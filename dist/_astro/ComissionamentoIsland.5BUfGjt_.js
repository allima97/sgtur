import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as l}from"./index.C0Fn7Wtz.js";import{s as N}from"./supabase.Ng8nq9tn.js";import{u as _e}from"./usePermissao.DEV7Ufch.js";const ue=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function A(j,d){const i=new Date(j);return i.setMonth(i.getMonth()+d),i}function Q(j){return j.toISOString().slice(0,10)}function V(j){const d=new Date;let i;switch(j){case"mes_anterior":{i=new Date(d.getFullYear(),d.getMonth()-1,1);break}case"trim":i=A(d,-3);break;case"sem":i=A(d,-6);break;case"ano":i=A(d,-12);break;case"mes_atual":default:i=new Date(d.getFullYear(),d.getMonth(),1);break}return{inicio:Q(i),fim:Q(d)}}function he(){const{ativo:j,loading:d}=_e("Vendas"),i=import.meta?.env?.PUBLIC_META_PRODUTO_ENABLED!=="false",[X,Z]=l.useState(null),[B,I]=l.useState(null),[R,ee]=l.useState(null),[U,ae]=l.useState([]),[F,te]=l.useState({}),[O,oe]=l.useState({}),[y,se]=l.useState({}),[$,ie]=l.useState([]),[pe,re]=l.useState(!0),[K,z]=l.useState(!0),[Y,T]=l.useState(null),[E,ce]=l.useState("mes_atual"),[W,ne]=l.useState(()=>V("mes_atual"));l.useEffect(()=>{d||!j||le()},[d,j,E]),l.useEffect(()=>{ne(V(E))},[E]);async function le(){try{z(!0),T(null);const{data:t}=await N.auth.getUser(),r=t?.user?.id||null;if(!r){T("Usuário não autenticado.");return}Z({id:r,nome:t?.user?.email||""});const _=V(E),{data:k}=await N.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:h}=await N.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",r).eq("periodo",_.inicio.slice(0,7)+"-01").maybeSingle(),x="id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral",P=async a=>{const C=a?`${x}, exibe_kpi_comissao`:x;return N.from("tipo_produtos").select(C)};let p=await P(!0),g=!0;p.error&&p.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(g=!1,p=await P(!1));const M=g?"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral, exibe_kpi_comissao":"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral";let v=await N.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${M}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim);v.error&&v.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(v=await N.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${x}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim),g=!1);const[L,S,q]=await Promise.all([N.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",h?.id||""),N.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta, commission_tier (faixa, de_pct, ate_pct, inc_pct_meta, inc_pct_comissao)"),N.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]),D=L.data,o=S.data,c=q.data,f=p.data,n=v.data;re(g);const s={};(o||[]).forEach(a=>{s[a.id]={id:a.id,tipo:a.tipo||"GERAL",meta_nao_atingida:a.meta_nao_atingida,meta_atingida:a.meta_atingida,super_meta:a.super_meta,commission_tier:a.commission_tier||[]}});const u={};(c||[]).forEach(a=>{u[a.produto_id]={produto_id:a.produto_id,rule_id:a.rule_id,fix_meta_nao_atingida:a.fix_meta_nao_atingida,fix_meta_atingida:a.fix_meta_atingida,fix_super_meta:a.fix_super_meta}});const b={};(f||[]).forEach(a=>{b[a.id]={id:a.id,nome:a.nome,regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,usa_meta_produto:a.usa_meta_produto,meta_produto_valor:a.meta_produto_valor,comissao_produto_meta_pct:a.comissao_produto_meta_pct,descontar_meta_geral:a.descontar_meta_geral,exibe_kpi_comissao:g?a.exibe_kpi_comissao:void 0}}),I(k?{usar_taxas_na_meta:!!k.usar_taxas_na_meta,foco_valor:k.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),ee(h),ae(D||[]),te(s),oe(u),se(b),ie(n||[])}catch(t){console.error(t),T("Erro ao carregar dados de comissionamento.")}finally{z(!1)}}function de(t,r){const _=r<100?"PRE":"POS",h=(t.commission_tier||[]).filter(v=>v.faixa===_).find(v=>r>=Number(v.de_pct)&&r<=Number(v.ate_pct)),x=_==="PRE"?t.meta_nao_atingida??t.meta_atingida??0:t.meta_atingida??t.meta_nao_atingida??0;if(!h)return _==="POS"&&r>=120?t.super_meta??x:x;const P=Number(h.inc_pct_meta||0),p=Number(h.inc_pct_comissao||0);if(P<=0)return p||x;const g=Math.max(0,Math.floor((r-Number(h.de_pct))/P));return x+g*(p/100)}const m=l.useMemo(()=>{if(!B)return null;const t={};U.forEach(o=>{t[o.produto_id]=o.valor});const r={},_={},k={};let h=0,x=0,P=0,p=0,g=0;const M={},v=[];let L=0;const S={};Object.values(y).forEach(o=>{o.regra_comissionamento==="diferenciado"&&(v.push(o.id),M[o.id]=0),o.usa_meta_produto&&(S[o.id]=0)}),$.forEach(o=>{(o.vendas_recibos||[]).forEach(c=>{const f=c.tipo_produtos?.id||c.produto_id||"",n=y[f];if(!n)return;const s=Number(c.valor_total||0),u=Number(c.valor_taxas||0),b=s-u,a=B.usar_taxas_na_meta?s:b;_[f]=(_[f]||0)+s,k[f]=(k[f]||0)+b,r[f]=(r[f]||0)+a,n.soma_na_meta&&(h+=a),x+=s,P+=u})});const q=x-P,D=R?.meta_geral&&R.meta_geral>0?h/R.meta_geral*100:0;return Object.keys(_).forEach(o=>{const c=y[o];if(!c)return;const f=B.foco_valor==="liquido"?k[o]||0:_[o]||0;if(c.regra_comissionamento==="diferenciado"){const n=O[o];if(!n)return;const s=t[o]||0,u=r[o]||0,b=s>0,a=b?u/s*100:0,C=b?u<s?0:a>=120?n.fix_super_meta??n.fix_meta_atingida??n.fix_meta_nao_atingida??0:n.fix_meta_atingida??n.fix_meta_nao_atingida??0:n.fix_meta_nao_atingida??n.fix_meta_atingida??n.fix_super_meta??0,w=f*(C/100);c.soma_na_meta&&!c.usa_meta_produto?p+=w:g+=w,M[o]=w}else{const n=O[o]?.rule_id,s=n?F[n]:void 0;let u=0;s&&(s.tipo==="ESCALONAVEL"?u=de(s,D):D<100?u=s.meta_nao_atingida||0:D>=120?u=s.super_meta??s.meta_atingida??s.meta_nao_atingida??0:u=s.meta_atingida??s.meta_nao_atingida??0);const b=f*(u/100);if(p+=b,i&&c.usa_meta_produto&&c.meta_produto_valor&&c.comissao_produto_meta_pct&&(r[o]||0)/c.meta_produto_valor*100>=100){const G=f*((c.comissao_produto_meta_pct||0)/100),J=c.descontar_meta_geral===!1?G:Math.max(G-b,0);L+=J,S[o]=(S[o]||0)+J}}}),{baseMeta:h,totalBruto:x,totalTaxas:P,valorLiquido:q,pctMetaGeral:D,comissaoGeral:p,comissaoDif:g,comissaoMetaProd:i?L:0,totalComissao:i?p+g+L:p+g,comissaoDifDetalhe:M,comissaoMetaProdDetalhe:i?S:{},produtosDiferenciados:v}},[$,B,y,O,U,R,F,i]);if(d)return e.jsx("div",{children:"Carregando permissões..."});if(!j)return e.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const H=i&&m?Object.entries(m.comissaoMetaProdDetalhe||{}).filter(([t])=>y[t]?.exibe_kpi_comissao!==!1):[],me=m&&m.produtosDiferenciados?m.produtosDiferenciados.filter(t=>y[t]?.exibe_kpi_comissao!==!1):[];return e.jsxs("div",{className:"card-base bg-transparent shadow-none p-0",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row mb-0",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Período"}),e.jsx("select",{className:"form-select",value:E,onChange:t=>ce(t.target.value),children:ue.map(t=>e.jsx("option",{value:t.id,children:t.label},t.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início"}),e.jsx("input",{className:"form-input",value:W.inicio,readOnly:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Fim"}),e.jsx("input",{className:"form-input",value:W.fim,readOnly:!0})]})]})}),Y&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:Y})}),K&&e.jsx("div",{children:"Carregando dados..."}),!K&&m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base mb-3",children:[e.jsx("div",{className:"text-center font-bold text-lg mb-4",children:"Como está seu Progresso"}),e.jsxs("div",{className:"grid gap-3 mb-1",style:{gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))"},children:[e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#16a34a"},children:[e.jsx("div",{className:"kpi-label",children:"Meta do mês"}),e.jsx("div",{className:"kpi-value",children:(R?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#ca8a04"},children:[e.jsx("div",{className:"kpi-label",children:"Total Bruto"}),e.jsx("div",{className:"kpi-value",children:m.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#c2410c"},children:[e.jsx("div",{className:"kpi-label",children:"Total Líquido"}),e.jsx("div",{className:"kpi-value",children:m.totalLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#0ea5e9"},children:[e.jsx("div",{className:"kpi-label",children:"Taxas"}),e.jsx("div",{className:"kpi-value",children:m.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#2563eb"},children:[e.jsx("div",{className:"kpi-label",children:"Vendas"}),e.jsx("div",{className:"kpi-value",children:m.totalVendas})]})]})]}),e.jsxs("div",{className:"card-base",children:[e.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),i&&H.length>0&&e.jsx("div",{style:{textAlign:"center",color:"#0f172a",marginBottom:8,fontSize:"0.9rem"},children:"Produtos com meta específica"}),e.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),e.jsx("div",{className:"kpi-value",children:m.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),i&&H.map(([t,r])=>e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:y[t]?.nome||"(produto)"}),e.jsx("div",{className:"kpi-value",children:r.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),r===0&&e.jsx("small",{style:{color:"#dc2626"},children:"Meta não atingida"})]},`meta-${t}`)),me.map(t=>e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:y[t]?.nome||"(produto)"}),e.jsx("div",{className:"kpi-value",children:(m.comissaoDifDetalhe?.[t]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),(m.comissaoDifDetalhe?.[t]||0)===0&&e.jsx("small",{style:{color:"#dc2626"},children:"Sem comissão"})]},t)),e.jsxs("div",{className:"kpi-card kpi-highlight flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:"Comissão total"}),e.jsx("div",{className:"kpi-value",children:m.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{he as default};
