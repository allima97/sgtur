import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as m}from"./supabase.Ng8nq9tn.js";import{u as W}from"./usePermissao.Bkt8qSjs.js";import{t as T}from"./titleCase.DQLlfrnh.js";function h(t){return(t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const I={nome:"",pais_id:"",codigo_admin1:"",tipo:""};function K(){const{permissao:t,ativo:q,loading:B}=W("Cadastros"),[f,F]=i.useState([]),[g,M]=i.useState([]),[o,x]=i.useState(I),[l,k]=i.useState(""),[v,j]=i.useState(!0),[N,_]=i.useState(!1),[u,S]=i.useState(null),[C,E]=i.useState(null),[w,n]=i.useState(null),[d,A]=i.useState(!1);async function p(a=!1){try{j(!0),n(null);const[{data:s,error:r},{data:z,error:D}]=await Promise.all([m.from("paises").select("id, nome").order("nome"),m.from("subdivisoes").select("id, nome, pais_id, codigo_admin1, tipo, created_at").order(a?"nome":"created_at",{ascending:!a}).limit(a?void 0:10)]);if(r)throw r;if(D)throw D;F(s||[]),M(z||[]),A(a)}catch(s){console.error(s),n("Erro ao carregar subdivisoes.")}finally{j(!1)}}i.useEffect(()=>{p(!1)},[]),i.useEffect(()=>{l.trim()&&!d&&p(!0)},[l,d]);const b=i.useMemo(()=>{const a=new Map(f.map(s=>[s.id,s.nome]));return g.map(s=>({...s,pais_nome:a.get(s.pais_id)||""}))},[g,f]),y=i.useMemo(()=>{if(!l.trim())return b;const a=h(l);return b.filter(s=>h(s.nome).includes(a)||h(s.pais_nome).includes(a)||h(s.codigo_admin1).includes(a))},[l,b]);function c(a,s){x(r=>({...r,[a]:s}))}function P(){x(I),S(null),n(null)}function L(a){S(a.id),x({nome:a.nome,pais_id:a.pais_id,codigo_admin1:a.codigo_admin1,tipo:a.tipo||""})}async function R(a){if(a.preventDefault(),t==="view"){n("Voce nao tem permissao para salvar subdivisoes.");return}if(!o.nome.trim()||!o.pais_id||!o.codigo_admin1.trim()){n("Preencha nome, codigo e pais.");return}try{_(!0),n(null);const s={nome:T(o.nome),pais_id:o.pais_id,codigo_admin1:o.codigo_admin1.trim(),tipo:o.tipo.trim()||null};if(u){const{error:r}=await m.from("subdivisoes").update(s).eq("id",u);if(r)throw r}else{const{error:r}=await m.from("subdivisoes").insert(s);if(r)throw r}P(),await p(d)}catch(s){console.error(s),n("Erro ao salvar subdivisao.")}finally{_(!1)}}async function V(a){if(t!=="admin"){alert("Somente administradores podem excluir subdivisoes.");return}if(confirm("Excluir esta subdivisao?"))try{E(a);const{error:s}=await m.from("subdivisoes").delete().eq("id",a);if(s)throw s;await p(d)}catch(s){console.error(s),n("Erro ao excluir subdivisao. Verifique se nao existem cidades vinculadas.")}finally{E(null)}}return B?e.jsx("div",{className:"paises-page",children:"Carregando permissoes..."}):q?e.jsxs("div",{className:"paises-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:R,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome da subdivisao *"}),e.jsx("input",{className:"form-input",value:o.nome,onChange:a=>c("nome",a.target.value),onBlur:a=>c("nome",T(a.target.value)),placeholder:"Ex: Sao Paulo, California..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Codigo admin1 *"}),e.jsx("input",{className:"form-input",value:o.codigo_admin1,onChange:a=>c("codigo_admin1",a.target.value),placeholder:"Ex: SP, CA, NY..."})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsx("input",{className:"form-input",value:o.tipo,onChange:a=>c("tipo",a.target.value),placeholder:"Ex: Estado, Provincia, Regiao..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Pais *"}),e.jsxs("select",{className:"form-select",value:o.pais_id,onChange:a=>c("pais_id",a.target.value),children:[e.jsx("option",{value:"",children:"Selecione"}),f.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]})]}),e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:N||t==="view",children:N?"Salvando...":u?"Salvar alteracoes":"Adicionar Estado/ProvÃ­ncia"}),u&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:P,children:"Cancelar edicao"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar subdivisao"}),e.jsx("input",{className:"form-input",value:l,onChange:a=>k(a.target.value),placeholder:"Nome, pais ou codigo..."})]})}),!d&&e.jsx("div",{className:"card-base card-config mb-3",children:"Ultimas Subdivisoes Cadastradas (10). Digite na busca para consultar todas."}),w&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:w})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Subdivisao"}),e.jsx("th",{children:"Codigo"}),e.jsx("th",{children:"Pais"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"Acoes"})]})}),e.jsxs("tbody",{children:[v&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Carregando subdivisoes..."})}),!v&&y.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhuma subdivisao encontrada."})}),!v&&y.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.codigo_admin1}),e.jsx("td",{children:a.pais_nome||"-"}),e.jsx("td",{children:a.tipo||"-"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{className:"th-actions",children:t!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>L(a),children:"âœï¸"}),t==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>V(a.id),disabled:C===a.id,children:C===a.id?"...":"ğŸ—‘ï¸"})]})})]},a.id))]})]})})]}):e.jsx("div",{className:"paises-page",children:"Voce nao possui acesso ao modulo de Cadastros."})}export{K as default};
