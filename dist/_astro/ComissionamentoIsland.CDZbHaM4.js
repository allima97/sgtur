import{s as f,j as a}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as aa}from"./usePermissao.72SYthuA.js";const ea=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function L(m,n){const l=new Date(m);return l.setMonth(l.getMonth()+n),l}function U(m){return m.toISOString().slice(0,10)}function w(m){const n=new Date;let l;switch(m){case"mes_anterior":{l=new Date(n.getFullYear(),n.getMonth()-1,1);break}case"trim":l=L(n,-3);break;case"sem":l=L(n,-6);break;case"ano":l=L(n,-12);break;case"mes_atual":default:l=new Date(n.getFullYear(),n.getMonth(),1);break}return{inicio:U(l),fim:U(n)}}function ia(){const{ativo:m,loading:n}=aa("Vendas"),[l,O]=r.useState(null),[M,z]=r.useState(null),[j,W]=r.useState(null),[q,Y]=r.useState([]),[G,H]=r.useState({}),[C,J]=r.useState({}),[b,K]=r.useState({}),[V,Q]=r.useState([]),[A,F]=r.useState(!0),[T,E]=r.useState(null),[y,X]=r.useState("mes_atual"),[I,Z]=r.useState(()=>w("mes_atual"));r.useEffect(()=>{n||!m||$()},[n,m,y]),r.useEffect(()=>{Z(w(y))},[y]);async function $(){try{F(!0),E(null);const{data:o}=await f.auth.getUser(),v=o?.user?.id||null;if(!v){E("Usuário não autenticado.");return}O({id:v,nome:o?.user?.email||""});const g=w(y),{data:h}=await f.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:N}=await f.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",v).eq("periodo",g.inicio.slice(0,7)+"-01").maybeSingle(),[k,P,S,R,D]=await Promise.all([f.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",N?.id||""),f.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta"),f.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta"),f.from("tipo_produtos").select("id, nome, regra_comissionamento, soma_na_meta"),f.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              id, nome, regra_comissionamento, soma_na_meta
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",g.inicio).lte("data_lancamento",g.fim)]),s=k.data,u=P.data,d=S.data,i=R.data,t=D.data,c={};(u||[]).forEach(e=>{c[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta}});const p={};(d||[]).forEach(e=>{p[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const B={};(i||[]).forEach(e=>{B[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta}}),z(h?{usar_taxas_na_meta:!!h.usar_taxas_na_meta,foco_valor:h.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),W(N),Y(s||[]),H(c),J(p),K(B),Q(t||[])}catch(o){console.error(o),E("Erro ao carregar dados de comissionamento.")}finally{F(!1)}}const _=r.useMemo(()=>{if(!M)return null;const o={};q.forEach(s=>{o[s.produto_id]=s.valor});const v={},g={};let h=0,N=0,k=0,P=0;const S={},R=[];Object.values(b).forEach(s=>{s.regra_comissionamento==="diferenciado"&&(R.push(s.id),S[s.id]=0)}),V.forEach(s=>{(s.vendas_recibos||[]).forEach(u=>{const d=u.tipo_produtos?.id||u.produto_id||"",i=b[d];if(!i)return;const t=Number(u.valor_total||0),c=Number(u.valor_taxas||0),p=M.foco_valor==="liquido"?t:M.usar_taxas_na_meta?t+c:t;g[d]=(g[d]||0)+t,v[d]=(v[d]||0)+p,i.soma_na_meta&&(h+=p),N+=t})});const D=j?.meta_geral&&j.meta_geral>0?h/j.meta_geral*100:0;return Object.keys(g).forEach(s=>{const u=b[s];if(!u)return;const d=g[s]||0;if(u.regra_comissionamento==="diferenciado"){const i=C[s];if(!i)return;const t=o[s]||0,c=v[s]||0,p=t>0?c/t*100:0,B=p>=120?i.fix_super_meta??i.fix_meta_atingida??i.fix_meta_nao_atingida??0:p>=100?i.fix_meta_atingida??i.fix_meta_nao_atingida??0:i.fix_meta_nao_atingida??0,e=d*(B/100);P+=e,S[s]=e}else{const i=C[s]?.rule_id,t=i?G[i]:void 0;let c=0;t&&(D<100?c=t.meta_nao_atingida||0:D>=120?c=t.super_meta??t.meta_atingida??t.meta_nao_atingida??0:c=t.meta_atingida??t.meta_nao_atingida??0),k+=d*(c/100)}}),{baseMeta:h,valorLiquido:N,pctMetaGeral:D,comissaoGeral:k,comissaoDif:P,totalComissao:k+P,comissaoDifDetalhe:S,produtosDiferenciados:R}},[V,M,b,C,q,j,G]);if(n)return a.jsx("div",{children:"Carregando permissões..."});if(!m)return a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const x={flexDirection:"column",alignItems:"center",textAlign:"center"};return a.jsxs("div",{className:"card-base",style:{background:"transparent",boxShadow:"none",padding:0},children:[a.jsx("div",{className:"card-base",style:{marginBottom:12},children:a.jsxs("div",{className:"form-row",style:{marginBottom:0},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:y,onChange:o=>X(o.target.value),children:ea.map(o=>a.jsx("option",{value:o.id,children:o.label},o.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:I.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:I.fim,readOnly:!0})]})]})}),T&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:T})}),A&&a.jsx("div",{children:"Carregando dados..."}),!A&&_&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",style:{marginBottom:12},children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,marginBottom:16},children:"Como está seu Progresso"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(4, minmax(180px, 1fr))",gap:12,marginBottom:4},children:[a.jsxs("div",{className:"kpi-card",style:{...x,color:"#16a34a"},children:[a.jsx("div",{className:"kpi-label",children:"Meta do mês"}),a.jsx("div",{className:"kpi-value",children:(j?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...x,color:"#ca8a04"},children:[a.jsx("div",{className:"kpi-label",children:"Vendas do mês"}),a.jsx("div",{className:"kpi-value",children:_.baseMeta.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...x,color:"#2563eb"},children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[_.pctMetaGeral.toFixed(1),"%"]})]}),a.jsxs("div",{className:"kpi-card",style:{...x,color:"#c2410c"},children:[a.jsx("div",{className:"kpi-label",children:"Base para comissionamento"}),a.jsx("div",{className:"kpi-value",children:_.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]}),a.jsxs("div",{className:"card-base",children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[a.jsxs("div",{className:"kpi-card",style:x,children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:_.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),(_.produtosDiferenciados||[]).map(o=>a.jsxs("div",{className:"kpi-card",style:x,children:[a.jsxs("div",{className:"kpi-label",children:["Comissão ",b[o]?.nome||"(produto)"]}),a.jsx("div",{className:"kpi-value",children:(_.comissaoDifDetalhe?.[o]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},o)),a.jsxs("div",{className:"kpi-card kpi-highlight",style:x,children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:_.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{ia as default};
