import{j as t}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as p}from"./supabase.Ng8nq9tn.js";import{u as Be}from"./usePermissao.DEV7Ufch.js";import{r as Ne}from"./logs.DwCrXgEk.js";function I(b){return(b||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const ae={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Me={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function Fe(b){const N=b.replace(/\D/g,"");return N?(Number(N)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function we(b){const N=Number(b);return Number.isNaN(N)?"":N.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function J(b){if(!b)return NaN;const N=b.replace(/\./g,"").replace(",",".");return Number(N)}function Ye(){const{permissao:b,ativo:N,loading:G,isAdmin:te}=Be("Vendas"),ie=b==="create"||b==="edit"||b==="delete"||b==="admin",[A,je]=s.useState([]),[F,Ce]=s.useState([]),[f,re]=s.useState([]),[K,Se]=s.useState([]),[c,q]=s.useState(ae),[_,P]=s.useState([]),[j,Q]=s.useState(null),[se,X]=s.useState({id:"",nome:""}),[de,h]=s.useState(null),[ne,R]=s.useState(!1),[$e,le]=s.useState(!0),[ke,ce]=s.useState(!1),[ue,me]=s.useState([]),[ze,ye]=s.useState(0),[B,Z]=s.useState(""),[C,$]=s.useState(""),[k,U]=s.useState(""),[De,W]=s.useState(!1),[pe,M]=s.useState([]),[O,fe]=s.useState(!1),[_e,H]=s.useState(null),[Ge,ee]=s.useState("");async function Ee(e,o){try{le(!0);const[a,i,n,g]=await Promise.all([p.from("clientes").select("id, nome, cpf").order("nome"),p.from("cidades").select("id, nome").order("nome"),p.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").order("nome"),p.from("tipo_produtos").select("id, nome, disponivel_todas_cidades")]);je(a.data||[]);const d=i.data||[];Ce(d);const x=g.data||[],D=new Map(x.map(l=>[l.id,l])),m=(n.data||[]).map(l=>{const r=l.tipo_produtos;return{...l,tipo_info:r?{disponivel_todas_cidades:r.disponivel_todas_cidades}:D.has(l.tipo_produto)?{disponivel_todas_cidades:D.get(l.tipo_produto||"")?.disponivel_todas_cidades}:void 0}});re(m),Se(x),e&&await Ve(e,d,m,o)}catch(a){console.error(a),h("Erro ao carregar dados."),w("Erro ao carregar dados.","error")}finally{le(!1)}}async function Ve(e,o,a,i){try{ce(!0);const{data:n,error:g}=await p.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(g)throw g;if(!n){h("Venda n√£o encontrada para edi√ß√£o.");return}let d="",x="";if(n.destino_id){const{data:r}=await p.from("produtos").select("id, cidade_id").eq("id",n.destino_id).maybeSingle();d=r?.cidade_id||"";const v=(o||F).find(S=>S.id===d);v&&(x=v.nome)}!d&&i?.id&&(d=i.id),!x&&i?.nome&&(x=i.nome),q({cliente_id:n.cliente_id,destino_id:d,data_lancamento:n.data_lancamento,data_embarque:n.data_embarque||""}),$(x||d||""),ee(x||d||"");const{data:D,error:m}=await p.from("vendas_recibos").select("*").eq("venda_id",e);if(m)throw m;const l=a||f;P((D||[]).map(r=>({id:r.id,produto_id:l.find(u=>{const v=!!u.tipo_info?.disponivel_todas_cidades;return u.tipo_produto===r.produto_id&&(v||!d||u.cidade_id===d)})?.id||"",numero_recibo:r.numero_recibo||"",valor_total:r.valor_total!=null?we(r.valor_total):"",valor_taxas:r.valor_taxas!=null?we(r.valor_taxas):"0,00"})))}catch(n){console.error(n),h("Erro ao carregar venda para edi√ß√£o."),w("Erro ao carregar venda para edi√ß√£o.","error")}finally{ce(!1)}}s.useEffect(()=>{const e=new URLSearchParams(window.location.search),o=e.get("id");o&&Q(o);const a=e.get("cidadeId")||"",i=e.get("cidadeNome")||"";(a||i)&&X({id:a,nome:i})},[]),s.useEffect(()=>{!G&&N&&Ee(j||void 0,se)},[G,N,j,se]),s.useEffect(()=>{if(C.trim().length<2){M([]);return}const e=new AbortController,o=setTimeout(async()=>{fe(!0),H(null);try{const{data:a,error:i}=await p.rpc("buscar_cidades",{q:C.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),H("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:n,error:g}=await p.from("cidades").select("id, nome").ilike("nome",`%${C.trim()}%`).order("nome");g?(console.error("Erro no fallback de cidades:",g),H("Erro ao buscar cidades.")):(M(n||[]),H(null))}else M(a||[])}finally{e.signal.aborted||fe(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[C]);const Y=e=>e.replace(/\D/g,""),ve=s.useMemo(()=>{if(!B.trim())return A;const e=I(B);return A.filter(o=>{const a=Y(o.cpf||"");return I(o.nome).includes(e)||a.includes(Y(e))})},[A,B]);s.useMemo(()=>{if(!C.trim())return F;const e=I(C);return F.filter(o=>I(o.nome).includes(e))},[F,C]);const be=s.useMemo(()=>{const e=K.filter(i=>i.disponivel_todas_cidades);let o=[];if(c.destino_id){const i=f.filter(d=>!!d.tipo_info?.disponivel_todas_cidades||d.cidade_id===c.destino_id),n=new Set(i.filter(d=>d.cidade_id===c.destino_id).map(d=>d.tipo_produto)),g=e.filter(d=>!n.has(d.id)).map(d=>({id:`virtual-${d.id}`,nome:d.nome||"Produto global",cidade_id:c.destino_id,tipo_produto:d.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}));o=[...i,...g]}else o=[...f.filter(i=>!!i.tipo_info?.disponivel_todas_cidades),...e.map(i=>({id:`virtual-${i.id}`,nome:i.nome||"Produto global",cidade_id:null,tipo_produto:i.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}))];if(!k.trim())return o;const a=I(k);return o.filter(i=>I(i.nome).includes(a))},[f,K,k,c.destino_id]),he=s.useMemo(()=>f.some(e=>e.tipo_info?.disponivel_todas_cidades),[f]),Ie=s.useMemo(()=>_.length>0,[_.length]);function qe(e){$(e);const o=F.find(a=>a.id===c.destino_id);(!o||!I(o.nome).includes(I(e)))&&q(a=>({...a,destino_id:""})),W(!0)}function w(e,o="success"){ye(a=>{const i=a+1;return me(n=>[...n,{id:i,message:e,type:o}]),setTimeout(()=>{me(n=>n.filter(g=>g.id!==i))},3500),i})}function Pe(){P(e=>[...e,{...Me}])}function oe(e,o,a){P(i=>{const n=[...i];return n[e][o]=a,n})}function ge(e,o,a){const i=Fe(a);oe(e,o,i)}s.useEffect(()=>{U(""),P(e=>e.map(o=>{const a=f.find(n=>n.id===o.produto_id),i=!!a?.tipo_info?.disponivel_todas_cidades;return a&&(i||a.cidade_id===c.destino_id)?o:{...o,produto_id:""}}))},[c.destino_id,f]);function Te(e){P(o=>o.filter((a,i)=>i!==e))}function xe(){q({...ae,data_lancamento:new Date().toISOString().substring(0,10)}),P([]),Q(null),X({id:"",nome:""}),Z(""),$(""),U(""),ee(""),M([]),h(null),window.location.href="/vendas/consulta"}function Le(){q(ae),P([]),Q(null),X({id:"",nome:""}),Z(""),$(""),U(""),ee(""),M([]),h(null),window.location.href="/vendas/consulta"}async function Re(e){if(e.preventDefault(),!ie&&!te){h("Voc√™ n√£o possui permiss√£o para cadastrar vendas."),w("Voc√™ n√£o possui permiss√£o para cadastrar vendas.","error");return}if(_.length===0){h("Uma venda precisa ter ao menos 1 recibo."),w("Inclua ao menos um recibo na venda.","error");return}try{R(!0),h(null);const{data:o}=await p.auth.getUser(),a=o?.user?.id;if(!a){h("Usu√°rio n√£o autenticado."),w("Usu√°rio n√£o autenticado.","error"),R(!1);return}if(!_.length){h("Uma venda precisa ter ao menos 1 recibo."),w("Inclua ao menos um recibo na venda.","error"),R(!1);return}if(!_[0]?.produto_id){h("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),w("Selecione um produto para o recibo principal.","error"),R(!1);return}if(_.some(m=>{const l=f.find(u=>u.id===m.produto_id),r=!!l?.tipo_info?.disponivel_todas_cidades||(m.produto_id||"").startsWith("virtual-");return l?.cidade_id&&!r})&&!c.destino_id){h("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),w("Selecione a cidade de destino.","error"),R(!1);return}async function g(m){const l=m.produto_id,r=f.find(V=>V.id===l);if(r&&!r.isVirtual)return r.id;const u=r?.tipo_produto||(l?.startsWith("virtual-")?l.replace("virtual-",""):r?.tipo_produto);if(!u)throw new Error("Produto inv√°lido. Selecione novamente.");const v=c.destino_id;if(!v)throw new Error("Selecione a cidade de destino para usar produtos globais.");const S=f.find(V=>V.tipo_produto===u&&V.cidade_id===v);if(S)return S.id;const E=K.find(V=>V.id===u),y=E?.nome||"Produto",{data:T,error:L}=await p.from("produtos").insert({nome:y,destino:y,cidade_id:v,tipo_produto:u,ativo:!0}).select("id").single();if(L)throw L;const z=T?.id;if(z)return re(V=>[...V,{id:z,nome:y,cidade_id:v,tipo_produto:u,tipo_info:{disponivel_todas_cidades:E?.disponivel_todas_cidades}}]),z;throw new Error("N√£o foi poss√≠vel criar produto global.")}const d=[];for(const m of _){const l=await g(m);d.push(l)}const x=d[0];let D=j;if(j){const{error:m}=await p.from("vendas").update({cliente_id:c.cliente_id,destino_id:x,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||null}).eq("id",j);if(m)throw m;await p.from("vendas_recibos").delete().eq("venda_id",j);for(let l=0;l<_.length;l++){const r=_[l],u=d[l],v=f.find(L=>L.id===u),S=v?.tipo_produto||(r.produto_id?.startsWith("virtual-")?r.produto_id.replace("virtual-",""):v?.tipo_produto);if(!S)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const E=J(r.valor_total),y=J(r.valor_taxas);if(Number.isNaN(E))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(y))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:T}=await p.from("vendas_recibos").insert({venda_id:j,produto_id:S,numero_recibo:r.numero_recibo.trim(),valor_total:E,valor_taxas:y});if(T)throw T}await Ne({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:j,venda:c,recibos:_}}),w("Venda atualizada com sucesso!","success"),setTimeout(()=>xe(),200)}else{const{data:m,error:l}=await p.from("vendas").insert({vendedor_id:a,cliente_id:c.cliente_id,destino_id:x,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||null}).select().single();if(l)throw l;D=m.id;for(let r=0;r<_.length;r++){const u=_[r],v=d[r],S=f.find(z=>z.id===v),E=S?.tipo_produto||(u.produto_id?.startsWith("virtual-")?u.produto_id.replace("virtual-",""):S?.tipo_produto);if(!E)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const y=J(u.valor_total),T=J(u.valor_taxas);if(Number.isNaN(y))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(T))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:L}=await p.from("vendas_recibos").insert({venda_id:D,produto_id:E,numero_recibo:u.numero_recibo.trim(),valor_total:y,valor_taxas:T});if(L)throw L}await Ne({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:c,recibos:_,id:D}}),w("Venda cadastrada com sucesso!","success"),setTimeout(()=>xe(),200)}}catch(o){console.error(o);const a=o?.message||o?.error?.message||"",i=o?.code||o?.error?.code||"";h(`Erro ao salvar venda.${i?` C√≥digo: ${i}.`:""}${a?` Detalhes: ${a}`:""}`),w("Erro ao salvar venda.","error")}finally{R(!1)}}return N?!ie&&!te?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):t.jsxs("div",{className:"vendas-cadastro-page",children:[t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:j?"Editar venda":"Cadastro de Venda"}),j&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),de&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:de})}),t.jsxs("form",{onSubmit:Re,children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:A.find(e=>e.id===c.cliente_id)?.nome||B,onChange:e=>Z(e.target.value),onBlur:()=>{const e=B.toLowerCase(),o=Y(B),a=ve.find(i=>{const n=Y(i.cpf||"");return i.nome.toLowerCase()===e||o&&n===o});a&&q({...c,cliente_id:a.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:ve.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group",style:{position:"relative"},children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:C,onChange:e=>qe(e.target.value),onFocus:()=>W(!0),onBlur:()=>setTimeout(()=>W(!1),150),required:Ie,style:{marginBottom:6}}),O&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),_e&&!O&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:_e}),De&&(O||C.trim().length>=2)&&t.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb",position:"absolute",zIndex:5,width:"100%",background:"#fff"},children:[pe.length===0&&!O&&C.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),pe.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:c.destino_id===e.id?"#e0f2fe":"#fff",borderColor:c.destino_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:a=>{a.preventDefault(),q(i=>({...i,destino_id:e.id})),$(o),W(!1),M([])},children:[o,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:c.data_embarque,onChange:e=>q({...c,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),_.map((e,o)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:he?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:f.find(a=>a.id===e.produto_id)?.nome||k,onChange:a=>U(a.target.value),onBlur:()=>{const a=be.find(i=>i.nome.toLowerCase()===k.toLowerCase());a&&oe(o,"produto_id",a.id)},required:!0,disabled:!c.destino_id&&!he}),t.jsx("datalist",{id:`listaProdutos-${o}`,children:be.map(a=>t.jsx("option",{value:a.nome},a.id))})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>oe(o,"numero_recibo",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:a=>ge(o,"valor_total",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:a=>ge(o,"valor_taxas",a.target.value)})]}),t.jsx("div",{className:"form-group",style:{width:"80px"},children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>Te(o),children:"üóëÔ∏è"})})]})},o)),t.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:Pe,children:"‚ûï Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:ne,children:ne?"Salvando...":"Salvar venda"}),t.jsx("button",{type:"button",className:"btn btn-outline",onClick:Le,style:{backgroundColor:"#f3f4f6",color:"#1f2937"},children:"Cancelar"})]})]})]}),ue.length>0&&t.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:ue.map(e=>t.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{Ye as default};
