import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as c}from"./index.C0Fn7Wtz.js";import{s as N}from"./supabase.Ng8nq9tn.js";function R(){return new Date().toISOString().substring(0,10)}function M(s,D){const p=new Date(s);return p.setDate(p.getDate()+D),p}function x(s){return s.toISOString().substring(0,10)}function G(s){return new Date(s.getFullYear(),s.getMonth(),1)}function V(s){return new Date(s.getFullYear(),s.getMonth()+1,0)}function K(s){return s.includes(";")||s.includes('"')||s.includes(`
`)?'"'+s.replace(/"/g,'""')+'"':s}function te(){const[s,D]=c.useState([]),[p,b]=c.useState(()=>{const a=M(new Date,-30);return x(a)}),[C,v]=c.useState(R()),[w,$]=c.useState("todos"),[O,Y]=c.useState([]),[k,q]=c.useState(!1),[I,g]=c.useState(null),[m,P]=c.useState(null),[Q,L]=c.useState(!0),[f,H]=c.useState("total"),[y,F]=c.useState(!0);c.useEffect(()=>{async function t(){try{const{data:a,error:n}=await N.from("clientes").select("id, nome, cpf").order("nome",{ascending:!0});if(n)throw n;D(a||[])}catch(a){console.error(a),g("Erro ao carregar clientes.")}}t()},[]),c.useEffect(()=>{async function t(){try{L(!0),g(null);const{data:a}=await N.auth.getUser(),n=a?.user?.id;if(!n){g("Usuário não autenticado.");return}const{data:r}=await N.from("users").select("id, user_types(name)").eq("id",n).maybeSingle(),i=r?.user_types?.name||a?.user?.user_metadata?.name||"",o=String(i||"").toUpperCase();let d="VENDEDOR";o.includes("ADMIN")?d="ADMIN":o.includes("GESTOR")?d="GESTOR":o.includes("VENDEDOR")?d="VENDEDOR":d="OUTRO";let u=[n];if(d==="GESTOR"){const{data:l}=await N.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",n),j=l?.map(S=>S.vendedor_id).filter(S=>!!S)||[];u=Array.from(new Set([n,...j]))}else d==="ADMIN"&&(u=[]);P({usuarioId:n,papel:d,vendedorIds:u})}catch(a){console.error(a),g("Erro ao carregar contexto do usuário.")}finally{L(!1)}}t()},[]);const h=c.useMemo(()=>{const t=new Map(s.map(r=>[r.id,r])),a=new Map;O.forEach(r=>{const i=r.cliente_id,o=t.get(i),d=o?.nome||"(sem cliente)",u=o?.cpf||"",l=a.get(i)||{cliente_id:i,cliente_nome:d,cliente_cpf:u,quantidade:0,total:0,ticketMedio:0},j=(r.vendas_recibos||[]).reduce((J,T)=>J+Number(T.valor_total||0)+Number(T.valor_taxas||0),0),S=j>0?j:r.valor_total??0;l.quantidade+=1,l.total+=S,a.set(i,l)});const n=Array.from(a.values()).map(r=>({...r,ticketMedio:r.quantidade>0?r.total/r.quantidade:0}));return n.sort((r,i)=>{let o=0;return f==="total"?o=r.total-i.total:f==="quantidade"?o=r.quantidade-i.quantidade:o=r.ticketMedio-i.ticketMedio,y?-o:o}),n},[O,s,f,y]),A=h.reduce((t,a)=>t+a.total,0),U=h.reduce((t,a)=>t+a.quantidade,0),W=U>0?A/U:0;function _(t){const a=new Date;if(t==="7"){const n=M(a,-7);b(x(n)),v(R());return}if(t==="30"){const n=M(a,-30);b(x(n)),v(R());return}if(t==="mes_atual"){const n=G(a),r=V(a);b(x(n)),v(x(r));return}if(t==="mes_anterior"){const n=new Date(a.getFullYear(),a.getMonth()-1,1),r=G(n),i=V(n);b(x(r)),v(x(i));return}}async function B(){if(m)try{q(!0),g(null);let t=N.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          produto_id,
          data_lancamento,
          data_embarque,
          valor_total,
          status,
          vendas_recibos (valor_total, valor_taxas)
        `).order("data_lancamento",{ascending:!1});m.papel!=="ADMIN"&&(t=t.in("vendedor_id",m.vendedorIds)),p&&(t=t.gte("data_lancamento",p)),C&&(t=t.lte("data_lancamento",C)),w!=="todos"&&(t=t.eq("status",w));const{data:a,error:n}=await t;if(n)throw n;Y(a||[])}catch(t){console.error(t),g("Erro ao carregar vendas para relatório por cliente.")}finally{q(!1)}}function E(t){t===f?F(a=>!a):(H(t),F(!0))}c.useEffect(()=>{m&&B()},[m]);function z(){if(h.length===0){alert("Não há dados para exportar.");return}const t=["cliente","cpf","quantidade","total","ticket_medio"],a=h.map(l=>[l.cliente_nome,l.cliente_cpf,l.quantidade.toString(),l.total.toFixed(2).replace(".",","),l.ticketMedio.toFixed(2).replace(".",",")]),n=[t,...a].map(l=>l.map(j=>K(j)).join(";")).join(`
`),r=new Blob([n],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(r),o=new Date,d=`${o.getFullYear()}${String(o.getMonth()+1).padStart(2,"0")}${String(o.getDate()).padStart(2,"0")}-${String(o.getHours()).padStart(2,"0")}${String(o.getMinutes()).padStart(2,"0")}`,u=document.createElement("a");u.href=i,u.setAttribute("download",`relatorio-vendas-por-cliente-${d}.csv`),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(i)}return e.jsxs("div",{className:"relatorio-vendas-cliente-page",children:[e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:p,onChange:t=>b(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:C,onChange:t=>v(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:w,onChange:t=>$(t.target.value),children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"aberto",children:"Aberto"}),e.jsx("option",{value:"confirmado",children:"Confirmado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]})]}),e.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>_("7"),children:"Últimos 7 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>_("30"),children:"Últimos 30 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>_("mes_atual"),children:"Este mês"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>_("mes_anterior"),children:"Mês anterior"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:B,children:"Aplicar filtros"}),e.jsx("button",{type:"button",className:"btn btn-purple",onClick:z,children:"Exportar CSV"})]})]}),Q&&e.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),m&&m.papel!=="ADMIN"&&e.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",m.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),I&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:I})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Clientes: ",e.jsx("strong",{children:h.length})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Faturamento total:"," ",e.jsx("strong",{children:A.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Ticket médio geral:"," ",e.jsx("strong",{children:W.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-purple min-w-[700px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"CPF"}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("quantidade"),children:["Qtde ",f==="quantidade"?y?"↓":"↑":""]}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("total"),children:["Faturamento ",f==="total"?y?"↓":"↑":""]}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("ticket"),children:["Ticket médio ",f==="ticket"?y?"↓":"↑":""]})]})}),e.jsxs("tbody",{children:[k&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!k&&h.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhum cliente encontrado com os filtros atuais."})}),!k&&h.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.cliente_nome}),e.jsx("td",{children:t.cliente_cpf}),e.jsx("td",{children:t.quantidade}),e.jsx("td",{children:t.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:t.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},t.cliente_id))]})]})})]})}export{te as default};
