import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as t}from"./index.C0Fn7Wtz.js";import{s as c}from"./supabase.Ng8nq9tn.js";import{u as te}from"./usePermissao.DiLe8-Rs.js";import{L as ne}from"./LoadingUsuarioContext.BaDUNi7o.js";const V="viagens";function ie(d){return d.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]/g,"_").replace(/_+/g,"_").replace(/^_+|_+$/g,"")}function pe({viagemId:d}){const{permissao:p,loading:S,ativo:Q}=te("Operacao"),L=p!=="none",g=p==="create"||p==="edit"||p==="delete"||p==="admin",n=p==="delete"||p==="admin",[r,k]=t.useState(null),[w,q]=t.useState(!1),[_,l]=t.useState(null),[X,P]=t.useState([]),[m,f]=t.useState({acompanhante_id:"",papel:"passageiro",documento_url:"",observacoes:""}),[C,N]=t.useState(!1),z={tipo:"aereo",fornecedor:"",descricao:"",status:"ativo",data_inicio:"",data_fim:"",valor:"",moeda:"BRL",voucher_url:"",observacoes:""},[s,i]=t.useState(z),[x,F]=t.useState(null),[D,O]=t.useState(!1),[U,$]=t.useState(null),[R,I]=t.useState(""),[K,W]=t.useState("voucher"),[v,G]=t.useState(null),[H,M]=t.useState(!1),[Z,J]=t.useState(null),A=r?.viagem_servicos||[],E=r?.viagem_documentos||[];t.useEffect(()=>{d&&!S&&L&&u()},[d,S,L]);async function u(){if(d)try{q(!0),l(null);const{data:a,error:o}=await c.from("viagens").select(`
          id,
          company_id,
          venda_id,
          orcamento_id,
          data_inicio,
          data_fim,
          status,
          origem,
          destino,
          responsavel_user_id,
          responsavel:users!responsavel_user_id (
            nome_completo
          ),
          observacoes,
          venda:vendas (
            id,
            cliente_id,
            clientes:clientes (
              id,
              nome
            )
          ),
          orcamento:orcamentos (
            id,
            cliente_id,
            clientes:clientes (
              id,
              nome
            )
          ),
          viagem_acompanhantes (
            id,
            papel,
            documento_url,
            observacoes,
            cliente_acompanhantes:acompanhante_id (
              nome_completo,
              cpf,
              rg,
              telefone,
              grau_parentesco
            )
          ),
          viagem_servicos (
            id,
            tipo,
            fornecedor,
            descricao,
            status,
            data_inicio,
            data_fim,
            valor,
            moeda,
            voucher_url,
            observacoes
          ),
          viagem_documentos (
            id,
            titulo,
            tipo,
            url,
            mime_type,
            size_bytes,
            created_at
          )
        `).eq("id",d).maybeSingle();if(o)throw o;const j=a||null;k(j);const b=j?.venda?.cliente_id||j?.orcamento?.cliente_id||null;if(b){const{data:y,error:T}=await c.from("cliente_acompanhantes").select("id, nome_completo, cpf, telefone, grau_parentesco").eq("cliente_id",b).eq("ativo",!0).order("nome_completo",{ascending:!0});!T&&y&&P(y.map(h=>({id:h.id,nome_completo:h.nome_completo,cpf:h.cpf,telefone:h.telefone,grau_parentesco:h.grau_parentesco})))}else P([])}catch(a){console.error(a),l("Erro ao carregar dossiê da viagem."),k(null)}finally{q(!1)}}if(S)return e.jsx(ne,{});if(!Q)return e.jsx("div",{children:"Você não possui acesso ao módulo de Operação/Viagens."});if(!d)return e.jsx("div",{children:"Nenhuma viagem selecionada."});async function Y(){if(!(!r||!g)){if(!m.acompanhante_id){l("Selecione um acompanhante para vincular.");return}try{N(!0),l(null);const a={viagem_id:r.id,acompanhante_id:m.acompanhante_id,company_id:r.company_id,papel:m.papel||null,documento_url:m.documento_url||null,observacoes:m.observacoes||null},{error:o}=await c.from("viagem_acompanhantes").insert(a);if(o)throw o;f({acompanhante_id:"",papel:"passageiro",documento_url:"",observacoes:""}),await u()}catch(a){console.error(a),l("Erro ao adicionar acompanhante.")}finally{N(!1)}}}async function ee(a){if(n)try{N(!0),l(null);const{error:o}=await c.from("viagem_acompanhantes").delete().eq("id",a).eq("viagem_id",d);if(o)throw o;await u()}catch(o){console.error(o),l("Erro ao remover acompanhante.")}finally{N(!1)}}function ae(a){F(a.id),i({tipo:a.tipo||"aereo",fornecedor:a.fornecedor||"",descricao:a.descricao||"",status:a.status||"ativo",data_inicio:a.data_inicio||"",data_fim:a.data_fim||"",valor:a.valor!==null&&a.valor!==void 0?String(a.valor):"",moeda:a.moeda||"BRL",voucher_url:a.voucher_url||"",observacoes:a.observacoes||""})}function B(){F(null),i(z)}async function oe(){if(!r||!r.company_id){l("Viagem sem company_id para salvar serviço.");return}try{O(!0),l(null);const a={viagem_id:r.id,company_id:r.company_id,tipo:s.tipo||"outro",fornecedor:s.fornecedor||null,descricao:s.descricao||null,status:s.status||null,data_inicio:s.data_inicio||null,data_fim:s.data_fim||null,valor:s.valor?Number(s.valor):null,moeda:s.moeda||"BRL",voucher_url:s.voucher_url||null,observacoes:s.observacoes||null};if(x){const{error:o}=await c.from("viagem_servicos").update(a).eq("id",x).eq("viagem_id",r.id);if(o)throw o}else{const{error:o}=await c.from("viagem_servicos").insert(a);if(o)throw o}B(),await u()}catch(a){console.error(a),l("Erro ao salvar serviço.")}finally{O(!1)}}async function re(a){if(n)try{$(a),l(null);const{error:o}=await c.from("viagem_servicos").delete().eq("id",a).eq("viagem_id",d);if(o)throw o;x===a&&B(),await u()}catch(o){console.error(o),l("Erro ao remover serviço.")}finally{$(null)}}async function se(){if(!r||!r.company_id){l("Viagem sem company_id para salvar documento.");return}if(!v){l("Selecione um arquivo para enviar.");return}if(!R.trim()){l("Informe um título para o documento.");return}try{M(!0),l(null);const a=ie(v.name),o=`${r.id}/${Date.now()}-${a}`,{data:j,error:b}=await c.storage.from(V).upload(o,v,{cacheControl:"3600",upsert:!1,contentType:v.type||void 0,metadata:{mimetype:v.type||"application/octet-stream"}});if(b)throw b;const y=c.storage.from(V).getPublicUrl(j.path).data.publicUrl,T={viagem_id:r.id,company_id:r.company_id,titulo:R,tipo:K||"outro",url:y,mime_type:v.type||null,size_bytes:v.size||null},{error:h}=await c.from("viagem_documentos").insert(T);if(h)throw h;I(""),W("voucher"),G(null),await u()}catch(a){console.error(a);const o=a instanceof Error?a.message:"Erro ao salvar documento. Verifique se o bucket de Storage existe e é público.";l(o)}finally{M(!1)}}async function le(a){if(n)try{J(a),l(null);const{error:o}=await c.from("viagem_documentos").delete().eq("id",a).eq("viagem_id",d);if(o)throw o;await u()}catch(o){console.error(o),l("Erro ao remover documento.")}finally{J(null)}}return e.jsxs("div",{className:"card-base card-purple",children:[e.jsx("div",{style:{display:"flex",justifyContent:"flex-end"},children:e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("a",{className:"btn btn-light",href:"/operacao/viagens",children:"Voltar"}),e.jsx("button",{className:"btn btn-primary",type:"button",onClick:u,disabled:w,children:w?"Atualizando...":"Atualizar"})]})}),_&&e.jsx("div",{style:{color:"red",marginTop:10},children:_}),!_&&r&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:16,marginTop:16},children:[e.jsxs("div",{className:"card-base",style:{border:"1px solid #e2e8f0"},children:[e.jsx("h3",{style:{marginBottom:8},children:"Dados da viagem"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Origem"}),e.jsx("div",{children:r.origem||"-"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("div",{children:r.destino||"-"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsx("div",{children:r.status||"-"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("div",{children:r.data_inicio?new Date(r.data_inicio).toLocaleDateString("pt-BR"):"-"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("div",{children:r.data_fim?new Date(r.data_fim).toLocaleDateString("pt-BR"):"-"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Responsável"}),e.jsx("div",{children:r.responsavel?.nome_completo||r.responsavel_user_id||"-"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Observações"}),e.jsx("div",{children:r.observacoes||"-"})]})]}),e.jsxs("div",{className:"card-base",style:{border:"1px solid #e2e8f0"},children:[e.jsxs("h3",{style:{marginBottom:8},children:["Acompanhantes (",r.viagem_acompanhantes?.length||0,")"]}),g&&e.jsxs("div",{className:"card-base",style:{marginBottom:12,border:"1px dashed #cbd5e1",background:"#f8fafc"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:"Vincular acompanhante existente"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Acompanhante"}),e.jsxs("select",{className:"form-select",value:m.acompanhante_id,onChange:a=>f(o=>({...o,acompanhante_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Selecione"}),X.map(a=>e.jsxs("option",{value:a.id,children:[a.nome_completo,a.cpf?` • ${a.cpf}`:""]},a.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Papel"}),e.jsxs("select",{className:"form-select",value:m.papel,onChange:a=>f(o=>({...o,papel:a.target.value})),children:[e.jsx("option",{value:"passageiro",children:"Passageiro"}),e.jsx("option",{value:"responsavel",children:"Responsável"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Documento URL"}),e.jsx("input",{type:"url",className:"form-input",value:m.documento_url,onChange:a=>f(o=>({...o,documento_url:a.target.value})),placeholder:"https://"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Observações"}),e.jsx("textarea",{className:"form-textarea",value:m.observacoes,onChange:a=>f(o=>({...o,observacoes:a.target.value}))})]}),e.jsx("button",{className:"btn btn-primary",type:"button",onClick:Y,disabled:C,children:C?"Salvando...":"Vincular acompanhante"})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[620px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Telefone"}),e.jsx("th",{children:"Parentesco"}),e.jsx("th",{children:"Papel"}),e.jsx("th",{children:"Documento"}),n&&e.jsx("th",{children:"Ações"})]})}),e.jsxs("tbody",{children:[(r.viagem_acompanhantes||[]).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:n?7:6,children:"Nenhum acompanhante vinculado."})}),(r.viagem_acompanhantes||[]).map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_acompanhantes?.nome_completo||"-"}),e.jsx("td",{children:a.cliente_acompanhantes?.cpf||"-"}),e.jsx("td",{children:a.cliente_acompanhantes?.telefone||"-"}),e.jsx("td",{children:a.cliente_acompanhantes?.grau_parentesco||"-"}),e.jsx("td",{children:a.papel||"-"}),e.jsx("td",{children:a.documento_url?e.jsx("a",{className:"btn btn-light",href:a.documento_url,target:"_blank",rel:"noreferrer",children:"Abrir"}):"-"}),n&&e.jsx("td",{children:e.jsx("button",{className:"btn btn-light",type:"button",onClick:()=>ee(a.id),disabled:C,children:"Remover"})})]},a.id))]})]})})]}),e.jsxs("div",{className:"card-base",style:{border:"1px solid #e2e8f0"},children:[e.jsxs("h3",{style:{marginBottom:8},children:["Serviços da viagem (",A.length,")"]}),g&&e.jsxs("div",{className:"card-base",style:{marginBottom:12,border:"1px dashed #cbd5e1",background:"#f8fafc"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:x?"Editar serviço":"Adicionar serviço"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:s.tipo,onChange:a=>i(o=>({...o,tipo:a.target.value})),children:[e.jsx("option",{value:"aereo",children:"Aéreo"}),e.jsx("option",{value:"hotel",children:"Hotel"}),e.jsx("option",{value:"terrestre",children:"Terrestre"}),e.jsx("option",{value:"seguro",children:"Seguro"}),e.jsx("option",{value:"passeio",children:"Passeio"}),e.jsx("option",{value:"outro",children:"Outro"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Fornecedor"}),e.jsx("input",{className:"form-input",value:s.fornecedor,onChange:a=>i(o=>({...o,fornecedor:a.target.value})),placeholder:"Nome do fornecedor"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:s.status,onChange:a=>i(o=>({...o,status:a.target.value})),children:[e.jsx("option",{value:"ativo",children:"Ativo"}),e.jsx("option",{value:"pendente",children:"Pendente"}),e.jsx("option",{value:"cancelado",children:"Cancelado"}),e.jsx("option",{value:"concluido",children:"Concluído"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Voucher URL"}),e.jsx("input",{className:"form-input",value:s.voucher_url,onChange:a=>i(o=>({...o,voucher_url:a.target.value})),placeholder:"https://"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:s.data_inicio,onChange:a=>i(o=>({...o,data_inicio:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:s.data_fim,onChange:a=>i(o=>({...o,data_fim:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor"}),e.jsx("input",{type:"number",step:"0.01",className:"form-input",value:s.valor,onChange:a=>i(o=>({...o,valor:a.target.value})),placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Moeda"}),e.jsx("input",{className:"form-input",value:s.moeda,onChange:a=>i(o=>({...o,moeda:a.target.value})),placeholder:"BRL"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Descrição"}),e.jsx("input",{className:"form-input",value:s.descricao,onChange:a=>i(o=>({...o,descricao:a.target.value})),placeholder:"Descrição resumida do serviço"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Observações"}),e.jsx("textarea",{className:"form-textarea",value:s.observacoes,onChange:a=>i(o=>({...o,observacoes:a.target.value}))})]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{className:"btn btn-primary",type:"button",onClick:oe,disabled:D,children:D?"Salvando...":x?"Salvar alterações":"Adicionar serviço"}),x&&e.jsx("button",{className:"btn btn-light",type:"button",onClick:B,disabled:D,children:"Cancelar edição"})]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Fornecedor"}),e.jsx("th",{children:"Descrição"}),e.jsx("th",{children:"Período"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Voucher"}),n&&e.jsx("th",{children:"Ações"})]})}),e.jsxs("tbody",{children:[A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:n?8:7,children:"Nenhum serviço cadastrado."})}),A.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.tipo||"-"}),e.jsx("td",{children:a.fornecedor||"-"}),e.jsx("td",{children:a.descricao||"-"}),e.jsx("td",{children:(a.data_inicio?new Date(a.data_inicio).toLocaleDateString("pt-BR"):"-")+" / "+(a.data_fim?new Date(a.data_fim).toLocaleDateString("pt-BR"):"-")}),e.jsx("td",{children:a.valor!==null&&a.valor!==void 0?Number(a.valor).toLocaleString("pt-BR",{style:"currency",currency:a.moeda||"BRL"}):"-"}),e.jsx("td",{children:a.status||"-"}),e.jsx("td",{children:a.voucher_url?e.jsx("a",{className:"btn btn-light",href:a.voucher_url,target:"_blank",rel:"noreferrer",children:"Abrir"}):"-"}),n&&e.jsxs("td",{style:{display:"flex",gap:6},children:[e.jsx("button",{className:"btn btn-light",type:"button",onClick:()=>ae(a),children:"Editar"}),e.jsx("button",{className:"btn btn-light",type:"button",onClick:()=>re(a.id),disabled:U===a.id,children:U===a.id?"Removendo...":"Remover"})]})]},a.id))]})]})})]}),e.jsxs("div",{className:"card-base border border-slate-200",children:[e.jsxs("h3",{className:"mb-2",children:["Documentos / vouchers (",E.length,")"]}),g&&e.jsxs("div",{className:"card-base mb-3 border border-dashed border-slate-300 bg-slate-50",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Enviar documento"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Título"}),e.jsx("input",{className:"form-input",value:R,onChange:a=>I(a.target.value),placeholder:"Ex: Voucher do hotel"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:K,onChange:a=>W(a.target.value),children:[e.jsx("option",{value:"voucher",children:"Voucher"}),e.jsx("option",{value:"bilhete",children:"Bilhete"}),e.jsx("option",{value:"roteiro",children:"Roteiro"}),e.jsx("option",{value:"seguro",children:"Seguro"}),e.jsx("option",{value:"outro",children:"Outro"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Arquivo"}),e.jsx("input",{type:"file",className:"form-input",onChange:a=>G(a.target.files?.[0]||null)})]})]}),e.jsx("button",{className:"btn btn-primary",type:"button",onClick:se,disabled:H,children:H?"Enviando...":"Enviar documento"}),e.jsxs("div",{className:"text-xs text-slate-500 mt-2",children:["Bucket sugerido: ",V," (público ou via URL assinada)."]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[640px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Título"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Arquivo"}),e.jsx("th",{children:"Tamanho"}),e.jsx("th",{children:"Criado em"}),n&&e.jsx("th",{children:"Ações"})]})}),e.jsxs("tbody",{children:[E.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:n?6:5,children:"Nenhum documento."})}),E.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.titulo||"-"}),e.jsx("td",{children:a.tipo||"-"}),e.jsx("td",{children:a.url?e.jsx("a",{className:"btn btn-light",href:a.url,target:"_blank",rel:"noreferrer",children:"Abrir"}):"-"}),e.jsx("td",{children:a.size_bytes?`${(Number(a.size_bytes)/1024).toFixed(1)} KB`:"-"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),n&&e.jsx("td",{children:e.jsx("button",{className:"btn btn-light",type:"button",onClick:()=>le(a.id),disabled:Z===a.id,children:Z===a.id?"Removendo...":"Remover"})})]},a.id))]})]})})]})]}),!_&&!r&&!w&&e.jsx("div",{style:{marginTop:12},children:"Viagem não encontrada ou sem permissão."})]})}export{pe as default};
