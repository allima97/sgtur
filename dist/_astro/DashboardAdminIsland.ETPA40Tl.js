import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as t}from"./index.C0Fn7Wtz.js";import{s as n}from"./supabase.Ng8nq9tn.js";import{u as Fe}from"./usePermissao.DiLe8-Rs.js";import{u as De,C as Re}from"./CredentialsForm.D_8FEnNE.js";import{L as Pe}from"./LoadingUsuarioContext.BaDUNi7o.js";const le={nome_empresa:"",nome_fantasia:"",cnpj:"",cidade:"",estado:"",active:!0},oe={id:"",nome_completo:"",email:"",company_id:"",user_type_id:"",active:!0};function Le(){const{ativo:ie,loading:ne}=Fe("AdminDashboard"),[de,L]=t.useState(!0),[J,m]=t.useState(null),[b,ce]=t.useState([]),[v,me]=t.useState([]),[_,ue]=t.useState([]),[w,pe]=t.useState({clientes:0,vendas:0,produtos:0,tipos:0}),[i,h]=t.useState(le),[d,f]=t.useState(oe),[Q,he]=t.useState([]),[$,xe]=t.useState([]),[u,F]=t.useState(null),[B,E]=t.useState([]),[M,g]=t.useState(!1),[H,j]=t.useState(null),[fe,D]=t.useState(!1),[je,R]=t.useState(!1),[be,P]=t.useState(!1),[ve,k]=t.useState(!1),[K,z]=t.useState(""),[W,O]=t.useState(""),[X,T]=t.useState(""),[Y,I]=t.useState(!0),Z=t.useMemo(()=>Object.fromEntries(b.map(s=>[s.id,s.nome_fantasia])),[b]),ge=t.useMemo(()=>v.filter(s=>(s.user_types?.name||"").toUpperCase().includes("VENDEDOR")),[v]),ee=t.useMemo(()=>{const s={};return $.forEach(a=>{a.ativo&&(s[a.gestor_id]||(s[a.gestor_id]=[]),s[a.gestor_id].push(a.vendedor_id))}),s},[$]),Ne=t.useMemo(()=>_.find(s=>s.id===u)||null,[_,u]);t.useEffect(()=>{u&&E(ee[u]||[])},[ee,u]);const N=t.useCallback(async()=>{try{L(!0),m(null);const[s,a,r,x]=await Promise.all([n.from("companies").select("*").order("nome_fantasia"),n.from("users").select("id, nome_completo, email, active, company_id, user_type_id, user_types(name)").order("nome_completo"),n.from("user_types").select("id, name").order("name"),n.from("gestor_vendedor").select("id, gestor_id, vendedor_id, ativo")]);if(s.error||a.error||r.error||x.error)throw s.error||a.error||r.error||x.error;const A=s.data||[],y=a.data||[],C=r.data||[],q=x.data||[],G=y.filter(o=>(o.user_types?.name||"").toUpperCase().includes("GESTOR")),p={};q.forEach(o=>{o.ativo&&(p[o.gestor_id]||(p[o.gestor_id]=[]),p[o.gestor_id].push(o.vendedor_id))}),ce(A),me(y),he(C),xe(q);const re=G.map(o=>({id:o.id,nome_completo:o.nome_completo,vendedores:p[o.id]?.length||0}));ue(re);const S=[{chave:"clientes",tabela:"clientes"},{chave:"vendas",tabela:"vendas"},{chave:"produtos",tabela:"produtos"},{chave:"tipos",tabela:"tipo_produtos"}],l={clientes:0,vendas:0,produtos:0,tipos:0};for(const{chave:o,tabela:Ae}of S){const{count:qe}=await n.from(Ae).select("*",{count:"exact",head:!0});l[o]=qe||0}pe(l)}catch(s){console.error(s),m("Erro ao carregar dados administrativos.")}finally{L(!1)}},[]),c=De({successMessage:"Usuário cadastrado! Ele receberá instruções por e-mail para validar o endereço e, no primeiro acesso, completar o perfil.",onSuccess:async s=>{await n.from("users").upsert({id:s.id,email:s.email,nome_completo:K||null,company_id:W||null,user_type_id:X||null,active:Y,uso_individual:!1}),j("Usuário criado com sucesso."),await N(),k(!1),z(""),O(""),T(""),I(!0)}}),[_e,ye]=t.useState(!1);t.useEffect(()=>{async function s(){try{const{data:a}=await n.auth.getUser();if(!a?.user)return;const{data:r}=await n.from("users").select("id, user_types(name)").eq("id",a.user.id).maybeSingle(),x=r?.user_types?.name?.toUpperCase()||"";ye(x.includes("ADMIN"))}catch(a){console.error(a)}}s()},[]),t.useEffect(()=>{N()},[N]);const V=()=>{h(le)},U=()=>{f(oe)},Ce=s=>{h({id:s.id,nome_empresa:s.nome_empresa,nome_fantasia:s.nome_fantasia,cnpj:s.cnpj,cidade:s.cidade||"",estado:s.estado||"",active:s.active!==!1})},se=s=>{f({id:s.id,nome_completo:s.nome_completo,email:s.email||"",company_id:s.company_id||"",user_type_id:s.user_type_id||"",active:s.active})},ae=s=>{s?Ce(s):V(),D(!0)},Se=s=>{s?se(s):U(),R(!0)},te=s=>{s?F(s):(F(null),E([])),P(!0)},we=()=>{z(""),O(""),T(""),I(!0),c.resetFields(),k(!0)},Ee=s=>{E(a=>a.includes(s)?a.filter(r=>r!==s):[...a,s])};async function Me(s){s.preventDefault(),g(!0),m(null),j(null);try{const a={nome_empresa:i.nome_empresa,nome_fantasia:i.nome_fantasia,cnpj:i.cnpj,cidade:i.cidade||null,estado:i.estado||null,active:i.active};if(i.id){a.id=i.id;const{error:r}=await n.from("companies").update(a).eq("id",i.id);if(r)throw r}else{const{error:r}=await n.from("companies").insert(a);if(r)throw r}j("Empresa salva com sucesso."),V(),D(!1),await N()}catch(a){console.error(a),m("Não foi possível salvar a empresa.")}finally{g(!1)}}async function ke(s){if(s.preventDefault(),!d.id){m("Selecione um usuário para editar.");return}g(!0),m(null),j(null);try{const a={nome_completo:d.nome_completo,email:d.email||null,company_id:d.company_id||null,user_type_id:d.user_type_id||null,active:d.active},{error:r}=await n.from("users").update(a).eq("id",d.id);if(r)throw r;j("Usuário atualizado com sucesso."),U(),R(!1),await N()}catch(a){console.error(a),m("Não foi possível atualizar o usuário.")}finally{g(!1)}}async function Ue(s){if(s.preventDefault(),!u){m("Selecione um gestor para atualizar a equipe.");return}g(!0),m(null),j(null);try{const{data:a,error:r}=await n.from("gestor_vendedor").select("id, gestor_id, vendedor_id, ativo").eq("gestor_id",u);if(r)throw r;const x=a||[],A=new Map(x.map(l=>[l.vendedor_id,l])),y=x.filter(l=>l.ativo).map(l=>l.vendedor_id),C=B,q=C.filter(l=>!y.includes(l)),G=y.filter(l=>!C.includes(l)),p=[];for(const l of q){const o=A.get(l);o?p.push(n.from("gestor_vendedor").update({ativo:!0}).eq("id",o.id)):p.push(n.from("gestor_vendedor").insert({gestor_id:u,vendedor_id:l,ativo:!0}))}for(const l of G){const o=A.get(l);o&&p.push(n.from("gestor_vendedor").update({ativo:!1}).eq("id",o.id))}const S=(await Promise.all(p)).find(l=>l?.error);if(S&&S.error)throw S.error;j("Equipe do gestor atualizada."),await N(),E(C),P(!1)}catch(a){console.error(a),m("Não foi possível atualizar a equipe do gestor.")}finally{g(!1)}}return ne?e.jsx(Pe,{}):!ie||!_e?e.jsx("div",{style:{padding:20},children:e.jsx("h3",{children:"Apenas administradores podem acessar este dashboard."})}):e.jsxs("div",{className:"dashboard-admin-page",children:[H&&e.jsx("div",{className:"card-base card-green mb-3",children:H}),e.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-rose-950 border border-rose-700 text-rose-100",children:[e.jsx("strong",{children:"Dashboard Administrativo"})," — Controle Geral do Sistema"]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsx("h3",{className:"mb-3 font-semibold text-lg",children:"Visão geral do sistema"}),e.jsxs("div",{className:"grid gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Clientes"}),e.jsx("div",{className:"kpi-value",children:w.clientes})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Vendas"}),e.jsx("div",{className:"kpi-value",children:w.vendas})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Produtos"}),e.jsx("div",{className:"kpi-value",children:w.produtos})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Tipos de produto"}),e.jsx("div",{className:"kpi-value",children:w.tipos})]})]})]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsx("h3",{className:"font-semibold mb-0",children:"Empresas cadastradas"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>ae(),children:"Nova empresa"})]}),e.jsx("div",{className:"table-container overflow-x-auto mt-4",children:e.jsxs("table",{className:"table-default table-header-red min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome fantasia"}),e.jsx("th",{children:"Razão social"}),e.jsx("th",{children:"CNPJ"}),e.jsx("th",{children:"UF"}),e.jsx("th",{children:"Ativa"}),e.jsx("th",{children:"Ações"})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhuma empresa cadastrada."})}):b.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nome_fantasia}),e.jsx("td",{children:s.nome_empresa}),e.jsx("td",{children:s.cnpj}),e.jsx("td",{children:s.estado||"-"}),e.jsx("td",{className:s.active?"text-emerald-500 font-bold":"text-rose-500 font-bold",children:s.active?"Sim":"Não"}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>ae(s),children:"Editar"})})]},s.id))})]})})]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsx("h3",{className:"font-semibold mb-0",children:"Usuários do sistema"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:we,children:"Novo usuário"})]}),e.jsx("div",{className:"table-container overflow-x-auto mt-4",children:e.jsxs("table",{className:"table-default table-header-red min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Empresa"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Ações"})]})}),e.jsx("tbody",{children:v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum usuário encontrado."})}):v.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nome_completo}),e.jsx("td",{children:s.email||"-"}),e.jsx("td",{children:s.user_types?.name||"—"}),e.jsx("td",{children:s.company_id?Z[s.company_id]||"-":"—"}),e.jsx("td",{className:s.active?"text-emerald-500 font-bold":"text-rose-500 font-bold",children:s.active?"Sim":"Não"}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>Se(s),children:"Editar"})})]},s.id))})]})})]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsx("h3",{className:"font-semibold mb-0",children:"Gestores & equipes"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>te(),children:"Nova equipe"})]}),e.jsx("div",{className:"table-container overflow-x-auto mt-4",children:e.jsxs("table",{className:"table-default table-header-red min-w-[640px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Gestor"}),e.jsx("th",{children:"Qtd. Vendedores"}),e.jsx("th",{children:"Ações"})]})}),e.jsx("tbody",{children:_.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:3,children:"Nenhum gestor encontrado."})}):_.map(s=>e.jsxs("tr",{className:u===s.id?"bg-slate-700/10":"",children:[e.jsx("td",{children:s.nome_completo}),e.jsx("td",{children:s.vendedores}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>te(s.id),children:"Gerir equipe"})})]},s.id))})]})})]}),J&&e.jsx("div",{className:"card-base card-config",children:J}),de&&e.jsx("div",{children:"Carregando dados..."}),fe&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/50 flex justify-center items-center p-4",children:e.jsxs("form",{className:"card-base card-config w-full max-w-xl",onSubmit:Me,children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:i.id?"Editar empresa":"Nova empresa"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>D(!1),children:"Fechar"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome fantasia"}),e.jsx("input",{className:"form-input",value:i.nome_fantasia,onChange:s=>h(a=>({...a,nome_fantasia:s.target.value})),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Razão social"}),e.jsx("input",{className:"form-input",value:i.nome_empresa,onChange:s=>h(a=>({...a,nome_empresa:s.target.value})),required:!0})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"CNPJ"}),e.jsx("input",{className:"form-input",value:i.cnpj,onChange:s=>h(a=>({...a,cnpj:s.target.value})),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cidade"}),e.jsx("input",{className:"form-input",value:i.cidade,onChange:s=>h(a=>({...a,cidade:s.target.value}))})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Estado (UF)"}),e.jsx("input",{className:"form-input",value:i.estado,onChange:s=>h(a=>({...a,estado:s.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativa?"}),e.jsxs("select",{className:"form-select",value:i.active?"true":"false",onChange:s=>h(a=>({...a,active:s.target.value==="true"})),children:[e.jsx("option",{value:"true",children:"Sim"}),e.jsx("option",{value:"false",children:"Não"})]})]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mt-3",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:M,children:"Salvar empresa"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:V,children:"Limpar"})]})]})}),je&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/50 flex justify-center items-center p-4",children:e.jsxs("form",{className:"card-base card-config w-full max-w-xl",onSubmit:ke,children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Editar usuário"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>R(!1),children:"Fechar"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Selecione o usuário"}),e.jsxs("select",{className:"form-select",value:d.id,onChange:s=>{const a=v.find(r=>r.id===s.target.value);a?se(a):U()},children:[e.jsx("option",{value:"",children:"Selecione"}),v.map(s=>e.jsx("option",{value:s.id,children:s.nome_completo},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome completo"}),e.jsx("input",{className:"form-input",value:d.nome_completo,onChange:s=>f(a=>({...a,nome_completo:s.target.value})),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"E-mail"}),e.jsx("input",{className:"form-input",value:d.email,onChange:s=>f(a=>({...a,email:s.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo de usuário"}),e.jsxs("select",{className:"form-select",value:d.user_type_id,onChange:s=>f(a=>({...a,user_type_id:s.target.value})),children:[e.jsx("option",{value:"",children:"Selecione"}),Q.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Empresa"}),e.jsxs("select",{className:"form-select",value:d.company_id,onChange:s=>f(a=>({...a,company_id:s.target.value})),children:[e.jsx("option",{value:"",children:"Sem empresa"}),b.map(s=>e.jsx("option",{value:s.id,children:s.nome_fantasia},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-select",value:d.active?"true":"false",onChange:s=>f(a=>({...a,active:s.target.value==="true"})),children:[e.jsx("option",{value:"true",children:"Sim"}),e.jsx("option",{value:"false",children:"Não"})]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mt-3",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:M,children:"Atualizar usuário"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:U,children:"Limpar"})]})]})}),be&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/50 flex justify-center items-center p-4",children:e.jsxs("form",{className:"card-base card-config w-full max-w-xl",onSubmit:Ue,children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Gestores & equipes"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>P(!1),children:"Fechar"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Selecione o gestor"}),e.jsxs("select",{className:"form-select",value:u||"",onChange:s=>{const a=s.target.value||null;F(a)},children:[e.jsx("option",{value:"",children:"Selecione"}),_.map(s=>e.jsx("option",{value:s.id,children:s.nome_completo},s.id))]})]}),Ne?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-wrap gap-2 max-h-48 overflow-y-auto mb-2",children:ge.map(s=>e.jsxs("label",{className:"flex items-center gap-2 border border-slate-500 rounded px-2 py-1",children:[e.jsx("input",{type:"checkbox",checked:B.includes(s.id),onChange:()=>Ee(s.id),disabled:M}),e.jsxs("span",{children:[s.nome_completo,s.company_id?` (${Z[s.company_id]||"—"})`:""]})]},s.id))}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:M,children:"Salvar equipe"})]}):e.jsx("p",{children:"Escolha um gestor para configurar a equipe."})]})}),ve&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/50 flex justify-center items-center p-4",children:e.jsxs("form",{className:"card-base card-config w-full max-w-xl",onSubmit:c.handleSubmit,children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("h4",{className:"text-lg font-semibold",children:"Cadastro administrativo de usuário"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>k(!1),children:"Fechar"})]}),c.message&&e.jsx("div",{className:"card-base card-config mb-3",children:c.message}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome completo"}),e.jsx("input",{className:"form-input",value:K,onChange:s=>z(s.target.value),required:!0,placeholder:"Nome do usuário"})]}),e.jsx(Re,{email:c.email,password:c.password,confirmPassword:c.confirmPassword,onEmailChange:c.setEmail,onPasswordChange:c.setPassword,onConfirmPasswordChange:c.setConfirmPassword,disabled:c.loading}),e.jsxs("div",{className:"form-row mt-2",children:[e.jsxs("div",{className:"form-group flex-1",children:[e.jsx("label",{className:"form-label",children:"Tipo de usuário"}),e.jsxs("select",{className:"form-select",value:X,onChange:s=>T(s.target.value),children:[e.jsx("option",{value:"",children:"Selecione"}),Q.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group flex-1",children:[e.jsx("label",{className:"form-label",children:"Empresa"}),e.jsxs("select",{className:"form-select",value:W,onChange:s=>O(s.target.value),children:[e.jsx("option",{value:"",children:"Sem empresa"}),b.map(s=>e.jsx("option",{value:s.id,children:s.nome_fantasia},s.id))]})]}),e.jsxs("div",{className:"form-group flex-1",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-select",value:Y?"true":"false",onChange:s=>I(s.target.value==="true"),children:[e.jsx("option",{value:"true",children:"Sim"}),e.jsx("option",{value:"false",children:"Não"})]})]})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mt-3",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:c.loading,children:"Criar usuário"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>k(!1),children:"Cancelar"})]})]})})]})}export{Le as default};
