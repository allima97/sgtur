import{j as a,s as c}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as Z}from"./usePermissao.72SYthuA.js";import{r as A}from"./logs.WCvMC_es.js";function _(f){return(f||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const T={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},ee={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function ie(){const{permissao:f,ativo:q,loading:V,isAdmin:D}=Z("Vendas"),E=f==="create"||f==="edit"||f==="delete"||f==="admin",[j,k]=r.useState([]),[N,O]=r.useState([]),[w,W]=r.useState([]),[s,b]=r.useState(T),[p,h]=r.useState([]),[l,$]=r.useState(null),[P,u]=r.useState(null),[L,y]=r.useState(!1),[ae,B]=r.useState(!0),[te,R]=r.useState(!1),[v,G]=r.useState(""),[x,H]=r.useState(""),[g,J]=r.useState("");async function K(e){try{B(!0);const[t,o,n]=await Promise.all([c.from("clientes").select("id, nome, cpf").order("nome"),c.from("produtos").select("id, nome").order("nome"),c.from("tipo_produtos").select("id, nome").order("nome")]);k(t.data||[]),O(o.data||[]),W(n.data||[]),e&&await F(e)}catch(t){console.error(t),u("Erro ao carregar dados.")}finally{B(!1)}}async function F(e){try{R(!0);const{data:t,error:o}=await c.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(o)throw o;if(!t){u("Venda nÃ£o encontrada para ediÃ§Ã£o.");return}b({cliente_id:t.cliente_id,destino_id:t.destino_id,data_lancamento:t.data_lancamento,data_embarque:t.data_embarque||""});const{data:n,error:d}=await c.from("vendas_recibos").select("*").eq("venda_id",e);if(d)throw d;h((n||[]).map(i=>({id:i.id,produto_id:i.produto_id||"",numero_recibo:i.numero_recibo||"",valor_total:i.valor_total!=null?String(i.valor_total):"",valor_taxas:i.valor_taxas!=null?String(i.valor_taxas):"0"})))}catch(t){console.error(t),u("Erro ao carregar venda para ediÃ§Ã£o.")}finally{R(!1)}}r.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&$(t)},[]),r.useEffect(()=>{!V&&q&&K(l||void 0)},[V,q,l]);const C=e=>e.replace(/\D/g,""),z=r.useMemo(()=>{if(!v.trim())return j;const e=_(v);return j.filter(t=>{const o=C(t.cpf||"");return _(t.nome).includes(e)||o.includes(C(e))})},[j,v]),I=r.useMemo(()=>{if(!x.trim())return N;const e=_(x);return N.filter(t=>_(t.nome).includes(e))},[N,x]),M=r.useMemo(()=>{if(!g.trim())return w;const e=_(g);return w.filter(t=>_(t.nome).includes(e))},[w,g]);function Q(){h(e=>[...e,{...ee}])}function S(e,t,o){h(n=>{const d=[...n];return d[e][t]=o,d})}function X(e){h(t=>t.filter((o,n)=>n!==e))}async function Y(e){if(e.preventDefault(),!E&&!D){u("VocÃª nÃ£o possui permissÃ£o para cadastrar vendas.");return}if(p.length===0){u("Uma venda precisa ter ao menos 1 recibo.");return}try{y(!0),u(null);const{data:t}=await c.auth.getUser(),o=t?.user?.id;if(!o){u("UsuÃ¡rio nÃ£o autenticado."),y(!1);return}let n=l;if(l){const{error:d}=await c.from("vendas").update({cliente_id:s.cliente_id,destino_id:s.destino_id,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).eq("id",l);if(d)throw d;await c.from("vendas_recibos").delete().eq("venda_id",l);for(const i of p){const{error:m}=await c.from("vendas_recibos").insert({venda_id:l,produto_id:i.produto_id||null,numero_recibo:i.numero_recibo.trim(),valor_total:Number(i.valor_total),valor_taxas:Number(i.valor_taxas)});if(m)throw m}await A({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:l,venda:s,recibos:p}}),alert("Venda atualizada com sucesso!"),await F(l)}else{const{data:d,error:i}=await c.from("vendas").insert({vendedor_id:o,cliente_id:s.cliente_id,destino_id:s.destino_id,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).select().single();if(i)throw i;n=d.id;for(const m of p){const{error:U}=await c.from("vendas_recibos").insert({venda_id:n,produto_id:m.produto_id||null,numero_recibo:m.numero_recibo.trim(),valor_total:Number(m.valor_total),valor_taxas:Number(m.valor_taxas)});if(U)throw U}await A({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:s,recibos:p,id:n}}),alert("Venda cadastrada com sucesso!"),b(T),h([])}}catch(t){console.error(t),u("Erro ao salvar venda.")}finally{y(!1)}}return q?!E&&!D?a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"VocÃª nÃ£o possui permissÃ£o para cadastrar vendas."})}):a.jsx("div",{className:"vendas-cadastro-page",children:a.jsxs("div",{className:"card-base card-green mb-3",children:[a.jsx("h3",{children:l?"Editar venda":"Cadastro de Venda"}),l&&a.jsx("small",{style:{color:"#0f172a"},children:"Modo ediÃ§Ã£o â€” altere cliente, destino, embarque e recibos."}),P&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:P})}),a.jsxs("form",{onSubmit:Y,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente *"}),a.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:j.find(e=>e.id===s.cliente_id)?.nome||v,onChange:e=>G(e.target.value),onBlur:()=>{const e=v.toLowerCase(),t=C(v),o=z.find(n=>{const d=C(n.cpf||"");return n.nome.toLowerCase()===e||t&&d===t});o&&b({...s,cliente_id:o.id})},required:!0}),a.jsx("datalist",{id:"listaClientes",children:z.map(e=>a.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino *"}),a.jsx("input",{className:"form-input",list:"listaDestinos",placeholder:"Buscar destino...",value:N.find(e=>e.id===s.destino_id)?.nome||x,onChange:e=>H(e.target.value),onBlur:()=>{const e=I.find(t=>t.nome.toLowerCase()===x.toLowerCase());e&&b({...s,destino_id:e.id})},required:!0}),a.jsx("datalist",{id:"listaDestinos",children:I.map(e=>a.jsx("option",{value:e.nome},e.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data de embarque"}),a.jsx("input",{className:"form-input",type:"date",value:s.data_embarque,onChange:e=>b({...s,data_embarque:e.target.value})})]})]}),a.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),p.map((e,t)=>a.jsx("div",{className:"card-base mb-2",children:a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto *"}),a.jsx("input",{className:"form-input",list:"listaProdutos",placeholder:"Buscar produto...",value:w.find(o=>o.id===e.produto_id)?.nome||g,onChange:o=>J(o.target.value),onBlur:()=>{const o=M.find(n=>n.nome.toLowerCase()===g.toLowerCase());o&&S(t,"produto_id",o.id)},required:!0}),a.jsx("datalist",{id:"listaProdutos",children:M.map(o=>a.jsx("option",{value:o.nome},o.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"NÃºmero recibo *"}),a.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:o=>S(t,"numero_recibo",o.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor total *"}),a.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_total,onChange:o=>S(t,"valor_total",o.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Taxas"}),a.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_taxas,onChange:o=>S(t,"valor_taxas",o.target.value)})]}),a.jsx("div",{className:"form-group",style:{width:"80px"},children:a.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>X(t),children:"ğŸ—‘ï¸"})})]})},t)),a.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[a.jsx("button",{type:"button",className:"btn btn-primary",onClick:Q,children:"â• Adicionar recibo"}),a.jsx("button",{type:"submit",className:"btn btn-success",disabled:L,children:L?"Salvando...":"Salvar venda"})]})]})]})}):a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Vendas."})})}export{ie as default};
