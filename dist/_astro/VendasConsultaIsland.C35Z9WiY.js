import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as x}from"./supabase.Ng8nq9tn.js";import{r as T}from"./logs.DwCrXgEk.js";import{u as he}from"./usePermissao.DiLe8-Rs.js";import{L as fe}from"./LoadingUsuarioContext.BaDUNi7o.js";function A(u){return(u||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function ye(){const{permissao:u,ativo:Z,loading:V,isAdmin:ee}=he("Vendas"),N=u!=="none",ae=u==="create"||u==="edit"||u==="delete"||u==="admin",q=u==="edit"||u==="delete"||u==="admin",j=u==="delete"||u==="admin",[h,te]=i.useState(null),[ne,B]=i.useState(!0),[I,se]=i.useState([]),[ie,F]=i.useState([]),[S,de]=i.useState(""),[M,_]=i.useState(null),[L,$]=i.useState(!0),[O,U]=i.useState(null),[o,E]=i.useState(null),[k,W]=i.useState(!1),[P,z]=i.useState(!1),[G,H]=i.useState(null),[Y,J]=i.useState([]),[re,oe]=i.useState(0);i.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&U(t)},[]),i.useEffect(()=>{async function a(){try{_(null),B(!0);const{data:t}=await x.auth.getUser(),s=t?.user?.id;if(!s){_("Usu√°rio n√£o autenticado.");return}const{data:c}=await x.from("users").select("id, user_types(name)").eq("id",s).maybeSingle(),d=c?.user_types?.name||t?.user?.user_metadata?.name||"",r=String(d||"").toUpperCase();let f="VENDEDOR";r.includes("ADMIN")?f="ADMIN":r.includes("GESTOR")?f="GESTOR":r.includes("VENDEDOR")?f="VENDEDOR":f="OUTRO";let n=[s];if(f==="GESTOR"){const{data:l}=await x.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",s),b=l?.map(v=>v.vendedor_id).filter(v=>!!v)||[];n=Array.from(new Set([s,...b]))}else f==="ADMIN"&&(n=[]);te({usuarioId:s,papel:f,vendedorIds:n})}catch(t){console.error(t),_("Erro ao carregar contexto do usu√°rio.")}finally{B(!1)}}a()},[]);async function w(){if(!(!N||!h))try{$(!0);let a=x.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          destino_cidade_id,
          data_lancamento,
          data_embarque,
          clientes(nome),
          destinos:produtos!destino_id (
            nome,
            cidade_id
          )
        `).order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(a=a.in("vendedor_id",h.vendedorIds));const{data:t,error:s}=await a;if(s)throw s;const c=Array.from(new Set((t||[]).map(n=>n.destino_cidade_id||n.destinos?.cidade_id).filter(n=>!!n)));let d={};if(c.length>0){const{data:n,error:l}=await x.from("cidades").select("id, nome").in("id",c);l?console.error(l):d=Object.fromEntries((n||[]).map(b=>[b.id,b.nome]))}const r=(t||[]).map(n=>{const l=n.destino_cidade_id||n.destinos?.cidade_id||"";return{id:n.id,vendedor_id:n.vendedor_id,cliente_id:n.cliente_id,destino_id:n.destino_id,destino_cidade_id:l,data_lancamento:n.data_lancamento,data_embarque:n.data_embarque,cliente_nome:n.clientes?.nome||"",destino_nome:n.destinos?.nome||"",destino_cidade_nome:l&&d[l]||""}});se(r);const f=r.map(n=>n.id);if(f.length===0)F([]);else{const{data:n}=await x.from("vendas_recibos").select("*").in("venda_id",f),l=Array.from(new Set((n||[]).map(m=>m.produto_id).filter(m=>!!m))),b=r.reduce((m,p)=>(p.destino_cidade_id&&(m[p.id]=p.destino_cidade_id),m),{});let v=[],X={};if(l.length>0){const{data:m,error:p}=await x.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").in("tipo_produto",l);!p&&m?v=m:p&&console.error(p);const{data:C,error:D}=await x.from("tipo_produtos").select("id, nome").in("id",l);!D&&C?X=Object.fromEntries(C.map(y=>[y.id,y.nome||"Produto"])):D&&console.error(D)}const ue=(n||[]).map(m=>{const p=b[m.venda_id]||"",C=v.find(y=>{const xe=!!y?.todas_as_cidades;return y.tipo_produto===m.produto_id&&(xe||!p||y.cidade_id===p)}),D=X[m.produto_id];return{...m,produto_nome:C?.nome||D||""}})||[];F(ue)}if(O){const n=r.find(l=>l.id===O);n&&E(n),U(null)}}catch(a){console.error(a),_("Erro ao carregar vendas."),g("Erro ao carregar vendas.","error")}finally{$(!1)}}i.useEffect(()=>{!V&&N&&h&&w()},[V,N,h]);const K=i.useMemo(()=>h?h.papel==="ADMIN"?"Todas as vendas":h.papel==="GESTOR"?"Vendas da sua equipe":"Suas vendas":"",[h]),Q=i.useMemo(()=>{if(!S.trim())return I;const a=A(S);return I.filter(t=>A(t.cliente_nome||"").includes(a)||A(t.destino_nome||"").includes(a)||A(t.id).includes(a))},[I,S]);function R(a){return ie.filter(t=>t.venda_id===a)}function g(a,t="success"){oe(c=>c+1);const s=re+1;J(c=>[...c,{id:s,message:a,type:t}]),setTimeout(()=>{J(c=>c.filter(d=>d.id!==s))},3500)}async function ce(a){if(!(!j&&!ee)&&confirm("Tem certeza que deseja CANCELAR esta venda?"))try{z(!0),await x.from("vendas_recibos").delete().eq("venda_id",a.id),await x.from("vendas").delete().eq("id",a.id),await T({acao:"venda_cancelada",modulo:"Vendas",detalhes:{id:a.id}}),await w(),E(null),g("Venda cancelada.","success")}catch(t){console.error(t),_("Erro ao cancelar venda."),g("Erro ao cancelar venda.","error")}finally{z(!1)}}async function le(a,t){if(j&&confirm("Excluir este recibo?"))try{H(a),await x.from("vendas_recibos").delete().eq("id",a),await T({acao:"recibo_excluido",modulo:"Vendas",detalhes:{recibo_id:a,venda_id:t}}),await w(),g("Recibo exclu√≠do.","success")}catch(s){console.error(s),_("Erro ao excluir recibo."),g("Erro ao excluir recibo.","error")}finally{H(null)}}async function me(a,t){if(q)try{W(!0),await x.from("vendas").update({data_embarque:t}).eq("id",a.id),await T({acao:"venda_remarcada",modulo:"Vendas",detalhes:{venda_id:a.id,nova_data:t}}),await w(),g("Data de embarque atualizada.","success")}catch(s){console.error(s),_("Erro ao remarcar venda."),g("Erro ao remarcar.","error")}finally{W(!1)}}return ne||V?e.jsx(fe,{}):Z?N?e.jsxs("div",{className:"vendas-consulta-page",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",style:{marginTop:8,display:"flex",alignItems:"end",gap:16,flexWrap:"wrap"},children:[e.jsxs("div",{className:"form-group",style:{flex:1,minWidth:0},children:[e.jsx("label",{className:"form-label",children:"Buscar venda"}),e.jsx("input",{className:"form-input",placeholder:"Nome, destino ou ID...",value:S,onChange:a=>de(a.target.value)}),K&&e.jsxs("small",{style:{color:"#64748b"},children:[K," ",h?.papel!=="ADMIN"?"(restri√ß√£o por vendedor)":""]})]}),ae&&e.jsx("div",{className:"form-group",style:{display:"flex",flexDirection:"row",gap:8,marginBottom:0,marginLeft:"auto",flexWrap:"nowrap",justifyContent:"flex-end",alignItems:"center",alignSelf:"center",marginTop:-4},children:e.jsx("a",{className:"btn btn-primary",href:"/vendas/cadastro",style:{textDecoration:"none"},children:"Nova venda"})})]})}),M&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:M})}),e.jsx("div",{className:"table-container overflow-x-auto",style:{maxHeight:"65vh",overflowY:"auto"},children:e.jsxs("table",{className:"table-default table-header-green min-w-[820px]",children:[e.jsx("thead",{style:{position:"sticky",top:0,zIndex:1},children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{style:{textAlign:"center"},children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),N&&e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando..."})}),!L&&Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma venda encontrada."})}),!L&&Q.map(a=>{const t=R(a.id).reduce((d,r)=>d+(r.valor_total||0),0),s=R(a.id).reduce((d,r)=>d+(r.valor_taxas||0),0),c=R(a.id).map(d=>d.produto_nome||"").filter(Boolean);return e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_nome}),e.jsx("td",{children:a.destino_cidade_nome||"-"}),e.jsx("td",{children:c.length===0?"-":e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:2},children:c.map((d,r)=>e.jsx("span",{children:d},`${a.id}-prod-${r}`))})}),e.jsx("td",{style:{textAlign:"center"},children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{children:["R$"," ",t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:s===0?"-":`R$ ${s.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",title:"Ver detalhes",onClick:()=>E(a),children:"üëÅÔ∏è"})})]},a.id)})]})]})}),o&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:"820px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{children:e.jsx("div",{className:"modal-title",style:{color:"#16a34a",fontSize:"1.15rem",fontWeight:800},children:"Detalhes da venda"})}),e.jsx("button",{className:"btn-ghost",onClick:()=>E(null),children:"‚úï"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",style:{display:"grid",gap:6,lineHeight:1.4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Cliente:"})," ",o.cliente_nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Cidade:"})," ",o.destino_cidade_nome||"N√£o informada"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Lan√ßada em:"})," ",new Date(o.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",o.data_embarque?new Date(o.data_embarque).toLocaleDateString("pt-BR"):"-"]})]}),e.jsx("h4",{style:{marginBottom:8,textAlign:"center"},children:"Recibos"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"N√∫mero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{style:{textAlign:"center"},children:"In√≠cio"}),e.jsx("th",{style:{textAlign:"center"},children:"Fim"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),j&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsx("tbody",{children:R(o.id).map(a=>{const t=(a.valor_total||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}),s=a.valor_taxas||0,c=s===0?"-":`R$ ${s.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`,d=r=>r?new Date(r).toLocaleDateString("pt-BR"):"-";return e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsx("td",{style:{textAlign:"center"},children:d(a.data_inicio)}),e.jsx("td",{style:{textAlign:"center"},children:d(a.data_fim)}),e.jsxs("td",{children:["R$ ",t]}),e.jsx("td",{children:c}),j&&e.jsx("td",{children:e.jsx("button",{className:"btn-icon btn-danger",disabled:G===a.id,onClick:()=>le(a.id,o.id),children:G===a.id?"‚Ä¶":"üóëÔ∏è"})})]},a.id)})})]})})]}),(q||j)&&e.jsxs("div",{className:"modal-footer",children:[q&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline",style:{minWidth:130,backgroundColor:"#f3f4f6",color:"#1f2937"},onClick:()=>{const a=`/vendas/cadastro?id=${o.id}${o.destino_cidade_id?`&cidadeId=${o.destino_cidade_id}`:""}${o.destino_cidade_nome?`&cidadeNome=${encodeURIComponent(o.destino_cidade_nome)}`:""}`;window.location.href=a},children:"Editar"}),e.jsx("button",{className:"btn btn-primary",style:{minWidth:130},onClick:()=>{const a=prompt("Nova data de embarque (AAAA-MM-DD):",o.data_embarque||"");a&&me(o,a)},disabled:k,children:k?"Salvando...":"Remarcar"})]}),j&&e.jsx("button",{className:"btn btn-danger",style:{minWidth:130},onClick:()=>ce(o),disabled:P,children:P?"Cancelando...":"Cancelar Venda"})]})]})}),Y.length>0&&e.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:Y.map(a=>e.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:a.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${a.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:a.message},a.id))})]}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para visualizar Vendas."})}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{ye as default};
