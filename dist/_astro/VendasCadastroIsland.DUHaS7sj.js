import{j as t}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as p}from"./supabase.Ng8nq9tn.js";import{u as Me}from"./usePermissao.Bkt8qSjs.js";import{r as we}from"./logs.DwCrXgEk.js";function I(b){return(b||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const ae={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},$e={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function Be(b){const w=b.replace(/\D/g,"");return w?(Number(w)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function Ne(b){const w=Number(b);return Number.isNaN(w)?"":w.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function K(b){if(!b)return NaN;const w=b.replace(/\./g,"").replace(",",".");return Number(w)}function Je(){const{permissao:b,ativo:w,loading:G,isAdmin:te}=Me("Vendas"),ie=b==="create"||b==="edit"||b==="delete"||b==="admin",[A,je]=s.useState([]),[B,Se]=s.useState([]),[f,re]=s.useState([]),[Q,Ce]=s.useState([]),[c,q]=s.useState(ae),[_,P]=s.useState([]),[j,X]=s.useState(null),[se,Y]=s.useState({id:"",nome:""}),[de,h]=s.useState(null),[ne,R]=s.useState(!1),[Fe,le]=s.useState(!0),[ke,ce]=s.useState(!1),[ue,me]=s.useState([]),[ze,ye]=s.useState(0),[M,Z]=s.useState(""),[S,F]=s.useState(""),[k,U]=s.useState(""),[De,W]=s.useState(!1),[pe,$]=s.useState([]),[O,fe]=s.useState(!1),[_e,H]=s.useState(null),[Ge,ee]=s.useState("");async function Ee(e,o){try{le(!0);const[a,i,n,x]=await Promise.all([p.from("clientes").select("id, nome, cpf").order("nome"),p.from("cidades").select("id, nome").order("nome"),p.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").order("nome"),p.from("tipo_produtos").select("id, nome, disponivel_todas_cidades")]);je(a.data||[]);const d=i.data||[];Se(d);const g=x.data||[],D=new Map(g.map(l=>[l.id,l])),m=(n.data||[]).map(l=>{const r=l.tipo_produtos;return{...l,tipo_info:r?{disponivel_todas_cidades:r.disponivel_todas_cidades}:D.has(l.tipo_produto)?{disponivel_todas_cidades:D.get(l.tipo_produto||"")?.disponivel_todas_cidades}:void 0}});re(m),Ce(g),e&&await Ve(e,d,m,o)}catch(a){console.error(a),h("Erro ao carregar dados."),N("Erro ao carregar dados.","error")}finally{le(!1)}}async function Ve(e,o,a,i){try{ce(!0);const{data:n,error:x}=await p.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(x)throw x;if(!n){h("Venda n√£o encontrada para edi√ß√£o.");return}let d="",g="";if(n.destino_id){const{data:r}=await p.from("produtos").select("id, cidade_id").eq("id",n.destino_id).maybeSingle();d=r?.cidade_id||"";const v=(o||B).find(C=>C.id===d);v&&(g=v.nome)}!d&&i?.id&&(d=i.id),!g&&i?.nome&&(g=i.nome),q({cliente_id:n.cliente_id,destino_id:d,data_lancamento:n.data_lancamento,data_embarque:n.data_embarque||""}),F(g||d||""),ee(g||d||"");const{data:D,error:m}=await p.from("vendas_recibos").select("*").eq("venda_id",e);if(m)throw m;const l=a||f;P((D||[]).map(r=>({id:r.id,produto_id:l.find(u=>{const v=!!u.tipo_info?.disponivel_todas_cidades;return u.tipo_produto===r.produto_id&&(v||!d||u.cidade_id===d)})?.id||"",numero_recibo:r.numero_recibo||"",valor_total:r.valor_total!=null?Ne(r.valor_total):"",valor_taxas:r.valor_taxas!=null?Ne(r.valor_taxas):"0,00"})))}catch(n){console.error(n),h("Erro ao carregar venda para edi√ß√£o."),N("Erro ao carregar venda para edi√ß√£o.","error")}finally{ce(!1)}}s.useEffect(()=>{const e=new URLSearchParams(window.location.search),o=e.get("id");o&&X(o);const a=e.get("cidadeId")||"",i=e.get("cidadeNome")||"";(a||i)&&Y({id:a,nome:i})},[]),s.useEffect(()=>{!G&&w&&Ee(j||void 0,se)},[G,w,j,se]),s.useEffect(()=>{if(S.trim().length<2){$([]);return}const e=new AbortController,o=setTimeout(async()=>{fe(!0),H(null);try{const{data:a,error:i}=await p.rpc("buscar_cidades",{q:S.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),H("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:n,error:x}=await p.from("cidades").select("id, nome").ilike("nome",`%${S.trim()}%`).order("nome");x?(console.error("Erro no fallback de cidades:",x),H("Erro ao buscar cidades.")):($(n||[]),H(null))}else $(a||[])}finally{e.signal.aborted||fe(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[S]);const J=e=>e.replace(/\D/g,""),ve=s.useMemo(()=>{if(!M.trim())return A;const e=I(M);return A.filter(o=>{const a=J(o.cpf||"");return I(o.nome).includes(e)||a.includes(J(e))})},[A,M]);s.useMemo(()=>{if(!S.trim())return B;const e=I(S);return B.filter(o=>I(o.nome).includes(e))},[B,S]);const be=s.useMemo(()=>{const e=Q.filter(i=>i.disponivel_todas_cidades);let o=[];if(c.destino_id){const i=f.filter(d=>!!d.tipo_info?.disponivel_todas_cidades||d.cidade_id===c.destino_id),n=new Set(i.filter(d=>d.cidade_id===c.destino_id).map(d=>d.tipo_produto)),x=e.filter(d=>!n.has(d.id)).map(d=>({id:`virtual-${d.id}`,nome:d.nome||"Produto global",cidade_id:c.destino_id,tipo_produto:d.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}));o=[...i,...x]}else o=[...f.filter(i=>!!i.tipo_info?.disponivel_todas_cidades),...e.map(i=>({id:`virtual-${i.id}`,nome:i.nome||"Produto global",cidade_id:null,tipo_produto:i.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}))];if(!k.trim())return o;const a=I(k);return o.filter(i=>I(i.nome).includes(a))},[f,Q,k,c.destino_id]),he=s.useMemo(()=>f.some(e=>e.tipo_info?.disponivel_todas_cidades),[f]),Ie=s.useMemo(()=>_.length>0,[_.length]);function qe(e){F(e);const o=B.find(a=>a.id===c.destino_id);(!o||!I(o.nome).includes(I(e)))&&q(a=>({...a,destino_id:""})),W(!0)}function N(e,o="success"){ye(a=>{const i=a+1;return me(n=>[...n,{id:i,message:e,type:o}]),setTimeout(()=>{me(n=>n.filter(x=>x.id!==i))},3500),i})}function Pe(){P(e=>[...e,{...$e}])}function oe(e,o,a){P(i=>{const n=[...i];return n[e][o]=a,n})}function xe(e,o,a){const i=Be(a);oe(e,o,i)}s.useEffect(()=>{U(""),P(e=>e.map(o=>{const a=f.find(n=>n.id===o.produto_id),i=!!a?.tipo_info?.disponivel_todas_cidades;return a&&(i||a.cidade_id===c.destino_id)?o:{...o,produto_id:""}}))},[c.destino_id,f]);function Te(e){P(o=>o.filter((a,i)=>i!==e))}function ge(){q({...ae,data_lancamento:new Date().toISOString().substring(0,10)}),P([]),X(null),Y({id:"",nome:""}),Z(""),F(""),U(""),ee(""),$([]),h(null),window.location.href="/vendas/consulta"}function Le(){q(ae),P([]),X(null),Y({id:"",nome:""}),Z(""),F(""),U(""),ee(""),$([]),h(null),window.location.href="/vendas/consulta"}async function Re(e){if(e.preventDefault(),!ie&&!te){h("Voc√™ n√£o possui permiss√£o para cadastrar vendas."),N("Voc√™ n√£o possui permiss√£o para cadastrar vendas.","error");return}if(_.length===0){h("Uma venda precisa ter ao menos 1 recibo."),N("Inclua ao menos um recibo na venda.","error");return}try{R(!0),h(null);const{data:o}=await p.auth.getUser(),a=o?.user?.id;if(!a){h("Usu√°rio n√£o autenticado."),N("Usu√°rio n√£o autenticado.","error"),R(!1);return}if(!_.length){h("Uma venda precisa ter ao menos 1 recibo."),N("Inclua ao menos um recibo na venda.","error"),R(!1);return}if(!_[0]?.produto_id){h("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),N("Selecione um produto para o recibo principal.","error"),R(!1);return}if(_.some(m=>{const l=f.find(u=>u.id===m.produto_id),r=!!l?.tipo_info?.disponivel_todas_cidades||(m.produto_id||"").startsWith("virtual-");return l?.cidade_id&&!r})&&!c.destino_id){h("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),N("Selecione a cidade de destino.","error"),R(!1);return}async function x(m){const l=m.produto_id,r=f.find(V=>V.id===l);if(r&&!r.isVirtual)return r.id;const u=r?.tipo_produto||(l?.startsWith("virtual-")?l.replace("virtual-",""):r?.tipo_produto);if(!u)throw new Error("Produto inv√°lido. Selecione novamente.");const v=c.destino_id;if(!v)throw new Error("Selecione a cidade de destino para usar produtos globais.");const C=f.find(V=>V.tipo_produto===u&&V.cidade_id===v);if(C)return C.id;const E=Q.find(V=>V.id===u),y=E?.nome||"Produto",{data:T,error:L}=await p.from("produtos").insert({nome:y,destino:y,cidade_id:v,tipo_produto:u,ativo:!0}).select("id").single();if(L)throw L;const z=T?.id;if(z)return re(V=>[...V,{id:z,nome:y,cidade_id:v,tipo_produto:u,tipo_info:{disponivel_todas_cidades:E?.disponivel_todas_cidades}}]),z;throw new Error("N√£o foi poss√≠vel criar produto global.")}const d=[];for(const m of _){const l=await x(m);d.push(l)}const g=d[0];let D=j;if(j){const{error:m}=await p.from("vendas").update({cliente_id:c.cliente_id,destino_id:g,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||null}).eq("id",j);if(m)throw m;await p.from("vendas_recibos").delete().eq("venda_id",j);for(let l=0;l<_.length;l++){const r=_[l],u=d[l],v=f.find(L=>L.id===u),C=v?.tipo_produto||(r.produto_id?.startsWith("virtual-")?r.produto_id.replace("virtual-",""):v?.tipo_produto);if(!C)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const E=K(r.valor_total),y=K(r.valor_taxas);if(Number.isNaN(E))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(y))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:T}=await p.from("vendas_recibos").insert({venda_id:j,produto_id:C,numero_recibo:r.numero_recibo.trim(),valor_total:E,valor_taxas:y});if(T)throw T}await we({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:j,venda:c,recibos:_}}),N("Venda atualizada com sucesso!","success"),setTimeout(()=>ge(),200)}else{const{data:m,error:l}=await p.from("vendas").insert({vendedor_id:a,cliente_id:c.cliente_id,destino_id:g,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||null}).select().single();if(l)throw l;D=m.id;for(let r=0;r<_.length;r++){const u=_[r],v=d[r],C=f.find(z=>z.id===v),E=C?.tipo_produto||(u.produto_id?.startsWith("virtual-")?u.produto_id.replace("virtual-",""):C?.tipo_produto);if(!E)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const y=K(u.valor_total),T=K(u.valor_taxas);if(Number.isNaN(y))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(T))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:L}=await p.from("vendas_recibos").insert({venda_id:D,produto_id:E,numero_recibo:u.numero_recibo.trim(),valor_total:y,valor_taxas:T});if(L)throw L}await we({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:c,recibos:_,id:D}}),N("Venda cadastrada com sucesso!","success"),setTimeout(()=>ge(),200)}}catch(o){console.error(o);const a=o?.message||o?.error?.message||"",i=o?.code||o?.error?.code||"";h(`Erro ao salvar venda.${i?` C√≥digo: ${i}.`:""}${a?` Detalhes: ${a}`:""}`),N("Erro ao salvar venda.","error")}finally{R(!1)}}return w?!ie&&!te?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):t.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:j?"Editar venda":"Cadastro de Venda"}),j&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),de&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:de})}),t.jsxs("form",{onSubmit:Re,children:[t.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[t.jsxs("div",{className:"form-group flex-1 min-w-[220px]",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:A.find(e=>e.id===c.cliente_id)?.nome||M,onChange:e=>Z(e.target.value),onBlur:()=>{const e=M.toLowerCase(),o=J(M),a=ve.find(i=>{const n=J(i.cpf||"");return i.nome.toLowerCase()===e||o&&n===o});a&&q({...c,cliente_id:a.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:ve.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[220px] relative",children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:S,onChange:e=>qe(e.target.value),onFocus:()=>W(!0),onBlur:()=>setTimeout(()=>W(!1),150),required:Ie,style:{marginBottom:6}}),O&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),_e&&!O&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:_e}),De&&(O||S.trim().length>=2)&&t.jsxs("div",{className:"card-base absolute left-0 right-0 mt-1 max-h-44 overflow-y-auto p-1 border border-slate-200 bg-white z-10",children:[pe.length===0&&!O&&S.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),pe.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:`btn btn-light w-full justify-start mb-1 ${c.destino_id===e.id?"bg-sky-100 border-sky-400":"bg-white border-slate-200"}`,onMouseDown:a=>{a.preventDefault(),q(i=>({...i,destino_id:e.id})),F(o),W(!1),$([])},children:[o,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:c.data_embarque,onChange:e=>q({...c,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3 font-semibold text-lg",children:"Recibos da Venda"}),_.map((e,o)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[t.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:he?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:f.find(a=>a.id===e.produto_id)?.nome||k,onChange:a=>U(a.target.value),onBlur:()=>{const a=be.find(i=>i.nome.toLowerCase()===k.toLowerCase());a&&oe(o,"produto_id",a.id)},required:!0,disabled:!c.destino_id&&!he}),t.jsx("datalist",{id:`listaProdutos-${o}`,children:be.map(a=>t.jsx("option",{value:a.nome},a.id))})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>oe(o,"numero_recibo",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:a=>xe(o,"valor_total",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:a=>xe(o,"valor_taxas",a.target.value)})]}),t.jsx("div",{className:"form-group flex-none w-20 flex items-end",children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-2",onClick:()=>Te(o),children:"üóëÔ∏è"})})]})},o)),t.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:Pe,children:"‚ûï Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:ne,children:ne?"Salvando...":"Salvar venda"}),t.jsx("button",{type:"button",className:"btn btn-outline bg-slate-100 text-slate-800",onClick:Le,children:"Cancelar"})]})]})]}),ue.length>0&&t.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:ue.map(e=>t.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{Je as default};
