import{j as e,s as t}from"./supabase.DNkd6bxA.js";import{r as o}from"./index.C0Fn7Wtz.js";import{r as B}from"./logs.WCvMC_es.js";function F(){const[n,g]=o.useState(null),[I,N]=o.useState(!0),[u,c]=o.useState(!1),[b,d]=o.useState(null),[C,l]=o.useState(null),[p,w]=o.useState(""),[_,S]=o.useState(""),[m,E]=o.useState(""),[P,A]=o.useState(!1),[x,j]=o.useState(null),[v,U]=o.useState(""),[y,T]=o.useState(null);o.useMemo(()=>{if(!n)return"";const a=n.cidade||"",s=n.estado||"";return[a,s].filter(Boolean).join(" / ")},[n]),o.useEffect(()=>{const a=new URLSearchParams(window.location.search);A(a.get("onboarding")==="1")},[]),o.useEffect(()=>{async function a(){try{N(!0),l(null);const{data:s}=await t.auth.getSession(),i=s?.session?.user;if(!i){window.location.href="/auth/login";return}const{data:r,error:h}=await t.from("users").select("nome_completo, cpf, data_nascimento, telefone, cidade, estado, email, uso_individual, company_id, companies(nome_empresa, cnpj, endereco, telefone), user_types(name)").eq("id",i.id).maybeSingle();if(h)throw h;g({nome_completo:r?.nome_completo||"",cpf:r?.cpf||"",data_nascimento:r?.data_nascimento||"",telefone:r?.telefone||"",cidade:r?.cidade||"",estado:r?.estado||"",email:r?.email||i.email||"",uso_individual:r?.uso_individual??null,company_id:r?.company_id||null,company:r?.companies||null,cargo:r?.user_types?.name||null}),E(r?.email||i.email||""),j(r?.uso_individual??null),T({nome:r?.companies?.nome_empresa||null,cnpj:r?.companies?.cnpj||null})}catch(s){console.error(s),l("N√£o foi poss√≠vel carregar seu perfil.")}finally{N(!1)}}a()},[]);function f(a,s){g(i=>i&&{...i,[a]:s})}function k(a){return a.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}function $(a){const s=a.replace(/\D/g,"").slice(0,11);return s.length<=10?s.replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{4})(\d)/,"$1-$2"):s.replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")}async function q(){if(n){l(null),d(null),c(!0);try{const{data:a}=await t.auth.getSession(),s=a?.session?.user;if(!s){window.location.href="/auth/login";return}await t.from("users").update({nome_completo:n.nome_completo||null,telefone:n.telefone||null,cidade:n.cidade||null,estado:n.estado||null,data_nascimento:n.data_nascimento||null,uso_individual:x}).eq("id",s.id),await B({user_id:s.id,acao:"perfil_atualizado",modulo:"perfil",detalhes:{cidade:n.cidade,estado:n.estado}}),d("Dados salvos com sucesso.")}catch(a){console.error(a),l("N√£o foi poss√≠vel salvar seus dados.")}finally{c(!1)}}}async function z(){if(l(null),d(null),!p||p.length<6){l("A nova senha deve ter ao menos 6 caracteres.");return}if(p!==_){l("As senhas n√£o conferem.");return}try{c(!0);const{error:a}=await t.auth.updateUser({password:p});if(a)throw a;d("Senha alterada com sucesso."),w(""),S("")}catch(a){console.error(a),l("N√£o foi poss√≠vel alterar a senha.")}finally{c(!1)}}async function L(){if(l(null),d(null),!m){l("Informe um e-mail v√°lido.");return}try{c(!0);const{error:a}=await t.auth.updateUser({email:m});if(a)throw a;await t.from("users").update({email:m}).eq("email",n?.email||m),d("E-mail atualizado. Confirme o novo e-mail para continuar usando."),g(s=>s&&{...s,email:m})}catch(a){console.error(a),l("N√£o foi poss√≠vel alterar o e-mail.")}finally{c(!1)}}async function W(){if(!v.trim()){l("Informe o CNPJ da nova empresa.");return}try{c(!0);const a=v.replace(/\D/g,""),{data:s,error:i}=await t.from("companies").select("id, nome_empresa, cnpj").eq("cnpj",a).limit(1);if(i)throw i;if(!s||s.length===0){l("Empresa n√£o encontrada para o CNPJ informado.");return}const r=s[0],{data:h}=await t.auth.getSession(),D=h?.session?.user;if(!D){window.location.href="/auth/login";return}await t.from("users").update({company_id:r.id}).eq("id",D.id),T({nome:r.nome_empresa,cnpj:r.cnpj}),d("Empresa atualizada com sucesso."),l(null)}catch(a){console.error(a),l("N√£o foi poss√≠vel trocar a empresa.")}finally{c(!1)}}return I?e.jsx("div",{className:"card-base card-config",children:"Carregando perfil..."}):n?e.jsxs("div",{className:"perfil-page",children:[P&&e.jsx("div",{className:"card-base card-config mb-3",children:"Complete os dados para finalizar seu primeiro acesso."}),C&&e.jsx("div",{className:"card-base card-config mb-3",children:C}),b&&e.jsx("div",{className:"card-base card-green mb-3",children:b}),e.jsxs("div",{className:"grid md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"card-base card-blue",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üë§ Dados pessoais"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Uso do sistema"}),e.jsxs("div",{className:"flex items-center gap-4",style:{marginTop:6},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"radio",name:"uso",checked:x!==!1,onChange:()=>j(!0)}),"Individual"]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"radio",name:"uso",checked:x===!1,onChange:()=>j(!1)}),"Corporativo"]})]}),e.jsx("small",{children:"Selecione conforme a forma de uso (pessoal ou vinculada √† empresa)."})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"3.8fr 0.8fr 1fr",gap:12,marginTop:16},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nome completo"}),e.jsx("input",{className:"form-input",value:n.nome_completo,onChange:a=>f("nome_completo",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"CPF"}),e.jsx("input",{className:"form-input",value:k(n.cpf||""),readOnly:!0,placeholder:"000.000.000-00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data de nascimento"}),e.jsx("input",{className:"form-input",type:"date",value:n.data_nascimento||"",onChange:a=>f("data_nascimento",a.target.value)})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 2fr 1fr",gap:12,marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Telefone"}),e.jsx("input",{className:"form-input",value:$(n.telefone||""),onChange:a=>f("telefone",$(a.target.value)),placeholder:"(00) 00000-0000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Cidade"}),e.jsx("input",{className:"form-input",value:n.cidade||"",onChange:a=>f("cidade",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"UF"}),e.jsx("input",{className:"form-input",value:n.estado||"",maxLength:2,onChange:a=>f("estado",a.target.value.toUpperCase())})]})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:q,disabled:u,children:u?"Salvando...":"Salvar dados"})})]}),e.jsxs("div",{className:"card-base card-config",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üîê Dados de acesso"}),e.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs("div",{className:"form-group",style:{flex:1},children:[e.jsx("label",{children:"E-mail de login"}),e.jsx("input",{className:"form-input",value:m,onChange:a=>E(a.target.value),type:"email"}),e.jsx("small",{children:"Ser√° necess√°rio confirmar o novo e-mail."})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"},children:e.jsx("button",{className:"btn btn-secondary",onClick:L,disabled:u,children:"Atualizar e-mail"})})]}),e.jsx("h4",{style:{marginTop:6,marginBottom:4},children:"Alterar senha"}),e.jsxs("div",{className:"form-group",style:{marginTop:0},children:[e.jsx("label",{children:"Nova senha"}),e.jsx("input",{className:"form-input",type:"password",value:p,onChange:a=>w(a.target.value),placeholder:"M√≠nimo 6 caracteres"})]}),e.jsxs("div",{className:"form-group",style:{marginTop:6},children:[e.jsx("label",{children:"Confirmar senha"}),e.jsx("input",{className:"form-input",type:"password",value:_,onChange:a=>S(a.target.value)})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:z,disabled:u,children:"Alterar senha"})})]}),e.jsxs("div",{className:"card-base",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üè¢ Empresa"}),y?e.jsxs("p",{style:{marginBottom:12,lineHeight:1.5},children:[e.jsx("strong",{children:"Empresa:"})," ",y.nome||"-",e.jsx("br",{}),e.jsx("strong",{children:"CNPJ:"})," ",y.cnpj||"-",e.jsx("br",{}),e.jsx("strong",{children:"Endere√ßo:"})," ",n.company?.endereco||"-",e.jsx("br",{}),e.jsx("strong",{children:"Telefone:"})," ",n.company?.telefone||"-",e.jsx("br",{}),e.jsx("strong",{children:"Cargo:"})," ",n.cargo||"-"]}):e.jsx("p",{style:{marginBottom:12},children:"Nenhuma empresa vinculada."}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Trocar empresa (CNPJ)"}),e.jsx("input",{className:"form-input",value:v,onChange:a=>U(a.target.value),placeholder:"00.000.000/0000-00"})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:W,disabled:u,children:"Trocar empresa"})})]})]})]}):e.jsx("div",{className:"card-base card-config",children:"Perfil n√£o encontrado."})}export{F as default};
