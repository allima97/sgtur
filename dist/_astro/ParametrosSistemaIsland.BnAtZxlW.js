import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as c}from"./index.C0Fn7Wtz.js";import{s as i}from"./supabase.Ng8nq9tn.js";import{u as T}from"./usePermissao.Bkt8qSjs.js";import{r as L}from"./logs.DwCrXgEk.js";const b={company_id:null,owner_user_id:null,usar_taxas_na_meta:!1,foco_valor:"bruto",modo_corporativo:!1,politica_cancelamento:"cancelar_venda",foco_faturamento:"bruto",exportacao_pdf:!1,exportacao_excel:!1};function B(){const{permissao:d,ativo:v,loading:D}=T("Parametros"),I=d==="admin"||d==="edit",[r,l]=c.useState(b),[A,g]=c.useState(!0),[p,j]=c.useState(!1),[y,n]=c.useState(null),[w,_]=c.useState(null),[N,x]=c.useState(null),[S,f]=c.useState("default"),[q,h]=c.useState(null),t=!v||!I&&d!=="edit"&&d!=="delete";c.useEffect(()=>{k()},[]);const V=c.useMemo(()=>r.foco_valor==="bruto"?"Valor bruto":"Valor líquido",[r.foco_valor]);async function k(){try{g(!0),n(null),_(null);const{data:a}=await i.auth.getUser(),o=a?.user?.id;if(!o){n("Usuário não autenticado.");return}const{data:C,error:P}=await i.from("users").select("company_id, nome_completo").eq("id",o).maybeSingle();if(P)throw P;const m=C?.company_id||null,u=C?.nome_completo||null,{data:s,error:E}=await i.from("parametros_comissao").select("*, owner_user:owner_user_id (nome_completo)").eq("company_id",m).maybeSingle();E?(console.error(E),l({...b,company_id:m,owner_user_id:o})):s?(l({id:s.id,company_id:m,owner_user_id:s.owner_user_id||o,owner_user_nome:s.owner_user?.nome_completo||u,usar_taxas_na_meta:!!s.usar_taxas_na_meta,foco_valor:s.foco_valor==="liquido"?"liquido":"bruto",modo_corporativo:!!s.modo_corporativo,politica_cancelamento:s.politica_cancelamento==="estornar_recibos"?"estornar_recibos":"cancelar_venda",foco_faturamento:s.foco_faturamento==="liquido"?"liquido":"bruto",exportacao_pdf:!!s.exportacao_pdf,exportacao_excel:!!s.exportacao_excel}),x(s.updated_at||s.created_at||null),f("banco"),h(s.owner_user?.nome_completo||u)):(l({...b,company_id:m,owner_user_id:o,owner_user_nome:u}),x(null),f("default"),h(u))}catch(a){console.error(a),n("Erro ao carregar parâmetros.")}finally{g(!1)}}async function z(){if(!t)try{j(!0),n(null),_(null);const a={company_id:r.company_id,owner_user_id:r.owner_user_id,usar_taxas_na_meta:r.usar_taxas_na_meta,foco_valor:r.foco_valor,modo_corporativo:r.modo_corporativo,politica_cancelamento:r.politica_cancelamento,foco_faturamento:r.foco_faturamento,exportacao_pdf:r.exportacao_pdf,exportacao_excel:r.exportacao_excel},{error:o}=await i.from("parametros_comissao").upsert(a,{onConflict:"company_id"});if(o)throw o;await L({user_id:(await i.auth.getUser()).data.user?.id||null,acao:"parametros_sistema_salvos",modulo:"Parametros",detalhes:a}),_("Parâmetros salvos com sucesso."),x(new Date().toISOString()),f("banco"),h(r.owner_user_nome||null)}catch(a){console.error(a),n("Erro ao salvar parâmetros.")}finally{j(!1)}}return A||D?e.jsx("div",{children:"Carregando parâmetros do sistema..."}):v?e.jsxs("div",{className:"card-base",children:[e.jsx("h2",{className:"card-title",children:"Parâmetros do Sistema"}),y&&e.jsx("div",{className:"auth-error",children:y}),w&&e.jsx("div",{className:"auth-success",children:w}),N&&e.jsxs("p",{style:{marginTop:0,color:"#64748b",fontSize:"0.9rem"},children:["Última atualização: ",new Date(N).toLocaleString("pt-BR")]}),S&&e.jsxs("p",{style:{marginTop:4,color:"#94a3b8",fontSize:"0.85rem"},children:["Origem dos dados: ",S==="banco"?"Banco de dados":"Valores padrão"]}),q&&e.jsxs("p",{style:{marginTop:4,color:"#94a3b8",fontSize:"0.85rem"},children:["Última edição por: ",q]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta considera taxas?"}),e.jsx("div",{children:e.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:r.usar_taxas_na_meta,onChange:a=>l(o=>({...o,usar_taxas_na_meta:a.target.checked})),disabled:t}),"Incluir taxas no cálculo de meta"]})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Foco das metas"}),e.jsxs("select",{className:"form-select",value:r.foco_valor,onChange:a=>l(o=>({...o,foco_valor:a.target.value==="liquido"?"liquido":"bruto"})),disabled:t,children:[e.jsx("option",{value:"bruto",children:"Valor bruto"}),e.jsx("option",{value:"liquido",children:"Valor líquido"})]}),e.jsxs("small",{style:{color:"#64748b"},children:[V," será usado em metas e dashboards."]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Modo corporativo"}),e.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:r.modo_corporativo,onChange:a=>l(o=>({...o,modo_corporativo:a.target.checked})),disabled:t}),"Ativar modo corporativo (multi-empresa, controles extras)"]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Política de cancelamento"}),e.jsxs("select",{className:"form-select",value:r.politica_cancelamento,onChange:a=>l(o=>({...o,politica_cancelamento:a.target.value==="estornar_recibos"?"estornar_recibos":"cancelar_venda"})),disabled:t,children:[e.jsx("option",{value:"cancelar_venda",children:"Cancelar venda (exclui venda)"}),e.jsx("option",{value:"estornar_recibos",children:"Estornar recibos (manter venda)"})]}),e.jsx("small",{style:{color:"#64748b"},children:"Define comportamento padrão ao cancelar vendas."})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Foco de faturamento"}),e.jsxs("select",{className:"form-select",value:r.foco_faturamento,onChange:a=>l(o=>({...o,foco_faturamento:a.target.value==="liquido"?"liquido":"bruto"})),disabled:t,children:[e.jsx("option",{value:"bruto",children:"Valor bruto"}),e.jsx("option",{value:"liquido",children:"Valor líquido"})]}),e.jsx("small",{style:{color:"#64748b"},children:"Define base para faturamento e relatórios financeiros."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Exportações"}),e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:8},children:[e.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:r.exportacao_pdf,onChange:a=>l(o=>({...o,exportacao_pdf:a.target.checked})),disabled:t}),"Habilitar exportação em PDF"]}),e.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"checkbox",checked:r.exportacao_excel,onChange:a=>l(o=>({...o,exportacao_excel:a.target.checked})),disabled:t}),"Habilitar exportação em Excel"]})]}),e.jsx("small",{style:{color:"#64748b"},children:"Mantém coerência com os módulos de relatórios e orçamentos."})]})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginTop:16},children:[e.jsx("button",{className:"btn btn-primary",onClick:z,disabled:t||p,children:p?"Salvando...":"Salvar parâmetros"}),e.jsx("button",{className:"btn btn-secondary",onClick:k,disabled:p,children:"Recarregar"})]}),t&&e.jsx("p",{style:{marginTop:12,color:"#f97316"},children:"Você não tem permissão para editar. Solicite acesso ao administrador."})]}):e.jsx("div",{children:"Acesso ao módulo de Parâmetros bloqueado."})}export{B as default};
