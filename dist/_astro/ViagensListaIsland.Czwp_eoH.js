import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as l}from"./supabase.Ng8nq9tn.js";import{u as me}from"./usePermissao.DiLe8-Rs.js";import{L as ue}from"./LoadingUsuarioContext.BaDUNi7o.js";const fe=[{value:"",label:"Todas"},{value:"planejada",label:"Planejada"},{value:"confirmada",label:"Confirmada"},{value:"em_viagem",label:"Em viagem"},{value:"concluida",label:"Concluída"},{value:"cancelada",label:"Cancelada"}],J={origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada",cliente_id:""};function ve(){const{permissao:f,loading:y,ativo:K}=me("Operacao"),F=f!=="none",D=f==="create"||f==="edit"||f==="delete"||f==="admin",[j,X]=r.useState(""),[v,Y]=r.useState(""),[b,Z]=r.useState(""),[V,ee]=r.useState([]),[_,I]=r.useState(!1),[$,L]=r.useState(null),[k,N]=r.useState(!1),[q,u]=r.useState(null),[C,O]=r.useState(!1),[i,m]=r.useState(()=>({...J})),[ae,se]=r.useState([]),[p,T]=r.useState(null),[A,R]=r.useState(null),[te,re]=r.useState([]),[B,P]=r.useState(null),[ie,U]=r.useState(!1),[M,W]=r.useState(null),h=r.useRef(null),g=r.useRef(null),ne=a=>{const s=[a.nome];return a.subdivisao_nome&&s.push(a.subdivisao_nome),a.pais_nome&&s.push(a.pais_nome),s.join(" • ")};r.useEffect(()=>{!y&&F&&w()},[y,F,j,v,b]),r.useEffect(()=>{async function a(){const{data:s}=await l.auth.getSession(),t=s?.session?.user||null;if(t){R(t.id);const{data:n}=await l.from("users").select("company_id").eq("id",t.id).maybeSingle();T(n?.company_id||null)}else{const{data:n}=await l.auth.getUser();if(!n?.user)return;R(n.user.id);const{data:d}=await l.from("users").select("company_id").eq("id",n.user.id).maybeSingle();T(d?.company_id||null)}}a()},[]),r.useEffect(()=>{if(!p)return;async function a(){try{const{data:s,error:t}=await l.from("clientes").select("id, nome, cpf").eq("company_id",p).order("nome",{ascending:!0}).limit(200);if(t)throw t;re(s||[]),P(null)}catch(s){console.error("Erro ao carregar clientes:",s),P("Não foi possível carregar os clientes.")}}a()},[p]),r.useEffect(()=>(z(""),()=>{h.current&&h.current.abort(),g.current&&clearTimeout(g.current)}),[]);async function z(a){h.current&&h.current.abort();const s=new AbortController;h.current=s;try{U(!0),W(null);const t=a.trim(),n=t.length===0?200:50;let d=[];try{const{data:o,error:c}=await l.rpc("buscar_cidades",{q:t,limite:n},{signal:s.signal});if(c)throw c;d=o||[]}catch(o){if(s.signal.aborted)return;console.warn("RPC buscar_cidades falhou:",o);let c=l.from("cidades").select("nome").order("nome").limit(n);t.length>0&&(c=c.ilike("nome",`%${t}%`));const E=await c;if(E.error)throw E.error;d=(E.data||[]).map(de=>({nome:de.nome}))}if(s.signal.aborted)return;const x=new Map;d.forEach(o=>{if(!o?.nome)return;const c=`${o.nome}|${o.pais_nome||""}|${o.subdivisao_nome||""}`;x.has(c)||x.set(c,o)}),se(Array.from(x.values()))}catch(t){s.signal.aborted||(console.error("Erro ao buscar cidades:",t),W("Não foi possível carregar as cidades."))}finally{s.signal.aborted||U(!1)}}function Q(a){g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{z(a)},250)}function S(){m({...J}),u(null)}function oe(){S(),N(!0)}function le(){S(),N(!1)}async function w(){try{I(!0),L(null);let a=l.from("viagens").select("id, data_inicio, data_fim, status, origem, destino, responsavel_user_id, cliente_id, clientes (nome), responsavel:users!responsavel_user_id (nome_completo)").order("data_inicio",{ascending:!0});j&&(a=a.eq("status",j)),v&&(a=a.gte("data_inicio",v)),b&&(a=a.lte("data_inicio",b));const{data:s,error:t}=await a;if(t)throw t;ee(s||[])}catch(a){console.error(a),L("Erro ao carregar viagens.")}finally{I(!1)}}async function ce(){if(!D)return;if(!p||!A){u("NÇőo foi possÇ§vel determinar sua empresa.");return}if(!i.cliente_id){u("Selecione o cliente responsÂvel.");return}if(!i.origem||!i.destino||!i.data_inicio){u("Origem, destino e data de inÃ­cio sÇőo obrigatÃ³rios.");return}let a=null;try{O(!0),u(null);const s=i.origem.trim(),t=i.destino.trim(),{data:n,error:d}=await l.from("orcamentos").insert({cliente_id:i.cliente_id,status:"novo",data_viagem:i.data_inicio,notas:`Viagem criada via Operacao: ${s} -> ${t}`}).select("id").single();if(d)throw d;if(a=n?.id||null,!a)throw new Error("Nao foi possivel vincular um orcamento.");const x={company_id:p,responsavel_user_id:A,cliente_id:i.cliente_id,origem:s,destino:t,data_inicio:i.data_inicio,data_fim:i.data_fim||null,status:i.status,orcamento_id:a},{error:o}=await l.from("viagens").insert(x);if(o)throw o;S(),N(!1),w()}catch(s){if(console.error(s),a){const{error:n}=await l.from("orcamentos").delete().eq("id",a);n&&console.warn("Nao foi possivel remover o orcamento temporario:",n)}const t=s&&typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?s.message:null;u(t||"Erro ao criar viagem.")}finally{O(!1)}}const G=r.useMemo(()=>[...V].sort((a,s)=>{const t=a.data_inicio||"",n=s.data_inicio||"";return t===n?0:t?n?t<n?-1:1:-1:1}),[V]),H={flex:"0 0 140px",minWidth:125};return y?e.jsx(ue,{}):K?e.jsx("div",{className:"card-base card-purple",children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[k&&e.jsxs("div",{className:"card-base card-blue",style:{padding:16},children:[e.jsx("datalist",{id:"cidades-list",children:ae.map(a=>e.jsx("option",{value:a.nome,label:ne(a)},`${a.nome}-${a.subdivisao_nome||""}-${a.pais_nome||""}`))}),ie&&e.jsx("small",{style:{color:"#6366f1"},children:"Buscando cidades..."}),M&&e.jsx("small",{style:{color:"red"},children:M}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:i.cliente_id,onChange:a=>m(s=>({...s,cliente_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Selecione um cliente"}),te.map(a=>e.jsxs("option",{value:a.id,children:[a.nome,a.cpf?` (${a.cpf})`:""]},a.id))]}),B&&e.jsx("small",{style:{color:"red"},children:B})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Origem"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:i.origem,onChange:a=>{const s=a.target.value;m(t=>({...t,origem:s})),Q(s)},placeholder:"Cidade de origem"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:i.destino,onChange:a=>{const s=a.target.value;m(t=>({...t,destino:s})),Q(s)},placeholder:"Cidade de destino"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:i.data_inicio,onChange:a=>m(s=>({...s,data_inicio:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:i.data_fim,onChange:a=>m(s=>({...s,data_fim:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:i.status,onChange:a=>m(s=>({...s,status:a.target.value})),children:[e.jsx("option",{value:"planejada",children:"Planejada"}),e.jsx("option",{value:"confirmada",children:"Confirmada"}),e.jsx("option",{value:"em_viagem",children:"Em viagem"}),e.jsx("option",{value:"concluida",children:"Concluída"}),e.jsx("option",{value:"cancelada",children:"Cancelada"})]})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12,display:"flex",gap:8,justifyContent:"flex-start"},children:[e.jsx("button",{className:"btn btn-primary",type:"button",onClick:ce,disabled:C,children:C?"Salvando...":"Salvar"}),e.jsx("button",{className:"btn btn-light",type:"button",onClick:le,disabled:C,children:"Cancelar"})]}),q&&e.jsx("div",{style:{color:"red"},children:q})]}),e.jsxs("div",{className:"form-row",style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"},children:[e.jsxs("div",{className:"form-group",style:{flex:"1 1 180px"},children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsx("select",{className:"form-select",value:j,onChange:a=>X(a.target.value),children:fe.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"form-group",style:H,children:[e.jsx("label",{className:"form-label",children:"Inicio"}),e.jsx("input",{type:"date",className:"form-input",value:v,onChange:a=>Y(a.target.value)})]}),e.jsxs("div",{className:"form-group",style:H,children:[e.jsx("label",{className:"form-label",children:"Final"}),e.jsx("input",{type:"date",className:"form-input",value:b,onChange:a=>Z(a.target.value)})]}),e.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"row",gap:8,marginBottom:0,marginLeft:"auto",flexWrap:"nowrap",justifyContent:"flex-end",alignItems:"center",alignSelf:"center"},children:[e.jsx("button",{className:"btn btn-strong",type:"button",onClick:w,disabled:_,children:_?"Atualizando...":"Atualizar"}),D&&e.jsx("button",{className:"btn btn-primary",type:"button",onClick:oe,disabled:k,children:"Nova viagem"})]})]}),$&&e.jsx("div",{style:{color:"red"},children:$}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Início"}),e.jsx("th",{children:"Fim"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Origem"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Responsável"}),e.jsx("th",{children:"Ver"})]})}),e.jsxs("tbody",{children:[_&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando viagens..."})}),!_&&G.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma viagem encontrada."})}),G.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_inicio?new Date(a.data_inicio).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.data_fim?new Date(a.data_fim).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.status||"-"}),e.jsx("td",{children:a.origem||"-"}),e.jsx("td",{children:a.destino||"-"}),e.jsx("td",{children:a.clientes?.nome||"-"}),e.jsx("td",{children:a.responsavel?.nome_completo||a.responsavel_user_id||"-"}),e.jsx("td",{children:e.jsx("a",{className:"btn btn-light",href:`/operacao/viagens/${a.id}`,children:"Abrir"})})]},a.id))]})]})})]})}):e.jsx("div",{children:"Você não possui acesso ao módulo de Operação/Viagens."})}export{ve as default};
