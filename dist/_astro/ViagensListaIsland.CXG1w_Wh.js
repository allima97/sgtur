import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as c}from"./supabase.Ng8nq9tn.js";import{u as _e}from"./usePermissao.DiLe8-Rs.js";import{L as ye}from"./LoadingUsuarioContext.BaDUNi7o.js";const Ne=[{value:"",label:"Todas"},{value:"planejada",label:"Planejada"},{value:"confirmada",label:"Confirmada"},{value:"em_viagem",label:"Em viagem"},{value:"concluida",label:"Conclu√≠da"},{value:"cancelada",label:"Cancelada"}],se={planejada:"Planejada",confirmada:"Confirmada",em_viagem:"Em viagem",concluida:"Conclu√≠da",cancelada:"Cancelada"};function Ce(n,f){if(!n)return null;const p=new Date;p.setHours(0,0,0,0);const _=new Date(n),g=f?new Date(f):null;return g&&g<p?"concluida":_>p?"confirmada":g&&p>g?"concluida":"em_viagem"}function Se(n){return n==null||Number.isNaN(n)?"-":n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}const re={origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada",cliente_id:""};function Fe(){const{permissao:n,loading:f,ativo:p,podeExcluir:_,podeEditar:g}=_e("Operacao"),I=n!=="none",T=n==="create"||n==="edit"||n==="delete"||n==="admin",[y,ie]=r.useState(""),[N,oe]=r.useState(""),[C,ne]=r.useState(""),[$,le]=r.useState([]),[S,A]=r.useState(!1),[q,w]=r.useState(null),[P,k]=r.useState(null),[B,V]=r.useState(!1),[R,h]=r.useState(null),[D,O]=r.useState(!1),[o,m]=r.useState(()=>({...re})),[ce,de]=r.useState([]),[x,U]=r.useState(null),[M,W]=r.useState(null),[ue,me]=r.useState([]),[z,H]=r.useState(null),[Q,G]=r.useState(null),[fe,J]=r.useState(!1),[K,X]=r.useState(null),b=r.useRef(null),j=r.useRef(null),pe=e=>{const t=[e.nome];return e.subdivisao_nome&&t.push(e.subdivisao_nome),e.pais_nome&&t.push(e.pais_nome),t.join(" ‚Ä¢ ")};r.useEffect(()=>{!f&&I&&E()},[f,I,y,N,C]),r.useEffect(()=>{async function e(){const{data:t}=await c.auth.getSession(),s=t?.session?.user||null;if(s){W(s.id);const{data:i}=await c.from("users").select("company_id").eq("id",s.id).maybeSingle();U(i?.company_id||null)}else{const{data:i}=await c.auth.getUser();if(!i?.user)return;W(i.user.id);const{data:u}=await c.from("users").select("company_id").eq("id",i.user.id).maybeSingle();U(u?.company_id||null)}}e()},[]),r.useEffect(()=>{if(!x)return;async function e(){try{const{data:t,error:s}=await c.from("clientes").select("id, nome, cpf").eq("company_id",x).order("nome",{ascending:!0}).limit(200);if(s)throw s;me(t||[]),H(null)}catch(t){console.error("Erro ao carregar clientes:",t),H("N√£o foi poss√≠vel carregar os clientes.")}}e()},[x]),r.useEffect(()=>(Y(""),()=>{b.current&&b.current.abort(),j.current&&clearTimeout(j.current)}),[]);async function Y(e){b.current&&b.current.abort();const t=new AbortController;b.current=t;try{J(!0),X(null);const s=e.trim(),i=s.length===0?200:50;let u=[];try{const{data:l,error:d}=await c.rpc("buscar_cidades",{q:s,limite:i},{signal:t.signal});if(d)throw d;u=l||[]}catch(l){if(t.signal.aborted)return;console.warn("RPC buscar_cidades falhou:",l);let d=c.from("cidades").select("nome").order("nome").limit(i);s.length>0&&(d=d.ilike("nome",`%${s}%`));const F=await d;if(F.error)throw F.error;u=(F.data||[]).map(ve=>({nome:ve.nome}))}if(t.signal.aborted)return;const v=new Map;u.forEach(l=>{if(!l?.nome)return;const d=`${l.nome}|${l.pais_nome||""}|${l.subdivisao_nome||""}`;v.has(d)||v.set(d,l)}),de(Array.from(v.values()))}catch(s){t.signal.aborted||(console.error("Erro ao buscar cidades:",s),X("N√£o foi poss√≠vel carregar as cidades."))}finally{t.signal.aborted||J(!1)}}function Z(e){j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{Y(e)},250)}function L(){m({...re}),h(null)}function ge(){L(),V(!0)}function he(){L(),V(!1)}async function E(){try{A(!0),w(null);let e=c.from("viagens").select("id, data_inicio, data_fim, status, origem, destino, responsavel_user_id, cliente_id, clientes (nome), responsavel:users!responsavel_user_id (nome_completo), recibo:vendas_recibos (id, valor_total, valor_taxas, data_inicio, data_fim, numero_recibo, produto_id, tipo_produtos (id, nome, tipo))").order("data_inicio",{ascending:!0});y&&(e=e.eq("status",y)),N&&(e=e.gte("data_inicio",N)),C&&(e=e.lte("data_inicio",C));const{data:t,error:s}=await e;if(s)throw s;le(t||[])}catch(e){console.error(e),w("Erro ao carregar viagens.")}finally{A(!1)}}async function xe(){if(!T)return;if(!x||!M){h("N√á≈ëo foi poss√á¬ßvel determinar sua empresa.");return}if(!o.cliente_id){h("Selecione o cliente respons√Çvel.");return}if(!o.origem||!o.destino||!o.data_inicio){h("Origem, destino e data de in√É¬≠cio s√á≈ëo obrigat√É¬≥rios.");return}let e=null;try{O(!0),h(null);const t=o.origem.trim(),s=o.destino.trim(),{data:i,error:u}=await c.from("orcamentos").insert({cliente_id:o.cliente_id,status:"novo",data_viagem:o.data_inicio,notas:`Viagem criada via Operacao: ${t} -> ${s}`}).select("id").single();if(u)throw u;if(e=i?.id||null,!e)throw new Error("Nao foi possivel vincular um orcamento.");const v={company_id:x,responsavel_user_id:M,cliente_id:o.cliente_id,origem:t,destino:s,data_inicio:o.data_inicio,data_fim:o.data_fim||null,status:o.status,orcamento_id:e},{error:l}=await c.from("viagens").insert(v);if(l)throw l;L(),V(!1),E()}catch(t){if(console.error(t),e){const{error:i}=await c.from("orcamentos").delete().eq("id",e);i&&console.warn("Nao foi possivel remover o orcamento temporario:",i)}const s=t&&typeof t=="object"&&t!==null&&"message"in t&&typeof t.message=="string"?t.message:null;h(s||"Erro ao criar viagem.")}finally{O(!1)}}async function be(e){if(!(!_||!window.confirm("Tem certeza que deseja excluir esta viagem?")))try{G(e.id),w(null),k(null);const{error:s}=await c.from("viagens").delete().eq("id",e.id);if(s)throw s;k("Viagem exclu√≠da."),await E()}catch(s){console.error(s);const i=s&&typeof s=="object"&&"message"in s&&typeof s.message=="string"?s.message:"Erro ao excluir viagem.";w(i)}finally{G(null)}}function je(e){const t=Ce(e.recibo?.data_inicio||e.data_inicio,e.recibo?.data_fim||e.data_fim);return t?se[t]||t:e.status?se[e.status]||e.status:"-"}const ee=r.useMemo(()=>[...$].sort((e,t)=>{const s=e.data_inicio||"",i=t.data_inicio||"";return s===i?0:s?i?s<i?-1:1:-1:1}),[$]),ae={flex:"0 0 140px",minWidth:125},te=7;return f?a.jsx(ye,{}):p?a.jsx("div",{className:"card-base card-purple",children:a.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[B&&a.jsxs("div",{className:"card-base card-blue",style:{padding:16},children:[a.jsx("datalist",{id:"cidades-list",children:ce.map(e=>a.jsx("option",{value:e.nome,label:pe(e)},`${e.nome}-${e.subdivisao_nome||""}-${e.pais_nome||""}`))}),fe&&a.jsx("small",{style:{color:"#6366f1"},children:"Buscando cidades..."}),K&&a.jsx("small",{style:{color:"red"},children:K}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:o.cliente_id,onChange:e=>m(t=>({...t,cliente_id:e.target.value})),children:[a.jsx("option",{value:"",children:"Selecione um cliente"}),ue.map(e=>a.jsxs("option",{value:e.id,children:[e.nome,e.cpf?` (${e.cpf})`:""]},e.id))]}),z&&a.jsx("small",{style:{color:"red"},children:z})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Origem"}),a.jsx("input",{className:"form-input",list:"cidades-list",value:o.origem,onChange:e=>{const t=e.target.value;m(s=>({...s,origem:t})),Z(t)},placeholder:"Cidade de origem"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsx("input",{className:"form-input",list:"cidades-list",value:o.destino,onChange:e=>{const t=e.target.value;m(s=>({...s,destino:t})),Z(t)},placeholder:"Cidade de destino"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data in√≠cio"}),a.jsx("input",{type:"date",className:"form-input",value:o.data_inicio,onChange:e=>m(t=>({...t,data_inicio:e.target.value}))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{type:"date",className:"form-input",value:o.data_fim,onChange:e=>m(t=>({...t,data_fim:e.target.value}))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:o.status,onChange:e=>m(t=>({...t,status:e.target.value})),children:[a.jsx("option",{value:"planejada",children:"Planejada"}),a.jsx("option",{value:"confirmada",children:"Confirmada"}),a.jsx("option",{value:"em_viagem",children:"Em viagem"}),a.jsx("option",{value:"concluida",children:"Conclu√≠da"}),a.jsx("option",{value:"cancelada",children:"Cancelada"})]})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12,display:"flex",gap:8,justifyContent:"flex-start"},children:[a.jsx("button",{className:"btn btn-primary",type:"button",onClick:xe,disabled:D,children:D?"Salvando...":"Salvar"}),a.jsx("button",{className:"btn btn-light",type:"button",onClick:he,disabled:D,children:"Cancelar"})]}),R&&a.jsx("div",{style:{color:"red"},children:R})]}),a.jsxs("div",{className:"form-row",style:{display:"flex",gap:8,flexWrap:"wrap",alignItems:"flex-end"},children:[a.jsxs("div",{className:"form-group",style:{flex:"1 1 180px"},children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsx("select",{className:"form-select",value:y,onChange:e=>ie(e.target.value),children:Ne.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-group",style:ae,children:[a.jsx("label",{className:"form-label",children:"Inicio"}),a.jsx("input",{type:"date",className:"form-input",value:N,onChange:e=>oe(e.target.value)})]}),a.jsxs("div",{className:"form-group",style:ae,children:[a.jsx("label",{className:"form-label",children:"Final"}),a.jsx("input",{type:"date",className:"form-input",value:C,onChange:e=>ne(e.target.value)})]}),a.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"row",gap:8,marginBottom:0,marginLeft:"auto",flexWrap:"nowrap",justifyContent:"flex-end",alignItems:"center",alignSelf:"center"},children:[a.jsx("button",{className:"btn btn-strong",type:"button",onClick:E,disabled:S,children:S?"Atualizando...":"Atualizar"}),T&&a.jsx("button",{className:"btn btn-primary",type:"button",onClick:ge,disabled:B,children:"Nova viagem"})]})]}),q&&a.jsx("div",{style:{color:"red"},children:q}),P&&a.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:P}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default min-w-[760px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"In√≠cio"}),a.jsx("th",{children:"Fim"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Valor"}),a.jsx("th",{style:{textAlign:"center"},children:"A√ß√µes"})]})}),a.jsxs("tbody",{children:[S&&a.jsx("tr",{children:a.jsx("td",{colSpan:te,children:"Carregando viagens..."})}),!S&&ee.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:te,children:"Nenhuma viagem encontrada."})}),ee.map(e=>{const t=je(e),s=e.recibo?.tipo_produtos?.nome||e.recibo?.tipo_produtos?.tipo||e.recibo?.produto_id||"-",i=Se(e.recibo?.valor_total);return a.jsxs("tr",{children:[a.jsx("td",{children:e.clientes?.nome||"-"}),a.jsx("td",{children:e.data_inicio?new Date(e.data_inicio).toLocaleDateString("pt-BR"):"-"}),a.jsx("td",{children:e.data_fim?new Date(e.data_fim).toLocaleDateString("pt-BR"):"-"}),a.jsx("td",{children:t}),a.jsx("td",{children:s}),a.jsx("td",{children:i}),a.jsxs("td",{style:{textAlign:"center",display:"flex",justifyContent:"center",alignItems:"center",gap:4},children:[a.jsx("a",{className:"btn-icon",href:`/operacao/viagens/${e.id}`,title:"Ver viagem",style:{padding:"4px 6px"},children:"üëÅÔ∏è"}),g&&a.jsx("a",{className:"btn-icon",href:`/operacao/viagens/${e.id}?modo=editar`,title:"Editar viagem",style:{padding:"4px 6px"},children:"‚úèÔ∏è"}),_&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir viagem",onClick:()=>be(e),disabled:Q===e.id,style:{padding:"4px 6px"},children:Q===e.id?"...":"üóëÔ∏è"})]})]},e.id)})]})]})})]})}):a.jsx("div",{children:"Voc√™ n√£o possui acesso ao m√≥dulo de Opera√ß√£o/Viagens."})}export{Fe as default};
