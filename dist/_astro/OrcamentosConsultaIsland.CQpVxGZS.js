import{s as l,j as t}from"./supabase.DNkd6bxA.js";import{r as a}from"./index.C0Fn7Wtz.js";import{u as ce}from"./usePermissao.72SYthuA.js";function ue(c){const f=c.getFullYear(),N=String(c.getMonth()+1).padStart(2,"0"),p=String(c.getDate()).padStart(2,"0"),g=String(c.getHours()).padStart(2,"0"),j=String(c.getMinutes()).padStart(2,"0"),r=Math.floor(Math.random()*900+100);return`VND-${f}${N}${p}-${g}${j}-${r}`}function je(){const{ativo:c}=ce("Vendas"),[f,N]=a.useState([]),[p,g]=a.useState(""),[j,r]=a.useState(null),[S,D]=a.useState(!0),[Q,q]=a.useState(null),[V,i]=a.useState(null),[d,b]=a.useState(null),[y,k]=a.useState(""),[L,$]=a.useState(""),[A,M]=a.useState(""),[O,R]=a.useState(""),[F,I]=a.useState(""),[P,T]=a.useState(""),[X,Z]=a.useState([]),[ee,te]=a.useState([]),[ae,se]=a.useState([]),z=["novo","enviado","negociando","fechado","perdido"],W={novo:{bg:"#e0f2fe",border:"#1d4ed8"},enviado:{bg:"#fef9c3",border:"#facc15"},negociando:{bg:"#fff7ed",border:"#fdba74"},fechado:{bg:"#ecfdf3",border:"#16a34a"},perdido:{bg:"#fee2e2",border:"#fca5a5"}},[me,he]=a.useState(null),[ve,pe]=a.useState(null),[_,B]=a.useState(""),[C,U]=a.useState(""),[w,H]=a.useState(""),[E,Y]=a.useState("");a.useEffect(()=>{u(),oe()},[]),a.useEffect(()=>{const e=()=>u();return window.addEventListener("orcamento-criado",e),()=>window.removeEventListener("orcamento-criado",e)},[]);async function u(){try{D(!0),r(null),i(null);let e=l.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            numero_venda,
            venda_criada,
            clientes:cliente_id (nome),
            destinos:produtos!destino_id (nome),
            produtos:tipo_produtos!produto_id (nome, tipo)
          `).order("data_orcamento",{ascending:!1});p&&(e=e.eq("status",p)),_&&(e=e.gte("data_orcamento",_)),C&&(e=e.lte("data_orcamento",C)),w&&(e=e.gte("valor",parseFloat(w))),E&&(e=e.lte("valor",parseFloat(E)));const{data:n,error:s}=await e;if(s)throw s;N(n||[])}catch(e){console.error(e),r("Erro ao carregar orçamentos.")}finally{D(!1)}}const m=a.useMemo(()=>f,[f]);a.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return m.forEach(n=>{const s=n.status||"novo";e[s]||(e[s]=[]),e[s].push(n)}),e},[m]);const G=a.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return m.forEach(n=>{const s=n.status||"novo",v=Number(n.valor||0);e[s]||(e[s]={qtd:0,valor:0}),e[s].qtd+=1,e[s].valor+=v}),e},[m]);function ne(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],n=m.map(o=>[o.id,o.clientes?.nome||"",o.destinos?.nome||"",o.produtos?.nome||"",o.status||"",o.valor??"",o.data_orcamento||"",o.data_viagem||"",o.numero_venda||""]),s=[e.join(","),...n.map(o=>o.join(","))].join(`
`),v=new Blob([s],{type:"text/csv;charset=utf-8;"}),x=URL.createObjectURL(v),h=document.createElement("a");h.href=x,h.download="orcamentos.csv",h.click(),URL.revokeObjectURL(x)}async function oe(){try{const[e,n,s]=await Promise.all([l.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),l.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),l.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);e.data&&Z(e.data),n.data&&te(n.data),s.data&&se(s.data)}catch(e){console.error(e)}}async function re(e,n){try{q(e),r(null),i(null);const{error:s}=await l.from("orcamentos").update({status:n}).eq("id",e);if(s)throw s;i("Status atualizado."),await u()}catch(s){console.error(s),r("Erro ao alterar status.")}finally{q(null)}}function le(e){b(e),k(e.valor?String(e.valor):""),$(e.data_viagem||""),M(e.notas||""),R(e.cliente_id||""),I(e.destino_id||""),T(e.produto_id||""),r(null),i(null)}async function ie(e){if(e.preventDefault(),!!d)try{i(null),r(null);const{error:n}=await l.from("orcamentos").update({valor:y?parseFloat(y):null,data_viagem:L||null,notas:A||null,cliente_id:O||d.cliente_id||null,destino_id:F||d.destino_id||null,produto_id:P||d.produto_id||null}).eq("id",d.id);if(n)throw n;i("Orçamento atualizado."),b(null),await u()}catch(n){console.error(n),r("Erro ao salvar edição.")}}async function de(e){if(window.confirm("Converter este orçamento em venda?"))try{i(null),r(null);const{data:s}=await l.auth.getUser(),v=s?.user?.id;if(!v)throw new Error("Usuário não autenticado.");const x=new Date,h=ue(x),o=x.toISOString().slice(0,10),{data:J,error:K}=await l.from("vendas").insert({vendedor_id:v,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:o,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:h,notas:e.notas}).select("id, numero_venda").maybeSingle();if(K)throw K;J?.id&&e.produto_id&&await l.from("vendas_recibos").insert({venda_id:J.id,produto_id:e.produto_id,numero_recibo:h,valor_total:e.valor||0,valor_taxas:0}),await l.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${h}`}).eq("id",e.id),i("Orçamento convertido em venda."),await u()}catch(s){console.error(s),r("Erro ao converter para venda.")}}return c?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"card-base",children:[t.jsx("div",{className:"page-header",style:{marginBottom:8},children:t.jsxs("div",{children:[t.jsx("h2",{className:"card-title",children:"Orçamentos"}),t.jsx("p",{className:"page-subtitle",children:"Consulta rápida dos orçamentos cadastrados."})]})}),t.jsxs("div",{className:"grid w-full",style:{marginTop:12,gap:10,gridTemplateColumns:"repeat(5, minmax(180px, 1fr))",alignItems:"end"},children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Status"}),t.jsxs("select",{className:"form-select",value:p,onChange:e=>g(e.target.value),children:[t.jsx("option",{value:"",children:"Todos"}),z.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data início"}),t.jsx("input",{className:"form-input",type:"date",value:_,onChange:e=>B(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data fim"}),t.jsx("input",{className:"form-input",type:"date",value:C,onChange:e=>U(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor min"}),t.jsx("input",{className:"form-input",type:"number",value:w,onChange:e=>H(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor max"}),t.jsx("input",{className:"form-input",type:"number",value:E,onChange:e=>Y(e.target.value)})]})]}),t.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:10},children:[t.jsx("button",{className:"btn btn-secondary",onClick:u,style:{minWidth:120},children:"Atualizar"}),t.jsx("button",{className:"btn btn-light",onClick:ne,style:{minWidth:140},children:"Exportar CSV"}),t.jsx("button",{className:"btn btn-light",onClick:()=>{g(""),B(""),U(""),H(""),Y(""),u()},style:{minWidth:140},children:"Limpar filtros"})]})]}),j&&t.jsx("div",{className:"auth-error",children:j}),V&&t.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:V}),t.jsxs("div",{className:"card-base card-blue",style:{marginTop:12},children:[t.jsx("h3",{className:"card-title",children:"Situação do Orçamento"}),t.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:10,alignItems:"stretch"},children:z.map(e=>t.jsxs("div",{className:"kpi-card",style:{background:W[e].bg,border:`1px solid ${W[e].border}`,textAlign:"center",display:"flex",flexDirection:"column",gap:6,justifyContent:"center"},children:[t.jsxs("div",{className:"kpi-label",style:{textTransform:"capitalize",fontWeight:700},children:[e," - ",String(G[e].qtd).padStart(2,"0")," Itens"]}),t.jsx("div",{className:"kpi-value",style:{fontSize:"1.3rem",fontWeight:800},children:G[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))})]}),t.jsx("div",{className:"card-base",style:{marginTop:16},children:t.jsx("div",{className:"table-container overflow-x-auto",children:t.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Data"}),t.jsx("th",{children:"Cliente"}),t.jsx("th",{children:"Destino"}),t.jsx("th",{children:"Produto"}),t.jsx("th",{style:{textAlign:"center"},children:"Status"}),t.jsx("th",{style:{textAlign:"center"},children:"Valor"}),t.jsx("th",{style:{textAlign:"center"},children:"Data viagem"}),t.jsx("th",{style:{textAlign:"center"},children:"Ações"})]})}),t.jsxs("tbody",{children:[S&&t.jsx("tr",{children:t.jsx("td",{colSpan:8,children:"Carregando..."})}),!S&&m.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:8,children:"Nenhum orçamento encontrado."})}),!S&&m.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:e.data_orcamento?.slice(0,10)||"—"}),t.jsx("td",{children:e.clientes?.nome||"—"}),t.jsx("td",{children:e.destinos?.nome||"—"}),t.jsx("td",{children:e.produtos?.nome||"—"}),t.jsx("td",{style:{textTransform:"capitalize",textAlign:"center"},children:t.jsxs("select",{className:"form-select",value:e.status||"",onChange:n=>re(e.id,n.target.value),disabled:Q===e.id,children:[t.jsx("option",{value:"novo",children:"Novo"}),t.jsx("option",{value:"enviado",children:"Enviado"}),t.jsx("option",{value:"negociando",children:"Negociando"}),t.jsx("option",{value:"fechado",children:"Fechado"}),t.jsx("option",{value:"perdido",children:"Perdido"})]})}),t.jsx("td",{style:{textAlign:"center"},children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"—"}),t.jsx("td",{style:{textAlign:"center"},children:e.data_viagem||"—"}),t.jsxs("td",{style:{textAlign:"center"},children:[t.jsx("button",{className:"btn-icon",onClick:()=>le(e),style:{marginRight:6},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":"Editar",children:"✏️"}),t.jsx("button",{className:"btn btn-primary","aria-label":"Converter em venda",onClick:()=>de(e),style:{padding:"4px 8px",fontSize:"0.95rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"$"})]})]},e.id))]})]})})}),d&&t.jsx("div",{className:"modal-backdrop",children:t.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[t.jsxs("div",{className:"modal-header",children:[t.jsxs("div",{children:[t.jsx("div",{className:"modal-title",children:"Editar orçamento"}),t.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",d.clientes?.nome||"—"," | Destino: ",d.destinos?.nome||"—"]})]}),t.jsx("button",{className:"btn-ghost",onClick:()=>b(null),children:"✖"})]}),t.jsxs("form",{onSubmit:ie,children:[t.jsxs("div",{className:"modal-body",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor (R$)"}),t.jsx("input",{className:"form-input",type:"number",value:y,onChange:e=>k(e.target.value),min:0,step:"0.01"})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data da viagem"}),t.jsx("input",{className:"form-input",type:"date",value:L,onChange:e=>$(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Cliente"}),t.jsxs("select",{className:"form-select",value:O,onChange:e=>R(e.target.value),children:[t.jsx("option",{value:"",children:"Selecione"}),X.map(e=>t.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Destino"}),t.jsxs("select",{className:"form-select",value:F,onChange:e=>I(e.target.value),children:[t.jsx("option",{value:"",children:"Selecione"}),ee.map(e=>t.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Produto"}),t.jsxs("select",{className:"form-select",value:P,onChange:e=>T(e.target.value),children:[t.jsx("option",{value:"",children:"(Opcional)"}),ae.map(e=>t.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Notas"}),t.jsx("textarea",{className:"form-input",rows:3,value:A,onChange:e=>M(e.target.value)})]})]}),t.jsxs("div",{className:"modal-footer",children:[t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>b(null),children:"Cancelar"}),t.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})})]}):t.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{je as default};
