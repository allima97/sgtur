import{j as e,s as i}from"./supabase.DNkd6bxA.js";import{r as n}from"./index.C0Fn7Wtz.js";import{u as ve}from"./usePermissao.72SYthuA.js";import{r as E}from"./logs.WCvMC_es.js";const V={nome:"",nascimento:"",cpf:"",telefone:"",whatsapp:"",email:"",endereco:"",complemento:"",cidade:"",estado:"",cep:"",rg:"",genero:"",nacionalidade:"",tags:"",tipo_cliente:"passageiro",notas:"",active:!0};function _e(){const{permissao:o,ativo:ee,loading:q}=ve("Clientes"),w=o!=="none",C=o==="create"||o==="edit"||o==="delete"||o==="admin",u=o==="edit"||o==="delete"||o==="admin",v=o==="delete"||o==="admin",[S,ae]=n.useState([]),[b,te]=n.useState(""),[k,c]=n.useState(null),[L,F]=n.useState(!0),[s,f]=n.useState(V),[x,B]=n.useState(null),[H,T]=n.useState(!1),[I,O]=n.useState(null),[P,W]=n.useState(null),[A,z]=n.useState([]),[M,G]=n.useState([]),[J,K]=n.useState(!1),[d,g]=n.useState(null),[Q,N]=n.useState([]),[se,U]=n.useState(!1),[m,_]=n.useState(null);async function R(){if(w)try{F(!0),c(null);const{data:a,error:t}=await i.from("clientes").select("*").order("nome",{ascending:!0});if(t)throw t;ae(a||[])}catch(a){console.error(a),c("Erro ao carregar clientes.")}finally{F(!1)}}n.useEffect(()=>{!q&&w&&R()},[q,w]);const X=n.useMemo(()=>{if(!b.trim())return S;const a=b.toLowerCase();return S.filter(t=>t.nome.toLowerCase().includes(a)||(t.cpf||"").includes(a)||(t.email||"").toLowerCase().includes(a))},[S,b]);function j(a,t){f(l=>({...l,[a]:t}))}function ne(){C&&(B(null),f(V))}async function le(a){W(a),K(!0);try{const{data:t}=await i.from("historico_viagens_real").select("id, data_viagem, valor_total, notas, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_viagem",{ascending:!1}),l=t?.map(r=>({id:r.id,data_viagem:r.data_viagem,destino_nome:r.destinos?.nome||"",valor_total:r.valor_total??null,notas:r.notas||null}))||[],{data:y}=await i.from("vendas").select("id, data_lancamento, data_embarque, destino_id, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_lancamento",{ascending:!1});let Z=[];if(y&&y.length>0){const r=y.map(h=>h.id),{data:xe}=await i.from("vendas_recibos").select("venda_id, valor_total, valor_taxas").in("venda_id",r);Z=y.map(h=>{const $=(xe||[]).filter(p=>p.venda_id===h.id),je=$.reduce((p,D)=>p+(D.valor_total||0),0),pe=$.reduce((p,D)=>p+(D.valor_taxas||0),0);return{id:h.id,data_lancamento:h.data_lancamento,data_embarque:h.data_embarque,destino_nome:h.destinos?.nome||"",valor_total:je,valor_taxas:pe}})}const{data:he}=await i.from("orcamentos").select("id, data_orcamento, status, valor, numero_venda, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_orcamento",{ascending:!1}),ue=he?.map(r=>({id:r.id,data_orcamento:r.data_orcamento,status:r.status,valor:r.valor??null,numero_venda:r.numero_venda??null,destino_nome:r.destinos?.nome||null}))||[];z(Z),G(ue)}catch(t){console.error(t),c("Erro ao carregar histÃ³rico do cliente.")}finally{K(!1)}}function Y(){W(null),z([]),G([]),g(null),N([]),_(null)}async function re(a){g(a),U(!0);try{const{data:t}=await i.from("vendas_recibos").select("numero_recibo, valor_total, valor_taxas, produtos(nome)").eq("venda_id",a.id);N((t||[]).map(l=>({numero_recibo:l.numero_recibo,valor_total:l.valor_total,valor_taxas:l.valor_taxas,produto_nome:l.produtos?.nome||null})))}catch(t){console.error(t),c("Erro ao carregar recibos da venda.")}finally{U(!1)}}function oe(a){_(a)}function ie(a){u&&(B(a.id),f({nome:a.nome,nascimento:a.nascimento||"",cpf:a.cpf,telefone:a.telefone,whatsapp:a.whatsapp||"",email:a.email||"",endereco:a.endereco||"",complemento:a.complemento||"",cidade:a.cidade||"",estado:a.estado||"",cep:a.cep||"",rg:a.rg||"",genero:a.genero||"",nacionalidade:a.nacionalidade||"",tags:(a.tags||[]).join(", "),tipo_cliente:a.tipo_cliente||"passageiro",notas:a.notas||"",active:a.active}))}async function ce(a){if(a.preventDefault(),!(!C&&!u))try{T(!0),c(null);const t={nome:s.nome.trim(),nascimento:s.nascimento||null,cpf:s.cpf.trim(),telefone:s.telefone.trim(),whatsapp:s.whatsapp.trim()||null,email:s.email.trim()||null,endereco:s.endereco.trim()||null,complemento:s.complemento.trim()||null,cidade:s.cidade.trim()||null,estado:s.estado.trim()||null,cep:s.cep.trim()||null,rg:s.rg.trim()||null,genero:s.genero.trim()||null,nacionalidade:s.nacionalidade.trim()||null,tags:s.tags?s.tags.split(",").map(l=>l.trim()):[],tipo_cliente:s.tipo_cliente,notas:s.notas||null,active:s.active};if(x){const{error:l}=await i.from("clientes").update(t).eq("id",x);if(l)throw l;await E({acao:"cliente_editado",modulo:"Clientes",detalhes:{id:x,payload:t}})}else{const{error:l}=await i.from("clientes").insert(t);if(l)throw l;await E({acao:"cliente_criado",modulo:"Clientes",detalhes:t})}f(V),B(null),await R()}catch(t){console.error(t),c("Erro ao salvar cliente.")}finally{T(!1)}}async function de(a){if(v&&window.confirm("Excluir cliente?"))try{O(a);const{error:t}=await i.from("clientes").delete().eq("id",a);if(t)throw t;await E({acao:"cliente_excluido",modulo:"Clientes",detalhes:{id:a}}),await R()}catch{c("NÃ£o foi possÃ­vel excluir este cliente.")}finally{O(null)}}if(!ee)return e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Clientes."})});const me=!C&&!u;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"clientes-page",children:[!me&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:ce,children:[e.jsx("h3",{children:x?"Editar cliente":"Novo cliente"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:s.nome,onChange:a=>j("nome",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"CPF *"}),e.jsx("input",{className:"form-input",value:s.cpf,onChange:a=>j("cpf",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Telefone *"}),e.jsx("input",{className:"form-input",value:s.telefone,onChange:a=>j("telefone",a.target.value)})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Whatsapp"}),e.jsx("input",{className:"form-input",value:s.whatsapp,onChange:a=>j("whatsapp",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Email"}),e.jsx("input",{className:"form-input",value:s.email,onChange:a=>j("email",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tags (,) "}),e.jsx("input",{className:"form-input",value:s.tags,onChange:a=>j("tags",a.target.value),placeholder:"premium, recorrente..."})]})]}),e.jsxs("div",{className:"mt-2",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-primary",disabled:H,type:"submit",children:H?"Salvando...":x?"Salvar alteraÃ§Ãµes":"Criar cliente"}),x&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:ne,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cliente"}),e.jsx("input",{className:"form-input",value:b,onChange:a=>te(a.target.value),placeholder:"Nome, CPF ou e-mail"})]})})}),k&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:k})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[960px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Telefone"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{children:"Ativo"}),(u||v)&&e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Carregando..."})}),!L&&X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum cliente encontrado."})}),!L&&X.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.cpf}),e.jsx("td",{children:a.telefone}),e.jsx("td",{children:a.email||"-"}),e.jsx("td",{children:a.active?"Sim":"NÃ£o"}),(u||v)&&e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",onClick:()=>le(a),title:"HistÃ³rico",children:"ðŸ—‚ï¸"}),u&&e.jsx("button",{className:"btn-icon",onClick:()=>ie(a),title:"Editar",children:"âœï¸"}),v&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>de(a.id),disabled:I===a.id,title:"Excluir",children:I===a.id?"...":"ðŸ—‘ï¸"})]})]},a.id))]})]})})]}),P&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:1100,width:"95vw"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"modal-title",children:["HistÃ³rico de ",P.nome]}),e.jsx("small",{style:{color:"#64748b"},children:"Vendas e orÃ§amentos do cliente"})]}),e.jsx("button",{className:"btn-ghost",onClick:Y,children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[J&&e.jsx("p",{children:"Carregando histÃ³rico..."}),!J&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"Vendas"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data lanÃ§amento"}),e.jsx("th",{children:"Embarque"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma venda encontrada."})}),A.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_lancamento?new Date(a.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.destino_nome||"-"}),e.jsx("td",{children:a.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"th-actions",children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>re(a),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},a.id))]})]})})]}),e.jsxs("div",{className:"card-base card-blue mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"OrÃ§amentos do cliente"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Venda"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[M.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhum orÃ§amento encontrado."})}),M.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_orcamento?.slice(0,10)||"-"}),e.jsx("td",{style:{textTransform:"capitalize"},children:a.status||"-"}),e.jsx("td",{children:a.destino_nome||"-"}),e.jsx("td",{children:(a.valor??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.numero_venda||"-"}),e.jsx("td",{className:"th-actions",children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>oe(a),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},a.id))]})]})})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:Y,children:"Fechar"})})]})}),d&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:720},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",children:"Detalhes da venda"}),e.jsxs("small",{style:{color:"#64748b"},children:["Destino: ",d.destino_nome||"-"]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>{g(null),N([])},children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{style:{marginBottom:12,lineHeight:1.5},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"LanÃ§amento:"})," ",new Date(d.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",d.data_embarque?new Date(d.data_embarque).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",d.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Taxas:"})," ",d.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]})]}),e.jsx("h4",{style:{marginBottom:8},children:"Recibos"}),se?e.jsx("p",{children:"Carregando recibos..."}):e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"NÃºmero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"})]})}),e.jsxs("tbody",{children:[Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum recibo encontrado."})}),Q.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsx("td",{children:(a.valor_total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:(a.valor_taxas||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},t))]})]})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>{g(null),N([])},children:"Fechar"})})]})}),m&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:640},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",children:"Detalhes do orÃ§amento"}),e.jsxs("small",{style:{color:"#64748b"},children:["Destino: ",m.destino_nome||"-"]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>_(null),children:"âœ•"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{style:{lineHeight:1.5},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Data:"})," ",m.data_orcamento?new Date(m.data_orcamento).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",m.status||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",(m.valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Venda vinculada:"})," ",m.numero_venda||"-"]})]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>_(null),children:"Fechar"})})]})})]})}export{_e as default};
