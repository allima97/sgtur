import{j as t,s as y}from"./supabase.DNkd6bxA.js";import{r as c}from"./index.C0Fn7Wtz.js";import{u as M,w as et}from"./xlsx.DrgRuPKf.js";function q(){return new Date().toISOString().substring(0,10)}function F(s,D){const h=new Date(s);return h.setDate(h.getDate()+D),h}function g(s){return s.toISOString().substring(0,10)}function V(s){return new Date(s.getFullYear(),s.getMonth(),1)}function G(s){return new Date(s.getFullYear(),s.getMonth()+1,0)}function at(s){return s.includes(";")||s.includes('"')||s.includes(`
`)?'"'+s.replace(/"/g,'""')+'"':s}function st(){const[s,D]=c.useState([]),[h,S]=c.useState(()=>{const a=F(new Date,-30);return g(a)}),[w,v]=c.useState(q()),[k,P]=c.useState("todos"),[O,Q]=c.useState([]),[E,I]=c.useState(!1),[L,b]=c.useState(null),[m,Y]=c.useState(null),[W,B]=c.useState(!0),[j,z]=c.useState({pdf:!0,excel:!0}),[f,H]=c.useState("total"),[_,$]=c.useState(!0);c.useEffect(()=>{async function e(){try{const{data:a,error:o}=await y.from("destinos").select("id, nome").order("nome",{ascending:!0});if(o)throw o;D(a||[])}catch(a){console.error(a),b("Erro ao carregar destinos.")}}e()},[]),c.useEffect(()=>{async function e(){try{B(!0),b(null);const{data:a}=await y.auth.getUser(),o=a?.user?.id;if(!o){b("Usuário não autenticado.");return}const{data:n}=await y.from("users").select("id, user_types(name), company_id").eq("id",o).maybeSingle(),r=n?.user_types?.name||a?.user?.user_metadata?.name||"",i=String(r||"").toUpperCase();let d="VENDEDOR";i.includes("ADMIN")?d="ADMIN":i.includes("GESTOR")?d="GESTOR":i.includes("VENDEDOR")?d="VENDEDOR":d="OUTRO";let u=[o];if(d==="GESTOR"){const{data:x}=await y.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",o),tt=x?.map(C=>C.vendedor_id).filter(C=>!!C)||[];u=Array.from(new Set([o,...tt]))}else d==="ADMIN"&&(u=[]);const p=n?.company_id||null;if(p){const{data:x}=await y.from("parametros_comissao").select("exportacao_pdf, exportacao_excel").eq("company_id",p).maybeSingle();x&&z({pdf:x.exportacao_pdf??!0,excel:x.exportacao_excel??!0})}Y({usuarioId:o,papel:d,vendedorIds:u})}catch(a){console.error(a),b("Erro ao carregar contexto do usuário.")}finally{B(!1)}}e()},[]);const l=c.useMemo(()=>{const e=new Map(s.map(n=>[n.id,n.nome])),a=new Map;O.forEach(n=>{const r=n.destino_id,i=e.get(r)||"(sem destino)",d=a.get(r)||{destino_id:r,destino_nome:i,quantidade:0,total:0,ticketMedio:0},u=n.valor_total??0;d.quantidade+=1,d.total+=u,a.set(r,d)});const o=Array.from(a.values()).map(n=>({...n,ticketMedio:n.quantidade>0?n.total/n.quantidade:0}));return o.sort((n,r)=>{let i=0;return f==="total"?i=n.total-r.total:f==="quantidade"?i=n.quantidade-r.quantidade:i=n.ticketMedio-r.ticketMedio,_?-i:i}),o},[O,s,f,_]),A=l.reduce((e,a)=>e+a.total,0),T=l.reduce((e,a)=>e+a.quantidade,0),J=T>0?A/T:0;function N(e){const a=new Date;if(e==="7"){const o=F(a,-7);S(g(o)),v(q());return}if(e==="30"){const o=F(a,-30);S(g(o)),v(q());return}if(e==="mes_atual"){const o=V(a),n=G(a);S(g(o)),v(g(n));return}if(e==="mes_anterior"){const o=new Date(a.getFullYear(),a.getMonth()-1,1),n=V(o),r=G(o);S(g(n)),v(g(r));return}}async function U(){if(m)try{I(!0),b(null);let e=y.from("vendas").select("id, vendedor_id, cliente_id, destino_id, produto_id, data_lancamento, data_embarque, valor_total, status").order("data_lancamento",{ascending:!1});m.papel!=="ADMIN"&&(e=e.in("vendedor_id",m.vendedorIds)),h&&(e=e.gte("data_lancamento",h)),w&&(e=e.lte("data_lancamento",w)),k!=="todos"&&(e=e.eq("status",k));const{data:a,error:o}=await e;if(o)throw o;Q(a||[])}catch(e){console.error(e),b("Erro ao carregar vendas para relatório por destino.")}finally{I(!1)}}function R(e){e===f?$(a=>!a):(H(e),$(!0))}c.useEffect(()=>{m&&U()},[m]);function K(){if(l.length===0){alert("Não há dados para exportar.");return}const e=["destino","quantidade","total","ticket_medio"],a=l.map(p=>[p.destino_nome,p.quantidade.toString(),p.total.toFixed(2).replace(".",","),p.ticketMedio.toFixed(2).replace(".",",")]),o=[e,...a].map(p=>p.map(x=>at(x)).join(";")).join(`
`),n=new Blob([o],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),i=new Date,d=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`,u=document.createElement("a");u.href=r,u.setAttribute("download",`relatorio-vendas-por-destino-${d}.csv`),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(r)}function X(){if(!j.excel){alert("Exportação Excel desabilitada nos parâmetros.");return}if(l.length===0){alert("Não há dados para exportar.");return}const e=l.map(r=>({Destino:r.destino_nome,Quantidade:r.quantidade,"Faturamento (R$)":r.total,"Ticket médio (R$)":r.ticketMedio})),a=M.json_to_sheet(e),o=M.book_new();M.book_append_sheet(o,a,"Vendas por Destino");const n=new Date().toISOString().replace(/[-:T]/g,"").slice(0,12);et(o,`relatorio-destinos-${n}.xlsx`)}function Z(){if(!j.pdf){alert("Exportação PDF desabilitada nos parâmetros.");return}if(l.length===0){alert("Não há dados para exportar.");return}const e=window.open("","_blank");if(!e){alert("Não foi possível abrir a janela de exportação.");return}const a=l.map(o=>`
        <tr>
          <td>${o.destino_nome}</td>
          <td>${o.quantidade}</td>
          <td>${o.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
          <td>${o.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
        </tr>`).join("");e.document.write(`
      <html>
        <head>
          <title>Vendas por Destino</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 16px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
            th { background: #f1f5f9; }
          </style>
        </head>
        <body>
          <h3>Relatório de Vendas por Destino</h3>
          <table>
            <thead>
              <tr>
                <th>Destino</th>
                <th>Qtde</th>
                <th>Faturamento</th>
                <th>Ticket médio</th>
              </tr>
            </thead>
            <tbody>${a}</tbody>
          </table>
          <script>window.print();<\/script>
        </body>
      </html>
    `),e.document.close()}return t.jsxs("div",{className:"relatorio-vendas-destino-page",children:[t.jsxs("div",{className:"card-base card-purple mb-3",children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data início"}),t.jsx("input",{type:"date",className:"form-input",value:h,onChange:e=>S(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data fim"}),t.jsx("input",{type:"date",className:"form-input",value:w,onChange:e=>v(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Status"}),t.jsxs("select",{className:"form-select",value:k,onChange:e=>P(e.target.value),children:[t.jsx("option",{value:"todos",children:"Todos"}),t.jsx("option",{value:"aberto",children:"Aberto"}),t.jsx("option",{value:"confirmado",children:"Confirmado"}),t.jsx("option",{value:"cancelado",children:"Cancelado"})]})]})]}),t.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("7"),children:"Últimos 7 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("30"),children:"Últimos 30 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_atual"),children:"Este mês"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_anterior"),children:"Mês anterior"}),t.jsx("button",{type:"button",className:"btn btn-primary",onClick:U,children:"Aplicar filtros"}),t.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-purple",onClick:K,children:"Exportar CSV"}),t.jsx("button",{type:"button",className:"btn btn-primary",onClick:X,disabled:!j.excel,title:j.excel?"":"Exportação Excel desabilitada nos parâmetros",children:"Exportar Excel"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:Z,disabled:!j.pdf,title:j.pdf?"":"Exportação PDF desabilitada nos parâmetros",children:"Exportar PDF"})]})]})]}),W&&t.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),m&&m.papel!=="ADMIN"&&t.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",m.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),L&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:L})}),t.jsx("div",{className:"card-base mb-3",children:t.jsxs("div",{className:"form-row",children:[t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Destinos: ",t.jsx("strong",{children:l.length})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Faturamento total:"," ",t.jsx("strong",{children:A.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Ticket médio geral:"," ",t.jsx("strong",{children:J.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),t.jsx("div",{className:"table-container overflow-x-auto",children:t.jsxs("table",{className:"table-default table-header-purple min-w-[620px]",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Destino"}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>R("quantidade"),children:["Qtde ",f==="quantidade"?_?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>R("total"),children:["Faturamento ",f==="total"?_?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>R("ticket"),children:["Ticket médio ",f==="ticket"?_?"↓":"↑":""]})]})}),t.jsxs("tbody",{children:[E&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Carregando..."})}),!E&&l.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Nenhum destino encontrado com os filtros atuais."})}),!E&&l.map(e=>t.jsxs("tr",{children:[t.jsx("td",{children:e.destino_nome}),t.jsx("td",{children:e.quantidade}),t.jsx("td",{children:e.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),t.jsx("td",{children:e.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},e.destino_id))]})]})})]})}export{st as default};
