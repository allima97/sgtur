import{j as e,s as i}from"./supabase.CWKfsr2i.js";import{r as n}from"./index.DVhKKaGN.js";import{r as d}from"./logs.z45cSWoX.js";function P(){const[l,S]=n.useState(""),[x,C]=n.useState(""),[j,E]=n.useState(""),[m,u]=n.useState(null),[v,t]=n.useState(!1),[A,N]=n.useState(!1);async function k(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip||""}catch{return""}}function r(s,o="danger"){u({texto:s,tipo:o}),setTimeout(()=>u(null),5e3)}function q(){N(!0)}function b(){N(!1)}async function I(s){s.preventDefault(),E(""),u(null),t(!0);const o=l.trim().toLowerCase(),w=x;if(!o||!w){r("Informe e-mail e senha"),t(!1);return}const f=await k(),h=typeof navigator<"u"?navigator.userAgent:"";try{await d({user_id:null,acao:"tentativa_login",modulo:"login",detalhes:{email:o}});const{data:p,error:y}=await i.auth.signInWithPassword({email:o,password:w});if(y){await d({user_id:null,acao:"login_falhou",modulo:"login",detalhes:{email:l,motivo:y.message,ip:f,userAgent:h}}),r("E-mail ou senha incorretos. Verifique seus dados e tente novamente."),t(!1);return}const c=p.user?.id||null;await d({user_id:c,acao:"login_sucesso",modulo:"login",detalhes:{email:o,userId:c,ip:f,userAgent:h}});const{data:_}=await i.auth.getUser();if(!!!(_?.user?.email_confirmed_at||_?.user?.confirmed_at)){await i.auth.signOut(),r("Confirme seu e-mail antes de acessar o sistema.","warning"),t(!1);return}const{data:L,error:g}=await i.from("users").select("nome_completo, active, company_id, cpf, telefone, cidade, estado, uso_individual").eq("id",c).maybeSingle();let a=L;if(g&&(g.code==="42703"||g.message?.toLowerCase().includes("active"))){const{data:M}=await i.from("users").select("nome_completo, company_id, cpf, telefone, cidade, estado, uso_individual").eq("id",c).maybeSingle();a=M}if(!a){r("Não foi possível carregar seu perfil. Tente novamente."),t(!1);return}if(a&&a.active===!1){q(),await i.auth.signOut(),t(!1);return}if(!a.nome_completo||!a.telefone||!a.cidade||!a.estado||a.uso_individual===null||a.uso_individual===void 0){window.location.replace("/perfil?onboarding=1");return}window.location.replace("/dashboard")}catch(p){await d({user_id:null,acao:"login_erro_interno",modulo:"login",detalhes:{email:l,erro:p.message,ip:f,userAgent:h}}),r("Erro inesperado ao fazer login.")}finally{t(!1)}}return e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-card auth-card-lg",children:[e.jsxs("div",{className:"auth-header",children:[e.jsx("div",{className:"auth-icon",children:e.jsx("i",{className:"fa-solid fa-plane-departure","aria-hidden":!0})}),e.jsx("h1",{children:"Bem-vindo ao SGTUR"}),e.jsx("h2",{children:"Sistema de Gerenciamento de Turismo"}),e.jsx("p",{className:"auth-subtitle",children:"Use seu e-mail e senha para acessar ou faça seu cadastro"})]}),m&&e.jsx("div",{className:`alert alert-${m.tipo}`,style:{marginBottom:12},children:m.texto}),j&&e.jsx("div",{className:"alert alert-danger",style:{marginBottom:16},children:j}),A&&e.jsxs("div",{className:"modal",children:[e.jsx("div",{className:"modal-overlay",onClick:b}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("i",{className:"fa-solid fa-triangle-exclamation text-yellow-600"}),e.jsx("h2",{children:"Acesso Suspenso"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{className:"text-lg font-semibold mb-4",children:"Atenção!"}),e.jsx("p",{className:"text-gray-700 mb-6",children:"Seu acesso está suspenso, por favor entrar em contato com o Gestor ou Administrador do sistema."}),e.jsxs("div",{className:"contact-info",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Se você acredita que isto é um erro, entre em contato:"}),e.jsxs("ul",{className:"mt-3 space-y-2 text-sm",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Email:"})," suporte@sgtur.com"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Telefone:"})," (11) 1234-5678"]})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{onClick:b,className:"btn btn-secondary",children:"Fechar"})})]})]}),e.jsxs("form",{onSubmit:I,className:"auth-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"email",children:[e.jsx("i",{className:"fa-solid fa-envelope"})," E-mail"]}),e.jsx("input",{type:"email",id:"email",className:"form-input",placeholder:"seu@email.com",required:!0,autoComplete:"email",value:l,onChange:s=>S(s.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"senha",children:[e.jsx("i",{className:"fa-solid fa-lock"})," Senha"]}),e.jsx("input",{type:"password",id:"senha",className:"form-input",placeholder:"Digite sua senha",required:!0,autoComplete:"current-password",value:x,onChange:s=>C(s.target.value)})]}),e.jsxs("div",{className:"auth-actions",children:[e.jsxs("button",{type:"submit",className:"btn btn-primary btn-block",disabled:v,children:[e.jsx("i",{className:"fa-solid fa-right-to-bracket"}),v?" Entrando...":" Entrar"]}),e.jsxs("a",{href:"/auth/register",className:"btn btn-secondary btn-block",children:[e.jsx("i",{className:"fa-solid fa-user-plus"}),"Criar Nova Conta"]})]})]})]})})}export{P as default};
