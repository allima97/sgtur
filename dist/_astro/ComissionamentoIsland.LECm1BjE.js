import{s as p,j as a}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as oa}from"./usePermissao.72SYthuA.js";const ia=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function q(d,n){const c=new Date(d);return c.setMonth(c.getMonth()+n),c}function Y(d){return d.toISOString().slice(0,10)}function O(d){const n=new Date;let c;switch(d){case"mes_anterior":{c=new Date(n.getFullYear(),n.getMonth()-1,1);break}case"trim":c=q(n,-3);break;case"sem":c=q(n,-6);break;case"ano":c=q(n,-12);break;case"mes_atual":default:c=new Date(n.getFullYear(),n.getMonth(),1);break}return{inicio:Y(c),fim:Y(n)}}function ca(){const{ativo:d,loading:n}=oa("Vendas"),[c,T]=r.useState(null),[R,H]=r.useState(null),[h,J]=r.useState(null),[G,K]=r.useState([]),[V,Q]=r.useState({}),[E,X]=r.useState({}),[j,Z]=r.useState({}),[A,$]=r.useState([]),[F,U]=r.useState(!0),[z,C]=r.useState(null),[b,aa]=r.useState("mes_atual"),[I,ea]=r.useState(()=>O("mes_atual"));r.useEffect(()=>{n||!d||ta()},[n,d,b]),r.useEffect(()=>{ea(O(b))},[b]);async function ta(){try{U(!0),C(null);const{data:i}=await p.auth.getUser(),f=i?.user?.id||null;if(!f){C("Usuário não autenticado.");return}T({id:f,nome:i?.user?.email||""});const g=O(b),{data:x}=await p.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:v}=await p.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",f).eq("periodo",g.inicio.slice(0,7)+"-01").maybeSingle(),[y,N,k,P,S]=await Promise.all([p.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",v?.id||""),p.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta"),p.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta"),p.from("tipo_produtos").select("id, nome, regra_comissionamento, soma_na_meta"),p.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              id, nome, regra_comissionamento, soma_na_meta
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",g.inicio).lte("data_lancamento",g.fim)]),B=y.data,w=N.data,D=k.data,t=P.data,u=S.data,l={};(w||[]).forEach(e=>{l[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta}});const o={};(D||[]).forEach(e=>{o[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const s={};(t||[]).forEach(e=>{s[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta}}),H(x?{usar_taxas_na_meta:!!x.usar_taxas_na_meta,foco_valor:x.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),J(v),K(B||[]),Q(l),X(o),Z(s),$(u||[])}catch(i){console.error(i),C("Erro ao carregar dados de comissionamento.")}finally{U(!1)}}const m=r.useMemo(()=>{if(!R)return null;const i={};G.forEach(t=>{i[t.produto_id]=t.valor});const f={},g={},x={};let v=0,y=0,N=0,k=0,P=0;const S={},B=[];Object.values(j).forEach(t=>{t.regra_comissionamento==="diferenciado"&&(B.push(t.id),S[t.id]=0)}),A.forEach(t=>{(t.vendas_recibos||[]).forEach(u=>{const l=u.tipo_produtos?.id||u.produto_id||"",o=j[l];if(!o)return;const s=Number(u.valor_total||0),e=Number(u.valor_taxas||0),M=s-e,L=R.usar_taxas_na_meta?s:M;g[l]=(g[l]||0)+s,x[l]=(x[l]||0)+M,f[l]=(f[l]||0)+L,o.soma_na_meta&&(v+=L),y+=s,N+=e})});const w=y-N,D=h?.meta_geral&&h.meta_geral>0?v/h.meta_geral*100:0;return Object.keys(g).forEach(t=>{const u=j[t];if(!u)return;const l=R.foco_valor==="liquido"?x[t]||0:g[t]||0;if(u.regra_comissionamento==="diferenciado"){const o=E[t];if(!o)return;const s=i[t]||0,e=f[t]||0,M=s>0,L=M?e/s*100:0,sa=M?e<s?0:L>=120?o.fix_super_meta??o.fix_meta_atingida??o.fix_meta_nao_atingida??0:o.fix_meta_atingida??o.fix_meta_nao_atingida??0:o.fix_meta_nao_atingida??o.fix_meta_atingida??o.fix_super_meta??0,W=l*(sa/100);P+=W,S[t]=W}else{const o=E[t]?.rule_id,s=o?V[o]:void 0;let e=0;s&&(D<100?e=s.meta_nao_atingida||0:D>=120?e=s.super_meta??s.meta_atingida??s.meta_nao_atingida??0:e=s.meta_atingida??s.meta_nao_atingida??0),k+=l*(e/100)}}),{baseMeta:v,totalBruto:y,totalTaxas:N,valorLiquido:w,pctMetaGeral:D,comissaoGeral:k,comissaoDif:P,totalComissao:k+P,comissaoDifDetalhe:S,produtosDiferenciados:B}},[A,R,j,E,G,h,V]);if(n)return a.jsx("div",{children:"Carregando permissões..."});if(!d)return a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const _={flexDirection:"column",alignItems:"center",textAlign:"center"};return a.jsxs("div",{className:"card-base",style:{background:"transparent",boxShadow:"none",padding:0},children:[a.jsx("div",{className:"card-base",style:{marginBottom:12},children:a.jsxs("div",{className:"form-row",style:{marginBottom:0},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:b,onChange:i=>aa(i.target.value),children:ia.map(i=>a.jsx("option",{value:i.id,children:i.label},i.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:I.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:I.fim,readOnly:!0})]})]})}),z&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:z})}),F&&a.jsx("div",{children:"Carregando dados..."}),!F&&m&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",style:{marginBottom:12},children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,marginBottom:16},children:"Como está seu Progresso"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))",gap:12,marginBottom:4},children:[a.jsxs("div",{className:"kpi-card",style:{..._,color:"#16a34a"},children:[a.jsx("div",{className:"kpi-label",children:"Meta do mês"}),a.jsx("div",{className:"kpi-value",children:(h?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#ca8a04"},children:[a.jsx("div",{className:"kpi-label",children:"Total Bruto"}),a.jsx("div",{className:"kpi-value",children:m.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#c2410c"},children:[a.jsx("div",{className:"kpi-label",children:"Total Taxas"}),a.jsx("div",{className:"kpi-value",children:m.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#0ea5e9"},children:[a.jsx("div",{className:"kpi-label",children:"Valor Liquido"}),a.jsx("div",{className:"kpi-value",children:m.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#2563eb"},children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[m.pctMetaGeral.toFixed(1),"%"]})]})]})]}),a.jsxs("div",{className:"card-base",children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[a.jsxs("div",{className:"kpi-card",style:_,children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:m.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),(m.produtosDiferenciados||[]).map(i=>a.jsxs("div",{className:"kpi-card",style:_,children:[a.jsx("div",{className:"kpi-label",children:j[i]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:(m.comissaoDifDetalhe?.[i]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},i)),a.jsxs("div",{className:"kpi-card kpi-highlight",style:_,children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:m.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{ca as default};
