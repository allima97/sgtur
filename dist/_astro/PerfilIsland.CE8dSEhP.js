import{j as e,s as m}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{r as K}from"./logs.WCvMC_es.js";function Z(){const[s,y]=r.useState(null),[U,T]=r.useState(!0),[x,u]=r.useState(!1),[D,f]=r.useState(null),[$,i]=r.useState(null),[j,I]=r.useState(""),[A,k]=r.useState(""),[g,w]=r.useState(""),[W,R]=r.useState(!1),[E,_]=r.useState(null),[S,L]=r.useState(""),[P,B]=r.useState(null),[p,O]=r.useState(!0),[q,b]=r.useState(null);r.useMemo(()=>{if(!s)return"";const a=s.cidade||"",n=s.estado||"";return[a,n].filter(Boolean).join(" / ")},[s]),r.useEffect(()=>{const a=new URLSearchParams(window.location.search);R(a.get("onboarding")==="1")},[]),r.useEffect(()=>{async function a(){try{T(!0),i(null);const{data:n}=await m.auth.getSession(),o=n?.session?.user;if(!o){window.location.href="/auth/login";return}const c="nome_completo, cpf, data_nascimento, telefone, whatsapp, rg, cep, endereco, numero, complemento, cidade, estado, email, uso_individual, company_id, companies(nome_empresa, cnpj, endereco, telefone), user_types(name)",h="nome_completo, cpf, data_nascimento, telefone, cidade, estado, email, uso_individual, company_id, companies(nome_empresa, cnpj, endereco, telefone), user_types(name)";let d=!0,{data:l,error:v}=await m.from("users").select(c).eq("id",o.id).maybeSingle();if(v&&v.code==="PGRST204"){d=!1;const z=await m.from("users").select(h).eq("id",o.id).maybeSingle();l=z.data,v=z.error}if(v)throw v;O(d),y({nome_completo:l?.nome_completo||"",cpf:l?.cpf||"",data_nascimento:l?.data_nascimento||"",telefone:l?.telefone||"",whatsapp:d&&l?.whatsapp||"",rg:d&&l?.rg||"",cep:d&&l?.cep||"",endereco:d&&l?.endereco||"",numero:d&&l?.numero||"",complemento:d&&l?.complemento||"",cidade:l?.cidade||"",estado:l?.estado||"",email:l?.email||o.email||"",uso_individual:l?.uso_individual??null,company_id:l?.company_id||null,company:l?.companies||null,cargo:l?.user_types?.name||null}),w(l?.email||o.email||""),_(l?.uso_individual??null),B({nome:l?.companies?.nome_empresa||null,cnpj:l?.companies?.cnpj||null})}catch(n){console.error(n),i("N√£o foi poss√≠vel carregar seu perfil.")}finally{T(!1)}}a()},[]);function t(a,n){y(o=>o&&{...o,[a]:n})}function H(a){return a.replace(/\D/g,"").slice(0,11).replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d)/,"$1.$2").replace(/(\d{3})(\d{1,2})$/,"$1-$2")}function N(a){const n=a.replace(/\D/g,"").slice(0,11);return n.length<=10?n.replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{4})(\d)/,"$1-$2"):n.replace(/(\d{2})(\d)/,"($1) $2").replace(/(\d{5})(\d)/,"$1-$2")}function C(a){return a.replace(/\D/g,"").slice(0,8).replace(/(\d{5})(\d)/,"$1-$2")}async function J(){if(s){i(null),f(null),u(!0);try{const{data:a}=await m.auth.getSession(),n=a?.session?.user;if(!n){window.location.href="/auth/login";return}await m.from("users").update({nome_completo:s.nome_completo||null,telefone:s.telefone||null,cidade:s.cidade||null,estado:s.estado||null,data_nascimento:s.data_nascimento||null,uso_individual:E,...p?{whatsapp:s.whatsapp||null,rg:s.rg||null,cep:s.cep||null,endereco:s.endereco||null,numero:s.numero||null,complemento:s.complemento||null}:{}}).eq("id",n.id),await K({user_id:n.id,acao:"perfil_atualizado",modulo:"perfil",detalhes:{cidade:s.cidade,estado:s.estado}}),f("Dados salvos com sucesso.")}catch(a){console.error(a),i("N√£o foi poss√≠vel salvar seus dados.")}finally{u(!1)}}}async function M(){if(i(null),f(null),!j||j.length<6){i("A nova senha deve ter ao menos 6 caracteres.");return}if(j!==A){i("As senhas n√£o conferem.");return}try{u(!0);const{error:a}=await m.auth.updateUser({password:j});if(a)throw a;f("Senha alterada com sucesso."),I(""),k("")}catch(a){console.error(a),i("N√£o foi poss√≠vel alterar a senha.")}finally{u(!1)}}async function G(){if(i(null),f(null),!g){i("Informe um e-mail v√°lido.");return}try{u(!0);const{error:a}=await m.auth.updateUser({email:g});if(a)throw a;await m.from("users").update({email:g}).eq("email",s?.email||g),f("E-mail atualizado. Confirme o novo e-mail para continuar usando."),y(n=>n&&{...n,email:g})}catch(a){console.error(a),i("N√£o foi poss√≠vel alterar o e-mail.")}finally{u(!1)}}async function V(){if(!S.trim()){i("Informe o CNPJ da nova empresa.");return}try{u(!0);const a=S.replace(/\D/g,""),{data:n,error:o}=await m.from("companies").select("id, nome_empresa, cnpj").eq("cnpj",a).limit(1);if(o)throw o;if(!n||n.length===0){i("Empresa n√£o encontrada para o CNPJ informado.");return}const c=n[0],{data:h}=await m.auth.getSession(),d=h?.session?.user;if(!d){window.location.href="/auth/login";return}await m.from("users").update({company_id:c.id}).eq("id",d.id),B({nome:c.nome_empresa,cnpj:c.cnpj}),f("Empresa atualizada com sucesso."),i(null)}catch(a){console.error(a),i("N√£o foi poss√≠vel trocar a empresa.")}finally{u(!1)}}async function F(a){if(!p)return;const n=(a||"").replace(/\D/g,"");if(console.log("[CEP] Valor recebido:",a,"| Somente d√≠gitos:",n),n.length!==8){b(null),console.log("[CEP] Menos de 8 d√≠gitos, abortando busca");return}try{b("Buscando endere√ßo...");const o=await fetch(`https://viacep.com.br/ws/${n}/json/`,{mode:"cors"});if(!o.ok)throw new Error("CEP inv√°lido ou indispon√≠vel.");const c=await o.json();if(console.log("[CEP] Resposta ViaCEP:",c),c.erro)throw new Error("CEP n√£o encontrado.");y(h=>h&&{...h,cep:C(n),endereco:c.logradouro||"",cidade:c.localidade||"",estado:c.uf||""}),b("Endere√ßo carregado pelo CEP."),console.log("[CEP] Perfil atualizado com endere√ßo, cidade e estado do ViaCEP")}catch(o){console.error("Erro ao buscar CEP:",o),b("N√£o foi poss√≠vel carregar o CEP.")}}return U?e.jsx("div",{className:"card-base card-config",children:"Carregando perfil..."}):s?e.jsxs("div",{className:"perfil-page",children:[W&&e.jsx("div",{className:"card-base card-config mb-3",children:"Complete os dados para finalizar seu primeiro acesso."}),$&&e.jsx("div",{className:"card-base card-config mb-3",children:$}),D&&e.jsx("div",{className:"card-base card-green mb-3",children:D}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{className:"card-base card-blue",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üë§ Dados pessoais"}),!p&&e.jsx("small",{style:{color:"#b91c1c",marginBottom:8},children:'Campos extras indispon√≠veis. Adicione as colunas novas em "users" no banco para editar CEP/WhatsApp/RG/endere√ßo.'}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Uso do sistema"}),e.jsxs("div",{className:"flex items-center gap-4",style:{marginTop:6},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"radio",name:"uso",checked:E!==!1,onChange:()=>_(!0)}),"Individual"]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6},children:[e.jsx("input",{type:"radio",name:"uso",checked:E===!1,onChange:()=>_(!1)}),"Corporativo"]})]}),e.jsx("small",{children:"Selecione conforme a forma de uso (pessoal ou vinculada √† empresa)."})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(0, 1.6fr) minmax(0, 0.9fr) minmax(0, 0.9fr) minmax(0, 1.1fr)",gap:12,marginTop:16},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nome completo"}),e.jsx("input",{className:"form-input",value:s.nome_completo,onChange:a=>t("nome_completo",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"CPF"}),e.jsx("input",{className:"form-input",value:H(s.cpf||""),readOnly:!0,placeholder:"000.000.000-00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"RG"}),e.jsx("input",{className:"form-input",value:s.rg||"",onChange:a=>t("rg",a.target.value),placeholder:"Documento",disabled:!p})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data Nascimento"}),e.jsx("input",{className:"form-input",type:"date",value:s.data_nascimento||"",onChange:a=>t("data_nascimento",a.target.value)})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(0, 0.8fr) minmax(0, 2fr) minmax(0, 0.7fr) minmax(0, 1fr)",gap:12,marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"CEP"}),e.jsx("input",{className:"form-input",value:C(s.cep||""),onChange:a=>{const n=C(a.target.value);t("cep",n)},onBlur:a=>{const n=C(a.target.value);n.replace(/\D/g,"").length===8&&F(n)},placeholder:"00000-000",disabled:!p}),e.jsx("small",{style:{color:q?.includes("N√£o foi")?"#b91c1c":"#475569"},children:q||"Preencha para auto-preencher endere√ßo."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Endere√ßo"}),e.jsx("input",{className:"form-input",value:s.endereco||"",onChange:a=>t("endereco",a.target.value),placeholder:"Rua / Avenida",disabled:!p})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"N√∫mero"}),e.jsx("input",{className:"form-input",value:s.numero||"",onChange:a=>t("numero",a.target.value),placeholder:"N¬∫",disabled:!p})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Complemento"}),e.jsx("input",{className:"form-input",value:s.complemento||"",onChange:a=>t("complemento",a.target.value),placeholder:"Opcional",disabled:!p})]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"minmax(0, 1.3fr) minmax(0, 1.1fr) minmax(0, 1.1fr) minmax(0, 1fr) minmax(0, 0.6fr)",gap:12,marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"E-mail"}),e.jsx("input",{className:"form-input",type:"email",value:s.email,onChange:a=>{t("email",a.target.value),w(a.target.value)},placeholder:"seu@email.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Telefone"}),e.jsx("input",{className:"form-input",value:N(s.telefone||""),onChange:a=>t("telefone",N(a.target.value)),placeholder:"(00) 00000-0000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"WhatsApp"}),e.jsx("input",{className:"form-input",value:N(s.whatsapp||""),onChange:a=>t("whatsapp",N(a.target.value)),placeholder:"(00) 00000-0000",disabled:!p})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Cidade"}),e.jsx("input",{className:"form-input",value:s.cidade||"",onChange:a=>t("cidade",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Estado"}),e.jsx("input",{className:"form-input",value:s.estado||"",maxLength:2,onChange:a=>t("estado",a.target.value.toUpperCase()),placeholder:"UF"})]})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:J,disabled:x,children:x?"Salvando...":"Salvar dados"})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"card-base card-config",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üîê Dados de acesso"}),e.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs("div",{className:"form-group",style:{flex:1},children:[e.jsx("label",{children:"E-mail de login"}),e.jsx("input",{className:"form-input",value:g,onChange:a=>w(a.target.value),type:"email"}),e.jsx("small",{children:"Ser√° necess√°rio confirmar o novo e-mail."})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"center"},children:e.jsx("button",{className:"btn btn-secondary",onClick:G,disabled:x,children:"Atualizar e-mail"})})]}),e.jsx("h4",{style:{marginTop:6,marginBottom:4},children:"Alterar senha"}),e.jsxs("div",{className:"form-group",style:{marginTop:0},children:[e.jsx("label",{children:"Nova senha"}),e.jsx("input",{className:"form-input",type:"password",value:j,onChange:a=>I(a.target.value),placeholder:"M√≠nimo 6 caracteres"})]}),e.jsxs("div",{className:"form-group",style:{marginTop:6},children:[e.jsx("label",{children:"Confirmar senha"}),e.jsx("input",{className:"form-input",type:"password",value:A,onChange:a=>k(a.target.value)})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:M,disabled:x,children:"Alterar senha"})})]}),e.jsxs("div",{className:"card-base",style:{display:"flex",flexDirection:"column",minHeight:"100%"},children:[e.jsx("h3",{children:"üè¢ Empresa"}),P?e.jsxs("p",{style:{marginBottom:12,lineHeight:1.5},children:[e.jsx("strong",{children:"Empresa:"})," ",P.nome||"-",e.jsx("br",{}),e.jsx("strong",{children:"CNPJ:"})," ",P.cnpj||"-",e.jsx("br",{}),e.jsx("strong",{children:"Endere√ßo:"})," ",s.company?.endereco||"-",e.jsx("br",{}),e.jsx("strong",{children:"Telefone:"})," ",s.company?.telefone||"-",e.jsx("br",{}),e.jsx("strong",{children:"Cargo:"})," ",s.cargo||"-"]}):e.jsx("p",{style:{marginBottom:12},children:"Nenhuma empresa vinculada."}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Trocar empresa (CNPJ)"}),e.jsx("input",{className:"form-input",value:S,onChange:a=>L(a.target.value),placeholder:"00.000.000/0000-00"})]}),e.jsx("div",{style:{display:"flex",gap:12,flexWrap:"wrap",marginTop:"auto",alignItems:"center"},children:e.jsx("button",{className:"btn btn-primary",onClick:V,disabled:x,children:"Trocar empresa"})})]})]})]})]}):e.jsx("div",{className:"card-base card-config",children:"Perfil n√£o encontrado."})}export{Z as default};
