import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as l}from"./supabase.Ng8nq9tn.js";import{u as ne}from"./usePermissao.DiLe8-Rs.js";import{L as oe}from"./LoadingUsuarioContext.BaDUNi7o.js";const le=[{value:"",label:"Todas"},{value:"planejada",label:"Planejada"},{value:"confirmada",label:"Confirmada"},{value:"em_viagem",label:"Em viagem"},{value:"concluida",label:"Concluída"},{value:"cancelada",label:"Cancelada"}];function he(){const{permissao:m,loading:y,ativo:G}=ne("Operacao"),S=m!=="none",w=m==="create"||m==="edit"||m==="delete"||m==="admin",[j,H]=i.useState(""),[v,J]=i.useState(""),[b,K]=i.useState(""),[E,X]=i.useState([]),[_,D]=i.useState(!1),[V,I]=i.useState(null),[$,F]=i.useState(!1),[L,f]=i.useState(null),[q,O]=i.useState(!1),[r,u]=i.useState({origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada",cliente_id:""}),[Y,Z]=i.useState([]),[h,k]=i.useState(null),[A,R]=i.useState(null),[ee,ae]=i.useState([]),[T,P]=i.useState(null),[se,B]=i.useState(!1),[U,M]=i.useState(null),p=i.useRef(null),g=i.useRef(null),te=a=>{const s=[a.nome];return a.subdivisao_nome&&s.push(a.subdivisao_nome),a.pais_nome&&s.push(a.pais_nome),s.join(" • ")};i.useEffect(()=>{!y&&S&&N()},[y,S,j,v,b]),i.useEffect(()=>{async function a(){const{data:s}=await l.auth.getSession(),t=s?.session?.user||null;if(t){R(t.id);const{data:n}=await l.from("users").select("company_id").eq("id",t.id).maybeSingle();k(n?.company_id||null)}else{const{data:n}=await l.auth.getUser();if(!n?.user)return;R(n.user.id);const{data:d}=await l.from("users").select("company_id").eq("id",n.user.id).maybeSingle();k(d?.company_id||null)}}a()},[]),i.useEffect(()=>{if(!h)return;async function a(){try{const{data:s,error:t}=await l.from("clientes").select("id, nome, cpf").eq("company_id",h).order("nome",{ascending:!0}).limit(200);if(t)throw t;ae(s||[]),P(null)}catch(s){console.error("Erro ao carregar clientes:",s),P("Não foi possível carregar os clientes.")}}a()},[h]),i.useEffect(()=>(z(""),()=>{p.current&&p.current.abort(),g.current&&clearTimeout(g.current)}),[]);async function z(a){p.current&&p.current.abort();const s=new AbortController;p.current=s;try{B(!0),M(null);const t=a.trim(),n=t.length===0?200:50;let d=[];try{const{data:o,error:c}=await l.rpc("buscar_cidades",{q:t,limite:n},{signal:s.signal});if(c)throw c;d=o||[]}catch(o){if(s.signal.aborted)return;console.warn("RPC buscar_cidades falhou:",o);let c=l.from("cidades").select("nome").order("nome").limit(n);t.length>0&&(c=c.ilike("nome",`%${t}%`));const C=await c;if(C.error)throw C.error;d=(C.data||[]).map(re=>({nome:re.nome}))}if(s.signal.aborted)return;const x=new Map;d.forEach(o=>{if(!o?.nome)return;const c=`${o.nome}|${o.pais_nome||""}|${o.subdivisao_nome||""}`;x.has(c)||x.set(c,o)}),Z(Array.from(x.values()))}catch(t){s.signal.aborted||(console.error("Erro ao buscar cidades:",t),M("Não foi possível carregar as cidades."))}finally{s.signal.aborted||B(!1)}}function Q(a){g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{z(a)},250)}async function N(){try{D(!0),I(null);let a=l.from("viagens").select("id, data_inicio, data_fim, status, origem, destino, responsavel_user_id, cliente_id, clientes (nome)").order("data_inicio",{ascending:!0});j&&(a=a.eq("status",j)),v&&(a=a.gte("data_inicio",v)),b&&(a=a.lte("data_inicio",b));const{data:s,error:t}=await a;if(t)throw t;X(s||[])}catch(a){console.error(a),I("Erro ao carregar viagens.")}finally{D(!1)}}async function ie(){if(!w)return;if(!h||!A){f("NÇőo foi possÇ§vel determinar sua empresa.");return}if(!r.cliente_id){f("Selecione o cliente responsÂvel.");return}if(!r.origem||!r.destino||!r.data_inicio){f("Origem, destino e data de inÃ­cio sÇőo obrigatÃ³rios.");return}let a=null;try{O(!0),f(null);const s=r.origem.trim(),t=r.destino.trim(),{data:n,error:d}=await l.from("orcamentos").insert({cliente_id:r.cliente_id,status:"novo",data_viagem:r.data_inicio,notas:`Viagem criada via Operacao: ${s} -> ${t}`}).select("id").single();if(d)throw d;if(a=n?.id||null,!a)throw new Error("Nao foi possivel vincular um orcamento.");const x={company_id:h,responsavel_user_id:A,cliente_id:r.cliente_id,origem:s,destino:t,data_inicio:r.data_inicio,data_fim:r.data_fim||null,status:r.status,orcamento_id:a},{error:o}=await l.from("viagens").insert(x);if(o)throw o;u({origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada",cliente_id:""}),F(!1),N()}catch(s){if(console.error(s),a){const{error:n}=await l.from("orcamentos").delete().eq("id",a);n&&console.warn("Nao foi possivel remover o orcamento temporario:",n)}const t=s&&typeof s=="object"&&s!==null&&"message"in s&&typeof s.message=="string"?s.message:null;f(t||"Erro ao criar viagem.")}finally{O(!1)}}const W=i.useMemo(()=>[...E].sort((a,s)=>{const t=a.data_inicio||"",n=s.data_inicio||"";return t===n?0:t?n?t<n?-1:1:-1:1}),[E]);return y?e.jsx(oe,{}):G?e.jsx("div",{className:"card-base card-purple",children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[w&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{style:{fontWeight:600},children:"Viagens"}),e.jsx("button",{className:"btn btn-primary",type:"button",onClick:()=>F(a=>!a),children:$?"Cancelar":"Nova viagem"})]}),$&&e.jsxs("div",{className:"card-base card-blue",style:{padding:16},children:[e.jsx("datalist",{id:"cidades-list",children:Y.map(a=>e.jsx("option",{value:a.nome,label:te(a)},`${a.nome}-${a.subdivisao_nome||""}-${a.pais_nome||""}`))}),se&&e.jsx("small",{style:{color:"#6366f1"},children:"Buscando cidades..."}),U&&e.jsx("small",{style:{color:"red"},children:U}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsxs("select",{className:"form-select",value:r.cliente_id,onChange:a=>u(s=>({...s,cliente_id:a.target.value})),children:[e.jsx("option",{value:"",children:"Selecione um cliente"}),ee.map(a=>e.jsxs("option",{value:a.id,children:[a.nome,a.cpf?` (${a.cpf})`:""]},a.id))]}),T&&e.jsx("small",{style:{color:"red"},children:T})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Origem"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:r.origem,onChange:a=>{const s=a.target.value;u(t=>({...t,origem:s})),Q(s)},placeholder:"Cidade de origem"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:r.destino,onChange:a=>{const s=a.target.value;u(t=>({...t,destino:s})),Q(s)},placeholder:"Cidade de destino"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:r.data_inicio,onChange:a=>u(s=>({...s,data_inicio:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:r.data_fim,onChange:a=>u(s=>({...s,data_fim:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:r.status,onChange:a=>u(s=>({...s,status:a.target.value})),children:[e.jsx("option",{value:"planejada",children:"Planejada"}),e.jsx("option",{value:"confirmada",children:"Confirmada"}),e.jsx("option",{value:"em_viagem",children:"Em viagem"}),e.jsx("option",{value:"concluida",children:"Concluída"}),e.jsx("option",{value:"cancelada",children:"Cancelada"})]})]}),e.jsx("div",{className:"form-group",style:{alignSelf:"flex-end"},children:e.jsx("button",{className:"btn btn-primary",type:"button",onClick:ie,disabled:q,children:q?"Salvando...":"Criar viagem"})})]}),L&&e.jsx("div",{style:{color:"red"},children:L})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsx("select",{className:"form-select",value:j,onChange:a=>H(a.target.value),children:le.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início a partir de"}),e.jsx("input",{type:"date",className:"form-input",value:v,onChange:a=>J(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início até"}),e.jsx("input",{type:"date",className:"form-input",value:b,onChange:a=>K(a.target.value)})]}),e.jsx("div",{className:"form-group",style:{alignSelf:"flex-end"},children:e.jsx("button",{className:"btn btn-light",type:"button",onClick:N,disabled:_,children:_?"Atualizando...":"Atualizar"})})]}),V&&e.jsx("div",{style:{color:"red"},children:V}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Início"}),e.jsx("th",{children:"Fim"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Origem"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Responsável"}),e.jsx("th",{children:"Ver"})]})}),e.jsxs("tbody",{children:[_&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando viagens..."})}),!_&&W.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma viagem encontrada."})}),W.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_inicio?new Date(a.data_inicio).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.data_fim?new Date(a.data_fim).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.status||"-"}),e.jsx("td",{children:a.origem||"-"}),e.jsx("td",{children:a.destino||"-"}),e.jsx("td",{children:a.clientes?.nome||"-"}),e.jsx("td",{children:a.responsavel_user_id||"-"}),e.jsx("td",{children:e.jsx("a",{className:"btn btn-light",href:`/operacao/viagens/${a.id}`,children:"Abrir"})})]},a.id))]})]})})]})}):e.jsx("div",{children:"Você não possui acesso ao módulo de Operação/Viagens."})}export{he as default};
