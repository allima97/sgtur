import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as d}from"./supabase.Ng8nq9tn.js";import{r as E}from"./logs.DwCrXgEk.js";import{u as R}from"./usePermissao.DiLe8-Rs.js";import{L as V}from"./LoadingUsuarioContext.BaDUNi7o.js";const f=["Dashboard","Clientes","Vendas","Orcamentos","Operacao","Viagens","Comissionamento","Cadastros","Paises","Cidades","Destinos","Produtos","Relatorios","Parametros","Metas","RegrasComissao","Admin","AdminDashboard","AdminLogs","AdminUsers"],F=[{value:"none",label:"Nenhum"},{value:"view",label:"Ver"},{value:"create",label:"Criar"},{value:"edit",label:"Editar"},{value:"delete",label:"Excluir"},{value:"admin",label:"Admin"}];function Q(){const{permissao:y,ativo:L,loading:P}=R("Admin"),[m,D]=r.useState(null),[c,I]=r.useState([]),[v,U]=r.useState([]),[u,q]=r.useState(""),[t,j]=r.useState(null),[h,p]=r.useState({}),[b,g]=r.useState(!1),[N,l]=r.useState(null),[M,w]=r.useState(!0),_=y==="admin";r.useEffect(()=>{x()},[]);async function x(){try{w(!0),l(null);const{data:s}=await d.auth.getUser(),a=s?.user?.id||null;D(a);const{data:o,error:i}=await d.from("users").select("id, nome_completo, email, active").order("nome_completo",{ascending:!0});if(i)throw i;I(o||[]);const{data:n,error:C}=await d.from("modulo_acesso").select("*");if(C)throw C;U(n||[])}catch(s){console.error(s),l("Erro ao carregar permiss√µes.")}finally{w(!1)}}const A=r.useMemo(()=>{if(!u.trim())return c;const s=u.toLowerCase();return c.filter(a=>a.nome_completo.toLowerCase().includes(s)||(a.email||"").toLowerCase().includes(s))},[c,u]);function S(s){j(s);const a={};for(const o of f){const i=v.find(n=>n.usuario_id===s.id&&n.modulo===o);a[o]=i?i.permissao:"none"}p(a)}function k(s,a){p(o=>({...o,[s]:a}))}async function B(){if(t){if(!_){l("Somente ADMIN pode alterar permiss√µes.");return}try{g(!0),l(null);for(const a of f){const o=h[a]||"none",i=v.find(n=>n.usuario_id===t.id&&n.modulo===a);i?await d.from("modulo_acesso").update({permissao:o,ativo:o!=="none"}).eq("id",i.id):await d.from("modulo_acesso").insert({usuario_id:t.id,modulo:a,permissao:o,ativo:o!=="none"})}await E({user_id:m,acao:"permissoes_atualizadas",modulo:"Admin",detalhes:{usuario_alterado_id:t.id,permissoes:h}}),await x();const s=c.find(a=>a.id===t.id)||null;s&&S(s)}catch(s){console.error(s),l("Erro ao salvar permiss√µes.")}finally{g(!1)}}}async function O(s){try{const a=!s.active,{error:o}=await d.from("users").update({active:a}).eq("id",s.id);if(o)throw o;await E({user_id:m,acao:a?"usuario_ativado":"usuario_bloqueado",modulo:"Admin",detalhes:{usuario_alterado_id:s.id}}),await x()}catch(a){console.error(a),l("Erro ao alterar status do usu√°rio.")}}return P?e.jsx(V,{}):L?_?M?e.jsx("div",{children:"Carregando dados de permiss√µes..."}):e.jsxs("div",{className:"admin-permissoes-page",children:[e.jsxs("div",{className:"card-base card-blue mb-3",children:[e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar usu√°rio"}),e.jsx("input",{className:"form-input",value:u,onChange:s=>q(s.target.value),placeholder:"Nome ou e-mail..."})]})}),N&&e.jsx("div",{className:"card-base card-config mt-2",children:e.jsx("strong",{children:N})})]}),e.jsx("div",{className:"table-container mb-3 overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[780px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{children:"Status"}),e.jsx("th",{className:"th-actions",children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum usu√°rio encontrado."})}),A.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nome_completo}),e.jsx("td",{children:s.email||"-"}),e.jsx("td",{children:s.active?"Ativo":"Bloqueado"}),e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",title:"Editar permiss√µes",onClick:()=>S(s),children:"‚öôÔ∏è"}),m!==s.id&&e.jsx("button",{className:`btn-icon ${s.active?"btn-danger":""}`,title:s.active?"Bloquear usu√°rio":"Reativar usu√°rio",onClick:()=>O(s),children:s.active?"üö´":"‚úÖ"})]})]},s.id))]})]})}),t&&e.jsxs("div",{className:"card-base card-blue",children:[e.jsxs("h3",{children:["Permiss√µes de: ",e.jsx("span",{className:"font-semibold",children:t.nome_completo})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[500px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"M√≥dulo"}),e.jsx("th",{children:"N√≠vel"})]})}),e.jsx("tbody",{children:f.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s}),e.jsx("td",{children:e.jsx("select",{className:"form-select",value:h[s]||"none",onChange:a=>k(s,a.target.value),children:F.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})})]},s))})]})}),e.jsxs("div",{className:"mt-2 flex gap-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:B,disabled:b,children:b?"Salvando...":"Salvar permiss√µes"}),e.jsx("button",{className:"btn btn-light",onClick:()=>j(null),children:"Fechar"})]})]})]}):e.jsx("div",{children:"Somente usu√°rios ADMIN podem gerenciar permiss√µes."}):e.jsx("div",{children:"Acesso ao m√≥dulo de Admin bloqueado."})}export{Q as default};
