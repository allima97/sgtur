import{j as e,s as u}from"./supabase.CWKfsr2i.js";import{r}from"./index.DVhKKaGN.js";import{u as D}from"./usePermissao.LURrmXgT.js";function M(){const{ativo:g,loading:f}=D("AdminDashboard"),[v,b]=r.useState(!1),[h,y]=r.useState([]),[N,S]=r.useState([]),[L,x]=r.useState(!0),[B,j]=r.useState(null),[l,w]=r.useState(""),[i,C]=r.useState(""),[n,_]=r.useState(""),[d,A]=r.useState(""),[o,p]=r.useState(null);if(r.useEffect(()=>{async function s(){const{data:t}=await u.auth.getUser();if(!t?.user)return;const{data:a}=await u.from("users").select("id, user_types(name)").eq("id",t.user.id).maybeSingle(),c=a?.user_types?.name?.toUpperCase()||"";b(c.includes("ADMIN"))}s()},[]),f)return e.jsx("div",{children:"Carregando permissões..."});if(!g||!v)return e.jsx("div",{style:{padding:20},children:e.jsx("h3",{children:"Apenas administradores podem acessar os logs."})});r.useEffect(()=>{async function s(){try{x(!0),j(null);const{data:t,error:a}=await u.from("logs").select(`
            *,
            users:users (nome_completo)
          `).order("created_at",{ascending:!1});if(a)throw a;y(t||[]);const{data:c}=await u.from("users").select("id, nome_completo").order("nome_completo");S(c||[])}catch(t){console.error(t),j("Erro ao carregar logs.")}finally{x(!1)}}s()},[]);const m=r.useMemo(()=>{let s=h;if(l&&(s=s.filter(t=>t.user_id===l)),i&&(s=s.filter(t=>(t.modulo||"")===i)),n&&(s=s.filter(t=>t.acao===n)),d.trim()){const t=d.toLowerCase();s=s.filter(a=>(JSON.stringify(a).toLowerCase()+(a.users?.nome_completo||"").toLowerCase()).includes(t))}return s},[h,l,i,n,d]);return e.jsxs("div",{className:"logs-admin-page",children:[e.jsxs("div",{style:{marginBottom:16,padding:"12px 16px",background:"#4c0519",border:"1px solid #be123c",borderRadius:8,color:"#fecdd3"},children:[e.jsx("strong",{children:"Logs de Auditoria"})," — todas as ações do sistema"]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsx("h3",{style:{marginBottom:12},children:"Filtros"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Usuário"}),e.jsxs("select",{className:"form-select",value:l,onChange:s=>w(s.target.value),children:[e.jsx("option",{value:"",children:"Todos"}),N.map(s=>e.jsx("option",{value:s.id,children:s.nome_completo},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Módulo"}),e.jsxs("select",{className:"form-select",value:i,onChange:s=>C(s.target.value),children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"permissoes",children:"Permissões"}),e.jsx("option",{value:"vendas",children:"Vendas"}),e.jsx("option",{value:"clientes",children:"Clientes"}),e.jsx("option",{value:"cadastros",children:"Cadastros"}),e.jsx("option",{value:"login",children:"Login"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ação"}),e.jsxs("select",{className:"form-select",value:n,onChange:s=>_(s.target.value),children:[e.jsx("option",{value:"",children:"Todas"}),Array.from(new Set(h.map(s=>s.acao))).map(s=>e.jsx("option",{children:s},s))]})]})]}),e.jsx("div",{className:"form-row mt-2",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Busca livre"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Buscar em qualquer campo...",value:d,onChange:s=>A(s.target.value)})]})})]}),e.jsxs("div",{className:"card-base card-red",children:[e.jsxs("h3",{style:{marginBottom:12},children:["Registros (",m.length,")"]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-red min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{minWidth:150},children:"Data"}),e.jsx("th",{children:"Usuário"}),e.jsx("th",{children:"Ação"}),e.jsx("th",{children:"Módulo"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Ver"})]})}),e.jsxs("tbody",{children:[m.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum log encontrado."})}),m.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(s.created_at).toLocaleString("pt-BR")}),e.jsx("td",{children:s.users?.nome_completo||"Desconhecido"}),e.jsx("td",{children:s.acao}),e.jsx("td",{children:s.modulo||"-"}),e.jsx("td",{children:s.ip||"-"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-light",onClick:()=>p(s),children:"Ver"})})]},s.id))]})]})})]}),o&&e.jsx("div",{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:100},children:e.jsxs("div",{style:{width:"95%",maxWidth:700,maxHeight:"90vh",overflowY:"auto",background:"#1e293b",padding:18,borderRadius:10,color:"#e2e8f0"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:10},children:[e.jsx("h3",{children:"Detalhes do log"}),e.jsx("button",{className:"btn btn-light",onClick:()=>p(null),children:"Fechar"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Usuário:"})," ",o.users?.nome_completo]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ação:"})," ",o.acao]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Módulo:"})," ",o.modulo]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data:"})," ",new Date(o.created_at).toLocaleString("pt-BR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"IP:"})," ",o.ip||"-"]}),e.jsx("p",{style:{marginTop:12},children:e.jsx("strong",{children:"Detalhes:"})}),e.jsx("pre",{style:{background:"#0f172a",padding:10,borderRadius:6,whiteSpace:"pre-wrap",fontSize:12},children:JSON.stringify(o.detalhes,null,2)})]})})]})}export{M as default};
