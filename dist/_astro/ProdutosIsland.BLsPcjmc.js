import{s as c,j as a}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as Se}from"./usePermissao.72SYthuA.js";import{t as $}from"./titleCase.DQLlfrnh.js";function p(d){return(d||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const me={nome:"",destino:"",cidade_id:"",tipo_produto:"",global:!1,atracao_principal:"",melhor_epoca:"",duracao_sugerida:"",nivel_preco:"",imagem_url:"",informacoes_importantes:"",ativo:!0};function Be(){const{permissao:d,ativo:pe,loading:fe}=Se("Cadastros"),[U,he]=t.useState([]),[k,G]=t.useState([]),[_,H]=t.useState([]),[q,O]=t.useState([]),[W,ve]=t.useState([]),[o,D]=t.useState(me),[v,ge]=t.useState(""),[j,N]=t.useState(""),[be,h]=t.useState(!1),[Y,w]=t.useState([]),[A,J]=t.useState(!1),[I,K]=t.useState(!0),[Q,X]=t.useState(!1),[T,Z]=t.useState(null),[ee,ae]=t.useState(null),[L,u]=t.useState(null),[se,P]=t.useState(null),[C,xe]=t.useState(!1);async function B(e=!1){const s=[],i=[];K(!0),u(null);try{const[{data:r,error:l},{data:f,error:y},g,M]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("subdivisoes").select("id, nome, pais_id").order("nome"),c.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome").then(async m=>m.error?(i.push(`tipo_produtos: ${m.error.message}`),console.warn("Fallback tipo_produtos por 'tipo':",m.error),await c.from("tipo_produtos").select("id, nome, tipo").order("tipo")):m),c.from("produtos").select("id, nome, destino, cidade_id, tipo_produto, informacoes_importantes, atracao_principal, melhor_epoca, duracao_sugerida, nivel_preco, imagem_url, ativo, created_at").order(e?"nome":"created_at",{ascending:!!e}).limit(e?void 0:10)]);l?(s.push("paises"),l.message&&i.push(`paises: ${l.message}`)):he(r||[]);const de=f||[];if(y?(s.push("subdivisoes"),y.message&&i.push(`subdivisoes: ${y.message}`)):G(de),g.error)s.push("tipo_produtos"),g.error.message&&i.push(`tipo_produtos: ${g.error.message}`);else{const m=g.data||[];if(m.length===0){const{data:S,error:b}=await c.from("tipo_produtos").select("id, nome, tipo").order("nome");b?(s.push("tipo_produtos"),i.push(`tipo_produtos (fallback): ${b.message}`)):O(S||[])}else O(m)}if(M.error)s.push("produtos"),M.error.message&&i.push(`produtos: ${M.error.message}`);else{const m=M.data||[];ve(m),xe(e);const S=Array.from(new Set(m.map(b=>b.cidade_id).filter(Boolean)));if(S.length){const{data:b,error:R}=await c.from("cidades").select("id, nome, subdivisao_id, subdivisoes (id, nome, pais_id)").in("id",S);if(R)s.push("cidades"),R.message&&i.push(`cidades: ${R.message}`);else{const le=b||[];H(le);const ne=Array.from(new Set(le.map(F=>F.subdivisao_id).filter(Boolean)));if(ne.length){const F=new Set(de.map(x=>x.id)),ce=ne.filter(x=>!F.has(x));if(ce.length){const{data:x,error:V}=await c.from("subdivisoes").select("id, nome, pais_id").in("id",ce);V?(s.push("subdivisoes"),V.message&&i.push(`subdivisoes (faltantes): ${V.message}`)):x?.length&&G(ye=>{const ue=new Map(ye.map(E=>[E.id,E]));return x.forEach(E=>ue.set(E.id,E)),Array.from(ue.values())})}}}}else H([])}}catch(r){console.error(r),s.push("geral"),r?.message&&i.push(`geral: ${r.message}`)}finally{if(s.length){const r=i.length?` Detalhes: ${i.join(" | ")}`:"";u(`Erro ao carregar: ${s.join(", ")}. Verifique permissoes/RLS.${r}`)}K(!1)}}t.useEffect(()=>{B(!1)},[]),t.useEffect(()=>{v.trim()&&!C&&B(!0)},[v,C]);const oe=t.useMemo(()=>new Map(k.map(e=>[e.id,e])),[k]);function _e(e){const s=_.find(r=>r.id===e);if(!s)return"";const i=oe.get(s.subdivisao_id);return i?`${s.nome} (${i.nome})`:s.nome}function ie(e){return e&&((e.nome||"").trim()||e.tipo)||""}const z=t.useMemo(()=>{const e=new Map(_.map(r=>[r.id,r])),s=new Map(U.map(r=>[r.id,r])),i=new Map(q.map(r=>[r.id,r]));return W.map(r=>{const l=e.get(r.cidade_id||""),f=l?oe.get(l.subdivisao_id)||l.subdivisoes:void 0,y=f?s.get(f.pais_id):void 0,g=r.tipo_produto?i.get(r.tipo_produto):void 0;return{...r,cidade_nome:l?.nome||(r.cidade_id?"":"Todas as cidades"),subdivisao_nome:f?.nome||"",pais_nome:y?.nome||"",tipo_nome:ie(g)}})},[W,_,k,U,q]),re=t.useMemo(()=>{if(!v.trim())return z;const e=p(v);return z.filter(s=>p(s.nome).includes(e)||p(s.cidade_nome).includes(e)||p(s.subdivisao_nome).includes(e)||p(s.pais_nome).includes(e)||p(s.tipo_nome).includes(e)||p(s.destino||"").includes(e))},[v,z]);function n(e,s){D(i=>({...i,[e]:s}))}function je(e){N(e);const s=_.find(i=>i.id===o.cidade_id);(!s||!p(s.nome).includes(p(e)))&&D(i=>({...i,cidade_id:""})),h(!0)}function te(){D(me),Z(null),u(null),N(""),h(!1)}function Ne(e){const s=_.find(i=>i.id===e.cidade_id);Z(e.id),D({nome:e.nome,cidade_id:e.cidade_id,tipo_produto:e.tipo_produto||"",global:!e.cidade_id,atracao_principal:e.atracao_principal||"",melhor_epoca:e.melhor_epoca||"",duracao_sugerida:e.duracao_sugerida||"",nivel_preco:e.nivel_preco||"",imagem_url:e.imagem_url||"",informacoes_importantes:e.informacoes_importantes||"",ativo:e.ativo??!0,destino:e.destino||""}),N(e.cidade_id&&(_e(e.cidade_id)||s?.nome)||""),h(!1)}t.useEffect(()=>{if(j.trim().length<2){w([]);return}const e=new AbortController,s=setTimeout(async()=>{J(!0),P(null);try{const{data:i,error:r}=await c.rpc("buscar_cidades",{q:j.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(r){console.error("Erro ao buscar cidades:",r),P("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:l,error:f}=await c.from("cidades").select("id, nome, subdivisao_id").ilike("nome",`%${j.trim()}%`).order("nome");f?(console.error("Erro no fallback de cidades:",f),P("Erro ao buscar cidades.")):(w(l||[]),P(null))}else w(i||[])}finally{e.signal.aborted||J(!1)}},300);return()=>{e.abort(),clearTimeout(s)}},[j]);async function we(e){if(e.preventDefault(),d==="view"){u("Voce nao tem permissao para salvar produtos.");return}if(!o.nome.trim()){u("Nome e obrigatorio.");return}if(!o.destino.trim()){u("Destino e obrigatorio.");return}if(!o.global&&!o.cidade_id){u("Cidade e obrigatoria.");return}if(!o.tipo_produto){u("Tipo de produto e obrigatorio.");return}try{X(!0),u(null);const s=$(o.nome),i=$(o.destino),r={nome:s,destino:i,cidade_id:o.global?null:o.cidade_id,tipo_produto:o.tipo_produto,atracao_principal:o.atracao_principal.trim()||null,melhor_epoca:o.melhor_epoca.trim()||null,duracao_sugerida:o.duracao_sugerida.trim()||null,nivel_preco:o.nivel_preco.trim()||null,imagem_url:o.imagem_url.trim()||null,informacoes_importantes:o.informacoes_importantes.trim()||null,ativo:o.ativo};if(T){const{error:l}=await c.from("produtos").update(r).eq("id",T);if(l)throw l}else{const{error:l}=await c.from("produtos").insert(r);if(l)throw l}te(),await B(C)}catch(s){console.error(s),u("Erro ao salvar produto. Verifique os dados e tente novamente.")}finally{X(!1)}}async function Ce(e){if(d!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{ae(e),u(null);const{error:s}=await c.from("produtos").delete().eq("id",e);if(s)throw s;await B(C)}catch(s){console.error(s),u("Nao foi possivel excluir o produto. Verifique vinculos com vendas/orcamentos.")}finally{ae(null)}}return fe?a.jsx("div",{children:"Carregando permissoes..."}):pe?a.jsxs("div",{className:"destinos-page",children:[a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:we,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome do produto *"}),a.jsx("input",{className:"form-input",value:o.nome,onChange:e=>n("nome",e.target.value),onBlur:e=>n("nome",$(e.target.value)),placeholder:"Ex: Passeio em Gramado, Pacote Paris...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo *"}),a.jsxs("select",{className:"form-select",value:o.tipo_produto,onChange:e=>n("tipo_produto",e.target.value),disabled:d==="view",children:[a.jsx("option",{value:"",children:"Selecione o tipo"}),q.map(e=>a.jsx("option",{value:e.id,children:ie(e)||"(sem nome)"},e.id))]})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Destino *"}),a.jsx("input",{className:"form-input",value:o.destino,onChange:e=>n("destino",e.target.value),onBlur:e=>n("destino",$(e.target.value)),placeholder:"Ex: Disney, Porto de Galinhas",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Cidade *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:j,onChange:e=>je(e.target.value),onFocus:()=>h(!0),onBlur:()=>setTimeout(()=>h(!1),150),disabled:d==="view"||o.global,style:{marginBottom:6}}),A&&a.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),se&&!A&&a.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:se}),be&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb"},children:[Y.length===0&&!A&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),Y.map(e=>{const s=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return a.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:o.cidade_id===e.id?"#e0f2fe":"#fff",borderColor:o.cidade_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:i=>{i.preventDefault(),n("cidade_id",e.id),N(s),h(!1),w([])},children:[s,e.pais_nome?a.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["â€¢ ",e.pais_nome]}):null]},e.id)})]}),a.jsxs("div",{style:{marginTop:6},children:[a.jsxs("label",{style:{display:"flex",gap:8,alignItems:"center",fontSize:14,color:"#0f172a"},children:[a.jsx("input",{type:"checkbox",checked:o.global,onChange:e=>{const s=e.target.checked;n("global",s),s&&(n("cidade_id",""),N(""),w([]),h(!1))},disabled:d==="view"}),"Produto disponÃ­vel para todas as cidades"]}),a.jsx("small",{style:{color:"#475569"},children:"Marque para produtos comuns (ex.: seguro viagem, chip) que devem aparecer em qualquer destino."})]})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Atracao principal"}),a.jsx("input",{className:"form-input",value:o.atracao_principal,onChange:e=>n("atracao_principal",e.target.value),placeholder:"Ex: Disney, Torre Eiffel...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Melhor epoca"}),a.jsx("input",{className:"form-input",value:o.melhor_epoca,onChange:e=>n("melhor_epoca",e.target.value),placeholder:"Ex: Dezembro a Marco",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Duracao sugerida"}),a.jsxs("select",{className:"form-select",value:o.duracao_sugerida,onChange:e=>n("duracao_sugerida",e.target.value),disabled:d==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),a.jsx("option",{value:"De 1 a 3 dias",children:"De 1 a 3 dias"}),a.jsx("option",{value:"De 3 a 5 dias",children:"De 3 a 5 dias"}),a.jsx("option",{value:"De 5 a 7 dias",children:"De 5 a 7 dias"}),a.jsx("option",{value:"De 7 a 10 dias",children:"De 7 a 10 dias"}),a.jsx("option",{value:"10 dias ou mais",children:"10 dias ou mais"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nivel de preco"}),a.jsxs("select",{className:"form-select",value:o.nivel_preco,onChange:e=>n("nivel_preco",e.target.value),disabled:d==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),a.jsx("option",{value:"Economico",children:"Economico"}),a.jsx("option",{value:"Intermediario",children:"Intermediario"}),a.jsx("option",{value:"Premium",children:"Premium"}),a.jsx("option",{value:"Super Premium",children:"Super Premium"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Imagem (URL)"}),a.jsx("input",{className:"form-input",value:o.imagem_url,onChange:e=>n("imagem_url",e.target.value),placeholder:"URL de uma imagem do destino",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Informacoes importantes"}),a.jsx("textarea",{className:"form-input",rows:3,value:o.informacoes_importantes,onChange:e=>n("informacoes_importantes",e.target.value),placeholder:"Observacoes gerais, dicas, documentacao necessaria, etc.",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Ativo"}),a.jsxs("select",{className:"form-select",value:o.ativo?"true":"false",onChange:e=>n("ativo",e.target.value==="true"),disabled:d==="view",children:[a.jsx("option",{value:"true",children:"Sim"}),a.jsx("option",{value:"false",children:"Nao"})]})]}),a.jsxs("div",{className:"mt-2",children:[d!=="view"&&a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:Q,children:Q?"Salvando...":T?"Salvar alteracoes":"Adicionar produto"}),T&&d!=="view"&&a.jsx("button",{type:"button",className:"btn btn-light",style:{marginLeft:8},onClick:te,children:"Cancelar edicao"})]})]})}),a.jsx("div",{className:"card-base mb-3",children:a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Buscar produto"}),a.jsx("input",{className:"form-input",value:v,onChange:e=>ge(e.target.value),placeholder:"Busque por nome, tipo, destino, cidade, estado/provÃ­ncia ou paÃ­s"})]})})}),L&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:L})}),!C&&!L&&a.jsx("div",{className:"card-base card-config mb-3",children:"Ultimos Produtos Cadastrados (10). Digite na busca para consultar todos."}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1080px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Tipo"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Estado/ProvÃ­ncia"}),a.jsx("th",{children:"Pais"}),a.jsx("th",{children:"Nivel de preco"}),a.jsx("th",{children:"Ativo"}),a.jsx("th",{children:"Criado em"}),a.jsx("th",{className:"th-actions",children:"Acoes"})]})}),a.jsxs("tbody",{children:[I&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando produtos..."})}),!I&&re.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum produto encontrado."})}),!I&&re.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.tipo_nome||"-"}),a.jsx("td",{children:e.destino||"-"}),a.jsx("td",{children:e.cidade_nome||"-"}),a.jsx("td",{children:e.subdivisao_nome||"-"}),a.jsx("td",{children:e.pais_nome||"-"}),a.jsx("td",{children:e.nivel_preco||"-"}),a.jsx("td",{children:e.ativo?"Sim":"Nao"}),a.jsx("td",{children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-"}),a.jsxs("td",{className:"th-actions",children:[d!=="view"&&a.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>Ne(e),children:"âœï¸"}),(d==="admin"||d==="delete")&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>Ce(e.id),disabled:ee===e.id,children:ee===e.id?"...":"ğŸ—‘ï¸"})]})]},e.id))]})]})})]}):a.jsx("div",{children:"Voce nao possui acesso ao modulo de Cadastros."})}export{Be as default};
