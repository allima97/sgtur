import{j as e,s as f}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as P,w as _e}from"./xlsx.DrgRuPKf.js";function F(){return new Date().toISOString().substring(0,10)}function x(i){return(i||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function T(i,V){const m=new Date(i);return m.setDate(m.getDate()+V),m}function _(i){return i.toISOString().substring(0,10)}function ne(i){return new Date(i.getFullYear(),i.getMonth(),1)}function se(i){return new Date(i.getFullYear(),i.getMonth()+1,0)}function ye(i){return i.includes(";")||i.includes('"')||i.includes(`
`)?'"'+i.replace(/"/g,'""')+'"':i}function we(){const[i,V]=s.useState([]),[m,re]=s.useState([]),[w,ie]=s.useState([]),[D,$]=s.useState(""),[C,z]=s.useState(""),[E,U]=s.useState(""),[M,A]=s.useState(null),[R,Y]=s.useState(null),[y,H]=s.useState(null),[k,g]=s.useState(()=>{const o=T(new Date,-7);return _(o)}),[q,j]=s.useState(F()),[B,le]=s.useState("todos"),[W,ce]=s.useState(""),[G,de]=s.useState(""),[J,ue]=s.useState([]),[L,K]=s.useState(!1),[Q,S]=s.useState(null),[h,me]=s.useState(null),[pe,X]=s.useState(!0),[N,he]=s.useState({pdf:!0,excel:!0});s.useEffect(()=>{async function t(){try{X(!0),S(null);const{data:o}=await f.auth.getUser(),a=o?.user?.id;if(!a){S("Usuário não autenticado.");return}const{data:n}=await f.from("users").select("id, user_types(name), company_id").eq("id",a).maybeSingle(),r=n?.user_types?.name||o?.user?.user_metadata?.name||"",d=String(r||"").toUpperCase();let l="VENDEDOR";d.includes("ADMIN")?l="ADMIN":d.includes("GESTOR")?l="GESTOR":d.includes("VENDEDOR")?l="VENDEDOR":l="OUTRO";let p=[a];if(l==="GESTOR"){const{data:b}=await f.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a),be=b?.map(O=>O.vendedor_id).filter(O=>!!O)||[];p=Array.from(new Set([a,...be]))}else l==="ADMIN"&&(p=[]);const c=n?.company_id||null;if(c){const{data:b}=await f.from("parametros_comissao").select("exportacao_pdf, exportacao_excel").eq("company_id",c).maybeSingle();b&&he({pdf:b.exportacao_pdf??!0,excel:b.exportacao_excel??!0})}me({usuarioId:a,papel:l,vendedorIds:p})}catch(o){console.error(o),S("Erro ao carregar contexto do usuário.")}finally{X(!1)}}t()},[]),s.useEffect(()=>{async function t(){try{const[{data:o,error:a},{data:n,error:r},{data:d,error:l}]=await Promise.all([f.from("clientes").select("id, nome, cpf").order("nome",{ascending:!0}),f.from("produtos").select("id, nome").order("nome",{ascending:!0}),f.from("tipo_produtos").select("id, nome, tipo").order("nome",{ascending:!0})]);if(a)throw a;if(r)throw r;if(l)throw l;V(o||[]),re(n||[]),ie(d||[])}catch(o){console.error(o),S("Erro ao carregar bases de clientes, destinos e produtos. Verifique o Supabase.")}}t()},[]);const Z=s.useMemo(()=>{if(!D.trim())return i;const t=x(D);return i.filter(o=>{const a=o.cpf||"";return x(o.nome).includes(t)||x(a).includes(t)})},[i,D]),ee=s.useMemo(()=>{if(!C.trim())return m;const t=x(C);return m.filter(o=>x(o.nome).includes(t))},[m,C]),te=s.useMemo(()=>{if(!E.trim())return w;const t=x(E);return w.filter(o=>{const a=x(o.nome||""),n=x(o.tipo||"");return a.includes(t)||n.includes(t)})},[w,E]),u=s.useMemo(()=>{const t=new Map(i.map(n=>[n.id,n])),o=new Map(m.map(n=>[n.id,n])),a=new Map(w.map(n=>[n.id,n]));return J.map(n=>{const r=t.get(n.cliente_id),d=o.get(n.destino_id),l=n.produto_id?a.get(n.produto_id):void 0;return{...n,cliente_nome:r?.nome||"(sem cliente)",cliente_cpf:r?.cpf||"",destino_nome:d?.nome||"(sem destino)",produto_nome:l?.nome||l?.tipo||"(sem produto)"}})},[J,i,m,w]),I=u.length,ae=u.reduce((t,o)=>{const a=o.valor_total??0;return t+a},0),fe=I>0?ae/I:0;async function oe(){if(h)try{K(!0),S(null);let t=f.from("vendas").select("id, vendedor_id, numero_venda, cliente_id, destino_id, produto_id, data_lancamento, data_embarque, valor_total, status").order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(t=t.in("vendedor_id",h.vendedorIds)),k&&(t=t.gte("data_lancamento",k)),q&&(t=t.lte("data_lancamento",q)),B!=="todos"&&(t=t.eq("status",B)),M&&(t=t.eq("cliente_id",M.id)),R&&(t=t.eq("destino_id",R.id)),y&&(t=t.eq("produto_id",y.id));const o=parseFloat(W.replace(",","."));isNaN(o)||(t=t.gte("valor_total",o));const a=parseFloat(G.replace(",","."));isNaN(a)||(t=t.lte("valor_total",a));const{data:n,error:r}=await t;if(r)throw r;ue(n||[])}catch(t){console.error(t),S("Erro ao carregar vendas para o relatório. Confira o schema e filtros.")}finally{K(!1)}}s.useEffect(()=>{h&&oe()},[h]);function v(t){const o=new Date;if(t==="limpar"){g(""),j("");return}if(t==="hoje"){const a=F();g(a),j(a);return}if(t==="7"){const a=T(o,-7);g(_(a)),j(F());return}if(t==="30"){const a=T(o,-30);g(_(a)),j(F());return}if(t==="mes_atual"){const a=ne(o),n=se(o);g(_(a)),j(_(n));return}if(t==="mes_anterior"){const a=new Date(o.getFullYear(),o.getMonth()-1,1),n=ne(a),r=se(a);g(_(n)),j(_(r));return}}function xe(){if(u.length===0){alert("Não há dados para exportar.");return}const t=["numero_venda","cliente","cpf","destino","produto","data_lancamento","data_embarque","status","valor_total"],o=u.map(c=>[c.numero_venda||"",c.cliente_nome,c.cliente_cpf||"",c.destino_nome,c.produto_nome,c.data_lancamento||"",c.data_embarque||"",c.status||"",(c.valor_total??0).toString().replace(".",",")]),a=[t,...o].map(c=>c.map(b=>ye(b)).join(";")).join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),d=new Date,l=`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}-${String(d.getHours()).padStart(2,"0")}${String(d.getMinutes()).padStart(2,"0")}`,p=document.createElement("a");p.href=r,p.setAttribute("download",`relatorio-vendas-${l}.csv`),document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(r)}function ge(){if(!N.excel){alert("Exportação Excel desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=u.map(r=>({"Nº Venda":r.numero_venda||r.id,Cliente:r.cliente_nome,CPF:r.cliente_cpf,Destino:r.destino_nome,Produto:r.produto_nome,"Data lançamento":r.data_lancamento?.slice(0,10)||"","Data embarque":r.data_embarque?.slice(0,10)||"",Status:r.status||"","Valor total":r.valor_total??0})),o=P.json_to_sheet(t),a=P.book_new();P.book_append_sheet(a,o,"Vendas");const n=new Date().toISOString().replace(/[-:T]/g,"").slice(0,12);_e(a,`relatorio-vendas-${n}.xlsx`)}function je(){if(!N.pdf){alert("Exportação PDF desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=window.open("","_blank");if(!t){alert("Não foi possível abrir a janela de exportação.");return}const o=u.map(a=>`
        <tr>
          <td>${a.numero_venda||a.id}</td>
          <td>${a.cliente_nome||""}</td>
          <td>${a.destino_nome||""}</td>
          <td>${a.produto_nome||""}</td>
          <td>${a.data_lancamento?.slice(0,10)||""}</td>
          <td>${a.status||""}</td>
          <td>${(a.valor_total??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
        </tr>`).join("");t.document.write(`
      <html>
        <head>
          <title>Relatório de Vendas</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 16px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
            th { background: #f1f5f9; }
          </style>
        </head>
        <body>
          <h3>Relatório de Vendas</h3>
          <table>
            <thead>
              <tr>
                <th>Nº Venda</th>
                <th>Cliente</th>
                <th>Destino</th>
                <th>Produto</th>
                <th>Lançamento</th>
                <th>Status</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>${o}</tbody>
          </table>
          <script>window.print();<\/script>
        </body>
      </html>
    `),t.document.close()}return e.jsxs("div",{className:"relatorio-vendas-page",children:[pe&&e.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),h&&h.papel!=="ADMIN"&&e.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",h.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:k,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:q,onChange:t=>j(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:B,onChange:t=>le(t.target.value),children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"aberto",children:"Aberto"}),e.jsx("option",{value:"confirmado",children:"Confirmado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor mínimo"}),e.jsx("input",{className:"form-input",value:W,onChange:t=>ce(t.target.value),placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor máximo"}),e.jsx("input",{className:"form-input",value:G,onChange:t=>de(t.target.value),placeholder:"0,00"})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:8},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsx("input",{className:"form-input",value:D,onChange:t=>{$(t.target.value),A(null)},placeholder:"Nome ou CPF..."}),D&&!M&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[Z.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum cliente encontrado."}),Z.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{A(t),$(t.nome)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.cpf||"Sem CPF"})]},t.id))]}),M&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:M.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",value:C,onChange:t=>{z(t.target.value),Y(null)},placeholder:"Nome do destino..."}),C&&!R&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[ee.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum destino encontrado."}),ee.map(t=>e.jsx("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{Y(t),z(t.nome)},children:e.jsx("div",{style:{fontWeight:600},children:t.nome})},t.id))]}),R&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:R.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Produto"}),e.jsx("input",{className:"form-input",value:E,onChange:t=>{U(t.target.value),H(null)},placeholder:"Nome ou tipo..."}),E&&!y&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[te.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum produto encontrado."}),te.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{H(t),U(t.nome||t.tipo)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome||"(sem nome)"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.tipo})]},t.id))]}),y&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado:"," ",e.jsx("strong",{children:y.nome||y.tipo})]})]})]}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("hoje"),children:"Hoje"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("7"),children:"Últimos 7 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("30"),children:"Últimos 30 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_atual"),children:"Este mês"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_anterior"),children:"Mês anterior"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("limpar"),children:"Limpar datas"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:oe,children:"Aplicar filtros"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-purple",onClick:xe,children:"Exportar CSV"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:ge,disabled:!N.excel,title:N.excel?"":"Exportação Excel desabilitada nos parâmetros",children:"Exportar Excel"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:je,disabled:!N.pdf,title:N.pdf?"":"Exportação PDF desabilitada nos parâmetros",children:"Exportar PDF"})]})]})]}),Q&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:Q})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:[e.jsx("strong",{children:I})," venda(s) encontrada(s)"]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Faturamento:"," ",e.jsx("strong",{children:ae.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Ticket médio:"," ",e.jsx("strong",{children:fe.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-purple min-w-[1000px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nº Venda"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Data lançamento"}),e.jsx("th",{children:"Data embarque"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Valor total"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Carregando vendas..."})}),!L&&u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Nenhuma venda encontrada com os filtros atuais."})}),!L&&u.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.numero_venda||"-"}),e.jsx("td",{children:t.cliente_nome}),e.jsx("td",{children:t.cliente_cpf}),e.jsx("td",{children:t.destino_nome}),e.jsx("td",{children:t.produto_nome}),e.jsx("td",{children:t.data_lancamento?new Date(t.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.data_embarque?new Date(t.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.status||"-"}),e.jsx("td",{children:t.valor_total!=null?t.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"-"})]},t.id))]})]})})]})}export{we as default};
