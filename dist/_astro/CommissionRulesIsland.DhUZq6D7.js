import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as d}from"./index.C0Fn7Wtz.js";import{s as c}from"./supabase.Ng8nq9tn.js";import{u as F}from"./usePermissao.Bkt8qSjs.js";import{r as P}from"./logs.DwCrXgEk.js";const g={id:"",nome:"",descricao:"",tipo:"GERAL",meta_nao_atingida:0,meta_atingida:0,super_meta:0,ativo:!0,tiers:[]};function B(){const{permissao:N,ativo:R}=F("Parametros"),r=N==="admin"||N==="edit",[v,O]=d.useState([]),[_,E]=d.useState(!0),[y,m]=d.useState(null),[i,u]=d.useState(g),[C,S]=d.useState(!1),[p,j]=d.useState(null),[w,x]=d.useState(null);d.useEffect(()=>{f()},[]);async function f(){try{E(!0),m(null);const{data:a,error:t}=await c.from("commission_rule").select("*, commission_tier(*)").order("created_at",{ascending:!1});if(t)throw t;O(a||[])}catch(a){console.error(a),m("Erro ao carregar regras de comissÃ£o.")}finally{E(!1)}}function h(a,t){u(s=>({...s,[a]:t}))}function A(a){u(t=>({...t,tiers:[...t.tiers||[],{faixa:a,de_pct:0,ate_pct:0,inc_pct_meta:0,inc_pct_comissao:0}]}))}function b(a,t,s){u(o=>{const n=[...o.tiers||[]];return n[a][t]=s,{...o,tiers:n}})}function I(a){u(t=>({...t,tiers:(t.tiers||[]).filter((s,o)=>o!==a)}))}async function T(a){if(a.preventDefault(),!!r){if(x(null),!i.nome.trim()){m("Informe o nome da regra.");return}if(i.tipo==="ESCALONAVEL"){if(!i.tiers||i.tiers.length===0){x("Adicione pelo menos uma faixa PRE ou POS.");return}for(const s of i.tiers)if(s.de_pct>s.ate_pct){x("Em uma faixa, o valor inicial nÃ£o pode ser maior que o final.");return}const t=["PRE","POS"];for(const s of t){const o=(i.tiers||[]).filter(n=>n.faixa===s).sort((n,l)=>n.de_pct-l.de_pct);for(let n=1;n<o.length;n++){const l=o[n-1],L=o[n];if(l.ate_pct>L.de_pct){x(`Faixas ${s} sobrepostas: finalize a faixa anterior em ${l.ate_pct}% antes de iniciar ${L.de_pct}%.`);return}}}}try{S(!0),m(null);const t={nome:i.nome.trim(),descricao:i.descricao||null,tipo:i.tipo,meta_nao_atingida:i.meta_nao_atingida??0,meta_atingida:i.meta_atingida??0,super_meta:i.super_meta??0,ativo:i.ativo};let s=p;if(p){const{error:o}=await c.from("commission_rule").update(t).eq("id",p);if(o)throw o;s=p}else{const{data:o,error:n}=await c.from("commission_rule").insert(t).select("id").single();if(n)throw n;s=o?.id}if(s&&(await c.from("commission_tier").delete().eq("rule_id",s),i.tiers&&i.tiers.length>0)){const o=i.tiers.map(l=>({rule_id:s,faixa:l.faixa,de_pct:Number(l.de_pct)||0,ate_pct:Number(l.ate_pct)||0,inc_pct_meta:Number(l.inc_pct_meta)||0,inc_pct_comissao:Number(l.inc_pct_comissao)||0,ativo:!0})),{error:n}=await c.from("commission_tier").insert(o);if(n)throw n}await P({user_id:(await c.auth.getUser()).data.user?.id||null,acao:p?"commission_rule_editada":"commission_rule_criada",modulo:"Parametros",detalhes:t}),u(g),j(null),await f()}catch(t){console.error(t),m("Erro ao salvar regra.")}finally{S(!1)}}}async function V(a){if(!r||!confirm("Inativar esta regra?"))return;const{error:t}=await c.from("commission_rule").update({ativo:!1}).eq("id",a);t||f()}async function k(a){if(!r||!confirm("Excluir permanentemente esta regra?"))return;const{error:t}=await c.from("commission_tier").delete().eq("rule_id",a);if(t){m("Erro ao excluir faixas da regra.");return}const{error:s}=await c.from("commission_rule").delete().eq("id",a);if(s){m("Erro ao excluir regra.");return}await P({user_id:(await c.auth.getUser()).data.user?.id||null,acao:"commission_rule_excluida",modulo:"Parametros",detalhes:{id:a}}),f()}function q(a){j(a.id),u({id:a.id,nome:a.nome,descricao:a.descricao||"",tipo:a.tipo,meta_nao_atingida:a.meta_nao_atingida??0,meta_atingida:a.meta_atingida??0,super_meta:a.super_meta??0,ativo:a.ativo,tiers:a.tipo==="ESCALONAVEL"?a.commission_tier?.map(t=>({faixa:t.faixa,de_pct:t.de_pct,ate_pct:t.ate_pct,inc_pct_meta:t.inc_pct_meta,inc_pct_comissao:t.inc_pct_comissao}))||[]:[]})}return R?e.jsxs("div",{className:"card-base card-blue",children:[e.jsx("h3",{style:{marginBottom:6},children:"Regras de Comissionamento"}),e.jsx("p",{style:{marginTop:0,marginBottom:12,color:"#475569",fontSize:"0.9rem"},children:"Configure regras gerais ou escalonadas usadas em produtos e metas."}),y&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:y})}),w&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:w})}),e.jsxs("form",{onSubmit:T,children:[e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:i.nome,onChange:a=>h("nome",a.target.value),required:!0,disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:i.tipo,onChange:a=>h("tipo",a.target.value==="ESCALONAVEL"?"ESCALONAVEL":"GERAL"),disabled:!r,children:[e.jsx("option",{value:"GERAL",children:"Geral (percentuais fixos)"}),e.jsx("option",{value:"ESCALONAVEL",children:"EscalonÃ¡vel (faixas)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta nÃ£o atingida (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.meta_nao_atingida,onChange:a=>h("meta_nao_atingida",Number(a.target.value)),disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta atingida (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.meta_atingida,onChange:a=>h("meta_atingida",Number(a.target.value)),disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Super meta (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.super_meta,onChange:a=>h("super_meta",Number(a.target.value)),disabled:!r})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DescriÃ§Ã£o"}),e.jsx("textarea",{className:"form-input",rows:2,value:i.descricao||"",onChange:a=>h("descricao",a.target.value),disabled:!r})]}),i.tipo==="ESCALONAVEL"&&e.jsxs("div",{className:"card-base card-purple mb-2",style:{marginTop:12},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h4",{style:{margin:0},children:"Faixas (PRE/POS)"}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>A("PRE"),disabled:!r,children:"+ Faixa PRE"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>A("POS"),disabled:!r,children:"+ Faixa POS"})]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[800px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Faixa"}),e.jsx("th",{children:"De (%)"}),e.jsx("th",{children:"AtÃ© (%)"}),e.jsx("th",{children:"Inc. Meta (%)"}),e.jsx("th",{children:"Inc. ComissÃ£o (%)"}),e.jsx("th",{children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[(!i.tiers||i.tiers.length===0)&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhuma faixa adicionada."})}),i.tiers?.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.faixa}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.de_pct,onChange:s=>b(t,"de_pct",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.ate_pct,onChange:s=>b(t,"ate_pct",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.inc_pct_meta,onChange:s=>b(t,"inc_pct_meta",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.inc_pct_comissao,onChange:s=>b(t,"inc_pct_comissao",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn-icon btn-danger",onClick:()=>I(t),disabled:!r,children:"ğŸ—‘ï¸"})})]},t))]})]})})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mt-2",children:[e.jsx("button",{className:"btn btn-primary",type:"submit",disabled:!r||C,children:C?"Salvando...":p?"Atualizar regra":"Criar regra"}),p&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>{u(g),j(null)},children:"Cancelar ediÃ§Ã£o"})]})]}),e.jsxs("div",{className:"card-base card-blue mt-4",children:[e.jsx("h4",{className:"mb-2",children:"Regras cadastradas"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[900px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Faixas"}),e.jsx("th",{children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[_&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!_&&v.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma regra cadastrada."})}),!_&&v.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.tipo}),e.jsx("td",{children:a.ativo?"Sim":"NÃ£o"}),e.jsx("td",{children:a.commission_tier?.length||0}),e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",onClick:()=>q(a),title:"Editar",children:"âœï¸"}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>V(a.id),disabled:!r,title:"Inativar",children:"â¸ï¸"}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>k(a.id),disabled:!r,title:"Excluir",children:"ğŸ—‘ï¸"})]})]},a.id))]})]})})]})]}):e.jsx("div",{className:"card-base card-config",children:"Acesso negado ao mÃ³dulo de ParÃ¢metros."})}export{B as default};
