import{s as x,j as a}from"./supabase.DNkd6bxA.js";import{r as n}from"./index.C0Fn7Wtz.js";import{u as ca}from"./usePermissao.72SYthuA.js";const da=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function G(u,l){const s=new Date(u);return s.setMonth(s.getMonth()+l),s}function Q(u){return u.toISOString().slice(0,10)}function A(u){const l=new Date;let s;switch(u){case"mes_anterior":{s=new Date(l.getFullYear(),l.getMonth()-1,1);break}case"trim":s=G(l,-3);break;case"sem":s=G(l,-6);break;case"ano":s=G(l,-12);break;case"mes_atual":default:s=new Date(l.getFullYear(),l.getMonth(),1);break}return{inicio:Q(s),fim:Q(l)}}function pa(){const{ativo:u,loading:l}=ca("Vendas"),s=import.meta?.env?.PUBLIC_META_PRODUTO_ENABLED!=="false",[X,Z]=n.useState(null),[E,$]=n.useState(null),[P,aa]=n.useState(null),[V,ea]=n.useState([]),[F,ta]=n.useState({}),[O,sa]=n.useState({}),[N,oa]=n.useState({}),[U,ra]=n.useState([]),[z,W]=n.useState(!0),[Y,T]=n.useState(null),[M,ia]=n.useState("mes_atual"),[H,na]=n.useState(()=>A("mes_atual"));n.useEffect(()=>{l||!u||la()},[l,u,M]),n.useEffect(()=>{na(A(M))},[M]);async function la(){try{W(!0),T(null);const{data:o}=await x.auth.getUser(),p=o?.user?.id||null;if(!p){T("Usuário não autenticado.");return}Z({id:p,nome:o?.user?.email||""});const g=A(M),{data:v}=await x.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:h}=await x.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",p).eq("periodo",g.inicio.slice(0,7)+"-01").maybeSingle(),[k,S,j,b,D]=await Promise.all([x.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",h?.id||""),x.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta"),x.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta"),x.from("tipo_produtos").select("id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral"),x.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",g.inicio).lte("data_lancamento",g.fim)]),C=k.data,R=S.data,y=j.data,w=b.data,B=D.data,t={};(R||[]).forEach(e=>{t[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta}});const r={};(y||[]).forEach(e=>{r[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const c={};(w||[]).forEach(e=>{c[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta}}),$(v?{usar_taxas_na_meta:!!v.usar_taxas_na_meta,foco_valor:v.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),aa(h),ea(C||[]),ta(t),sa(r),oa(c),ra(B||[])}catch(o){console.error(o),T("Erro ao carregar dados de comissionamento.")}finally{W(!1)}}const d=n.useMemo(()=>{if(!E)return null;const o={};V.forEach(t=>{o[t.produto_id]=t.valor});const p={},g={},v={};let h=0,k=0,S=0,j=0,b=0;const D={},C=[];let R=0;const y={};Object.values(N).forEach(t=>{t.regra_comissionamento==="diferenciado"&&(C.push(t.id),D[t.id]=0),t.usa_meta_produto&&(y[t.id]=0)}),U.forEach(t=>{(t.vendas_recibos||[]).forEach(r=>{const c=r.tipo_produtos?.id||r.produto_id||"",e=N[c];if(!e)return;const i=Number(r.valor_total||0),m=Number(r.valor_taxas||0),f=i-m,L=E.usar_taxas_na_meta?i:f;g[c]=(g[c]||0)+i,v[c]=(v[c]||0)+f,p[c]=(p[c]||0)+L,e.soma_na_meta&&(h+=L),k+=i,S+=m})});const w=k-S,B=P?.meta_geral&&P.meta_geral>0?h/P.meta_geral*100:0;return Object.keys(g).forEach(t=>{const r=N[t];if(!r)return;const c=E.foco_valor==="liquido"?v[t]||0:g[t]||0;if(r.regra_comissionamento==="diferenciado"){const e=O[t];if(!e)return;const i=o[t]||0,m=p[t]||0,f=i>0,L=f?m/i*100:0,I=f?m<i?0:L>=120?e.fix_super_meta??e.fix_meta_atingida??e.fix_meta_nao_atingida??0:e.fix_meta_atingida??e.fix_meta_nao_atingida??0:e.fix_meta_nao_atingida??e.fix_meta_atingida??e.fix_super_meta??0,q=c*(I/100);b+=q,D[t]=q}else{const e=O[t]?.rule_id,i=e?F[e]:void 0;let m=0;i&&(B<100?m=i.meta_nao_atingida||0:B>=120?m=i.super_meta??i.meta_atingida??i.meta_nao_atingida??0:m=i.meta_atingida??i.meta_nao_atingida??0);const f=c*(m/100);if(j+=f,s&&r.usa_meta_produto&&r.meta_produto_valor&&r.comissao_produto_meta_pct&&(p[t]||0)/r.meta_produto_valor*100>=100){const J=c*((r.comissao_produto_meta_pct||0)/100),K=r.descontar_meta_geral===!1?J:Math.max(J-f,0);R+=K,y[t]=(y[t]||0)+K}}}),{baseMeta:h,totalBruto:k,totalTaxas:S,valorLiquido:w,pctMetaGeral:B,comissaoGeral:j,comissaoDif:b,comissaoMetaProd:s?R:0,totalComissao:s?j+b+R:j+b,comissaoDifDetalhe:D,comissaoMetaProdDetalhe:s?y:{},produtosDiferenciados:C}},[U,E,N,O,V,P,F,s]);if(l)return a.jsx("div",{children:"Carregando permissões..."});if(!u)return a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const _={flexDirection:"column",alignItems:"center",textAlign:"center"};return a.jsxs("div",{className:"card-base",style:{background:"transparent",boxShadow:"none",padding:0},children:[a.jsx("div",{className:"card-base",style:{marginBottom:12},children:a.jsxs("div",{className:"form-row",style:{marginBottom:0},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:M,onChange:o=>ia(o.target.value),children:da.map(o=>a.jsx("option",{value:o.id,children:o.label},o.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:H.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:H.fim,readOnly:!0})]})]})}),Y&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:Y})}),z&&a.jsx("div",{children:"Carregando dados..."}),!z&&d&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",style:{marginBottom:12},children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,marginBottom:16},children:"Como está seu Progresso"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))",gap:12,marginBottom:4},children:[a.jsxs("div",{className:"kpi-card",style:{..._,color:"#16a34a"},children:[a.jsx("div",{className:"kpi-label",children:"Meta do mês"}),a.jsx("div",{className:"kpi-value",children:(P?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#ca8a04"},children:[a.jsx("div",{className:"kpi-label",children:"Total Bruto"}),a.jsx("div",{className:"kpi-value",children:d.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#c2410c"},children:[a.jsx("div",{className:"kpi-label",children:"Total Taxas"}),a.jsx("div",{className:"kpi-value",children:d.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#0ea5e9"},children:[a.jsx("div",{className:"kpi-label",children:"Valor Liquido"}),a.jsx("div",{className:"kpi-value",children:d.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{..._,color:"#2563eb"},children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[d.pctMetaGeral.toFixed(1),"%"]})]})]})]}),a.jsxs("div",{className:"card-base",children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[a.jsxs("div",{className:"kpi-card",style:_,children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:d.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),s&&d.comissaoMetaProd>0&&a.jsxs("div",{className:"kpi-card",style:_,children:[a.jsx("div",{className:"kpi-label",children:"Meta específica (produtos)"}),a.jsx("div",{className:"kpi-value",children:d.comissaoMetaProd.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),(d.produtosDiferenciados||[]).map(o=>a.jsxs("div",{className:"kpi-card",style:_,children:[a.jsx("div",{className:"kpi-label",children:N[o]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:(d.comissaoDifDetalhe?.[o]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},o)),a.jsxs("div",{className:"kpi-card kpi-highlight",style:_,children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:d.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{pa as default};
