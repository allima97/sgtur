import{j as e,s as y}from"./supabase.DNkd6bxA.js";import{r as c}from"./index.C0Fn7Wtz.js";import{u as q,w as te}from"./xlsx.DrgRuPKf.js";function F(){return new Date().toISOString().substring(0,10)}function O(s,w){const f=new Date(s);return f.setDate(f.getDate()+w),f}function b(s){return s.toISOString().substring(0,10)}function G(s){return new Date(s.getFullYear(),s.getMonth(),1)}function P(s){return new Date(s.getFullYear(),s.getMonth()+1,0)}function ae(s){return s.includes(";")||s.includes('"')||s.includes(`
`)?'"'+s.replace(/"/g,'""')+'"':s}function se(){const[s,w]=c.useState([]),[f,v]=c.useState(()=>{const a=O(new Date,-30);return b(a)}),[k,_]=c.useState(F()),[E,Q]=c.useState("todos"),[I,Y]=c.useState([]),[R,L]=c.useState(!1),[B,g]=c.useState(null),[h,W]=c.useState(null),[z,$]=c.useState(!0),[j,H]=c.useState({pdf:!0,excel:!0}),[x,J]=c.useState("total"),[S,A]=c.useState(!0);c.useEffect(()=>{async function t(){try{const{data:a,error:o}=await y.from("produtos").select("id, nome").order("nome",{ascending:!0});if(o)throw o;w(a||[])}catch(a){console.error(a),g("Erro ao carregar destinos.")}}t()},[]),c.useEffect(()=>{async function t(){try{$(!0),g(null);const{data:a}=await y.auth.getUser(),o=a?.user?.id;if(!o){g("Usuário não autenticado.");return}const{data:r}=await y.from("users").select("id, user_types(name), company_id").eq("id",o).maybeSingle(),n=r?.user_types?.name||a?.user?.user_metadata?.name||"",i=String(n||"").toUpperCase();let d="VENDEDOR";i.includes("ADMIN")?d="ADMIN":i.includes("GESTOR")?d="GESTOR":i.includes("VENDEDOR")?d="VENDEDOR":d="OUTRO";let l=[o];if(d==="GESTOR"){const{data:m}=await y.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",o),D=m?.map(M=>M.vendedor_id).filter(M=>!!M)||[];l=Array.from(new Set([o,...D]))}else d==="ADMIN"&&(l=[]);const p=r?.company_id||null;if(p){const{data:m}=await y.from("parametros_comissao").select("exportacao_pdf, exportacao_excel").eq("company_id",p).maybeSingle();m&&H({pdf:m.exportacao_pdf??!0,excel:m.exportacao_excel??!0})}W({usuarioId:o,papel:d,vendedorIds:l})}catch(a){console.error(a),g("Erro ao carregar contexto do usuário.")}finally{$(!1)}}t()},[]);const u=c.useMemo(()=>{const t=new Map(s.map(r=>[r.id,r.nome])),a=new Map;I.forEach(r=>{const n=r.destino_id,i=t.get(n)||"(sem destino)",d=a.get(n)||{destino_id:n,destino_nome:i,quantidade:0,total:0,ticketMedio:0},l=(r.vendas_recibos||[]).reduce((m,D)=>m+Number(D.valor_total||0)+Number(D.valor_taxas||0),0),p=l>0?l:r.valor_total??0;d.quantidade+=1,d.total+=p,a.set(n,d)});const o=Array.from(a.values()).map(r=>({...r,ticketMedio:r.quantidade>0?r.total/r.quantidade:0}));return o.sort((r,n)=>{let i=0;return x==="total"?i=r.total-n.total:x==="quantidade"?i=r.quantidade-n.quantidade:i=r.ticketMedio-n.ticketMedio,S?-i:i}),o},[I,s,x,S]),T=u.reduce((t,a)=>t+a.total,0),U=u.reduce((t,a)=>t+a.quantidade,0),K=U>0?T/U:0;function N(t){const a=new Date;if(t==="7"){const o=O(a,-7);v(b(o)),_(F());return}if(t==="30"){const o=O(a,-30);v(b(o)),_(F());return}if(t==="mes_atual"){const o=G(a),r=P(a);v(b(o)),_(b(r));return}if(t==="mes_anterior"){const o=new Date(a.getFullYear(),a.getMonth()-1,1),r=G(o),n=P(o);v(b(r)),_(b(n));return}}async function V(){if(h)try{L(!0),g(null);let t=y.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          produto_id,
          data_lancamento,
          data_embarque,
          valor_total,
          status,
          vendas_recibos (valor_total, valor_taxas)
        `).order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(t=t.in("vendedor_id",h.vendedorIds)),f&&(t=t.gte("data_lancamento",f)),k&&(t=t.lte("data_lancamento",k)),E!=="todos"&&(t=t.eq("status",E));const{data:a,error:o}=await t;if(o)throw o;Y(a||[])}catch(t){console.error(t),g("Erro ao carregar vendas para relatório por destino.")}finally{L(!1)}}function C(t){t===x?A(a=>!a):(J(t),A(!0))}c.useEffect(()=>{h&&V()},[h]);function X(){if(u.length===0){alert("Não há dados para exportar.");return}const t=["destino","quantidade","total","ticket_medio"],a=u.map(p=>[p.destino_nome,p.quantidade.toString(),p.total.toFixed(2).replace(".",","),p.ticketMedio.toFixed(2).replace(".",",")]),o=[t,...a].map(p=>p.map(m=>ae(m)).join(";")).join(`
`),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),i=new Date,d=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`,l=document.createElement("a");l.href=n,l.setAttribute("download",`relatorio-vendas-por-destino-${d}.csv`),document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n)}function Z(){if(!j.excel){alert("Exportação Excel desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=u.map(n=>({Destino:n.destino_nome,Quantidade:n.quantidade,"Faturamento (R$)":n.total,"Ticket médio (R$)":n.ticketMedio})),a=q.json_to_sheet(t),o=q.book_new();q.book_append_sheet(o,a,"Vendas por Destino");const r=new Date().toISOString().replace(/[-:T]/g,"").slice(0,12);te(o,`relatorio-destinos-${r}.xlsx`)}function ee(){if(!j.pdf){alert("Exportação PDF desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=window.open("","_blank");if(!t){alert("Não foi possível abrir a janela de exportação.");return}const a=u.map(o=>`
        <tr>
          <td>${o.destino_nome}</td>
          <td>${o.quantidade}</td>
          <td>${o.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
          <td>${o.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
        </tr>`).join("");t.document.write(`
      <html>
        <head>
          <title>Vendas por Destino</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 16px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
            th { background: #f1f5f9; }
          </style>
        </head>
        <body>
          <h3>Relatório de Vendas por Destino</h3>
          <table>
            <thead>
              <tr>
                <th>Destino</th>
                <th>Qtde</th>
                <th>Faturamento</th>
                <th>Ticket médio</th>
              </tr>
            </thead>
            <tbody>${a}</tbody>
          </table>
          <script>window.print();<\/script>
        </body>
      </html>
    `),t.document.close()}return e.jsxs("div",{className:"relatorio-vendas-destino-page",children:[e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:f,onChange:t=>v(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:k,onChange:t=>_(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:E,onChange:t=>Q(t.target.value),children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"aberto",children:"Aberto"}),e.jsx("option",{value:"confirmado",children:"Confirmado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]})]}),e.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("7"),children:"Últimos 7 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("30"),children:"Últimos 30 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_atual"),children:"Este mês"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_anterior"),children:"Mês anterior"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:V,children:"Aplicar filtros"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-purple",onClick:X,children:"Exportar CSV"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Z,disabled:!j.excel,title:j.excel?"":"Exportação Excel desabilitada nos parâmetros",children:"Exportar Excel"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:ee,disabled:!j.pdf,title:j.pdf?"":"Exportação PDF desabilitada nos parâmetros",children:"Exportar PDF"})]})]})]}),z&&e.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),h&&h.papel!=="ADMIN"&&e.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",h.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),B&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:B})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Destinos: ",e.jsx("strong",{children:u.length})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Faturamento total:"," ",e.jsx("strong",{children:T.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{children:["Ticket médio geral:"," ",e.jsx("strong",{children:K.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-purple min-w-[620px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Destino"}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>C("quantidade"),children:["Qtde ",x==="quantidade"?S?"↓":"↑":""]}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>C("total"),children:["Faturamento ",x==="total"?S?"↓":"↑":""]}),e.jsxs("th",{style:{cursor:"pointer"},onClick:()=>C("ticket"),children:["Ticket médio ",x==="ticket"?S?"↓":"↑":""]})]})}),e.jsxs("tbody",{children:[R&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Carregando..."})}),!R&&u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum destino encontrado com os filtros atuais."})}),!R&&u.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.destino_nome}),e.jsx("td",{children:t.quantidade}),e.jsx("td",{children:t.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:t.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},t.destino_id))]})]})})]})}export{se as default};
