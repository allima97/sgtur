import{s as l,j as a}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as je}from"./usePermissao.72SYthuA.js";function be(c){const p=c.getFullYear(),E=String(c.getMonth()+1).padStart(2,"0"),x=String(c.getDate()).padStart(2,"0"),j=String(c.getHours()).padStart(2,"0"),b=String(c.getMinutes()).padStart(2,"0"),i=Math.floor(Math.random()*900+100);return`VND-${p}${E}${x}-${j}${b}-${i}`}function _e(){const{ativo:c}=je("Vendas"),[p,E]=s.useState([]),[x,j]=s.useState(""),[b,i]=s.useState(null),[V,B]=s.useState(!0),[S,I]=s.useState(null),[F,d]=s.useState(null),[r,N]=s.useState(null),[k,P]=s.useState(""),[T,U]=s.useState(""),[A,W]=s.useState(""),[H,Y]=s.useState(""),[K,G]=s.useState(""),[J,Q]=s.useState(""),[z,oe]=s.useState(""),[ie,le]=s.useState([]),[de,ce]=s.useState([]),[me,ue]=s.useState([]),y=["novo","enviado","negociando","fechado","perdido"],_={novo:{bg:"#f8fafc",border:"#e2e8f0"},enviado:{bg:"#f1f5f9",border:"#cbd5e1"},negociando:{bg:"#eff6ff",border:"#bfdbfe"},fechado:{bg:"#ecfdf3",border:"#bbf7d0"},perdido:{bg:"#fef2f2",border:"#fecaca"}},[C,w]=s.useState(null),[D,$]=s.useState(null),[q,X]=s.useState(""),[L,Z]=s.useState(""),[R,ee]=s.useState(""),[O,ae]=s.useState("");s.useEffect(()=>{h(),xe()},[]);async function h(){try{B(!0),i(null),d(null);let e=l.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            venda_id,
            numero_venda,
            venda_criada,
            numero_venda_url,
            interacoes,
            clientes:cliente_id (nome),
            destinos:destino_id (nome),
            produtos:produto_id (nome)
          `).order("data_orcamento",{ascending:!1});x&&(e=e.eq("status",x)),q&&(e=e.gte("data_orcamento",q)),L&&(e=e.lte("data_orcamento",L)),R&&(e=e.gte("valor",parseFloat(R))),O&&(e=e.lte("valor",parseFloat(O)));const{data:t,error:n}=await e;if(n)throw n;E(t||[])}catch(e){console.error(e),i("Erro ao carregar orçamentos.")}finally{B(!1)}}const m=s.useMemo(()=>p,[p]),M=s.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return m.forEach(t=>{const n=t.status||"novo";e[n]||(e[n]=[]),e[n].push(t)}),e},[m]),te=s.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return m.forEach(t=>{const n=t.status||"novo",v=Number(t.valor||0);e[n]||(e[n]={qtd:0,valor:0}),e[n].qtd+=1,e[n].valor+=v}),e},[m]);function he(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],t=m.map(o=>[o.id,o.clientes?.nome||"",o.destinos?.nome||"",o.produtos?.nome||"",o.status||"",o.valor??"",o.data_orcamento||"",o.data_viagem||"",o.numero_venda||""]),n=[e.join(","),...t.map(o=>o.join(","))].join(`
`),v=new Blob([n],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(v),u=document.createElement("a");u.href=g,u.download="orcamentos.csv",u.click(),URL.revokeObjectURL(g)}function ve(e){w(e);const t=p.find(n=>n.id===e);t?.status&&$(t.status)}async function pe(e){if(C){if(e==="fechado"||e==="perdido"){w(null),$(null);return}await f(C,e),w(null),$(null)}}async function xe(){try{const[e,t,n]=await Promise.all([l.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),l.from("destinos").select("id, nome").eq("ativo",!0).order("nome"),l.from("produtos").select("id, nome").eq("ativo",!0).order("nome")]);e.data&&le(e.data),t.data&&ce(t.data),n.data&&ue(n.data)}catch(e){console.error(e)}}async function f(e,t){try{I(e),i(null),d(null);const{error:n}=await l.from("orcamentos").update({status:t}).eq("id",e);if(n)throw n;d("Status atualizado."),await h()}catch(n){console.error(n),i("Erro ao alterar status.")}finally{I(null)}}function fe(e){N(e),P(e.valor?String(e.valor):""),U(e.data_viagem||""),W(e.notas||""),Y(e.cliente_id||""),G(e.destino_id||""),Q(e.produto_id||""),i(null),d(null)}async function ge(e){if(e.preventDefault(),!!r)try{d(null),i(null);const{error:t}=await l.from("orcamentos").update({valor:k?parseFloat(k):null,data_viagem:T||null,notas:A||null,cliente_id:H||r.cliente_id||null,destino_id:K||r.destino_id||null,produto_id:J||r.produto_id||null,interacoes:z.trim()?[...r.interacoes||[],{criado_em:new Date().toISOString(),texto:z.trim()}]:r.interacoes||[]}).eq("id",r.id);if(t)throw t;d("Orçamento atualizado."),N(null),await h()}catch(t){console.error(t),i("Erro ao salvar edição.")}}async function ne(e){if(window.confirm("Converter este orçamento em venda?"))try{d(null),i(null);const{data:n}=await l.auth.getUser(),v=n?.user?.id;if(!v)throw new Error("Usuário não autenticado.");const g=new Date,u=be(g),o=g.toISOString().slice(0,10),{data:se,error:re}=await l.from("vendas").insert({vendedor_id:v,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:o,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:u,notas:e.notas}).select("id, numero_venda").maybeSingle();if(re)throw re;se?.id&&e.produto_id&&await l.from("vendas_recibos").insert({venda_id:se.id,produto_id:e.produto_id,numero_recibo:u,valor_total:e.valor||0,valor_taxas:0}),await l.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${u}`}).eq("id",e.id),d("Orçamento convertido em venda."),await h()}catch(n){console.error(n),i("Erro ao converter para venda.")}}return c?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",children:[a.jsxs("div",{className:"page-header",children:[a.jsxs("div",{children:[a.jsx("h2",{className:"card-title",children:"Orçamentos"}),a.jsx("p",{className:"page-subtitle",children:"Consulta rápida dos orçamentos cadastrados."})]}),a.jsxs("div",{className:"grid gap-3 w-full sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:x,onChange:e=>j(e.target.value),children:[a.jsx("option",{value:"",children:"Todos"}),y.map(e=>a.jsx("option",{value:e,children:e},e))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data início"}),a.jsx("input",{className:"form-input",type:"date",value:q,onChange:e=>X(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{className:"form-input",type:"date",value:L,onChange:e=>Z(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor min"}),a.jsx("input",{className:"form-input",type:"number",value:R,onChange:e=>ee(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor max"}),a.jsx("input",{className:"form-input",type:"number",value:O,onChange:e=>ae(e.target.value)})]})]}),a.jsxs("div",{style:{display:"flex",gap:8},children:[a.jsx("button",{className:"btn btn-secondary",onClick:h,children:"Atualizar"}),a.jsx("button",{className:"btn btn-light",onClick:he,children:"Exportar CSV"}),a.jsx("button",{className:"btn btn-light",onClick:()=>{j(""),X(""),Z(""),ee(""),ae(""),h()},children:"Limpar filtros"})]})]}),b&&a.jsx("div",{className:"auth-error",children:b}),F&&a.jsx("div",{className:"auth-success",children:F}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Venda"}),a.jsx("th",{children:"Valor"}),a.jsx("th",{children:"Data viagem"}),a.jsx("th",{children:"Notas"}),a.jsx("th",{children:"Ações"})]})}),a.jsxs("tbody",{children:[V&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando..."})}),!V&&m.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum orçamento encontrado."})}),!V&&m.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.data_orcamento?.slice(0,10)||"—"}),a.jsx("td",{children:e.clientes?.nome||"—"}),a.jsx("td",{children:e.destinos?.nome||"—"}),a.jsx("td",{children:e.produtos?.nome||"—"}),a.jsx("td",{style:{textTransform:"capitalize"},children:a.jsxs("select",{className:"form-select",value:e.status||"",onChange:t=>f(e.id,t.target.value),disabled:S===e.id,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"enviado",children:"Enviado"}),a.jsx("option",{value:"negociando",children:"Negociando"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})}),a.jsx("td",{children:e.venda_id?a.jsx("a",{href:e.numero_venda_url||"/vendas/consulta",title:"Ver venda",children:e.numero_venda||`${e.venda_id.slice(0,6)}...`}):"—"}),a.jsx("td",{children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"—"}),a.jsx("td",{children:e.data_viagem||"—"}),a.jsx("td",{children:e.notas||"—"}),a.jsxs("td",{children:[a.jsx("button",{className:"btn btn-light",onClick:()=>fe(e),style:{padding:"4px 8px",fontSize:"0.85rem"},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":"Editar",children:"Editar"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>ne(e),style:{padding:"4px 8px",fontSize:"0.85rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"Converter"})]})]},e.id))]})]})}),r&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Editar orçamento"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",r.clientes?.nome||"—"," | Destino: ",r.destinos?.nome||"—"]})]}),a.jsx("button",{className:"btn-ghost",onClick:()=>N(null),children:"✖"})]}),a.jsxs("form",{onSubmit:ge,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor (R$)"}),a.jsx("input",{className:"form-input",type:"number",value:k,onChange:e=>P(e.target.value),min:0,step:"0.01"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data da viagem"}),a.jsx("input",{className:"form-input",type:"date",value:T,onChange:e=>U(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:H,onChange:e=>Y(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),ie.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsxs("select",{className:"form-select",value:K,onChange:e=>G(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),de.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto"}),a.jsxs("select",{className:"form-select",value:J,onChange:e=>Q(e.target.value),children:[a.jsx("option",{value:"",children:"(Opcional)"}),me.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Notas"}),a.jsx("textarea",{className:"form-input",rows:3,value:A,onChange:e=>W(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Adicionar interação"}),a.jsx("textarea",{className:"form-input",rows:2,value:z,onChange:e=>oe(e.target.value),placeholder:"Ex: Ligação com cliente, próxima ação..."})]}),r.interacoes&&r.interacoes.length>0&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Histórico"}),a.jsx("div",{style:{maxHeight:120,overflowY:"auto",border:"1px solid #e2e8f0",borderRadius:8,padding:8,background:"#f8fafc"},children:r.interacoes.slice().reverse().map((e,t)=>a.jsxs("div",{style:{marginBottom:6,fontSize:"0.9rem"},children:[a.jsx("div",{style:{color:"#64748b",fontSize:"0.8rem"},children:e.criado_em?.slice(0,16).replace("T"," ")}),a.jsx("div",{children:e.texto})]},t))})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N(null),children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})})]}),a.jsxs("div",{className:"card-base card-blue",style:{marginTop:12},children:[a.jsx("h3",{className:"card-title",children:"Situação do Orçamento"}),a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))",gap:10,alignItems:"stretch",marginBottom:10},children:y.map(e=>a.jsxs("div",{className:"kpi-card",style:{background:_[e].bg,border:`1px solid ${_[e].border}`},children:[a.jsx("div",{className:"kpi-label",style:{textTransform:"capitalize"},children:e}),a.jsxs("div",{className:"kpi-value",style:{fontSize:"1.1rem"},children:[te[e].qtd," itens"]}),a.jsx("div",{style:{fontSize:"0.9rem",color:"#0f172a"},children:te[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))}),y.some(e=>M[e].length>0)?a.jsx("div",{className:"grid gap-3 sm:grid-cols-2 xl:grid-cols-4",children:y.filter(e=>M[e].length>0).map(e=>a.jsxs("div",{style:{background:_[e].bg,border:`1px solid ${_[e].border}`,borderRadius:10,padding:10,transition:"transform 0.1s ease, box-shadow 0.1s ease",boxShadow:D&&D===e?"0 0 0 2px rgba(59,130,246,0.4)":"none",transform:D&&D===e?"scale(1.01)":"none"},onDragOver:t=>t.preventDefault(),onDrop:()=>pe(e),children:[a.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:a.jsx("div",{style:{fontWeight:700,textTransform:"capitalize"},children:e})}),a.jsx("div",{style:{display:"flex",flexDirection:"column",gap:8},children:M[e].map(t=>a.jsxs("div",{style:{background:"white",borderRadius:8,border:C===t.id?"1px solid #3b82f6":"1px solid #e2e8f0",padding:"8px 10px",boxShadow:C===t.id?"0 8px 16px rgba(59,130,246,0.15)":"0 1px 2px rgba(0,0,0,0.05)",position:"relative"},draggable:t.status!=="fechado"&&t.status!=="perdido",onDragStart:()=>{t.status==="fechado"||t.status==="perdido"||ve(t.id)},onDragEnd:()=>w(null),title:`Cliente: ${t.clientes?.nome||"—"}
Destino: ${t.destinos?.nome||"—"}
Valor: ${t.valor?t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"—"}
Data orçamento: ${t.data_orcamento?.slice(0,10)||"—"}
Data viagem: ${t.data_viagem||"—"}
Venda: ${t.numero_venda||"—"}`,children:[a.jsx("div",{style:{fontWeight:600},children:t.clientes?.nome||"Cliente"}),a.jsx("div",{style:{fontSize:"0.85rem",color:"#64748b"},children:t.destinos?.nome||"—"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Valor:"," ",t.valor?t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"—"]}),a.jsxs("div",{style:{fontSize:"0.8rem",color:"#94a3b8"},children:["Orcamento: ",t.data_orcamento?.slice(0,10)||"—"," | Viagem:"," ",t.data_viagem||"—"]}),t.venda_id&&a.jsxs("div",{style:{fontSize:"0.8rem",color:"#22c55e"},children:["Venda: ",t.numero_venda||t.venda_id.slice(0,6)]}),a.jsxs("div",{style:{marginTop:6,display:"flex",gap:6,flexWrap:"wrap"},children:[e!=="negociando"&&a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px",fontSize:"0.8rem"},onClick:()=>f(t.id,"negociando"),disabled:S===t.id,children:"Mover p/ negociando"}),e!=="enviado"&&a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px",fontSize:"0.8rem"},onClick:()=>f(t.id,"enviado"),disabled:S===t.id,children:"Enviar"}),e!=="perdido"&&a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px",fontSize:"0.8rem"},onClick:()=>f(t.id,"perdido"),disabled:S===t.id,children:"Marcar perdido"}),e!=="fechado"&&a.jsx("button",{className:"btn btn-primary",style:{padding:"4px 8px",fontSize:"0.8rem"},onClick:()=>ne(t),disabled:!t.cliente_id||!t.destino_id,children:"Fechar (Venda)"})]})]},t.id))})]},e))}):a.jsx("div",{className:"card-base card-config",style:{marginTop:8},children:a.jsx("strong",{children:"Nenhum orçamento para exibir no Kanban."})})]})]}):a.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{_e as default};
