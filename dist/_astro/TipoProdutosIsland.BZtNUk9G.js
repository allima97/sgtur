import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as ie}from"./usePermissao.72SYthuA.js";import{t as I}from"./titleCase.DQLlfrnh.js";function O(s){return(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function ne(){const{permissao:s,ativo:U,loading:H}=ie("Parametros"),[N,J]=t.useState([]),[b,M]=t.useState(!0),[F,d]=t.useState(null),[h,K]=t.useState(""),[p,q]=t.useState(null),[z,B]=t.useState(null),[L,Q]=t.useState([]),[x,X]=t.useState({}),[v,j]=t.useState(""),[S,w]=t.useState(""),[C,y]=t.useState(""),[E,R]=t.useState(""),[o,T]=t.useState({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0});function f(a,i){T(u=>{if(a==="nome"){const l=String(i);return{...u,nome:l,tipo:u.tipo||l}}return{...u,[a]:i}})}async function A(){try{M(!0),d(null);const[{data:a,error:i},u,l]=await Promise.all([c.from("tipo_produtos").select("*").order("nome",{ascending:!0}),c.from("commission_rule").select("id, nome, tipo").eq("ativo",!0).order("nome"),c.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]);if(i)throw i;J(a||[]),Q(u.data||[]);const n={};l.data?.forEach(r=>{n[r.produto_id]={rule_id:r.rule_id||"",fix_meta_nao_atingida:r.fix_meta_nao_atingida,fix_meta_atingida:r.fix_meta_atingida,fix_super_meta:r.fix_super_meta}}),X(n)}catch(a){console.error(a),d("Erro ao carregar tipos de produto.")}finally{M(!1)}}t.useEffect(()=>{A()},[]);function k(){T({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0}),j(""),w(""),y(""),R(""),q(null),d(null)}function Y(a){q(a.id),T({nome:a.nome||a.tipo,tipo:a.tipo||a.nome||"",regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,disponivel_todas_cidades:!!a.disponivel_todas_cidades,ativo:a.ativo});const i=x[a.id]||{};j(i.rule_id||""),w(i.fix_meta_nao_atingida!==null&&i.fix_meta_nao_atingida!==void 0?String(i.fix_meta_nao_atingida):""),y(i.fix_meta_atingida!==null&&i.fix_meta_atingida!==void 0?String(i.fix_meta_atingida):""),R(i.fix_super_meta!==null&&i.fix_super_meta!==void 0?String(i.fix_super_meta):"")}async function Z(a){if(a.preventDefault(),s==="view"){d("VocÃª nÃ£o tem permissÃ£o para salvar tipos de produto.");return}const i=I(o.nome),u=I(o.tipo||i);if(!i){d("Nome Ã© obrigatÃ³rio.");return}if(o.regra_comissionamento==="geral"&&!v){d("Selecione uma regra de comissÃ£o para produtos do tipo 'geral'.");return}const l=n=>n.trim()===""?null:Number(n);if(o.regra_comissionamento==="diferenciado"){const n=l(S),r=l(C),m=l(E);if(n===null||isNaN(n)||r===null||isNaN(r)||m===null||isNaN(m)){d("Preencha os percentuais fixos para meta nÃ£o atingida, atingida e super meta (apenas nÃºmeros).");return}}try{d(null);const n={nome:i,tipo:u,regra_comissionamento:o.regra_comissionamento,soma_na_meta:o.soma_na_meta,disponivel_todas_cidades:o.disponivel_todas_cidades,ativo:o.ativo};let r=p;if(p){const{error:m}=await c.from("tipo_produtos").update(n).eq("id",p);if(m)throw m}else{const{data:m,error:_}=await c.from("tipo_produtos").insert(n).select("id").single();if(_)throw _;r=m?.id||null}if(r){async function m(){const g="ComissÃ£o Fixa (auto)",{data:V}=await c.from("commission_rule").select("id").eq("nome",g).maybeSingle();if(V?.id)return V.id;const{data:ae,error:W}=await c.from("commission_rule").insert({nome:g,descricao:"Gerada automaticamente para produtos diferenciados sem regra vinculada.",tipo:"GERAL",meta_nao_atingida:0,meta_atingida:0,super_meta:0,ativo:!0}).select("id").single();if(W)throw W;return ae?.id}const _=o.regra_comissionamento==="diferenciado"?l(S):null,P=o.regra_comissionamento==="diferenciado"?l(C):null,ee=o.regra_comissionamento==="diferenciado"?l(E):null;let D=v||x[r]?.rule_id||null;if(o.regra_comissionamento==="diferenciado"&&!D&&(D=await m()),v||o.regra_comissionamento==="diferenciado"){const{error:g}=await c.from("product_commission_rule").upsert({produto_id:r,rule_id:D,ativo:!0,fix_meta_nao_atingida:_,fix_meta_atingida:P,fix_super_meta:ee},{onConflict:"produto_id"});if(g)throw g}else await c.from("product_commission_rule").delete().eq("produto_id",r)}k(),await A()}catch(n){console.error(n),d("Erro ao salvar tipo de produto.")}}async function $(a){if(s!=="admin"){alert("Somente administradores podem excluir tipos de produto.");return}if(confirm("Tem certeza que deseja excluir este tipo de produto?"))try{B(a);const{error:i}=await c.from("tipo_produtos").delete().eq("id",a);if(i)throw i;await A()}catch(i){console.error(i),d("Erro ao excluir tipo de produto. Talvez esteja vinculado a vendas/recibos.")}finally{B(null)}}const G=t.useMemo(()=>{if(!h.trim())return N;const a=O(h);return N.filter(i=>O(i.nome||i.tipo||"").includes(a))},[h,N]);return H?e.jsx("div",{children:"Carregando permissÃµes..."}):U?e.jsxs("div",{className:"produtos-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:Z,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:o.nome,onChange:a=>f("nome",a.target.value),onBlur:a=>f("nome",I(a.target.value)),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Modelo de comissÃ£o"}),e.jsxs("select",{className:"form-input",value:o.regra_comissionamento,onChange:a=>{const i=a.target.value;f("regra_comissionamento",i),i==="diferenciado"&&j("")},disabled:s==="view",children:[e.jsx("option",{value:"geral",children:"Geral (usa regra cadastrada)"}),e.jsx("option",{value:"diferenciado",children:"Diferenciado (percentual fixo)"})]})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Soma na meta?"}),e.jsxs("select",{className:"form-input",value:o.soma_na_meta?"1":"0",onChange:a=>f("soma_na_meta",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DisponÃ­vel para todas as cidades?"}),e.jsxs("select",{className:"form-input",value:o.disponivel_todas_cidades?"1":"0",onChange:a=>f("disponivel_todas_cidades",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"0",children:"NÃ£o"}),e.jsx("option",{value:"1",children:"Sim"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-input",value:o.ativo?"1":"0",onChange:a=>f("ativo",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]})]}),o.regra_comissionamento==="geral"&&e.jsxs("div",{className:"form-group",style:{marginTop:8},children:[e.jsx("label",{className:"form-label",children:"Regra de ComissÃ£o *"}),e.jsxs("select",{className:"form-input",value:v,onChange:a=>j(a.target.value),disabled:s==="view",required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),L.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.tipo,")"]},a.id))]})]}),o.regra_comissionamento==="diferenciado"&&e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta nÃ£o atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:S,onChange:a=>w(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:C,onChange:a=>y(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (super meta) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:E,onChange:a=>R(a.target.value),disabled:s==="view"})]})]}),s!=="view"&&e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",type:"submit",children:p?"Salvar alteraÃ§Ãµes":"Adicionar tipo"}),p&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:k,children:"Cancelar ediÃ§Ã£o"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar tipo de produto"}),e.jsx("input",{className:"form-input",value:h,onChange:a=>K(a.target.value),placeholder:"Digite parte do nome..."})]})}),F&&e.jsx("div",{className:"card-base card-config mb-3",children:F}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Regra"}),e.jsx("th",{children:"Regra vinculada"}),e.jsx("th",{children:"Soma meta"}),e.jsx("th",{children:"Todas cidades"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[b&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando tipos de produto..."})}),!b&&G.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhum tipo encontrado."})}),!b&&G.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome||a.tipo}),e.jsx("td",{children:a.regra_comissionamento}),e.jsx("td",{children:x[a.id]?.rule_id?L.find(i=>i.id===x[a.id]?.rule_id)?.nome||"-":x[a.id]?.fix_meta_atingida?"ComissÃ£o fixa":"-"}),e.jsx("td",{children:a.soma_na_meta?"Sim":"NÃ£o"}),e.jsx("td",{children:a.disponivel_todas_cidades?"Sim":"NÃ£o"}),e.jsx("td",{style:{color:a.ativo?"#22c55e":"#ef4444"},children:a.ativo?"Ativo":"Inativo"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{className:"th-actions",children:[s!=="view"&&e.jsx("button",{className:"btn-icon",onClick:()=>Y(a),children:"âœï¸"}),s==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>$(a.id),disabled:z===a.id,children:z===a.id?"...":"ğŸ—‘ï¸"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"VocÃª nÃ£o possui acesso ao mÃ³dulo de ParÃ¢metros."})}export{ne as default};
