import{s as d,j as e}from"./supabase.CWKfsr2i.js";import{r as o}from"./index.DVhKKaGN.js";import{r as E}from"./logs.z45cSWoX.js";import{u as R}from"./usePermissao.LURrmXgT.js";const f=["Dashboard","Clientes","Vendas","Orcamentos","Cadastros","Paises","Cidades","Destinos","Produtos","Relatorios","Parametros","Metas","RegrasComissao","Admin","AdminDashboard","AdminLogs","AdminUsers"],F=[{value:"none",label:"Nenhum"},{value:"view",label:"Ver"},{value:"create",label:"Criar"},{value:"edit",label:"Editar"},{value:"delete",label:"Excluir"},{value:"admin",label:"Admin"}];function $(){const{permissao:y,ativo:L}=R("Admin"),[m,P]=o.useState(null),[c,D]=o.useState([]),[v,I]=o.useState([]),[u,q]=o.useState(""),[i,j]=o.useState(null),[h,b]=o.useState({}),[p,g]=o.useState(!1),[N,l]=o.useState(null),[M,w]=o.useState(!0),_=y==="admin";o.useEffect(()=>{x()},[]);async function x(){try{w(!0),l(null);const{data:s}=await d.auth.getUser(),a=s?.user?.id||null;P(a);const{data:r,error:t}=await d.from("users").select("id, nome_completo, email, active").order("nome_completo",{ascending:!0});if(t)throw t;D(r||[]);const{data:n,error:C}=await d.from("modulo_acesso").select("*");if(C)throw C;I(n||[])}catch(s){console.error(s),l("Erro ao carregar permiss√µes.")}finally{w(!1)}}const S=o.useMemo(()=>{if(!u.trim())return c;const s=u.toLowerCase();return c.filter(a=>a.nome_completo.toLowerCase().includes(s)||(a.email||"").toLowerCase().includes(s))},[c,u]);function A(s){j(s);const a={};for(const r of f){const t=v.find(n=>n.usuario_id===s.id&&n.modulo===r);a[r]=t?t.permissao:"none"}b(a)}function U(s,a){b(r=>({...r,[s]:a}))}async function k(){if(i){if(!_){l("Somente ADMIN pode alterar permiss√µes.");return}try{g(!0),l(null);for(const a of f){const r=h[a]||"none",t=v.find(n=>n.usuario_id===i.id&&n.modulo===a);t?await d.from("modulo_acesso").update({permissao:r,ativo:r!=="none"}).eq("id",t.id):await d.from("modulo_acesso").insert({usuario_id:i.id,modulo:a,permissao:r,ativo:r!=="none"})}await E({user_id:m,acao:"permissoes_atualizadas",modulo:"Admin",detalhes:{usuario_alterado_id:i.id,permissoes:h}}),await x();const s=c.find(a=>a.id===i.id)||null;s&&A(s)}catch(s){console.error(s),l("Erro ao salvar permiss√µes.")}finally{g(!1)}}}async function B(s){try{const a=!s.active,{error:r}=await d.from("users").update({active:a}).eq("id",s.id);if(r)throw r;await E({user_id:m,acao:a?"usuario_ativado":"usuario_bloqueado",modulo:"Admin",detalhes:{usuario_alterado_id:s.id}}),await x()}catch(a){console.error(a),l("Erro ao alterar status do usu√°rio.")}}return L?_?M?e.jsx("div",{children:"Carregando dados de permiss√µes..."}):e.jsxs("div",{className:"admin-permissoes-page",children:[e.jsxs("div",{className:"card-base card-blue mb-3",children:[e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar usu√°rio"}),e.jsx("input",{className:"form-input",value:u,onChange:s=>q(s.target.value),placeholder:"Nome ou e-mail..."})]})}),N&&e.jsx("div",{className:"card-base card-config mt-2",children:e.jsx("strong",{children:N})})]}),e.jsx("div",{className:"table-container mb-3 overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[780px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{children:"Status"}),e.jsx("th",{className:"th-actions",children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[S.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum usu√°rio encontrado."})}),S.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.nome_completo}),e.jsx("td",{children:s.email||"-"}),e.jsx("td",{children:s.active?"Ativo":"Bloqueado"}),e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",title:"Editar permiss√µes",onClick:()=>A(s),children:"‚öôÔ∏è"}),m!==s.id&&e.jsx("button",{className:`btn-icon ${s.active?"btn-danger":""}`,title:s.active?"Bloquear usu√°rio":"Reativar usu√°rio",onClick:()=>B(s),children:s.active?"üö´":"‚úÖ"})]})]},s.id))]})]})}),i&&e.jsxs("div",{className:"card-base card-blue",children:[e.jsxs("h3",{children:["Permiss√µes de:"," ",e.jsx("span",{style:{fontWeight:600},children:i.nome_completo})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[500px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"M√≥dulo"}),e.jsx("th",{children:"N√≠vel"})]})}),e.jsx("tbody",{children:f.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s}),e.jsx("td",{children:e.jsx("select",{className:"form-select",value:h[s]||"none",onChange:a=>U(s,a.target.value),children:F.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})})]},s))})]})}),e.jsxs("div",{className:"mt-2",children:[e.jsx("button",{className:"btn btn-primary",onClick:k,disabled:p,children:p?"Salvando...":"Salvar permiss√µes"}),e.jsx("button",{className:"btn btn-light",style:{marginLeft:8},onClick:()=>j(null),children:"Fechar"})]})]})]}):e.jsx("div",{children:"Somente usu√°rios ADMIN podem gerenciar permiss√µes."}):e.jsx("div",{children:"Acesso ao m√≥dulo de Admin bloqueado."})}export{$ as default};
