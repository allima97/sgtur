import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as n}from"./index.C0Fn7Wtz.js";import{s as i}from"./supabase.Ng8nq9tn.js";import{u as Ea}from"./usePermissao.DiLe8-Rs.js";import{L as Ca}from"./LoadingUsuarioContext.BaDUNi7o.js";function Ia(v){const V=v.getFullYear(),q=String(v.getMonth()+1).padStart(2,"0"),P=String(v.getDate()).padStart(2,"0"),j=String(v.getHours()).padStart(2,"0"),B=String(v.getMinutes()).padStart(2,"0"),U=Math.floor(Math.random()*900+100);return`VND-${V}${q}${P}-${j}${B}-${U}`}function $a({suppressLoadingMessage:v=!1}){const{ativo:V,loading:q,podeCriar:P,podeExcluir:j}=Ea("Vendas"),[B,U]=n.useState(!1),[b,ea]=n.useState([]),[W,me]=n.useState(""),[ue,m]=n.useState(null),[H,pe]=n.useState(!0),[aa,he]=n.useState(null),[fe,u]=n.useState(null),[g,w]=n.useState(null),[K,ge]=n.useState(""),[ve,xe]=n.useState(""),[be,je]=n.useState(""),[ye,Ne]=n.useState(""),[we,Se]=n.useState(""),[_e,Ee]=n.useState(""),[ta,ra]=n.useState([]),[na,oa]=n.useState([]),[sa,ia]=n.useState([]),Y=["novo","enviado","negociando","fechado","perdido"],S=7,_={novo:{bg:"#e0f2fe",border:"#1d4ed8"},enviado:{bg:"#fef9c3",border:"#facc15"},negociando:{bg:"#fff7ed",border:"#fdba74"},fechado:{bg:"#ecfdf3",border:"#16a34a"},perdido:{bg:"#fee2e2",border:"#fca5a5"}},[Ce,G]=n.useState(null),[ka,J]=n.useState(null),[Q,Ie]=n.useState(""),[X,ke]=n.useState(""),[Z,De]=n.useState(""),[ee,Le]=n.useState(""),[l,Te]=n.useState(null),[Ae,ae]=n.useState([]),[te,Re]=n.useState(!1),[E,C]=n.useState(!1),[$e,f]=n.useState(null),[ze,I]=n.useState("anotacao"),[re,k]=n.useState(""),[Fe,D]=n.useState(""),[Oe,L]=n.useState("email"),[ne,T]=n.useState(""),[oe,A]=n.useState(""),[se,R]=n.useState(""),[Me,ie]=n.useState(!0),[Ve,qe]=n.useState(null),[Pe,la]=n.useState(!1),[le,ca]=n.useState(!1),[y,Be]=n.useState({}),[Ue,We]=n.useState([]),[da,ma]=n.useState(0),[$,He]=n.useState(null),ua=[{value:"anotacao",label:"Anota√ß√£o interna"},{value:"contato",label:"Contato com cliente"},{value:"envio",label:"Envio de proposta"},{value:"follow-up",label:"Follow-up"}];n.useEffect(()=>{p(),xa()},[]),n.useEffect(()=>{if(typeof window>"u")return;const e=t=>{U(!!t?.detail?.aberto)};return window.addEventListener("formulario-orcamento-status",e),()=>window.removeEventListener("formulario-orcamento-status",e)},[]),n.useEffect(()=>{const e=()=>p();return window.addEventListener("orcamento-criado",e),()=>window.removeEventListener("orcamento-criado",e)},[]),n.useEffect(()=>{const e=()=>p();return window.addEventListener("orcamento-interacao-criada",e),()=>window.removeEventListener("orcamento-interacao-criada",e)},[]);async function p(){try{pe(!0),m(null),u(null);let e=i.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            numero_venda,
            venda_criada,
            clientes:cliente_id (nome),
            destinos:produtos!destino_id (nome),
            produtos:tipo_produtos!produto_id (nome, tipo)
          `).order("data_orcamento",{ascending:!1});W&&(e=e.eq("status",W)),Q&&(e=e.gte("data_orcamento",Q)),X&&(e=e.lte("data_orcamento",X)),Z&&(e=e.gte("valor",parseFloat(Z))),ee&&(e=e.lte("valor",parseFloat(ee)));const{data:t,error:r}=await e;if(r)throw r;const o=t||[];ea(o);const s=o.map(h=>h.id).filter(Boolean);s.length?ba(s):Be({})}catch(e){console.error(e),m("Erro ao carregar or√ßamentos.")}finally{pe(!1)}}const z=n.useMemo(()=>{const e=["novo","enviado","negociando"];return b.filter(t=>{const r=t.status||"novo";if(!e.includes(r))return!1;const o=pa(t.data_viagem||null),s=ha(t.data_orcamento||null),h=y[t.id],c=F(h?.created_at||null),O=!t.data_viagem&&s>=7,M=Number.isFinite(o)&&o<=7,_a=!h?.created_at||c>=S;return M||O||_a})},[b,y]),Ke=n.useMemo(()=>new Set(z.map(e=>e.id)),[z]),x=n.useMemo(()=>le?b.filter(e=>Ke.has(e.id)):b,[b,le,Ke]),ce=n.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return x.forEach(t=>{const r=t.status||"novo";e[r]||(e[r]=[]),e[r].push(t)}),e},[x]);function pa(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,o=new Date(`${e}T00:00:00`).getTime()-t.getTime();return Math.floor(o/(1e3*60*60*24))}function ha(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,r=new Date(`${e}T00:00:00`),o=t.getTime()-r.getTime();return Math.floor(o/(1e3*60*60*24))}function N(e,t=80){if(!e)return"";const r=e.replace(/\s+/g," ").trim();return r.length<=t?r:`${r.slice(0,t-1)}‚Ä¶`}function F(e){if(!e)return Number.POSITIVE_INFINITY;const t=Date.now()-new Date(e).getTime();return Math.floor(t/(1e3*60*60*24))}function d(e,t="success"){ma(o=>o+1);const r=da+1;We(o=>[...o,{id:r,message:e,type:t}]),setTimeout(()=>{We(o=>o.filter(s=>s.id!==r))},3500)}const Ye=n.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return x.forEach(t=>{const r=t.status||"novo",o=Number(t.valor||0);e[r]||(e[r]={qtd:0,valor:0}),e[r].qtd+=1,e[r].valor+=o}),e},[x]);function fa(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],t=x.map(c=>[c.id,c.clientes?.nome||"",c.destinos?.nome||"",c.produtos?.nome||"",c.status||"",c.valor??"",c.data_orcamento||"",c.data_viagem||"",c.numero_venda||""]),r=[e.join(","),...t.map(c=>c.join(","))].join(`
`),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(o),h=document.createElement("a");h.href=s,h.download="orcamentos.csv",h.click(),URL.revokeObjectURL(s)}function ga(e){G(e);const t=b.find(r=>r.id===e);t?.status&&J(t.status)}async function va(e){Ce&&(await Ge(Ce,e),G(null),J(null))}async function xa(){try{const[e,t,r]=await Promise.all([i.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),i.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),i.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);e.data&&ra(e.data),t.data&&oa(t.data),r.data&&ia(r.data)}catch(e){console.error(e)}}async function ba(e){try{const{data:t,error:r}=await i.from("orcamento_interacoes").select("orcamento_id, tipo, created_at, mensagem, anexo_url").in("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;const o={};(t||[]).forEach(s=>{o[s.orcamento_id]||(o[s.orcamento_id]={tipo:s.tipo,created_at:s.created_at,mensagem:s.mensagem,anexo_url:s.anexo_url})}),Be(o)}catch(t){console.error("Erro ao carregar √∫ltimas intera√ß√µes",t)}}async function Ge(e,t){try{he(e),m(null),u(null);const{error:r}=await i.from("orcamentos").update({status:t}).eq("id",e);if(r)throw r;u("Status atualizado."),d("Status atualizado.","success"),await p()}catch(r){console.error(r),m("Erro ao alterar status."),d("Erro ao alterar status.","error")}finally{he(null)}}async function Je(e){if(!(!j||!window.confirm("Excluir este or√ßamento e seu hist√≥rico?")))try{He(e.id),m(null),u(null);const r=await i.from("orcamento_interacoes").delete().eq("orcamento_id",e.id);r.error&&console.warn("N√£o foi poss√≠vel limpar intera√ß√µes antes de excluir o or√ßamento.",r.error);const o=await i.from("viagens").delete().eq("orcamento_id",e.id);o.error&&console.warn("N√£o foi poss√≠vel limpar viagens vinculadas antes de excluir o or√ßamento.",o.error);const{error:s}=await i.from("orcamentos").delete().eq("id",e.id);if(s)throw s;u("Or√ßamento exclu√≠do."),d("Or√ßamento exclu√≠do.","success"),await p()}catch(r){console.error(r);const o=r&&typeof r=="object"&&"message"in r&&typeof r.message=="string"?r.message:"Erro ao excluir or√ßamento.";m(o),d(o,"error")}finally{He(null)}}function Qe(e){w(e),ge(e.valor?String(e.valor):""),xe(e.data_viagem||""),je(e.notas||""),Ne(e.cliente_id||""),Se(e.destino_id||""),Ee(e.produto_id||""),m(null),u(null)}async function ja(e){if(e.preventDefault(),!!g)try{u(null),m(null);const{error:t}=await i.from("orcamentos").update({valor:K?parseFloat(K):null,data_viagem:ve||null,notas:be||null,cliente_id:ye||g.cliente_id||null,destino_id:we||g.destino_id||null,produto_id:_e||g.produto_id||null}).eq("id",g.id);if(t)throw t;u("Or√ßamento atualizado."),d("Or√ßamento atualizado.","success"),w(null),await p()}catch(t){console.error(t),m("Erro ao salvar edi√ß√£o."),d("Erro ao salvar edi√ß√£o.","error")}}async function ya(e){if(window.confirm("Converter este or√ßamento em venda?"))try{u(null),m(null);const{data:r}=await i.auth.getUser(),o=r?.user?.id;if(!o)throw new Error("Usu√°rio n√£o autenticado.");const s=new Date,h=Ia(s),c=s.toISOString().slice(0,10),{data:O,error:M}=await i.from("vendas").insert({vendedor_id:o,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:c,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:h,notas:e.notas}).select("id, numero_venda").maybeSingle();if(M)throw M;O?.id&&e.produto_id&&await i.from("vendas_recibos").insert({venda_id:O.id,produto_id:e.produto_id,numero_recibo:h,valor_total:e.valor||0,valor_taxas:0}),await i.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${h}`}).eq("id",e.id),u("Or√ßamento convertido em venda."),d("Or√ßamento convertido em venda.","success"),await p()}catch(r){console.error(r),m("Erro ao converter para venda."),d("Erro ao converter para venda.","error")}}async function Na(e){try{qe(e.id),m(null),u(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const o=`Follow-up autom√°tico: or√ßamento ${e.id} (${e.status||"novo"}) ${e.data_viagem?`viagem em ${e.data_viagem}`:"sem data de viagem"}.`,{error:s}=await i.from("orcamento_interacoes").insert({orcamento_id:e.id,usuario_id:r,tipo:"follow-up",mensagem:o});if(s)throw s;u("Follow-up registrado."),d("Follow-up registrado.","success"),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:e.id}})),await p()}catch(t){console.error(t),m("Erro ao registrar follow-up."),d("Erro ao registrar follow-up.","error")}finally{qe(null)}}async function de(e){try{Re(!0),f(null);const{data:t,error:r}=await i.from("orcamento_interacoes").select(`
            id,
            tipo,
            mensagem,
            created_at,
            usuario_id,
            responsavel_id,
            anexo_url,
            users:usuario_id (email),
            responsavel:responsavel_id (email)
          `).eq("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;ae(t||[])}catch(t){console.error(t);const r=t?.message||"Erro ao carregar intera√ß√µes.";f(`${r} Verifique se a tabela "orcamento_interacoes" existe com colunas esperadas.`)}finally{Re(!1)}}function Xe(e){Te(e),ae([]),k(""),I("anotacao"),D(""),L("email"),T(""),A(""),R(""),ie(!0),de(e.id)}function Ze(){Te(null),ae([]),f(null),k(""),I("anotacao"),D(""),L("email"),T(""),A(""),R(""),ie(!0)}async function wa(e){if(e.preventDefault(),!!l){if(!re.trim()){f("Escreva uma mensagem para registrar no hist√≥rico.");return}try{C(!0),f(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const{error:o}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:ze||"anotacao",mensagem:re.trim(),anexo_url:Fe.trim()||null});if(o)throw o;k(""),I("anotacao"),D(""),await de(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),d("Intera√ß√£o registrada.","success")}catch(t){console.error(t);const r=t?.message||"Erro ao salvar intera√ß√£o.";f(r),d("Erro ao salvar intera√ß√£o.","error")}finally{C(!1)}}}async function Sa(e){if(e.preventDefault(),!!l){if(!se.trim()&&!oe.trim()){f("Informe uma mensagem ou um link para registrar o envio/compartilhamento.");return}try{C(!0),f(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const o=se.trim()||`Enviado via ${Oe}${ne?` para ${ne}`:""}.`,{error:s}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:"envio",mensagem:o,anexo_url:oe.trim()||null});if(s)throw s;Me&&l.status!=="fechado"&&l.status!=="perdido"&&(await i.from("orcamentos").update({status:"enviado"}).eq("id",l.id),await p()),R(""),A(""),T(""),L("email"),await de(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),d("Envio registrado.","success"),await p()}catch(t){console.error(t);const r=t?.message||"Erro ao registrar envio/compartilhamento.";f(r),d("Erro ao registrar envio/compartilhamento.","error")}finally{C(!1)}}}return q?v?null:a.jsx(Ca,{}):V?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",children:[a.jsxs("div",{className:"grid w-full mt-3 gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",alignItems:"end"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:W,onChange:e=>me(e.target.value),children:[a.jsx("option",{value:"",children:"Todos"}),Y.map(e=>a.jsx("option",{value:e,children:e},e))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data in√≠cio"}),a.jsx("input",{className:"form-input",type:"date",value:Q,onChange:e=>Ie(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{className:"form-input",type:"date",value:X,onChange:e=>ke(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor min"}),a.jsx("input",{className:"form-input",type:"number",value:Z,onChange:e=>De(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor max"}),a.jsx("input",{className:"form-input",type:"number",value:ee,onChange:e=>Le(e.target.value)})]}),P&&a.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[a.jsx("span",{style:{visibility:"hidden"},children:"bot√£o"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>window.dispatchEvent(new CustomEvent("abrir-formulario-orcamento")),disabled:B,children:"Adicionar or√ßamento"})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[a.jsx("button",{className:"btn btn-secondary min-w-[120px]",onClick:p,children:"Atualizar"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:fa,children:"Exportar CSV"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:()=>{me(""),Ie(""),ke(""),De(""),Le(""),p()},children:"Limpar filtros"}),a.jsx("button",{className:"btn btn-light min-w-[160px]",onClick:()=>la(e=>!e),children:Pe?"Ocultar Kanban":"Mostrar Kanban"}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:le,onChange:e=>ca(e.target.checked)}),"S√≥ pendentes de follow-up"]})]})]}),ue&&a.jsx("div",{className:"auth-error",children:ue}),fe&&a.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:fe}),a.jsxs("div",{className:"card-base card-blue mt-3",children:[a.jsx("h3",{className:"card-title font-semibold",children:"Situa√ß√£o do Or√ßamento"}),a.jsx("div",{className:"grid gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",alignItems:"stretch"},children:Y.map(e=>a.jsxs("div",{className:"kpi-card flex flex-col gap-1 items-center justify-center text-center",style:{background:_[e].bg,border:`1px solid ${_[e].border}`},children:[a.jsxs("div",{className:"kpi-label capitalize font-bold",children:[e," - ",String(Ye[e].qtd).padStart(2,"0")," Itens"]}),a.jsx("div",{className:"kpi-value text-xl font-extrabold",children:Ye[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))})]}),z.length>0&&a.jsxs("div",{className:"card-base card-yellow",style:{marginTop:12},children:[a.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Pendentes de follow-up"}),a.jsx("p",{className:"page-subtitle",children:"Viagem pr√≥xima (‚â§ 7 dias) ou or√ßamento sem data h√° 7+ dias. Clique para registrar follow-up."})]})}),a.jsx("div",{style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))"},children:z.map(e=>{const t=y[e.id],r=F(t?.created_at||null),o=!t?.created_at||r>=S;return a.jsxs("div",{className:"card-base",style:{border:"1px solid #facc15",background:"#fffbeb"},children:[a.jsx("div",{style:{fontWeight:700},children:e.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Status: ",(e.status||"novo").toUpperCase()," | Viagem: ",e.data_viagem||"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),o&&a.jsxs("div",{style:{marginTop:4,color:"#b45309",fontSize:"0.85rem",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]}),a.jsx("button",{className:"btn btn-primary",style:{marginTop:8,width:"100%"},onClick:()=>Na(e),disabled:Ve===e.id,children:Ve===e.id?"Registrando...":"Registrar follow-up"}),t?.tipo&&a.jsxs("div",{style:{marginTop:8,fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",t?.tipo," ",t?.created_at?new Date(t?.created_at||"").toLocaleDateString("pt-BR"):"",N(t?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:N(t?.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]})]},`pend-${e.id}`)})})]}),a.jsx("div",{className:"card-base",style:{marginTop:16},children:a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{style:{textAlign:"center"},children:"Status"}),a.jsx("th",{style:{textAlign:"center"},children:"Valor"}),a.jsx("th",{style:{textAlign:"center"},children:"Data viagem"}),a.jsx("th",{style:{textAlign:"center"},children:"√öltima intera√ß√£o"}),a.jsx("th",{style:{textAlign:"center"},children:"A√ß√µes"})]})}),a.jsxs("tbody",{children:[H&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando..."})}),!H&&x.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum or√ßamento encontrado."})}),!H&&x.map(e=>{const t=y[e.id],r=F(t?.created_at||null),o=!t?.created_at||r>=S;return a.jsxs("tr",{children:[a.jsx("td",{children:e.data_orcamento?.slice(0,10)||"‚Äî"}),a.jsx("td",{children:e.clientes?.nome||"‚Äî"}),a.jsx("td",{children:e.destinos?.nome||"‚Äî"}),a.jsx("td",{children:e.produtos?.nome||"‚Äî"}),a.jsx("td",{style:{textTransform:"capitalize",textAlign:"center"},children:a.jsxs("select",{className:"form-select",value:e.status||"",onChange:s=>Ge(e.id,s.target.value),disabled:aa===e.id,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"enviado",children:"Enviado"}),a.jsx("option",{value:"negociando",children:"Negociando"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})}),a.jsx("td",{style:{textAlign:"center"},children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"}),a.jsx("td",{style:{textAlign:"center"},children:e.data_viagem||"‚Äî"}),a.jsxs("td",{style:{textAlign:"center",fontSize:"0.85rem",color:"#475569"},children:[t?.tipo||"‚Äî",t?.created_at?` ‚Ä¢ ${new Date(t.created_at).toLocaleDateString("pt-BR")}`:"",t?.mensagem&&a.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:N(t.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})}),o&&a.jsxs("div",{style:{color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]})]}),a.jsxs("td",{style:{textAlign:"center"},children:[j&&a.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Je(e),disabled:$===e.id,style:{marginRight:6},title:"Excluir or√ßamento",children:$===e.id?"...":"üóëÔ∏è"}),a.jsx("button",{className:"btn-icon",onClick:()=>Qe(e),style:{marginRight:6},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":"Editar",children:"‚úèÔ∏è"}),a.jsx("button",{className:"btn btn-primary","aria-label":"Converter em venda",onClick:()=>ya(e),style:{padding:"4px 8px",fontSize:"0.95rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"$"}),a.jsx("button",{className:"btn-icon","aria-label":"Hist√≥rico de intera√ß√µes",onClick:()=>Xe(e),style:{marginLeft:6},title:"Ver hist√≥rico / registrar intera√ß√£o",children:"üïí"})]})]},e.id)})]})]})})}),Pe&&a.jsxs("div",{className:"card-base",style:{marginTop:16},children:[a.jsx("div",{className:"page-header",style:{marginBottom:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Kanban de Or√ßamentos"}),a.jsx("p",{className:"page-subtitle",children:"Arraste os cards entre colunas para alterar o status."})]})}),a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12,alignItems:"flex-start"},children:Y.map(e=>a.jsxs("div",{onDragOver:t=>t.preventDefault(),onDrop:()=>va(e),style:{border:`2px dashed ${_[e].border}`,background:_[e].bg,minHeight:120,padding:8,borderRadius:10},children:[a.jsxs("div",{style:{fontWeight:800,textTransform:"capitalize",marginBottom:6},children:[e," (",ce[e]?.length||0,")"]}),a.jsxs("div",{style:{display:"grid",gap:8},children:[(ce[e]||[]).map(t=>{const r=y[t.id],o=F(r?.created_at||null),s=!r?.created_at||o>=S;return a.jsxs("div",{draggable:!0,onDragStart:()=>ga(t.id),onDragEnd:()=>{G(null),J(null)},className:"card-base",style:{padding:10,cursor:"grab",border:"1px solid #e2e8f0",background:"#fff"},children:[a.jsx("div",{style:{fontWeight:700},children:t.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",t.valor?t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Viagem: ",t.data_viagem||"‚Äî"]}),s&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(o)?`${o}d`:"‚Äî"]}),r?.tipo&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",r?.tipo," ",r?.created_at?new Date(r?.created_at||"").toLocaleDateString("pt-BR"):"",N(r?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:N(r?.mensagem)}),r?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:r?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]}),a.jsxs("div",{style:{display:"flex",gap:6,marginTop:6,flexWrap:"wrap"},children:[a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Qe(t),children:"Editar"}),a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Xe(t),children:"Hist√≥rico"}),j&&a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px",color:"#b91c1c",borderColor:"#fca5a5",background:"#fee2e2"},onClick:()=>Je(t),disabled:$===t.id,children:$===t.id?"Excluindo...":"Excluir"})]})]},`kan-card-${t.id}`)}),(ce[e]||[]).length===0&&a.jsx("div",{style:{fontSize:"0.9rem",color:"#475569"},children:"Sem itens."})]})]},`kanban-${e}`))})]}),g&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Editar or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",g.clientes?.nome||"‚Äî"," | Destino: ",g.destinos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:()=>w(null),children:"‚úñ"})]}),a.jsxs("form",{onSubmit:ja,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor (R$)"}),a.jsx("input",{className:"form-input",type:"number",value:K,onChange:e=>ge(e.target.value),min:0,step:"0.01"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data da viagem"}),a.jsx("input",{className:"form-input",type:"date",value:ve,onChange:e=>xe(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:ye,onChange:e=>Ne(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),ta.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsxs("select",{className:"form-select",value:we,onChange:e=>Se(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),na.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto"}),a.jsxs("select",{className:"form-select",value:_e,onChange:e=>Ee(e.target.value),children:[a.jsx("option",{value:"",children:"(Opcional)"}),sa.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Notas"}),a.jsx("textarea",{className:"form-input",rows:3,value:be,onChange:e=>je(e.target.value)})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>w(null),children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})}),l&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:640,width:"90vw"},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Hist√≥rico do or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Cliente: ",l.clientes?.nome||"‚Äî"," | Destino: ",l.destinos?.nome||"‚Äî"," | Produto: ",l.produtos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:Ze,children:"‚úñ"})]}),a.jsxs("div",{className:"modal-body",style:{display:"grid",gap:12},children:[a.jsxs("form",{onSubmit:Sa,className:"card-base",style:{background:"#eef2ff"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Registrar envio / compartilhamento"}),a.jsxs("div",{className:"grid",style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Canal"}),a.jsxs("select",{className:"form-select",value:Oe,onChange:e=>L(e.target.value),children:[a.jsx("option",{value:"email",children:"E-mail"}),a.jsx("option",{value:"whatsapp",children:"WhatsApp"}),a.jsx("option",{value:"link",children:"Link"}),a.jsx("option",{value:"outro",children:"Outro"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destinat√°rio"}),a.jsx("input",{className:"form-input",type:"text",value:ne,onChange:e=>T(e.target.value),placeholder:"E-mail, telefone, nome..."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link"}),a.jsx("input",{className:"form-input",type:"url",value:oe,onChange:e=>A(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:se,onChange:e=>R(e.target.value),placeholder:"Ex.: Proposta enviada por e-mail. Link do PDF..."})]}),a.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8,fontSize:"0.9rem"},children:[a.jsx("input",{type:"checkbox",checked:Me,onChange:e=>ie(e.target.checked)}),'Marcar or√ßamento como "enviado"']}),a.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:E,children:E?"Salvando...":"Registrar envio"})})]}),a.jsxs("form",{onSubmit:wa,className:"card-base",style:{background:"#f8fafc"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo"}),a.jsx("select",{className:"form-select",value:ze,onChange:e=>I(e.target.value),children:ua.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:re,onChange:e=>k(e.target.value),placeholder:"Ex.: Enviada proposta por e-mail. Aguardando retorno."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link / Anexo (opcional)"}),a.jsx("input",{className:"form-input",type:"url",value:Fe,onChange:e=>D(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]}),$e&&a.jsx("div",{className:"auth-error",children:$e}),a.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:Ze,children:"Fechar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:E,children:E?"Salvando...":"Registrar"})]})]}),a.jsxs("div",{className:"card-base",style:{maxHeight:"50vh",overflowY:"auto"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Intera√ß√µes"}),te&&a.jsx("div",{children:"Carregando intera√ß√µes..."}),!te&&Ae.length===0&&a.jsx("div",{children:"Nenhuma intera√ß√£o registrada ainda."}),!te&&Ae.map(e=>a.jsxs("div",{style:{padding:"10px 0",borderBottom:"1px solid #e2e8f0",display:"grid",gap:4},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[a.jsx("span",{style:{background:"#e2e8f0",color:"#0f172a",padding:"2px 8px",borderRadius:12,fontSize:"0.85rem",textTransform:"capitalize",whiteSpace:"nowrap"},children:e.tipo||"anotacao"}),a.jsx("span",{style:{fontSize:"0.85rem",color:"#475569",textAlign:"right"},children:e.created_at?new Date(e.created_at).toLocaleString("pt-BR"):"‚Äî"})]}),a.jsx("div",{style:{whiteSpace:"pre-wrap",color:"#0f172a"},children:e.mensagem}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Por: ",e.users?.email||e.usuario_id||"‚Äî"]}),e.anexo_url&&a.jsx("div",{style:{fontSize:"0.9rem"},children:a.jsx("a",{href:e.anexo_url,target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo/compartilhamento"})})]},e.id))]})]})]})}),Ue.length>0&&a.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:Ue.map(e=>a.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):a.jsx("div",{children:"Acesso ao m√≥dulo de Vendas bloqueado."})}export{$a as default};
