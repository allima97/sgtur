import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as h}from"./supabase.Ng8nq9tn.js";import{u as T}from"./usePermissao.DiLe8-Rs.js";import{L as B}from"./LoadingUsuarioContext.BaDUNi7o.js";import{r as k}from"./logs.DwCrXgEk.js";const G=["R$","USD","EUR"],H=()=>new Date().toISOString().slice(0,10),V=()=>({moeda:"USD",data:H(),valor:""});function J(o){if(!o||typeof o!="string")return null;const b=o.replace(/\./g,"").replace(",",".").trim();if(!b)return null;const j=Number(b);return Number.isFinite(j)?j:null}function K(o){return o==null||Number.isNaN(o)?"-":o.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:6})}function ae(){const{permissao:o,ativo:b,loading:j}=T("Parametros"),[l,y]=r.useState(V()),[n,D]=r.useState(null),[p,_]=r.useState([]),[I,v]=r.useState(!0),[w,U]=r.useState(!1),[F,t]=r.useState(null),[R,u]=r.useState(null),[g,q]=r.useState(null),[S,z]=r.useState(null),f=(o||"").toLowerCase(),c=f==="admin"||f==="edit"||f==="create",N=f==="admin"||f==="edit",L=r.useCallback(()=>{y(V()),D(null)},[]),x=r.useCallback(async()=>{v(!0),t(null),u(null);try{const{data:a}=await h.auth.getUser(),s=a?.user?.id||null;if(z(s),!s){t("UsuÃ¡rio nÃ£o autenticado."),_([]);return}const{data:d,error:m}=await h.from("users").select("company_id").eq("id",s).maybeSingle();if(m)throw m;const i=d?.company_id||null;if(q(i),!i){t("UsuÃ¡rio nÃ£o estÃ¡ vinculado a uma empresa."),_([]);return}const{data:E,error:P}=await h.from("parametros_cambios").select("id, moeda, data, valor, created_at, owner_user_id, owner_user:owner_user_id (nome_completo)").eq("company_id",i).order("data",{ascending:!1}).order("created_at",{ascending:!1});if(P)throw P;_(E||[])}catch(a){console.error(a),t("NÃ£o foi possÃ­vel carregar os cÃ¢mbios.")}finally{v(!1)}},[]);r.useEffect(()=>{x()},[x]);const C=(a,s)=>{y(d=>({...d,[a]:s}))},A=async a=>{if(a.preventDefault(),!c||!g)return;t(null),u(null);const s=J(l.valor),d=l.moeda.trim();if(!d){t("Informe a moeda.");return}if(!l.data){t("Informe a data.");return}if(s==null){t("Informe um valor vÃ¡lido para o cÃ¢mbio.");return}U(!0);try{const m={company_id:g,owner_user_id:S,moeda:d,data:l.data,valor:s};let i=null;if(n?i=(await h.from("parametros_cambios").update(m).eq("id",n)).error:i=(await h.from("parametros_cambios").insert(m)).error,i)throw i;u(n?"CÃ¢mbio atualizado com sucesso.":"CÃ¢mbio salvo com sucesso."),L(),await x(),await k({user_id:S,acao:n?"parametros_cambios_atualizacao":"parametros_cambios_cadastro",modulo:"Parametros",detalhes:{id:n||null,moeda:d,data:l.data,valor:s}})}catch(m){console.error(m),t("NÃ£o foi possÃ­vel salvar o cÃ¢mbio.")}finally{U(!1)}},M=async a=>{if(N&&window.confirm("Deseja excluir este cÃ¢mbio?")){t(null),u(null),v(!0);try{const{error:s}=await h.from("parametros_cambios").delete().eq("id",a);if(s)throw s;u("CÃ¢mbio excluÃ­do."),await x(),await k({user_id:S,acao:"parametros_cambios_exclusao",modulo:"Parametros",detalhes:{id:a}})}catch(s){console.error(s),t("NÃ£o foi possÃ­vel excluir o cÃ¢mbio.")}finally{v(!1)}}},$=a=>{D(a.id),y({moeda:a.moeda,data:a.data,valor:a.valor!=null?a.valor.toFixed(2):""}),u(null),t(null)},O=r.useMemo(()=>p.length?`${p.length} cÃ¢mbio(s) registrado(s).`:"Nenhum cÃ¢mbio cadastrado.",[p]);return I||j?e.jsx(B,{}):b?e.jsxs("div",{className:"card-base",children:[e.jsx("h2",{className:"card-title",children:"CÃ¢mbios"}),e.jsx("p",{className:"card-subtitle",children:"Cadastre o valor de cÃ¢mbio aplicado em cada dia."}),F&&e.jsx("div",{className:"auth-error",children:F}),R&&e.jsx("div",{className:"auth-success",children:R}),e.jsxs("form",{onSubmit:A,className:"space-y-4",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Moeda"}),e.jsx("input",{type:"text",className:"form-input",list:"moeda-sugestoes",value:l.moeda,onChange:a=>C("moeda",a.target.value),disabled:!c}),e.jsx("datalist",{id:"moeda-sugestoes",children:G.map(a=>e.jsx("option",{value:a},a))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data"}),e.jsx("input",{type:"date",className:"form-input",value:l.data,onChange:a=>C("data",a.target.value),disabled:!c})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor (R$)"}),e.jsx("input",{type:"text",className:"form-input",inputMode:"decimal",placeholder:"Ex: 6,50",value:l.valor,onChange:a=>C("valor",a.target.value),disabled:!c})]}),e.jsxs("div",{className:"form-group",style:{display:"flex",alignItems:"flex-end",gap:8},children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:!c||w||!g,children:w?n?"Atualizando...":"Salvando...":n?"Atualizar cÃ¢mbio":"Salvar cÃ¢mbio"}),n&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:L,disabled:w,children:"Cancelar ediÃ§Ã£o"})]})]}),!g&&e.jsx("div",{className:"auth-error",children:"VocÃª precisa estar vinculado a uma empresa para cadastrar cÃ¢mbios."}),!c&&e.jsx("div",{style:{marginTop:8,color:"#f97316",fontSize:"0.9rem"},children:"VocÃª nÃ£o tem permissÃ£o para cadastrar ou remover cÃ¢mbios. Solicite acesso ao administrador."})]}),e.jsxs("div",{className:"table-container overflow-x-auto mt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("strong",{children:O}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:x,disabled:I,children:"Recarregar"})]}),e.jsxs("table",{className:"table-default table-header-blue min-w-[600px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Moeda"}),e.jsx("th",{children:"Valor (R$)"}),e.jsx("th",{children:"Cadastrado por"}),e.jsx("th",{children:"Criado em"}),N&&e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[p.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:N?6:5,children:"Nenhum cÃ¢mbio cadastrado ainda."})}),p.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data}),e.jsx("td",{children:a.moeda}),e.jsx("td",{children:K(a.valor)}),e.jsx("td",{children:a.owner_user?.nome_completo||a.owner_user_id||"â€”"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleString("pt-BR"):"â€”"}),e.jsx("td",{className:"th-actions",children:e.jsxs("div",{className:"action-buttons",children:[c&&e.jsx("button",{type:"button",className:"btn-icon",title:"Editar cÃ¢mbio",onClick:()=>$(a),children:"âœï¸"}),N&&e.jsx("button",{type:"button",className:"btn-icon btn-danger",title:"Excluir cÃ¢mbio",onClick:()=>M(a.id),children:"ğŸ—‘ï¸"})]})})]},a.id))]})]})]})]}):e.jsx("div",{children:"Acesso ao mÃ³dulo de ParÃ¢metros bloqueado."})}export{ae as default};
