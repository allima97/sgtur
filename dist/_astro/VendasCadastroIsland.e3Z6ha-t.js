import{s as l,j as t}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as me}from"./usePermissao.72SYthuA.js";import{r as X}from"./logs.WCvMC_es.js";function g(N){return(N||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const Z={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},fe={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function je(){const{permissao:N,ativo:$,loading:F,isAdmin:I}=me("Vendas"),T=N==="create"||N==="edit"||N==="delete"||N==="admin",[E,ee]=s.useState([]),[y,ae]=s.useState([]),[b,oe]=s.useState([]),[i,w]=s.useState(Z),[v,C]=s.useState([]),[u,te]=s.useState(null),[M,c]=s.useState(null),[A,x]=s.useState(!1),[pe,U]=s.useState(!0),[be,O]=s.useState(!1),[S,re]=s.useState(""),[m,k]=s.useState(""),[q,H]=s.useState(""),[se,D]=s.useState(!1),[W,V]=s.useState([]),[P,Y]=s.useState(!1),[G,B]=s.useState(null),[_e,ie]=s.useState("");async function de(e){try{U(!0);const[o,a,r]=await Promise.all([l.from("clientes").select("id, nome, cpf").order("nome"),l.from("cidades").select("id, nome").order("nome"),l.from("produtos").select("id, nome, cidade_id, tipo_produto").order("nome")]);ee(o.data||[]);const d=a.data||[];ae(d),oe(r.data||[]),e&&await J(e,d)}catch(o){console.error(o),c("Erro ao carregar dados.")}finally{U(!1)}}async function J(e,o){try{O(!0);const{data:a,error:r}=await l.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(r)throw r;if(!a){c("Venda nÃ£o encontrada para ediÃ§Ã£o.");return}let d="",f="";if(a.destino_id){const{data:n}=await l.from("produtos").select("id, cidade_id").eq("id",a.destino_id).maybeSingle();d=n?.cidade_id||"";const j=(o||y).find(z=>z.id===d);j&&(f=j.nome)}w({cliente_id:a.cliente_id,destino_id:d,data_lancamento:a.data_lancamento,data_embarque:a.data_embarque||""}),k(f),ie(f);const{data:h,error:p}=await l.from("vendas_recibos").select("*").eq("venda_id",e);if(p)throw p;C((h||[]).map(n=>({id:n.id,produto_id:b.find(_=>_.tipo_produto===n.produto_id&&(!d||_.cidade_id===d))?.id||"",numero_recibo:n.numero_recibo||"",valor_total:n.valor_total!=null?String(n.valor_total):"",valor_taxas:n.valor_taxas!=null?String(n.valor_taxas):"0"})))}catch(a){console.error(a),c("Erro ao carregar venda para ediÃ§Ã£o.")}finally{O(!1)}}s.useEffect(()=>{const o=new URLSearchParams(window.location.search).get("id");o&&te(o)},[]),s.useEffect(()=>{!F&&$&&de(u||void 0)},[F,$,u]),s.useEffect(()=>{if(m.trim().length<2){V([]);return}const e=new AbortController,o=setTimeout(async()=>{Y(!0),B(null);try{const{data:a,error:r}=await l.rpc("buscar_cidades",{q:m.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(r){console.error("Erro ao buscar cidades:",r),B("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:d,error:f}=await l.from("cidades").select("id, nome").ilike("nome",`%${m.trim()}%`).order("nome");f?(console.error("Erro no fallback de cidades:",f),B("Erro ao buscar cidades.")):(V(d||[]),B(null))}else V(a||[])}finally{e.signal.aborted||Y(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[m]);const L=e=>e.replace(/\D/g,""),K=s.useMemo(()=>{if(!S.trim())return E;const e=g(S);return E.filter(o=>{const a=L(o.cpf||"");return g(o.nome).includes(e)||a.includes(L(e))})},[E,S]);s.useMemo(()=>{if(!m.trim())return y;const e=g(m);return y.filter(o=>g(o.nome).includes(e))},[y,m]);const Q=s.useMemo(()=>{const e=i.destino_id?b.filter(a=>a.cidade_id===i.destino_id):[];if(!q.trim())return e;const o=g(q);return e.filter(a=>g(a.nome).includes(o))},[b,q,i.destino_id]);function ne(e){k(e);const o=y.find(a=>a.id===i.destino_id);(!o||!g(o.nome).includes(g(e)))&&w(a=>({...a,destino_id:""})),D(!0)}function le(){C(e=>[...e,{...fe}])}function R(e,o,a){C(r=>{const d=[...r];return d[e][o]=a,d})}s.useEffect(()=>{H(""),C(e=>e.map(o=>{const a=b.find(r=>r.id===o.produto_id);return a&&a.cidade_id===i.destino_id?o:{...o,produto_id:""}}))},[i.destino_id,b]);function ce(e){C(o=>o.filter((a,r)=>r!==e))}async function ue(e){if(e.preventDefault(),!T&&!I){c("VocÃª nÃ£o possui permissÃ£o para cadastrar vendas.");return}if(v.length===0){c("Uma venda precisa ter ao menos 1 recibo.");return}try{x(!0),c(null);const{data:o}=await l.auth.getUser(),a=o?.user?.id;if(!a){c("UsuÃ¡rio nÃ£o autenticado."),x(!1);return}if(!v.length){c("Uma venda precisa ter ao menos 1 recibo."),x(!1);return}const r=v[0]?.produto_id;if(!r){c("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),x(!1);return}const d=b.find(h=>h.id===r);if(!d||d.cidade_id!==i.destino_id){c("O produto do recibo precisa pertencer Ã  cidade de destino selecionada."),x(!1);return}if(!d.tipo_produto){c("O produto selecionado nÃ£o possui tipo vinculado. Cadastre um tipo de produto para ele."),x(!1);return}let f=u;if(u){const{error:h}=await l.from("vendas").update({cliente_id:i.cliente_id,destino_id:r,data_lancamento:i.data_lancamento,data_embarque:i.data_embarque||null}).eq("id",u);if(h)throw h;await l.from("vendas_recibos").delete().eq("venda_id",u);for(const p of v){const n=b.find(j=>j.id===p.produto_id);if(!n?.tipo_produto)throw new Error("Produto do recibo nÃ£o possui tipo vinculado.");const{error:_}=await l.from("vendas_recibos").insert({venda_id:u,produto_id:n.tipo_produto,numero_recibo:p.numero_recibo.trim(),valor_total:Number(p.valor_total),valor_taxas:Number(p.valor_taxas)});if(_)throw _}await X({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:u,venda:i,recibos:v}}),alert("Venda atualizada com sucesso!"),await J(u)}else{const{data:h,error:p}=await l.from("vendas").insert({vendedor_id:a,cliente_id:i.cliente_id,destino_id:r,data_lancamento:i.data_lancamento,data_embarque:i.data_embarque||null}).select().single();if(p)throw p;f=h.id;for(const n of v){const _=b.find(z=>z.id===n.produto_id);if(!_?.tipo_produto)throw new Error("Produto do recibo nÃ£o possui tipo vinculado.");const{error:j}=await l.from("vendas_recibos").insert({venda_id:f,produto_id:_.tipo_produto,numero_recibo:n.numero_recibo.trim(),valor_total:Number(n.valor_total),valor_taxas:Number(n.valor_taxas)});if(j)throw j}await X({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:i,recibos:v,id:f}}),alert("Venda cadastrada com sucesso!"),w(Z),C([])}}catch(o){console.error(o);const a=o?.message||o?.error?.message||"",r=o?.code||o?.error?.code||"";c(`Erro ao salvar venda.${r?` CÃ³digo: ${r}.`:""}${a?` Detalhes: ${a}`:""}`)}finally{x(!1)}}return $?!T&&!I?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"VocÃª nÃ£o possui permissÃ£o para cadastrar vendas."})}):t.jsx("div",{className:"vendas-cadastro-page",children:t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:u?"Editar venda":"Cadastro de Venda"}),u&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo ediÃ§Ã£o â€” altere cliente, cidade de destino, embarque e recibos."}),M&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:M})}),t.jsxs("form",{onSubmit:ue,children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:E.find(e=>e.id===i.cliente_id)?.nome||S,onChange:e=>re(e.target.value),onBlur:()=>{const e=S.toLowerCase(),o=L(S),a=K.find(r=>{const d=L(r.cpf||"");return r.nome.toLowerCase()===e||o&&d===o});a&&w({...i,cliente_id:a.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:K.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group",style:{position:"relative"},children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:m,onChange:e=>ne(e.target.value),onFocus:()=>D(!0),onBlur:()=>setTimeout(()=>D(!1),150),required:!0,style:{marginBottom:6}}),P&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),G&&!P&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:G}),se&&(P||m.trim().length>=2)&&t.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb",position:"absolute",zIndex:5,width:"100%",background:"#fff"},children:[W.length===0&&!P&&m.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),W.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:i.destino_id===e.id?"#e0f2fe":"#fff",borderColor:i.destino_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:a=>{a.preventDefault(),w(r=>({...r,destino_id:e.id})),k(o),D(!1),V([])},children:[o,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["â€¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:i.data_embarque,onChange:e=>w({...i,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),v.map((e,o)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:"Selecione uma cidade primeiro e busque o produto...",value:b.find(a=>a.id===e.produto_id)?.nome||q,onChange:a=>H(a.target.value),onBlur:()=>{const a=Q.find(r=>r.nome.toLowerCase()===q.toLowerCase());a&&R(o,"produto_id",a.id)},required:!0,disabled:!i.destino_id}),t.jsx("datalist",{id:`listaProdutos-${o}`,children:Q.map(a=>t.jsx("option",{value:a.nome},a.id))})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"NÃºmero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>R(o,"numero_recibo",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_total,onChange:a=>R(o,"valor_total",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_taxas,onChange:a=>R(o,"valor_taxas",a.target.value)})]}),t.jsx("div",{className:"form-group",style:{width:"80px"},children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>ce(o),children:"ğŸ—‘ï¸"})})]})},o)),t.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:le,children:"â• Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:A,children:A?"Salvando...":"Salvar venda"})]})]})]})}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Vendas."})})}export{je as default};
