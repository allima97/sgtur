import{j as o}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as u}from"./supabase.Ng8nq9tn.js";import{u as Qe}from"./usePermissao.DiLe8-Rs.js";import{r as Pe}from"./logs.DwCrXgEk.js";function L(f){return(f||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const fe={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Xe={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0",data_inicio:"",data_fim:""};function Ye(f){const g=f.replace(/\D/g,"");return g?(Number(g)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function Le(f){const g=Number(f);return Number.isNaN(g)?"":g.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function Fe(f){if(!f)return NaN;const g=f.replace(/\./g,"").replace(",",".");return Number(g)}function Ze(f,g){if(!f)return"planejada";const R=new Date;R.setHours(0,0,0,0);const Y=new Date(f),F=g?new Date(g):null;return F&&F<R?"concluida":Y>R?"confirmada":F&&R>F?"concluida":"em_viagem"}function ca(){const{permissao:f,ativo:g,loading:R,isAdmin:Y}=Qe("Vendas"),F=f==="create"||f==="edit"||f==="delete"||f==="admin",[Z,Te]=r.useState([]),[T,Be]=r.useState([]),[h,ee]=r.useState([]),[pe,$e]=r.useState([]),[s,B]=r.useState(fe),[x,$]=r.useState([]),[S,se]=r.useState(null),[_e,ne]=r.useState({id:"",nome:""}),[be,w]=r.useState(null),[ve,M]=r.useState(!1),[ea,ge]=r.useState(!0),[aa,he]=r.useState(!1),[xe,we]=r.useState([]),[oa,Me]=r.useState(0),[k,ce]=r.useState(""),[E,W]=r.useState(""),[H,ae]=r.useState(""),[ke,oe]=r.useState(!1),[Ne,z]=r.useState([]),[te,je]=r.useState(!1),[Se,ie]=r.useState(null),[ta,le]=r.useState("");async function ze(e,t){try{ge(!0);const[a,d,c,N]=await Promise.all([u.from("clientes").select("id, nome, cpf").order("nome"),u.from("cidades").select("id, nome").order("nome"),u.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").order("nome"),u.from("tipo_produtos").select("id, nome")]);Te(a.data||[]);const b=d.data||[];Be(b);const V=N.data||[],G=(c.data||[]).map(D=>({...D,todas_as_cidades:D.todas_as_cidades??!1}));ee(G),$e(V),e&&await Ge(e,b,G,t)}catch(a){console.error(a),w("Erro ao carregar dados."),y("Erro ao carregar dados.","error")}finally{ge(!1)}}async function Ge(e,t,a,d){try{he(!0);const{data:c,error:N}=await u.from("vendas").select("id, cliente_id, destino_id, destino_cidade_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(N)throw N;if(!c){w("Venda n√£o encontrada para edi√ß√£o.");return}let b=c.destino_cidade_id||"",V="";if(b){const C=(t||T).find(j=>j.id===b);C&&(V=C.nome)}else if(c.destino_id){const{data:p}=await u.from("produtos").select("id, cidade_id").eq("id",c.destino_id).maybeSingle();b=p?.cidade_id||"";const j=(t||T).find(ue=>ue.id===b);j&&(V=j.nome)}!b&&d?.id&&(b=d.id),!V&&d?.nome&&(V=d.nome),B({cliente_id:c.cliente_id,destino_id:b,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||""}),W(V||b||""),le(V||b||"");const{data:G,error:D}=await u.from("vendas_recibos").select("*").eq("venda_id",e);if(D)throw D;const re=a||h;$((G||[]).map(p=>({id:p.id,produto_id:re.find(C=>{const j=!!C.todas_as_cidades;return C.tipo_produto===p.produto_id&&(j||!b||C.cidade_id===b)})?.id||"",numero_recibo:p.numero_recibo||"",valor_total:p.valor_total!=null?Le(p.valor_total):"",valor_taxas:p.valor_taxas!=null?Le(p.valor_taxas):"0,00",data_inicio:p.data_inicio||"",data_fim:p.data_fim||""})))}catch(c){console.error(c),w("Erro ao carregar venda para edi√ß√£o."),y("Erro ao carregar venda para edi√ß√£o.","error")}finally{he(!1)}}r.useEffect(()=>{const e=new URLSearchParams(window.location.search),t=e.get("id");t&&se(t);const a=e.get("cidadeId")||"",d=e.get("cidadeNome")||"";(a||d)&&ne({id:a,nome:d})},[]),r.useEffect(()=>{!R&&g&&ze(S||void 0,_e)},[R,g,S,_e]),r.useEffect(()=>{if(E.trim().length<2){z([]);return}const e=new AbortController,t=setTimeout(async()=>{je(!0),ie(null);try{const{data:a,error:d}=await u.rpc("buscar_cidades",{q:E.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(d){console.error("Erro ao buscar cidades:",d),ie("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:c,error:N}=await u.from("cidades").select("id, nome").ilike("nome",`%${E.trim()}%`).order("nome");N?(console.error("Erro no fallback de cidades:",N),ie("Erro ao buscar cidades.")):(z(c||[]),ie(null))}else z(a||[])}finally{e.signal.aborted||je(!1)}},300);return()=>{e.abort(),clearTimeout(t)}},[E]);const de=e=>e.replace(/\D/g,""),ye=r.useMemo(()=>{if(!k.trim())return Z;const e=L(k);return Z.filter(t=>{const a=de(t.cpf||"");return L(t.nome).includes(e)||a.includes(de(e))})},[Z,k]);r.useMemo(()=>{if(!E.trim())return T;const e=L(E);return T.filter(t=>L(t.nome).includes(e))},[T,E]);const Ce=r.useMemo(()=>{const e=s.destino_id?h.filter(a=>a.todas_as_cidades||a.cidade_id===s.destino_id):h.filter(a=>a.todas_as_cidades);if(!H.trim())return e;const t=L(H);return e.filter(a=>L(a.nome).includes(t))},[h,H,s.destino_id]),Ee=r.useMemo(()=>h.some(e=>!!e.todas_as_cidades),[h]),Ae=r.useMemo(()=>x.length>0,[x.length]);function Ue(e){W(e);const t=T.find(a=>a.id===s.destino_id);(!t||!L(t.nome).includes(L(e)))&&B(a=>({...a,destino_id:""})),oe(!0)}function y(e,t="success"){Me(a=>{const d=a+1;return we(c=>[...c,{id:d,message:e,type:t}]),setTimeout(()=>{we(c=>c.filter(N=>N.id!==d))},3500),d})}function Oe(){$(e=>[...e,{...Xe}])}function J(e,t,a){$(d=>{const c=[...d];return c[e][t]=a,c})}function De(e,t,a){const d=Ye(a);J(e,t,d)}r.useEffect(()=>{ae(""),$(e=>e.map(t=>{const a=h.find(c=>c.id===t.produto_id),d=!!a?.todas_as_cidades;return a&&(d||a.cidade_id===s.destino_id)?t:{...t,produto_id:""}}))},[s.destino_id,h]);function We(e){$(t=>t.filter((a,d)=>d!==e))}function Ie(){B({...fe,data_lancamento:new Date().toISOString().substring(0,10)}),$([]),se(null),ne({id:"",nome:""}),ce(""),W(""),ae(""),le(""),z([]),w(null),window.location.href="/vendas/consulta"}function He(){B(fe),$([]),se(null),ne({id:"",nome:""}),ce(""),W(""),ae(""),le(""),z([]),w(null),window.location.href="/vendas/consulta"}async function Je(e){if(e.preventDefault(),!F&&!Y){w("Voc√™ n√£o possui permiss√£o para cadastrar vendas."),y("Voc√™ n√£o possui permiss√£o para cadastrar vendas.","error");return}if(x.length===0){w("Uma venda precisa ter ao menos 1 recibo."),y("Inclua ao menos um recibo na venda.","error");return}try{M(!0),w(null);const{data:t}=await u.auth.getUser(),a=t?.user?.id;if(!a){w("Usu√°rio n√£o autenticado."),y("Usu√°rio n√£o autenticado.","error"),M(!1);return}const{data:d,error:c}=await u.from("users").select("company_id").eq("id",a).maybeSingle();if(c)throw c;const N=d?.company_id;if(!N)throw new Error("Seu usu√°rio precisa estar vinculado a uma empresa para cadastrar viagens.");if(!x.length){w("Uma venda precisa ter ao menos 1 recibo."),y("Inclua ao menos um recibo na venda.","error"),M(!1);return}if(!x[0]?.produto_id){w("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),y("Selecione um produto para o recibo principal.","error"),M(!1);return}if(x.some(i=>{const n=h.find(m=>m.id===i.produto_id),l=!!n?.todas_as_cidades||(i.produto_id||"").startsWith("virtual-");return n?.cidade_id&&!l})&&!s.destino_id){w("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),y("Selecione a cidade de destino.","error"),M(!1);return}async function G(i){const n=i.produto_id,l=h.find(_=>_.id===n);if(l&&!l.isVirtual)return l.id;const m=l?.tipo_produto||(n?.startsWith("virtual-")?n.replace("virtual-",""):l?.tipo_produto);if(!m)throw new Error("Produto inv√°lido. Selecione novamente.");const I=s.destino_id;if(!I)throw new Error("Selecione a cidade de destino para usar produtos globais.");const A=pe.find(_=>_.id===m),U=!!l?.todas_as_cidades,P=h.find(_=>_.tipo_produto===m&&_.cidade_id===I&&!_.todas_as_cidades);if(P)return P.id;if(U){const _=h.find(O=>O.tipo_produto===m&&!!O.todas_as_cidades);if(_)return _.id;const{data:q,error:Ve}=await u.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").eq("tipo_produto",m).eq("todas_as_cidades",!0).limit(1).maybeSingle();if(Ve)throw Ve;if(q?.id)return ee(O=>O.some(Ke=>Ke.id===q.id)?O:[...O,{id:q.id,nome:q.nome,cidade_id:q.cidade_id,tipo_produto:q.tipo_produto,todas_as_cidades:!!q.todas_as_cidades}]),q.id;throw new Error("Produto global selecionado n√£o possui cadastro na tabela de Produtos; cadastre o servi√ßo como global antes de continuar.")}const{data:v,error:K}=await u.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").eq("tipo_produto",m).eq("cidade_id",I).limit(1).maybeSingle();if(K)throw K;if(v?.id)return ee(_=>_.some(q=>q.id===v.id)?_:[..._,{id:v.id,nome:v.nome,cidade_id:v.cidade_id,tipo_produto:v.tipo_produto,todas_as_cidades:!!v.todas_as_cidades}]),v.id;const Q=A?.nome||"Produto",{data:X,error:Re}=await u.from("produtos").insert({nome:Q,destino:Q,cidade_id:I,tipo_produto:m,ativo:!0,todas_as_cidades:!1}).select("id").single();if(Re)throw Re;const me=X?.id;if(me)return ee(_=>[..._,{id:me,nome:Q,cidade_id:I,tipo_produto:m,todas_as_cidades:!1}]),me;throw new Error("N√£o foi poss√≠vel criar produto local.")}const D=[];for(const i of x){const n=await G(i);D.push(n)}const re=D[0];let p=[];if(S){const{data:i,error:n}=await u.from("vendas_recibos").select("id").eq("venda_id",S);if(n)throw n;p=(i||[]).map(l=>l.id).filter(Boolean)}const C=i=>T.find(n=>n.id===i)?.nome||"";let j=S;async function ue(i){if(!i.reciboId)return;if(!j)throw new Error("Venda n√£o encontrada ao criar viagem.");const n=Ze(i.dataInicio,i.dataFim),l=i.cidade||C(s.destino_id),m=i.produtoNome||i.tipoNome||l||null,I=l&&l!==m?l:i.produtoNome||i.tipoNome||m,{data:A,error:U}=await u.from("viagens").insert({company_id:N,venda_id:j,recibo_id:i.reciboId,cliente_id:s.cliente_id,responsavel_user_id:a,origem:I||null,destino:m||null,data_inicio:i.dataInicio||null,data_fim:i.dataFim||null,status:n,observacoes:i.numeroRecibo?`Recibo ${i.numeroRecibo}`:null}).select("id").single();if(U)throw U;const P=A?.id;if(!P)return;const{error:v}=await u.from("viagem_passageiros").insert({viagem_id:P,cliente_id:s.cliente_id,company_id:N,papel:"passageiro",created_by:a});if(v)throw v}async function qe(i,n){if(!j)throw new Error("Venda n√£o encontrada ao salvar recibo.");const l=h.find(X=>X.id===n),m=l?.tipo_produto||(i.produto_id?.startsWith("virtual-")?i.produto_id.replace("virtual-",""):l?.tipo_produto);if(!m)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const I=Fe(i.valor_total),A=Fe(i.valor_taxas);if(Number.isNaN(I))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(A))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const U=pe.find(X=>X.id===m)?.nome||l?.nome||"",P={venda_id:j,produto_id:m,numero_recibo:i.numero_recibo.trim(),valor_total:I,valor_taxas:A,data_inicio:i.data_inicio||null,data_fim:i.data_fim||null},{data:v,error:K}=await u.from("vendas_recibos").insert(P).select("id, data_inicio, data_fim").single();if(K)throw K;const Q=C(s.destino_id)||C(l?.cidade_id);await ue({reciboId:v?.id,dataInicio:v?.data_inicio||null,dataFim:v?.data_fim||null,tipoNome:U,produtoNome:l?.nome,numeroRecibo:P.numero_recibo,cidade:Q||void 0})}if(S){const{error:i}=await u.from("vendas").update({cliente_id:s.cliente_id,destino_id:re,destino_cidade_id:s.destino_id||null,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).eq("id",S);if(i)throw i;if(p.length>0){const{error:n}=await u.from("viagens").delete().in("recibo_id",p);if(n)throw n}await u.from("vendas_recibos").delete().eq("venda_id",S);for(let n=0;n<x.length;n++)await qe(x[n],D[n]);await Pe({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:S,venda:s,recibos:x}}),y("Venda atualizada com sucesso!","success"),setTimeout(()=>Ie(),200)}else{const{data:i,error:n}=await u.from("vendas").insert({vendedor_id:a,cliente_id:s.cliente_id,destino_id:re,destino_cidade_id:s.destino_id||null,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).select().single();if(n)throw n;j=i.id;for(let l=0;l<x.length;l++)await qe(x[l],D[l]);await Pe({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:s,recibos:x,id:j}}),y("Venda cadastrada com sucesso!","success"),setTimeout(()=>Ie(),200)}}catch(t){console.error(t);const a=t?.message||t?.error?.message||"",d=t?.code||t?.error?.code||"";w(`Erro ao salvar venda.${d?` C√≥digo: ${d}.`:""}${a?` Detalhes: ${a}`:""}`),y("Erro ao salvar venda.","error")}finally{M(!1)}}return g?!F&&!Y?o.jsx("div",{className:"card-base card-config",children:o.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):o.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[o.jsxs("div",{className:"card-base card-green mb-3",children:[o.jsx("h3",{children:S?"Editar venda":"Cadastro de Venda"}),S&&o.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),be&&o.jsx("div",{className:"card-base card-config mb-3",children:o.jsx("strong",{children:be})}),o.jsxs("form",{onSubmit:Je,children:[o.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[o.jsxs("div",{className:"form-group flex-1 min-w-[220px]",children:[o.jsx("label",{className:"form-label",children:"Cliente *"}),o.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:Z.find(e=>e.id===s.cliente_id)?.nome||k,onChange:e=>ce(e.target.value),onBlur:()=>{const e=k.toLowerCase(),t=de(k),a=ye.find(d=>{const c=de(d.cpf||"");return d.nome.toLowerCase()===e||t&&c===t});a&&B({...s,cliente_id:a.id})},required:!0}),o.jsx("datalist",{id:"listaClientes",children:ye.map(e=>o.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[220px] relative",children:[o.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),o.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:E,onChange:e=>Ue(e.target.value),onFocus:()=>oe(!0),onBlur:()=>setTimeout(()=>oe(!1),150),required:Ae,style:{marginBottom:6}}),te&&o.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),Se&&!te&&o.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:Se}),ke&&(te||E.trim().length>=2)&&o.jsxs("div",{className:"card-base absolute left-0 right-0 mt-1 max-h-44 overflow-y-auto p-1 border border-slate-200 bg-white z-10",children:[Ne.length===0&&!te&&E.trim().length>=2&&o.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),Ne.map(e=>{const t=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return o.jsxs("button",{type:"button",className:`btn btn-light w-full justify-start mb-1 ${s.destino_id===e.id?"bg-sky-100 border-sky-400":"bg-white border-slate-200"}`,onMouseDown:a=>{a.preventDefault(),B(d=>({...d,destino_id:e.id})),W(t),oe(!1),z([])},children:[t,e.pais_nome?o.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[o.jsx("label",{className:"form-label",children:"Data de embarque"}),o.jsx("input",{className:"form-input",type:"date",value:s.data_embarque,onChange:e=>B({...s,data_embarque:e.target.value})})]})]}),o.jsx("h4",{className:"mt-3 font-semibold text-lg",children:"Recibos da Venda"}),x.map((e,t)=>o.jsx("div",{className:"card-base mb-2",children:o.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[o.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[o.jsx("label",{className:"form-label",children:"Produto *"}),o.jsx("input",{className:"form-input",list:`listaProdutos-${t}`,placeholder:Ee?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:h.find(a=>a.id===e.produto_id)?.nome||H,onChange:a=>ae(a.target.value),onBlur:()=>{const a=Ce.find(d=>d.nome.toLowerCase()===H.toLowerCase());a&&J(t,"produto_id",a.id)},required:!0,disabled:!s.destino_id&&!Ee}),o.jsx("datalist",{id:`listaProdutos-${t}`,children:Ce.map(a=>o.jsx("option",{value:a.nome},a.id))})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[o.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),o.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>J(t,"numero_recibo",a.target.value),required:!0})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[160px]",children:[o.jsx("label",{className:"form-label",children:"In√≠cio *"}),o.jsx("input",{className:"form-input",type:"date",value:e.data_inicio,onChange:a=>J(t,"data_inicio",a.target.value),required:!0})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[160px]",children:[o.jsx("label",{className:"form-label",children:"Fim *"}),o.jsx("input",{className:"form-input",type:"date",value:e.data_fim,onChange:a=>J(t,"data_fim",a.target.value),required:!0})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[o.jsx("label",{className:"form-label",children:"Valor total *"}),o.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:a=>De(t,"valor_total",a.target.value),required:!0})]}),o.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[o.jsx("label",{className:"form-label",children:"Taxas"}),o.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:a=>De(t,"valor_taxas",a.target.value)})]}),o.jsx("div",{className:"form-group flex-none w-20 flex items-end",children:o.jsx("button",{type:"button",className:"btn-icon btn-danger mt-2",onClick:()=>We(t),children:"üóëÔ∏è"})})]})},t)),o.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[o.jsx("button",{type:"button",className:"btn btn-primary",onClick:Oe,children:"‚ûï Adicionar recibo"}),o.jsx("button",{type:"submit",className:"btn btn-success",disabled:ve,children:ve?"Salvando...":"Salvar venda"}),o.jsx("button",{type:"button",className:"btn btn-outline bg-slate-100 text-slate-800",onClick:He,children:"Cancelar"})]})]})]}),xe.length>0&&o.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:xe.map(e=>o.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):o.jsx("div",{className:"card-base card-config",children:o.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{ca as default};
