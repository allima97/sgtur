import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as d}from"./supabase.Ng8nq9tn.js";import{u as fe}from"./usePermissao.DEV7Ufch.js";import{t as z}from"./titleCase.DQLlfrnh.js";function se(o){return(o||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function Ne(){const{permissao:o,ativo:oe,loading:ie}=fe("Parametros"),[N,te]=i.useState([]),[S,L]=i.useState(!0),[U,c]=i.useState(null),[v,re]=i.useState(""),[_,W]=i.useState(null),[$,O]=i.useState(null),[H,ne]=i.useState([]),[f,le]=i.useState({}),[j,b]=i.useState(""),[w,C]=i.useState(""),[y,E]=i.useState(""),[k,M]=i.useState(""),[p,D]=i.useState(!1),[J,R]=i.useState(""),[Q,T]=i.useState(""),[X,A]=i.useState(!0),[Y,I]=i.useState(!0),[q,de]=i.useState(!0),[t,F]=i.useState({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0});function x(a,s){F(u=>{if(a==="nome"){const l=String(s);return{...u,nome:l,tipo:u.tipo||l}}return{...u,[a]:s}})}async function K(){try{L(!0),c(null);const[{data:a,error:s},u,l,V]=await Promise.all([d.from("tipo_produtos").select("*").order("nome",{ascending:!0}),d.from("commission_rule").select("id, nome, tipo").eq("ativo",!0).order("nome"),d.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta"),d.from("tipo_produtos").select("exibe_kpi_comissao").limit(1)]);if(s)throw s;const B=!V.error;de(B),te(a||[]),ne(u.data||[]);const r={};l.data?.forEach(n=>{r[n.produto_id]={rule_id:n.rule_id||"",fix_meta_nao_atingida:n.fix_meta_nao_atingida,fix_meta_atingida:n.fix_meta_atingida,fix_super_meta:n.fix_super_meta}}),le(r)}catch(a){console.error(a),c("Erro ao carregar tipos de produto.")}finally{L(!1)}}i.useEffect(()=>{K()},[]);function Z(){F({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0}),D(!1),R(""),T(""),A(!0),I(!0),b(""),C(""),E(""),M(""),W(null),c(null)}function ce(a){W(a.id),F({nome:a.nome||a.tipo,tipo:a.tipo||a.nome||"",regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,disponivel_todas_cidades:!!a.disponivel_todas_cidades,ativo:a.ativo}),D(!!a.usa_meta_produto),R(a.meta_produto_valor!==null&&a.meta_produto_valor!==void 0?String(a.meta_produto_valor):""),T(a.comissao_produto_meta_pct!==null&&a.comissao_produto_meta_pct!==void 0?String(a.comissao_produto_meta_pct):""),A(a.descontar_meta_geral!==null&&a.descontar_meta_geral!==void 0?!!a.descontar_meta_geral:!0),I(a.exibe_kpi_comissao!==null&&a.exibe_kpi_comissao!==void 0?!!a.exibe_kpi_comissao:!0);const s=f[a.id]||{};b(s.rule_id||""),C(s.fix_meta_nao_atingida!==null&&s.fix_meta_nao_atingida!==void 0?String(s.fix_meta_nao_atingida):""),E(s.fix_meta_atingida!==null&&s.fix_meta_atingida!==void 0?String(s.fix_meta_atingida):""),M(s.fix_super_meta!==null&&s.fix_super_meta!==void 0?String(s.fix_super_meta):"")}async function me(a){if(a.preventDefault(),o==="view"){c("VocÃª nÃ£o tem permissÃ£o para salvar tipos de produto.");return}const s=z(t.nome),u=z(t.tipo||s);if(!s){c("Nome Ã© obrigatÃ³rio.");return}if(t.regra_comissionamento==="geral"&&!j){c("Selecione uma regra de comissÃ£o para produtos do tipo 'geral'.");return}const l=r=>r.trim()===""?null:Number(r),V=l(J),B=l(Q);if(t.regra_comissionamento==="diferenciado"){const r=l(w),n=l(y),m=l(k);if(r===null||isNaN(r)||n===null||isNaN(n)||m===null||isNaN(m)){c("Preencha os percentuais fixos para meta nÃ£o atingida, atingida e super meta (apenas nÃºmeros).");return}}try{c(null);const r={nome:s,tipo:u,regra_comissionamento:t.regra_comissionamento,soma_na_meta:t.soma_na_meta,disponivel_todas_cidades:t.disponivel_todas_cidades,ativo:t.ativo,usa_meta_produto:p,meta_produto_valor:p?V:null,comissao_produto_meta_pct:p?B:null,descontar_meta_geral:X};q&&(r.exibe_kpi_comissao=Y);let n=_;if(_){const{error:m}=await d.from("tipo_produtos").update(r).eq("id",_);if(m)throw m}else{const{data:m,error:g}=await d.from("tipo_produtos").insert(r).select("id").single();if(g)throw g;n=m?.id||null}if(n){async function m(){const h="ComissÃ£o Fixa (auto)",{data:ee}=await d.from("commission_rule").select("id").eq("nome",h).maybeSingle();if(ee?.id)return ee.id;const{data:_e,error:ae}=await d.from("commission_rule").insert({nome:h,descricao:"Gerada automaticamente para produtos diferenciados sem regra vinculada.",tipo:"GERAL",meta_nao_atingida:0,meta_atingida:0,super_meta:0,ativo:!0}).select("id").single();if(ae)throw ae;return _e?.id}const g=t.regra_comissionamento==="diferenciado"?l(w):null,pe=t.regra_comissionamento==="diferenciado"?l(y):null,xe=t.regra_comissionamento==="diferenciado"?l(k):null;let G=j||f[n]?.rule_id||null;if(t.regra_comissionamento==="diferenciado"&&!G&&(G=await m()),j||t.regra_comissionamento==="diferenciado"){const{error:h}=await d.from("product_commission_rule").upsert({produto_id:n,rule_id:G,ativo:!0,fix_meta_nao_atingida:g,fix_meta_atingida:pe,fix_super_meta:xe},{onConflict:"produto_id"});if(h)throw h}else await d.from("product_commission_rule").delete().eq("produto_id",n)}Z(),await K()}catch(r){console.error(r),c(r instanceof Error?`Erro ao salvar tipo de produto: ${r.message}`:"Erro ao salvar tipo de produto.")}}async function ue(a){if(o!=="admin"){alert("Somente administradores podem excluir tipos de produto.");return}if(confirm("Tem certeza que deseja excluir este tipo de produto?"))try{O(a);const{error:s}=await d.from("tipo_produtos").delete().eq("id",a);if(s)throw s;await K()}catch(s){console.error(s),c("Erro ao excluir tipo de produto. Talvez esteja vinculado a vendas/recibos.")}finally{O(null)}}const P=i.useMemo(()=>{if(!v.trim())return N;const a=se(v);return N.filter(s=>se(s.nome||s.tipo||"").includes(a))},[v,N]);return ie?e.jsx("div",{children:"Carregando permissÃµes..."}):oe?e.jsxs("div",{className:"produtos-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:me,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:t.nome,onChange:a=>x("nome",a.target.value),onBlur:a=>x("nome",z(a.target.value)),disabled:o==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Modelo de comissÃ£o"}),e.jsxs("select",{className:"form-input",value:t.regra_comissionamento,onChange:a=>{const s=a.target.value;x("regra_comissionamento",s),s==="diferenciado"&&b("")},disabled:o==="view",children:[e.jsx("option",{value:"geral",children:"Geral (usa regra cadastrada)"}),e.jsx("option",{value:"diferenciado",children:"Diferenciado (percentual fixo)"})]})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Soma na meta?"}),e.jsxs("select",{className:"form-input",value:t.soma_na_meta?"1":"0",onChange:a=>x("soma_na_meta",a.target.value==="1"),disabled:o==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DisponÃ­vel para todas as cidades?"}),e.jsxs("select",{className:"form-input",value:t.disponivel_todas_cidades?"1":"0",onChange:a=>x("disponivel_todas_cidades",a.target.value==="1"),disabled:o==="view",children:[e.jsx("option",{value:"0",children:"NÃ£o"}),e.jsx("option",{value:"1",children:"Sim"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-input",value:t.ativo?"1":"0",onChange:a=>x("ativo",a.target.value==="1"),disabled:o==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]})]}),e.jsxs("div",{className:"card-base card-blue",style:{marginTop:12},children:[e.jsx("h4",{style:{marginBottom:8},children:"Meta especÃ­fica do produto (opcional)"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Usar meta especÃ­fica?"}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:p,onChange:a=>D(a.target.checked),disabled:o==="view"}),e.jsx("span",{children:"Sim"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Exibe KPI com comissÃ£o especÃ­fica?"}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:Y,onChange:a=>I(a.target.checked),disabled:o==="view"||!q}),e.jsx("span",{children:"Sim"})]}),!q&&e.jsx("small",{style:{color:"#dc2626"},children:"Adicione a coluna exibe_kpi_comissao em tipo_produtos para ativar este controle."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta do produto (R$)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",min:"0",value:J,onChange:a=>R(a.target.value),disabled:!p||o==="view",placeholder:"Ex: 1000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"% ao bater a meta do produto"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",min:"0",value:Q,onChange:a=>T(a.target.value),disabled:!p||o==="view",placeholder:"Ex: 10 (para 10%)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Descontar comissÃ£o da meta geral?"}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:X,onChange:a=>A(a.target.checked),disabled:o==="view"}),e.jsx("span",{children:"Sim"})]})]})]}),e.jsx("small",{style:{color:"#475569"},children:'Se ativado, o produto paga a comissÃ£o da meta prÃ³pria (ex.: 10%); se "Descontar meta geral" estiver ligado, subtrai o que jÃ¡ foi pago pela meta geral para evitar duplicidade.'})]}),t.regra_comissionamento==="geral"&&e.jsxs("div",{className:"form-group",style:{marginTop:8},children:[e.jsx("label",{className:"form-label",children:"Regra de ComissÃ£o *"}),e.jsxs("select",{className:"form-input",value:j,onChange:a=>b(a.target.value),disabled:o==="view",required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),H.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.tipo,")"]},a.id))]})]}),t.regra_comissionamento==="diferenciado"&&e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta nÃ£o atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:w,onChange:a=>C(a.target.value),disabled:o==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:y,onChange:a=>E(a.target.value),disabled:o==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (super meta) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:k,onChange:a=>M(a.target.value),disabled:o==="view"})]})]}),o!=="view"&&e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",type:"submit",children:_?"Salvar alteraÃ§Ãµes":"Adicionar tipo"}),_&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:Z,children:"Cancelar ediÃ§Ã£o"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar tipo de produto"}),e.jsx("input",{className:"form-input",value:v,onChange:a=>re(a.target.value),placeholder:"Digite parte do nome..."})]})}),U&&e.jsx("div",{className:"card-base card-config mb-3",children:U}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Regra"}),e.jsx("th",{children:"Regra vinculada"}),e.jsx("th",{children:"Soma meta"}),e.jsx("th",{children:"Todas cidades"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[S&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando tipos de produto..."})}),!S&&P.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhum tipo encontrado."})}),!S&&P.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome||a.tipo}),e.jsx("td",{children:a.regra_comissionamento}),e.jsx("td",{children:f[a.id]?.rule_id?H.find(s=>s.id===f[a.id]?.rule_id)?.nome||"-":f[a.id]?.fix_meta_atingida?"ComissÃ£o fixa":"-"}),e.jsx("td",{children:a.soma_na_meta?"Sim":"NÃ£o"}),e.jsx("td",{children:a.disponivel_todas_cidades?"Sim":"NÃ£o"}),e.jsx("td",{style:{color:a.ativo?"#22c55e":"#ef4444"},children:a.ativo?"Ativo":"Inativo"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{className:"th-actions",children:[o!=="view"&&e.jsx("button",{className:"btn-icon",onClick:()=>ce(a),children:"âœï¸"}),o==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>ue(a.id),disabled:$===a.id,children:$===a.id?"...":"ğŸ—‘ï¸"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"VocÃª nÃ£o possui acesso ao mÃ³dulo de ParÃ¢metros."})}export{Ne as default};
