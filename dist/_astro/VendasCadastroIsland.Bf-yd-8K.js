import{s as p,j as t}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as Pe}from"./usePermissao.72SYthuA.js";import{r as he}from"./logs.WCvMC_es.js";function V(b){return(b||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const oe={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Le={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function Re(b){const x=b.replace(/\D/g,"");return x?(Number(x)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function ge(b){const x=Number(b);return Number.isNaN(x)?"":x.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function Y(b){if(!b)return NaN;const x=b.replace(/\./g,"").replace(",",".");return Number(x)}function Ge(){const{permissao:b,ativo:x,loading:z,isAdmin:ae}=Pe("Vendas"),te=b==="create"||b==="edit"||b==="delete"||b==="admin",[G,xe]=r.useState([]),[M,Ne]=r.useState([]),[f,ie]=r.useState([]),[J,we]=r.useState([]),[l,q]=r.useState(oe),[_,I]=r.useState([]),[w,K]=r.useState(null),[de,Q]=r.useState({id:"",nome:""}),[se,h]=r.useState(null),[re,R]=r.useState(!1),[Te,ne]=r.useState(!0),[Be,le]=r.useState(!1),[T,X]=r.useState(""),[j,F]=r.useState(""),[$,A]=r.useState(""),[je,U]=r.useState(!1),[ce,B]=r.useState([]),[W,ue]=r.useState(!1),[me,O]=r.useState(null),[Me,Z]=r.useState("");async function Ce(e,o){try{ne(!0);const[a,i,c,N]=await Promise.all([p.from("clientes").select("id, nome, cpf").order("nome"),p.from("cidades").select("id, nome").order("nome"),p.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").order("nome"),p.from("tipo_produtos").select("id, nome, disponivel_todas_cidades")]);xe(a.data||[]);const s=i.data||[];Ne(s);const g=N.data||[],y=new Map(g.map(n=>[n.id,n])),m=(c.data||[]).map(n=>{const d=n.tipo_produtos;return{...n,tipo_info:d?{disponivel_todas_cidades:d.disponivel_todas_cidades}:y.has(n.tipo_produto)?{disponivel_todas_cidades:y.get(n.tipo_produto||"")?.disponivel_todas_cidades}:void 0}});ie(m),we(g),e&&await Se(e,s,m,o)}catch(a){console.error(a),h("Erro ao carregar dados.")}finally{ne(!1)}}async function Se(e,o,a,i){try{le(!0);const{data:c,error:N}=await p.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(N)throw N;if(!c){h("Venda n√£o encontrada para edi√ß√£o.");return}let s="",g="";if(c.destino_id){const{data:d}=await p.from("produtos").select("id, cidade_id").eq("id",c.destino_id).maybeSingle();s=d?.cidade_id||"";const v=(o||M).find(C=>C.id===s);v&&(g=v.nome)}!s&&i?.id&&(s=i.id),!g&&i?.nome&&(g=i.nome),q({cliente_id:c.cliente_id,destino_id:s,data_lancamento:c.data_lancamento,data_embarque:c.data_embarque||""}),F(g||s||""),Z(g||s||"");const{data:y,error:m}=await p.from("vendas_recibos").select("*").eq("venda_id",e);if(m)throw m;const n=a||f;I((y||[]).map(d=>({id:d.id,produto_id:n.find(u=>{const v=!!u.tipo_info?.disponivel_todas_cidades;return u.tipo_produto===d.produto_id&&(v||!s||u.cidade_id===s)})?.id||"",numero_recibo:d.numero_recibo||"",valor_total:d.valor_total!=null?ge(d.valor_total):"",valor_taxas:d.valor_taxas!=null?ge(d.valor_taxas):"0,00"})))}catch(c){console.error(c),h("Erro ao carregar venda para edi√ß√£o.")}finally{le(!1)}}r.useEffect(()=>{const e=new URLSearchParams(window.location.search),o=e.get("id");o&&K(o);const a=e.get("cidadeId")||"",i=e.get("cidadeNome")||"";(a||i)&&Q({id:a,nome:i})},[]),r.useEffect(()=>{!z&&x&&Ce(w||void 0,de)},[z,x,w,de]),r.useEffect(()=>{if(j.trim().length<2){B([]);return}const e=new AbortController,o=setTimeout(async()=>{ue(!0),O(null);try{const{data:a,error:i}=await p.rpc("buscar_cidades",{q:j.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),O("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:c,error:N}=await p.from("cidades").select("id, nome").ilike("nome",`%${j.trim()}%`).order("nome");N?(console.error("Erro no fallback de cidades:",N),O("Erro ao buscar cidades.")):(B(c||[]),O(null))}else B(a||[])}finally{e.signal.aborted||ue(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[j]);const H=e=>e.replace(/\D/g,""),pe=r.useMemo(()=>{if(!T.trim())return G;const e=V(T);return G.filter(o=>{const a=H(o.cpf||"");return V(o.nome).includes(e)||a.includes(H(e))})},[G,T]);r.useMemo(()=>{if(!j.trim())return M;const e=V(j);return M.filter(o=>V(o.nome).includes(e))},[M,j]);const fe=r.useMemo(()=>{const e=J.filter(i=>i.disponivel_todas_cidades);let o=[];if(l.destino_id){const i=f.filter(s=>!!s.tipo_info?.disponivel_todas_cidades||s.cidade_id===l.destino_id),c=new Set(i.filter(s=>s.cidade_id===l.destino_id).map(s=>s.tipo_produto)),N=e.filter(s=>!c.has(s.id)).map(s=>({id:`virtual-${s.id}`,nome:s.nome||"Produto global",cidade_id:l.destino_id,tipo_produto:s.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}));o=[...i,...N]}else o=[...f.filter(i=>!!i.tipo_info?.disponivel_todas_cidades),...e.map(i=>({id:`virtual-${i.id}`,nome:i.nome||"Produto global",cidade_id:null,tipo_produto:i.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}))];if(!$.trim())return o;const a=V($);return o.filter(i=>V(i.nome).includes(a))},[f,J,$,l.destino_id]),_e=r.useMemo(()=>f.some(e=>e.tipo_info?.disponivel_todas_cidades),[f]),ye=r.useMemo(()=>_.length>0,[_.length]);function De(e){F(e);const o=M.find(a=>a.id===l.destino_id);(!o||!V(o.nome).includes(V(e)))&&q(a=>({...a,destino_id:""})),U(!0)}function Ee(){I(e=>[...e,{...Le}])}function ee(e,o,a){I(i=>{const c=[...i];return c[e][o]=a,c})}function ve(e,o,a){const i=Re(a);ee(e,o,i)}r.useEffect(()=>{A(""),I(e=>e.map(o=>{const a=f.find(c=>c.id===o.produto_id),i=!!a?.tipo_info?.disponivel_todas_cidades;return a&&(i||a.cidade_id===l.destino_id)?o:{...o,produto_id:""}}))},[l.destino_id,f]);function Ve(e){I(o=>o.filter((a,i)=>i!==e))}function be(){q({...oe,data_lancamento:new Date().toISOString().substring(0,10)}),I([]),K(null),Q({id:"",nome:""}),X(""),F(""),A(""),Z(""),B([]),h(null),window.location.href="/vendas/consulta"}function qe(){q(oe),I([]),K(null),Q({id:"",nome:""}),X(""),F(""),A(""),Z(""),B([]),h(null),window.location.href="/vendas/consulta"}async function Ie(e){if(e.preventDefault(),!te&&!ae){h("Voc√™ n√£o possui permiss√£o para cadastrar vendas.");return}if(_.length===0){h("Uma venda precisa ter ao menos 1 recibo.");return}try{R(!0),h(null);const{data:o}=await p.auth.getUser(),a=o?.user?.id;if(!a){h("Usu√°rio n√£o autenticado."),R(!1);return}if(!_.length){h("Uma venda precisa ter ao menos 1 recibo."),R(!1);return}if(!_[0]?.produto_id){h("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),R(!1);return}if(_.some(m=>{const n=f.find(u=>u.id===m.produto_id),d=!!n?.tipo_info?.disponivel_todas_cidades||(m.produto_id||"").startsWith("virtual-");return n?.cidade_id&&!d})&&!l.destino_id){h("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),R(!1);return}async function N(m){const n=m.produto_id,d=f.find(E=>E.id===n);if(d&&!d.isVirtual)return d.id;const u=d?.tipo_produto||(n?.startsWith("virtual-")?n.replace("virtual-",""):d?.tipo_produto);if(!u)throw new Error("Produto inv√°lido. Selecione novamente.");const v=l.destino_id;if(!v)throw new Error("Selecione a cidade de destino para usar produtos globais.");const C=f.find(E=>E.tipo_produto===u&&E.cidade_id===v);if(C)return C.id;const D=J.find(E=>E.id===u),S=D?.nome||"Produto",{data:P,error:L}=await p.from("produtos").insert({nome:S,destino:S,cidade_id:v,tipo_produto:u,ativo:!0}).select("id").single();if(L)throw L;const k=P?.id;if(k)return ie(E=>[...E,{id:k,nome:S,cidade_id:v,tipo_produto:u,tipo_info:{disponivel_todas_cidades:D?.disponivel_todas_cidades}}]),k;throw new Error("N√£o foi poss√≠vel criar produto global.")}const s=[];for(const m of _){const n=await N(m);s.push(n)}const g=s[0];let y=w;if(w){const{error:m}=await p.from("vendas").update({cliente_id:l.cliente_id,destino_id:g,data_lancamento:l.data_lancamento,data_embarque:l.data_embarque||null}).eq("id",w);if(m)throw m;await p.from("vendas_recibos").delete().eq("venda_id",w);for(let n=0;n<_.length;n++){const d=_[n],u=s[n],v=f.find(L=>L.id===u),C=v?.tipo_produto||(d.produto_id?.startsWith("virtual-")?d.produto_id.replace("virtual-",""):v?.tipo_produto);if(!C)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const D=Y(d.valor_total),S=Y(d.valor_taxas);if(Number.isNaN(D))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(S))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:P}=await p.from("vendas_recibos").insert({venda_id:w,produto_id:C,numero_recibo:d.numero_recibo.trim(),valor_total:D,valor_taxas:S});if(P)throw P}await he({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:w,venda:l,recibos:_}}),alert("Venda atualizada com sucesso!"),be()}else{const{data:m,error:n}=await p.from("vendas").insert({vendedor_id:a,cliente_id:l.cliente_id,destino_id:g,data_lancamento:l.data_lancamento,data_embarque:l.data_embarque||null}).select().single();if(n)throw n;y=m.id;for(let d=0;d<_.length;d++){const u=_[d],v=s[d],C=f.find(k=>k.id===v),D=C?.tipo_produto||(u.produto_id?.startsWith("virtual-")?u.produto_id.replace("virtual-",""):C?.tipo_produto);if(!D)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const S=Y(u.valor_total),P=Y(u.valor_taxas);if(Number.isNaN(S))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(P))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:L}=await p.from("vendas_recibos").insert({venda_id:y,produto_id:D,numero_recibo:u.numero_recibo.trim(),valor_total:S,valor_taxas:P});if(L)throw L}await he({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:l,recibos:_,id:y}}),alert("Venda cadastrada com sucesso!"),be()}}catch(o){console.error(o);const a=o?.message||o?.error?.message||"",i=o?.code||o?.error?.code||"";h(`Erro ao salvar venda.${i?` C√≥digo: ${i}.`:""}${a?` Detalhes: ${a}`:""}`)}finally{R(!1)}}return x?!te&&!ae?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):t.jsx("div",{className:"vendas-cadastro-page",children:t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:w?"Editar venda":"Cadastro de Venda"}),w&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),se&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:se})}),t.jsxs("form",{onSubmit:Ie,children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:G.find(e=>e.id===l.cliente_id)?.nome||T,onChange:e=>X(e.target.value),onBlur:()=>{const e=T.toLowerCase(),o=H(T),a=pe.find(i=>{const c=H(i.cpf||"");return i.nome.toLowerCase()===e||o&&c===o});a&&q({...l,cliente_id:a.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:pe.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group",style:{position:"relative"},children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:j,onChange:e=>De(e.target.value),onFocus:()=>U(!0),onBlur:()=>setTimeout(()=>U(!1),150),required:ye,style:{marginBottom:6}}),W&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),me&&!W&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:me}),je&&(W||j.trim().length>=2)&&t.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb",position:"absolute",zIndex:5,width:"100%",background:"#fff"},children:[ce.length===0&&!W&&j.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),ce.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:l.destino_id===e.id?"#e0f2fe":"#fff",borderColor:l.destino_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:a=>{a.preventDefault(),q(i=>({...i,destino_id:e.id})),F(o),U(!1),B([])},children:[o,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:l.data_embarque,onChange:e=>q({...l,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),_.map((e,o)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:_e?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:f.find(a=>a.id===e.produto_id)?.nome||$,onChange:a=>A(a.target.value),onBlur:()=>{const a=fe.find(i=>i.nome.toLowerCase()===$.toLowerCase());a&&ee(o,"produto_id",a.id)},required:!0,disabled:!l.destino_id&&!_e}),t.jsx("datalist",{id:`listaProdutos-${o}`,children:fe.map(a=>t.jsx("option",{value:a.nome},a.id))})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>ee(o,"numero_recibo",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:a=>ve(o,"valor_total",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:a=>ve(o,"valor_taxas",a.target.value)})]}),t.jsx("div",{className:"form-group",style:{width:"80px"},children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>Ve(o),children:"üóëÔ∏è"})})]})},o)),t.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:Ee,children:"‚ûï Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:re,children:re?"Salvando...":"Salvar venda"}),t.jsx("button",{type:"button",className:"btn btn-outline",onClick:qe,style:{backgroundColor:"#f3f4f6",color:"#1f2937"},children:"Cancelar"})]})]})]})}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{Ge as default};
