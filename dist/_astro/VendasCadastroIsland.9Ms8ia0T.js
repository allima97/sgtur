import{s as p,j as a}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as Ee}from"./usePermissao.72SYthuA.js";import{r as me}from"./logs.WCvMC_es.js";function V(b){return(b||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const pe={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Ve={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function Pe(b){const h=b.replace(/\D/g,"");return h?(Number(h)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function fe(b){const h=Number(b);return Number.isNaN(h)?"":h.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function O(b){if(!b)return NaN;const h=b.replace(/\./g,"").replace(",",".");return Number(h)}function Fe(){const{permissao:b,ativo:h,loading:$,isAdmin:K}=Ee("Vendas"),Q=b==="create"||b==="edit"||b==="delete"||b==="admin",[k,_e]=r.useState([]),[I,ve]=r.useState([]),[f,X]=r.useState([]),[H,be]=r.useState([]),[s,L]=r.useState(pe),[v,R]=r.useState([]),[g,he]=r.useState(null),[Z,x]=r.useState(null),[ee,T]=r.useState(!1),[qe,oe]=r.useState(!0),[Ie,ae]=r.useState(!1),[B,ge]=r.useState(""),[w,Y]=r.useState(""),[M,te]=r.useState(""),[xe,z]=r.useState(!1),[ie,G]=r.useState([]),[A,de]=r.useState(!1),[re,U]=r.useState(null),[Le,Ne]=r.useState("");async function we(e){try{oe(!0);const[o,t,i,m]=await Promise.all([p.from("clientes").select("id, nome, cpf").order("nome"),p.from("cidades").select("id, nome").order("nome"),p.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").order("nome"),p.from("tipo_produtos").select("id, nome, disponivel_todas_cidades")]);_e(o.data||[]);const _=t.data||[];ve(_);const n=m.data||[],S=new Map(n.map(c=>[c.id,c])),j=(i.data||[]).map(c=>{const d=c.tipo_produtos;return{...c,tipo_info:d?{disponivel_todas_cidades:d.disponivel_todas_cidades}:S.has(c.tipo_produto)?{disponivel_todas_cidades:S.get(c.tipo_produto||"")?.disponivel_todas_cidades}:void 0}});X(j),be(n),e&&await se(e,_,j)}catch(o){console.error(o),x("Erro ao carregar dados.")}finally{oe(!1)}}async function se(e,o,t){try{ae(!0);const{data:i,error:m}=await p.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(m)throw m;if(!i){x("Venda n√£o encontrada para edi√ß√£o.");return}let _="",n="";if(i.destino_id){const{data:d}=await p.from("produtos").select("id, cidade_id").eq("id",i.destino_id).maybeSingle();_=d?.cidade_id||"";const u=(o||I).find(N=>N.id===_);u&&(n=u.nome)}L({cliente_id:i.cliente_id,destino_id:_,data_lancamento:i.data_lancamento,data_embarque:i.data_embarque||""}),Y(n),Ne(n);const{data:S,error:j}=await p.from("vendas_recibos").select("*").eq("venda_id",e);if(j)throw j;const c=t||f;R((S||[]).map(d=>({id:d.id,produto_id:c.find(l=>{const u=!!l.tipo_info?.disponivel_todas_cidades;return l.tipo_produto===d.produto_id&&(u||!_||l.cidade_id===_)})?.id||"",numero_recibo:d.numero_recibo||"",valor_total:d.valor_total!=null?fe(d.valor_total):"",valor_taxas:d.valor_taxas!=null?fe(d.valor_taxas):"0,00"})))}catch(i){console.error(i),x("Erro ao carregar venda para edi√ß√£o.")}finally{ae(!1)}}r.useEffect(()=>{const o=new URLSearchParams(window.location.search).get("id");o&&he(o)},[]),r.useEffect(()=>{!$&&h&&we(g||void 0)},[$,h,g]),r.useEffect(()=>{if(w.trim().length<2){G([]);return}const e=new AbortController,o=setTimeout(async()=>{de(!0),U(null);try{const{data:t,error:i}=await p.rpc("buscar_cidades",{q:w.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),U("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:m,error:_}=await p.from("cidades").select("id, nome").ilike("nome",`%${w.trim()}%`).order("nome");_?(console.error("Erro no fallback de cidades:",_),U("Erro ao buscar cidades.")):(G(m||[]),U(null))}else G(t||[])}finally{e.signal.aborted||de(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[w]);const W=e=>e.replace(/\D/g,""),ne=r.useMemo(()=>{if(!B.trim())return k;const e=V(B);return k.filter(o=>{const t=W(o.cpf||"");return V(o.nome).includes(e)||t.includes(W(e))})},[k,B]);r.useMemo(()=>{if(!w.trim())return I;const e=V(w);return I.filter(o=>V(o.nome).includes(e))},[I,w]);const le=r.useMemo(()=>{const e=H.filter(i=>i.disponivel_todas_cidades);let o=[];if(s.destino_id){const i=f.filter(n=>!!n.tipo_info?.disponivel_todas_cidades||n.cidade_id===s.destino_id),m=new Set(i.filter(n=>n.cidade_id===s.destino_id).map(n=>n.tipo_produto)),_=e.filter(n=>!m.has(n.id)).map(n=>({id:`virtual-${n.id}`,nome:n.nome||"Produto global",cidade_id:s.destino_id,tipo_produto:n.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}));o=[...i,..._]}else o=[...f.filter(i=>!!i.tipo_info?.disponivel_todas_cidades),...e.map(i=>({id:`virtual-${i.id}`,nome:i.nome||"Produto global",cidade_id:null,tipo_produto:i.id,tipo_info:{disponivel_todas_cidades:!0},isVirtual:!0}))];if(!M.trim())return o;const t=V(M);return o.filter(i=>V(i.nome).includes(t))},[f,H,M,s.destino_id]),ce=r.useMemo(()=>f.some(e=>e.tipo_info?.disponivel_todas_cidades),[f]),je=r.useMemo(()=>v.length>0,[v.length]);function Ce(e){Y(e);const o=I.find(t=>t.id===s.destino_id);(!o||!V(o.nome).includes(V(e)))&&L(t=>({...t,destino_id:""})),z(!0)}function Se(){R(e=>[...e,{...Ve}])}function J(e,o,t){R(i=>{const m=[...i];return m[e][o]=t,m})}function ue(e,o,t){const i=Pe(t);J(e,o,i)}r.useEffect(()=>{te(""),R(e=>e.map(o=>{const t=f.find(m=>m.id===o.produto_id),i=!!t?.tipo_info?.disponivel_todas_cidades;return t&&(i||t.cidade_id===s.destino_id)?o:{...o,produto_id:""}}))},[s.destino_id,f]);function ye(e){R(o=>o.filter((t,i)=>i!==e))}async function De(e){if(e.preventDefault(),!Q&&!K){x("Voc√™ n√£o possui permiss√£o para cadastrar vendas.");return}if(v.length===0){x("Uma venda precisa ter ao menos 1 recibo.");return}try{T(!0),x(null);const{data:o}=await p.auth.getUser(),t=o?.user?.id;if(!t){x("Usu√°rio n√£o autenticado."),T(!1);return}if(!v.length){x("Uma venda precisa ter ao menos 1 recibo."),T(!1);return}if(!v[0]?.produto_id){x("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),T(!1);return}if(v.some(c=>{const d=f.find(u=>u.id===c.produto_id),l=!!d?.tipo_info?.disponivel_todas_cidades||(c.produto_id||"").startsWith("virtual-");return d?.cidade_id&&!l})&&!s.destino_id){x("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),T(!1);return}async function _(c){const d=c.produto_id,l=f.find(E=>E.id===d);if(l&&!l.isVirtual)return l.id;const u=l?.tipo_produto||(d?.startsWith("virtual-")?d.replace("virtual-",""):l?.tipo_produto);if(!u)throw new Error("Produto inv√°lido. Selecione novamente.");const N=s.destino_id;if(!N)throw new Error("Selecione a cidade de destino para usar produtos globais.");const y=f.find(E=>E.tipo_produto===u&&E.cidade_id===N);if(y)return y.id;const D=H.find(E=>E.id===u),C=D?.nome||"Produto",{data:P,error:q}=await p.from("produtos").insert({nome:C,destino:C,cidade_id:N,tipo_produto:u,ativo:!0}).select("id").single();if(q)throw q;const F=P?.id;if(F)return X(E=>[...E,{id:F,nome:C,cidade_id:N,tipo_produto:u,tipo_info:{disponivel_todas_cidades:D?.disponivel_todas_cidades}}]),F;throw new Error("N√£o foi poss√≠vel criar produto global.")}const n=[];for(const c of v){const d=await _(c);n.push(d)}const S=n[0];let j=g;if(g){const{error:c}=await p.from("vendas").update({cliente_id:s.cliente_id,destino_id:S,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).eq("id",g);if(c)throw c;await p.from("vendas_recibos").delete().eq("venda_id",g);for(let d=0;d<v.length;d++){const l=v[d],u=n[d],N=f.find(q=>q.id===u),y=N?.tipo_produto||(l.produto_id?.startsWith("virtual-")?l.produto_id.replace("virtual-",""):N?.tipo_produto);if(!y)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const D=O(l.valor_total),C=O(l.valor_taxas);if(Number.isNaN(D))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(C))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:P}=await p.from("vendas_recibos").insert({venda_id:g,produto_id:y,numero_recibo:l.numero_recibo.trim(),valor_total:D,valor_taxas:C});if(P)throw P}await me({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:g,venda:s,recibos:v}}),alert("Venda atualizada com sucesso!"),await se(g,I,f)}else{const{data:c,error:d}=await p.from("vendas").insert({vendedor_id:t,cliente_id:s.cliente_id,destino_id:S,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque||null}).select().single();if(d)throw d;j=c.id;for(let l=0;l<v.length;l++){const u=v[l],N=n[l],y=f.find(F=>F.id===N),D=y?.tipo_produto||(u.produto_id?.startsWith("virtual-")?u.produto_id.replace("virtual-",""):y?.tipo_produto);if(!D)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const C=O(u.valor_total),P=O(u.valor_taxas);if(Number.isNaN(C))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(P))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:q}=await p.from("vendas_recibos").insert({venda_id:j,produto_id:D,numero_recibo:u.numero_recibo.trim(),valor_total:C,valor_taxas:P});if(q)throw q}await me({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:s,recibos:v,id:j}}),alert("Venda cadastrada com sucesso!"),L(pe),R([])}}catch(o){console.error(o);const t=o?.message||o?.error?.message||"",i=o?.code||o?.error?.code||"";x(`Erro ao salvar venda.${i?` C√≥digo: ${i}.`:""}${t?` Detalhes: ${t}`:""}`)}finally{T(!1)}}return h?!Q&&!K?a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):a.jsx("div",{className:"vendas-cadastro-page",children:a.jsxs("div",{className:"card-base card-green mb-3",children:[a.jsx("h3",{children:g?"Editar venda":"Cadastro de Venda"}),g&&a.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),Z&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:Z})}),a.jsxs("form",{onSubmit:De,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente *"}),a.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:k.find(e=>e.id===s.cliente_id)?.nome||B,onChange:e=>ge(e.target.value),onBlur:()=>{const e=B.toLowerCase(),o=W(B),t=ne.find(i=>{const m=W(i.cpf||"");return i.nome.toLowerCase()===e||o&&m===o});t&&L({...s,cliente_id:t.id})},required:!0}),a.jsx("datalist",{id:"listaClientes",children:ne.map(e=>a.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),a.jsxs("div",{className:"form-group",style:{position:"relative"},children:[a.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:w,onChange:e=>Ce(e.target.value),onFocus:()=>z(!0),onBlur:()=>setTimeout(()=>z(!1),150),required:je,style:{marginBottom:6}}),A&&a.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),re&&!A&&a.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:re}),xe&&(A||w.trim().length>=2)&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb",position:"absolute",zIndex:5,width:"100%",background:"#fff"},children:[ie.length===0&&!A&&w.trim().length>=2&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),ie.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return a.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:s.destino_id===e.id?"#e0f2fe":"#fff",borderColor:s.destino_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:t=>{t.preventDefault(),L(i=>({...i,destino_id:e.id})),Y(o),z(!1),G([])},children:[o,e.pais_nome?a.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data de embarque"}),a.jsx("input",{className:"form-input",type:"date",value:s.data_embarque,onChange:e=>L({...s,data_embarque:e.target.value})})]})]}),a.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),v.map((e,o)=>a.jsx("div",{className:"card-base mb-2",children:a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto *"}),a.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:ce?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:f.find(t=>t.id===e.produto_id)?.nome||M,onChange:t=>te(t.target.value),onBlur:()=>{const t=le.find(i=>i.nome.toLowerCase()===M.toLowerCase());t&&J(o,"produto_id",t.id)},required:!0,disabled:!s.destino_id&&!ce}),a.jsx("datalist",{id:`listaProdutos-${o}`,children:le.map(t=>a.jsx("option",{value:t.nome},t.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),a.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:t=>J(o,"numero_recibo",t.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor total *"}),a.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:t=>ue(o,"valor_total",t.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Taxas"}),a.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:t=>ue(o,"valor_taxas",t.target.value)})]}),a.jsx("div",{className:"form-group",style:{width:"80px"},children:a.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>ye(o),children:"üóëÔ∏è"})})]})},o)),a.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[a.jsx("button",{type:"button",className:"btn btn-primary",onClick:Se,children:"‚ûï Adicionar recibo"}),a.jsx("button",{type:"submit",className:"btn btn-success",disabled:ee,children:ee?"Salvando...":"Salvar venda"})]})]})]})}):a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{Fe as default};
