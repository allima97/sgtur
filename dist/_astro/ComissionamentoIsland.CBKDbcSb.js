import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as n}from"./index.C0Fn7Wtz.js";import{s as k}from"./supabase.Ng8nq9tn.js";import{u as _e}from"./usePermissao.DiLe8-Rs.js";import{L as ue}from"./LoadingUsuarioContext.BaDUNi7o.js";const fe=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function U(M,l){const d=new Date(M);return d.setMonth(d.getMonth()+l),d}function X(M){return M.toISOString().slice(0,10)}function F(M){const l=new Date;let d;switch(M){case"mes_anterior":{d=new Date(l.getFullYear(),l.getMonth()-1,1);break}case"trim":d=U(l,-3);break;case"sem":d=U(l,-6);break;case"ano":d=U(l,-12);break;case"mes_atual":default:d=new Date(l.getFullYear(),l.getMonth(),1);break}return{inicio:X(d),fim:X(l)}}function Pe(){const{permissao:M,ativo:l,loading:d}=_e("Vendas"),P=import.meta?.env?.PUBLIC_META_PRODUTO_ENABLED!=="false",[pe,Z]=n.useState(null),[q,I]=n.useState(null),[B,ee]=n.useState(null),[$,ae]=n.useState([]),[K,te]=n.useState({}),[T,oe]=n.useState({}),[S,se]=n.useState({}),[A,ie]=n.useState([]),[xe,re]=n.useState(!0),[z,Q]=n.useState(!0),[Y,G]=n.useState(null),[C,ce]=n.useState("mes_atual"),[W,ne]=n.useState(()=>F("mes_atual"));n.useEffect(()=>{d||!l||le()},[d,l,C,M]),n.useEffect(()=>{ne(F(C))},[C]);async function le(){try{Q(!0),G(null);const{data:t}=await k.auth.getUser(),s=t?.user?.id||null;if(!s){G("Usuário não autenticado.");return}Z({id:s,nome:t?.user?.email||""});const _=F(C),L=M==="admin",{data:p}=await k.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:x}=await k.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",s).eq("periodo",_.inicio.slice(0,7)+"-01").maybeSingle(),b="id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral",g=async a=>{const O=a?`${b}, exibe_kpi_comissao`:b;return k.from("tipo_produtos").select(O)};let v=await g(!0),j=!0;v.error&&v.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(j=!1,v=await g(!1));const N=j?"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral, exibe_kpi_comissao":"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral";let R=k.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${N}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim);!L&&s&&(R=R.eq("vendedor_id",s));let y=await R;if(y.error&&y.error.message?.toLowerCase().includes("exibe_kpi_comissao")){let a=k.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${b}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim);!L&&s&&(a=a.eq("vendedor_id",s)),y=await a,j=!1}const[V,E,o]=await Promise.all([k.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",x?.id||""),k.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta, commission_tier (faixa, de_pct, ate_pct, inc_pct_meta, inc_pct_comissao)"),k.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]),r=V.data,u=E.data,c=o.data,i=v.data,f=y.data;re(j);const h={};(u||[]).forEach(a=>{h[a.id]={id:a.id,tipo:a.tipo||"GERAL",meta_nao_atingida:a.meta_nao_atingida,meta_atingida:a.meta_atingida,super_meta:a.super_meta,commission_tier:a.commission_tier||[]}});const D={};(c||[]).forEach(a=>{D[a.produto_id]={produto_id:a.produto_id,rule_id:a.rule_id,fix_meta_nao_atingida:a.fix_meta_nao_atingida,fix_meta_atingida:a.fix_meta_atingida,fix_super_meta:a.fix_super_meta}});const w={};(i||[]).forEach(a=>{w[a.id]={id:a.id,nome:a.nome,regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,usa_meta_produto:a.usa_meta_produto,meta_produto_valor:a.meta_produto_valor,comissao_produto_meta_pct:a.comissao_produto_meta_pct,descontar_meta_geral:a.descontar_meta_geral,exibe_kpi_comissao:j?a.exibe_kpi_comissao:void 0}}),I(p?{usar_taxas_na_meta:!!p.usar_taxas_na_meta,foco_valor:p.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),ee(x),ae(r||[]),te(h),oe(D),se(w),ie(f||[])}catch(t){console.error(t),G("Erro ao carregar dados de comissionamento.")}finally{Q(!1)}}function de(t,s){const _=s<100?"PRE":"POS",p=(t.commission_tier||[]).filter(N=>N.faixa===_).find(N=>s>=Number(N.de_pct)&&s<=Number(N.ate_pct)),x=_==="PRE"?t.meta_nao_atingida??t.meta_atingida??0:t.meta_atingida??t.meta_nao_atingida??0;if(!p)return _==="POS"&&s>=120?t.super_meta??x:x;const b=Number(p.inc_pct_meta||0),g=Number(p.inc_pct_comissao||0);if(b<=0)return g||x;const v=Math.max(0,Math.floor((s-Number(p.de_pct))/b));return x+v*(g/100)}const m=n.useMemo(()=>{if(!q)return null;const t={};$.forEach(o=>{t[o.produto_id]=o.valor});const s={},_={},L={};let p=0,x=0,b=0,g=0,v=0;const j={},N=[];let R=0;const y={};Object.values(S).forEach(o=>{o.regra_comissionamento==="diferenciado"&&(N.push(o.id),j[o.id]=0),o.usa_meta_produto&&(y[o.id]=0)}),A.forEach(o=>{(o.vendas_recibos||[]).forEach(r=>{const u=r.tipo_produtos?.id||r.produto_id||"",c=S[u];if(!c)return;const i=Number(r.valor_total||0),f=Number(r.valor_taxas||0),h=i-f,D=q.usar_taxas_na_meta?i:h;_[u]=(_[u]||0)+i,L[u]=(L[u]||0)+h,s[u]=(s[u]||0)+D,c.soma_na_meta&&(p+=D),x+=i,b+=f})});const V=x-b,E=B?.meta_geral&&B.meta_geral>0?p/B.meta_geral*100:0;return Object.keys(_).forEach(o=>{const r=S[o];if(!r)return;const u=q.foco_valor==="liquido"?L[o]||0:_[o]||0;if(r.regra_comissionamento==="diferenciado"){const c=T[o];if(!c)return;const i=t[o]||0,f=s[o]||0,h=i>0,D=h?f/i*100:0,w=h?f<i?0:D>=120?c.fix_super_meta??c.fix_meta_atingida??c.fix_meta_nao_atingida??0:c.fix_meta_atingida??c.fix_meta_nao_atingida??0:c.fix_meta_nao_atingida??c.fix_meta_atingida??c.fix_super_meta??0,a=u*(w/100);r.soma_na_meta&&!r.usa_meta_produto?g+=a:v+=a,j[o]=a}else{const c=T[o]?.rule_id,i=c?K[c]:void 0;let f=0;i&&(i.tipo==="ESCALONAVEL"?f=de(i,E):E<100?f=i.meta_nao_atingida||0:E>=120?f=i.super_meta??i.meta_atingida??i.meta_nao_atingida??0:f=i.meta_atingida??i.meta_nao_atingida??0);const h=u*(f/100);if(g+=h,P&&r.usa_meta_produto&&r.meta_produto_valor&&r.comissao_produto_meta_pct&&(s[o]||0)/r.meta_produto_valor*100>=100){const O=u*((r.comissao_produto_meta_pct||0)/100),J=r.descontar_meta_geral===!1?O:Math.max(O-h,0);R+=J,y[o]=(y[o]||0)+J}}}),{baseMeta:p,totalBruto:x,totalTaxas:b,totalLiquido:V,pctMetaGeral:E,comissaoGeral:g,comissaoDif:v,comissaoMetaProd:P?R:0,totalComissao:P?g+v+R:g+v,comissaoDifDetalhe:j,comissaoMetaProdDetalhe:P?y:{},produtosDiferenciados:N,totalVendas:A.length}},[A,q,S,T,$,B,K,P]);if(d)return e.jsx(ue,{});if(!l)return e.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const H=P&&m?Object.entries(m.comissaoMetaProdDetalhe||{}).filter(([t])=>S[t]?.exibe_kpi_comissao!==!1):[],me=m&&m.produtosDiferenciados?m.produtosDiferenciados.filter(t=>S[t]?.exibe_kpi_comissao!==!1):[];return e.jsxs("div",{className:"card-base bg-transparent shadow-none p-0",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row mb-0",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Período"}),e.jsx("select",{className:"form-select",value:C,onChange:t=>ce(t.target.value),children:fe.map(t=>e.jsx("option",{value:t.id,children:t.label},t.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início"}),e.jsx("input",{className:"form-input",value:W.inicio,readOnly:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Fim"}),e.jsx("input",{className:"form-input",value:W.fim,readOnly:!0})]})]})}),Y&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:Y})}),z&&e.jsx("div",{children:"Carregando dados..."}),!z&&m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base mb-3",children:[e.jsx("div",{className:"text-center font-bold text-lg mb-4",children:"Como está seu Progresso"}),e.jsxs("div",{className:"grid gap-3 mb-1",style:{gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))"},children:[e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#16a34a"},children:[e.jsx("div",{className:"kpi-label",children:"Meta do mês"}),e.jsx("div",{className:"kpi-value",children:(B?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#ca8a04"},children:[e.jsx("div",{className:"kpi-label",children:"Total Bruto"}),e.jsx("div",{className:"kpi-value",children:m.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#c2410c"},children:[e.jsx("div",{className:"kpi-label",children:"Total Líquido"}),e.jsx("div",{className:"kpi-value",children:m.totalLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#0ea5e9"},children:[e.jsx("div",{className:"kpi-label",children:"Taxas"}),e.jsx("div",{className:"kpi-value",children:m.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",style:{color:"#2563eb"},children:[e.jsx("div",{className:"kpi-label",children:"Vendas"}),e.jsx("div",{className:"kpi-value",children:m.totalVendas})]})]})]}),e.jsxs("div",{className:"card-base",children:[e.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),P&&H.length>0&&e.jsx("div",{style:{textAlign:"center",color:"#0f172a",marginBottom:8,fontSize:"0.9rem"},children:"Produtos com meta específica"}),e.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),e.jsx("div",{className:"kpi-value",children:m.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),P&&H.map(([t,s])=>e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:S[t]?.nome||"(produto)"}),e.jsx("div",{className:"kpi-value",children:s.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),s===0&&e.jsx("small",{style:{color:"#dc2626"},children:"Meta não atingida"})]},`meta-${t}`)),me.map(t=>e.jsxs("div",{className:"kpi-card flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:S[t]?.nome||"(produto)"}),e.jsx("div",{className:"kpi-value",children:(m.comissaoDifDetalhe?.[t]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),(m.comissaoDifDetalhe?.[t]||0)===0&&e.jsx("small",{style:{color:"#dc2626"},children:"Sem comissão"})]},t)),e.jsxs("div",{className:"kpi-card kpi-highlight flex flex-col items-center text-center",children:[e.jsx("div",{className:"kpi-label",children:"Comissão total"}),e.jsx("div",{className:"kpi-value",children:m.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{Pe as default};
