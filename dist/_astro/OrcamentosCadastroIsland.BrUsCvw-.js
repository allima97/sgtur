import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as r}from"./supabase.Ng8nq9tn.js";import{u as k}from"./usePermissao.DiLe8-Rs.js";import{L as A}from"./LoadingUsuarioContext.BaDUNi7o.js";function G({suppressLoadingMessage:E=!1}){const{ativo:I,loading:q}=k("Vendas"),[D,P]=s.useState([]),[V,O]=s.useState([]),[_,L]=s.useState([]),[n,i]=s.useState(""),[c,d]=s.useState(""),[g,m]=s.useState(""),[u,x]=s.useState("novo"),[f,p]=s.useState(""),[b,v]=s.useState(""),[N,h]=s.useState(""),[S,w]=s.useState(!1),[C,t]=s.useState(null),[y,j]=s.useState(null);s.useEffect(()=>{F()},[]);async function F(){try{const[a,o,l]=await Promise.all([r.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),r.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),r.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);a.data&&P(a.data),o.data&&O(o.data),l.data&&L(l.data)}catch(a){console.error(a),t("Erro ao carregar listas.")}}async function R(a){if(a.preventDefault(),t(null),j(null),!n||!c||!u){t("Cliente, destino e status são obrigatórios.");return}try{w(!0);const o={cliente_id:n,destino_id:c||null,produto_id:g||null,status:u,valor:f?parseFloat(f):null,data_viagem:b||null,notas:N||null},{error:l}=await r.from("orcamentos").insert(o);if(l)throw l;j("Orçamento criado."),window.dispatchEvent(new CustomEvent("orcamento-criado")),i(""),d(""),m(""),x("novo"),p(""),v(""),h("")}catch(o){console.error(o),t("Erro ao salvar orçamento.")}finally{w(!1)}}return q?E?null:e.jsx(A,{className:"mb-3"}):I?e.jsxs("div",{className:"card-base card-blue mb-3",children:[e.jsx("h2",{className:"card-title font-semibold text-lg",children:"Novo Orçamento"}),C&&e.jsx("div",{className:"auth-error text-red-600 font-medium mb-2",children:C}),y&&e.jsx("div",{className:"auth-success text-slate-900 font-bold mb-2",children:y}),e.jsxs("form",{onSubmit:R,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Cliente *"}),e.jsxs("select",{className:"form-select",value:n,onChange:a=>i(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),D.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Destino *"}),e.jsxs("select",{className:"form-select",value:c,onChange:a=>d(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),V.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Tipo de produto"}),e.jsxs("select",{className:"form-select",value:g,onChange:a=>m(a.target.value),children:[e.jsx("option",{value:"",children:"(Opcional)"}),_.map(a=>e.jsx("option",{value:a.id,children:a.nome||a.tipo},a.id))]})]})]}),e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:u,onChange:a=>x(a.target.value),children:[e.jsx("option",{value:"novo",children:"Novo"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"negociando",children:"Negociando"}),e.jsx("option",{value:"fechado",children:"Fechado"}),e.jsx("option",{value:"perdido",children:"Perdido"})]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Valor estimado (R$)"}),e.jsx("input",{className:"form-input",type:"number",value:f,onChange:a=>p(a.target.value),min:0,step:"0.01"})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Data da viagem"}),e.jsx("input",{className:"form-input",type:"date",value:b,onChange:a=>v(a.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Notas"}),e.jsx("textarea",{className:"form-input",rows:3,value:N,onChange:a=>h(a.target.value),placeholder:"Observações, próximos passos..."})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:S,children:S?"Salvando...":"Criar orçamento"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>{i(""),d(""),m(""),x("novo"),p(""),v(""),h(""),t(null),j(null)},children:"Limpar"})]})]})]}):e.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{G as default};
