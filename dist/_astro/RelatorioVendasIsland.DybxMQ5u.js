import{j as e,s as x}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as $,w as Se}from"./xlsx.DrgRuPKf.js";function B(){return new Date().toISOString().substring(0,10)}function g(i){return(i||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function z(i,q){const h=new Date(i);return h.setDate(h.getDate()+q),h}function _(i){return i.toISOString().substring(0,10)}function ie(i){return new Date(i.getFullYear(),i.getMonth(),1)}function le(i){return new Date(i.getFullYear(),i.getMonth()+1,0)}function Ne(i){return i.includes(";")||i.includes('"')||i.includes(`
`)?'"'+i.replace(/"/g,'""')+'"':i}function Ce(){const[i,q]=s.useState([]),[h,de]=s.useState([]),[w,ce]=s.useState([]),[D,U]=s.useState(""),[C,A]=s.useState(""),[E,Y]=s.useState(""),[M,H]=s.useState(null),[R,W]=s.useState(null),[y,G]=s.useState(null),[L,b]=s.useState(()=>{const a=z(new Date,-7);return _(a)}),[I,j]=s.useState(B()),[O,ue]=s.useState("todos"),[J,me]=s.useState(""),[K,pe]=s.useState(""),[Q,he]=s.useState([]),[P,X]=s.useState(!1),[Z,S]=s.useState(null),[f,fe]=s.useState(null),[xe,ee]=s.useState(!0),[N,ge]=s.useState({pdf:!0,excel:!0});s.useEffect(()=>{async function t(){try{ee(!0),S(null);const{data:a}=await x.auth.getUser(),o=a?.user?.id;if(!o){S("Usuário não autenticado.");return}const{data:n}=await x.from("users").select("id, user_types(name), company_id").eq("id",o).maybeSingle(),r=n?.user_types?.name||a?.user?.user_metadata?.name||"",c=String(r||"").toUpperCase();let d="VENDEDOR";c.includes("ADMIN")?d="ADMIN":c.includes("GESTOR")?d="GESTOR":c.includes("VENDEDOR")?d="VENDEDOR":d="OUTRO";let u=[o];if(d==="GESTOR"){const{data:p}=await x.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",o),k=p?.map(F=>F.vendedor_id).filter(F=>!!F)||[];u=Array.from(new Set([o,...k]))}else d==="ADMIN"&&(u=[]);const l=n?.company_id||null;if(l){const{data:p}=await x.from("parametros_comissao").select("exportacao_pdf, exportacao_excel").eq("company_id",l).maybeSingle();p&&ge({pdf:p.exportacao_pdf??!0,excel:p.exportacao_excel??!0})}fe({usuarioId:o,papel:d,vendedorIds:u})}catch(a){console.error(a),S("Erro ao carregar contexto do usuário.")}finally{ee(!1)}}t()},[]),s.useEffect(()=>{async function t(){try{const[{data:a,error:o},{data:n,error:r},{data:c,error:d}]=await Promise.all([x.from("clientes").select("id, nome, cpf").order("nome",{ascending:!0}),x.from("produtos").select("id, nome").order("nome",{ascending:!0}),x.from("tipo_produtos").select("id, nome, tipo").order("nome",{ascending:!0})]);if(o)throw o;if(r)throw r;if(d)throw d;q(a||[]),de(n||[]),ce(c||[])}catch(a){console.error(a),S("Erro ao carregar bases de clientes, destinos e produtos. Verifique o Supabase.")}}t()},[]);const te=s.useMemo(()=>{if(!D.trim())return i;const t=g(D);return i.filter(a=>{const o=a.cpf||"";return g(a.nome).includes(t)||g(o).includes(t)})},[i,D]),oe=s.useMemo(()=>{if(!C.trim())return h;const t=g(C);return h.filter(a=>g(a.nome).includes(t))},[h,C]),ae=s.useMemo(()=>{if(!E.trim())return w;const t=g(E);return w.filter(a=>{const o=g(a.nome||""),n=g(a.tipo||"");return o.includes(t)||n.includes(t)})},[w,E]),m=s.useMemo(()=>{const t=new Map(i.map(n=>[n.id,n])),a=new Map(h.map(n=>[n.id,n])),o=new Map(w.map(n=>[n.id,n]));return Q.map(n=>{const r=t.get(n.cliente_id),c=a.get(n.destino_id),d=n.produto_id?o.get(n.produto_id):void 0,u=n.vendas_recibos||[],l=u.map(V=>V.numero_recibo).filter(Boolean).join(" / "),p=u.reduce((V,re)=>V+Number(re.valor_total||0)+Number(re.valor_taxas||0),0),k=u.find(V=>V.tipo_produtos?.id),F=p>0?p:n.valor_total??null;return{...n,numero_venda:n.numero_venda||l||n.id,valor_total:F,cliente_nome:r?.nome||"(sem cliente)",cliente_cpf:r?.cpf||"",destino_nome:c?.nome||"(sem destino)",produto_nome:d?.nome||d?.tipo||k?.tipo_produtos?.nome||k?.tipo_produtos?.tipo||"(sem produto)"}})},[Q,i,h,w]),T=m.length,ne=m.reduce((t,a)=>{const o=a.valor_total??0;return t+o},0),be=T>0?ne/T:0;async function se(){if(f)try{X(!0),S(null);let t=x.from("vendas").select(`
          id,
          vendedor_id,
          numero_venda,
          cliente_id,
          destino_id,
          produto_id,
          data_lancamento,
          data_embarque,
          valor_total,
          status,
          vendas_recibos (
            numero_recibo,
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (id, nome, tipo)
          )
        `).order("data_lancamento",{ascending:!1});f.papel!=="ADMIN"&&(t=t.in("vendedor_id",f.vendedorIds)),L&&(t=t.gte("data_lancamento",L)),I&&(t=t.lte("data_lancamento",I)),O!=="todos"&&(t=t.eq("status",O)),M&&(t=t.eq("cliente_id",M.id)),R&&(t=t.eq("destino_id",R.id)),y&&(t=t.eq("produto_id",y.id));const a=parseFloat(J.replace(",","."));isNaN(a)||(t=t.gte("valor_total",a));const o=parseFloat(K.replace(",","."));isNaN(o)||(t=t.lte("valor_total",o));const{data:n,error:r}=await t;if(r)throw r;he(n||[])}catch(t){console.error(t),S("Erro ao carregar vendas para o relatório. Confira o schema e filtros.")}finally{X(!1)}}s.useEffect(()=>{f&&se()},[f]);function v(t){const a=new Date;if(t==="limpar"){b(""),j("");return}if(t==="hoje"){const o=B();b(o),j(o);return}if(t==="7"){const o=z(a,-7);b(_(o)),j(B());return}if(t==="30"){const o=z(a,-30);b(_(o)),j(B());return}if(t==="mes_atual"){const o=ie(a),n=le(a);b(_(o)),j(_(n));return}if(t==="mes_anterior"){const o=new Date(a.getFullYear(),a.getMonth()-1,1),n=ie(o),r=le(o);b(_(n)),j(_(r));return}}function je(){if(m.length===0){alert("Não há dados para exportar.");return}const t=["numero_venda","cliente","cpf","destino","produto","data_lancamento","data_embarque","status","valor_total"],a=m.map(l=>[l.numero_venda||"",l.cliente_nome,l.cliente_cpf||"",l.destino_nome,l.produto_nome,l.data_lancamento||"",l.data_embarque||"",l.status||"",(l.valor_total??0).toString().replace(".",",")]),o=[t,...a].map(l=>l.map(p=>Ne(p)).join(";")).join(`
`),n=new Blob([o],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),c=new Date,d=`${c.getFullYear()}${String(c.getMonth()+1).padStart(2,"0")}${String(c.getDate()).padStart(2,"0")}-${String(c.getHours()).padStart(2,"0")}${String(c.getMinutes()).padStart(2,"0")}`,u=document.createElement("a");u.href=r,u.setAttribute("download",`relatorio-vendas-${d}.csv`),document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(r)}function _e(){if(!N.excel){alert("Exportação Excel desabilitada nos parâmetros.");return}if(m.length===0){alert("Não há dados para exportar.");return}const t=m.map(r=>({"Nº Venda":r.numero_venda||r.id,Cliente:r.cliente_nome,CPF:r.cliente_cpf,Destino:r.destino_nome,Produto:r.produto_nome,"Data lançamento":r.data_lancamento?.slice(0,10)||"","Data embarque":r.data_embarque?.slice(0,10)||"",Status:r.status||"","Valor total":r.valor_total??0})),a=$.json_to_sheet(t),o=$.book_new();$.book_append_sheet(o,a,"Vendas");const n=new Date().toISOString().replace(/[-:T]/g,"").slice(0,12);Se(o,`relatorio-vendas-${n}.xlsx`)}function ye(){if(!N.pdf){alert("Exportação PDF desabilitada nos parâmetros.");return}if(m.length===0){alert("Não há dados para exportar.");return}const t=window.open("","_blank");if(!t){alert("Não foi possível abrir a janela de exportação.");return}const a=m.map(o=>`
        <tr>
          <td>${o.numero_venda||o.id}</td>
          <td>${o.cliente_nome||""}</td>
          <td>${o.destino_nome||""}</td>
          <td>${o.produto_nome||""}</td>
          <td>${o.data_lancamento?.slice(0,10)||""}</td>
          <td>${o.status||""}</td>
          <td>${(o.valor_total??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
        </tr>`).join("");t.document.write(`
      <html>
        <head>
          <title>Relatório de Vendas</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 16px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
            th { background: #f1f5f9; }
          </style>
        </head>
        <body>
          <h3>Relatório de Vendas</h3>
          <table>
            <thead>
              <tr>
                <th>Nº Venda</th>
                <th>Cliente</th>
                <th>Destino</th>
                <th>Produto</th>
                <th>Lançamento</th>
                <th>Status</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>${a}</tbody>
          </table>
          <script>window.print();<\/script>
        </body>
      </html>
    `),t.document.close()}return e.jsxs("div",{className:"relatorio-vendas-page",children:[xe&&e.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),f&&f.papel!=="ADMIN"&&e.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",f.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:L,onChange:t=>b(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:I,onChange:t=>j(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:O,onChange:t=>ue(t.target.value),children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"aberto",children:"Aberto"}),e.jsx("option",{value:"confirmado",children:"Confirmado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor mínimo"}),e.jsx("input",{className:"form-input",value:J,onChange:t=>me(t.target.value),placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor máximo"}),e.jsx("input",{className:"form-input",value:K,onChange:t=>pe(t.target.value),placeholder:"0,00"})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:8},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsx("input",{className:"form-input",value:D,onChange:t=>{U(t.target.value),H(null)},placeholder:"Nome ou CPF..."}),D&&!M&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[te.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum cliente encontrado."}),te.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{H(t),U(t.nome)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.cpf||"Sem CPF"})]},t.id))]}),M&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:M.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",value:C,onChange:t=>{A(t.target.value),W(null)},placeholder:"Nome do destino..."}),C&&!R&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[oe.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum destino encontrado."}),oe.map(t=>e.jsx("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{W(t),A(t.nome)},children:e.jsx("div",{style:{fontWeight:600},children:t.nome})},t.id))]}),R&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:R.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Produto"}),e.jsx("input",{className:"form-input",value:E,onChange:t=>{Y(t.target.value),G(null)},placeholder:"Nome ou tipo..."}),E&&!y&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[ae.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum produto encontrado."}),ae.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{G(t),Y(t.nome||t.tipo)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome||"(sem nome)"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.tipo})]},t.id))]}),y&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado:"," ",e.jsx("strong",{children:y.nome||y.tipo})]})]})]}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("hoje"),children:"Hoje"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("7"),children:"Últimos 7 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("30"),children:"Últimos 30 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_atual"),children:"Este mês"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_anterior"),children:"Mês anterior"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("limpar"),children:"Limpar datas"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:se,children:"Aplicar filtros"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-purple",onClick:je,children:"Exportar CSV"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:_e,disabled:!N.excel,title:N.excel?"":"Exportação Excel desabilitada nos parâmetros",children:"Exportar Excel"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:ye,disabled:!N.pdf,title:N.pdf?"":"Exportação PDF desabilitada nos parâmetros",children:"Exportar PDF"})]})]})]}),Z&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:Z})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:[e.jsx("strong",{children:T})," venda(s) encontrada(s)"]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Faturamento:"," ",e.jsx("strong",{children:ne.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Ticket médio:"," ",e.jsx("strong",{children:be.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-purple min-w-[1000px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nº Venda"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Data lançamento"}),e.jsx("th",{children:"Data embarque"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Valor total"})]})}),e.jsxs("tbody",{children:[P&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Carregando vendas..."})}),!P&&m.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Nenhuma venda encontrada com os filtros atuais."})}),!P&&m.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.numero_venda||"-"}),e.jsx("td",{children:t.cliente_nome}),e.jsx("td",{children:t.cliente_cpf}),e.jsx("td",{children:t.destino_nome}),e.jsx("td",{children:t.produto_nome}),e.jsx("td",{children:t.data_lancamento?new Date(t.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.data_embarque?new Date(t.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.status||"-"}),e.jsx("td",{children:t.valor_total!=null?t.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"-"})]},t.id))]})]})})]})}export{Ce as default};
