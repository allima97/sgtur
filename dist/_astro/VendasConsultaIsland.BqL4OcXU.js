import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as h}from"./supabase.Ng8nq9tn.js";import{r as T}from"./logs.DwCrXgEk.js";import{u as xe}from"./usePermissao.Bkt8qSjs.js";function V(u){return(u||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function je(){const{permissao:u,ativo:Z,loading:A,isAdmin:ee}=xe("Vendas"),N=u!=="none",ae=u==="create"||u==="edit"||u==="delete"||u==="admin",q=u==="edit"||u==="delete"||u==="admin",j=u==="delete"||u==="admin",[x,te]=i.useState(null),[se,B]=i.useState(!0),[I,de]=i.useState([]),[ie,M]=i.useState([]),[E,ne]=i.useState(""),[$,_]=i.useState(null),[L,F]=i.useState(!0),[O,k]=i.useState(null),[n,S]=i.useState(null),[U,P]=i.useState(!1),[z,W]=i.useState(!1),[G,H]=i.useState(null),[Y,J]=i.useState([]),[oe,re]=i.useState(0);i.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&k(t)},[]),i.useEffect(()=>{async function a(){try{_(null),B(!0);const{data:t}=await h.auth.getUser(),d=t?.user?.id;if(!d){_("Usu√°rio n√£o autenticado.");return}const{data:o}=await h.from("users").select("id, user_types(name)").eq("id",d).maybeSingle(),r=o?.user_types?.name||t?.user?.user_metadata?.name||"",c=String(r||"").toUpperCase();let p="VENDEDOR";c.includes("ADMIN")?p="ADMIN":c.includes("GESTOR")?p="GESTOR":c.includes("VENDEDOR")?p="VENDEDOR":p="OUTRO";let s=[d];if(p==="GESTOR"){const{data:l}=await h.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",d),v=l?.map(y=>y.vendedor_id).filter(y=>!!y)||[];s=Array.from(new Set([d,...v]))}else p==="ADMIN"&&(s=[]);te({usuarioId:d,papel:p,vendedorIds:s})}catch(t){console.error(t),_("Erro ao carregar contexto do usu√°rio.")}finally{B(!1)}}a()},[]);async function w(){if(!(!N||!x))try{F(!0);let a=h.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          data_lancamento,
          data_embarque,
          clientes(nome),
          destinos:produtos!destino_id (
            nome,
            cidade_id
          )
        `).order("data_lancamento",{ascending:!1});x.papel!=="ADMIN"&&(a=a.in("vendedor_id",x.vendedorIds));const{data:t,error:d}=await a;if(d)throw d;const o=Array.from(new Set((t||[]).map(s=>s.destinos?.cidade_id).filter(s=>!!s)));let r={};if(o.length>0){const{data:s,error:l}=await h.from("cidades").select("id, nome").in("id",o);l?console.error(l):r=Object.fromEntries((s||[]).map(v=>[v.id,v.nome]))}const c=(t||[]).map(s=>{const l=s.destinos?.cidade_id||"";return{id:s.id,vendedor_id:s.vendedor_id,cliente_id:s.cliente_id,destino_id:s.destino_id,destino_cidade_id:l,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque,cliente_nome:s.clientes?.nome||"",destino_nome:s.destinos?.nome||"",destino_cidade_nome:l&&r[l]||""}});de(c);const p=c.map(s=>s.id);if(p.length===0)M([]);else{const{data:s}=await h.from("vendas_recibos").select("*").in("venda_id",p),l=Array.from(new Set((s||[]).map(m=>m.produto_id).filter(m=>!!m))),v=c.reduce((m,f)=>(f.destino_cidade_id&&(m[f.id]=f.destino_cidade_id),m),{});let y=[],X={};if(l.length>0){const{data:m,error:f}=await h.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").in("tipo_produto",l);!f&&m?y=m:f&&console.error(f);const{data:C,error:D}=await h.from("tipo_produtos").select("id, nome, disponivel_todas_cidades").in("id",l);!D&&C?X=Object.fromEntries(C.map(g=>[g.id,{nome:g.nome||"Produto",disponivel_todas_cidades:g.disponivel_todas_cidades}])):D&&console.error(D)}const ue=(s||[]).map(m=>{const f=v[m.venda_id]||"",C=y.find(g=>{const he=!!g?.tipo_produtos?.disponivel_todas_cidades;return g.tipo_produto===m.produto_id&&(he||!f||g.cidade_id===f)}),D=X[m.produto_id]||{};return{...m,produto_nome:C?.nome||D.nome||""}})||[];M(ue)}if(O){const s=c.find(l=>l.id===O);s&&S(s),k(null)}}catch(a){console.error(a),_("Erro ao carregar vendas."),b("Erro ao carregar vendas.","error")}finally{F(!1)}}i.useEffect(()=>{!A&&N&&x&&w()},[A,N,x]);const K=i.useMemo(()=>x?x.papel==="ADMIN"?"Todas as vendas":x.papel==="GESTOR"?"Vendas da sua equipe":"Suas vendas":"",[x]),Q=i.useMemo(()=>{if(!E.trim())return I;const a=V(E);return I.filter(t=>V(t.cliente_nome||"").includes(a)||V(t.destino_nome||"").includes(a)||V(t.id).includes(a))},[I,E]);function R(a){return ie.filter(t=>t.venda_id===a)}function b(a,t="success"){re(o=>o+1);const d=oe+1;J(o=>[...o,{id:d,message:a,type:t}]),setTimeout(()=>{J(o=>o.filter(r=>r.id!==d))},3500)}async function ce(a){if(!(!j&&!ee)&&confirm("Tem certeza que deseja CANCELAR esta venda?"))try{W(!0),await h.from("vendas_recibos").delete().eq("venda_id",a.id),await h.from("vendas").delete().eq("id",a.id),await T({acao:"venda_cancelada",modulo:"Vendas",detalhes:{id:a.id}}),await w(),S(null),b("Venda cancelada.","success")}catch(t){console.error(t),_("Erro ao cancelar venda."),b("Erro ao cancelar venda.","error")}finally{W(!1)}}async function le(a,t){if(j&&confirm("Excluir este recibo?"))try{H(a),await h.from("vendas_recibos").delete().eq("id",a),await T({acao:"recibo_excluido",modulo:"Vendas",detalhes:{recibo_id:a,venda_id:t}}),await w(),b("Recibo exclu√≠do.","success")}catch(d){console.error(d),_("Erro ao excluir recibo."),b("Erro ao excluir recibo.","error")}finally{H(null)}}async function me(a,t){if(q)try{P(!0),await h.from("vendas").update({data_embarque:t}).eq("id",a.id),await T({acao:"venda_remarcada",modulo:"Vendas",detalhes:{venda_id:a.id,nova_data:t}}),await w(),b("Data de embarque atualizada.","success")}catch(d){console.error(d),_("Erro ao remarcar venda."),b("Erro ao remarcar.","error")}finally{P(!1)}}return Z?se||A?e.jsx("div",{className:"card-base card-config",children:"Carregando contexto do usu√°rio..."}):N?e.jsxs("div",{className:"vendas-consulta-page",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",style:{marginTop:8},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar venda"}),e.jsx("input",{className:"form-input",placeholder:"Nome, destino ou ID...",value:E,onChange:a=>ne(a.target.value)}),K&&e.jsxs("small",{style:{color:"#64748b"},children:[K," ",x?.papel!=="ADMIN"?"(restri√ß√£o por vendedor)":""]})]}),ae&&e.jsx("div",{className:"form-group",style:{alignItems:"flex-end"},children:e.jsx("a",{className:"btn btn-primary",href:"/vendas/cadastro",children:"Nova venda"})})]})}),$&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:$})}),e.jsx("div",{className:"table-container overflow-x-auto",style:{maxHeight:"65vh",overflowY:"auto"},children:e.jsxs("table",{className:"table-default table-header-green min-w-[820px]",children:[e.jsx("thead",{style:{position:"sticky",top:0,zIndex:1},children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{style:{textAlign:"center"},children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),N&&e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando..."})}),!L&&Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma venda encontrada."})}),!L&&Q.map(a=>{const t=R(a.id).reduce((r,c)=>r+(c.valor_total||0),0),d=R(a.id).reduce((r,c)=>r+(c.valor_taxas||0),0),o=R(a.id).map(r=>r.produto_nome||"").filter(Boolean);return e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_nome}),e.jsx("td",{children:a.destino_cidade_nome||"-"}),e.jsx("td",{children:o.length===0?"-":e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:2},children:o.map((r,c)=>e.jsx("span",{children:r},`${a.id}-prod-${c}`))})}),e.jsx("td",{style:{textAlign:"center"},children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{children:["R$"," ",t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:d===0?"-":`R$ ${d.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",title:"Ver detalhes",onClick:()=>S(a),children:"üëÅÔ∏è"})})]},a.id)})]})]})}),n&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:"820px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{children:e.jsx("div",{className:"modal-title",style:{color:"#16a34a",fontSize:"1.15rem",fontWeight:800},children:"Detalhes da venda"})}),e.jsx("button",{className:"btn-ghost",onClick:()=>S(null),children:"‚úï"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",style:{display:"grid",gap:6,lineHeight:1.4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Cliente:"})," ",n.cliente_nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Cidade:"})," ",n.destino_cidade_nome||"N√£o informada"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Lan√ßada em:"})," ",new Date(n.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",n.data_embarque?new Date(n.data_embarque).toLocaleDateString("pt-BR"):"-"]})]}),e.jsx("h4",{style:{marginBottom:8,textAlign:"center"},children:"Recibos"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"N√∫mero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),j&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsx("tbody",{children:R(n.id).map(a=>{const t=(a.valor_total||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}),d=a.valor_taxas||0,o=d===0?"-":`R$ ${d.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsxs("td",{children:["R$ ",t]}),e.jsx("td",{children:o}),j&&e.jsx("td",{children:e.jsx("button",{className:"btn-icon btn-danger",disabled:G===a.id,onClick:()=>le(a.id,n.id),children:G===a.id?"‚Ä¶":"üóëÔ∏è"})})]},a.id)})})]})})]}),(q||j)&&e.jsxs("div",{className:"modal-footer",children:[q&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline",style:{minWidth:130,backgroundColor:"#f3f4f6",color:"#1f2937"},onClick:()=>{const a=`/vendas/cadastro?id=${n.id}${n.destino_cidade_id?`&cidadeId=${n.destino_cidade_id}`:""}${n.destino_cidade_nome?`&cidadeNome=${encodeURIComponent(n.destino_cidade_nome)}`:""}`;window.location.href=a},children:"Editar"}),e.jsx("button",{className:"btn btn-primary",style:{minWidth:130},onClick:()=>{const a=prompt("Nova data de embarque (AAAA-MM-DD):",n.data_embarque||"");a&&me(n,a)},disabled:U,children:U?"Salvando...":"Remarcar"})]}),j&&e.jsx("button",{className:"btn btn-danger",style:{minWidth:130},onClick:()=>ce(n),disabled:z,children:z?"Cancelando...":"Cancelar Venda"})]})]})}),Y.length>0&&e.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:Y.map(a=>e.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:a.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${a.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:a.message},a.id))})]}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para visualizar Vendas."})}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{je as default};
