import{s as d,j as a}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as aa}from"./usePermissao.72SYthuA.js";const ea=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function D(n,o){const i=new Date(n);return i.setMonth(i.getMonth()+o),i}function U(n){return n.toISOString().slice(0,10)}function L(n){const o=new Date;let i;switch(n){case"mes_anterior":{i=new Date(o.getFullYear(),o.getMonth()-1,1);break}case"trim":i=D(o,-3);break;case"sem":i=D(o,-6);break;case"ano":i=D(o,-12);break;case"mes_atual":default:i=new Date(o.getFullYear(),o.getMonth(),1);break}return{inicio:U(i),fim:U(o)}}function ia(){const{ativo:n,loading:o}=aa("Vendas"),[i,B]=s.useState(null),[v,A]=s.useState(null),[l,Y]=s.useState(null),[E,z]=s.useState([]),[C,H]=s.useState({}),[q,J]=s.useState({}),[w,K]=s.useState({}),[G,Q]=s.useState([]),[I,O]=s.useState(!0),[F,P]=s.useState(null),[x,W]=s.useState("mes_atual"),[V,X]=s.useState(()=>L("mes_atual"));s.useEffect(()=>{o||!n||Z()},[o,n,x]),s.useEffect(()=>{X(L(x))},[x]);async function Z(){try{O(!0),P(null);const{data:t}=await d.auth.getUser(),p=t?.user?.id||null;if(!p){P("Usuário não autenticado.");return}B({id:p,nome:t?.user?.email||""});const m=L(x),[{data:u},{data:N},{data:R},{data:f},{data:h},{data:j},_]=await Promise.all([d.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),d.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",p).eq("periodo",m.inicio.slice(0,7)+"-01").maybeSingle(),d.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",N?.id||""),d.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta"),d.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta"),d.from("tipo_produtos").select("id, nome, regra_comissionamento, soma_na_meta"),d.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              id, nome, regra_comissionamento, soma_na_meta
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",m.inicio).lte("data_lancamento",m.fim)]),k={};(f||[]).forEach(e=>{k[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta}});const y={};(h||[]).forEach(e=>{y[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const M={};(j||[]).forEach(e=>{M[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta}}),A(u?{usar_taxas_na_meta:!!u.usar_taxas_na_meta,foco_valor:u.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),Y(N),z(R||[]),H(k),J(y),K(M),Q(_.data||[])}catch(t){console.error(t),P("Erro ao carregar dados de comissionamento.")}finally{O(!1)}}const c=s.useMemo(()=>{if(!v)return null;let t=0,p=0,m=0,u=0;v.foco_valor,G.forEach(R=>{(R.vendas_recibos||[]).forEach(f=>{const h=f.tipo_produtos?.id||f.produto_id||"",j=w[h];if(!j)return;const _=Number(f.valor_total||0),k=Number(f.valor_taxas||0),y=_+k,M=v.foco_valor==="liquido"?_:v.usar_taxas_na_meta?y:_;j.soma_na_meta&&(t+=M);const e=q[h],$=j.regra_comissionamento==="diferenciado",T=_;if($&&e){const b=E.find(g=>g.produto_id===h)?.valor||0,r=b>0?t/b*100:0,S=r>=120?e.fix_super_meta||e.fix_meta_atingida||e.fix_meta_nao_atingida||0:r>=100?e.fix_meta_atingida||e.fix_meta_nao_atingida||0:e.fix_meta_nao_atingida||0;u+=T*(S/100)}else{const b=e?.rule_id,r=b?C[b]:void 0,S=l?.meta_geral&&l.meta_geral>0?t/l.meta_geral*100:0;let g=0;r&&(S<100?g=r.meta_nao_atingida||0:S>=120?g=r.super_meta||r.meta_atingida||r.meta_nao_atingida||0:g=r.meta_atingida||r.meta_nao_atingida||0),m+=T*(g/100)}p+=_})});const N=l?.meta_geral&&l.meta_geral>0?t/l.meta_geral*100:0;return{baseMeta:t,valorLiquido:p,pctMetaGeral:N,comissaoGeral:m,comissaoDif:u,totalComissao:m+u}},[G,v,w,q,E,l,C]);return o?a.jsx("div",{children:"Carregando permissões..."}):n?a.jsxs("div",{className:"card-base",children:[a.jsxs("div",{className:"form-row",style:{marginBottom:16},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:x,onChange:t=>W(t.target.value),children:ea.map(t=>a.jsx("option",{value:t.id,children:t.label},t.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:V.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:V.fim,readOnly:!0})]})]}),F&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:F})}),I&&a.jsx("div",{children:"Carregando dados..."}),!I&&c&&a.jsxs("div",{className:"kpi-grid",children:[a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Meta (base)"}),a.jsx("div",{className:"kpi-value",children:c.baseMeta.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Meta geral"}),a.jsx("div",{className:"kpi-value",children:(l?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[c.pctMetaGeral.toFixed(1),"%"]})]}),a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Faturamento líquido"}),a.jsx("div",{className:"kpi-value",children:c.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:c.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",children:[a.jsx("div",{className:"kpi-label",children:"Comissão (diferenciado)"}),a.jsx("div",{className:"kpi-value",children:c.comissaoDif.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card kpi-highlight",children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:c.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]}):a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."})}export{ia as default};
