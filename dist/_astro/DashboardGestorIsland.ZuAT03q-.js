import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as o}from"./index.C0Fn7Wtz.js";import{s as h}from"./supabase.Ng8nq9tn.js";import{u as P}from"./usePermissao.DEV7Ufch.js";import{R as K,L as X,X as Q,Y as W,T as z,a as H}from"./LineChart.BvtkNKdM.js";import"./index.2_Y_w1Vs.js";function g(m){return m.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}function J(){const m=new Date,S=new Date(m.getFullYear(),m.getMonth(),1),r=new Date(m.getFullYear(),m.getMonth()+1,0),j=k=>k.toISOString().substring(0,10);return{inicio:j(S),fim:j(r)}}function oe(){const{ativo:m,loading:S}=P("Dashboard"),[r,j]=o.useState("OUTRO"),[k,w]=o.useState(""),[x,O]=o.useState([]),[D,M]=o.useState({}),[v,I]=o.useState(""),[f,G]=o.useState(""),[_,V]=o.useState([]),[y,A]=o.useState([]),[B,R]=o.useState(!0),[T,E]=o.useState(null);o.useEffect(()=>{const{inicio:t,fim:a}=J();I(t),G(a)},[]),o.useEffect(()=>{async function t(){try{const{data:a}=await h.auth.getUser();if(!a?.user){E("Usuário não autenticado.");return}w(a.user.id);const{data:i,error:d}=await h.from("users").select("id, nome_completo, user_types(name)").eq("id",a.user.id).maybeSingle();if(d)throw d;const n=i?.user_types?.name?.toUpperCase()||"";let l="OUTRO";if(n.includes("ADMIN")?l="ADMIN":n.includes("GESTOR")?l="GESTOR":n.includes("VENDEDOR")&&(l="VENDEDOR"),j(l),l==="GESTOR"){const{data:u,error:s}=await h.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a.user.id);if(s)throw s;const c=u?.map(p=>p.vendedor_id).filter(Boolean);O(c);const{data:b}=await h.from("users").select("id, nome_completo").in("id",c),N={};b?.forEach(p=>{N[p.id]=p.nome_completo}),M(N)}}catch(a){console.error(a),E("Erro ao carregar contexto do gestor.")}}t()},[r]),o.useEffect(()=>{if(!v||!f||r!=="GESTOR"&&r!=="ADMIN")return;async function t(){try{R(!0),E(null);let a=h.from("vendas").select(`
          id,
          data_lancamento,
          vendedor_id,
          clientes:clientes (nome),
          destinos:produtos!destino_id (nome),
          vendas_recibos (
            id,
            valor_total,
            produtos:tipo_produtos!produto_id (nome)
          )
        `).gte("data_lancamento",v).lte("data_lancamento",f).eq("cancelada",!1);r==="GESTOR"&&x.length>0&&(a=a.in("vendedor_id",x));const{data:i,error:d}=await a;if(d)throw d;V(i||[]);let n=h.from("metas_vendedor").select("vendedor_id, meta_geral, scope").gte("periodo",v).lte("periodo",f).eq("ativo",!0);r==="GESTOR"&&x.length>0&&(n=n.in("vendedor_id",x));const{data:l,error:u}=await n;if(u)throw u;A(l||[])}catch(a){console.error(a),E("Erro ao carregar dados do dashboard do gestor.")}finally{R(!1)}}t()},[v,f,x,r]);const{totalTeamSales:L,totalTeamDeals:U,ticketMedioEquipe:C,metaEquipe:F,atingimentoEquipe:Y,rankingEquipe:q}=o.useMemo(()=>{let t=0;const a={};let i=0;_.forEach(s=>{const c=(s.vendas_recibos||[]).reduce((N,p)=>N+Number(p.valor_total||0),0);t+=c;const b=s.vendedor_id||"0";a[b]=(a[b]||0)+c}),y.forEach(s=>{s.scope,i+=Number(s.meta_geral||0)});const d=_.length,n=d>0?t/d:0,l=i>0?t/i*100:0,u=Object.entries(a).map(([s,c])=>({vendedor_id:s,nome:D[s]||"Vendedor",total:c})).sort((s,c)=>s.total<c.total?1:-1);return{totalTeamSales:t,totalTeamDeals:d,ticketMedioEquipe:n,metaEquipe:i,atingimentoEquipe:l,rankingEquipe:u}},[_,y,D]);return S?e.jsx("div",{children:"Carregando permissões..."}):m?r!=="GESTOR"&&r!=="ADMIN"?e.jsx("div",{style:{padding:20},children:e.jsx("h3",{children:"Somente Gestores podem acessar este dashboard."})}):e.jsxs("div",{className:"dashboard-geral-page",children:[e.jsxs("div",{style:{marginBottom:15,padding:"12px 16px",borderRadius:8,background:"#312e81",border:"1px solid #4338ca",color:"#e0e7ff"},children:[e.jsx("strong",{children:"Dashboard do Gestor"})," — período:",e.jsxs("span",{style:{marginLeft:6},children:[new Date(v).toLocaleDateString("pt-BR")," até"," ",new Date(f).toLocaleDateString("pt-BR")]})]}),e.jsx("div",{className:"card-base card-purple mb-3",children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px,1fr))",gap:10},children:[e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Vendas da equipe"}),e.jsx("div",{className:"kpi-value",children:g(L)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Qtd. Vendas"}),e.jsx("div",{className:"kpi-value",children:U})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Ticket médio"}),e.jsx("div",{className:"kpi-value",children:g(C)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Meta da equipe"}),e.jsx("div",{className:"kpi-value",children:g(F)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Atingimento"}),e.jsxs("div",{className:"kpi-value",children:[Y.toFixed(1),"%"]})]})]})}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsx("h3",{style:{marginBottom:8},children:"Ranking da equipe"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[480px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Vendedor"}),e.jsx("th",{children:"Total vendido"})]})}),e.jsxs("tbody",{children:[q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:"Sem vendas no período."})}),q.map((t,a)=>e.jsxs("tr",{children:[e.jsxs("td",{children:["#",a+1," — ",t.nome]}),e.jsx("td",{children:g(t.total)})]},t.vendedor_id))]})]})})]}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsx("h3",{style:{marginBottom:8},children:"Evolução de vendas da equipe"}),e.jsx("div",{style:{width:"100%",height:260},children:e.jsx(K,{children:e.jsxs(X,{data:q.map((t,a)=>({name:t.nome,total:t.total})),children:[e.jsx(Q,{dataKey:"name"}),e.jsx(W,{}),e.jsx(z,{formatter:t=>g(Number(t||0))}),e.jsx(H,{type:"monotone",dataKey:"total",stroke:"#a855f7",strokeWidth:2})]})})})]}),B&&e.jsx("div",{children:"Carregando..."}),T&&e.jsx("div",{className:"card-base card-config",children:T})]}):e.jsx("div",{children:"Você não possui acesso ao Dashboard."})}export{oe as default};
