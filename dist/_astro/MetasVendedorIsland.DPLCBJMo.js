import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as d}from"./supabase.Ng8nq9tn.js";import{u as fe}from"./usePermissao.DiLe8-Rs.js";import{L as pe}from"./LoadingUsuarioContext.BaDUNi7o.js";function be(){const{permissao:h,ativo:Z,loading:y}=fe("Metas"),[R,ee]=s.useState(null),[w,ae]=s.useState(null),[te,P]=s.useState([]),[q,oe]=s.useState([]),[u,F]=s.useState(""),[I,B]=s.useState(new Date().toISOString().slice(0,7)),[k,S]=s.useState(!0),[M,E]=s.useState(""),[f,p]=s.useState([]),[$,V]=s.useState([]),[L,G]=s.useState({}),[_,U]=s.useState(null),[re,T]=s.useState(!0),[C,W]=s.useState(!1),[z,D]=s.useState(!1),[O,i]=s.useState(null);s.useEffect(()=>{se()},[]);async function se(){try{T(!0);const{data:a}=await d.auth.getUser(),t=a?.user?.id;if(!t){i("Usu√°rio n√£o autenticado.");return}const{data:o}=await d.from("users").select("id, nome_completo, uso_individual, company_id"),r=o?.find(x=>x.id===t)||null;ae(r);const{data:n}=await d.from("tipo_produtos").select("id, nome").eq("ativo",!0);oe(n||[]);const l=h==="admin",m=h==="edit";r?.company_id&&(l||m)?P(o?.filter(x=>x.company_id===r.company_id)||[]):P([r]);const{data:c}=await d.from("parametros_comissao").select("foco_valor").eq("company_id",r?.company_id||null).maybeSingle();ee(c||null),await g(r?.id||""),F(r?.id||"")}catch(a){console.error(a),i("Erro ao carregar dados iniciais")}finally{T(!1)}}async function g(a){if(!(h==="admin")&&!(h==="edit")&&a!==w?.id){V([]);return}const{data:r}=await d.from("metas_vendedor").select("*").eq("vendedor_id",a).order("periodo",{ascending:!1}),n=r||[];if(V(n),n.length>0){const{data:l}=await d.from("metas_vendedor_produto").select("meta_vendedor_id, produto_id, valor").in("meta_vendedor_id",n.map(c=>c.id)),m={};(l||[]).forEach(c=>{m[c.meta_vendedor_id]||(m[c.meta_vendedor_id]=[]),m[c.meta_vendedor_id].push(c)}),G(m)}else G({})}s.useEffect(()=>{!y&&u&&g(u)},[u,y]);const Q=h==="admin",H=h==="edit",j=w?.uso_individual||Q||H,ie=w?.uso_individual===!1&&(Q||H);function J(a){const t=a.replace(/\D/g,"");return t?(Number(t)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function N(a){if(!a)return 0;if(/^\d+$/.test(a))return Number(a)/100;const t=a.replace(/\./g,"").replace(",","."),o=parseFloat(t);return Number.isNaN(o)?0:o}function K(a){return a==null?"":Math.round(a*100).toString()}function X(){return f.reduce((a,t)=>a+N(t.valor),0)}async function ne(a){if(a.preventDefault(),i(null),!M||!u){i("Meta geral e vendedor s√£o obrigat√≥rios.");return}const t=X(),o=N(M),r=t;if(Number.isNaN(o)){i("Meta geral inv√°lida.");return}if(R?.foco_valor==="liquido"&&r<=0){i("Quando o foco √© valor l√≠quido, informe metas diferenciadas por produto.");return}const n=f.filter(l=>l.produto_id&&N(l.valor)>0);if(r>0&&n.length===0){i("Adicione pelo menos um produto com valor para a meta diferenciada.");return}try{W(!0);const l=`${I}-01`,m={vendedor_id:u,periodo:l,meta_geral:o,meta_diferenciada:r,ativo:k,scope:"vendedor"};let c=_;if(_){const{error:v}=await d.from("metas_vendedor").update(m).eq("id",_);if(v)throw v}else{const{data:v,error:b}=await d.from("metas_vendedor").insert(m).select("id").single();if(b)throw b;c=v.id}const x=c;if(await d.from("metas_vendedor_produto").delete().eq("meta_vendedor_id",x),n.length>0){const v=n.map(Y=>({meta_vendedor_id:x,produto_id:Y.produto_id,valor:N(Y.valor)})),{error:b}=await d.from("metas_vendedor_produto").insert(v);if(b)throw b}await g(u),A()}catch(l){console.error(l),i(l?.message?`Erro ao salvar meta: ${l.message}`:"Erro ao salvar meta.")}finally{W(!1)}}function A(){E(""),p([]),U(null),S(!0)}function le(){A(),D(!0),i(null)}function de(){A(),D(!1),i(null)}function ce(a){U(a.id),B(a.periodo.slice(0,7)),E(K(a.meta_geral));const t=L[a.id]||[];t.length>0?p(t.map(o=>({produto_id:o.produto_id,valor:K(o.valor)}))):p([]),S(a.ativo),D(!0),i(null)}async function ue(a,t){try{const{error:o}=await d.from("metas_vendedor").update({ativo:!t}).eq("id",a);if(o)throw o;await g(u)}catch{i("N√£o foi poss√≠vel alterar status da meta.")}}async function me(a){if(!confirm("Excluir esta meta?"))return;const{error:t}=await d.from("metas_vendedor").delete().eq("id",a);if(t){i("N√£o foi poss√≠vel excluir meta.");return}await g(u)}return y||re?e.jsx(pe,{}):Z?e.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[e.jsxs("div",{className:"card-base card-blue mb-2",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-end"},children:[e.jsx("h3",{children:"Metas cadastradas"}),j&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:le,disabled:z,children:"Adicionar meta"})]}),z&&e.jsxs("form",{onSubmit:ne,children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[ie&&e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Vendedor *"}),e.jsx("select",{className:"form-select",value:u,onChange:a=>F(a.target.value),children:te.map(a=>e.jsx("option",{value:a.id,children:a.nome_completo},a.id))})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Per√≠odo *"}),e.jsx("input",{type:"month",className:"form-input",value:I,onChange:a=>B(a.target.value)})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Meta Geral (R$) *"}),e.jsx("input",{className:"form-input",type:"text",value:J(M),onChange:a=>{const t=a.target.value.replace(/\D/g,"");E(t)},inputMode:"decimal",placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[220px]",children:[e.jsx("label",{className:"form-label",children:"Metas diferenciadas por produto (opcional)"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[f.map((a,t)=>e.jsxs("div",{className:"flex flex-col md:flex-row gap-2",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Produto"}),e.jsxs("select",{className:"form-select",value:a.produto_id,onChange:o=>{const r=[...f];r[t]={...r[t],produto_id:o.target.value},p(r)},children:[e.jsx("option",{value:"",children:"Selecione"}),q.map(o=>e.jsx("option",{value:o.id,children:o.nome},o.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[e.jsx("label",{className:"form-label",children:"Meta (R$)"}),e.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",value:J(a.valor),onChange:o=>{const r=o.target.value.replace(/\D/g,""),n=[...f];n[t]={...n[t],valor:r},p(n)},placeholder:"0,00"})]}),e.jsx("div",{className:"form-group flex-none flex items-end",children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>{p(f.filter((o,r)=>r!==t))},children:"Remover"})})]},t)),e.jsxs("div",{className:"form-row",style:{alignItems:"center"},children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>p([...f,{produto_id:"",valor:""}]),children:"+ Adicionar produto"}),e.jsxs("div",{style:{marginLeft:"auto",fontWeight:600},children:["Total diferenciada:"," ",X().toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]})]}),R?.foco_valor==="liquido"&&e.jsx("small",{style:{color:"#f97316"},children:"Foco em valor l√≠quido ativo: informe metas diferenciadas por produto."})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativa?"}),e.jsxs("select",{className:"form-select",value:k?"true":"false",onChange:a=>S(a.target.value==="true"),children:[e.jsx("option",{value:"true",children:"Sim"}),e.jsx("option",{value:"false",children:"N√£o"})]})]})]}),O&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:O})}),j&&e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:12},children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:C,children:C?"Salvando...":_?"Salvar altera√ß√µes":"Salvar meta"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:de,disabled:C,children:"Cancelar"})]})]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[880px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Per√≠odo"}),e.jsx("th",{children:"Meta Geral"}),e.jsx("th",{children:"Meta Diferenciada"}),e.jsx("th",{children:"Produtos"}),e.jsx("th",{children:"Ativo"}),j&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[$.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:j?6:5,children:"Nenhuma meta cadastrada."})}),$.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.periodo.slice(0,7)}),e.jsx("td",{children:a.meta_geral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.meta_diferenciada.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:(L[a.id]||[]).length===0?"‚Äî":(L[a.id]||[]).map(t=>`${q.find(r=>r.id===t.produto_id)?.nome||"Produto"}: ${t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`).join(" | ")}),e.jsx("td",{children:a.ativo?"Sim":"N√£o"}),j&&e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>ce(a),children:"‚úèÔ∏è"}),e.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>me(a.id),children:"üóëÔ∏è"}),e.jsx("button",{className:"btn-icon",title:a.ativo?"Inativar":"Ativar",onClick:()=>ue(a.id,a.ativo),children:a.ativo?"‚è∏Ô∏è":"‚ñ∂Ô∏è"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"Acesso ao m√≥dulo de Metas bloqueado."})}export{be as default};
