import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as t}from"./index.C0Fn7Wtz.js";import{s as c}from"./supabase.Ng8nq9tn.js";import{u as Ve}from"./usePermissao.DiLe8-Rs.js";import{t as B}from"./titleCase.DQLlfrnh.js";import{L as We}from"./LoadingUsuarioContext.BaDUNi7o.js";function p(n){return(n||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const Me=[{value:"Economico",label:"EconÃ´mico"},{value:"Intermediario",label:"IntermediÃ¡rio"},{value:"Variavel",label:"VariÃ¡vel"},{value:"Premium",label:"Premium"},{value:"Super Premium",label:"Super Premium"}];function Oe(n){if(!n)return"";const F=p(n),$=Me.find(y=>p(y.value)===F||p(y.label)===F);return $?$.label:n}function I(n){return n?(n.nome_fantasia?.trim()||n.nome_completo?.trim()||"").trim():""}const De={nome:"",destino:"",cidade_id:"",tipo_produto:"",atracao_principal:"",melhor_epoca:"",duracao_sugerida:"",nivel_preco:"",imagem_url:"",informacoes_importantes:"",ativo:!0,fornecedor_id:"",fornecedor_label:"",todas_as_cidades:!1};function ea(){const{permissao:n,ativo:F,loading:$}=Ve("Cadastros"),[y,Te]=t.useState([]),[z,ae]=t.useState([]),[w,se]=t.useState([]),[R,oe]=t.useState([]),[ie,Pe]=t.useState([]),[r,L]=t.useState(De),[x,Be]=t.useState(""),[C,S]=t.useState(""),[Fe,g]=t.useState(!1),[re,E]=t.useState([]),[G,te]=t.useState(!1),[U,ne]=t.useState(!0),[V,le]=t.useState(!1),[k,de]=t.useState(null),[ce,ue]=t.useState(null),[W,f]=t.useState(null),[me,A]=t.useState(null),[D,$e]=t.useState(!1),[O,Le]=t.useState(null),[M,fe]=t.useState([]),[H,Y]=t.useState(!1),[pe,he]=t.useState(null);async function q(e=!1){const s=[],o=[];ne(!0),f(null);try{const[{data:i,error:u},{data:l,error:m},b,_]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("subdivisoes").select("id, nome, pais_id").order("nome"),c.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome").then(async h=>h.error?(o.push(`tipo_produtos: ${h.error.message}`),console.warn("Fallback tipo_produtos por 'tipo':",h.error),await c.from("tipo_produtos").select("id, nome, tipo").order("tipo")):h),c.from("produtos").select("id, nome, destino, cidade_id, tipo_produto, informacoes_importantes, atracao_principal, melhor_epoca, duracao_sugerida, nivel_preco, imagem_url, ativo, fornecedor_id, created_at, todas_as_cidades").order(e?"nome":"created_at",{ascending:!!e}).limit(e?void 0:10)]);u?(s.push("paises"),u.message&&o.push(`paises: ${u.message}`)):Te(i||[]);const ye=l||[];if(m?(s.push("subdivisoes"),m.message&&o.push(`subdivisoes: ${m.message}`)):ae(ye),b.error)s.push("tipo_produtos"),b.error.message&&o.push(`tipo_produtos: ${b.error.message}`);else{const h=b.data||[];if(h.length===0){const{data:T,error:j}=await c.from("tipo_produtos").select("id, nome, tipo").order("nome");j?(s.push("tipo_produtos"),o.push(`tipo_produtos (fallback): ${j.message}`)):oe(T||[])}else oe(h)}if(_.error)s.push("produtos"),_.error.message&&o.push(`produtos: ${_.error.message}`);else{const h=_.data||[];Pe(h),$e(e);const T=Array.from(new Set(h.map(j=>j.cidade_id).filter(Boolean)));if(T.length){const{data:j,error:X}=await c.from("cidades").select("id, nome, subdivisao_id, subdivisoes (id, nome, pais_id)").in("id",T);if(X)s.push("cidades"),X.message&&o.push(`cidades: ${X.message}`);else{const we=j||[];se(we);const Ce=Array.from(new Set(we.map(Z=>Z.subdivisao_id).filter(Boolean)));if(Ce.length){const Z=new Set(ye.map(N=>N.id)),Se=Ce.filter(N=>!Z.has(N));if(Se.length){const{data:N,error:ee}=await c.from("subdivisoes").select("id, nome, pais_id").in("id",Se);ee?(s.push("subdivisoes"),ee.message&&o.push(`subdivisoes (faltantes): ${ee.message}`)):N?.length&&ae(Ue=>{const Ee=new Map(Ue.map(P=>[P.id,P]));return N.forEach(P=>Ee.set(P.id,P)),Array.from(Ee.values())})}}}}else se([])}}catch(i){console.error(i),s.push("geral"),i?.message&&o.push(`geral: ${i.message}`)}finally{if(s.length){const i=o.length?` Detalhes: ${o.join(" | ")}`:"";f(`Erro ao carregar: ${s.join(", ")}. Verifique permissoes/RLS.${i}`)}ne(!1)}}t.useEffect(()=>{q(!1)},[]),t.useEffect(()=>{let e=!0;async function s(){try{const{data:o}=await c.auth.getSession(),u=o?.session?.user||(await c.auth.getUser()).data?.user||null;if(!u||!e)return;const{data:l,error:m}=await c.from("users").select("company_id").eq("id",u.id).maybeSingle();if(!e)return;if(m){console.error("Erro ao buscar company_id dos fornecedores:",m);return}Le(l?.company_id||null)}catch(o){console.error("Erro ao determinar company_id dos fornecedores:",o)}}return s(),()=>{e=!1}},[]),t.useEffect(()=>{if(!O){fe([]);return}let e=!0;async function s(){const{data:o,error:i}=await c.from("fornecedores").select("id, nome_completo, nome_fantasia").eq("company_id",O).order("nome_fantasia",{ascending:!0});if(e){if(i){console.error("Erro ao carregar fornecedores:",i);return}fe(o||[])}}return s(),()=>{e=!1}},[O]),t.useEffect(()=>{x.trim()&&!D&&q(!0)},[x,D]);const be=t.useMemo(()=>new Map(z.map(e=>[e.id,e])),[z]),ge=t.useMemo(()=>new Map(M.map(e=>[e.id,I(e)])),[M]);function ke(e){if(!e)return"";const s=w.find(i=>i.id===e);if(!s)return"";const o=be.get(s.subdivisao_id);return o?`${s.nome} (${o.nome})`:s.nome}function ve(e){return e&&((e.nome||"").trim()||e.tipo)||""}const J=t.useMemo(()=>{const e=new Map(w.map(i=>[i.id,i])),s=new Map(y.map(i=>[i.id,i])),o=new Map(R.map(i=>[i.id,i]));return ie.map(i=>{const u=i.todas_as_cidades?null:e.get(i.cidade_id||""),l=u?be.get(u.subdivisao_id)||u.subdivisoes:void 0,m=l?s.get(l.pais_id):void 0,b=i.tipo_produto?o.get(i.tipo_produto):void 0;return{...i,cidade_nome:i.todas_as_cidades?"Todas as cidades":u?.nome||"",subdivisao_nome:l?.nome||"",pais_nome:m?.nome||"",tipo_nome:ve(b),fornecedor_nome:ge.get(i.fornecedor_id||"")||""}})},[ie,w,z,y,R,ge]),xe=t.useMemo(()=>{if(!x.trim())return J;const e=p(x);return J.filter(s=>p(s.nome).includes(e)||p(s.cidade_nome).includes(e)||p(s.subdivisao_nome).includes(e)||p(s.pais_nome).includes(e)||p(s.tipo_nome).includes(e)||p(s.destino||"").includes(e))},[x,J]),K=!!k?"full":pe===null?"selection":pe?"global":"full",v=K==="global";function d(e,s){L(o=>({...o,[e]:s}))}function Ae(e){if(r.todas_as_cidades)return;S(e);const s=w.find(o=>o.id===r.cidade_id);(!s||!p(s.nome).includes(p(e)))&&L(o=>({...o,cidade_id:""})),g(!0)}function _e(e){d("todas_as_cidades",e),e&&(d("cidade_id",""),S(""),g(!1),E([]))}function je(e){he(e),_e(e),e?d("destino",B("Global")):d("destino","")}function qe(e){d("fornecedor_label",e);const s=e.trim().toLowerCase();if(!s){d("fornecedor_id","");return}const o=M.find(i=>I(i).toLowerCase()===s);d("fornecedor_id",o?o.id:"")}function Q(){L(De),de(null),f(null),S(""),g(!1),he(null)}function Ie(e){const s=w.find(o=>o.id===e.cidade_id);de(e.id),L({nome:e.nome,cidade_id:e.cidade_id,tipo_produto:e.tipo_produto||"",atracao_principal:e.atracao_principal||"",melhor_epoca:e.melhor_epoca||"",duracao_sugerida:e.duracao_sugerida||"",nivel_preco:e.nivel_preco||"",imagem_url:e.imagem_url||"",informacoes_importantes:e.informacoes_importantes||"",ativo:e.ativo??!0,destino:e.destino||"",fornecedor_id:e.fornecedor_id||"",fornecedor_label:I(M.find(o=>o.id===e.fornecedor_id)),todas_as_cidades:e.todas_as_cidades??!1}),S(e.todas_as_cidades?"":ke(e.cidade_id)||s?.nome||""),g(!1),Y(!0)}function ze(){Q(),Y(!0),f(null)}function Ne(){Q(),Y(!1)}t.useEffect(()=>{if(C.trim().length<2){E([]);return}const e=new AbortController,s=setTimeout(async()=>{te(!0),A(null);try{const{data:o,error:i}=await c.rpc("buscar_cidades",{q:C.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),A("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:u,error:l}=await c.from("cidades").select("id, nome, subdivisao_id").ilike("nome",`%${C.trim()}%`).order("nome");l?(console.error("Erro no fallback de cidades:",l),A("Erro ao buscar cidades.")):(E(u||[]),A(null))}else E(o||[])}finally{e.signal.aborted||te(!1)}},300);return()=>{e.abort(),clearTimeout(s)}},[C]);async function Re(e){if(e.preventDefault(),n==="view"){f("Voce nao tem permissao para salvar produtos.");return}if(!r.nome.trim()){f("Nome e obrigatorio.");return}if(!r.destino.trim()){f("Destino e obrigatorio.");return}if(!r.todas_as_cidades&&!r.cidade_id){f("Cidade e obrigatoria quando o produto nao for global.");return}if(!r.tipo_produto){f("Tipo de produto e obrigatorio.");return}try{le(!0),f(null);const s=l=>{const m=l?.message||l?.error?.message||"",b=l?.details||l?.error?.details||"",_=l?.hint||l?.error?.hint||"";return[m,b,_].filter(Boolean).join(" | ")},o=B(r.nome),i=B(r.destino),u={nome:o,destino:i,cidade_id:r.todas_as_cidades?null:r.cidade_id,tipo_produto:r.tipo_produto,atracao_principal:r.atracao_principal.trim()||null,melhor_epoca:r.melhor_epoca.trim()||null,duracao_sugerida:r.duracao_sugerida.trim()||null,nivel_preco:r.nivel_preco.trim()||null,imagem_url:r.imagem_url.trim()||null,informacoes_importantes:r.informacoes_importantes.trim()||null,ativo:r.ativo,fornecedor_id:r.fornecedor_id||null,todas_as_cidades:r.todas_as_cidades};if(k){const{error:l}=await c.from("produtos").update(u).eq("id",k);if(l){const m=s(l);throw new Error(m||l.message)}}else{const{error:l}=await c.from("produtos").insert(u);if(l){const m=s(l);throw new Error(m||l.message)}}Q(),await q(D)}catch(s){console.error(s);const o=s?.message||s?.error?.message||"";f(`Erro ao salvar produto.${o?` Detalhes: ${o}`:""}`)}finally{le(!1)}}async function Ge(e){if(n!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{ue(e),f(null);const{error:s}=await c.from("produtos").delete().eq("id",e);if(s)throw s;await q(D)}catch(s){console.error(s),f("Nao foi possivel excluir o produto. Verifique vinculos com vendas/orcamentos.")}finally{ue(null)}}return $?a.jsx(We,{}):F?a.jsxs("div",{className:"destinos-page",children:[a.jsx("div",{className:"card-base mb-3",children:a.jsxs("div",{className:"form-row",style:{display:"flex",gap:12,flexWrap:"wrap",alignItems:"flex-end"},children:[a.jsxs("div",{className:"form-group",style:{flex:"1 1 320px"},children:[a.jsx("label",{className:"form-label",children:"Buscar produto"}),a.jsx("input",{className:"form-input",value:x,onChange:e=>Be(e.target.value),placeholder:"Busque por nome, tipo, destino, cidade, estado/provÃ­ncia ou paÃ­s"})]}),n!=="view"&&a.jsx("div",{className:"form-group",style:{alignItems:"flex-end"},children:a.jsx("button",{type:"button",className:"btn btn-primary",onClick:ze,disabled:H,children:"Adicionar produto"})})]})}),H&&K==="selection"&&a.jsxs("div",{className:"card-base card-blue mb-3",children:[a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Todas as cidades"}),a.jsxs("div",{className:"flex gap-2",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>je(!1),children:"Nao"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>je(!0),children:"Sim"})]}),a.jsx("small",{style:{color:"#64748b"},children:'Escolha "Sim" para cadastrar um produto global; "Nao" abre o formulario completo.'})]})}),a.jsx("div",{className:"mt-2 flex flex-wrap gap-2",style:{justifyContent:"flex-end"},children:a.jsx("button",{type:"button",className:"btn btn-light",onClick:Ne,children:"Cancelar"})})]}),H&&K!=="selection"&&a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:Re,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome do produto *"}),a.jsx("input",{className:"form-input",value:r.nome,onChange:e=>d("nome",e.target.value),onBlur:e=>d("nome",B(e.target.value)),placeholder:"Ex: Passeio em Gramado, Pacote Paris...",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo *"}),a.jsxs("select",{className:"form-select",value:r.tipo_produto,onChange:e=>d("tipo_produto",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione o tipo"}),R.map(e=>a.jsx("option",{value:e.id,children:ve(e)||"(sem nome)"},e.id))]})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Destino *"}),a.jsx("input",{className:"form-input",value:r.destino,onChange:e=>d("destino",e.target.value),onBlur:e=>d("destino",B(e.target.value)),placeholder:v?"Global":"Ex: Disney, Porto de Galinhas",disabled:n==="view"||v})]}),!v&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"form-group",style:{flex:1,minWidth:200},children:[a.jsx("label",{className:"form-label",children:"Todas as cidades"}),a.jsxs("select",{className:"form-select",value:r.todas_as_cidades?"true":"false",onChange:e=>_e(e.target.value==="true"),disabled:n==="view",children:[a.jsx("option",{value:"false",children:"Nao"}),a.jsx("option",{value:"true",children:"Sim"})]}),a.jsx("small",{style:{color:"#64748b"},children:"Produtos globais ficam disponiveis para qualquer cidade e nao salvam cidade especifica."})]}),a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Cidade *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:C,onChange:e=>Ae(e.target.value),onFocus:()=>g(!0),onBlur:()=>setTimeout(()=>g(!1),150),disabled:n==="view"||r.todas_as_cidades,style:{marginBottom:6}}),G&&a.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),me&&!G&&a.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:me}),Fe&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb"},children:[re.length===0&&!G&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),re.map(e=>{const s=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return a.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:r.cidade_id===e.id?"#e0f2fe":"#fff",borderColor:r.cidade_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:o=>{o.preventDefault(),d("cidade_id",e.id),S(s),g(!1),E([])},children:[s,e.pais_nome?a.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["- ",e.pais_nome]}):null]},e.id)})]})]})]}),a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Fornecedor (opcional)"}),a.jsx("input",{className:"form-input",list:"fornecedores-list",placeholder:"Escolha um fornecedor",value:r.fornecedor_label,onChange:e=>qe(e.target.value),disabled:n==="view"}),a.jsx("datalist",{id:"fornecedores-list",children:M.map(e=>a.jsx("option",{value:I(e)},e.id))})]})]}),!v&&a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Atracao principal"}),a.jsx("input",{className:"form-input",value:r.atracao_principal,onChange:e=>d("atracao_principal",e.target.value),placeholder:"Ex: Disney, Torre Eiffel...",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Melhor epoca"}),a.jsx("input",{className:"form-input",value:r.melhor_epoca,onChange:e=>d("melhor_epoca",e.target.value),placeholder:"Ex: Dezembro a Marco",disabled:n==="view"})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[!v&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Duracao sugerida"}),a.jsxs("select",{className:"form-select",value:r.duracao_sugerida,onChange:e=>d("duracao_sugerida",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),a.jsx("option",{value:"De 1 a 3 dias",children:"De 1 a 3 dias"}),a.jsx("option",{value:"De 3 a 5 dias",children:"De 3 a 5 dias"}),a.jsx("option",{value:"De 5 a 7 dias",children:"De 5 a 7 dias"}),a.jsx("option",{value:"De 7 a 10 dias",children:"De 7 a 10 dias"}),a.jsx("option",{value:"10 dias ou mais",children:"10 dias ou mais"})]})]}),a.jsxs("div",{className:"form-group",style:v?{flex:1}:void 0,children:[a.jsx("label",{className:"form-label",children:"Nivel de preco"}),a.jsxs("select",{className:"form-select",value:r.nivel_preco,onChange:e=>d("nivel_preco",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),Me.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))]})]}),!v&&a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Imagem (URL)"}),a.jsx("input",{className:"form-input",value:r.imagem_url,onChange:e=>d("imagem_url",e.target.value),placeholder:"URL de uma imagem do destino",disabled:n==="view"})]})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Informacoes importantes"}),a.jsx("textarea",{className:"form-input",rows:3,value:r.informacoes_importantes,onChange:e=>d("informacoes_importantes",e.target.value),placeholder:"Observacoes gerais, dicas, documentacao necessaria, etc.",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Ativo"}),a.jsxs("select",{className:"form-select",value:r.ativo?"true":"false",onChange:e=>d("ativo",e.target.value==="true"),disabled:n==="view",children:[a.jsx("option",{value:"true",children:"Sim"}),a.jsx("option",{value:"false",children:"Nao"})]})]}),a.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",style:{justifyContent:"flex-end"},children:[a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:V,children:V?"Salvando...":k?"Salvar alteracoes":"Salvar produto"}),a.jsx("button",{type:"button",className:"btn btn-light",onClick:Ne,disabled:V,children:"Cancelar"})]})]})}),"      ",W&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:W})}),!D&&!W&&a.jsx("div",{className:"card-base card-config mb-3",children:"Ultimos Produtos Cadastrados (10). Digite na busca para consultar todos."}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1080px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Fornecedor"}),a.jsx("th",{children:"Nivel de preco"}),a.jsx("th",{children:"Ativo"}),a.jsx("th",{children:"Criado em"}),a.jsx("th",{className:"th-actions",children:"Acoes"})]})}),a.jsxs("tbody",{children:[U&&a.jsx("tr",{children:a.jsx("td",{colSpan:8,children:"Carregando produtos..."})}),!U&&xe.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:8,children:"Nenhum produto encontrado."})}),!U&&xe.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.destino||"-"}),a.jsx("td",{children:e.cidade_nome||"-"}),a.jsx("td",{children:e.fornecedor_nome||"-"}),a.jsx("td",{children:Oe(e.nivel_preco)||"-"}),a.jsx("td",{children:e.ativo?"Sim":"Nao"}),a.jsx("td",{children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-"}),a.jsxs("td",{className:"th-actions",children:[n!=="view"&&a.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>Ie(e),children:"âœï¸"}),(n==="admin"||n==="delete")&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>Ge(e.id),disabled:ce===e.id,children:ce===e.id?"...":"ğŸ—‘ï¸"})]})]},e.id))]})]})})]}):a.jsx("div",{children:"Voce nao possui acesso ao modulo de Cadastros."})}export{ea as default};
