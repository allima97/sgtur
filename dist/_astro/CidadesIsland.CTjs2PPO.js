import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r as i}from"./index.C0Fn7Wtz.js";import{u as G}from"./usePermissao.72SYthuA.js";import{r as I}from"./logs.WCvMC_es.js";function N(l){return(l||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const H={nome:"",estado_id:"",descricao:""};function re(){const l=G("Cidades"),_=G("Cadastros"),m=l.isAdmin||_.isAdmin,p=l.loading||_.loading,t=m?"admin":l.permissao!=="none"?l.permissao:_.permissao,g=m||t!=="none",C=m||t==="create"||t==="edit"||t==="delete"||t==="admin",u=m||t==="edit"||t==="delete"||t==="admin",b=m||t==="delete"||t==="admin",[w,J]=i.useState([]),[S,K]=i.useState([]),[k,O]=i.useState([]),[f,Q]=i.useState(""),[o,E]=i.useState(H),[h,P]=i.useState(null),[y,x]=i.useState(null),[T,F]=i.useState(!1),[L,B]=i.useState(null),[z,D]=i.useState(!0),[j,U]=i.useState(!1);async function v(a=!1){if(!g)return;async function r(){if(a){const s=[];let n=0;for(;;){const{data:A,error:W}=await c.from("cidades").select("id, nome, estado_id, descricao, created_at").order("nome").range(n,n+1e3-1);if(W)throw W;if(s.push(...A||[]),!A||A.length<1e3)break;n+=1e3}return s}else{const{data:s,error:d}=await c.from("cidades").select("id, nome, estado_id, descricao, created_at").order("created_at",{ascending:!1}).limit(10);if(d)throw d;return s||[]}}try{D(!0);const[{data:s},{data:d},n]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("estados").select("id, nome, pais_id").order("nome"),r()]);J(s||[]),K(d||[]),O(n||[]),U(a)}catch(s){console.error(s),x("Erro ao carregar cidades.")}finally{D(!1)}}i.useEffect(()=>{if(!p){if(!g){D(!1);return}v(!1)}},[p,g]),i.useEffect(()=>{f.trim()&&!j&&v(!0)},[f,j]);const M=i.useMemo(()=>{const a=new Map(S.map(s=>[s.id,s])),r=new Map(w.map(s=>[s.id,s]));return k.map(s=>{const d=a.get(s.estado_id),n=d?r.get(d.pais_id):void 0;return{...s,estado_nome:d?.nome||"",pais_nome:n?.nome||""}})},[k,S,w]),V=i.useMemo(()=>{if(!f.trim())return M;const a=N(f);return M.filter(r=>N(r.nome).includes(a)||N(r.estado_nome).includes(a)||N(r.pais_nome).includes(a))},[f,M]);function q(a,r){E(s=>({...s,[a]:r}))}function X(a){u&&(P(a.id),E({nome:a.nome,estado_id:a.estado_id,descricao:a.descricao||""}))}function R(){C&&(P(null),E(H))}async function Y(a){if(a.preventDefault(),!(!C&&!u)){if(!o.estado_id){x("Estado √© obrigat√≥rio.");return}try{F(!0),x(null);const r={nome:o.nome,estado_id:o.estado_id,descricao:o.descricao||null};if(h){const{error:s}=await c.from("cidades").update(r).eq("id",h);if(s)throw s;await I({user_id:null,acao:"cidade_editada",modulo:"Cadastros",detalhes:{id:h,payload:r}})}else{const{error:s}=await c.from("cidades").insert(r);if(s)throw s;await I({user_id:null,acao:"cidade_criada",modulo:"Cadastros",detalhes:r})}R(),v(j)}catch(r){console.error(r),x("Erro ao salvar cidade.")}finally{F(!1)}}}async function Z(a){if(b&&confirm("Excluir cidade?"))try{B(a);const{error:r}=await c.from("cidades").delete().eq("id",a);if(r)throw r;await I({user_id:null,acao:"cidade_excluida",modulo:"Cadastros",detalhes:{id:a}}),v(j)}catch(r){console.error(r),x("Erro ao excluir cidade (provavelmente usada em produtos/destinos).")}finally{B(null)}}return!g&&!m?p?e.jsx("div",{className:"auth-info",children:"Carregando permiss√µes..."}):e.jsx("div",{className:"auth-error",children:"Voc√™ n√£o possui permiss√£o para visualizar Cidades."}):e.jsxs("div",{className:"cidades-page",children:[(C||u)&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:Y,children:[e.jsx("h3",{children:h?"Editar cidade":"Nova cidade"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:o.nome,onChange:a=>q("nome",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Estado *"}),e.jsxs("select",{className:"form-select",value:o.estado_id,onChange:a=>q("estado_id",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione o estado"}),S.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," ‚Äî ",w.find(r=>r.id===a.pais_id)?.nome||"Sem pa√≠s"]},a.id))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Descri√ß√£o"}),e.jsx("textarea",{className:"form-input",rows:3,value:o.descricao,onChange:a=>q("descricao",a.target.value)})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",disabled:T,children:T?"Salvando...":h?"Salvar altera√ß√µes":"Adicionar cidade"}),h&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:R,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cidade"}),e.jsx("input",{className:"form-input",placeholder:"Nome, estado ou pa√≠s...",value:f,onChange:a=>Q(a.target.value)})]})})}),p&&e.jsx("div",{className:"auth-info mb-3",children:"Carregando permiss√µes..."}),!p&&y&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:y})}),!j&&!y&&e.jsx("div",{className:"card-base card-config mb-3",children:"√öltimas Cidades Cadastradas (10). Digite na busca para consultar todas."}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cidade"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Pa√≠s"}),e.jsx("th",{children:"Criada em"}),(u||b)&&e.jsx("th",{className:"th-actions",children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[z&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!z&&V.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma cidade encontrada."})}),!z&&V.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.estado_nome||"‚Äî"}),e.jsx("td",{children:a.pais_nome||"‚Äî"}),e.jsx("td",{children:a.created_at?a.created_at.slice(0,10):"‚Äî"}),(u||b)&&e.jsxs("td",{className:"th-actions",children:[u&&e.jsx("button",{className:"btn-icon",onClick:()=>X(a),title:"Editar",children:"‚úèÔ∏è"}),b&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Z(a.id),disabled:L===a.id,title:"Excluir",children:L===a.id?"...":"üóëÔ∏è"})]})]},a.id))]})]})})]})}export{re as default};
