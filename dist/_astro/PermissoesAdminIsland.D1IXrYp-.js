import{j as s}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as t}from"./supabase.Ng8nq9tn.js";import{u as C}from"./usePermissao.Bkt8qSjs.js";const p=["Dashboard","Clientes","Vendas","Orcamentos","Operacao","Comissionamento","Cadastros","Paises","Cidades","Destinos","Produtos","Relatorios","Parametros","Metas","RegrasComissao","Admin","AdminDashboard","AdminLogs","AdminUsers"];function S(){const{permissao:h,ativo:x,loading:f}=C("AdminDashboard"),[j,g]=i.useState([]),[v,d]=i.useState([]),[b,l]=i.useState(!0),[c,m]=i.useState(null),[y,_]=i.useState(!1);if(i.useEffect(()=>{async function e(){const{data:o}=await t.auth.getUser();if(!o?.user)return;const{data:a}=await t.from("users").select("id, user_types(name)").eq("id",o.user.id).maybeSingle(),r=Array.isArray(a?.user_types)&&a.user_types.length>0&&a.user_types[0].name?.toUpperCase()||"";_(r.includes("ADMIN"))}e()},[]),f)return s.jsx("div",{children:"Carregando permissões..."});if(!x||!y)return s.jsx("div",{style:{padding:20},children:s.jsx("h3",{children:"Apenas administradores podem acessar este módulo."})});i.useEffect(()=>{async function e(){try{l(!0),m(null);const{data:o}=await t.from("users").select("id, nome_completo, email, user_types(name)").order("nome_completo"),a=o?.map(n=>({id:n.id,nome_completo:n.nome_completo,email:n.email,tipo:Array.isArray(n.user_types)&&n.user_types.length>0&&n.user_types[0].name||"OUTRO"}))||[];g(a);const{data:r}=await t.from("modulo_acesso").select("*");d(r||[])}catch(o){console.error(o),m("Erro ao carregar dados.")}finally{l(!1)}}e()},[]);function w(e,o){const a=A(e,o);return a||{id:"",usuario_id:e,modulo:o,permissao:"view",ativo:!1}}function A(e,o){return N.find(a=>a.usuario_id===e&&a.modulo===o)}const N=h?v:[];async function u(e){try{if(e.id){const{error:a}=await t.from("modulo_acesso").update({permissao:e.permissao,ativo:e.ativo}).eq("id",e.id);if(a)throw a}else{const{error:a}=await t.from("modulo_acesso").insert({usuario_id:e.usuario_id,modulo:e.modulo,permissao:e.permissao,ativo:e.ativo});if(a)throw a}const{data:o}=await t.from("modulo_acesso").select("*");d(o||[])}catch(o){console.error(o),alert("Erro ao salvar permissão.")}}return s.jsxs("div",{className:"permissoes-admin-page",children:[s.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-rose-950 border border-rose-700 text-rose-100",children:[s.jsx("strong",{children:"Editor de Permissões"})," — controle total dos módulos"]}),c&&s.jsx("div",{className:"card-base card-config mb-3",children:c}),b&&s.jsx("div",{children:"Carregando..."}),s.jsxs("div",{className:"card-base card-red",children:[s.jsx("h3",{className:"mb-3 font-semibold",children:"Usuários"}),s.jsx("div",{className:"table-container overflow-x-auto",children:s.jsxs("table",{className:"table-default table-header-red min-w-[900px]",children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{className:"min-w-[180px]",children:"Usuário"}),p.map(e=>s.jsx("th",{children:e},e))]})}),s.jsx("tbody",{children:j.map(e=>s.jsxs("tr",{children:[s.jsxs("td",{children:[s.jsx("strong",{children:e.nome_completo}),s.jsx("br",{}),s.jsx("small",{children:e.email}),s.jsx("br",{}),s.jsxs("small",{children:["Tipo: ",e.tipo]})]}),p.map(o=>{const a=w(e.id,o);return s.jsx("td",{children:s.jsxs("div",{className:"flex flex-col gap-1",children:[s.jsxs("label",{className:"text-xs",children:[s.jsx("input",{type:"checkbox",checked:a.ativo,onChange:r=>u({...a,ativo:r.target.checked})})," ","ativo"]}),s.jsxs("select",{disabled:!a.ativo,value:a.permissao,onChange:r=>u({...a,permissao:r.target.value}),className:"text-xs bg-indigo-950 text-indigo-100 border border-indigo-900 rounded px-1 py-0.5",children:[s.jsx("option",{value:"view",children:"View"}),s.jsx("option",{value:"edit",children:"Edit"}),s.jsx("option",{value:"admin",children:"Admin"})]})]})},o)})]},e.id))})]})})]})]})}export{S as default};
