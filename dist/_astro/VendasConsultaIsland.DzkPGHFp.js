import{j as e,s as u}from"./supabase.DNkd6bxA.js";import{r as i}from"./index.C0Fn7Wtz.js";import{r as L}from"./logs.WCvMC_es.js";import{u as ce}from"./usePermissao.72SYthuA.js";function C(l){return(l||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function xe(){const{permissao:l,ativo:Q,loading:V,isAdmin:X}=ce("Vendas"),v=l!=="none",Y=l==="create"||l==="edit"||l==="delete"||l==="admin",A=l==="edit"||l==="delete"||l==="admin",j=l==="delete"||l==="admin",[h,Z]=i.useState(null),[ee,B]=i.useState(!0),[q,ae]=i.useState([]),[te,M]=i.useState([]),[y,de]=i.useState(""),[F,D]=i.useState(null),[I,O]=i.useState(!0),[$,T]=i.useState(null),[s,E]=i.useState(null),[U,P]=i.useState(!1),[k,W]=i.useState(!1),[z,G]=i.useState(null);i.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&T(t)},[]),i.useEffect(()=>{async function a(){try{D(null),B(!0);const{data:t}=await u.auth.getUser(),n=t?.user?.id;if(!n){D("Usu√°rio n√£o autenticado.");return}const{data:p}=await u.from("users").select("id, user_types(name)").eq("id",n).maybeSingle(),m=p?.user_types?.name||t?.user?.user_metadata?.name||"",o=String(m||"").toUpperCase();let x="VENDEDOR";o.includes("ADMIN")?x="ADMIN":o.includes("GESTOR")?x="GESTOR":o.includes("VENDEDOR")?x="VENDEDOR":x="OUTRO";let d=[n];if(x==="GESTOR"){const{data:r}=await u.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",n),b=r?.map(g=>g.vendedor_id).filter(g=>!!g)||[];d=Array.from(new Set([n,...b]))}else x==="ADMIN"&&(d=[]);Z({usuarioId:n,papel:x,vendedorIds:d})}catch(t){console.error(t),D("Erro ao carregar contexto do usu√°rio.")}finally{B(!1)}}a()},[]);async function S(){if(!(!v||!h))try{O(!0);let a=u.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          data_lancamento,
          data_embarque,
          clientes(nome),
          destinos:produtos!destino_id (
            nome,
            cidade_id
          )
        `).order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(a=a.in("vendedor_id",h.vendedorIds));const{data:t,error:n}=await a;if(n)throw n;const p=Array.from(new Set((t||[]).map(d=>d.destinos?.cidade_id).filter(d=>!!d)));let m={};if(p.length>0){const{data:d,error:r}=await u.from("cidades").select("id, nome").in("id",p);r?console.error(r):m=Object.fromEntries((d||[]).map(b=>[b.id,b.nome]))}const o=(t||[]).map(d=>{const r=d.destinos?.cidade_id||"";return{id:d.id,vendedor_id:d.vendedor_id,cliente_id:d.cliente_id,destino_id:d.destino_id,destino_cidade_id:r,data_lancamento:d.data_lancamento,data_embarque:d.data_embarque,cliente_nome:d.clientes?.nome||"",destino_nome:d.destinos?.nome||"",destino_cidade_nome:r&&m[r]||""}});ae(o);const x=o.map(d=>d.id);if(x.length===0)M([]);else{const{data:d}=await u.from("vendas_recibos").select("*").in("venda_id",x),r=Array.from(new Set((d||[]).map(c=>c.produto_id).filter(c=>!!c))),b=o.reduce((c,f)=>(f.destino_cidade_id&&(c[f.id]=f.destino_cidade_id),c),{});let g=[],K={};if(r.length>0){const{data:c,error:f}=await u.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").in("tipo_produto",r);!f&&c?g=c:f&&console.error(f);const{data:w,error:N}=await u.from("tipo_produtos").select("id, nome, disponivel_todas_cidades").in("id",r);!N&&w?K=Object.fromEntries(w.map(_=>[_.id,{nome:_.nome||"Produto",disponivel_todas_cidades:_.disponivel_todas_cidades}])):N&&console.error(N)}const oe=(d||[]).map(c=>{const f=b[c.venda_id]||"",w=g.find(_=>{const re=!!_?.tipo_produtos?.disponivel_todas_cidades;return _.tipo_produto===c.produto_id&&(re||!f||_.cidade_id===f)}),N=K[c.produto_id]||{};return{...c,produto_nome:w?.nome||N.nome||""}})||[];M(oe)}if($){const d=o.find(r=>r.id===$);d&&E(d),T(null)}}catch(a){console.error(a),D("Erro ao carregar vendas.")}finally{O(!1)}}i.useEffect(()=>{!V&&v&&h&&S()},[V,v,h]);const H=i.useMemo(()=>h?h.papel==="ADMIN"?"Todas as vendas":h.papel==="GESTOR"?"Vendas da sua equipe":"Suas vendas":"",[h]),J=i.useMemo(()=>{if(!y.trim())return q;const a=C(y);return q.filter(t=>C(t.cliente_nome||"").includes(a)||C(t.destino_nome||"").includes(a)||C(t.id).includes(a))},[q,y]);function R(a){return te.filter(t=>t.venda_id===a)}async function ne(a){if(!(!j&&!X)&&confirm("Tem certeza que deseja CANCELAR esta venda?"))try{W(!0),await u.from("vendas_recibos").delete().eq("venda_id",a.id),await u.from("vendas").delete().eq("id",a.id),await L({acao:"venda_cancelada",modulo:"Vendas",detalhes:{id:a.id}}),await S(),E(null)}catch(t){console.error(t),alert("Erro ao cancelar venda.")}finally{W(!1)}}async function ie(a,t){if(j&&confirm("Excluir este recibo?"))try{G(a),await u.from("vendas_recibos").delete().eq("id",a),await L({acao:"recibo_excluido",modulo:"Vendas",detalhes:{recibo_id:a,venda_id:t}}),await S()}catch(n){console.error(n),alert("Erro ao excluir recibo.")}finally{G(null)}}async function se(a,t){if(A)try{P(!0),await u.from("vendas").update({data_embarque:t}).eq("id",a.id),await L({acao:"venda_remarcada",modulo:"Vendas",detalhes:{venda_id:a.id,nova_data:t}}),await S()}catch(n){console.error(n),alert("Erro ao remarcar.")}finally{P(!1)}}return Q?ee||V?e.jsx("div",{className:"card-base card-config",children:"Carregando contexto do usu√°rio..."}):v?e.jsxs("div",{className:"vendas-consulta-page",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",style:{marginTop:8},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar venda"}),e.jsx("input",{className:"form-input",placeholder:"Nome, destino ou ID...",value:y,onChange:a=>de(a.target.value)}),H&&e.jsxs("small",{style:{color:"#64748b"},children:[H," ",h?.papel!=="ADMIN"?"(restri√ß√£o por vendedor)":""]})]}),Y&&e.jsx("div",{className:"form-group",style:{alignItems:"flex-end"},children:e.jsx("a",{className:"btn btn-primary",href:"/vendas/cadastro",children:"Nova venda"})})]})}),F&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:F})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{style:{textAlign:"center"},children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),v&&e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[I&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando..."})}),!I&&J.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma venda encontrada."})}),!I&&J.map(a=>{const t=R(a.id).reduce((m,o)=>m+(o.valor_total||0),0),n=R(a.id).reduce((m,o)=>m+(o.valor_taxas||0),0),p=R(a.id).map(m=>m.produto_nome||"").filter(Boolean);return e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_nome}),e.jsx("td",{children:a.destino_cidade_nome||"-"}),e.jsx("td",{children:p.length===0?"-":e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:2},children:p.map((m,o)=>e.jsx("span",{children:m},`${a.id}-prod-${o}`))})}),e.jsx("td",{style:{textAlign:"center"},children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{children:["R$"," ",t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:n===0?"-":`R$ ${n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",title:"Ver detalhes",onClick:()=>E(a),children:"üëÅÔ∏è"})})]},a.id)})]})]})}),s&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:"820px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{children:e.jsx("div",{className:"modal-title",style:{color:"#16a34a",fontSize:"1.15rem",fontWeight:800},children:"Detalhes da venda"})}),e.jsx("button",{className:"btn-ghost",onClick:()=>E(null),children:"‚úï"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",style:{display:"grid",gap:6,lineHeight:1.4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Cliente:"})," ",s.cliente_nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Cidade:"})," ",s.destino_cidade_nome||"N√£o informada"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Lan√ßada em:"})," ",new Date(s.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",s.data_embarque?new Date(s.data_embarque).toLocaleDateString("pt-BR"):"-"]})]}),e.jsx("h4",{style:{marginBottom:8,textAlign:"center"},children:"Recibos"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"N√∫mero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),j&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsx("tbody",{children:R(s.id).map(a=>{const t=(a.valor_total||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}),n=a.valor_taxas||0,p=n===0?"-":`R$ ${n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsxs("td",{children:["R$ ",t]}),e.jsx("td",{children:p}),j&&e.jsx("td",{children:e.jsx("button",{className:"btn-icon btn-danger",disabled:z===a.id,onClick:()=>ie(a.id,s.id),children:z===a.id?"‚Ä¶":"üóëÔ∏è"})})]},a.id)})})]})})]}),(A||j)&&e.jsxs("div",{className:"modal-footer",children:[A&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline",style:{minWidth:130,backgroundColor:"#f3f4f6",color:"#1f2937"},onClick:()=>{const a=`/vendas/cadastro?id=${s.id}${s.destino_cidade_id?`&cidadeId=${s.destino_cidade_id}`:""}${s.destino_cidade_nome?`&cidadeNome=${encodeURIComponent(s.destino_cidade_nome)}`:""}`;window.location.href=a},children:"Editar"}),e.jsx("button",{className:"btn btn-primary",style:{minWidth:130},onClick:()=>{const a=prompt("Nova data de embarque (AAAA-MM-DD):",s.data_embarque||"");a&&se(s,a)},disabled:U,children:U?"Salvando...":"Remarcar"})]}),j&&e.jsx("button",{className:"btn btn-danger",style:{minWidth:130},onClick:()=>ne(s),disabled:k,children:k?"Cancelando...":"Cancelar Venda"})]})]})})]}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para visualizar Vendas."})}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{xe as default};
