import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{r as R}from"./logs.WCvMC_es.js";import{u as ae}from"./usePermissao.72SYthuA.js";function v(d){return(d||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function de(){const{permissao:d,ativo:$,loading:_,isAdmin:z}=ae("Vendas"),u=d!=="none",G=d==="create"||d==="edit"||d==="delete"||d==="admin",g=d==="edit"||d==="delete"||d==="admin",m=d==="delete"||d==="admin",[o,F]=r.useState(null),[W,w]=r.useState(!0),[N,H]=r.useState([]),[J,V]=r.useState([]),[x,K]=r.useState(""),[q,f]=r.useState(null),[S,C]=r.useState(!0),[A,L]=r.useState(null),[i,b]=r.useState(null),[I,B]=r.useState(!1),[M,O]=r.useState(!1),[T,U]=r.useState(null);r.useEffect(()=>{const s=new URLSearchParams(window.location.search).get("id");s&&L(s)},[]),r.useEffect(()=>{async function a(){try{f(null),w(!0);const{data:s}=await c.auth.getUser(),n=s?.user?.id;if(!n){f("UsuÃ¡rio nÃ£o autenticado.");return}const{data:h}=await c.from("users").select("id, user_types(name)").eq("id",n).maybeSingle(),p=h?.user_types?.name||s?.user?.user_metadata?.name||"",t=String(p||"").toUpperCase();let l="VENDEDOR";t.includes("ADMIN")?l="ADMIN":t.includes("GESTOR")?l="GESTOR":t.includes("VENDEDOR")?l="VENDEDOR":l="OUTRO";let D=[n];if(l==="GESTOR"){const{data:Z}=await c.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",n),ee=Z?.map(E=>E.vendedor_id).filter(E=>!!E)||[];D=Array.from(new Set([n,...ee]))}else l==="ADMIN"&&(D=[]);F({usuarioId:n,papel:l,vendedorIds:D})}catch(s){console.error(s),f("Erro ao carregar contexto do usuÃ¡rio.")}finally{w(!1)}}a()},[]);async function j(){if(!(!u||!o))try{C(!0);let a=c.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          data_lancamento,
          data_embarque,
          clientes(nome),
          destinos:produtos!destino_id (nome)
        `).order("data_lancamento",{ascending:!1});o.papel!=="ADMIN"&&(a=a.in("vendedor_id",o.vendedorIds));const{data:s,error:n}=await a;if(n)throw n;const h=(s||[]).map(t=>({id:t.id,vendedor_id:t.vendedor_id,cliente_id:t.cliente_id,destino_id:t.destino_id,data_lancamento:t.data_lancamento,data_embarque:t.data_embarque,cliente_nome:t.clientes?.nome||"",destino_nome:t.destinos?.nome||""}));H(h);const p=h.map(t=>t.id);if(p.length===0)V([]);else{const{data:t}=await c.from("vendas_recibos").select("*").in("venda_id",p);V(t||[])}if(A){const t=h.find(l=>l.id===A);t&&b(t),L(null)}}catch(a){console.error(a),f("Erro ao carregar vendas.")}finally{C(!1)}}r.useEffect(()=>{!_&&u&&o&&j()},[_,u,o]);const k=r.useMemo(()=>o?o.papel==="ADMIN"?"Todas as vendas":o.papel==="GESTOR"?"Vendas da sua equipe":"Suas vendas":"",[o]),P=r.useMemo(()=>{if(!x.trim())return N;const a=v(x);return N.filter(s=>v(s.cliente_nome||"").includes(a)||v(s.destino_nome||"").includes(a)||v(s.id).includes(a))},[N,x]);function y(a){return J.filter(s=>s.venda_id===a)}async function Q(a){if(!(!m&&!z)&&confirm("Tem certeza que deseja CANCELAR esta venda?"))try{O(!0),await c.from("vendas_recibos").delete().eq("venda_id",a.id),await c.from("vendas").delete().eq("id",a.id),await R({acao:"venda_cancelada",modulo:"Vendas",detalhes:{id:a.id}}),await j(),b(null)}catch(s){console.error(s),alert("Erro ao cancelar venda.")}finally{O(!1)}}async function X(a,s){if(m&&confirm("Excluir este recibo?"))try{U(a),await c.from("vendas_recibos").delete().eq("id",a),await R({acao:"recibo_excluido",modulo:"Vendas",detalhes:{recibo_id:a,venda_id:s}}),await j()}catch(n){console.error(n),alert("Erro ao excluir recibo.")}finally{U(null)}}async function Y(a,s){if(g)try{B(!0),await c.from("vendas").update({data_embarque:s}).eq("id",a.id),await R({acao:"venda_remarcada",modulo:"Vendas",detalhes:{venda_id:a.id,nova_data:s}}),await j()}catch(n){console.error(n),alert("Erro ao remarcar.")}finally{B(!1)}}return $?W||_?e.jsx("div",{className:"card-base card-config",children:"Carregando contexto do usuÃ¡rio..."}):u?e.jsxs("div",{className:"vendas-consulta-page",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar venda"}),e.jsx("input",{className:"form-input",placeholder:"Nome, destino ou ID...",value:x,onChange:a=>K(a.target.value)}),k&&e.jsxs("small",{style:{color:"#64748b"},children:[k," ",o?.papel!=="ADMIN"?"(restriÃ§Ã£o por vendedor)":""]})]}),G&&e.jsx("div",{className:"form-group",style:{alignItems:"flex-end"},children:e.jsx("a",{className:"btn btn-primary",href:"/vendas/cadastro",children:"Nova venda"})})]})}),q&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:q})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"LanÃ§amento"}),e.jsx("th",{children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),u&&e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[S&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando..."})}),!S&&P.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma venda encontrada."})}),!S&&P.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_nome}),e.jsx("td",{children:a.destino_nome}),e.jsx("td",{children:new Date(a.data_lancamento).toLocaleDateString("pt-BR")}),e.jsx("td",{children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{children:["R$",y(a.id).reduce((s,n)=>s+(n.valor_total||0),0).toLocaleString("pt-BR")]}),e.jsxs("td",{children:["R$",y(a.id).reduce((s,n)=>s+(n.valor_taxas||0),0).toLocaleString("pt-BR")]}),e.jsx("td",{className:"th-actions",children:e.jsx("button",{className:"btn-icon",title:"Ver detalhes",onClick:()=>b(a),children:"ğŸ‘ï¸"})})]},a.id))]})]})}),i&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:"820px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",children:"Detalhes da venda"}),e.jsxs("small",{style:{color:"#64748b"},children:[i.cliente_nome," â€¢ ",i.destino_nome]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>b(null),children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-2",style:{lineHeight:1.5},children:[e.jsx("strong",{children:"LanÃ§ada em:"})," ",new Date(i.data_lancamento).toLocaleDateString("pt-BR"),e.jsx("br",{}),e.jsx("strong",{children:"Embarque:"})," ",i.data_embarque?new Date(i.data_embarque).toLocaleDateString("pt-BR"):"-"]}),e.jsx("h4",{style:{marginBottom:8},children:"Recibos"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"NÃºmero"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),m&&e.jsx("th",{children:"AÃ§Ãµes"})]})}),e.jsx("tbody",{children:y(i.id).map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsxs("td",{children:["R$",(a.valor_total||0).toLocaleString("pt-BR")]}),e.jsxs("td",{children:["R$",(a.valor_taxas||0).toLocaleString("pt-BR")]}),m&&e.jsx("td",{children:e.jsx("button",{className:"btn-icon btn-danger",disabled:T===a.id,onClick:()=>X(a.id,i.id),children:T===a.id?"â€¦":"ğŸ—‘ï¸"})})]},a.id))})]})})]}),(g||m)&&e.jsxs("div",{className:"modal-footer",children:[g&&e.jsxs(e.Fragment,{children:[e.jsx("a",{className:"btn btn-outline",href:`/vendas/cadastro?id=${i.id}`,children:"Editar"}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{const a=prompt("Nova data de embarque (AAAA-MM-DD):",i.data_embarque||"");a&&Y(i,a)},disabled:I,children:I?"Salvando...":"Remarcar"})]}),m&&e.jsx("button",{className:"btn btn-danger",onClick:()=>Q(i),disabled:M,children:M?"Cancelando...":"Cancelar Venda"})]})]})})]}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"VocÃª nÃ£o possui permissÃ£o para visualizar Vendas."})}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Vendas."})})}export{de as default};
