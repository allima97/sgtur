import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as S}from"./supabase.Ng8nq9tn.js";import{u as Ce}from"./usePermissao.DEV7Ufch.js";function Pe(o,i){const u=o.valor_total_bruto-o.valor_total_taxas;return i.foco_valor==="liquido"?u:i.usar_taxas_na_meta?o.valor_total_bruto:u}function Le(o,i){if(o.modo==="FIXO"||!o.esc_ativado)return i<100?o.meta_nao_atingida??0:i>=100&&i<120?o.meta_atingida??o.meta_nao_atingida??0:o.super_meta??o.meta_atingida??o.meta_nao_atingida??0;let x=o.meta_atingida??o.meta_nao_atingida??0;if(o.esc_ativado){const l=o.esc_inicial_pct??100,g=o.esc_final_pct??i,m=o.esc_incremento_pct_meta??5,j=o.esc_incremento_pct_comissao??0;if(i>l&&m>0){const p=Math.min(i,g),R=Math.floor((p-l)/m);x+=R*j}}if(o.esc2_ativado){const l=o.esc2_inicial_pct??120,g=o.esc2_final_pct??i,m=o.esc2_incremento_pct_meta??5,j=o.esc2_incremento_pct_comissao??0;if(i>l&&m>0){const p=Math.min(i,g),R=Math.floor((p-l)/m);x+=R*j}}return x}function qe(o,i,u){const x=Pe(o,u),l=o.percentual_meta_atingido,g=Le(i,l),m=o.valor_total_bruto-o.valor_total_taxas,j=m*(g/100);return{baseMeta:x,pctMeta:l,pctComissao:g,valorLiquido:m,valorComissao:j}}function Ne(){const o=new Date,i=o.getFullYear(),u=String(o.getMonth()+1).padStart(2,"0");return`${i}-${u}`}function Z(o){return`${o}-01`}function we(o){const[i,u]=o.split("-"),x=parseInt(i,10),l=parseInt(u,10),g=l===12?1:l+1,m=l===12?x+1:x,j=String(g).padStart(2,"0");return`${m}-${j}-01`}function Me(){const{permissao:o,ativo:i}=Ce("Metas"),[u,x]=r.useState(null),[l,g]=r.useState([]),[m,j]=r.useState([]),[p,R]=r.useState(null),[D,ee]=r.useState({}),[y,F]=r.useState(""),[C,E]=r.useState(""),[b,ae]=r.useState(Ne()),[v,te]=r.useState(null),[B,T]=r.useState([]),[V,A]=r.useState([]),[oe,I]=r.useState(!0),[W,$]=r.useState(!1),[U,h]=r.useState(null),[k,se]=r.useState(0),[re,ne]=r.useState(0),[O,ie]=r.useState(0),[G,ce]=r.useState(0),[de,le]=r.useState(0),[me,ue]=r.useState(0),[fe,_e]=r.useState(0);function pe(a,t){if(a.tipo==="GERAL")return t<100?a.meta_nao_atingida??0:t>=100&&t<120?a.meta_atingida??a.meta_nao_atingida??0:a.super_meta??a.meta_atingida??a.meta_nao_atingida??0;const n=t>=0?t<100?"PRE":"POS":"PRE",s=(a.commission_tier||[]).filter(d=>d.faixa===n).find(d=>t>=d.de_pct&&t<=d.ate_pct);return s?s.inc_pct_comissao??0:a.meta_atingida??a.meta_nao_atingida??0}const Q=o==="admin",he=o==="edit",xe=u?.uso_individual===!1&&(Q||he)||Q,ge=u?.uso_individual===!1&&xe;r.useEffect(()=>{ve()},[]);async function ve(){try{I(!0),h(null);const{data:a}=await S.auth.getUser(),t=a?.user?.id;if(!t){h("Usuário não autenticado.");return}const{data:n,error:c}=await S.from("users").select("id, nome_completo, uso_individual, company_id");if(c)throw c;const s=(n||[]).find(_=>_.id===t);x(s||null);let d=[];s?.company_id?d=(n||[]).filter(_=>_.company_id===s.company_id):d=s?[s]:[],g(d);const f=s?.id??"";F(f);const{data:P,error:L}=await S.from("commission_templates").select("*").eq("ativo",!0).order("nome",{ascending:!0});if(L)throw L;j(P||[]),P&&P.length>0&&E(P[0].id);const N=await je(s);R(N),f&&(await X(f,b),await Y(f,b));const{data:q}=await S.from("product_commission_rule").select(`
            produto_id,
            commission_rule:rule_id (
              id,
              nome,
              tipo,
              meta_nao_atingida,
              meta_atingida,
              super_meta,
              commission_tier (*)
            )
          `),w={};(q||[]).forEach(_=>{_.produto_id&&_.commission_rule&&(w[_.produto_id]=_.commission_rule)}),ee(w)}catch(a){console.error(a),h("Erro ao carregar dados iniciais do fechamento.")}finally{I(!1)}}async function je(a){if(!a)return{usar_taxas_na_meta:!0};if(a.uso_individual){const{data:t}=await S.from("parametros_comissao").select("*").eq("owner_user_id",a.id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}if(a.company_id){const{data:t}=await S.from("parametros_comissao").select("*").eq("company_id",a.company_id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}return{usar_taxas_na_meta:!0}}async function X(a,t){const n=Z(t),{data:c}=await S.from("metas_vendedor").select("*").eq("vendedor_id",a).eq("periodo",n).maybeSingle(),s=c||null;return te(s),s?.template_id&&E(s.template_id),s}async function ye(a){const t=[a];try{const{data:n,error:c}=await S.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a);!c&&n&&n.forEach(s=>{s.vendedor_id&&!t.includes(s.vendedor_id)&&t.push(s.vendedor_id)})}catch(n){console.error("Erro ao carregar equipe:",n)}return A(t),t}async function Y(a,t){if(!a||a.length===0){T([]);return}const n=Z(t),c=we(t),{data:s,error:d}=await S.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            produto_id,
            valor_total,
            valor_taxas
          )
        `).in("vendedor_id",a).eq("cancelada",!1).gte("data_lancamento",n).lt("data_lancamento",c);if(d){console.error(d),h("Erro ao carregar vendas do período."),T([]);return}T(s||[])}r.useEffect(()=>{y&&u&&(async()=>{h(null);const a=await X(y,b);let t=[y];a?.scope==="equipe"?t=await ye(y):A([y]),await Y(t,b)})()},[y,b]);const Se=r.useMemo(()=>{let a=0,t=0;for(const c of B)for(const s of c.vendas_recibos||[]){const d=s.valor_total??0,f=s.valor_taxas??0;a+=d+f,t+=f}const n=a-t;return{totalBruto:a,totalTaxas:t,liquido:n}},[B]);async function be(){if(!C){h("Selecione um template de comissão.");return}if(!v){h("Defina uma meta para este período antes de calcular a comissão.");return}if(!p){h("Parâmetros de comissão não encontrados.");return}try{$(!0),h(null);const a=m.find(_=>_.id===C);if(!a){h("Template de comissão não encontrado.");return}const{totalBruto:t,totalTaxas:n,liquido:c}=Se;se(t),ne(n),ie(c);const s=p.foco_valor==="liquido"?c:p.usar_taxas_na_meta?t:c;ce(s);const d=v.meta_geral||0;let f=0;d>0&&(f=s/d*100);const L=qe({valor_total_bruto:t,valor_total_taxas:n,percentual_meta_atingido:f},a,p),N=L.pctComissao;let q=N;if(D&&B.length>0){let _=0,H=0;B.forEach(Be=>{(Be.vendas_recibos||[]).forEach(z=>{const J=z.produto_id,K=J?D[J]:null,M=(z.valor_total??0)-(z.valor_taxas??0);if(K&&M>0){const Re=pe(K,f);H+=Re*M,_+=M}})}),_>0&&(q=H/_||N)}const w=c*(q/100);le(L.pctMeta),ue(q),_e(w)}catch(a){console.error(a),h("Erro ao calcular comissão do período.")}finally{$(!1)}}return i?oe?e.jsx("div",{children:"Carregando dados do fechamento..."}):e.jsxs("div",{className:"fechamento-comissao-page",children:[e.jsxs("div",{style:{marginBottom:"15px",padding:"10px 14px",borderRadius:"8px",background:"#022c22",border:"1px solid #064e3b",color:"#e2f3ed",fontSize:"0.9rem",display:"flex",justifyContent:"space-between",alignItems:"center",gap:12,flexWrap:"wrap"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Módulo:"})," Fechamento de Comissão"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Perfil:"})," ",e.jsx("span",{style:{textTransform:"uppercase"},children:u?.uso_individual?"Uso Individual":"Corporativo"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Permissão:"})," ",e.jsx("span",{style:{textTransform:"uppercase",fontWeight:"bold",color:o==="admin"?"#22c55e":o==="edit"?"#eab308":"#ef4444"},children:o})]}),e.jsxs("div",{style:{width:"100%",marginTop:6,display:"flex",flexWrap:"wrap",gap:8},children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Vendedor:"})," ",l.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Template:"})," ",m.find(a=>a.id===C)?.nome||"Selecione"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Meta:"})," ",v?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Foco:"})," ",p?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),e.jsxs("div",{style:{width:"100%",marginTop:6,display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Vendedor:"})," ",l.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Template:"})," ",m.find(a=>a.id===C)?.nome||"Selecione"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Meta:"})," ",v?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Foco:"})," ",p?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),v?.scope==="equipe"&&e.jsxs("div",{style:{width:"100%",marginTop:6,color:"#cbd5e1"},children:[e.jsx("strong",{children:"Escopo:"})," Equipe (",V.length," membros)"]}),v?.scope==="equipe"&&V.length>0&&e.jsxs("div",{style:{width:"100%",marginTop:4,color:"#cbd5e1",fontSize:"0.9rem"},children:[e.jsx("strong",{children:"Membros:"})," ",V.map(a=>l.find(t=>t.id===a)?.nome_completo||a).join(", ")]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsxs("div",{className:"form-row",children:[ge&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Vendedor"}),e.jsx("select",{className:"form-select",value:y,onChange:a=>F(a.target.value),children:l.map(a=>e.jsx("option",{value:a.id,children:a.nome_completo},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Período"}),e.jsx("input",{type:"month",className:"form-input",value:b,onChange:a=>ae(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Template de Comissão"}),e.jsxs("select",{className:"form-select",value:C,onChange:a=>E(a.target.value),children:[m.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.modo,")"]},a.id)),m.length===0&&e.jsx("option",{value:"",children:"Nenhum template disponível"})]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:be,disabled:W||!v,children:W?"Calculando...":"Calcular comissão do mês"}),!v&&e.jsxs("span",{style:{marginLeft:10,fontSize:"0.85rem"},children:["Defina uma meta para este período em"," ",e.jsx("strong",{children:"Metas do Vendedor"}),"."]})]}),U&&e.jsx("div",{className:"card-base card-config mt-2",children:e.jsx("strong",{children:U})})]}),e.jsxs("div",{className:"mb-3",style:{display:"grid",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",gap:12},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Meta do mês"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:v?v.meta_geral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"–"})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsxs("div",{style:{fontSize:"0.8rem",opacity:.8},children:["Base da meta (usando"," ",p?.usar_taxas_na_meta?"valor bruto (com taxas)":"valor líquido (sem taxas)",")"]}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:(p?.usar_taxas_na_meta?k:O).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Meta Atingida"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[de.toFixed(1),"%"]})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Comissão Aplicada"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[me.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"mb-3",style:{display:"grid",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",gap:12},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor bruto no período (venda + taxas)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:k.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Total de taxas no período"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:re.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor líquido (base da comissão)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:O.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsx("div",{style:{fontSize:"0.9rem",marginBottom:4},children:"Comissão estimada para o período"}),e.jsx("div",{style:{fontSize:"1.6rem",fontWeight:700,color:"#22c55e"},children:fe.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.75,marginTop:4},children:"Cálculo considerando sempre o valor líquido (venda - taxas), conforme sua regra de negócio."})]}),e.jsxs("div",{className:"card-base card-green mb-2",children:[e.jsx("h3",{children:"Vendas do período"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Somente vendas não canceladas com recibos vinculados."})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Qtd. Recibos"}),e.jsx("th",{children:"Bruto (R$)"}),e.jsx("th",{children:"Taxas (R$)"}),e.jsx("th",{children:"Líquido (R$)"})]})}),e.jsxs("tbody",{children:[B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma venda encontrada no período."})}),B.map(a=>{let t=0,n=0;for(const s of a.vendas_recibos||[]){const d=s.valor_total??0,f=s.valor_taxas??0;t+=d+f,n+=f}const c=t-n;return e.jsxs("tr",{children:[e.jsx("td",{children:a.data_lancamento?new Date(a.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.vendas_recibos?.length||0}),e.jsx("td",{children:t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:c.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},a.id)})]})]})})]}):e.jsx("div",{children:"Acesso ao módulo de Metas & Comissões bloqueado."})}export{Me as default};
