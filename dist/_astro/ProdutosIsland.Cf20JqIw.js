import{j as e,s as d}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as O}from"./usePermissao.72SYthuA.js";function Y(){const{permissao:s,ativo:T,loading:k}=O("Cadastros"),[v,B]=t.useState([]),[j,y]=t.useState(!0),[E,l]=t.useState(null),[f,V]=t.useState(""),[u,M]=t.useState(null),[R,A]=t.useState(null),[D,z]=t.useState([]),[x,G]=t.useState({}),[g,_]=t.useState(""),[I,b]=t.useState(""),[P,N]=t.useState(""),[q,S]=t.useState(""),[i,w]=t.useState({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,ativo:!0});function p(a,o){w(c=>{if(a==="nome"){const n=String(o);return{...c,nome:n,tipo:c.tipo||n}}return{...c,[a]:o}})}async function C(){try{y(!0),l(null);const[{data:a,error:o},c,n]=await Promise.all([d.from("produtos").select("*").order("nome",{ascending:!0}),d.from("commission_rule").select("id, nome, tipo").eq("ativo",!0).order("nome"),d.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]);if(o)throw o;B(a||[]),z(c.data||[]);const m={};n.data?.forEach(r=>{m[r.produto_id]={rule_id:r.rule_id||"",fix_meta_nao_atingida:r.fix_meta_nao_atingida,fix_meta_atingida:r.fix_meta_atingida,fix_super_meta:r.fix_super_meta}}),G(m)}catch(a){console.error(a),l("Erro ao carregar produtos.")}finally{y(!1)}}t.useEffect(()=>{C()},[]);function F(){w({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,ativo:!0}),_(""),b(""),N(""),S(""),M(null)}function W(a){M(a.id),w({nome:a.nome,tipo:a.tipo||a.nome,regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,ativo:a.ativo});const o=x[a.id]||{};_(o.rule_id||""),b(o.fix_meta_nao_atingida!==null&&o.fix_meta_nao_atingida!==void 0?String(o.fix_meta_nao_atingida):""),N(o.fix_meta_atingida!==null&&o.fix_meta_atingida!==void 0?String(o.fix_meta_atingida):""),S(o.fix_super_meta!==null&&o.fix_super_meta!==void 0?String(o.fix_super_meta):"")}async function H(a){if(a.preventDefault(),s==="view"){l("VocÃª nÃ£o tem permissÃ£o para salvar produtos.");return}const o=i.nome.trim(),c=i.tipo.trim()||o;if(!o){l("Nome Ã© obrigatÃ³rio.");return}if(i.regra_comissionamento==="geral"&&!g){l("Selecione uma regra de comissÃ£o para produtos do tipo 'geral'.");return}try{l(null);const n={nome:o,tipo:c,regra_comissionamento:i.regra_comissionamento,soma_na_meta:i.soma_na_meta,ativo:i.ativo};let m=u;if(u){const{error:r}=await d.from("produtos").update(n).eq("id",u);if(r)throw r}else{const{data:r,error:h}=await d.from("produtos").insert(n).select("id").single();if(h)throw h;m=r?.id||null}if(m){const r=i.regra_comissionamento==="diferenciado"&&Number(I)||null,h=i.regra_comissionamento==="diferenciado"&&Number(P)||null,K=i.regra_comissionamento==="diferenciado"&&Number(q)||null;g||i.regra_comissionamento==="diferenciado"?await d.from("product_commission_rule").upsert({produto_id:m,rule_id:g||null,ativo:!0,fix_meta_nao_atingida:r,fix_meta_atingida:h,fix_super_meta:K},{onConflict:"produto_id"}):await d.from("product_commission_rule").delete().eq("produto_id",m)}F(),await C()}catch(n){console.error(n),l("Erro ao salvar produto.")}}async function J(a){if(s!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{A(a);const{error:o}=await d.from("produtos").delete().eq("id",a);if(o)throw o;await C()}catch(o){console.error(o),l("Erro ao excluir produto. Talvez esteja vinculado a vendas/recibos.")}finally{A(null)}}const L=t.useMemo(()=>{if(!f.trim())return v;const a=f.toLowerCase();return v.filter(o=>o.nome.toLowerCase().includes(a))},[f,v]);return k?e.jsx("div",{children:"Carregando permissÃµes..."}):T?e.jsxs("div",{className:"produtos-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:H,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:i.nome,onChange:a=>p("nome",a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Modelo de comissÃ£o"}),e.jsxs("select",{className:"form-input",value:i.regra_comissionamento,onChange:a=>{const o=a.target.value;p("regra_comissionamento",o),o==="diferenciado"&&_("")},disabled:s==="view",children:[e.jsx("option",{value:"geral",children:"Geral (usa regra cadastrada)"}),e.jsx("option",{value:"diferenciado",children:"Diferenciado (percentual fixo)"})]})]})]}),e.jsxs("div",{className:"form-row mt-1",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Soma na meta?"}),e.jsxs("select",{className:"form-input",value:i.soma_na_meta?"1":"0",onChange:a=>p("soma_na_meta",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-input",value:i.ativo?"1":"0",onChange:a=>p("ativo",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]})]}),i.regra_comissionamento==="geral"&&e.jsxs("div",{className:"form-group",style:{marginTop:8},children:[e.jsx("label",{className:"form-label",children:"Regra de ComissÃ£o *"}),e.jsxs("select",{className:"form-input",value:g,onChange:a=>_(a.target.value),disabled:s==="view",required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),D.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.tipo,")"]},a.id))]})]}),i.regra_comissionamento==="diferenciado"&&e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta nÃ£o atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:I,onChange:a=>b(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:P,onChange:a=>N(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (super meta) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:q,onChange:a=>S(a.target.value),disabled:s==="view"})]})]}),s!=="view"&&e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",type:"submit",children:u?"Salvar alteraÃ§Ãµes":"Adicionar produto"}),u&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:F,children:"Cancelar ediÃ§Ã£o"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar produto"}),e.jsx("input",{className:"form-input",value:f,onChange:a=>V(a.target.value),placeholder:"Digite parte do nome..."})]})}),E&&e.jsx("div",{className:"card-base card-config mb-3",children:E}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Regra"}),e.jsx("th",{children:"Regra vinculada"}),e.jsx("th",{children:"Soma meta"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[j&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando produtos..."})}),!j&&L.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhum produto encontrado."})}),!j&&L.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.regra_comissionamento}),e.jsx("td",{children:x[a.id]?.rule_id?D.find(o=>o.id===x[a.id]?.rule_id)?.nome||"-":x[a.id]?.fix_meta_atingida?"ComissÃ£o fixa":"-"}),e.jsx("td",{children:a.soma_na_meta?"Sim":"NÃ£o"}),e.jsx("td",{style:{color:a.ativo?"#22c55e":"#ef4444"},children:a.ativo?"Ativo":"Inativo"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{className:"th-actions",children:[s!=="view"&&e.jsx("button",{className:"btn-icon",onClick:()=>W(a),children:"âœï¸"}),s==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>J(a.id),disabled:R===a.id,children:R===a.id?"...":"ğŸ—‘ï¸"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"VocÃª nÃ£o possui acesso ao mÃ³dulo de Cadastros."})}export{Y as default};
