import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as R}from"./usePermissao.72SYthuA.js";function j(o){return(o||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const I={nome:"",pais_id:""};function J(){const{permissao:o,ativo:q,loading:F}=R("Cadastros"),[h,M]=r.useState([]),[b,T]=r.useState([]),[n,p]=r.useState(I),[l,k]=r.useState(""),[f,g]=r.useState(!0),[v,N]=r.useState(!1),[m,E]=r.useState(null),[w,S]=r.useState(null),[C,i]=r.useState(null),[d,B]=r.useState(!1);async function u(a=!1){try{g(!0),i(null);const[{data:s,error:t},{data:A,error:P}]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("estados").select("id, nome, pais_id, created_at").order(a?"nome":"created_at",{ascending:!a}).limit(a?void 0:10)]);if(t)throw t;if(P)throw P;M(s||[]),T(A||[]),B(a)}catch(s){console.error(s),i("Erro ao carregar estados.")}finally{g(!1)}}r.useEffect(()=>{u(!1)},[]),r.useEffect(()=>{l.trim()&&!d&&u(!0)},[l,d]);const x=r.useMemo(()=>{const a=new Map(h.map(s=>[s.id,s.nome]));return b.map(s=>({...s,pais_nome:a.get(s.pais_id)||""}))},[b,h]),_=r.useMemo(()=>{if(!l.trim())return x;const a=j(l);return x.filter(s=>j(s.nome).includes(a)||j(s.pais_nome).includes(a))},[l,x]);function y(a,s){p(t=>({...t,[a]:s}))}function D(){p(I),E(null),i(null)}function L(a){E(a.id),p({nome:a.nome,pais_id:a.pais_id})}async function V(a){if(a.preventDefault(),o==="view"){i("VocÃª nÃ£o tem permissÃ£o para salvar estados.");return}if(!n.nome.trim()||!n.pais_id){i("Preencha nome e paÃ­s.");return}try{N(!0),i(null);const s={nome:n.nome.trim(),pais_id:n.pais_id};if(m){const{error:t}=await c.from("estados").update(s).eq("id",m);if(t)throw t}else{const{error:t}=await c.from("estados").insert(s);if(t)throw t}D(),await u(d)}catch(s){console.error(s),i("Erro ao salvar estado.")}finally{N(!1)}}async function z(a){if(o!=="admin"){alert("Somente administradores podem excluir estados.");return}if(confirm("Excluir este estado?"))try{S(a);const{error:s}=await c.from("estados").delete().eq("id",a);if(s)throw s;await u(d)}catch(s){console.error(s),i("Erro ao excluir estado. Verifique se nÃ£o existem cidades vinculadas.")}finally{S(null)}}return F?e.jsx("div",{className:"paises-page",children:"Carregando permissÃµes..."}):q?e.jsxs("div",{className:"paises-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:V,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome do estado *"}),e.jsx("input",{className:"form-input",value:n.nome,onChange:a=>y("nome",a.target.value),placeholder:"Ex: SÃ£o Paulo, CalifÃ³rnia..."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"PaÃ­s *"}),e.jsxs("select",{className:"form-select",value:n.pais_id,onChange:a=>y("pais_id",a.target.value),children:[e.jsx("option",{value:"",children:"Selecione"}),h.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]})]}),e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:v||o==="view",children:v?"Salvando...":m?"Salvar alteraÃ§Ãµes":"Adicionar estado"}),m&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:D,children:"Cancelar ediÃ§Ã£o"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar estado"}),e.jsx("input",{className:"form-input",value:l,onChange:a=>k(a.target.value),placeholder:"Nome ou paÃ­s..."})]})}),!d&&e.jsx("div",{className:"card-base card-config mb-3",children:"Ãšltimos Estados Cadastrados (10). Digite na busca para consultar todos."}),C&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:C})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[640px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"PaÃ­s"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[f&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Carregando estados..."})}),!f&&_.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum estado encontrado."})}),!f&&_.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.pais_nome||"-"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{className:"th-actions",children:o!=="view"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>L(a),children:"âœï¸"}),o==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>z(a.id),disabled:w===a.id,children:w===a.id?"...":"ğŸ—‘ï¸"})]})})]},a.id))]})]})})]}):e.jsx("div",{className:"paises-page",children:"VocÃª nÃ£o possui acesso ao mÃ³dulo de Cadastros."})}export{J as default};
