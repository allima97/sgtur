import{j as a,s as c}from"./supabase.DNkd6bxA.js";import{r as s}from"./index.C0Fn7Wtz.js";import{u as Y}from"./usePermissao.72SYthuA.js";import{r as z}from"./logs.WCvMC_es.js";const A={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Z={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function ne(){const{permissao:x,ativo:S,loading:y,isAdmin:V}=Y("Vendas"),L=x==="create"||x==="edit"||x==="delete"||x==="admin",[g,k]=s.useState([]),[j,T]=s.useState([]),[N,O]=s.useState([]),[r,v]=s.useState(A),[f,_]=s.useState([]),[l,W]=s.useState(null),[D,u]=s.useState(null),[E,q]=s.useState(!1),[ee,P]=s.useState(!0),[ae,B]=s.useState(!1),[p,$]=s.useState(""),[b,G]=s.useState(""),[h,H]=s.useState("");async function J(e){try{P(!0);const[t,o,n]=await Promise.all([c.from("clientes").select("id, nome, cpf").order("nome"),c.from("destinos").select("id, nome").order("nome"),c.from("produtos").select("id, nome").order("nome")]);k(t.data||[]),T(o.data||[]),O(n.data||[]),e&&await R(e)}catch(t){console.error(t),u("Erro ao carregar dados.")}finally{P(!1)}}async function R(e){try{B(!0);const{data:t,error:o}=await c.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(o)throw o;if(!t){u("Venda nÃ£o encontrada para ediÃ§Ã£o.");return}v({cliente_id:t.cliente_id,destino_id:t.destino_id,data_lancamento:t.data_lancamento,data_embarque:t.data_embarque||""});const{data:n,error:d}=await c.from("vendas_recibos").select("*").eq("venda_id",e);if(d)throw d;_((n||[]).map(i=>({id:i.id,produto_id:i.produto_id||"",numero_recibo:i.numero_recibo||"",valor_total:i.valor_total!=null?String(i.valor_total):"",valor_taxas:i.valor_taxas!=null?String(i.valor_taxas):"0"})))}catch(t){console.error(t),u("Erro ao carregar venda para ediÃ§Ã£o.")}finally{B(!1)}}s.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&W(t)},[]),s.useEffect(()=>{!y&&S&&J(l||void 0)},[y,S,l]);const w=e=>e.replace(/\D/g,""),F=s.useMemo(()=>{if(!p.trim())return g;const e=p.toLowerCase();return g.filter(t=>{const o=w(t.cpf||"");return t.nome.toLowerCase().includes(e)||o.includes(w(e))})},[g,p]),I=s.useMemo(()=>{if(!b.trim())return j;const e=b.toLowerCase();return j.filter(t=>t.nome.toLowerCase().includes(e))},[j,b]),M=s.useMemo(()=>{if(!h.trim())return N;const e=h.toLowerCase();return N.filter(t=>t.nome.toLowerCase().includes(e))},[N,h]);function K(){_(e=>[...e,{...Z}])}function C(e,t,o){_(n=>{const d=[...n];return d[e][t]=o,d})}function Q(e){_(t=>t.filter((o,n)=>n!==e))}async function X(e){if(e.preventDefault(),!L&&!V){u("VocÃª nÃ£o possui permissÃ£o para cadastrar vendas.");return}if(f.length===0){u("Uma venda precisa ter ao menos 1 recibo.");return}try{q(!0),u(null);const{data:t}=await c.auth.getUser(),o=t?.user?.id;if(!o){u("UsuÃ¡rio nÃ£o autenticado."),q(!1);return}let n=l;if(l){const{error:d}=await c.from("vendas").update({cliente_id:r.cliente_id,destino_id:r.destino_id,data_lancamento:r.data_lancamento,data_embarque:r.data_embarque||null}).eq("id",l);if(d)throw d;await c.from("vendas_recibos").delete().eq("venda_id",l);for(const i of f){const{error:m}=await c.from("vendas_recibos").insert({venda_id:l,produto_id:i.produto_id||null,numero_recibo:i.numero_recibo.trim(),valor_total:Number(i.valor_total),valor_taxas:Number(i.valor_taxas)});if(m)throw m}await z({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:l,venda:r,recibos:f}}),alert("Venda atualizada com sucesso!"),await R(l)}else{const{data:d,error:i}=await c.from("vendas").insert({vendedor_id:o,cliente_id:r.cliente_id,destino_id:r.destino_id,data_lancamento:r.data_lancamento,data_embarque:r.data_embarque||null}).select().single();if(i)throw i;n=d.id;for(const m of f){const{error:U}=await c.from("vendas_recibos").insert({venda_id:n,produto_id:m.produto_id||null,numero_recibo:m.numero_recibo.trim(),valor_total:Number(m.valor_total),valor_taxas:Number(m.valor_taxas)});if(U)throw U}await z({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:r,recibos:f,id:n}}),alert("Venda cadastrada com sucesso!"),v(A),_([])}}catch(t){console.error(t),u("Erro ao salvar venda.")}finally{q(!1)}}return S?!L&&!V?a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"VocÃª nÃ£o possui permissÃ£o para cadastrar vendas."})}):a.jsx("div",{className:"vendas-cadastro-page",children:a.jsxs("div",{className:"card-base card-green mb-3",children:[a.jsx("h3",{children:l?"Editar venda":"Cadastro de Venda"}),l&&a.jsx("small",{style:{color:"#0f172a"},children:"Modo ediÃ§Ã£o â€” altere cliente, destino, embarque e recibos."}),D&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:D})}),a.jsxs("form",{onSubmit:X,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente *"}),a.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:g.find(e=>e.id===r.cliente_id)?.nome||p,onChange:e=>$(e.target.value),onBlur:()=>{const e=p.toLowerCase(),t=w(p),o=F.find(n=>{const d=w(n.cpf||"");return n.nome.toLowerCase()===e||t&&d===t});o&&v({...r,cliente_id:o.id})},required:!0}),a.jsx("datalist",{id:"listaClientes",children:F.map(e=>a.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino *"}),a.jsx("input",{className:"form-input",list:"listaDestinos",placeholder:"Buscar destino...",value:j.find(e=>e.id===r.destino_id)?.nome||b,onChange:e=>G(e.target.value),onBlur:()=>{const e=I.find(t=>t.nome.toLowerCase()===b.toLowerCase());e&&v({...r,destino_id:e.id})},required:!0}),a.jsx("datalist",{id:"listaDestinos",children:I.map(e=>a.jsx("option",{value:e.nome},e.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data de embarque"}),a.jsx("input",{className:"form-input",type:"date",value:r.data_embarque,onChange:e=>v({...r,data_embarque:e.target.value})})]})]}),a.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),f.map((e,t)=>a.jsx("div",{className:"card-base mb-2",children:a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto *"}),a.jsx("input",{className:"form-input",list:"listaProdutos",placeholder:"Buscar produto...",value:N.find(o=>o.id===e.produto_id)?.nome||h,onChange:o=>H(o.target.value),onBlur:()=>{const o=M.find(n=>n.nome.toLowerCase()===h.toLowerCase());o&&C(t,"produto_id",o.id)},required:!0}),a.jsx("datalist",{id:"listaProdutos",children:M.map(o=>a.jsx("option",{value:o.nome},o.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"NÃºmero recibo *"}),a.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:o=>C(t,"numero_recibo",o.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor total *"}),a.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_total,onChange:o=>C(t,"valor_total",o.target.value),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Taxas"}),a.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_taxas,onChange:o=>C(t,"valor_taxas",o.target.value)})]}),a.jsx("div",{className:"form-group",style:{width:"80px"},children:a.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>Q(t),children:"ğŸ—‘ï¸"})})]})},t)),a.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[a.jsx("button",{type:"button",className:"btn btn-primary",onClick:K,children:"â• Adicionar recibo"}),a.jsx("button",{type:"submit",className:"btn btn-success",disabled:E,children:E?"Salvando...":"Salvar venda"})]})]})]})}):a.jsx("div",{className:"card-base card-config",children:a.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Vendas."})})}export{ne as default};
