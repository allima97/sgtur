import{s as m,j as t}from"./supabase.DNkd6bxA.js";import{r}from"./index.C0Fn7Wtz.js";import{u as _e}from"./usePermissao.72SYthuA.js";import{r as ee}from"./logs.WCvMC_es.js";function j(N){return(N||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const ae={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},ve={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function Se(){const{permissao:N,ativo:O,loading:F,isAdmin:I}=_e("Vendas"),M=N==="create"||N==="edit"||N==="delete"||N==="admin",[D,oe]=r.useState([]),[w,te]=r.useState([]),[s,de]=r.useState([]),[i,S]=r.useState(ae),[f,y]=r.useState([]),[_,re]=r.useState(null),[A,c]=r.useState(null),[U,h]=r.useState(!1),[he,G]=r.useState(!0),[ge,H]=r.useState(!1),[q,ie]=r.useState(""),[g,T]=r.useState(""),[E,W]=r.useState(""),[se,V]=r.useState(!1),[Y,P]=r.useState([]),[L,J]=r.useState(!1),[K,B]=r.useState(null),[xe,ne]=r.useState("");async function le(e){try{G(!0);const[o,a,d]=await Promise.all([m.from("clientes").select("id, nome, cpf").order("nome"),m.from("cidades").select("id, nome").order("nome"),m.from("produtos").select("id, nome, cidade_id, tipo_produto").order("nome")]);oe(o.data||[]);const n=a.data||[];te(n);const b=d.data||[];de(b),e&&await Q(e,n,b)}catch(o){console.error(o),c("Erro ao carregar dados.")}finally{G(!1)}}async function Q(e,o,a){try{H(!0);const{data:d,error:n}=await m.from("vendas").select("id, cliente_id, destino_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(n)throw n;if(!d){c("Venda nÃ£o encontrada para ediÃ§Ã£o.");return}let b="",C="";if(d.destino_id){const{data:l}=await m.from("produtos").select("id, cidade_id").eq("id",d.destino_id).maybeSingle();b=l?.cidade_id||"";const $=(o||w).find(be=>be.id===b);$&&(C=$.nome)}S({cliente_id:d.cliente_id,destino_id:b,data_lancamento:d.data_lancamento,data_embarque:d.data_embarque||""}),T(C),ne(C);const{data:v,error:p}=await m.from("vendas_recibos").select("*").eq("venda_id",e);if(p)throw p;const u=a||s;y((v||[]).map(l=>({id:l.id,produto_id:u.find(x=>x.tipo_produto===l.produto_id&&(!b||x.cidade_id===b||!x.cidade_id))?.id||"",numero_recibo:l.numero_recibo||"",valor_total:l.valor_total!=null?String(l.valor_total):"",valor_taxas:l.valor_taxas!=null?String(l.valor_taxas):"0"})))}catch(d){console.error(d),c("Erro ao carregar venda para ediÃ§Ã£o.")}finally{H(!1)}}r.useEffect(()=>{const o=new URLSearchParams(window.location.search).get("id");o&&re(o)},[]),r.useEffect(()=>{!F&&O&&le(_||void 0)},[F,O,_]),r.useEffect(()=>{if(g.trim().length<2){P([]);return}const e=new AbortController,o=setTimeout(async()=>{J(!0),B(null);try{const{data:a,error:d}=await m.rpc("buscar_cidades",{q:g.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(d){console.error("Erro ao buscar cidades:",d),B("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:n,error:b}=await m.from("cidades").select("id, nome").ilike("nome",`%${g.trim()}%`).order("nome");b?(console.error("Erro no fallback de cidades:",b),B("Erro ao buscar cidades.")):(P(n||[]),B(null))}else P(a||[])}finally{e.signal.aborted||J(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[g]);const k=e=>e.replace(/\D/g,""),X=r.useMemo(()=>{if(!q.trim())return D;const e=j(q);return D.filter(o=>{const a=k(o.cpf||"");return j(o.nome).includes(e)||a.includes(k(e))})},[D,q]);r.useMemo(()=>{if(!g.trim())return w;const e=j(g);return w.filter(o=>j(o.nome).includes(e))},[w,g]);const Z=r.useMemo(()=>{const e=i.destino_id?s.filter(a=>!a.cidade_id||a.cidade_id===i.destino_id):s.filter(a=>!a.cidade_id);if(!E.trim())return e;const o=j(E);return e.filter(a=>j(a.nome).includes(o))},[s,E,i.destino_id]),z=r.useMemo(()=>s.some(e=>!e.cidade_id),[s]),ce=r.useMemo(()=>f.length===0?!1:f.some(e=>s.find(a=>a.id===e.produto_id)?.cidade_id),[f,s]);function ue(e){T(e);const o=w.find(a=>a.id===i.destino_id);(!o||!j(o.nome).includes(j(e)))&&S(a=>({...a,destino_id:""})),V(!0)}function me(){y(e=>[...e,{...ve}])}function R(e,o,a){y(d=>{const n=[...d];return n[e][o]=a,n})}r.useEffect(()=>{W(""),y(e=>e.map(o=>{const a=s.find(d=>d.id===o.produto_id);return a&&(!a.cidade_id||a.cidade_id===i.destino_id)?o:{...o,produto_id:""}}))},[i.destino_id,s]);function fe(e){y(o=>o.filter((a,d)=>d!==e))}async function pe(e){if(e.preventDefault(),!M&&!I){c("VocÃª nÃ£o possui permissÃ£o para cadastrar vendas.");return}if(f.length===0){c("Uma venda precisa ter ao menos 1 recibo.");return}try{h(!0),c(null);const{data:o}=await m.auth.getUser(),a=o?.user?.id;if(!a){c("UsuÃ¡rio nÃ£o autenticado."),h(!1);return}if(!f.length){c("Uma venda precisa ter ao menos 1 recibo."),h(!1);return}const d=f[0]?.produto_id;if(!d){c("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),h(!1);return}const n=s.find(v=>v.id===d);if(f.some(v=>s.find(u=>u.id===v.produto_id)?.cidade_id)&&!i.destino_id){c("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),h(!1);return}if(!n){c("O produto do recibo precisa ser vÃ¡lido."),h(!1);return}if(n.cidade_id&&i.destino_id&&n.cidade_id!==i.destino_id){c("O produto do recibo precisa pertencer Ã  cidade de destino selecionada."),h(!1);return}if(i.destino_id&&f.some(p=>{const u=s.find(l=>l.id===p.produto_id);return u?.cidade_id&&u.cidade_id!==i.destino_id})){c("Todos os produtos precisam pertencer Ã  cidade selecionada ou ser globais."),h(!1);return}if(!n.tipo_produto){c("O produto selecionado nÃ£o possui tipo vinculado. Cadastre um tipo de produto para ele."),h(!1);return}let C=_;if(_){const{error:v}=await m.from("vendas").update({cliente_id:i.cliente_id,destino_id:d,data_lancamento:i.data_lancamento,data_embarque:i.data_embarque||null}).eq("id",_);if(v)throw v;await m.from("vendas_recibos").delete().eq("venda_id",_);for(const p of f){const u=s.find(x=>x.id===p.produto_id);if(!u?.tipo_produto)throw new Error("Produto do recibo nÃ£o possui tipo vinculado.");const{error:l}=await m.from("vendas_recibos").insert({venda_id:_,produto_id:u.tipo_produto,numero_recibo:p.numero_recibo.trim(),valor_total:Number(p.valor_total),valor_taxas:Number(p.valor_taxas)});if(l)throw l}await ee({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:_,venda:i,recibos:f}}),alert("Venda atualizada com sucesso!"),await Q(_,w,s)}else{const{data:v,error:p}=await m.from("vendas").insert({vendedor_id:a,cliente_id:i.cliente_id,destino_id:d,data_lancamento:i.data_lancamento,data_embarque:i.data_embarque||null}).select().single();if(p)throw p;C=v.id;for(const u of f){const l=s.find($=>$.id===u.produto_id);if(!l?.tipo_produto)throw new Error("Produto do recibo nÃ£o possui tipo vinculado.");const{error:x}=await m.from("vendas_recibos").insert({venda_id:C,produto_id:l.tipo_produto,numero_recibo:u.numero_recibo.trim(),valor_total:Number(u.valor_total),valor_taxas:Number(u.valor_taxas)});if(x)throw x}await ee({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:i,recibos:f,id:C}}),alert("Venda cadastrada com sucesso!"),S(ae),y([])}}catch(o){console.error(o);const a=o?.message||o?.error?.message||"",d=o?.code||o?.error?.code||"";c(`Erro ao salvar venda.${d?` CÃ³digo: ${d}.`:""}${a?` Detalhes: ${a}`:""}`)}finally{h(!1)}}return O?!M&&!I?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"VocÃª nÃ£o possui permissÃ£o para cadastrar vendas."})}):t.jsx("div",{className:"vendas-cadastro-page",children:t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:_?"Editar venda":"Cadastro de Venda"}),_&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo ediÃ§Ã£o â€” altere cliente, cidade de destino, embarque e recibos."}),A&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:A})}),t.jsxs("form",{onSubmit:pe,children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:D.find(e=>e.id===i.cliente_id)?.nome||q,onChange:e=>ie(e.target.value),onBlur:()=>{const e=q.toLowerCase(),o=k(q),a=X.find(d=>{const n=k(d.cpf||"");return d.nome.toLowerCase()===e||o&&n===o});a&&S({...i,cliente_id:a.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:X.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group",style:{position:"relative"},children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),z&&t.jsx("small",{style:{display:"block",color:"#475569",marginBottom:4},children:"ObrigatÃ³rio apenas se o recibo tiver produto vinculado a uma cidade."}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:g,onChange:e=>ue(e.target.value),onFocus:()=>V(!0),onBlur:()=>setTimeout(()=>V(!1),150),required:ce,style:{marginBottom:6}}),L&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),K&&!L&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:K}),se&&(L||g.trim().length>=2)&&t.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb",position:"absolute",zIndex:5,width:"100%",background:"#fff"},children:[Y.length===0&&!L&&g.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),Y.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:i.destino_id===e.id?"#e0f2fe":"#fff",borderColor:i.destino_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:a=>{a.preventDefault(),S(d=>({...d,destino_id:e.id})),T(o),V(!1),P([])},children:[o,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["â€¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:i.data_embarque,onChange:e=>S({...i,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3",children:"Recibos da Venda"}),f.map((e,o)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${o}`,placeholder:z?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:s.find(a=>a.id===e.produto_id)?.nome||E,onChange:a=>W(a.target.value),onBlur:()=>{const a=Z.find(d=>d.nome.toLowerCase()===E.toLowerCase());a&&R(o,"produto_id",a.id)},required:!0,disabled:!i.destino_id&&!z}),t.jsx("datalist",{id:`listaProdutos-${o}`,children:Z.map(a=>t.jsx("option",{value:a.nome},a.id))})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"NÃºmero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:a=>R(o,"numero_recibo",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_total,onChange:a=>R(o,"valor_total",a.target.value),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"number",step:"0.01",value:e.valor_taxas,onChange:a=>R(o,"valor_taxas",a.target.value)})]}),t.jsx("div",{className:"form-group",style:{width:"80px"},children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-4",onClick:()=>fe(o),children:"ğŸ—‘ï¸"})})]})},o)),t.jsxs("div",{className:"mt-3",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:me,children:"â• Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:U,children:U?"Salvando...":"Salvar venda"})]})]})]})}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Vendas."})})}export{Se as default};
