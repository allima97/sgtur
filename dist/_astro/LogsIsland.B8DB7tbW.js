import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as a}from"./index.C0Fn7Wtz.js";import{s as m}from"./supabase.Ng8nq9tn.js";import{u as D}from"./usePermissao.Bkt8qSjs.js";function I(){const{ativo:g,loading:f}=D("AdminDashboard"),[v,b]=a.useState(!1),[u,N]=a.useState([]),[w,S]=a.useState([]),[L,x]=a.useState(!0),[U,j]=a.useState(null),[l,y]=a.useState(""),[n,C]=a.useState(""),[i,_]=a.useState(""),[c,A]=a.useState(""),[t,p]=a.useState(null);if(a.useEffect(()=>{async function s(){const{data:r}=await m.auth.getUser();if(!r?.user)return;const{data:o}=await m.from("users").select("id, user_types(name)").eq("id",r.user.id).maybeSingle(),d=o?.user_types?.name?.toUpperCase()||"";b(d.includes("ADMIN"))}s()},[]),f)return e.jsx("div",{children:"Carregando permissões..."});if(!g||!v)return e.jsx("div",{style:{padding:20},children:e.jsx("h3",{children:"Apenas administradores podem acessar os logs."})});a.useEffect(()=>{async function s(){try{x(!0),j(null);const{data:r,error:o}=await m.from("logs").select(`
            *,
            users:users (nome_completo)
          `).order("created_at",{ascending:!1});if(o)throw o;N(r||[]);const{data:d}=await m.from("users").select("id, nome_completo").order("nome_completo");S(d||[])}catch(r){console.error(r),j("Erro ao carregar logs.")}finally{x(!1)}}s()},[]);const h=a.useMemo(()=>{let s=u;if(l&&(s=s.filter(r=>r.user_id===l)),n&&(s=s.filter(r=>(r.modulo||"")===n)),i&&(s=s.filter(r=>r.acao===i)),c.trim()){const r=c.toLowerCase();s=s.filter(o=>(JSON.stringify(o).toLowerCase()+(o.users?.nome_completo||"").toLowerCase()).includes(r))}return s},[u,l,n,i,c]);return e.jsxs("div",{className:"logs-admin-page",children:[e.jsxs("div",{className:"mb-4 p-4 rounded-lg bg-rose-950 border border-rose-700 text-rose-100",children:[e.jsx("strong",{children:"Logs de Auditoria"})," — todas as ações do sistema"]}),e.jsxs("div",{className:"card-base card-red mb-3",children:[e.jsx("h3",{style:{marginBottom:12},children:"Filtros"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Usuário"}),e.jsxs("select",{className:"form-select",value:l,onChange:s=>y(s.target.value),children:[e.jsx("option",{value:"",children:"Todos"}),w.map(s=>e.jsx("option",{value:s.id,children:s.nome_completo},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Módulo"}),e.jsxs("select",{className:"form-select",value:n,onChange:s=>C(s.target.value),children:[e.jsx("option",{value:"",children:"Todos"}),e.jsx("option",{value:"permissoes",children:"Permissões"}),e.jsx("option",{value:"vendas",children:"Vendas"}),e.jsx("option",{value:"clientes",children:"Clientes"}),e.jsx("option",{value:"cadastros",children:"Cadastros"}),e.jsx("option",{value:"login",children:"Login"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ação"}),e.jsxs("select",{className:"form-select",value:i,onChange:s=>_(s.target.value),children:[e.jsx("option",{value:"",children:"Todas"}),Array.from(new Set(u.map(s=>s.acao))).map(s=>e.jsx("option",{children:s},s))]})]})]}),e.jsx("div",{className:"form-row mt-2",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Busca livre"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"Buscar em qualquer campo...",value:c,onChange:s=>A(s.target.value)})]})})]}),e.jsxs("div",{className:"card-base card-red",children:[e.jsxs("h3",{className:"mb-3 font-semibold",children:["Registros (",h.length,")"]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-red min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"min-w-[150px]",children:"Data"}),e.jsx("th",{children:"Usuário"}),e.jsx("th",{children:"Ação"}),e.jsx("th",{children:"Módulo"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Ver"})]})}),e.jsxs("tbody",{children:[h.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum log encontrado."})}),h.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(s.created_at).toLocaleString("pt-BR")}),e.jsx("td",{children:s.users?.nome_completo||"Desconhecido"}),e.jsx("td",{children:s.acao}),e.jsx("td",{children:s.modulo||"-"}),e.jsx("td",{children:s.ip||"-"}),e.jsx("td",{children:e.jsx("button",{className:"btn btn-light",onClick:()=>p(s),children:"Ver"})})]},s.id))]})]})})]}),t&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex justify-center items-center z-[100]",children:e.jsxs("div",{className:"w-[95%] max-w-[700px] max-h-[90vh] overflow-y-auto bg-slate-800 p-5 rounded-xl text-slate-100",children:[e.jsxs("div",{className:"flex justify-between mb-2",children:[e.jsx("h3",{children:"Detalhes do log"}),e.jsx("button",{className:"btn btn-light",onClick:()=>p(null),children:"Fechar"})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Usuário:"})," ",t.users?.nome_completo]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ação:"})," ",t.acao]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Módulo:"})," ",t.modulo]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Data:"})," ",new Date(t.created_at).toLocaleString("pt-BR")]}),e.jsxs("p",{children:[e.jsx("strong",{children:"IP:"})," ",t.ip||"-"]}),e.jsx("p",{className:"mt-3",children:e.jsx("strong",{children:"Detalhes:"})}),e.jsx("pre",{className:"bg-slate-900 p-3 rounded text-xs whitespace-pre-wrap",children:JSON.stringify(t.detalhes,null,2)})]})})]})}export{I as default};
