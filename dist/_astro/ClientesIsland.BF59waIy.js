import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r as d}from"./index.C0Fn7Wtz.js";import{u as Re}from"./usePermissao.72SYthuA.js";import{r as U}from"./logs.WCvMC_es.js";import{t as fe}from"./titleCase.DQLlfrnh.js";const X={nome:"",nascimento:"",cpf:"",telefone:"",whatsapp:"",email:"",endereco:"",complemento:"",cidade:"",estado:"",cep:"",rg:"",genero:"",nacionalidade:"",tags:"",tipo_cliente:"passageiro",notas:"",active:!0};function Fe(){const{permissao:x,ativo:_e,loading:Y}=Re("Clientes"),H=x!=="none",T=x==="create"||x==="edit"||x==="delete"||x==="admin",E=x==="edit"||x==="delete"||x==="admin",A=x==="delete"||x==="admin",[W,ge]=d.useState([]),[q,ve]=d.useState(""),[Z,y]=d.useState(null),[z,$]=d.useState(!0),[o,V]=d.useState(X),[B,M]=d.useState(null),[ee,te]=d.useState(!1),[ae,oe]=d.useState(null),[se,ne]=d.useState(null),[ie,re]=d.useState([]),[de,le]=d.useState([]),[ce,me]=d.useState(!1),[_,k]=d.useState(null),[F,L]=d.useState([]),[be,he]=d.useState(!1),[w,I]=d.useState(null);async function G(){if(H)try{$(!0),y(null);const{data:t,error:s}=await c.from("clientes").select("*").order("nome",{ascending:!0});if(s)throw s;ge(t||[])}catch(t){console.error(t),y("Erro ao carregar clientes.")}finally{$(!1)}}d.useEffect(()=>{!Y&&H&&G()},[Y,H]);const ue=d.useMemo(()=>{if(!q.trim())return W;const t=q.toLowerCase();return W.filter(s=>s.nome.toLowerCase().includes(t)||(s.cpf||"").includes(t)||(s.email||"").toLowerCase().includes(t))},[W,q]);function S(t,s){V(h=>({...h,[t]:s}))}function Ne(){T&&(M(null),V(X))}async function ye(t){ne(t),me(!0);const s=new Set;try{const{data:h}=await c.from("historico_viagens_real").select("id, data_viagem, valor_total, notas, destinos:produtos!destino_id (nome)").eq("cliente_id",t.id).order("data_viagem",{ascending:!1}),u=h?.map(a=>({id:a.id,data_viagem:a.data_viagem,destino_nome:a.destinos?.nome||"",valor_total:a.valor_total??null,notas:a.notas||null}))||[],{data:g}=await c.from("vendas").select("id, data_lancamento, data_embarque, destino_id, destinos:produtos!destino_id (nome, cidade_id)").eq("cliente_id",t.id).order("data_lancamento",{ascending:!1});let v=[],b={};if(g&&g.length>0){const a=g.map(n=>n.id),m=Array.from(new Set(g.map(n=>n.destinos?.cidade_id).filter(n=>!!n)));if(m.length>0){const{data:n,error:l}=await c.from("cidades").select("id, nome").in("id",m);l?console.error(l):b=Object.fromEntries((n||[]).map(f=>[f.id,f.nome||""]))}const{data:j}=await c.from("vendas_recibos").select("venda_id, valor_total, valor_taxas, produto_id").in("venda_id",a);v=g.map(n=>{const l=(j||[]).filter(i=>i.venda_id===n.id),f=l.reduce((i,Q)=>i+(Q.valor_total||0),0),P=l.reduce((i,Q)=>i+(Q.valor_taxas||0),0);return{id:n.id,data_lancamento:n.data_lancamento,data_embarque:n.data_embarque,destino_nome:n.destinos?.nome||"",destino_cidade_id:n.destinos?.cidade_id||null,destino_cidade_nome:n.destinos?.cidade_id&&b[n.destinos?.cidade_id]||"",valor_total:f,valor_taxas:P}})}const{data:D}=await c.from("orcamentos").select("id, data_orcamento, status, valor, numero_venda, produto_id, destinos:produtos!destino_id (nome, cidade_id)").eq("cliente_id",t.id).order("data_orcamento",{ascending:!1}),N=(D?.map(a=>a.destinos?.cidade_id).filter(a=>!!a)||[]).filter(a=>!(a in(b||{})));if(N.length>0){const{data:a,error:m}=await c.from("cidades").select("id, nome").in("id",N);m?console.error(m):(a||[]).forEach(j=>{b[j.id]=j.nome||""})}(D?.map(a=>a.produto_id).filter(a=>!!a)||[]).forEach(a=>s.add(a));let p=[],C=[];const J={},K={},O=new Set;let xe={};if(s.size>0){const a=Array.from(s),{data:m,error:j}=await c.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").in("tipo_produto",a);!j&&m?p=m:j&&console.error(j);const{data:n,error:l}=await c.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").in("id",a);!l&&n?(C=n,n.forEach(i=>{i.id&&(J[i.id]=i.nome||"Produto",K[i.id]=i),i.tipo_produto&&O.add(i.tipo_produto)})):l&&console.error(l),p.forEach(i=>{i.tipo_produto&&O.add(i.tipo_produto)}),a.forEach(i=>O.add(i));const{data:f,error:P}=await c.from("tipo_produtos").select("id, nome, disponivel_todas_cidades").in("id",Array.from(O));!P&&f?xe=Object.fromEntries(f.map(i=>[i.id,{nome:i.nome||"Produto",disponivel_todas_cidades:i.disponivel_todas_cidades}])):P&&console.error(P)}const je=(a,m)=>{if(!a)return"";if(K[a]){const l=K[a];if(!!l?.tipo_produtos?.disponivel_todas_cidades||!m||l.cidade_id===m)return l.nome||"Produto"}if(J[a])return J[a];const j=p.find(l=>{const f=!!l?.tipo_produtos?.disponivel_todas_cidades;return l.tipo_produto===a&&(f||!m||l.cidade_id===m)}),n=xe[a]||{};return j?.nome||n.nome||"Produto"};v.length>0&&(v=v.map(a=>({...a,produtos:(a.produtos||[]).map(m=>je(m,a.destino_cidade_id)).filter(Boolean)})));const De=D?.map(a=>({id:a.id,data_orcamento:a.data_orcamento,status:a.status,valor:a.valor??null,numero_venda:a.numero_venda??null,destino_nome:a.destinos?.nome||null,destino_cidade_nome:a.destinos?.cidade_id?b[a.destinos?.cidade_id]||"":null,produto_nome:je(a.produto_id,a.destinos?.cidade_id)}))||[];re(v),le(De)}catch(h){console.error(h),y("Erro ao carregar histÃ³rico do cliente.")}finally{me(!1)}}function pe(){ne(null),re([]),le([]),k(null),L([]),I(null)}async function we(t){k(t),he(!0),L([]);try{const{data:s}=await c.from("vendas_recibos").select("id, numero_recibo, valor_total, valor_taxas, produto_id").eq("venda_id",t.id),h=(s||[]).map(r=>({id:r.id,numero_recibo:r.numero_recibo,valor_total:r.valor_total,valor_taxas:r.valor_taxas,produto_id:r.produto_id,produto_nome:null}))||[],u=Array.from(new Set(h.map(r=>r.produto_id).filter(r=>!!r))),g=t.destino_cidade_id||"";let v=[],b={};if(u.length>0){const{data:r,error:N}=await c.from("produtos").select("id, nome, cidade_id, tipo_produto, tipo_produtos(disponivel_todas_cidades)").in("tipo_produto",u);!N&&r?v=r:N&&console.error(N);const{data:R,error:p}=await c.from("tipo_produtos").select("id, nome, disponivel_todas_cidades").in("id",u);!p&&R?b=Object.fromEntries(R.map(C=>[C.id,{nome:C.nome||"Produto",disponivel_todas_cidades:C.disponivel_todas_cidades}])):p&&console.error(p)}const D=r=>{if(!r)return"";const N=v.find(p=>{const C=!!p?.tipo_produtos?.disponivel_todas_cidades;return p.tipo_produto===r&&(C||!g||p.cidade_id===g)}),R=b[r]||{};return N?.nome||R.nome||"Produto"};L(h.map(r=>({...r,produto_nome:D(r.produto_id)})))}catch(s){console.error(s),y("Erro ao carregar recibos da venda.")}finally{he(!1)}}function Se(t){I(t)}function Ce(t){E&&(M(t.id),V({nome:t.nome,nascimento:t.nascimento||"",cpf:t.cpf,telefone:t.telefone,whatsapp:t.whatsapp||"",email:t.email||"",endereco:t.endereco||"",complemento:t.complemento||"",cidade:t.cidade||"",estado:t.estado||"",cep:t.cep||"",rg:t.rg||"",genero:t.genero||"",nacionalidade:t.nacionalidade||"",tags:(t.tags||[]).join(", "),tipo_cliente:t.tipo_cliente||"passageiro",notas:t.notas||"",active:t.active}))}async function Ee(t){if(t.preventDefault(),!(!T&&!E))try{te(!0),y(null);const h={nome:fe(o.nome),nascimento:o.nascimento||null,cpf:o.cpf.trim(),telefone:o.telefone.trim(),whatsapp:o.whatsapp.trim()||null,email:o.email.trim()||null,endereco:o.endereco.trim()||null,complemento:o.complemento.trim()||null,cidade:o.cidade.trim()||null,estado:o.estado.trim()||null,cep:o.cep.trim()||null,rg:o.rg.trim()||null,genero:o.genero.trim()||null,nacionalidade:o.nacionalidade.trim()||null,tags:o.tags?o.tags.split(",").map(u=>u.trim()):[],tipo_cliente:o.tipo_cliente,notas:o.notas||null,active:o.active};if(B){const{error:u}=await c.from("clientes").update(h).eq("id",B);if(u)throw u;await U({acao:"cliente_editado",modulo:"Clientes",detalhes:{id:B,payload:h}})}else{const{error:u}=await c.from("clientes").insert(h);if(u)throw u;await U({acao:"cliente_criado",modulo:"Clientes",detalhes:h})}V(X),M(null),await G()}catch(s){console.error(s),y("Erro ao salvar cliente.")}finally{te(!1)}}async function Be(t){if(A&&window.confirm("Excluir cliente?"))try{oe(t);const{error:s}=await c.from("clientes").delete().eq("id",t);if(s)throw s;await U({acao:"cliente_excluido",modulo:"Clientes",detalhes:{id:t}}),await G()}catch{y("NÃ£o foi possÃ­vel excluir este cliente.")}finally{oe(null)}}if(!_e)return e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Clientes."})});const Le=!T&&!E;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"clientes-page",children:[!Le&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:Ee,children:[e.jsx("h3",{children:B?"Editar cliente":"Novo cliente"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:o.nome,onChange:t=>S("nome",t.target.value),onBlur:t=>S("nome",fe(t.target.value)),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"CPF *"}),e.jsx("input",{className:"form-input",value:o.cpf,onChange:t=>S("cpf",t.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Telefone *"}),e.jsx("input",{className:"form-input",value:o.telefone,onChange:t=>S("telefone",t.target.value)})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Whatsapp"}),e.jsx("input",{className:"form-input",value:o.whatsapp,onChange:t=>S("whatsapp",t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Email"}),e.jsx("input",{className:"form-input",value:o.email,onChange:t=>S("email",t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tags (,) "}),e.jsx("input",{className:"form-input",value:o.tags,onChange:t=>S("tags",t.target.value),placeholder:"premium, recorrente..."})]})]}),e.jsxs("div",{className:"mt-2",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-primary",disabled:ee,type:"submit",children:ee?"Salvando...":B?"Salvar alteraÃ§Ãµes":"Criar cliente"}),B&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:Ne,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",style:{marginTop:12},children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cliente"}),e.jsx("input",{className:"form-input",value:q,onChange:t=>ve(t.target.value),placeholder:"Nome, CPF ou e-mail"})]})})}),Z&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:Z})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[960px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Telefone"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{style:{textAlign:"center"},children:"Ativo"}),(E||A)&&e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[z&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Carregando..."})}),!z&&ue.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum cliente encontrado."})}),!z&&ue.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.nome}),e.jsx("td",{children:t.cpf}),e.jsx("td",{children:t.telefone}),e.jsx("td",{children:t.email||"-"}),e.jsx("td",{style:{textAlign:"center"},children:t.active?"Sim":"NÃ£o"}),(E||A)&&e.jsxs("td",{className:"th-actions",style:{textAlign:"center"},children:[e.jsx("button",{className:"btn-icon",onClick:()=>ye(t),title:"HistÃ³rico",children:"ðŸ—‚ï¸"}),E&&e.jsx("button",{className:"btn-icon",onClick:()=>Ce(t),title:"Editar",children:"âœï¸"}),A&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>Be(t.id),disabled:ae===t.id,title:"Excluir",children:ae===t.id?"...":"ðŸ—‘ï¸"})]})]},t.id))]})]})})]}),se&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:1100,width:"95vw"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"modal-title",style:{color:"#1d4ed8",fontSize:"1.2rem",fontWeight:800},children:["HistÃ³rico de ",se.nome]}),e.jsx("small",{style:{color:"#64748b"},children:"Vendas e orÃ§amentos do cliente"})]}),e.jsx("button",{className:"btn-ghost",onClick:pe,children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[ce&&e.jsx("p",{children:"Carregando histÃ³rico..."}),!ce&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"Vendas"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data LanÃ§amento"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[ie.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhuma venda encontrada."})}),ie.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.data_lancamento?new Date(t.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.destino_cidade_nome||"-"}),e.jsx("td",{children:t.data_embarque?new Date(t.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:t.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>we(t),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},t.id))]})]})})]}),e.jsxs("div",{className:"card-base card-blue mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"OrÃ§amentos do cliente"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Venda"}),e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[de.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhum orÃ§amento encontrado."})}),de.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.data_orcamento?new Date(t.data_orcamento).toLocaleDateString("pt-BR").replaceAll("/","-"):"-"}),e.jsx("td",{style:{textTransform:"capitalize"},children:t.status||"-"}),e.jsx("td",{children:t.destino_cidade_nome||"-"}),e.jsx("td",{children:t.produto_nome||"-"}),e.jsx("td",{children:(t.valor??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:t.numero_venda||"-"}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>Se(t),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},t.id))]})]})})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:pe,children:"Fechar"})})]})}),_&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:720},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{children:e.jsx("div",{className:"modal-title",style:{color:"#16a34a",fontSize:"1.15rem",fontWeight:800},children:"Detalhes da venda"})}),e.jsx("button",{className:"btn-ghost",onClick:()=>{k(null),L([])},children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{style:{display:"grid",gap:6,lineHeight:1.4,marginBottom:8},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Recibo:"})," ",F.length>0?F.map(t=>t.numero_recibo||"-").join(", "):"â€”"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Destino:"})," ",_.destino_cidade_nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"LanÃ§amento:"})," ",new Date(_.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",_.data_embarque?new Date(_.data_embarque).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",_.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Taxas:"})," ",_.valor_taxas===0?"-":_.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]})]}),e.jsx("h4",{style:{marginBottom:8,textAlign:"center"},children:"Recibos"}),be?e.jsx("p",{children:"Carregando recibos..."}):e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"NÃºmero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"})]})}),e.jsxs("tbody",{children:[F.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum recibo encontrado."})}),F.map((t,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:t.numero_recibo||"-"}),e.jsx("td",{children:t.produto_nome||"-"}),e.jsx("td",{children:(t.valor_total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:(t.valor_taxas||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},s))]})]})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>{k(null),L([])},children:"Fechar"})})]})}),w&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:640},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",style:{color:"#1d4ed8",fontSize:"1.15rem",fontWeight:800},children:"Detalhes do orÃ§amento"}),e.jsxs("small",{style:{color:"#64748b"},children:["Destino: ",w.destino_nome||"-"]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>I(null),children:"âœ•"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{style:{display:"grid",gap:6,lineHeight:1.4,marginBottom:4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Data:"})," ",w.data_orcamento?new Date(w.data_orcamento).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",w.status||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",(w.valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Venda vinculada:"})," ",w.numero_venda||"-"]})]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>I(null),children:"Fechar"})})]})})]})}export{Fe as default};
