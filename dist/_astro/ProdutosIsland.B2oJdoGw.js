import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as t}from"./index.C0Fn7Wtz.js";import{s as l}from"./supabase.Ng8nq9tn.js";import{u as $e}from"./usePermissao.DiLe8-Rs.js";import{t as L}from"./titleCase.DQLlfrnh.js";import{L as Le}from"./LoadingUsuarioContext.BaDUNi7o.js";function h(n){return(n||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function F(n){return n?(n.nome_fantasia?.trim()||n.nome_completo?.trim()||"").trim():""}const ge={nome:"",destino:"",cidade_id:"",tipo_produto:"",atracao_principal:"",melhor_epoca:"",duracao_sugerida:"",nivel_preco:"",imagem_url:"",informacoes_importantes:"",ativo:!0,fornecedor_id:"",fornecedor_label:""};function ze(){const{permissao:n,ativo:be,loading:xe}=$e("Cadastros"),[O,_e]=t.useState([]),[k,W]=t.useState([]),[N,Y]=t.useState([]),[A,J]=t.useState([]),[K,je]=t.useState([]),[i,D]=t.useState(ge),[g,Ne]=t.useState(""),[w,M]=t.useState(""),[we,b]=t.useState(!1),[Q,T]=t.useState([]),[I,X]=t.useState(!1),[q,Z]=t.useState(!0),[ee,ae]=t.useState(!1),[B,oe]=t.useState(null),[se,re]=t.useState(null),[R,p]=t.useState(null),[ie,P]=t.useState(null),[y,ye]=t.useState(!1),[z,Ce]=t.useState(null),[C,te]=t.useState([]);async function $(e=!1){const o=[],s=[];Z(!0),p(null);try{const[{data:r,error:m},{data:d,error:u},v,x]=await Promise.all([l.from("paises").select("id, nome").order("nome"),l.from("subdivisoes").select("id, nome, pais_id").order("nome"),l.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome").then(async f=>f.error?(s.push(`tipo_produtos: ${f.error.message}`),console.warn("Fallback tipo_produtos por 'tipo':",f.error),await l.from("tipo_produtos").select("id, nome, tipo").order("tipo")):f),l.from("produtos").select("id, nome, destino, cidade_id, tipo_produto, informacoes_importantes, atracao_principal, melhor_epoca, duracao_sugerida, nivel_preco, imagem_url, ativo, fornecedor_id, created_at").order(e?"nome":"created_at",{ascending:!!e}).limit(e?void 0:10)]);m?(o.push("paises"),m.message&&s.push(`paises: ${m.message}`)):_e(r||[]);const ue=d||[];if(u?(o.push("subdivisoes"),u.message&&s.push(`subdivisoes: ${u.message}`)):W(ue),v.error)o.push("tipo_produtos"),v.error.message&&s.push(`tipo_produtos: ${v.error.message}`);else{const f=v.data||[];if(f.length===0){const{data:S,error:_}=await l.from("tipo_produtos").select("id, nome, tipo").order("nome");_?(o.push("tipo_produtos"),s.push(`tipo_produtos (fallback): ${_.message}`)):J(S||[])}else J(f)}if(x.error)o.push("produtos"),x.error.message&&s.push(`produtos: ${x.error.message}`);else{const f=x.data||[];je(f),ye(e);const S=Array.from(new Set(f.map(_=>_.cidade_id).filter(Boolean)));if(S.length){const{data:_,error:V}=await l.from("cidades").select("id, nome, subdivisao_id, subdivisoes (id, nome, pais_id)").in("id",S);if(V)o.push("cidades"),V.message&&s.push(`cidades: ${V.message}`);else{const pe=_||[];Y(pe);const fe=Array.from(new Set(pe.map(G=>G.subdivisao_id).filter(Boolean)));if(fe.length){const G=new Set(ue.map(j=>j.id)),he=fe.filter(j=>!G.has(j));if(he.length){const{data:j,error:H}=await l.from("subdivisoes").select("id, nome, pais_id").in("id",he);H?(o.push("subdivisoes"),H.message&&s.push(`subdivisoes (faltantes): ${H.message}`)):j?.length&&W(Pe=>{const ve=new Map(Pe.map(E=>[E.id,E]));return j.forEach(E=>ve.set(E.id,E)),Array.from(ve.values())})}}}}else Y([])}}catch(r){console.error(r),o.push("geral"),r?.message&&s.push(`geral: ${r.message}`)}finally{if(o.length){const r=s.length?` Detalhes: ${s.join(" | ")}`:"";p(`Erro ao carregar: ${o.join(", ")}. Verifique permissoes/RLS.${r}`)}Z(!1)}}t.useEffect(()=>{$(!1)},[]),t.useEffect(()=>{let e=!0;async function o(){try{const{data:s}=await l.auth.getSession(),m=s?.session?.user||(await l.auth.getUser()).data?.user||null;if(!m||!e)return;const{data:d,error:u}=await l.from("users").select("company_id").eq("id",m.id).maybeSingle();if(!e)return;if(u){console.error("Erro ao buscar company_id dos fornecedores:",u);return}Ce(d?.company_id||null)}catch(s){console.error("Erro ao determinar company_id dos fornecedores:",s)}}return o(),()=>{e=!1}},[]),t.useEffect(()=>{if(!z){te([]);return}let e=!0;async function o(){const{data:s,error:r}=await l.from("fornecedores").select("id, nome_completo, nome_fantasia").eq("company_id",z).order("nome_fantasia",{ascending:!0});if(e){if(r){console.error("Erro ao carregar fornecedores:",r);return}te(s||[])}}return o(),()=>{e=!1}},[z]),t.useEffect(()=>{g.trim()&&!y&&$(!0)},[g,y]);const ne=t.useMemo(()=>new Map(k.map(e=>[e.id,e])),[k]),de=t.useMemo(()=>new Map(C.map(e=>[e.id,F(e)])),[C]);function Se(e){const o=N.find(r=>r.id===e);if(!o)return"";const s=ne.get(o.subdivisao_id);return s?`${o.nome} (${s.nome})`:o.nome}function le(e){return e&&((e.nome||"").trim()||e.tipo)||""}const U=t.useMemo(()=>{const e=new Map(N.map(r=>[r.id,r])),o=new Map(O.map(r=>[r.id,r])),s=new Map(A.map(r=>[r.id,r]));return K.map(r=>{const m=e.get(r.cidade_id||""),d=m?ne.get(m.subdivisao_id)||m.subdivisoes:void 0,u=d?o.get(d.pais_id):void 0,v=r.tipo_produto?s.get(r.tipo_produto):void 0;return{...r,cidade_nome:m?.nome||"",subdivisao_nome:d?.nome||"",pais_nome:u?.nome||"",tipo_nome:le(v),fornecedor_nome:de.get(r.fornecedor_id||"")||""}})},[K,N,k,O,A,de]),ce=t.useMemo(()=>{if(!g.trim())return U;const e=h(g);return U.filter(o=>h(o.nome).includes(e)||h(o.cidade_nome).includes(e)||h(o.subdivisao_nome).includes(e)||h(o.pais_nome).includes(e)||h(o.tipo_nome).includes(e)||h(o.destino||"").includes(e))},[g,U]);function c(e,o){D(s=>({...s,[e]:o}))}function Ee(e){M(e);const o=N.find(s=>s.id===i.cidade_id);(!o||!h(o.nome).includes(h(e)))&&D(s=>({...s,cidade_id:""})),b(!0)}function De(e){c("fornecedor_label",e);const o=e.trim().toLowerCase();if(!o){c("fornecedor_id","");return}const s=C.find(r=>F(r).toLowerCase()===o);c("fornecedor_id",s?s.id:"")}function me(){D(ge),oe(null),p(null),M(""),b(!1)}function Me(e){const o=N.find(s=>s.id===e.cidade_id);oe(e.id),D({nome:e.nome,cidade_id:e.cidade_id,tipo_produto:e.tipo_produto||"",atracao_principal:e.atracao_principal||"",melhor_epoca:e.melhor_epoca||"",duracao_sugerida:e.duracao_sugerida||"",nivel_preco:e.nivel_preco||"",imagem_url:e.imagem_url||"",informacoes_importantes:e.informacoes_importantes||"",ativo:e.ativo??!0,destino:e.destino||"",fornecedor_id:e.fornecedor_id||"",fornecedor_label:F(C.find(s=>s.id===e.fornecedor_id))}),M(Se(e.cidade_id)||o?.nome||""),b(!1)}t.useEffect(()=>{if(w.trim().length<2){T([]);return}const e=new AbortController,o=setTimeout(async()=>{X(!0),P(null);try{const{data:s,error:r}=await l.rpc("buscar_cidades",{q:w.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(r){console.error("Erro ao buscar cidades:",r),P("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:m,error:d}=await l.from("cidades").select("id, nome, subdivisao_id").ilike("nome",`%${w.trim()}%`).order("nome");d?(console.error("Erro no fallback de cidades:",d),P("Erro ao buscar cidades.")):(T(m||[]),P(null))}else T(s||[])}finally{e.signal.aborted||X(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[w]);async function Te(e){if(e.preventDefault(),n==="view"){p("Voce nao tem permissao para salvar produtos.");return}if(!i.nome.trim()){p("Nome e obrigatorio.");return}if(!i.destino.trim()){p("Destino e obrigatorio.");return}if(!i.cidade_id){p("Cidade e obrigatoria.");return}if(!i.tipo_produto){p("Tipo de produto e obrigatorio.");return}try{ae(!0),p(null);const o=d=>{const u=d?.message||d?.error?.message||"",v=d?.details||d?.error?.details||"",x=d?.hint||d?.error?.hint||"";return[u,v,x].filter(Boolean).join(" | ")},s=L(i.nome),r=L(i.destino),m={nome:s,destino:r,cidade_id:i.cidade_id,tipo_produto:i.tipo_produto,atracao_principal:i.atracao_principal.trim()||null,melhor_epoca:i.melhor_epoca.trim()||null,duracao_sugerida:i.duracao_sugerida.trim()||null,nivel_preco:i.nivel_preco.trim()||null,imagem_url:i.imagem_url.trim()||null,informacoes_importantes:i.informacoes_importantes.trim()||null,ativo:i.ativo,fornecedor_id:i.fornecedor_id||null};if(B){const{error:d}=await l.from("produtos").update(m).eq("id",B);if(d){const u=o(d);throw new Error(u||d.message)}}else{const{error:d}=await l.from("produtos").insert(m);if(d){const u=o(d);throw new Error(u||d.message)}}me(),await $(y)}catch(o){console.error(o);const s=o?.message||o?.error?.message||"";p(`Erro ao salvar produto.${s?` Detalhes: ${s}`:""}`)}finally{ae(!1)}}async function Be(e){if(n!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{re(e),p(null);const{error:o}=await l.from("produtos").delete().eq("id",e);if(o)throw o;await $(y)}catch(o){console.error(o),p("Nao foi possivel excluir o produto. Verifique vinculos com vendas/orcamentos.")}finally{re(null)}}return xe?a.jsx(Le,{}):be?a.jsxs("div",{className:"destinos-page",children:[a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:Te,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome do produto *"}),a.jsx("input",{className:"form-input",value:i.nome,onChange:e=>c("nome",e.target.value),onBlur:e=>c("nome",L(e.target.value)),placeholder:"Ex: Passeio em Gramado, Pacote Paris...",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo *"}),a.jsxs("select",{className:"form-select",value:i.tipo_produto,onChange:e=>c("tipo_produto",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione o tipo"}),A.map(e=>a.jsx("option",{value:e.id,children:le(e)||"(sem nome)"},e.id))]})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Destino *"}),a.jsx("input",{className:"form-input",value:i.destino,onChange:e=>c("destino",e.target.value),onBlur:e=>c("destino",L(e.target.value)),placeholder:"Ex: Disney, Porto de Galinhas",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Cidade *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:w,onChange:e=>Ee(e.target.value),onFocus:()=>b(!0),onBlur:()=>setTimeout(()=>b(!1),150),disabled:n==="view",style:{marginBottom:6}}),I&&a.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),ie&&!I&&a.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:ie}),we&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb"},children:[Q.length===0&&!I&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),Q.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return a.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:i.cidade_id===e.id?"#e0f2fe":"#fff",borderColor:i.cidade_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:s=>{s.preventDefault(),c("cidade_id",e.id),M(o),b(!1),T([])},children:[o,e.pais_nome?a.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["â€¢ ",e.pais_nome]}):null]},e.id)})]})]}),a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Fornecedor (opcional)"}),a.jsx("input",{className:"form-input",list:"fornecedores-list",placeholder:"Escolha um fornecedor",value:i.fornecedor_label,onChange:e=>De(e.target.value),disabled:n==="view"}),a.jsx("datalist",{id:"fornecedores-list",children:C.map(e=>a.jsx("option",{value:F(e)},e.id))})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Atracao principal"}),a.jsx("input",{className:"form-input",value:i.atracao_principal,onChange:e=>c("atracao_principal",e.target.value),placeholder:"Ex: Disney, Torre Eiffel...",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Melhor epoca"}),a.jsx("input",{className:"form-input",value:i.melhor_epoca,onChange:e=>c("melhor_epoca",e.target.value),placeholder:"Ex: Dezembro a Marco",disabled:n==="view"})]})]}),a.jsxs("div",{className:"form-row",style:{marginTop:12},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Duracao sugerida"}),a.jsxs("select",{className:"form-select",value:i.duracao_sugerida,onChange:e=>c("duracao_sugerida",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),a.jsx("option",{value:"De 1 a 3 dias",children:"De 1 a 3 dias"}),a.jsx("option",{value:"De 3 a 5 dias",children:"De 3 a 5 dias"}),a.jsx("option",{value:"De 5 a 7 dias",children:"De 5 a 7 dias"}),a.jsx("option",{value:"De 7 a 10 dias",children:"De 7 a 10 dias"}),a.jsx("option",{value:"10 dias ou mais",children:"10 dias ou mais"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nivel de preco"}),a.jsxs("select",{className:"form-select",value:i.nivel_preco,onChange:e=>c("nivel_preco",e.target.value),disabled:n==="view",children:[a.jsx("option",{value:"",children:"Selecione"}),a.jsx("option",{value:"Economico",children:"Economico"}),a.jsx("option",{value:"Intermediario",children:"Intermediario"}),a.jsx("option",{value:"Premium",children:"Premium"}),a.jsx("option",{value:"Super Premium",children:"Super Premium"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Imagem (URL)"}),a.jsx("input",{className:"form-input",value:i.imagem_url,onChange:e=>c("imagem_url",e.target.value),placeholder:"URL de uma imagem do destino",disabled:n==="view"})]})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Informacoes importantes"}),a.jsx("textarea",{className:"form-input",rows:3,value:i.informacoes_importantes,onChange:e=>c("informacoes_importantes",e.target.value),placeholder:"Observacoes gerais, dicas, documentacao necessaria, etc.",disabled:n==="view"})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Ativo"}),a.jsxs("select",{className:"form-select",value:i.ativo?"true":"false",onChange:e=>c("ativo",e.target.value==="true"),disabled:n==="view",children:[a.jsx("option",{value:"true",children:"Sim"}),a.jsx("option",{value:"false",children:"Nao"})]})]}),a.jsxs("div",{className:"mt-2",children:[n!=="view"&&a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:ee,children:ee?"Salvando...":B?"Salvar alteracoes":"Adicionar produto"}),B&&n!=="view"&&a.jsx("button",{type:"button",className:"btn btn-light",style:{marginLeft:8},onClick:me,children:"Cancelar edicao"})]})]})}),a.jsx("div",{className:"card-base mb-3",children:a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Buscar produto"}),a.jsx("input",{className:"form-input",value:g,onChange:e=>Ne(e.target.value),placeholder:"Busque por nome, tipo, destino, cidade, estado/provÃ­ncia ou paÃ­s"})]})})}),R&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:R})}),!y&&!R&&a.jsx("div",{className:"card-base card-config mb-3",children:"Ultimos Produtos Cadastrados (10). Digite na busca para consultar todos."}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1080px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Tipo"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Fornecedor"}),a.jsx("th",{children:"Estado/ProvÃ­ncia"}),a.jsx("th",{children:"Pais"}),a.jsx("th",{children:"Nivel de preco"}),a.jsx("th",{children:"Ativo"}),a.jsx("th",{children:"Criado em"}),a.jsx("th",{className:"th-actions",children:"Acoes"})]})}),a.jsxs("tbody",{children:[q&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando produtos..."})}),!q&&ce.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum produto encontrado."})}),!q&&ce.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.tipo_nome||"-"}),a.jsx("td",{children:e.destino||"-"}),a.jsx("td",{children:e.cidade_nome||"-"}),a.jsx("td",{children:e.fornecedor_nome||"-"}),a.jsx("td",{children:e.subdivisao_nome||"-"}),a.jsx("td",{children:e.pais_nome||"-"}),a.jsx("td",{children:e.nivel_preco||"-"}),a.jsx("td",{children:e.ativo?"Sim":"Nao"}),a.jsx("td",{children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-"}),a.jsxs("td",{className:"th-actions",children:[n!=="view"&&a.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>Me(e),children:"âœï¸"}),(n==="admin"||n==="delete")&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>Be(e.id),disabled:se===e.id,children:se===e.id?"...":"ğŸ—‘ï¸"})]})]},e.id))]})]})})]}):a.jsx("div",{children:"Voce nao possui acesso ao modulo de Cadastros."})}export{ze as default};
