import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as S}from"./supabase.Ng8nq9tn.js";import{u as Ce}from"./usePermissao.DiLe8-Rs.js";import{L as Pe}from"./LoadingUsuarioContext.BaDUNi7o.js";function Le(s,i){const g=s.valor_total_bruto-s.valor_total_taxas;return i.foco_valor==="liquido"?g:i.usar_taxas_na_meta?s.valor_total_bruto:g}function qe(s,i){if(s.modo==="FIXO"||!s.esc_ativado)return i<100?s.meta_nao_atingida??0:i>=100&&i<120?s.meta_atingida??s.meta_nao_atingida??0:s.super_meta??s.meta_atingida??s.meta_nao_atingida??0;let f=s.meta_atingida??s.meta_nao_atingida??0;if(s.esc_ativado){const l=s.esc_inicial_pct??100,x=s.esc_final_pct??i,p=s.esc_incremento_pct_meta??5,_=s.esc_incremento_pct_comissao??0;if(i>l&&p>0){const N=Math.min(i,x),h=Math.floor((N-l)/p);f+=h*_}}if(s.esc2_ativado){const l=s.esc2_inicial_pct??120,x=s.esc2_final_pct??i,p=s.esc2_incremento_pct_meta??5,_=s.esc2_incremento_pct_comissao??0;if(i>l&&p>0){const N=Math.min(i,x),h=Math.floor((N-l)/p);f+=h*_}}return f}function we(s,i,g){const f=Le(s,g),l=s.percentual_meta_atingido,x=qe(i,l),p=s.valor_total_bruto-s.valor_total_taxas,_=p*(x/100);return{baseMeta:f,pctMeta:l,pctComissao:x,valorLiquido:p,valorComissao:_}}function Ee(){const s=new Date,i=s.getFullYear(),g=String(s.getMonth()+1).padStart(2,"0");return`${i}-${g}`}function Z(s){return`${s}-01`}function Ve(s){const[i,g]=s.split("-"),f=parseInt(i,10),l=parseInt(g,10),x=l===12?1:l+1,p=l===12?f+1:f,_=String(x).padStart(2,"0");return`${p}-${_}-01`}function Ae(){const{permissao:s,ativo:i,loading:g}=Ce("Metas"),[f,l]=r.useState(null),[x,p]=r.useState([]),[_,N]=r.useState([]),[h,ee]=r.useState(null),[D,ae]=r.useState({}),[y,F]=r.useState(""),[R,E]=r.useState(""),[b,te]=r.useState(Ee()),[j,se]=r.useState(null),[B,V]=r.useState([]),[z,A]=r.useState([]),[oe,I]=r.useState(!0),[W,$]=r.useState(!1),[U,v]=r.useState(null),[O,re]=r.useState(0),[ne,ie]=r.useState(0),[k,ce]=r.useState(0),[G,de]=r.useState(0),[le,me]=r.useState(0),[ue,fe]=r.useState(0),[xe,_e]=r.useState(0);function pe(a,t){if(a.tipo==="GERAL")return t<100?a.meta_nao_atingida??0:t>=100&&t<120?a.meta_atingida??a.meta_nao_atingida??0:a.super_meta??a.meta_atingida??a.meta_nao_atingida??0;const n=t>=0?t<100?"PRE":"POS":"PRE",o=(a.commission_tier||[]).filter(d=>d.faixa===n).find(d=>t>=d.de_pct&&t<=d.ate_pct);return o?o.inc_pct_comissao??0:a.meta_atingida??a.meta_nao_atingida??0}const Q=s==="admin",he=s==="edit",ge=f?.uso_individual===!1&&(Q||he)||Q,ve=f?.uso_individual===!1&&ge;r.useEffect(()=>{je()},[]);async function je(){try{I(!0),v(null);const{data:a}=await S.auth.getUser(),t=a?.user?.id;if(!t){v("Usuário não autenticado.");return}const{data:n,error:c}=await S.from("users").select("id, nome_completo, uso_individual, company_id");if(c)throw c;const o=(n||[]).find(u=>u.id===t);l(o||null);let d=[];o?.company_id?d=(n||[]).filter(u=>u.company_id===o.company_id):d=o?[o]:[],p(d);const m=o?.id??"";F(m);const{data:C,error:P}=await S.from("commission_templates").select("*").eq("ativo",!0).order("nome",{ascending:!0});if(P)throw P;N(C||[]),C&&C.length>0&&E(C[0].id);const q=await ye(o);ee(q),m&&(await X(m,b),await Y(m,b));const{data:L}=await S.from("product_commission_rule").select(`
            produto_id,
            commission_rule:rule_id (
              id,
              nome,
              tipo,
              meta_nao_atingida,
              meta_atingida,
              super_meta,
              commission_tier (*)
            )
          `),w={};(L||[]).forEach(u=>{u.produto_id&&u.commission_rule&&(w[u.produto_id]=u.commission_rule)}),ae(w)}catch(a){console.error(a),v("Erro ao carregar dados iniciais do fechamento.")}finally{I(!1)}}async function ye(a){if(!a)return{usar_taxas_na_meta:!0};if(a.uso_individual){const{data:t}=await S.from("parametros_comissao").select("*").eq("owner_user_id",a.id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}if(a.company_id){const{data:t}=await S.from("parametros_comissao").select("*").eq("company_id",a.company_id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}return{usar_taxas_na_meta:!0}}async function X(a,t){const n=Z(t),{data:c}=await S.from("metas_vendedor").select("*").eq("vendedor_id",a).eq("periodo",n).maybeSingle(),o=c||null;return se(o),o?.template_id&&E(o.template_id),o}async function Se(a){const t=[a];try{const{data:n,error:c}=await S.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a);!c&&n&&n.forEach(o=>{o.vendedor_id&&!t.includes(o.vendedor_id)&&t.push(o.vendedor_id)})}catch(n){console.error("Erro ao carregar equipe:",n)}return A(t),t}async function Y(a,t){if(!a||a.length===0){V([]);return}const n=Z(t),c=Ve(t),{data:o,error:d}=await S.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            produto_id,
            valor_total,
            valor_taxas
          )
        `).in("vendedor_id",a).eq("cancelada",!1).gte("data_lancamento",n).lt("data_lancamento",c);if(d){console.error(d),v("Erro ao carregar vendas do período."),V([]);return}V(o||[])}r.useEffect(()=>{y&&f&&(async()=>{v(null);const a=await X(y,b);let t=[y];a?.scope==="equipe"?t=await Se(y):A([y]),await Y(t,b)})()},[y,b]);const be=r.useMemo(()=>{let a=0,t=0;for(const c of B)for(const o of c.vendas_recibos||[]){const d=o.valor_total??0,m=o.valor_taxas??0;a+=d+m,t+=m}const n=a-t;return{totalBruto:a,totalTaxas:t,liquido:n}},[B]);async function Be(){if(!R){v("Selecione um template de comissão.");return}if(!j){v("Defina uma meta para este período antes de calcular a comissão.");return}if(!h){v("Parâmetros de comissão não encontrados.");return}try{$(!0),v(null);const a=_.find(u=>u.id===R);if(!a){v("Template de comissão não encontrado.");return}const{totalBruto:t,totalTaxas:n,liquido:c}=be;re(t),ie(n),ce(c);const o=h.foco_valor==="liquido"?c:h.usar_taxas_na_meta?t:c;de(o);const d=j.meta_geral||0;let m=0;d>0&&(m=o/d*100);const P=we({valor_total_bruto:t,valor_total_taxas:n,percentual_meta_atingido:m},a,h),q=P.pctComissao;let L=q;if(D&&B.length>0){let u=0,H=0;B.forEach(Ne=>{(Ne.vendas_recibos||[]).forEach(M=>{const J=M.produto_id,K=J?D[J]:null,T=(M.valor_total??0)-(M.valor_taxas??0);if(K&&T>0){const Re=pe(K,m);H+=Re*T,u+=T}})}),u>0&&(L=H/u||q)}const w=c*(L/100);me(P.pctMeta),fe(L),_e(w)}catch(a){console.error(a),v("Erro ao calcular comissão do período.")}finally{$(!1)}}return g?e.jsx(Pe,{}):i?oe?e.jsx("div",{children:"Carregando dados do fechamento..."}):e.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-emerald-950 border border-emerald-800 text-emerald-100 text-sm flex flex-wrap gap-3 items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Módulo:"})," Fechamento de Comissão"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Perfil:"})," ",e.jsx("span",{style:{textTransform:"uppercase"},children:f?.uso_individual?"Uso Individual":"Corporativo"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Permissão:"})," ",e.jsx("span",{style:{textTransform:"uppercase",fontWeight:"bold",color:s==="admin"?"#22c55e":s==="edit"?"#eab308":"#ef4444"},children:s})]}),e.jsxs("div",{className:"w-full mt-2 flex flex-wrap gap-2",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Vendedor:"})," ",x.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Template:"})," ",_.find(a=>a.id===R)?.nome||"Selecione"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Meta:"})," ",j?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Foco:"})," ",h?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),e.jsxs("div",{className:"w-full mt-2 grid gap-2",style:{gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Vendedor:"})," ",x.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Template:"})," ",_.find(a=>a.id===R)?.nome||"Selecione"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Meta:"})," ",j?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Foco:"})," ",h?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),j?.scope==="equipe"&&e.jsxs("div",{className:"w-full mt-2 text-slate-300",children:[e.jsx("strong",{children:"Escopo:"})," Equipe (",z.length," membros)"]}),j?.scope==="equipe"&&z.length>0&&e.jsxs("div",{className:"w-full mt-1 text-slate-300 text-sm",children:[e.jsx("strong",{children:"Membros:"})," ",z.map(a=>x.find(t=>t.id===a)?.nome_completo||a).join(", ")]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-4",children:[ve&&e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Vendedor"}),e.jsx("select",{className:"form-select",value:y,onChange:a=>F(a.target.value),children:x.map(a=>e.jsx("option",{value:a.id,children:a.nome_completo},a.id))})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Período"}),e.jsx("input",{type:"month",className:"form-input",value:b,onChange:a=>te(a.target.value)})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Template de Comissão"}),e.jsxs("select",{className:"form-select",value:R,onChange:a=>E(a.target.value),children:[_.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.modo,")"]},a.id)),_.length===0&&e.jsx("option",{value:"",children:"Nenhum template disponível"})]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:Be,disabled:W||!j,children:W?"Calculando...":"Calcular comissão do mês"}),!j&&e.jsxs("span",{style:{marginLeft:10,fontSize:"0.85rem"},children:["Defina uma meta para este período em"," ",e.jsx("strong",{children:"Metas do Vendedor"}),"."]})]}),U&&e.jsx("div",{className:"card-base card-config mt-2",children:e.jsx("strong",{children:U})})]}),e.jsxs("div",{className:"mb-3 grid gap-3 md:gap-4",style:{gridTemplateColumns:"repeat(4, minmax(0, 1fr))"},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Meta do mês"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:j?j.meta_geral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"–"})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsxs("div",{style:{fontSize:"0.8rem",opacity:.8},children:["Base da meta (usando"," ",h?.usar_taxas_na_meta?"valor bruto (com taxas)":"valor líquido (sem taxas)",")"]}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:(h?.usar_taxas_na_meta?O:k).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Meta Atingida"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[le.toFixed(1),"%"]})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Comissão Aplicada"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[ue.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"mb-3",style:{display:"grid",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",gap:12},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor bruto no período (venda + taxas)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:O.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Total de taxas no período"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:ne.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor líquido (base da comissão)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:k.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsx("div",{style:{fontSize:"0.9rem",marginBottom:4},children:"Comissão estimada para o período"}),e.jsx("div",{style:{fontSize:"1.6rem",fontWeight:700,color:"#22c55e"},children:xe.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.75,marginTop:4},children:"Cálculo considerando sempre o valor líquido (venda - taxas), conforme sua regra de negócio."})]}),e.jsxs("div",{className:"card-base card-green mb-2",children:[e.jsx("h3",{children:"Vendas do período"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Somente vendas não canceladas com recibos vinculados."})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Qtd. Recibos"}),e.jsx("th",{children:"Bruto (R$)"}),e.jsx("th",{children:"Taxas (R$)"}),e.jsx("th",{children:"Líquido (R$)"})]})}),e.jsxs("tbody",{children:[B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma venda encontrada no período."})}),B.map(a=>{let t=0,n=0;for(const o of a.vendas_recibos||[]){const d=o.valor_total??0,m=o.valor_taxas??0;t+=d+m,n+=m}const c=t-n;return e.jsxs("tr",{children:[e.jsx("td",{children:a.data_lancamento?new Date(a.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.vendas_recibos?.length||0}),e.jsx("td",{children:t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:c.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},a.id)})]})]})})]}):e.jsx("div",{children:"Acesso ao módulo de Metas & Comissões bloqueado."})}export{Ae as default};
