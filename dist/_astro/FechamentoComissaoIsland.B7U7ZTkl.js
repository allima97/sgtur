import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as S}from"./supabase.Ng8nq9tn.js";import{u as Re}from"./usePermissao.DEV7Ufch.js";function Pe(s,i){const u=s.valor_total_bruto-s.valor_total_taxas;return i.foco_valor==="liquido"?u:i.usar_taxas_na_meta?s.valor_total_bruto:u}function Ce(s,i){if(s.modo==="FIXO"||!s.esc_ativado)return i<100?s.meta_nao_atingida??0:i>=100&&i<120?s.meta_atingida??s.meta_nao_atingida??0:s.super_meta??s.meta_atingida??s.meta_nao_atingida??0;let h=s.meta_atingida??s.meta_nao_atingida??0;if(s.esc_ativado){const d=s.esc_inicial_pct??100,g=s.esc_final_pct??i,m=s.esc_incremento_pct_meta??5,j=s.esc_incremento_pct_comissao??0;if(i>d&&m>0){const _=Math.min(i,g),N=Math.floor((_-d)/m);h+=N*j}}if(s.esc2_ativado){const d=s.esc2_inicial_pct??120,g=s.esc2_final_pct??i,m=s.esc2_incremento_pct_meta??5,j=s.esc2_incremento_pct_comissao??0;if(i>d&&m>0){const _=Math.min(i,g),N=Math.floor((_-d)/m);h+=N*j}}return h}function Le(s,i,u){const h=Pe(s,u),d=s.percentual_meta_atingido,g=Ce(i,d),m=s.valor_total_bruto-s.valor_total_taxas,j=m*(g/100);return{baseMeta:h,pctMeta:d,pctComissao:g,valorLiquido:m,valorComissao:j}}function qe(){const s=new Date,i=s.getFullYear(),u=String(s.getMonth()+1).padStart(2,"0");return`${i}-${u}`}function Z(s){return`${s}-01`}function we(s){const[i,u]=s.split("-"),h=parseInt(i,10),d=parseInt(u,10),g=d===12?1:d+1,m=d===12?h+1:h,j=String(g).padStart(2,"0");return`${m}-${j}-01`}function Te(){const{permissao:s,ativo:i}=Re("Metas"),[u,h]=r.useState(null),[d,g]=r.useState([]),[m,j]=r.useState([]),[_,N]=r.useState(null),[D,ee]=r.useState({}),[y,F]=r.useState(""),[R,E]=r.useState(""),[b,ae]=r.useState(qe()),[v,te]=r.useState(null),[B,V]=r.useState([]),[z,A]=r.useState([]),[se,I]=r.useState(!0),[W,$]=r.useState(!1),[U,p]=r.useState(null),[O,oe]=r.useState(0),[re,ne]=r.useState(0),[k,ie]=r.useState(0),[G,ce]=r.useState(0),[le,de]=r.useState(0),[me,ue]=r.useState(0),[fe,xe]=r.useState(0);function _e(a,t){if(a.tipo==="GERAL")return t<100?a.meta_nao_atingida??0:t>=100&&t<120?a.meta_atingida??a.meta_nao_atingida??0:a.super_meta??a.meta_atingida??a.meta_nao_atingida??0;const n=t>=0?t<100?"PRE":"POS":"PRE",o=(a.commission_tier||[]).filter(l=>l.faixa===n).find(l=>t>=l.de_pct&&t<=l.ate_pct);return o?o.inc_pct_comissao??0:a.meta_atingida??a.meta_nao_atingida??0}const Q=s==="admin",pe=s==="edit",he=u?.uso_individual===!1&&(Q||pe)||Q,ge=u?.uso_individual===!1&&he;r.useEffect(()=>{ve()},[]);async function ve(){try{I(!0),p(null);const{data:a}=await S.auth.getUser(),t=a?.user?.id;if(!t){p("Usuário não autenticado.");return}const{data:n,error:c}=await S.from("users").select("id, nome_completo, uso_individual, company_id");if(c)throw c;const o=(n||[]).find(x=>x.id===t);h(o||null);let l=[];o?.company_id?l=(n||[]).filter(x=>x.company_id===o.company_id):l=o?[o]:[],g(l);const f=o?.id??"";F(f);const{data:P,error:C}=await S.from("commission_templates").select("*").eq("ativo",!0).order("nome",{ascending:!0});if(C)throw C;j(P||[]),P&&P.length>0&&E(P[0].id);const q=await je(o);N(q),f&&(await X(f,b),await Y(f,b));const{data:L}=await S.from("product_commission_rule").select(`
            produto_id,
            commission_rule:rule_id (
              id,
              nome,
              tipo,
              meta_nao_atingida,
              meta_atingida,
              super_meta,
              commission_tier (*)
            )
          `),w={};(L||[]).forEach(x=>{x.produto_id&&x.commission_rule&&(w[x.produto_id]=x.commission_rule)}),ee(w)}catch(a){console.error(a),p("Erro ao carregar dados iniciais do fechamento.")}finally{I(!1)}}async function je(a){if(!a)return{usar_taxas_na_meta:!0};if(a.uso_individual){const{data:t}=await S.from("parametros_comissao").select("*").eq("owner_user_id",a.id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}if(a.company_id){const{data:t}=await S.from("parametros_comissao").select("*").eq("company_id",a.company_id).maybeSingle();if(t)return{usar_taxas_na_meta:t.usar_taxas_na_meta??!0}}return{usar_taxas_na_meta:!0}}async function X(a,t){const n=Z(t),{data:c}=await S.from("metas_vendedor").select("*").eq("vendedor_id",a).eq("periodo",n).maybeSingle(),o=c||null;return te(o),o?.template_id&&E(o.template_id),o}async function ye(a){const t=[a];try{const{data:n,error:c}=await S.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a);!c&&n&&n.forEach(o=>{o.vendedor_id&&!t.includes(o.vendedor_id)&&t.push(o.vendedor_id)})}catch(n){console.error("Erro ao carregar equipe:",n)}return A(t),t}async function Y(a,t){if(!a||a.length===0){V([]);return}const n=Z(t),c=we(t),{data:o,error:l}=await S.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            produto_id,
            valor_total,
            valor_taxas
          )
        `).in("vendedor_id",a).eq("cancelada",!1).gte("data_lancamento",n).lt("data_lancamento",c);if(l){console.error(l),p("Erro ao carregar vendas do período."),V([]);return}V(o||[])}r.useEffect(()=>{y&&u&&(async()=>{p(null);const a=await X(y,b);let t=[y];a?.scope==="equipe"?t=await ye(y):A([y]),await Y(t,b)})()},[y,b]);const Se=r.useMemo(()=>{let a=0,t=0;for(const c of B)for(const o of c.vendas_recibos||[]){const l=o.valor_total??0,f=o.valor_taxas??0;a+=l+f,t+=f}const n=a-t;return{totalBruto:a,totalTaxas:t,liquido:n}},[B]);async function be(){if(!R){p("Selecione um template de comissão.");return}if(!v){p("Defina uma meta para este período antes de calcular a comissão.");return}if(!_){p("Parâmetros de comissão não encontrados.");return}try{$(!0),p(null);const a=m.find(x=>x.id===R);if(!a){p("Template de comissão não encontrado.");return}const{totalBruto:t,totalTaxas:n,liquido:c}=Se;oe(t),ne(n),ie(c);const o=_.foco_valor==="liquido"?c:_.usar_taxas_na_meta?t:c;ce(o);const l=v.meta_geral||0;let f=0;l>0&&(f=o/l*100);const C=Le({valor_total_bruto:t,valor_total_taxas:n,percentual_meta_atingido:f},a,_),q=C.pctComissao;let L=q;if(D&&B.length>0){let x=0,H=0;B.forEach(Be=>{(Be.vendas_recibos||[]).forEach(M=>{const J=M.produto_id,K=J?D[J]:null,T=(M.valor_total??0)-(M.valor_taxas??0);if(K&&T>0){const Ne=_e(K,f);H+=Ne*T,x+=T}})}),x>0&&(L=H/x||q)}const w=c*(L/100);de(C.pctMeta),ue(L),xe(w)}catch(a){console.error(a),p("Erro ao calcular comissão do período.")}finally{$(!1)}}return i?se?e.jsx("div",{children:"Carregando dados do fechamento..."}):e.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[e.jsxs("div",{className:"mb-4 p-3 rounded-lg bg-emerald-950 border border-emerald-800 text-emerald-100 text-sm flex flex-wrap gap-3 items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Módulo:"})," Fechamento de Comissão"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Perfil:"})," ",e.jsx("span",{style:{textTransform:"uppercase"},children:u?.uso_individual?"Uso Individual":"Corporativo"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Permissão:"})," ",e.jsx("span",{style:{textTransform:"uppercase",fontWeight:"bold",color:s==="admin"?"#22c55e":s==="edit"?"#eab308":"#ef4444"},children:s})]}),e.jsxs("div",{className:"w-full mt-2 flex flex-wrap gap-2",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Vendedor:"})," ",d.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Template:"})," ",m.find(a=>a.id===R)?.nome||"Selecione"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Meta:"})," ",v?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Foco:"})," ",_?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),e.jsxs("div",{className:"w-full mt-2 grid gap-2",style:{gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Período:"})," ",b]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Vendedor:"})," ",d.find(a=>a.id===y)?.nome_completo||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Template:"})," ",m.find(a=>a.id===R)?.nome||"Selecione"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Meta:"})," ",v?.meta_geral?.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Base da meta:"})," ",G.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Foco:"})," ",_?.foco_valor==="liquido"?"Valor líquido":"Valor bruto"]})]}),v?.scope==="equipe"&&e.jsxs("div",{className:"w-full mt-2 text-slate-300",children:[e.jsx("strong",{children:"Escopo:"})," Equipe (",z.length," membros)"]}),v?.scope==="equipe"&&z.length>0&&e.jsxs("div",{className:"w-full mt-1 text-slate-300 text-sm",children:[e.jsx("strong",{children:"Membros:"})," ",z.map(a=>d.find(t=>t.id===a)?.nome_completo||a).join(", ")]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-4",children:[ge&&e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Vendedor"}),e.jsx("select",{className:"form-select",value:y,onChange:a=>F(a.target.value),children:d.map(a=>e.jsx("option",{value:a.id,children:a.nome_completo},a.id))})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Período"}),e.jsx("input",{type:"month",className:"form-input",value:b,onChange:a=>ae(a.target.value)})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Template de Comissão"}),e.jsxs("select",{className:"form-select",value:R,onChange:a=>E(a.target.value),children:[m.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.modo,")"]},a.id)),m.length===0&&e.jsx("option",{value:"",children:"Nenhum template disponível"})]})]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:be,disabled:W||!v,children:W?"Calculando...":"Calcular comissão do mês"}),!v&&e.jsxs("span",{style:{marginLeft:10,fontSize:"0.85rem"},children:["Defina uma meta para este período em"," ",e.jsx("strong",{children:"Metas do Vendedor"}),"."]})]}),U&&e.jsx("div",{className:"card-base card-config mt-2",children:e.jsx("strong",{children:U})})]}),e.jsxs("div",{className:"mb-3 grid gap-3 md:gap-4",style:{gridTemplateColumns:"repeat(4, minmax(0, 1fr))"},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Meta do mês"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:v?v.meta_geral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"–"})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsxs("div",{style:{fontSize:"0.8rem",opacity:.8},children:["Base da meta (usando"," ",_?.usar_taxas_na_meta?"valor bruto (com taxas)":"valor líquido (sem taxas)",")"]}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:(_?.usar_taxas_na_meta?O:k).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Meta Atingida"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[le.toFixed(1),"%"]})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"% Comissão Aplicada"}),e.jsxs("div",{style:{fontSize:"1.2rem",fontWeight:600},children:[me.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"mb-3",style:{display:"grid",gridTemplateColumns:"repeat(3, minmax(0, 1fr))",gap:12},children:[e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor bruto no período (venda + taxas)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:O.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Total de taxas no período"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:re.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),e.jsxs("div",{className:"card-base card-green",children:[e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Valor líquido (base da comissão)"}),e.jsx("div",{style:{fontSize:"1.2rem",fontWeight:600},children:k.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]}),e.jsxs("div",{className:"card-base card-green mb-3",children:[e.jsx("div",{style:{fontSize:"0.9rem",marginBottom:4},children:"Comissão estimada para o período"}),e.jsx("div",{style:{fontSize:"1.6rem",fontWeight:700,color:"#22c55e"},children:fe.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.75,marginTop:4},children:"Cálculo considerando sempre o valor líquido (venda - taxas), conforme sua regra de negócio."})]}),e.jsxs("div",{className:"card-base card-green mb-2",children:[e.jsx("h3",{children:"Vendas do período"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.8},children:"Somente vendas não canceladas com recibos vinculados."})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Qtd. Recibos"}),e.jsx("th",{children:"Bruto (R$)"}),e.jsx("th",{children:"Taxas (R$)"}),e.jsx("th",{children:"Líquido (R$)"})]})}),e.jsxs("tbody",{children:[B.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma venda encontrada no período."})}),B.map(a=>{let t=0,n=0;for(const o of a.vendas_recibos||[]){const l=o.valor_total??0,f=o.valor_taxas??0;t+=l+f,n+=f}const c=t-n;return e.jsxs("tr",{children:[e.jsx("td",{children:a.data_lancamento?new Date(a.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.vendas_recibos?.length||0}),e.jsx("td",{children:t.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:n.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:c.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},a.id)})]})]})})]}):e.jsx("div",{children:"Acesso ao módulo de Metas & Comissões bloqueado."})}export{Te as default};
