import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as n}from"./index.C0Fn7Wtz.js";import{s as i}from"./supabase.Ng8nq9tn.js";import{u as Na}from"./usePermissao.DiLe8-Rs.js";import{L as Sa}from"./LoadingUsuarioContext.BaDUNi7o.js";function _a(x){const M=x.getFullYear(),V=String(x.getMonth()+1).padStart(2,"0"),O=String(x.getDate()).padStart(2,"0"),P=String(x.getHours()).padStart(2,"0"),q=String(x.getMinutes()).padStart(2,"0"),v=Math.floor(Math.random()*900+100);return`VND-${M}${V}${O}-${P}${q}-${v}`}function La({suppressLoadingMessage:x=!1}){const{ativo:M,loading:V,podeCriar:O}=Na("Vendas"),[P,q]=n.useState(!1),[v,Je]=n.useState([]),[B,ce]=n.useState(""),[de,u]=n.useState(null),[U,me]=n.useState(!0),[Qe,ue]=n.useState(null),[pe,h]=n.useState(null),[g,N]=n.useState(null),[W,he]=n.useState(""),[fe,ve]=n.useState(""),[ge,xe]=n.useState(""),[be,je]=n.useState(""),[ye,Ne]=n.useState(""),[Se,_e]=n.useState(""),[Xe,Ze]=n.useState([]),[ea,aa]=n.useState([]),[ta,ra]=n.useState([]),H=["novo","enviado","negociando","fechado","perdido"],S=7,_={novo:{bg:"#e0f2fe",border:"#1d4ed8"},enviado:{bg:"#fef9c3",border:"#facc15"},negociando:{bg:"#fff7ed",border:"#fdba74"},fechado:{bg:"#ecfdf3",border:"#16a34a"},perdido:{bg:"#fee2e2",border:"#fca5a5"}},[we,K]=n.useState(null),[wa,Y]=n.useState(null),[G,Ce]=n.useState(""),[J,Ee]=n.useState(""),[Q,Ie]=n.useState(""),[X,ke]=n.useState(""),[l,De]=n.useState(null),[Le,Z]=n.useState([]),[ee,Te]=n.useState(!1),[w,C]=n.useState(!1),[Ae,f]=n.useState(null),[$e,E]=n.useState("anotacao"),[ae,I]=n.useState(""),[Re,k]=n.useState(""),[ze,D]=n.useState("email"),[te,L]=n.useState(""),[re,T]=n.useState(""),[ne,A]=n.useState(""),[Fe,oe]=n.useState(!0),[Me,Ve]=n.useState(null),[Oe,na]=n.useState(!1),[se,oa]=n.useState(!1),[j,Pe]=n.useState({}),[qe,Be]=n.useState([]),[sa,ia]=n.useState(0),la=[{value:"anotacao",label:"Anota√ß√£o interna"},{value:"contato",label:"Contato com cliente"},{value:"envio",label:"Envio de proposta"},{value:"follow-up",label:"Follow-up"}];n.useEffect(()=>{p(),ha()},[]),n.useEffect(()=>{if(typeof window>"u")return;const e=t=>{q(!!t?.detail?.aberto)};return window.addEventListener("formulario-orcamento-status",e),()=>window.removeEventListener("formulario-orcamento-status",e)},[]),n.useEffect(()=>{const e=()=>p();return window.addEventListener("orcamento-criado",e),()=>window.removeEventListener("orcamento-criado",e)},[]),n.useEffect(()=>{const e=()=>p();return window.addEventListener("orcamento-interacao-criada",e),()=>window.removeEventListener("orcamento-interacao-criada",e)},[]);async function p(){try{me(!0),u(null),h(null);let e=i.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            numero_venda,
            venda_criada,
            clientes:cliente_id (nome),
            destinos:produtos!destino_id (nome),
            produtos:tipo_produtos!produto_id (nome, tipo)
          `).order("data_orcamento",{ascending:!1});B&&(e=e.eq("status",B)),G&&(e=e.gte("data_orcamento",G)),J&&(e=e.lte("data_orcamento",J)),Q&&(e=e.gte("valor",parseFloat(Q))),X&&(e=e.lte("valor",parseFloat(X)));const{data:t,error:r}=await e;if(r)throw r;const o=t||[];Je(o);const s=o.map(m=>m.id).filter(Boolean);s.length?fa(s):Pe({})}catch(e){console.error(e),u("Erro ao carregar or√ßamentos.")}finally{me(!1)}}const $=n.useMemo(()=>{const e=["novo","enviado","negociando"];return v.filter(t=>{const r=t.status||"novo";if(!e.includes(r))return!1;const o=ca(t.data_viagem||null),s=da(t.data_orcamento||null),m=j[t.id],c=R(m?.created_at||null),z=!t.data_viagem&&s>=7,F=Number.isFinite(o)&&o<=7,ya=!m?.created_at||c>=S;return F||z||ya})},[v,j]),Ue=n.useMemo(()=>new Set($.map(e=>e.id)),[$]),b=n.useMemo(()=>se?v.filter(e=>Ue.has(e.id)):v,[v,se,Ue]),ie=n.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return b.forEach(t=>{const r=t.status||"novo";e[r]||(e[r]=[]),e[r].push(t)}),e},[b]);function ca(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,o=new Date(`${e}T00:00:00`).getTime()-t.getTime();return Math.floor(o/(1e3*60*60*24))}function da(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,r=new Date(`${e}T00:00:00`),o=t.getTime()-r.getTime();return Math.floor(o/(1e3*60*60*24))}function y(e,t=80){if(!e)return"";const r=e.replace(/\s+/g," ").trim();return r.length<=t?r:`${r.slice(0,t-1)}‚Ä¶`}function R(e){if(!e)return Number.POSITIVE_INFINITY;const t=Date.now()-new Date(e).getTime();return Math.floor(t/(1e3*60*60*24))}function d(e,t="success"){ia(o=>o+1);const r=sa+1;Be(o=>[...o,{id:r,message:e,type:t}]),setTimeout(()=>{Be(o=>o.filter(s=>s.id!==r))},3500)}const We=n.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return b.forEach(t=>{const r=t.status||"novo",o=Number(t.valor||0);e[r]||(e[r]={qtd:0,valor:0}),e[r].qtd+=1,e[r].valor+=o}),e},[b]);function ma(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],t=b.map(c=>[c.id,c.clientes?.nome||"",c.destinos?.nome||"",c.produtos?.nome||"",c.status||"",c.valor??"",c.data_orcamento||"",c.data_viagem||"",c.numero_venda||""]),r=[e.join(","),...t.map(c=>c.join(","))].join(`
`),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(o),m=document.createElement("a");m.href=s,m.download="orcamentos.csv",m.click(),URL.revokeObjectURL(s)}function ua(e){K(e);const t=v.find(r=>r.id===e);t?.status&&Y(t.status)}async function pa(e){we&&(await He(we,e),K(null),Y(null))}async function ha(){try{const[e,t,r]=await Promise.all([i.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),i.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),i.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);e.data&&Ze(e.data),t.data&&aa(t.data),r.data&&ra(r.data)}catch(e){console.error(e)}}async function fa(e){try{const{data:t,error:r}=await i.from("orcamento_interacoes").select("orcamento_id, tipo, created_at, mensagem, anexo_url").in("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;const o={};(t||[]).forEach(s=>{o[s.orcamento_id]||(o[s.orcamento_id]={tipo:s.tipo,created_at:s.created_at,mensagem:s.mensagem,anexo_url:s.anexo_url})}),Pe(o)}catch(t){console.error("Erro ao carregar √∫ltimas intera√ß√µes",t)}}async function He(e,t){try{ue(e),u(null),h(null);const{error:r}=await i.from("orcamentos").update({status:t}).eq("id",e);if(r)throw r;h("Status atualizado."),d("Status atualizado.","success"),await p()}catch(r){console.error(r),u("Erro ao alterar status."),d("Erro ao alterar status.","error")}finally{ue(null)}}function Ke(e){N(e),he(e.valor?String(e.valor):""),ve(e.data_viagem||""),xe(e.notas||""),je(e.cliente_id||""),Ne(e.destino_id||""),_e(e.produto_id||""),u(null),h(null)}async function va(e){if(e.preventDefault(),!!g)try{h(null),u(null);const{error:t}=await i.from("orcamentos").update({valor:W?parseFloat(W):null,data_viagem:fe||null,notas:ge||null,cliente_id:be||g.cliente_id||null,destino_id:ye||g.destino_id||null,produto_id:Se||g.produto_id||null}).eq("id",g.id);if(t)throw t;h("Or√ßamento atualizado."),d("Or√ßamento atualizado.","success"),N(null),await p()}catch(t){console.error(t),u("Erro ao salvar edi√ß√£o."),d("Erro ao salvar edi√ß√£o.","error")}}async function ga(e){if(window.confirm("Converter este or√ßamento em venda?"))try{h(null),u(null);const{data:r}=await i.auth.getUser(),o=r?.user?.id;if(!o)throw new Error("Usu√°rio n√£o autenticado.");const s=new Date,m=_a(s),c=s.toISOString().slice(0,10),{data:z,error:F}=await i.from("vendas").insert({vendedor_id:o,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:c,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:m,notas:e.notas}).select("id, numero_venda").maybeSingle();if(F)throw F;z?.id&&e.produto_id&&await i.from("vendas_recibos").insert({venda_id:z.id,produto_id:e.produto_id,numero_recibo:m,valor_total:e.valor||0,valor_taxas:0}),await i.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${m}`}).eq("id",e.id),h("Or√ßamento convertido em venda."),d("Or√ßamento convertido em venda.","success"),await p()}catch(r){console.error(r),u("Erro ao converter para venda."),d("Erro ao converter para venda.","error")}}async function xa(e){try{Ve(e.id),u(null),h(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const o=`Follow-up autom√°tico: or√ßamento ${e.id} (${e.status||"novo"}) ${e.data_viagem?`viagem em ${e.data_viagem}`:"sem data de viagem"}.`,{error:s}=await i.from("orcamento_interacoes").insert({orcamento_id:e.id,usuario_id:r,tipo:"follow-up",mensagem:o});if(s)throw s;h("Follow-up registrado."),d("Follow-up registrado.","success"),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:e.id}})),await p()}catch(t){console.error(t),u("Erro ao registrar follow-up."),d("Erro ao registrar follow-up.","error")}finally{Ve(null)}}async function le(e){try{Te(!0),f(null);const{data:t,error:r}=await i.from("orcamento_interacoes").select(`
            id,
            tipo,
            mensagem,
            created_at,
            usuario_id,
            responsavel_id,
            anexo_url,
            users:usuario_id (email),
            responsavel:responsavel_id (email)
          `).eq("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;Z(t||[])}catch(t){console.error(t);const r=t?.message||"Erro ao carregar intera√ß√µes.";f(`${r} Verifique se a tabela "orcamento_interacoes" existe com colunas esperadas.`)}finally{Te(!1)}}function Ye(e){De(e),Z([]),I(""),E("anotacao"),k(""),D("email"),L(""),T(""),A(""),oe(!0),le(e.id)}function Ge(){De(null),Z([]),f(null),I(""),E("anotacao"),k(""),D("email"),L(""),T(""),A(""),oe(!0)}async function ba(e){if(e.preventDefault(),!!l){if(!ae.trim()){f("Escreva uma mensagem para registrar no hist√≥rico.");return}try{C(!0),f(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const{error:o}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:$e||"anotacao",mensagem:ae.trim(),anexo_url:Re.trim()||null});if(o)throw o;I(""),E("anotacao"),k(""),await le(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),d("Intera√ß√£o registrada.","success")}catch(t){console.error(t);const r=t?.message||"Erro ao salvar intera√ß√£o.";f(r),d("Erro ao salvar intera√ß√£o.","error")}finally{C(!1)}}}async function ja(e){if(e.preventDefault(),!!l){if(!ne.trim()&&!re.trim()){f("Informe uma mensagem ou um link para registrar o envio/compartilhamento.");return}try{C(!0),f(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const o=ne.trim()||`Enviado via ${ze}${te?` para ${te}`:""}.`,{error:s}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:"envio",mensagem:o,anexo_url:re.trim()||null});if(s)throw s;Fe&&l.status!=="fechado"&&l.status!=="perdido"&&(await i.from("orcamentos").update({status:"enviado"}).eq("id",l.id),await p()),A(""),T(""),L(""),D("email"),await le(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),d("Envio registrado.","success"),await p()}catch(t){console.error(t);const r=t?.message||"Erro ao registrar envio/compartilhamento.";f(r),d("Erro ao registrar envio/compartilhamento.","error")}finally{C(!1)}}}return V?x?null:a.jsx(Sa,{}):M?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",children:[a.jsxs("div",{className:"grid w-full mt-3 gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",alignItems:"end"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:B,onChange:e=>ce(e.target.value),children:[a.jsx("option",{value:"",children:"Todos"}),H.map(e=>a.jsx("option",{value:e,children:e},e))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data in√≠cio"}),a.jsx("input",{className:"form-input",type:"date",value:G,onChange:e=>Ce(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{className:"form-input",type:"date",value:J,onChange:e=>Ee(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor min"}),a.jsx("input",{className:"form-input",type:"number",value:Q,onChange:e=>Ie(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor max"}),a.jsx("input",{className:"form-input",type:"number",value:X,onChange:e=>ke(e.target.value)})]}),O&&a.jsxs("div",{className:"form-group",style:{display:"flex",flexDirection:"column",alignItems:"flex-start"},children:[a.jsx("span",{style:{visibility:"hidden"},children:"bot√£o"}),a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>window.dispatchEvent(new CustomEvent("abrir-formulario-orcamento")),disabled:P,children:"Adicionar or√ßamento"})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[a.jsx("button",{className:"btn btn-secondary min-w-[120px]",onClick:p,children:"Atualizar"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:ma,children:"Exportar CSV"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:()=>{ce(""),Ce(""),Ee(""),Ie(""),ke(""),p()},children:"Limpar filtros"}),a.jsx("button",{className:"btn btn-light min-w-[160px]",onClick:()=>na(e=>!e),children:Oe?"Ocultar Kanban":"Mostrar Kanban"}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:se,onChange:e=>oa(e.target.checked)}),"S√≥ pendentes de follow-up"]})]})]}),de&&a.jsx("div",{className:"auth-error",children:de}),pe&&a.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:pe}),a.jsxs("div",{className:"card-base card-blue mt-3",children:[a.jsx("h3",{className:"card-title font-semibold",children:"Situa√ß√£o do Or√ßamento"}),a.jsx("div",{className:"grid gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",alignItems:"stretch"},children:H.map(e=>a.jsxs("div",{className:"kpi-card flex flex-col gap-1 items-center justify-center text-center",style:{background:_[e].bg,border:`1px solid ${_[e].border}`},children:[a.jsxs("div",{className:"kpi-label capitalize font-bold",children:[e," - ",String(We[e].qtd).padStart(2,"0")," Itens"]}),a.jsx("div",{className:"kpi-value text-xl font-extrabold",children:We[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))})]}),$.length>0&&a.jsxs("div",{className:"card-base card-yellow",style:{marginTop:12},children:[a.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Pendentes de follow-up"}),a.jsx("p",{className:"page-subtitle",children:"Viagem pr√≥xima (‚â§ 7 dias) ou or√ßamento sem data h√° 7+ dias. Clique para registrar follow-up."})]})}),a.jsx("div",{style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))"},children:$.map(e=>{const t=j[e.id],r=R(t?.created_at||null),o=!t?.created_at||r>=S;return a.jsxs("div",{className:"card-base",style:{border:"1px solid #facc15",background:"#fffbeb"},children:[a.jsx("div",{style:{fontWeight:700},children:e.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Status: ",(e.status||"novo").toUpperCase()," | Viagem: ",e.data_viagem||"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),o&&a.jsxs("div",{style:{marginTop:4,color:"#b45309",fontSize:"0.85rem",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]}),a.jsx("button",{className:"btn btn-primary",style:{marginTop:8,width:"100%"},onClick:()=>xa(e),disabled:Me===e.id,children:Me===e.id?"Registrando...":"Registrar follow-up"}),t?.tipo&&a.jsxs("div",{style:{marginTop:8,fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",t?.tipo," ",t?.created_at?new Date(t?.created_at||"").toLocaleDateString("pt-BR"):"",y(t?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:y(t?.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]})]},`pend-${e.id}`)})})]}),a.jsx("div",{className:"card-base",style:{marginTop:16},children:a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{style:{textAlign:"center"},children:"Status"}),a.jsx("th",{style:{textAlign:"center"},children:"Valor"}),a.jsx("th",{style:{textAlign:"center"},children:"Data viagem"}),a.jsx("th",{style:{textAlign:"center"},children:"√öltima intera√ß√£o"}),a.jsx("th",{style:{textAlign:"center"},children:"A√ß√µes"})]})}),a.jsxs("tbody",{children:[U&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando..."})}),!U&&b.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum or√ßamento encontrado."})}),!U&&b.map(e=>{const t=j[e.id],r=R(t?.created_at||null),o=!t?.created_at||r>=S;return a.jsxs("tr",{children:[a.jsx("td",{children:e.data_orcamento?.slice(0,10)||"‚Äî"}),a.jsx("td",{children:e.clientes?.nome||"‚Äî"}),a.jsx("td",{children:e.destinos?.nome||"‚Äî"}),a.jsx("td",{children:e.produtos?.nome||"‚Äî"}),a.jsx("td",{style:{textTransform:"capitalize",textAlign:"center"},children:a.jsxs("select",{className:"form-select",value:e.status||"",onChange:s=>He(e.id,s.target.value),disabled:Qe===e.id,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"enviado",children:"Enviado"}),a.jsx("option",{value:"negociando",children:"Negociando"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})}),a.jsx("td",{style:{textAlign:"center"},children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"}),a.jsx("td",{style:{textAlign:"center"},children:e.data_viagem||"‚Äî"}),a.jsxs("td",{style:{textAlign:"center",fontSize:"0.85rem",color:"#475569"},children:[t?.tipo||"‚Äî",t?.created_at?` ‚Ä¢ ${new Date(t.created_at).toLocaleDateString("pt-BR")}`:"",t?.mensagem&&a.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:y(t.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})}),o&&a.jsxs("div",{style:{color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]})]}),a.jsxs("td",{style:{textAlign:"center"},children:[a.jsx("button",{className:"btn-icon",onClick:()=>Ke(e),style:{marginRight:6},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":"Editar",children:"‚úèÔ∏è"}),a.jsx("button",{className:"btn btn-primary","aria-label":"Converter em venda",onClick:()=>ga(e),style:{padding:"4px 8px",fontSize:"0.95rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"$"}),a.jsx("button",{className:"btn-icon","aria-label":"Hist√≥rico de intera√ß√µes",onClick:()=>Ye(e),style:{marginLeft:6},title:"Ver hist√≥rico / registrar intera√ß√£o",children:"üïí"})]})]},e.id)})]})]})})}),Oe&&a.jsxs("div",{className:"card-base",style:{marginTop:16},children:[a.jsx("div",{className:"page-header",style:{marginBottom:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Kanban de Or√ßamentos"}),a.jsx("p",{className:"page-subtitle",children:"Arraste os cards entre colunas para alterar o status."})]})}),a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12,alignItems:"flex-start"},children:H.map(e=>a.jsxs("div",{onDragOver:t=>t.preventDefault(),onDrop:()=>pa(e),style:{border:`2px dashed ${_[e].border}`,background:_[e].bg,minHeight:120,padding:8,borderRadius:10},children:[a.jsxs("div",{style:{fontWeight:800,textTransform:"capitalize",marginBottom:6},children:[e," (",ie[e]?.length||0,")"]}),a.jsxs("div",{style:{display:"grid",gap:8},children:[(ie[e]||[]).map(t=>{const r=j[t.id],o=R(r?.created_at||null),s=!r?.created_at||o>=S;return a.jsxs("div",{draggable:!0,onDragStart:()=>ua(t.id),onDragEnd:()=>{K(null),Y(null)},className:"card-base",style:{padding:10,cursor:"grab",border:"1px solid #e2e8f0",background:"#fff"},children:[a.jsx("div",{style:{fontWeight:700},children:t.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",t.valor?t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Viagem: ",t.data_viagem||"‚Äî"]}),s&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(o)?`${o}d`:"‚Äî"]}),r?.tipo&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",r?.tipo," ",r?.created_at?new Date(r?.created_at||"").toLocaleDateString("pt-BR"):"",y(r?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:y(r?.mensagem)}),r?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:r?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]}),a.jsxs("div",{style:{display:"flex",gap:6,marginTop:6,flexWrap:"wrap"},children:[a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Ke(t),children:"Editar"}),a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Ye(t),children:"Hist√≥rico"})]})]},`kan-card-${t.id}`)}),(ie[e]||[]).length===0&&a.jsx("div",{style:{fontSize:"0.9rem",color:"#475569"},children:"Sem itens."})]})]},`kanban-${e}`))})]}),g&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Editar or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",g.clientes?.nome||"‚Äî"," | Destino: ",g.destinos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:()=>N(null),children:"‚úñ"})]}),a.jsxs("form",{onSubmit:va,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor (R$)"}),a.jsx("input",{className:"form-input",type:"number",value:W,onChange:e=>he(e.target.value),min:0,step:"0.01"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data da viagem"}),a.jsx("input",{className:"form-input",type:"date",value:fe,onChange:e=>ve(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:be,onChange:e=>je(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),Xe.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsxs("select",{className:"form-select",value:ye,onChange:e=>Ne(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),ea.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto"}),a.jsxs("select",{className:"form-select",value:Se,onChange:e=>_e(e.target.value),children:[a.jsx("option",{value:"",children:"(Opcional)"}),ta.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Notas"}),a.jsx("textarea",{className:"form-input",rows:3,value:ge,onChange:e=>xe(e.target.value)})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N(null),children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})}),l&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:640,width:"90vw"},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Hist√≥rico do or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Cliente: ",l.clientes?.nome||"‚Äî"," | Destino: ",l.destinos?.nome||"‚Äî"," | Produto: ",l.produtos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:Ge,children:"‚úñ"})]}),a.jsxs("div",{className:"modal-body",style:{display:"grid",gap:12},children:[a.jsxs("form",{onSubmit:ja,className:"card-base",style:{background:"#eef2ff"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Registrar envio / compartilhamento"}),a.jsxs("div",{className:"grid",style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Canal"}),a.jsxs("select",{className:"form-select",value:ze,onChange:e=>D(e.target.value),children:[a.jsx("option",{value:"email",children:"E-mail"}),a.jsx("option",{value:"whatsapp",children:"WhatsApp"}),a.jsx("option",{value:"link",children:"Link"}),a.jsx("option",{value:"outro",children:"Outro"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destinat√°rio"}),a.jsx("input",{className:"form-input",type:"text",value:te,onChange:e=>L(e.target.value),placeholder:"E-mail, telefone, nome..."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link"}),a.jsx("input",{className:"form-input",type:"url",value:re,onChange:e=>T(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:ne,onChange:e=>A(e.target.value),placeholder:"Ex.: Proposta enviada por e-mail. Link do PDF..."})]}),a.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8,fontSize:"0.9rem"},children:[a.jsx("input",{type:"checkbox",checked:Fe,onChange:e=>oe(e.target.checked)}),'Marcar or√ßamento como "enviado"']}),a.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:w,children:w?"Salvando...":"Registrar envio"})})]}),a.jsxs("form",{onSubmit:ba,className:"card-base",style:{background:"#f8fafc"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo"}),a.jsx("select",{className:"form-select",value:$e,onChange:e=>E(e.target.value),children:la.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:ae,onChange:e=>I(e.target.value),placeholder:"Ex.: Enviada proposta por e-mail. Aguardando retorno."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link / Anexo (opcional)"}),a.jsx("input",{className:"form-input",type:"url",value:Re,onChange:e=>k(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]}),Ae&&a.jsx("div",{className:"auth-error",children:Ae}),a.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:Ge,children:"Fechar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:w,children:w?"Salvando...":"Registrar"})]})]}),a.jsxs("div",{className:"card-base",style:{maxHeight:"50vh",overflowY:"auto"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Intera√ß√µes"}),ee&&a.jsx("div",{children:"Carregando intera√ß√µes..."}),!ee&&Le.length===0&&a.jsx("div",{children:"Nenhuma intera√ß√£o registrada ainda."}),!ee&&Le.map(e=>a.jsxs("div",{style:{padding:"10px 0",borderBottom:"1px solid #e2e8f0",display:"grid",gap:4},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[a.jsx("span",{style:{background:"#e2e8f0",color:"#0f172a",padding:"2px 8px",borderRadius:12,fontSize:"0.85rem",textTransform:"capitalize",whiteSpace:"nowrap"},children:e.tipo||"anotacao"}),a.jsx("span",{style:{fontSize:"0.85rem",color:"#475569",textAlign:"right"},children:e.created_at?new Date(e.created_at).toLocaleString("pt-BR"):"‚Äî"})]}),a.jsx("div",{style:{whiteSpace:"pre-wrap",color:"#0f172a"},children:e.mensagem}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Por: ",e.users?.email||e.usuario_id||"‚Äî"]}),e.anexo_url&&a.jsx("div",{style:{fontSize:"0.9rem"},children:a.jsx("a",{href:e.anexo_url,target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo/compartilhamento"})})]},e.id))]})]})]})}),qe.length>0&&a.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:qe.map(e=>a.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):a.jsx("div",{children:"Acesso ao m√≥dulo de Vendas bloqueado."})}export{La as default};
