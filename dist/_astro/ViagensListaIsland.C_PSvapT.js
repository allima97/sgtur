import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as c}from"./supabase.Ng8nq9tn.js";import{u as se}from"./usePermissao.DEV7Ufch.js";const te=[{value:"",label:"Todas"},{value:"planejada",label:"Planejada"},{value:"confirmada",label:"Confirmada"},{value:"em_viagem",label:"Em viagem"},{value:"concluida",label:"Concluída"},{value:"cancelada",label:"Cancelada"}];function oe(){const{permissao:u,loading:b,ativo:Q}=se("Operacao"),C=u!=="none",S=u==="create"||u==="edit"||u==="delete"||u==="admin",[p,W]=i.useState(""),[g,G]=i.useState(""),[x,H]=i.useState(""),[w,J]=i.useState([]),[j,E]=i.useState(!1),[D,V]=i.useState(null),[I,F]=i.useState(!1),[$,v]=i.useState(null),[k,A]=i.useState(!1),[r,d]=i.useState({origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada"}),[K,X]=i.useState([]),[O,R]=i.useState(null),[T,q]=i.useState(null),[Y,P]=i.useState(!1),[B,L]=i.useState(null),m=i.useRef(null),f=i.useRef(null),Z=a=>{const s=[a.nome];return a.subdivisao_nome&&s.push(a.subdivisao_nome),a.pais_nome&&s.push(a.pais_nome),s.join(" • ")};i.useEffect(()=>{!b&&C&&y()},[b,C,p,g,x]),i.useEffect(()=>{async function a(){const{data:s}=await c.auth.getSession(),t=s?.session?.user||null;if(t){q(t.id);const{data:n}=await c.from("users").select("company_id").eq("id",t.id).maybeSingle();R(n?.company_id||null)}else{const{data:n}=await c.auth.getUser();if(!n?.user)return;q(n.user.id);const{data:h}=await c.from("users").select("company_id").eq("id",n.user.id).maybeSingle();R(h?.company_id||null)}}a()},[]),i.useEffect(()=>(U(""),()=>{m.current&&m.current.abort(),f.current&&clearTimeout(f.current)}),[]);async function U(a){m.current&&m.current.abort();const s=new AbortController;m.current=s;try{P(!0),L(null);const t=a.trim(),n=t.length===0?200:50;let h=[];try{const{data:l,error:o}=await c.rpc("buscar_cidades",{q:t,limite:n},{signal:s.signal});if(o)throw o;h=l||[]}catch(l){if(s.signal.aborted)return;console.warn("RPC buscar_cidades falhou:",l);let o=c.from("cidades").select("nome").order("nome").limit(n);t.length>0&&(o=o.ilike("nome",`%${t}%`));const N=await o;if(N.error)throw N.error;h=(N.data||[]).map(ae=>({nome:ae.nome}))}if(s.signal.aborted)return;const _=new Map;h.forEach(l=>{if(!l?.nome)return;const o=`${l.nome}|${l.pais_nome||""}|${l.subdivisao_nome||""}`;_.has(o)||_.set(o,l)}),X(Array.from(_.values()))}catch(t){s.signal.aborted||(console.error("Erro ao buscar cidades:",t),L("Não foi possível carregar as cidades."))}finally{s.signal.aborted||P(!1)}}function z(a){f.current&&clearTimeout(f.current),f.current=setTimeout(()=>{U(a)},250)}async function y(){try{E(!0),V(null);let a=c.from("viagens").select("id, data_inicio, data_fim, status, origem, destino, responsavel_user_id").order("data_inicio",{ascending:!0});p&&(a=a.eq("status",p)),g&&(a=a.gte("data_inicio",g)),x&&(a=a.lte("data_inicio",x));const{data:s,error:t}=await a;if(t)throw t;J(s||[])}catch(a){console.error(a),V("Erro ao carregar viagens.")}finally{E(!1)}}async function ee(){if(S){if(!O||!T){v("Não foi possível determinar sua empresa.");return}if(!r.origem||!r.destino||!r.data_inicio){v("Origem, destino e data de início são obrigatórios.");return}try{A(!0),v(null);const a={company_id:O,responsavel_user_id:T,origem:r.origem.trim(),destino:r.destino.trim(),data_inicio:r.data_inicio,data_fim:r.data_fim||null,status:r.status},{error:s}=await c.from("viagens").insert(a);if(s)throw s;d({origem:"",destino:"",data_inicio:"",data_fim:"",status:"planejada"}),F(!1),y()}catch(a){console.error(a),v("Erro ao criar viagem.")}finally{A(!1)}}}const M=i.useMemo(()=>[...w].sort((a,s)=>{const t=a.data_inicio||"",n=s.data_inicio||"";return t===n?0:t?n?t<n?-1:1:-1:1}),[w]);return!Q&&!b?e.jsx("div",{children:"Você não possui acesso ao módulo de Operação/Viagens."}):e.jsx("div",{className:"card-base card-purple",children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:12},children:[S&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{style:{fontWeight:600},children:"Viagens"}),e.jsx("button",{className:"btn btn-primary",type:"button",onClick:()=>F(a=>!a),children:I?"Cancelar":"Nova viagem"})]}),I&&e.jsxs("div",{className:"card-base card-blue",style:{padding:16},children:[e.jsx("datalist",{id:"cidades-list",children:K.map(a=>e.jsx("option",{value:a.nome,label:Z(a)},`${a.nome}-${a.subdivisao_nome||""}-${a.pais_nome||""}`))}),Y&&e.jsx("small",{style:{color:"#6366f1"},children:"Buscando cidades..."}),B&&e.jsx("small",{style:{color:"red"},children:B}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Origem"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:r.origem,onChange:a=>{const s=a.target.value;d(t=>({...t,origem:s})),z(s)},placeholder:"Cidade de origem"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",list:"cidades-list",value:r.destino,onChange:a=>{const s=a.target.value;d(t=>({...t,destino:s})),z(s)},placeholder:"Cidade de destino"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:r.data_inicio,onChange:a=>d(s=>({...s,data_inicio:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:r.data_fim,onChange:a=>d(s=>({...s,data_fim:a.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:r.status,onChange:a=>d(s=>({...s,status:a.target.value})),children:[e.jsx("option",{value:"planejada",children:"Planejada"}),e.jsx("option",{value:"confirmada",children:"Confirmada"}),e.jsx("option",{value:"em_viagem",children:"Em viagem"}),e.jsx("option",{value:"concluida",children:"Concluída"}),e.jsx("option",{value:"cancelada",children:"Cancelada"})]})]}),e.jsx("div",{className:"form-group",style:{alignSelf:"flex-end"},children:e.jsx("button",{className:"btn btn-primary",type:"button",onClick:ee,disabled:k,children:k?"Salvando...":"Criar viagem"})})]}),$&&e.jsx("div",{style:{color:"red"},children:$})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsx("select",{className:"form-select",value:p,onChange:a=>W(a.target.value),children:te.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início a partir de"}),e.jsx("input",{type:"date",className:"form-input",value:g,onChange:a=>G(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Início até"}),e.jsx("input",{type:"date",className:"form-input",value:x,onChange:a=>H(a.target.value)})]}),e.jsx("div",{className:"form-group",style:{alignSelf:"flex-end"},children:e.jsx("button",{className:"btn btn-light",type:"button",onClick:y,disabled:j,children:j?"Atualizando...":"Atualizar"})})]}),D&&e.jsx("div",{style:{color:"red"},children:D}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Início"}),e.jsx("th",{children:"Fim"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Origem"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Responsável"}),e.jsx("th",{children:"Ver"})]})}),e.jsxs("tbody",{children:[j&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando viagens..."})}),!j&&M.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma viagem encontrada."})}),M.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_inicio?new Date(a.data_inicio).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.data_fim?new Date(a.data_fim).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.status||"-"}),e.jsx("td",{children:a.origem||"-"}),e.jsx("td",{children:a.destino||"-"}),e.jsx("td",{children:a.responsavel_user_id||"-"}),e.jsx("td",{children:e.jsx("a",{className:"btn btn-light",href:`/operacao/viagens/${a.id}`,children:"Abrir"})})]},a.id))]})]})})]})})}export{oe as default};
