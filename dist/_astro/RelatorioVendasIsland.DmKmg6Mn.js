import{j as e,s as f}from"./supabase.CWKfsr2i.js";import{r as s}from"./index.DVhKKaGN.js";import{u as O,w as be}from"./xlsx.DrgRuPKf.js";function R(){return new Date().toISOString().substring(0,10)}function P(i,L){const m=new Date(i);return m.setDate(m.getDate()+L),m}function b(i){return i.toISOString().substring(0,10)}function oe(i){return new Date(i.getFullYear(),i.getMonth(),1)}function ne(i){return new Date(i.getFullYear(),i.getMonth()+1,0)}function _e(i){return i.includes(";")||i.includes('"')||i.includes(`
`)?'"'+i.replace(/"/g,'""')+'"':i}function ve(){const[i,L]=s.useState([]),[m,se]=s.useState([]),[v,re]=s.useState([]),[w,T]=s.useState(""),[C,$]=s.useState(""),[D,z]=s.useState(""),[E,U]=s.useState(null),[M,A]=s.useState(null),[_,Y]=s.useState(null),[F,x]=s.useState(()=>{const o=P(new Date,-7);return b(o)}),[V,g]=s.useState(R()),[k,ie]=s.useState("todos"),[H,le]=s.useState(""),[W,de]=s.useState(""),[G,ce]=s.useState([]),[q,J]=s.useState(!1),[K,y]=s.useState(null),[h,ue]=s.useState(null),[me,Q]=s.useState(!0),[S,pe]=s.useState({pdf:!0,excel:!0});s.useEffect(()=>{async function t(){try{Q(!0),y(null);const{data:o}=await f.auth.getUser(),a=o?.user?.id;if(!a){y("Usuário não autenticado.");return}const{data:n}=await f.from("users").select("id, user_types(name), company_id").eq("id",a).maybeSingle(),r=n?.user_types?.name||o?.user?.user_metadata?.name||"",c=String(r||"").toUpperCase();let l="VENDEDOR";c.includes("ADMIN")?l="ADMIN":c.includes("GESTOR")?l="GESTOR":c.includes("VENDEDOR")?l="VENDEDOR":l="OUTRO";let p=[a];if(l==="GESTOR"){const{data:j}=await f.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a),je=j?.map(I=>I.vendedor_id).filter(I=>!!I)||[];p=Array.from(new Set([a,...je]))}else l==="ADMIN"&&(p=[]);const d=n?.company_id||null;if(d){const{data:j}=await f.from("parametros_comissao").select("exportacao_pdf, exportacao_excel").eq("company_id",d).maybeSingle();j&&pe({pdf:j.exportacao_pdf??!0,excel:j.exportacao_excel??!0})}ue({usuarioId:a,papel:l,vendedorIds:p})}catch(o){console.error(o),y("Erro ao carregar contexto do usuário.")}finally{Q(!1)}}t()},[]),s.useEffect(()=>{async function t(){try{const[{data:o,error:a},{data:n,error:r},{data:c,error:l}]=await Promise.all([f.from("clientes").select("id, nome, cpf").order("nome",{ascending:!0}),f.from("destinos").select("id, nome").order("nome",{ascending:!0}),f.from("produtos").select("id, nome, tipo").order("nome",{ascending:!0})]);if(a)throw a;if(r)throw r;if(l)throw l;L(o||[]),se(n||[]),re(c||[])}catch(o){console.error(o),y("Erro ao carregar bases de clientes, destinos e produtos. Verifique o Supabase.")}}t()},[]);const X=s.useMemo(()=>{if(!w.trim())return i;const t=w.toLowerCase();return i.filter(o=>{const a=o.cpf||"";return o.nome.toLowerCase().includes(t)||a.toLowerCase().includes(t)})},[i,w]),Z=s.useMemo(()=>{if(!C.trim())return m;const t=C.toLowerCase();return m.filter(o=>o.nome.toLowerCase().includes(t))},[m,C]),ee=s.useMemo(()=>{if(!D.trim())return v;const t=D.toLowerCase();return v.filter(o=>{const a=(o.nome||"").toLowerCase(),n=(o.tipo||"").toLowerCase();return a.includes(t)||n.includes(t)})},[v,D]),u=s.useMemo(()=>{const t=new Map(i.map(n=>[n.id,n])),o=new Map(m.map(n=>[n.id,n])),a=new Map(v.map(n=>[n.id,n]));return G.map(n=>{const r=t.get(n.cliente_id),c=o.get(n.destino_id),l=n.produto_id?a.get(n.produto_id):void 0;return{...n,cliente_nome:r?.nome||"(sem cliente)",cliente_cpf:r?.cpf||"",destino_nome:c?.nome||"(sem destino)",produto_nome:l?.nome||l?.tipo||"(sem produto)"}})},[G,i,m,v]),B=u.length,te=u.reduce((t,o)=>{const a=o.valor_total??0;return t+a},0),he=B>0?te/B:0;async function ae(){if(h)try{J(!0),y(null);let t=f.from("vendas").select("id, vendedor_id, numero_venda, cliente_id, destino_id, produto_id, data_lancamento, data_embarque, valor_total, status").order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(t=t.in("vendedor_id",h.vendedorIds)),F&&(t=t.gte("data_lancamento",F)),V&&(t=t.lte("data_lancamento",V)),k!=="todos"&&(t=t.eq("status",k)),E&&(t=t.eq("cliente_id",E.id)),M&&(t=t.eq("destino_id",M.id)),_&&(t=t.eq("produto_id",_.id));const o=parseFloat(H.replace(",","."));isNaN(o)||(t=t.gte("valor_total",o));const a=parseFloat(W.replace(",","."));isNaN(a)||(t=t.lte("valor_total",a));const{data:n,error:r}=await t;if(r)throw r;ce(n||[])}catch(t){console.error(t),y("Erro ao carregar vendas para o relatório. Confira o schema e filtros.")}finally{J(!1)}}s.useEffect(()=>{h&&ae()},[h]);function N(t){const o=new Date;if(t==="limpar"){x(""),g("");return}if(t==="hoje"){const a=R();x(a),g(a);return}if(t==="7"){const a=P(o,-7);x(b(a)),g(R());return}if(t==="30"){const a=P(o,-30);x(b(a)),g(R());return}if(t==="mes_atual"){const a=oe(o),n=ne(o);x(b(a)),g(b(n));return}if(t==="mes_anterior"){const a=new Date(o.getFullYear(),o.getMonth()-1,1),n=oe(a),r=ne(a);x(b(n)),g(b(r));return}}function fe(){if(u.length===0){alert("Não há dados para exportar.");return}const t=["numero_venda","cliente","cpf","destino","produto","data_lancamento","data_embarque","status","valor_total"],o=u.map(d=>[d.numero_venda||"",d.cliente_nome,d.cliente_cpf||"",d.destino_nome,d.produto_nome,d.data_lancamento||"",d.data_embarque||"",d.status||"",(d.valor_total??0).toString().replace(".",",")]),a=[t,...o].map(d=>d.map(j=>_e(j)).join(";")).join(`
`),n=new Blob([a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),c=new Date,l=`${c.getFullYear()}${String(c.getMonth()+1).padStart(2,"0")}${String(c.getDate()).padStart(2,"0")}-${String(c.getHours()).padStart(2,"0")}${String(c.getMinutes()).padStart(2,"0")}`,p=document.createElement("a");p.href=r,p.setAttribute("download",`relatorio-vendas-${l}.csv`),document.body.appendChild(p),p.click(),document.body.removeChild(p),URL.revokeObjectURL(r)}function xe(){if(!S.excel){alert("Exportação Excel desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=u.map(r=>({"Nº Venda":r.numero_venda||r.id,Cliente:r.cliente_nome,CPF:r.cliente_cpf,Destino:r.destino_nome,Produto:r.produto_nome,"Data lançamento":r.data_lancamento?.slice(0,10)||"","Data embarque":r.data_embarque?.slice(0,10)||"",Status:r.status||"","Valor total":r.valor_total??0})),o=O.json_to_sheet(t),a=O.book_new();O.book_append_sheet(a,o,"Vendas");const n=new Date().toISOString().replace(/[-:T]/g,"").slice(0,12);be(a,`relatorio-vendas-${n}.xlsx`)}function ge(){if(!S.pdf){alert("Exportação PDF desabilitada nos parâmetros.");return}if(u.length===0){alert("Não há dados para exportar.");return}const t=window.open("","_blank");if(!t){alert("Não foi possível abrir a janela de exportação.");return}const o=u.map(a=>`
        <tr>
          <td>${a.numero_venda||a.id}</td>
          <td>${a.cliente_nome||""}</td>
          <td>${a.destino_nome||""}</td>
          <td>${a.produto_nome||""}</td>
          <td>${a.data_lancamento?.slice(0,10)||""}</td>
          <td>${a.status||""}</td>
          <td>${(a.valor_total??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}</td>
        </tr>`).join("");t.document.write(`
      <html>
        <head>
          <title>Relatório de Vendas</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 16px; }
            table { width: 100%; border-collapse: collapse; font-size: 12px; }
            th, td { border: 1px solid #e2e8f0; padding: 6px; text-align: left; }
            th { background: #f1f5f9; }
          </style>
        </head>
        <body>
          <h3>Relatório de Vendas</h3>
          <table>
            <thead>
              <tr>
                <th>Nº Venda</th>
                <th>Cliente</th>
                <th>Destino</th>
                <th>Produto</th>
                <th>Lançamento</th>
                <th>Status</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>${o}</tbody>
          </table>
          <script>window.print();<\/script>
        </body>
      </html>
    `),t.document.close()}return e.jsxs("div",{className:"relatorio-vendas-page",children:[me&&e.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),h&&h.papel!=="ADMIN"&&e.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",h.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data início"}),e.jsx("input",{type:"date",className:"form-input",value:F,onChange:t=>x(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Data fim"}),e.jsx("input",{type:"date",className:"form-input",value:V,onChange:t=>g(t.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:k,onChange:t=>ie(t.target.value),children:[e.jsx("option",{value:"todos",children:"Todos"}),e.jsx("option",{value:"aberto",children:"Aberto"}),e.jsx("option",{value:"confirmado",children:"Confirmado"}),e.jsx("option",{value:"cancelado",children:"Cancelado"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor mínimo"}),e.jsx("input",{className:"form-input",value:H,onChange:t=>le(t.target.value),placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Valor máximo"}),e.jsx("input",{className:"form-input",value:W,onChange:t=>de(t.target.value),placeholder:"0,00"})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:8},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Cliente"}),e.jsx("input",{className:"form-input",value:w,onChange:t=>{T(t.target.value),U(null)},placeholder:"Nome ou CPF..."}),w&&!E&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[X.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum cliente encontrado."}),X.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{U(t),T(t.nome)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.cpf||"Sem CPF"})]},t.id))]}),E&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:E.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Destino"}),e.jsx("input",{className:"form-input",value:C,onChange:t=>{$(t.target.value),A(null)},placeholder:"Nome do destino..."}),C&&!M&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[Z.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum destino encontrado."}),Z.map(t=>e.jsx("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{A(t),$(t.nome)},children:e.jsx("div",{style:{fontWeight:600},children:t.nome})},t.id))]}),M&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado: ",e.jsx("strong",{children:M.nome})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Produto"}),e.jsx("input",{className:"form-input",value:D,onChange:t=>{z(t.target.value),Y(null)},placeholder:"Nome ou tipo..."}),D&&!_&&e.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto"},children:[ee.length===0&&e.jsx("div",{style:{fontSize:"0.85rem"},children:"Nenhum produto encontrado."}),ee.map(t=>e.jsxs("div",{style:{padding:"4px 6px",cursor:"pointer"},onClick:()=>{Y(t),z(t.nome||t.tipo)},children:[e.jsx("div",{style:{fontWeight:600},children:t.nome||"(sem nome)"}),e.jsx("div",{style:{fontSize:"0.8rem",opacity:.7},children:t.tipo})]},t.id))]}),_&&e.jsxs("div",{style:{fontSize:"0.8rem",marginTop:4},children:["Selecionado:"," ",e.jsx("strong",{children:_.nome||_.tipo})]})]})]}),e.jsxs("div",{style:{marginTop:12,display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("hoje"),children:"Hoje"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("7"),children:"Últimos 7 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("30"),children:"Últimos 30 dias"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_atual"),children:"Este mês"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_anterior"),children:"Mês anterior"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("limpar"),children:"Limpar datas"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:ae,children:"Aplicar filtros"}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-purple",onClick:fe,children:"Exportar CSV"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:xe,disabled:!S.excel,title:S.excel?"":"Exportação Excel desabilitada nos parâmetros",children:"Exportar Excel"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:ge,disabled:!S.pdf,title:S.pdf?"":"Exportação PDF desabilitada nos parâmetros",children:"Exportar PDF"})]})]})]}),K&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:K})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",children:[e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:[e.jsx("strong",{children:B})," venda(s) encontrada(s)"]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Faturamento:"," ",e.jsx("strong",{children:te.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),e.jsx("div",{className:"form-group",children:e.jsxs("span",{style:{fontSize:"0.9rem"},children:["Ticket médio:"," ",e.jsx("strong",{children:he.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-purple min-w-[1000px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nº Venda"}),e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Data lançamento"}),e.jsx("th",{children:"Data embarque"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Valor total"})]})}),e.jsxs("tbody",{children:[q&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Carregando vendas..."})}),!q&&u.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,children:"Nenhuma venda encontrada com os filtros atuais."})}),!q&&u.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.numero_venda||"-"}),e.jsx("td",{children:t.cliente_nome}),e.jsx("td",{children:t.cliente_cpf}),e.jsx("td",{children:t.destino_nome}),e.jsx("td",{children:t.produto_nome}),e.jsx("td",{children:t.data_lancamento?new Date(t.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.data_embarque?new Date(t.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:t.status||"-"}),e.jsx("td",{children:t.valor_total!=null?t.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"-"})]},t.id))]})]})})]})}export{ve as default};
