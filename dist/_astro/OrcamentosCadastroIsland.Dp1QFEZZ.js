import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as n}from"./supabase.Ng8nq9tn.js";import{u as U}from"./usePermissao.DiLe8-Rs.js";import{L as $}from"./LoadingUsuarioContext.BaDUNi7o.js";function K({suppressLoadingMessage:L=!1}){const{ativo:q,loading:D}=U("Vendas"),[F,O]=s.useState([]),[P,V]=s.useState([]),[_,R]=s.useState([]),[i,c]=s.useState(""),[d,m]=s.useState(""),[w,u]=s.useState(""),[f,x]=s.useState("novo"),[p,v]=s.useState(""),[S,h]=s.useState(""),[C,j]=s.useState(""),[b,E]=s.useState(!1),[y,t]=s.useState(null),[I,g]=s.useState(null),[N,l]=s.useState(!1);s.useEffect(()=>{k()},[]),s.useEffect(()=>{if(typeof window>"u")return;const a=()=>l(!0),o=()=>l(!1);return window.addEventListener("abrir-formulario-orcamento",a),window.addEventListener("fechar-formulario-orcamento",o),()=>{window.removeEventListener("abrir-formulario-orcamento",a),window.removeEventListener("fechar-formulario-orcamento",o)}},[]),s.useEffect(()=>{typeof window>"u"||window.dispatchEvent(new CustomEvent("formulario-orcamento-status",{detail:{aberto:N}}))},[N]);async function k(){try{const[a,o,r]=await Promise.all([n.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),n.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),n.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);a.data&&O(a.data),o.data&&V(o.data),r.data&&R(r.data)}catch(a){console.error(a),t("Erro ao carregar listas.")}}function A(){c(""),m(""),u(""),x("novo"),v(""),h(""),j(""),t(null),g(null)}function M(){A(),l(!1)}async function T(a){if(a.preventDefault(),t(null),g(null),!i||!d||!f){t("Cliente, destino e status são obrigatórios.");return}try{E(!0);const o={cliente_id:i,destino_id:d||null,produto_id:w||null,status:f,valor:p?parseFloat(p):null,data_viagem:S||null,notas:C||null},{error:r}=await n.from("orcamentos").insert(o);if(r)throw r;g("Orçamento criado."),window.dispatchEvent(new CustomEvent("orcamento-criado")),c(""),m(""),u(""),x("novo"),v(""),h(""),j(""),l(!1)}catch(o){console.error(o),t("Erro ao salvar orçamento.")}finally{E(!1)}}return D?L?null:e.jsx($,{className:"mb-3"}):q?N?e.jsxs("div",{className:"card-base card-blue mb-3",children:[e.jsx("h2",{className:"card-title font-semibold text-lg",children:"Novo Orçamento"}),y&&e.jsx("div",{className:"auth-error text-red-600 font-medium mb-2",children:y}),I&&e.jsx("div",{className:"auth-success text-slate-900 font-bold mb-2",children:I}),e.jsxs("form",{onSubmit:T,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Cliente *"}),e.jsxs("select",{className:"form-select",value:i,onChange:a=>c(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),F.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Destino *"}),e.jsxs("select",{className:"form-select",value:d,onChange:a=>m(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),P.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Tipo de produto"}),e.jsxs("select",{className:"form-select",value:w,onChange:a=>u(a.target.value),children:[e.jsx("option",{value:"",children:"(Opcional)"}),_.map(a=>e.jsx("option",{value:a.id,children:a.nome||a.tipo},a.id))]})]})]}),e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:f,onChange:a=>x(a.target.value),children:[e.jsx("option",{value:"novo",children:"Novo"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"negociando",children:"Negociando"}),e.jsx("option",{value:"fechado",children:"Fechado"}),e.jsx("option",{value:"perdido",children:"Perdido"})]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Valor estimado (R$)"}),e.jsx("input",{className:"form-input",type:"number",value:p,onChange:a=>v(a.target.value),min:0,step:"0.01"})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Data da viagem"}),e.jsx("input",{className:"form-input",type:"date",value:S,onChange:a=>h(a.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Notas"}),e.jsx("textarea",{className:"form-input",rows:3,value:C,onChange:a=>j(a.target.value),placeholder:"Observações, próximos passos..."})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:b,children:b?"Salvando...":"Salvar"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:M,disabled:b,children:"Cancelar"})]})]})]}):null:e.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{K as default};
