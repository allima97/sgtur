import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as l}from"./index.C0Fn7Wtz.js";import{s as N}from"./supabase.Ng8nq9tn.js";import{u as ua}from"./usePermissao.DEV7Ufch.js";const pa=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function V(j,d){const i=new Date(j);return i.setMonth(i.getMonth()+d),i}function Q(j){return j.toISOString().slice(0,10)}function F(j){const d=new Date;let i;switch(j){case"mes_anterior":{i=new Date(d.getFullYear(),d.getMonth()-1,1);break}case"trim":i=V(d,-3);break;case"sem":i=V(d,-6);break;case"ano":i=V(d,-12);break;case"mes_atual":default:i=new Date(d.getFullYear(),d.getMonth(),1);break}return{inicio:Q(i),fim:Q(d)}}function ba(){const{ativo:j,loading:d}=ua("Vendas"),i=import.meta?.env?.PUBLIC_META_PRODUTO_ENABLED!=="false",[X,Z]=l.useState(null),[C,aa]=l.useState(null),[B,ea]=l.useState(null),[U,ta]=l.useState([]),[$,oa]=l.useState({}),[T,sa]=l.useState({}),[k,ia]=l.useState({}),[z,ra]=l.useState([]),[fa,ca]=l.useState(!0),[K,W]=l.useState(!0),[Y,q]=l.useState(null),[E,na]=l.useState("mes_atual"),[H,la]=l.useState(()=>F("mes_atual"));l.useEffect(()=>{d||!j||da()},[d,j,E]),l.useEffect(()=>{la(F(E))},[E]);async function da(){try{W(!0),q(null);const{data:t}=await N.auth.getUser(),r=t?.user?.id||null;if(!r){q("Usuário não autenticado.");return}Z({id:r,nome:t?.user?.email||""});const _=F(E),{data:M}=await N.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:h}=await N.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",r).eq("periodo",_.inicio.slice(0,7)+"-01").maybeSingle(),g="id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral",y=async e=>{const w=e?`${g}, exibe_kpi_comissao`:g;return N.from("tipo_produtos").select(w)};let p=await y(!0),x=!0;p.error&&p.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(x=!1,p=await y(!1));const S=x?"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral, exibe_kpi_comissao":"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral";let v=await N.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${S}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim);v.error&&v.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(v=await N.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${g}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",_.inicio).lte("data_lancamento",_.fim),x=!1);const[L,D,A]=await Promise.all([N.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",h?.id||""),N.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta, commission_tier (faixa, de_pct, ate_pct, inc_pct_meta, inc_pct_comissao)"),N.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]),R=L.data,o=D.data,c=A.data,f=p.data,n=v.data;ca(x);const s={};(o||[]).forEach(e=>{s[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta,commission_tier:e.commission_tier||[]}});const u={};(c||[]).forEach(e=>{u[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const b={};(f||[]).forEach(e=>{b[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta,usa_meta_produto:e.usa_meta_produto,meta_produto_valor:e.meta_produto_valor,comissao_produto_meta_pct:e.comissao_produto_meta_pct,descontar_meta_geral:e.descontar_meta_geral,exibe_kpi_comissao:x?e.exibe_kpi_comissao:void 0}}),aa(M?{usar_taxas_na_meta:!!M.usar_taxas_na_meta,foco_valor:M.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),ea(h),ta(R||[]),oa(s),sa(u),ia(b),ra(n||[])}catch(t){console.error(t),q("Erro ao carregar dados de comissionamento.")}finally{W(!1)}}function ma(t,r){const _=r<100?"PRE":"POS",h=(t.commission_tier||[]).filter(v=>v.faixa===_).find(v=>r>=Number(v.de_pct)&&r<=Number(v.ate_pct)),g=_==="PRE"?t.meta_nao_atingida??t.meta_atingida??0:t.meta_atingida??t.meta_nao_atingida??0;if(!h)return _==="POS"&&r>=120?t.super_meta??g:g;const y=Number(h.inc_pct_meta||0),p=Number(h.inc_pct_comissao||0);if(y<=0)return p||g;const x=Math.max(0,Math.floor((r-Number(h.de_pct))/y));return g+x*(p/100)}const m=l.useMemo(()=>{if(!C)return null;const t={};U.forEach(o=>{t[o.produto_id]=o.valor});const r={},_={},M={};let h=0,g=0,y=0,p=0,x=0;const S={},v=[];let L=0;const D={};Object.values(k).forEach(o=>{o.regra_comissionamento==="diferenciado"&&(v.push(o.id),S[o.id]=0),o.usa_meta_produto&&(D[o.id]=0)}),z.forEach(o=>{(o.vendas_recibos||[]).forEach(c=>{const f=c.tipo_produtos?.id||c.produto_id||"",n=k[f];if(!n)return;const s=Number(c.valor_total||0),u=Number(c.valor_taxas||0),b=s-u,e=C.usar_taxas_na_meta?s:b;_[f]=(_[f]||0)+s,M[f]=(M[f]||0)+b,r[f]=(r[f]||0)+e,n.soma_na_meta&&(h+=e),g+=s,y+=u})});const A=g-y,R=B?.meta_geral&&B.meta_geral>0?h/B.meta_geral*100:0;return Object.keys(_).forEach(o=>{const c=k[o];if(!c)return;const f=C.foco_valor==="liquido"?M[o]||0:_[o]||0;if(c.regra_comissionamento==="diferenciado"){const n=T[o];if(!n)return;const s=t[o]||0,u=r[o]||0,b=s>0,e=b?u/s*100:0,w=b?u<s?0:e>=120?n.fix_super_meta??n.fix_meta_atingida??n.fix_meta_nao_atingida??0:n.fix_meta_atingida??n.fix_meta_nao_atingida??0:n.fix_meta_nao_atingida??n.fix_meta_atingida??n.fix_super_meta??0,O=f*(w/100);c.soma_na_meta&&!c.usa_meta_produto?p+=O:x+=O,S[o]=O}else{const n=T[o]?.rule_id,s=n?$[n]:void 0;let u=0;s&&(s.tipo==="ESCALONAVEL"?u=ma(s,R):R<100?u=s.meta_nao_atingida||0:R>=120?u=s.super_meta??s.meta_atingida??s.meta_nao_atingida??0:u=s.meta_atingida??s.meta_nao_atingida??0);const b=f*(u/100);if(p+=b,i&&c.usa_meta_produto&&c.meta_produto_valor&&c.comissao_produto_meta_pct&&(r[o]||0)/c.meta_produto_valor*100>=100){const G=f*((c.comissao_produto_meta_pct||0)/100),J=c.descontar_meta_geral===!1?G:Math.max(G-b,0);L+=J,D[o]=(D[o]||0)+J}}}),{baseMeta:h,totalBruto:g,totalTaxas:y,valorLiquido:A,pctMetaGeral:R,comissaoGeral:p,comissaoDif:x,comissaoMetaProd:i?L:0,totalComissao:i?p+x+L:p+x,comissaoDifDetalhe:S,comissaoMetaProdDetalhe:i?D:{},produtosDiferenciados:v}},[z,C,k,T,U,B,$,i]);if(d)return a.jsx("div",{children:"Carregando permissões..."});if(!j)return a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const P={flexDirection:"column",alignItems:"center",textAlign:"center"},I=i&&m?Object.entries(m.comissaoMetaProdDetalhe||{}).filter(([t])=>k[t]?.exibe_kpi_comissao!==!1):[],_a=m&&m.produtosDiferenciados?m.produtosDiferenciados.filter(t=>k[t]?.exibe_kpi_comissao!==!1):[];return a.jsxs("div",{className:"card-base",style:{background:"transparent",boxShadow:"none",padding:0},children:[a.jsx("div",{className:"card-base",style:{marginBottom:12},children:a.jsxs("div",{className:"form-row",style:{marginBottom:0},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:E,onChange:t=>na(t.target.value),children:pa.map(t=>a.jsx("option",{value:t.id,children:t.label},t.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:H.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:H.fim,readOnly:!0})]})]})}),Y&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:Y})}),K&&a.jsx("div",{children:"Carregando dados..."}),!K&&m&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",style:{marginBottom:12},children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,marginBottom:16},children:"Como está seu Progresso"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))",gap:12,marginBottom:4},children:[a.jsxs("div",{className:"kpi-card",style:{...P,color:"#16a34a"},children:[a.jsx("div",{className:"kpi-label",children:"Meta do mês"}),a.jsx("div",{className:"kpi-value",children:(B?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...P,color:"#ca8a04"},children:[a.jsx("div",{className:"kpi-label",children:"Total Bruto"}),a.jsx("div",{className:"kpi-value",children:m.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...P,color:"#c2410c"},children:[a.jsx("div",{className:"kpi-label",children:"Total Taxas"}),a.jsx("div",{className:"kpi-value",children:m.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...P,color:"#0ea5e9"},children:[a.jsx("div",{className:"kpi-label",children:"Valor Liquido"}),a.jsx("div",{className:"kpi-value",children:m.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...P,color:"#2563eb"},children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[m.pctMetaGeral.toFixed(1),"%"]})]})]})]}),a.jsxs("div",{className:"card-base",children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),i&&I.length>0&&a.jsx("div",{style:{textAlign:"center",color:"#0f172a",marginBottom:8,fontSize:"0.9rem"},children:"Produtos com meta específica"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[a.jsxs("div",{className:"kpi-card",style:P,children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:m.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),i&&I.map(([t,r])=>a.jsxs("div",{className:"kpi-card",style:P,children:[a.jsx("div",{className:"kpi-label",children:k[t]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:r.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),r===0&&a.jsx("small",{style:{color:"#dc2626"},children:"Meta não atingida"})]},`meta-${t}`)),_a.map(t=>a.jsxs("div",{className:"kpi-card",style:P,children:[a.jsx("div",{className:"kpi-label",children:k[t]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:(m.comissaoDifDetalhe?.[t]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),(m.comissaoDifDetalhe?.[t]||0)===0&&a.jsx("small",{style:{color:"#dc2626"},children:"Sem comissão"})]},t)),a.jsxs("div",{className:"kpi-card kpi-highlight",style:P,children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:m.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{ba as default};
