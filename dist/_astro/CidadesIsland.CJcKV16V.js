import{j as a,s as c}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as Q}from"./usePermissao.72SYthuA.js";import{r as L}from"./logs.WCvMC_es.js";import{t as X}from"./titleCase.DQLlfrnh.js";function N(g){return(g||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const Y={nome:"",subdivisao_id:"",descricao:""};function ue(){const g=Q("Cidades"),z=Q("Cadastros"),x=g.isAdmin||z.isAdmin,m=g.loading||z.loading,l=x?"admin":g.permissao!=="none"?g.permissao:z.permissao,f=x||l!=="none",k=x||l==="create"||l==="edit"||l==="delete"||l==="admin",j=x||l==="edit"||l==="delete"||l==="admin",C=x||l==="delete"||l==="admin",[q,Z]=t.useState([]),[D,ee]=t.useState([]),[$,F]=t.useState([]),[p,ae]=t.useState(""),[v,A]=t.useState(Y),[_,R]=t.useState(null),[M,u]=t.useState(null),[V,W]=t.useState(!1),[O,U]=t.useState(null),[P,T]=t.useState(!0),[B,I]=t.useState(!1),[oe,G]=t.useState(!1);async function S(e=!1){if(!f)return;async function r(){const s="id, nome, subdivisao_id, descricao, created_at",i="id, nome, subdivisao_id, descricao";if(e){const o=[];let d=0;for(;;)try{const{data:h,error:b}=await c.from("cidades").select(s).order("nome").range(d,d+1e3-1);if(b)throw b;if(o.push(...h||[]),!h||h.length<1e3)break;d+=1e3}catch(h){console.warn("[Cidades] Falha na query principal, aplicando fallback.",h);try{const{data:b,error:w}=await c.from("cidades").select(i).order("nome").range(d,d+1e3-1);if(w)throw w;if(o.push(...b||[]),!b||b.length<1e3)break;d+=1e3}catch(b){console.warn("[Cidades] Fallback sem campo descricao.",b);const{data:w,error:K}=await c.from("cidades").select("id, nome, subdivisao_id").order("nome").range(d,d+1e3-1);if(K)throw K;if(o.push(...w||[]),!w||w.length<1e3)break;d+=1e3}}return o}else try{const{data:o,error:n}=await c.from("cidades").select(s).order("created_at",{ascending:!1}).limit(10);if(n)throw n;return o||[]}catch(o){console.warn("[Cidades] created_at indisponivel, ordenando por nome.",o);try{const{data:n,error:d}=await c.from("cidades").select(i).order("nome").limit(10);if(d)throw d;return n||[]}catch(n){console.warn("[Cidades] Fallback sem descricao/nome.",n);const{data:d,error:h}=await c.from("cidades").select("id, nome, subdivisao_id").order("nome").limit(10);if(h)throw h;return d||[]}}}try{T(!0);const[{data:s,error:i},{data:o,error:n},d]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("subdivisoes").select("id, nome, pais_id, codigo_admin1, tipo").order("nome"),r()]);i?u("Erro ao carregar paises."):Z(s||[]),n?u("Erro ao carregar subdivisoes."):ee(o||[]),F(d||[]),I(e)}catch(s){console.error(s),u("Erro ao carregar cidades.")}finally{T(!1)}}t.useEffect(()=>{if(!m){if(!f){T(!1);return}S(!1)}},[m,f]),t.useEffect(()=>{!p.trim()&&!m&&f&&S(!1)},[p,m,f]),t.useEffect(()=>{const e=p.trim();if(!e||m||!f)return;const r=new AbortController;async function s(){G(!0),u(null);try{const{data:i,error:o}=await c.rpc("buscar_cidades",{q:e,limite:200},{signal:r.signal});if(r.signal.aborted)return;if(o)throw o;F((i||[]).map(d=>({id:d.id,nome:d.nome,subdivisao_id:d.subdivisao_id||"",descricao:d.descricao||null,created_at:d.created_at||null,subdivisao_nome:d.subdivisao_nome||"",pais_nome:d.pais_nome||""}))),I(!0)}catch(i){if(r.signal.aborted)return;console.warn("[Cidades] RPC falhou, tentando fallback direto.",i);try{const{data:o,error:n}=await c.from("cidades").select("id, nome, subdivisao_id, descricao, created_at").ilike("nome",`%${e}%`).order("nome");if(n)throw n;F(o||[]),I(!0)}catch(o){console.error(o);const n=o instanceof Error?o.message:"";u(`Erro ao buscar cidades.${n?` Detalhe: ${n}`:""}`)}}finally{r.signal.aborted||G(!1)}}return s(),()=>r.abort()},[p,m,f]);const y=t.useMemo(()=>{const e=new Map(D.map(s=>[s.id,s])),r=new Map(q.map(s=>[s.id,s]));return $.map(s=>{const i=s.subdivisao_id?e.get(s.subdivisao_id):void 0,o=i?r.get(i.pais_id):void 0;return{...s,subdivisao_nome:i?.nome||s.subdivisao_nome||"",pais_nome:o?.nome||s.pais_nome||""}})},[$,D,q]),H=t.useMemo(()=>{if(!p.trim())return y;const e=N(p),r=y.filter(i=>N(i.nome).includes(e)),s=y.filter(i=>!N(i.nome).includes(e)&&(N(i.subdivisao_nome||"").includes(e)||N(i.pais_nome||"").includes(e)));return[...r,...s]},[p,y]);function E(e,r){A(s=>({...s,[e]:r}))}function se(e){if(!j)return;async function r(){try{let s=e;if(!e.subdivisao_id){const{data:i,error:o}=await c.from("cidades").select("id, nome, subdivisao_id, descricao").eq("id",e.id).maybeSingle();if(o)throw o;i&&(s={...e,subdivisao_id:i.subdivisao_id||"",descricao:i.descricao||""})}R(s.id),A({nome:s.nome,subdivisao_id:s.subdivisao_id||"",descricao:s.descricao||""})}catch(s){console.error(s),u("Nao foi possivel carregar dados da cidade para edicao.")}}r()}function J(){k&&(R(null),A(Y))}async function ie(e){if(e.preventDefault(),!(!k&&!j)){if(!v.subdivisao_id){u("Subdivisao e obrigatoria.");return}try{W(!0),u(null);const s={nome:X(v.nome),subdivisao_id:v.subdivisao_id,descricao:v.descricao||null};if(_){const{error:i}=await c.from("cidades").update(s).eq("id",_);if(i)throw i;await L({user_id:null,acao:"cidade_editada",modulo:"Cadastros",detalhes:{id:_,payload:s}})}else{const{error:i}=await c.from("cidades").insert(s);if(i)throw i;await L({user_id:null,acao:"cidade_criada",modulo:"Cadastros",detalhes:s})}J(),S(B)}catch(r){console.error(r),u("Erro ao salvar cidade.")}finally{W(!1)}}}async function re(e){if(C&&confirm("Excluir cidade?"))try{U(e);const{error:r}=await c.from("cidades").delete().eq("id",e);if(r)throw r;await L({user_id:null,acao:"cidade_excluida",modulo:"Cadastros",detalhes:{id:e}}),S(B)}catch(r){console.error(r),u("Erro ao excluir cidade (provavelmente usada em produtos/destinos).")}finally{U(null)}}return!f&&!x?m?a.jsx("div",{className:"auth-info",children:"Carregando permissoes..."}):a.jsx("div",{className:"auth-error",children:"Voce nao possui permissao para visualizar Cidades."}):a.jsxs("div",{className:"cidades-page",children:[(k||j)&&a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:ie,children:[a.jsx("h3",{children:_?"Editar cidade":"Nova cidade"}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome *"}),a.jsx("input",{className:"form-input",value:v.nome,onChange:e=>E("nome",e.target.value),onBlur:e=>E("nome",X(e.target.value)),required:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Subdivisao *"}),a.jsxs("select",{className:"form-select",value:v.subdivisao_id,onChange:e=>E("subdivisao_id",e.target.value),required:!0,children:[a.jsx("option",{value:"",children:"Selecione a subdivisao"}),D.map(e=>a.jsxs("option",{value:e.id,children:[e.nome," - ",q.find(r=>r.id===e.pais_id)?.nome||"Sem pais"]},e.id))]})]})]}),a.jsxs("div",{className:"form-group",style:{marginTop:12},children:[a.jsx("label",{className:"form-label",children:"Descricao"}),a.jsx("textarea",{className:"form-input",rows:3,value:v.descricao,onChange:e=>E("descricao",e.target.value)})]}),a.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:8},children:[a.jsx("button",{className:"btn btn-primary",disabled:V,children:V?"Salvando...":_?"Salvar alteracoes":"Adicionar cidade"}),_&&a.jsx("button",{type:"button",className:"btn btn-light",onClick:J,children:"Cancelar"})]})]})}),a.jsx("div",{className:"card-base mb-3",children:a.jsx("div",{className:"form-row",style:{marginTop:12},children:a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Buscar cidade"}),a.jsx("input",{className:"form-input",placeholder:"Nome, subdivisao ou pais...",value:p,onChange:e=>ae(e.target.value)})]})})}),m&&a.jsx("div",{className:"auth-info mb-3",children:"Carregando permissoes..."}),!m&&M&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:M})}),!B&&!M&&a.jsx("div",{className:"card-base card-config mb-3",children:"Ultimas Cidades Cadastradas (10). Digite na busca para consultar todas."}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Subdivisao"}),a.jsx("th",{children:"Pais"}),a.jsx("th",{children:"Criada em"}),(j||C)&&a.jsx("th",{className:"th-actions",children:"Acoes"})]})}),a.jsxs("tbody",{children:[P&&a.jsx("tr",{children:a.jsx("td",{colSpan:5,children:"Carregando..."})}),!P&&H.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:5,children:"Nenhuma cidade encontrada."})}),!P&&H.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.subdivisao_nome||"-"}),a.jsx("td",{children:e.pais_nome||"-"}),a.jsx("td",{children:e.created_at?e.created_at.slice(0,10):"-"}),(j||C)&&a.jsxs("td",{className:"th-actions",children:[j&&a.jsx("button",{className:"btn-icon",onClick:()=>se(e),title:"Editar",children:"‚úèÔ∏è"}),C&&a.jsx("button",{className:"btn-icon btn-danger",onClick:()=>re(e.id),disabled:O===e.id,title:"Excluir",children:O===e.id?"...":"üóëÔ∏è"})]})]},e.id))]})]})})]})}export{ue as default};
