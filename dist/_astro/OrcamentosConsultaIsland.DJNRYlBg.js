import{s as l,j as a}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as ce}from"./usePermissao.72SYthuA.js";function ue(c){const x=c.getFullYear(),N=String(c.getMonth()+1).padStart(2,"0"),p=String(c.getDate()).padStart(2,"0"),g=String(c.getHours()).padStart(2,"0"),j=String(c.getMinutes()).padStart(2,"0"),r=Math.floor(Math.random()*900+100);return`VND-${x}${N}${p}-${g}${j}-${r}`}function je(){const{ativo:c}=ce("Vendas"),[x,N]=t.useState([]),[p,g]=t.useState(""),[j,r]=t.useState(null),[S,D]=t.useState(!0),[Q,q]=t.useState(null),[V,i]=t.useState(null),[d,b]=t.useState(null),[_,k]=t.useState(""),[L,$]=t.useState(""),[M,O]=t.useState(""),[R,F]=t.useState(""),[I,P]=t.useState(""),[T,z]=t.useState(""),[X,Z]=t.useState([]),[ee,ae]=t.useState([]),[te,se]=t.useState([]),W=["novo","enviado","negociando","fechado","perdido"],B={novo:{bg:"#e0f2fe",border:"#1d4ed8"},enviado:{bg:"#fef9c3",border:"#facc15"},negociando:{bg:"#fff7ed",border:"#fdba74"},fechado:{bg:"#ecfdf3",border:"#16a34a"},perdido:{bg:"#fee2e2",border:"#fca5a5"}},[me,he]=t.useState(null),[ve,pe]=t.useState(null),[y,U]=t.useState(""),[C,A]=t.useState(""),[w,H]=t.useState(""),[E,Y]=t.useState("");t.useEffect(()=>{u(),oe()},[]),t.useEffect(()=>{const e=()=>u();return window.addEventListener("orcamento-criado",e),()=>window.removeEventListener("orcamento-criado",e)},[]);async function u(){try{D(!0),r(null),i(null);let e=l.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            numero_venda,
            venda_criada,
            clientes:cliente_id (nome),
            destinos:produtos!destino_id (nome),
            produtos:tipo_produtos!produto_id (nome, tipo)
          `).order("data_orcamento",{ascending:!1});p&&(e=e.eq("status",p)),y&&(e=e.gte("data_orcamento",y)),C&&(e=e.lte("data_orcamento",C)),w&&(e=e.gte("valor",parseFloat(w))),E&&(e=e.lte("valor",parseFloat(E)));const{data:n,error:s}=await e;if(s)throw s;N(n||[])}catch(e){console.error(e),r("Erro ao carregar orçamentos.")}finally{D(!1)}}const m=t.useMemo(()=>x,[x]);t.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return m.forEach(n=>{const s=n.status||"novo";e[s]||(e[s]=[]),e[s].push(n)}),e},[m]);const G=t.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return m.forEach(n=>{const s=n.status||"novo",v=Number(n.valor||0);e[s]||(e[s]={qtd:0,valor:0}),e[s].qtd+=1,e[s].valor+=v}),e},[m]);function ne(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],n=m.map(o=>[o.id,o.clientes?.nome||"",o.destinos?.nome||"",o.produtos?.nome||"",o.status||"",o.valor??"",o.data_orcamento||"",o.data_viagem||"",o.numero_venda||""]),s=[e.join(","),...n.map(o=>o.join(","))].join(`
`),v=new Blob([s],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(v),h=document.createElement("a");h.href=f,h.download="orcamentos.csv",h.click(),URL.revokeObjectURL(f)}async function oe(){try{const[e,n,s]=await Promise.all([l.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),l.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),l.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);e.data&&Z(e.data),n.data&&ae(n.data),s.data&&se(s.data)}catch(e){console.error(e)}}async function re(e,n){try{q(e),r(null),i(null);const{error:s}=await l.from("orcamentos").update({status:n}).eq("id",e);if(s)throw s;i("Status atualizado."),await u()}catch(s){console.error(s),r("Erro ao alterar status.")}finally{q(null)}}function le(e){b(e),k(e.valor?String(e.valor):""),$(e.data_viagem||""),O(e.notas||""),F(e.cliente_id||""),P(e.destino_id||""),z(e.produto_id||""),r(null),i(null)}async function ie(e){if(e.preventDefault(),!!d)try{i(null),r(null);const{error:n}=await l.from("orcamentos").update({valor:_?parseFloat(_):null,data_viagem:L||null,notas:M||null,cliente_id:R||d.cliente_id||null,destino_id:I||d.destino_id||null,produto_id:T||d.produto_id||null}).eq("id",d.id);if(n)throw n;i("Orçamento atualizado."),b(null),await u()}catch(n){console.error(n),r("Erro ao salvar edição.")}}async function de(e){if(window.confirm("Converter este orçamento em venda?"))try{i(null),r(null);const{data:s}=await l.auth.getUser(),v=s?.user?.id;if(!v)throw new Error("Usuário não autenticado.");const f=new Date,h=ue(f),o=f.toISOString().slice(0,10),{data:J,error:K}=await l.from("vendas").insert({vendedor_id:v,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:o,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:h,notas:e.notas}).select("id, numero_venda").maybeSingle();if(K)throw K;J?.id&&e.produto_id&&await l.from("vendas_recibos").insert({venda_id:J.id,produto_id:e.produto_id,numero_recibo:h,valor_total:e.valor||0,valor_taxas:0}),await l.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${h}`}).eq("id",e.id),i("Orçamento convertido em venda."),await u()}catch(s){console.error(s),r("Erro ao converter para venda.")}}return c?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",children:[a.jsx("div",{className:"page-header",style:{marginBottom:8},children:a.jsxs("div",{children:[a.jsx("h2",{className:"card-title",children:"Orçamentos"}),a.jsx("p",{className:"page-subtitle",children:"Consulta rápida dos orçamentos cadastrados."})]})}),a.jsxs("div",{className:"grid w-full",style:{marginTop:12,gap:10,gridTemplateColumns:"repeat(5, minmax(180px, 1fr))",alignItems:"end"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:p,onChange:e=>g(e.target.value),children:[a.jsx("option",{value:"",children:"Todos"}),W.map(e=>a.jsx("option",{value:e,children:e},e))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data início"}),a.jsx("input",{className:"form-input",type:"date",value:y,onChange:e=>U(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{className:"form-input",type:"date",value:C,onChange:e=>A(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor min"}),a.jsx("input",{className:"form-input",type:"number",value:w,onChange:e=>H(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor max"}),a.jsx("input",{className:"form-input",type:"number",value:E,onChange:e=>Y(e.target.value)})]})]}),a.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:10},children:[a.jsx("button",{className:"btn btn-secondary",onClick:u,style:{minWidth:120},children:"Atualizar"}),a.jsx("button",{className:"btn btn-light",onClick:ne,style:{minWidth:140},children:"Exportar CSV"}),a.jsx("button",{className:"btn btn-light",onClick:()=>{g(""),U(""),A(""),H(""),Y(""),u()},style:{minWidth:140},children:"Limpar filtros"})]})]}),j&&a.jsx("div",{className:"auth-error",children:j}),V&&a.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:V}),a.jsxs("div",{className:"card-base card-blue",style:{marginTop:12},children:[a.jsx("h3",{className:"card-title",children:"Situação do Orçamento"}),a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:10,alignItems:"stretch"},children:W.map(e=>a.jsxs("div",{className:"kpi-card",style:{background:B[e].bg,border:`1px solid ${B[e].border}`,textAlign:"center",display:"flex",flexDirection:"column",gap:6,justifyContent:"center"},children:[a.jsxs("div",{className:"kpi-label",style:{textTransform:"capitalize",fontWeight:700},children:[e," - ",String(G[e].qtd).padStart(2,"0")," Itens"]}),a.jsx("div",{className:"kpi-value",style:{fontSize:"1.3rem",fontWeight:800},children:G[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))})]}),a.jsx("div",{className:"card-base",style:{marginTop:16},children:a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Status"}),a.jsx("th",{children:"Valor"}),a.jsx("th",{children:"Data viagem"}),a.jsx("th",{children:"Notas"}),a.jsx("th",{children:"Ações"})]})}),a.jsxs("tbody",{children:[S&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando..."})}),!S&&m.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum orçamento encontrado."})}),!S&&m.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.data_orcamento?.slice(0,10)||"—"}),a.jsx("td",{children:e.clientes?.nome||"—"}),a.jsx("td",{children:e.destinos?.nome||"—"}),a.jsx("td",{children:e.produtos?.nome||"—"}),a.jsx("td",{style:{textTransform:"capitalize"},children:a.jsxs("select",{className:"form-select",value:e.status||"",onChange:n=>re(e.id,n.target.value),disabled:Q===e.id,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"enviado",children:"Enviado"}),a.jsx("option",{value:"negociando",children:"Negociando"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})}),a.jsx("td",{children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"—"}),a.jsx("td",{children:e.data_viagem||"—"}),a.jsx("td",{children:e.notas||"—"}),a.jsxs("td",{children:[a.jsx("button",{className:"btn-icon",onClick:()=>le(e),style:{marginRight:6},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":"Editar",children:"✏️"}),a.jsx("button",{className:"btn btn-primary",onClick:()=>de(e),style:{padding:"4px 8px",fontSize:"0.85rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Orçamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"Converter"})]})]},e.id))]})]})})}),d&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Editar orçamento"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",d.clientes?.nome||"—"," | Destino: ",d.destinos?.nome||"—"]})]}),a.jsx("button",{className:"btn-ghost",onClick:()=>b(null),children:"✖"})]}),a.jsxs("form",{onSubmit:ie,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor (R$)"}),a.jsx("input",{className:"form-input",type:"number",value:_,onChange:e=>k(e.target.value),min:0,step:"0.01"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data da viagem"}),a.jsx("input",{className:"form-input",type:"date",value:L,onChange:e=>$(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:R,onChange:e=>F(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),X.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsxs("select",{className:"form-select",value:I,onChange:e=>P(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),ee.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto"}),a.jsxs("select",{className:"form-select",value:T,onChange:e=>z(e.target.value),children:[a.jsx("option",{value:"",children:"(Opcional)"}),te.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Notas"}),a.jsx("textarea",{className:"form-input",rows:3,value:M,onChange:e=>O(e.target.value)})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>b(null),children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})})]}):a.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{je as default};
