import{j as a}from"./jsx-runtime.mfZSNocD.js";import{r as s}from"./index.C0Fn7Wtz.js";import{s as i}from"./supabase.Ng8nq9tn.js";import{u as fa}from"./usePermissao.DEV7Ufch.js";function xa(x){const v=x.getFullYear(),P=String(x.getMonth()+1).padStart(2,"0"),b=String(x.getDate()).padStart(2,"0"),S=String(x.getHours()).padStart(2,"0"),_=String(x.getMinutes()).padStart(2,"0"),d=Math.floor(Math.random()*900+100);return`VND-${v}${P}${b}-${S}${_}-${d}`}function _a(){const{ativo:x}=fa("Vendas"),[v,P]=s.useState([]),[b,S]=s.useState(""),[_,d]=s.useState(null),[q,ie]=s.useState(!0),[He,le]=s.useState(null),[ce,p]=s.useState(null),[f,w]=s.useState(null),[B,de]=s.useState(""),[me,ue]=s.useState(""),[he,pe]=s.useState(""),[ge,ve]=s.useState(""),[fe,xe]=s.useState(""),[je,be]=s.useState(""),[Ke,Ye]=s.useState([]),[Ge,Je]=s.useState([]),[Qe,Xe]=s.useState([]),U=["novo","enviado","negociando","fechado","perdido"],C=7,E={novo:{bg:"#e0f2fe",border:"#1d4ed8"},enviado:{bg:"#fef9c3",border:"#facc15"},negociando:{bg:"#fff7ed",border:"#fdba74"},fechado:{bg:"#ecfdf3",border:"#16a34a"},perdido:{bg:"#fee2e2",border:"#fca5a5"}},[ye,W]=s.useState(null),[ja,H]=s.useState(null),[K,Ne]=s.useState(""),[Y,Se]=s.useState(""),[G,_e]=s.useState(""),[J,we]=s.useState(""),[l,Ce]=s.useState(null),[Ee,Q]=s.useState([]),[X,Ie]=s.useState(!1),[I,k]=s.useState(!1),[ke,g]=s.useState(null),[De,D]=s.useState("anotacao"),[Z,T]=s.useState(""),[Te,A]=s.useState(""),[Ae,L]=s.useState("email"),[ee,$]=s.useState(""),[ae,R]=s.useState(""),[te,z]=s.useState(""),[Le,re]=s.useState(!0),[$e,Re]=s.useState(null),[ze,Ze]=s.useState(!1),[se,ea]=s.useState(!1),[y,Fe]=s.useState({}),[Me,Ve]=s.useState([]),[aa,ta]=s.useState(0),ra=[{value:"anotacao",label:"Anota√ß√£o interna"},{value:"contato",label:"Contato com cliente"},{value:"envio",label:"Envio de proposta"},{value:"follow-up",label:"Follow-up"}];s.useEffect(()=>{h(),ca()},[]),s.useEffect(()=>{const e=()=>h();return window.addEventListener("orcamento-criado",e),()=>window.removeEventListener("orcamento-criado",e)},[]),s.useEffect(()=>{const e=()=>h();return window.addEventListener("orcamento-interacao-criada",e),()=>window.removeEventListener("orcamento-interacao-criada",e)},[]);async function h(){try{ie(!0),d(null),p(null);let e=i.from("orcamentos").select(`
            id,
            status,
            valor,
            data_orcamento,
            data_viagem,
            notas,
            cliente_id,
            destino_id,
            produto_id,
            numero_venda,
            venda_criada,
            clientes:cliente_id (nome),
            destinos:produtos!destino_id (nome),
            produtos:tipo_produtos!produto_id (nome, tipo)
          `).order("data_orcamento",{ascending:!1});b&&(e=e.eq("status",b)),K&&(e=e.gte("data_orcamento",K)),Y&&(e=e.lte("data_orcamento",Y)),G&&(e=e.gte("valor",parseFloat(G))),J&&(e=e.lte("valor",parseFloat(J)));const{data:t,error:r}=await e;if(r)throw r;const n=t||[];P(n);const o=n.map(u=>u.id).filter(Boolean);o.length?da(o):Fe({})}catch(e){console.error(e),d("Erro ao carregar or√ßamentos.")}finally{ie(!1)}}const F=s.useMemo(()=>{const e=["novo","enviado","negociando"];return v.filter(t=>{const r=t.status||"novo";if(!e.includes(r))return!1;const n=sa(t.data_viagem||null),o=na(t.data_orcamento||null),u=y[t.id],c=M(u?.created_at||null),V=!t.data_viagem&&o>=7,O=Number.isFinite(n)&&n<=7,va=!u?.created_at||c>=C;return O||V||va})},[v,y]),Oe=s.useMemo(()=>new Set(F.map(e=>e.id)),[F]),j=s.useMemo(()=>se?v.filter(e=>Oe.has(e.id)):v,[v,se,Oe]),ne=s.useMemo(()=>{const e={novo:[],enviado:[],negociando:[],fechado:[],perdido:[]};return j.forEach(t=>{const r=t.status||"novo";e[r]||(e[r]=[]),e[r].push(t)}),e},[j]);function sa(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,n=new Date(`${e}T00:00:00`).getTime()-t.getTime();return Math.floor(n/(1e3*60*60*24))}function na(e){if(!e)return Number.POSITIVE_INFINITY;const t=new Date,r=new Date(`${e}T00:00:00`),n=t.getTime()-r.getTime();return Math.floor(n/(1e3*60*60*24))}function N(e,t=80){if(!e)return"";const r=e.replace(/\s+/g," ").trim();return r.length<=t?r:`${r.slice(0,t-1)}‚Ä¶`}function M(e){if(!e)return Number.POSITIVE_INFINITY;const t=Date.now()-new Date(e).getTime();return Math.floor(t/(1e3*60*60*24))}function m(e,t="success"){ta(n=>n+1);const r=aa+1;Ve(n=>[...n,{id:r,message:e,type:t}]),setTimeout(()=>{Ve(n=>n.filter(o=>o.id!==r))},3500)}const Pe=s.useMemo(()=>{const e={novo:{qtd:0,valor:0},enviado:{qtd:0,valor:0},negociando:{qtd:0,valor:0},fechado:{qtd:0,valor:0},perdido:{qtd:0,valor:0}};return j.forEach(t=>{const r=t.status||"novo",n=Number(t.valor||0);e[r]||(e[r]={qtd:0,valor:0}),e[r].qtd+=1,e[r].valor+=n}),e},[j]);function oa(){const e=["id","cliente","destino","produto","status","valor","data_orcamento","data_viagem","numero_venda"],t=j.map(c=>[c.id,c.clientes?.nome||"",c.destinos?.nome||"",c.produtos?.nome||"",c.status||"",c.valor??"",c.data_orcamento||"",c.data_viagem||"",c.numero_venda||""]),r=[e.join(","),...t.map(c=>c.join(","))].join(`
`),n=new Blob([r],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),u=document.createElement("a");u.href=o,u.download="orcamentos.csv",u.click(),URL.revokeObjectURL(o)}function ia(e){W(e);const t=v.find(r=>r.id===e);t?.status&&H(t.status)}async function la(e){ye&&(await qe(ye,e),W(null),H(null))}async function ca(){try{const[e,t,r]=await Promise.all([i.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),i.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),i.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);e.data&&Ye(e.data),t.data&&Je(t.data),r.data&&Xe(r.data)}catch(e){console.error(e)}}async function da(e){try{const{data:t,error:r}=await i.from("orcamento_interacoes").select("orcamento_id, tipo, created_at, mensagem, anexo_url").in("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;const n={};(t||[]).forEach(o=>{n[o.orcamento_id]||(n[o.orcamento_id]={tipo:o.tipo,created_at:o.created_at,mensagem:o.mensagem,anexo_url:o.anexo_url})}),Fe(n)}catch(t){console.error("Erro ao carregar √∫ltimas intera√ß√µes",t)}}async function qe(e,t){try{le(e),d(null),p(null);const{error:r}=await i.from("orcamentos").update({status:t}).eq("id",e);if(r)throw r;p("Status atualizado."),m("Status atualizado.","success"),await h()}catch(r){console.error(r),d("Erro ao alterar status."),m("Erro ao alterar status.","error")}finally{le(null)}}function Be(e){w(e),de(e.valor?String(e.valor):""),ue(e.data_viagem||""),pe(e.notas||""),ve(e.cliente_id||""),xe(e.destino_id||""),be(e.produto_id||""),d(null),p(null)}async function ma(e){if(e.preventDefault(),!!f)try{p(null),d(null);const{error:t}=await i.from("orcamentos").update({valor:B?parseFloat(B):null,data_viagem:me||null,notas:he||null,cliente_id:ge||f.cliente_id||null,destino_id:fe||f.destino_id||null,produto_id:je||f.produto_id||null}).eq("id",f.id);if(t)throw t;p("Or√ßamento atualizado."),m("Or√ßamento atualizado.","success"),w(null),await h()}catch(t){console.error(t),d("Erro ao salvar edi√ß√£o."),m("Erro ao salvar edi√ß√£o.","error")}}async function ua(e){if(window.confirm("Converter este or√ßamento em venda?"))try{p(null),d(null);const{data:r}=await i.auth.getUser(),n=r?.user?.id;if(!n)throw new Error("Usu√°rio n√£o autenticado.");const o=new Date,u=xa(o),c=o.toISOString().slice(0,10),{data:V,error:O}=await i.from("vendas").insert({vendedor_id:n,cliente_id:e.cliente_id,destino_id:e.destino_id,produto_id:e.produto_id,data_lancamento:c,data_embarque:e.data_viagem||null,valor_total:e.valor||0,status:"aberto",numero_venda:u,notas:e.notas}).select("id, numero_venda").maybeSingle();if(O)throw O;V?.id&&e.produto_id&&await i.from("vendas_recibos").insert({venda_id:V.id,produto_id:e.produto_id,numero_recibo:u,valor_total:e.valor||0,valor_taxas:0}),await i.from("orcamentos").update({status:"fechado",notas:`${e.notas?`${e.notas}
`:""}Convertido para venda ${u}`}).eq("id",e.id),p("Or√ßamento convertido em venda."),m("Or√ßamento convertido em venda.","success"),await h()}catch(r){console.error(r),d("Erro ao converter para venda."),m("Erro ao converter para venda.","error")}}async function ha(e){try{Re(e.id),d(null),p(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const n=`Follow-up autom√°tico: or√ßamento ${e.id} (${e.status||"novo"}) ${e.data_viagem?`viagem em ${e.data_viagem}`:"sem data de viagem"}.`,{error:o}=await i.from("orcamento_interacoes").insert({orcamento_id:e.id,usuario_id:r,tipo:"follow-up",mensagem:n});if(o)throw o;p("Follow-up registrado."),m("Follow-up registrado.","success"),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:e.id}})),await h()}catch(t){console.error(t),d("Erro ao registrar follow-up."),m("Erro ao registrar follow-up.","error")}finally{Re(null)}}async function oe(e){try{Ie(!0),g(null);const{data:t,error:r}=await i.from("orcamento_interacoes").select(`
            id,
            tipo,
            mensagem,
            created_at,
            usuario_id,
            responsavel_id,
            anexo_url,
            users:usuario_id (email),
            responsavel:responsavel_id (email)
          `).eq("orcamento_id",e).order("created_at",{ascending:!1});if(r)throw r;Q(t||[])}catch(t){console.error(t);const r=t?.message||"Erro ao carregar intera√ß√µes.";g(`${r} Verifique se a tabela "orcamento_interacoes" existe com colunas esperadas.`)}finally{Ie(!1)}}function Ue(e){Ce(e),Q([]),T(""),D("anotacao"),A(""),L("email"),$(""),R(""),z(""),re(!0),oe(e.id)}function We(){Ce(null),Q([]),g(null),T(""),D("anotacao"),A(""),L("email"),$(""),R(""),z(""),re(!0)}async function pa(e){if(e.preventDefault(),!!l){if(!Z.trim()){g("Escreva uma mensagem para registrar no hist√≥rico.");return}try{k(!0),g(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const{error:n}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:De||"anotacao",mensagem:Z.trim(),anexo_url:Te.trim()||null});if(n)throw n;T(""),D("anotacao"),A(""),await oe(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),m("Intera√ß√£o registrada.","success")}catch(t){console.error(t);const r=t?.message||"Erro ao salvar intera√ß√£o.";g(r),m("Erro ao salvar intera√ß√£o.","error")}finally{k(!1)}}}async function ga(e){if(e.preventDefault(),!!l){if(!te.trim()&&!ae.trim()){g("Informe uma mensagem ou um link para registrar o envio/compartilhamento.");return}try{k(!0),g(null);const{data:t}=await i.auth.getUser(),r=t?.user?.id;if(!r)throw new Error("Usu√°rio n√£o autenticado.");const n=te.trim()||`Enviado via ${Ae}${ee?` para ${ee}`:""}.`,{error:o}=await i.from("orcamento_interacoes").insert({orcamento_id:l.id,usuario_id:r,tipo:"envio",mensagem:n,anexo_url:ae.trim()||null});if(o)throw o;Le&&l.status!=="fechado"&&l.status!=="perdido"&&(await i.from("orcamentos").update({status:"enviado"}).eq("id",l.id),await h()),z(""),R(""),$(""),L("email"),await oe(l.id),window.dispatchEvent(new CustomEvent("orcamento-interacao-criada",{detail:{orcamentoId:l.id}})),m("Envio registrado.","success"),await h()}catch(t){console.error(t);const r=t?.message||"Erro ao registrar envio/compartilhamento.";g(r),m("Erro ao registrar envio/compartilhamento.","error")}finally{k(!1)}}}return x?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",children:[a.jsx("div",{className:"page-header mb-2",children:a.jsxs("div",{children:[a.jsx("h2",{className:"card-title font-semibold text-lg",children:"Or√ßamentos"}),a.jsx("p",{className:"page-subtitle text-slate-500",children:"Consulta r√°pida dos or√ßamentos cadastrados."})]})}),a.jsxs("div",{className:"grid w-full mt-3 gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(5, minmax(180px, 1fr))",alignItems:"end"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Status"}),a.jsxs("select",{className:"form-select",value:b,onChange:e=>S(e.target.value),children:[a.jsx("option",{value:"",children:"Todos"}),U.map(e=>a.jsx("option",{value:e,children:e},e))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data in√≠cio"}),a.jsx("input",{className:"form-input",type:"date",value:K,onChange:e=>Ne(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data fim"}),a.jsx("input",{className:"form-input",type:"date",value:Y,onChange:e=>Se(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor min"}),a.jsx("input",{className:"form-input",type:"number",value:G,onChange:e=>_e(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor max"}),a.jsx("input",{className:"form-input",type:"number",value:J,onChange:e=>we(e.target.value)})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[a.jsx("button",{className:"btn btn-secondary min-w-[120px]",onClick:h,children:"Atualizar"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:oa,children:"Exportar CSV"}),a.jsx("button",{className:"btn btn-light min-w-[140px]",onClick:()=>{S(""),Ne(""),Se(""),_e(""),we(""),h()},children:"Limpar filtros"}),a.jsx("button",{className:"btn btn-light min-w-[160px]",onClick:()=>Ze(e=>!e),children:ze?"Ocultar Kanban":"Mostrar Kanban"}),a.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[a.jsx("input",{type:"checkbox",checked:se,onChange:e=>ea(e.target.checked)}),"S√≥ pendentes de follow-up"]})]})]}),_&&a.jsx("div",{className:"auth-error",children:_}),ce&&a.jsx("div",{className:"auth-success",style:{color:"#0f172a",fontWeight:700},children:ce}),a.jsxs("div",{className:"card-base card-blue mt-3",children:[a.jsx("h3",{className:"card-title font-semibold",children:"Situa√ß√£o do Or√ßamento"}),a.jsx("div",{className:"grid gap-2 md:gap-3",style:{gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",alignItems:"stretch"},children:U.map(e=>a.jsxs("div",{className:"kpi-card flex flex-col gap-1 items-center justify-center text-center",style:{background:E[e].bg,border:`1px solid ${E[e].border}`},children:[a.jsxs("div",{className:"kpi-label capitalize font-bold",children:[e," - ",String(Pe[e].qtd).padStart(2,"0")," Itens"]}),a.jsx("div",{className:"kpi-value text-xl font-extrabold",children:Pe[e].valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},`kpi-${e}`))})]}),F.length>0&&a.jsxs("div",{className:"card-base card-yellow",style:{marginTop:12},children:[a.jsx("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Pendentes de follow-up"}),a.jsx("p",{className:"page-subtitle",children:"Viagem pr√≥xima (‚â§ 7 dias) ou or√ßamento sem data h√° 7+ dias. Clique para registrar follow-up."})]})}),a.jsx("div",{style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))"},children:F.map(e=>{const t=y[e.id],r=M(t?.created_at||null),n=!t?.created_at||r>=C;return a.jsxs("div",{className:"card-base",style:{border:"1px solid #facc15",background:"#fffbeb"},children:[a.jsx("div",{style:{fontWeight:700},children:e.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Status: ",(e.status||"novo").toUpperCase()," | Viagem: ",e.data_viagem||"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),n&&a.jsxs("div",{style:{marginTop:4,color:"#b45309",fontSize:"0.85rem",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]}),a.jsx("button",{className:"btn btn-primary",style:{marginTop:8,width:"100%"},onClick:()=>ha(e),disabled:$e===e.id,children:$e===e.id?"Registrando...":"Registrar follow-up"}),t?.tipo&&a.jsxs("div",{style:{marginTop:8,fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",t?.tipo," ",t?.created_at?new Date(t?.created_at||"").toLocaleDateString("pt-BR"):"",N(t?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:N(t?.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]})]},`pend-${e.id}`)})})]}),a.jsx("div",{className:"card-base",style:{marginTop:16},children:a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1100px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Data"}),a.jsx("th",{children:"Cliente"}),a.jsx("th",{children:"Destino"}),a.jsx("th",{children:"Produto"}),a.jsx("th",{style:{textAlign:"center"},children:"Status"}),a.jsx("th",{style:{textAlign:"center"},children:"Valor"}),a.jsx("th",{style:{textAlign:"center"},children:"Data viagem"}),a.jsx("th",{style:{textAlign:"center"},children:"√öltima intera√ß√£o"}),a.jsx("th",{style:{textAlign:"center"},children:"A√ß√µes"})]})}),a.jsxs("tbody",{children:[q&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando..."})}),!q&&j.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum or√ßamento encontrado."})}),!q&&j.map(e=>{const t=y[e.id],r=M(t?.created_at||null),n=!t?.created_at||r>=C;return a.jsxs("tr",{children:[a.jsx("td",{children:e.data_orcamento?.slice(0,10)||"‚Äî"}),a.jsx("td",{children:e.clientes?.nome||"‚Äî"}),a.jsx("td",{children:e.destinos?.nome||"‚Äî"}),a.jsx("td",{children:e.produtos?.nome||"‚Äî"}),a.jsx("td",{style:{textTransform:"capitalize",textAlign:"center"},children:a.jsxs("select",{className:"form-select",value:e.status||"",onChange:o=>qe(e.id,o.target.value),disabled:He===e.id,children:[a.jsx("option",{value:"novo",children:"Novo"}),a.jsx("option",{value:"enviado",children:"Enviado"}),a.jsx("option",{value:"negociando",children:"Negociando"}),a.jsx("option",{value:"fechado",children:"Fechado"}),a.jsx("option",{value:"perdido",children:"Perdido"})]})}),a.jsx("td",{style:{textAlign:"center"},children:e.valor?e.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"}),a.jsx("td",{style:{textAlign:"center"},children:e.data_viagem||"‚Äî"}),a.jsxs("td",{style:{textAlign:"center",fontSize:"0.85rem",color:"#475569"},children:[t?.tipo||"‚Äî",t?.created_at?` ‚Ä¢ ${new Date(t.created_at).toLocaleDateString("pt-BR")}`:"",t?.mensagem&&a.jsx("div",{style:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:N(t.mensagem)}),t?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:t.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})}),n&&a.jsxs("div",{style:{color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(r)?`${r}d`:"‚Äî"]})]}),a.jsxs("td",{style:{textAlign:"center"},children:[a.jsx("button",{className:"btn-icon",onClick:()=>Be(e),style:{marginRight:6},disabled:e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":"Editar",children:"‚úèÔ∏è"}),a.jsx("button",{className:"btn btn-primary","aria-label":"Converter em venda",onClick:()=>ua(e),style:{padding:"4px 8px",fontSize:"0.95rem",marginLeft:6},disabled:!e.cliente_id||!e.destino_id||e.status==="fechado"||e.status==="perdido",title:e.status==="fechado"||e.status==="perdido"?"Or√ßamento encerrado":!e.cliente_id||!e.destino_id?"Selecione cliente e destino para converter":"Converter em venda",children:"$"}),a.jsx("button",{className:"btn-icon","aria-label":"Hist√≥rico de intera√ß√µes",onClick:()=>Ue(e),style:{marginLeft:6},title:"Ver hist√≥rico / registrar intera√ß√£o",children:"üïí"})]})]},e.id)})]})]})})}),ze&&a.jsxs("div",{className:"card-base",style:{marginTop:16},children:[a.jsx("div",{className:"page-header",style:{marginBottom:8},children:a.jsxs("div",{children:[a.jsx("h3",{className:"card-title",children:"Kanban de Or√ßamentos"}),a.jsx("p",{className:"page-subtitle",children:"Arraste os cards entre colunas para alterar o status."})]})}),a.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",gap:12,alignItems:"flex-start"},children:U.map(e=>a.jsxs("div",{onDragOver:t=>t.preventDefault(),onDrop:()=>la(e),style:{border:`2px dashed ${E[e].border}`,background:E[e].bg,minHeight:120,padding:8,borderRadius:10},children:[a.jsxs("div",{style:{fontWeight:800,textTransform:"capitalize",marginBottom:6},children:[e," (",ne[e]?.length||0,")"]}),a.jsxs("div",{style:{display:"grid",gap:8},children:[(ne[e]||[]).map(t=>{const r=y[t.id],n=M(r?.created_at||null),o=!r?.created_at||n>=C;return a.jsxs("div",{draggable:!0,onDragStart:()=>ia(t.id),onDragEnd:()=>{W(null),H(null)},className:"card-base",style:{padding:10,cursor:"grab",border:"1px solid #e2e8f0",background:"#fff"},children:[a.jsx("div",{style:{fontWeight:700},children:t.clientes?.nome||"Cliente n√£o informado"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Valor:"," ",t.valor?t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"}):"‚Äî"]}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Viagem: ",t.data_viagem||"‚Äî"]}),o&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#b45309",fontWeight:700},children:["Sem intera√ß√£o h√° ",Number.isFinite(n)?`${n}d`:"‚Äî"]}),r?.tipo&&a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["√öltima: ",r?.tipo," ",r?.created_at?new Date(r?.created_at||"").toLocaleDateString("pt-BR"):"",N(r?.mensagem)&&a.jsx("div",{style:{color:"#0f172a"},children:N(r?.mensagem)}),r?.anexo_url&&a.jsx("div",{children:a.jsx("a",{href:r?.anexo_url||"",target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo"})})]}),a.jsxs("div",{style:{display:"flex",gap:6,marginTop:6,flexWrap:"wrap"},children:[a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Be(t),children:"Editar"}),a.jsx("button",{className:"btn btn-light",style:{padding:"4px 8px"},onClick:()=>Ue(t),children:"Hist√≥rico"})]})]},`kan-card-${t.id}`)}),(ne[e]||[]).length===0&&a.jsx("div",{style:{fontSize:"0.9rem",color:"#475569"},children:"Sem itens."})]})]},`kanban-${e}`))})]}),f&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:500},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Editar or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Cliente: ",f.clientes?.nome||"‚Äî"," | Destino: ",f.destinos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:()=>w(null),children:"‚úñ"})]}),a.jsxs("form",{onSubmit:ma,children:[a.jsxs("div",{className:"modal-body",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Valor (R$)"}),a.jsx("input",{className:"form-input",type:"number",value:B,onChange:e=>de(e.target.value),min:0,step:"0.01"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Data da viagem"}),a.jsx("input",{className:"form-input",type:"date",value:me,onChange:e=>ue(e.target.value)})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Cliente"}),a.jsxs("select",{className:"form-select",value:ge,onChange:e=>ve(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),Ke.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destino"}),a.jsxs("select",{className:"form-select",value:fe,onChange:e=>xe(e.target.value),children:[a.jsx("option",{value:"",children:"Selecione"}),Ge.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Produto"}),a.jsxs("select",{className:"form-select",value:je,onChange:e=>be(e.target.value),children:[a.jsx("option",{value:"",children:"(Opcional)"}),Qe.map(e=>a.jsx("option",{value:e.id,children:e.nome},e.id))]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Notas"}),a.jsx("textarea",{className:"form-input",rows:3,value:he,onChange:e=>pe(e.target.value)})]})]}),a.jsxs("div",{className:"modal-footer",children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>w(null),children:"Cancelar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",children:"Salvar"})]})]})]})}),l&&a.jsx("div",{className:"modal-backdrop",children:a.jsxs("div",{className:"modal-panel",style:{maxWidth:640,width:"90vw"},children:[a.jsxs("div",{className:"modal-header",children:[a.jsxs("div",{children:[a.jsx("div",{className:"modal-title",children:"Hist√≥rico do or√ßamento"}),a.jsxs("div",{style:{fontSize:"0.9rem",color:"#475569"},children:["Cliente: ",l.clientes?.nome||"‚Äî"," | Destino: ",l.destinos?.nome||"‚Äî"," | Produto: ",l.produtos?.nome||"‚Äî"]})]}),a.jsx("button",{className:"btn-ghost",onClick:We,children:"‚úñ"})]}),a.jsxs("div",{className:"modal-body",style:{display:"grid",gap:12},children:[a.jsxs("form",{onSubmit:ga,className:"card-base",style:{background:"#eef2ff"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Registrar envio / compartilhamento"}),a.jsxs("div",{className:"grid",style:{display:"grid",gap:10,gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Canal"}),a.jsxs("select",{className:"form-select",value:Ae,onChange:e=>L(e.target.value),children:[a.jsx("option",{value:"email",children:"E-mail"}),a.jsx("option",{value:"whatsapp",children:"WhatsApp"}),a.jsx("option",{value:"link",children:"Link"}),a.jsx("option",{value:"outro",children:"Outro"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Destinat√°rio"}),a.jsx("input",{className:"form-input",type:"text",value:ee,onChange:e=>$(e.target.value),placeholder:"E-mail, telefone, nome..."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link"}),a.jsx("input",{className:"form-input",type:"url",value:ae,onChange:e=>R(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:te,onChange:e=>z(e.target.value),placeholder:"Ex.: Proposta enviada por e-mail. Link do PDF..."})]}),a.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8,fontSize:"0.9rem"},children:[a.jsx("input",{type:"checkbox",checked:Le,onChange:e=>re(e.target.checked)}),'Marcar or√ßamento como "enviado"']}),a.jsx("div",{style:{display:"flex",gap:8,justifyContent:"flex-end",marginTop:8},children:a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:I,children:I?"Salvando...":"Registrar envio"})})]}),a.jsxs("form",{onSubmit:pa,className:"card-base",style:{background:"#f8fafc"},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo"}),a.jsx("select",{className:"form-select",value:De,onChange:e=>D(e.target.value),children:ra.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Mensagem"}),a.jsx("textarea",{className:"form-input",rows:3,value:Z,onChange:e=>T(e.target.value),placeholder:"Ex.: Enviada proposta por e-mail. Aguardando retorno."})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Link / Anexo (opcional)"}),a.jsx("input",{className:"form-input",type:"url",value:Te,onChange:e=>A(e.target.value),placeholder:"https://... (PDF, drive, WhatsApp, etc.)"})]}),ke&&a.jsx("div",{className:"auth-error",children:ke}),a.jsxs("div",{style:{display:"flex",gap:8,justifyContent:"flex-end"},children:[a.jsx("button",{type:"button",className:"btn btn-light",onClick:We,children:"Fechar"}),a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:I,children:I?"Salvando...":"Registrar"})]})]}),a.jsxs("div",{className:"card-base",style:{maxHeight:"50vh",overflowY:"auto"},children:[a.jsx("div",{className:"modal-title",style:{fontSize:"1rem",marginBottom:8},children:"Intera√ß√µes"}),X&&a.jsx("div",{children:"Carregando intera√ß√µes..."}),!X&&Ee.length===0&&a.jsx("div",{children:"Nenhuma intera√ß√£o registrada ainda."}),!X&&Ee.map(e=>a.jsxs("div",{style:{padding:"10px 0",borderBottom:"1px solid #e2e8f0",display:"grid",gap:4},children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8},children:[a.jsx("span",{style:{background:"#e2e8f0",color:"#0f172a",padding:"2px 8px",borderRadius:12,fontSize:"0.85rem",textTransform:"capitalize",whiteSpace:"nowrap"},children:e.tipo||"anotacao"}),a.jsx("span",{style:{fontSize:"0.85rem",color:"#475569",textAlign:"right"},children:e.created_at?new Date(e.created_at).toLocaleString("pt-BR"):"‚Äî"})]}),a.jsx("div",{style:{whiteSpace:"pre-wrap",color:"#0f172a"},children:e.mensagem}),a.jsxs("div",{style:{fontSize:"0.85rem",color:"#475569"},children:["Por: ",e.users?.email||e.usuario_id||"‚Äî"]}),e.anexo_url&&a.jsx("div",{style:{fontSize:"0.9rem"},children:a.jsx("a",{href:e.anexo_url,target:"_blank",rel:"noreferrer",style:{color:"#1d4ed8"},children:"Abrir anexo/compartilhamento"})})]},e.id))]})]})]})}),Me.length>0&&a.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:Me.map(e=>a.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):a.jsx("div",{children:"Acesso ao m√≥dulo de Vendas bloqueado."})}export{_a as default};
