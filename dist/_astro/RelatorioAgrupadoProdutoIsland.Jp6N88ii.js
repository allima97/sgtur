import{j as t,s as S}from"./supabase.DNkd6bxA.js";import{r as c}from"./index.C0Fn7Wtz.js";function M(){return new Date().toISOString().substring(0,10)}function R(s,_){const p=new Date(s);return p.setDate(p.getDate()+_),p}function x(s){return s.toISOString().substring(0,10)}function T(s){return new Date(s.getFullYear(),s.getMonth(),1)}function $(s){return new Date(s.getFullYear(),s.getMonth()+1,0)}function z(s){return s.includes(";")||s.includes('"')||s.includes(`
`)?'"'+s.replace(/"/g,'""')+'"':s}function X(){const[s,_]=c.useState([]),[p,b]=c.useState(()=>{const a=R(new Date,-30);return x(a)}),[D,v]=c.useState(M()),[w,G]=c.useState("todos"),[O,P]=c.useState([]),[k,q]=c.useState(!1),[L,j]=c.useState(null),[m,V]=c.useState(null),[Y,I]=c.useState(!0),[h,Q]=c.useState("total"),[y,A]=c.useState(!0);c.useEffect(()=>{async function e(){try{const{data:a,error:r}=await S.from("tipo_produtos").select("id, nome, tipo").order("nome",{ascending:!0});if(r)throw r;_(a||[])}catch(a){console.error(a),j("Erro ao carregar produtos.")}}e()},[]),c.useEffect(()=>{async function e(){try{I(!0),j(null);const{data:a}=await S.auth.getUser(),r=a?.user?.id;if(!r){j("Usuário não autenticado.");return}const{data:l}=await S.from("users").select("id, user_types(name)").eq("id",r).maybeSingle(),o=l?.user_types?.name||a?.user?.user_metadata?.name||"",i=String(o||"").toUpperCase();let n="VENDEDOR";i.includes("ADMIN")?n="ADMIN":i.includes("GESTOR")?n="GESTOR":i.includes("VENDEDOR")?n="VENDEDOR":n="OUTRO";let d=[r];if(n==="GESTOR"){const{data:u}=await S.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",r),g=u?.map(C=>C.vendedor_id).filter(C=>!!C)||[];d=Array.from(new Set([r,...g]))}else n==="ADMIN"&&(d=[]);V({usuarioId:r,papel:n,vendedorIds:d})}catch(a){console.error(a),j("Erro ao carregar contexto do usuário.")}finally{I(!1)}}e()},[]);const f=c.useMemo(()=>{const e=new Map(s.map(o=>[o.id,o])),a=new Map,r=(o,i)=>{const n=o||"sem-produto",d=o?e.get(o):void 0,u=d?.nome||d?.tipo||"(sem produto)",g=a.get(n)||{produto_id:o,produto_nome:u,quantidade:0,total:0,ticketMedio:0};g.quantidade+=1,g.total+=i,a.set(n,g)};O.forEach(o=>{const i=o.vendas_recibos||[];if(i.length)i.forEach(n=>{const d=Number(n.valor_total||0)+Number(n.valor_taxas||0);r(n.produto_id,d)});else{const n=o.valor_total??0;r(o.produto_id,n)}});const l=Array.from(a.values()).map(o=>({...o,ticketMedio:o.quantidade>0?o.total/o.quantidade:0}));return l.sort((o,i)=>{let n=0;return h==="total"?n=o.total-i.total:h==="quantidade"?n=o.quantidade-i.quantidade:n=o.ticketMedio-i.ticketMedio,y?-n:n}),l},[O,s,h,y]),F=f.reduce((e,a)=>e+a.total,0),U=f.reduce((e,a)=>e+a.quantidade,0),H=U>0?F/U:0;function N(e){const a=new Date;if(e==="7"){const r=R(a,-7);b(x(r)),v(M());return}if(e==="30"){const r=R(a,-30);b(x(r)),v(M());return}if(e==="mes_atual"){const r=T(a),l=$(a);b(x(r)),v(x(l));return}if(e==="mes_anterior"){const r=new Date(a.getFullYear(),a.getMonth()-1,1),l=T(r),o=$(r);b(x(l)),v(x(o));return}}async function B(){if(m)try{q(!0),j(null);let e=S.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          produto_id,
          data_lancamento,
          data_embarque,
          valor_total,
          status,
          vendas_recibos (produto_id, valor_total, valor_taxas)
        `).order("data_lancamento",{ascending:!1});m.papel!=="ADMIN"&&(e=e.in("vendedor_id",m.vendedorIds)),p&&(e=e.gte("data_lancamento",p)),D&&(e=e.lte("data_lancamento",D)),w!=="todos"&&(e=e.eq("status",w));const{data:a,error:r}=await e;if(r)throw r;P(a||[])}catch(e){console.error(e),j("Erro ao carregar vendas para relatório por produto.")}finally{q(!1)}}function E(e){e===h?A(a=>!a):(Q(e),A(!0))}c.useEffect(()=>{m&&B()},[m]);function W(){if(f.length===0){alert("Não há dados para exportar.");return}const e=["produto","quantidade","total","ticket_medio"],a=f.map(u=>[u.produto_nome,u.quantidade.toString(),u.total.toFixed(2).replace(".",","),u.ticketMedio.toFixed(2).replace(".",",")]),r=[e,...a].map(u=>u.map(g=>z(g)).join(";")).join(`
`),l=new Blob([r],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(l),i=new Date,n=`${i.getFullYear()}${String(i.getMonth()+1).padStart(2,"0")}${String(i.getDate()).padStart(2,"0")}-${String(i.getHours()).padStart(2,"0")}${String(i.getMinutes()).padStart(2,"0")}`,d=document.createElement("a");d.href=o,d.setAttribute("download",`relatorio-vendas-por-produto-${n}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(o)}return t.jsxs("div",{className:"relatorio-vendas-produto-page",children:[t.jsxs("div",{className:"card-base card-purple mb-3",children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data início"}),t.jsx("input",{type:"date",className:"form-input",value:p,onChange:e=>b(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data fim"}),t.jsx("input",{type:"date",className:"form-input",value:D,onChange:e=>v(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Status"}),t.jsxs("select",{className:"form-select",value:w,onChange:e=>G(e.target.value),children:[t.jsx("option",{value:"todos",children:"Todos"}),t.jsx("option",{value:"aberto",children:"Aberto"}),t.jsx("option",{value:"confirmado",children:"Confirmado"}),t.jsx("option",{value:"cancelado",children:"Cancelado"})]})]})]}),t.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("7"),children:"Últimos 7 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("30"),children:"Últimos 30 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_atual"),children:"Este mês"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>N("mes_anterior"),children:"Mês anterior"}),t.jsx("button",{type:"button",className:"btn btn-primary",onClick:B,children:"Aplicar filtros"}),t.jsx("button",{type:"button",className:"btn btn-purple",onClick:W,children:"Exportar CSV"})]})]}),Y&&t.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),m&&m.papel!=="ADMIN"&&t.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",m.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),L&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:L})}),t.jsx("div",{className:"card-base mb-3",children:t.jsxs("div",{className:"form-row",children:[t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Produtos: ",t.jsx("strong",{children:f.length})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Faturamento total:"," ",t.jsx("strong",{children:F.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Ticket médio geral:"," ",t.jsx("strong",{children:H.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),t.jsx("div",{className:"table-container overflow-x-auto",children:t.jsxs("table",{className:"table-default table-header-purple min-w-[620px]",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Produto"}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("quantidade"),children:["Qtde ",h==="quantidade"?y?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("total"),children:["Faturamento ",h==="total"?y?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>E("ticket"),children:["Ticket médio ",h==="ticket"?y?"↓":"↑":""]})]})}),t.jsxs("tbody",{children:[k&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Carregando..."})}),!k&&f.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Nenhum produto encontrado com os filtros atuais."})}),!k&&f.map((e,a)=>t.jsxs("tr",{children:[t.jsx("td",{children:e.produto_nome}),t.jsx("td",{children:e.quantidade}),t.jsx("td",{children:e.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),t.jsx("td",{children:e.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},e.produto_id??`sem-${a}`))]})]})})]})}export{X as default};
