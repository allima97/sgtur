import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r as n}from"./index.C0Fn7Wtz.js";import{u as fe}from"./usePermissao.72SYthuA.js";import{r as E}from"./logs.WCvMC_es.js";import{t as ee}from"./titleCase.DQLlfrnh.js";const V={nome:"",nascimento:"",cpf:"",telefone:"",whatsapp:"",email:"",endereco:"",complemento:"",cidade:"",estado:"",cep:"",rg:"",genero:"",nacionalidade:"",tags:"",tipo_cliente:"passageiro",notas:"",active:!0};function we(){const{permissao:i,ativo:ae,loading:q}=fe("Clientes"),w=i!=="none",C=i==="create"||i==="edit"||i==="delete"||i==="admin",j=i==="edit"||i==="delete"||i==="admin",f=i==="delete"||i==="admin",[S,te]=n.useState([]),[b,se]=n.useState(""),[k,d]=n.useState(null),[L,F]=n.useState(!0),[t,g]=n.useState(V),[p,B]=n.useState(null),[H,T]=n.useState(!1),[W,I]=n.useState(null),[O,P]=n.useState(null),[A,z]=n.useState([]),[M,G]=n.useState([]),[J,K]=n.useState(!1),[m,N]=n.useState(null),[Q,_]=n.useState([]),[ne,U]=n.useState(!1),[h,y]=n.useState(null);async function R(){if(w)try{F(!0),d(null);const{data:a,error:s}=await c.from("clientes").select("*").order("nome",{ascending:!0});if(s)throw s;te(a||[])}catch(a){console.error(a),d("Erro ao carregar clientes.")}finally{F(!1)}}n.useEffect(()=>{!q&&w&&R()},[q,w]);const X=n.useMemo(()=>{if(!b.trim())return S;const a=b.toLowerCase();return S.filter(s=>s.nome.toLowerCase().includes(a)||(s.cpf||"").includes(a)||(s.email||"").toLowerCase().includes(a))},[S,b]);function u(a,s){g(r=>({...r,[a]:s}))}function le(){C&&(B(null),g(V))}async function re(a){P(a),K(!0);try{const{data:s}=await c.from("historico_viagens_real").select("id, data_viagem, valor_total, notas, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_viagem",{ascending:!1}),r=s?.map(l=>({id:l.id,data_viagem:l.data_viagem,destino_nome:l.destinos?.nome||"",valor_total:l.valor_total??null,notas:l.notas||null}))||[],{data:o}=await c.from("vendas").select("id, data_lancamento, data_embarque, destino_id, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_lancamento",{ascending:!1});let Z=[];if(o&&o.length>0){const l=o.map(x=>x.id),{data:je}=await c.from("vendas_recibos").select("venda_id, valor_total, valor_taxas").in("venda_id",l);Z=o.map(x=>{const $=(je||[]).filter(v=>v.venda_id===x.id),pe=$.reduce((v,D)=>v+(D.valor_total||0),0),ve=$.reduce((v,D)=>v+(D.valor_taxas||0),0);return{id:x.id,data_lancamento:x.data_lancamento,data_embarque:x.data_embarque,destino_nome:x.destinos?.nome||"",valor_total:pe,valor_taxas:ve}})}const{data:ue}=await c.from("orcamentos").select("id, data_orcamento, status, valor, numero_venda, destinos:produtos!destino_id (nome)").eq("cliente_id",a.id).order("data_orcamento",{ascending:!1}),xe=ue?.map(l=>({id:l.id,data_orcamento:l.data_orcamento,status:l.status,valor:l.valor??null,numero_venda:l.numero_venda??null,destino_nome:l.destinos?.nome||null}))||[];z(Z),G(xe)}catch(s){console.error(s),d("Erro ao carregar histÃ³rico do cliente.")}finally{K(!1)}}function Y(){P(null),z([]),G([]),N(null),_([]),y(null)}async function oe(a){N(a),U(!0);try{const{data:s}=await c.from("vendas_recibos").select("numero_recibo, valor_total, valor_taxas, produtos(nome)").eq("venda_id",a.id);_((s||[]).map(r=>({numero_recibo:r.numero_recibo,valor_total:r.valor_total,valor_taxas:r.valor_taxas,produto_nome:r.produtos?.nome||null})))}catch(s){console.error(s),d("Erro ao carregar recibos da venda.")}finally{U(!1)}}function ie(a){y(a)}function ce(a){j&&(B(a.id),g({nome:a.nome,nascimento:a.nascimento||"",cpf:a.cpf,telefone:a.telefone,whatsapp:a.whatsapp||"",email:a.email||"",endereco:a.endereco||"",complemento:a.complemento||"",cidade:a.cidade||"",estado:a.estado||"",cep:a.cep||"",rg:a.rg||"",genero:a.genero||"",nacionalidade:a.nacionalidade||"",tags:(a.tags||[]).join(", "),tipo_cliente:a.tipo_cliente||"passageiro",notas:a.notas||"",active:a.active}))}async function de(a){if(a.preventDefault(),!(!C&&!j))try{T(!0),d(null);const r={nome:ee(t.nome),nascimento:t.nascimento||null,cpf:t.cpf.trim(),telefone:t.telefone.trim(),whatsapp:t.whatsapp.trim()||null,email:t.email.trim()||null,endereco:t.endereco.trim()||null,complemento:t.complemento.trim()||null,cidade:t.cidade.trim()||null,estado:t.estado.trim()||null,cep:t.cep.trim()||null,rg:t.rg.trim()||null,genero:t.genero.trim()||null,nacionalidade:t.nacionalidade.trim()||null,tags:t.tags?t.tags.split(",").map(o=>o.trim()):[],tipo_cliente:t.tipo_cliente,notas:t.notas||null,active:t.active};if(p){const{error:o}=await c.from("clientes").update(r).eq("id",p);if(o)throw o;await E({acao:"cliente_editado",modulo:"Clientes",detalhes:{id:p,payload:r}})}else{const{error:o}=await c.from("clientes").insert(r);if(o)throw o;await E({acao:"cliente_criado",modulo:"Clientes",detalhes:r})}g(V),B(null),await R()}catch(s){console.error(s),d("Erro ao salvar cliente.")}finally{T(!1)}}async function me(a){if(f&&window.confirm("Excluir cliente?"))try{I(a);const{error:s}=await c.from("clientes").delete().eq("id",a);if(s)throw s;await E({acao:"cliente_excluido",modulo:"Clientes",detalhes:{id:a}}),await R()}catch{d("NÃ£o foi possÃ­vel excluir este cliente.")}finally{I(null)}}if(!ae)return e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao mÃ³dulo de Clientes."})});const he=!C&&!j;return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"clientes-page",children:[!he&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:de,children:[e.jsx("h3",{children:p?"Editar cliente":"Novo cliente"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:t.nome,onChange:a=>u("nome",a.target.value),onBlur:a=>u("nome",ee(a.target.value)),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"CPF *"}),e.jsx("input",{className:"form-input",value:t.cpf,onChange:a=>u("cpf",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Telefone *"}),e.jsx("input",{className:"form-input",value:t.telefone,onChange:a=>u("telefone",a.target.value)})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Whatsapp"}),e.jsx("input",{className:"form-input",value:t.whatsapp,onChange:a=>u("whatsapp",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Email"}),e.jsx("input",{className:"form-input",value:t.email,onChange:a=>u("email",a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tags (,) "}),e.jsx("input",{className:"form-input",value:t.tags,onChange:a=>u("tags",a.target.value),placeholder:"premium, recorrente..."})]})]}),e.jsxs("div",{className:"mt-2",style:{display:"flex",gap:10,flexWrap:"wrap"},children:[e.jsx("button",{className:"btn btn-primary",disabled:H,type:"submit",children:H?"Salvando...":p?"Salvar alteraÃ§Ãµes":"Criar cliente"}),p&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:le,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",style:{marginTop:12},children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cliente"}),e.jsx("input",{className:"form-input",value:b,onChange:a=>se(a.target.value),placeholder:"Nome, CPF ou e-mail"})]})})}),k&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:k})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[960px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"CPF"}),e.jsx("th",{children:"Telefone"}),e.jsx("th",{children:"E-mail"}),e.jsx("th",{children:"Ativo"}),(j||f)&&e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Carregando..."})}),!L&&X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhum cliente encontrado."})}),!L&&X.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.cpf}),e.jsx("td",{children:a.telefone}),e.jsx("td",{children:a.email||"-"}),e.jsx("td",{children:a.active?"Sim":"NÃ£o"}),(j||f)&&e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",onClick:()=>re(a),title:"HistÃ³rico",children:"ðŸ—‚ï¸"}),j&&e.jsx("button",{className:"btn-icon",onClick:()=>ce(a),title:"Editar",children:"âœï¸"}),f&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>me(a.id),disabled:W===a.id,title:"Excluir",children:W===a.id?"...":"ðŸ—‘ï¸"})]})]},a.id))]})]})})]}),O&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:1100,width:"95vw"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"modal-title",children:["HistÃ³rico de ",O.nome]}),e.jsx("small",{style:{color:"#64748b"},children:"Vendas e orÃ§amentos do cliente"})]}),e.jsx("button",{className:"btn-ghost",onClick:Y,children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[J&&e.jsx("p",{children:"Carregando histÃ³rico..."}),!J&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"card-base mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"Vendas"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[820px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data lanÃ§amento"}),e.jsx("th",{children:"Embarque"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[A.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma venda encontrada."})}),A.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_lancamento?new Date(a.data_lancamento).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsx("td",{children:a.destino_nome||"-"}),e.jsx("td",{children:a.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{className:"th-actions",children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>oe(a),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},a.id))]})]})})]}),e.jsxs("div",{className:"card-base card-blue mb-2",children:[e.jsx("h4",{style:{marginBottom:8},children:"OrÃ§amentos do cliente"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[760px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Venda"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[M.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhum orÃ§amento encontrado."})}),M.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.data_orcamento?.slice(0,10)||"-"}),e.jsx("td",{style:{textTransform:"capitalize"},children:a.status||"-"}),e.jsx("td",{children:a.destino_nome||"-"}),e.jsx("td",{children:(a.valor??0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.numero_venda||"-"}),e.jsx("td",{className:"th-actions",children:e.jsx("button",{className:"btn-icon",type:"button",onClick:()=>ie(a),title:"Ver detalhes",children:"ðŸ‘ï¸"})})]},a.id))]})]})})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:Y,children:"Fechar"})})]})}),m&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:720},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",children:"Detalhes da venda"}),e.jsxs("small",{style:{color:"#64748b"},children:["Destino: ",m.destino_nome||"-"]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>{N(null),_([])},children:"âœ•"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{style:{marginBottom:12,lineHeight:1.5},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"LanÃ§amento:"})," ",new Date(m.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",m.data_embarque?new Date(m.data_embarque).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",m.valor_total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Taxas:"})," ",m.valor_taxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]})]}),e.jsx("h4",{style:{marginBottom:8},children:"Recibos"}),ne?e.jsx("p",{children:"Carregando recibos..."}):e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"NÃºmero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"})]})}),e.jsxs("tbody",{children:[Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,children:"Nenhum recibo encontrado."})}),Q.map((a,s)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsx("td",{children:(a.valor_total||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:(a.valor_taxas||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},s))]})]})})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>{N(null),_([])},children:"Fechar"})})]})}),h&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:640},children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("div",{children:[e.jsx("div",{className:"modal-title",children:"Detalhes do orÃ§amento"}),e.jsxs("small",{style:{color:"#64748b"},children:["Destino: ",h.destino_nome||"-"]})]}),e.jsx("button",{className:"btn-ghost",onClick:()=>y(null),children:"âœ•"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("div",{style:{lineHeight:1.5},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Data:"})," ",h.data_orcamento?new Date(h.data_orcamento).toLocaleDateString("pt-BR"):"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",h.status||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Valor:"})," ",(h.valor||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Venda vinculada:"})," ",h.numero_venda||"-"]})]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"btn btn-outline",onClick:()=>y(null),children:"Fechar"})})]})})]})}export{we as default};
