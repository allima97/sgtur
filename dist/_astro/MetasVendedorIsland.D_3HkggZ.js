import{s as l,j as e}from"./supabase.CWKfsr2i.js";import{r as s}from"./index.DVhKKaGN.js";import{u as le}from"./usePermissao.LURrmXgT.js";function me(){const{permissao:h,ativo:X}=le("Metas"),[C,Y]=s.useState(null),[y,Z]=s.useState(null),[ee,D]=s.useState([]),[R,ae]=s.useState([]),[u,A]=s.useState(""),[P,q]=s.useState(new Date().toISOString().slice(0,7)),[B,S]=s.useState(!0),[w,M]=s.useState(""),[f,p]=s.useState([]),[I,F]=s.useState([]),[E,$]=s.useState({}),[g,k]=s.useState(null),[L,V]=s.useState(!0),[G,U]=s.useState(!1),[z,c]=s.useState(null);s.useEffect(()=>{te()},[]);async function te(){try{V(!0);const{data:a}=await l.auth.getUser(),t=a?.user?.id;if(!t){c("Usu√°rio n√£o autenticado.");return}const{data:o}=await l.from("users").select("id, nome_completo, uso_individual, company_id"),r=o?.find(v=>v.id===t)||null;Z(r);const{data:i}=await l.from("produtos").select("id, nome").eq("ativo",!0);ae(i||[]);const n=h==="admin",m=h==="edit";r?.company_id&&(n||m)?D(o?.filter(v=>v.company_id===r.company_id)||[]):D([r]);const{data:d}=await l.from("parametros_comissao").select("foco_valor").eq("company_id",r?.company_id||null).maybeSingle();Y(d||null),await j(r?.id||""),A(r?.id||"")}catch(a){console.error(a),c("Erro ao carregar dados iniciais")}finally{V(!1)}}async function j(a){if(!(h==="admin")&&!(h==="edit")&&a!==y?.id){F([]);return}const{data:r}=await l.from("metas_vendedor").select("*").eq("vendedor_id",a).order("periodo",{ascending:!1}),i=r||[];if(F(i),i.length>0){const{data:n}=await l.from("metas_vendedor_produto").select("meta_vendedor_id, produto_id, valor").in("meta_vendedor_id",i.map(d=>d.id)),m={};(n||[]).forEach(d=>{m[d.meta_vendedor_id]||(m[d.meta_vendedor_id]=[]),m[d.meta_vendedor_id].push(d)}),$(m)}else $({})}s.useEffect(()=>{!L&&u&&j(u)},[u,L]);const O=h==="admin",Q=h==="edit",_=y?.uso_individual||O||Q,oe=y?.uso_individual===!1&&(O||Q);function T(a){const t=a.replace(/\D/g,"");return t?(Number(t)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function N(a){if(!a)return 0;if(/^\d+$/.test(a))return Number(a)/100;const t=a.replace(/\./g,"").replace(",","."),o=parseFloat(t);return Number.isNaN(o)?0:o}function W(a){return a==null?"":Math.round(a*100).toString()}function H(){return f.reduce((a,t)=>a+N(t.valor),0)}async function re(a){if(a.preventDefault(),c(null),!w||!u){c("Meta geral e vendedor s√£o obrigat√≥rios.");return}const t=H(),o=N(w),r=t;if(Number.isNaN(o)){c("Meta geral inv√°lida.");return}if(C?.foco_valor==="liquido"&&r<=0){c("Quando o foco √© valor l√≠quido, informe metas diferenciadas por produto.");return}const i=f.filter(n=>n.produto_id&&N(n.valor)>0);if(r>0&&i.length===0){c("Adicione pelo menos um produto com valor para a meta diferenciada.");return}try{U(!0);const n=`${P}-01`,m={vendedor_id:u,periodo:n,meta_geral:o,meta_diferenciada:r,ativo:B,scope:"vendedor"};let d=g;if(g){const{error:x}=await l.from("metas_vendedor").update(m).eq("id",g);if(x)throw x}else{const{data:x,error:b}=await l.from("metas_vendedor").insert(m).select("id").single();if(b)throw b;d=x.id}const v=d;if(await l.from("metas_vendedor_produto").delete().eq("meta_vendedor_id",v),i.length>0){const x=i.map(K=>({meta_vendedor_id:v,produto_id:K.produto_id,valor:N(K.valor)})),{error:b}=await l.from("metas_vendedor_produto").insert(x);if(b)throw b}await j(u),J()}catch(n){console.error(n),c(n?.message?`Erro ao salvar meta: ${n.message}`:"Erro ao salvar meta.")}finally{U(!1)}}function J(){M(""),p([]),k(null),S(!0)}function se(a){k(a.id),q(a.periodo.slice(0,7)),M(W(a.meta_geral));const t=E[a.id]||[];t.length>0?p(t.map(o=>({produto_id:o.produto_id,valor:W(o.valor)}))):p([]),S(a.ativo)}async function ie(a,t){try{const{error:o}=await l.from("metas_vendedor").update({ativo:!t}).eq("id",a);if(o)throw o;await j(u)}catch{c("N√£o foi poss√≠vel alterar status da meta.")}}async function ne(a){if(!confirm("Excluir esta meta?"))return;const{error:t}=await l.from("metas_vendedor").delete().eq("id",a);if(t){c("N√£o foi poss√≠vel excluir meta.");return}await j(u)}return L?e.jsx("div",{children:"Carregando..."}):X?e.jsxs("div",{className:"metas-vendedor-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:re,children:[e.jsxs("div",{className:"form-row",children:[oe&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Vendedor *"}),e.jsx("select",{className:"form-select",value:u,onChange:a=>A(a.target.value),children:ee.map(a=>e.jsx("option",{value:a.id,children:a.nome_completo},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Per√≠odo *"}),e.jsx("input",{type:"month",className:"form-input",value:P,onChange:a=>q(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta Geral (R$) *"}),e.jsx("input",{className:"form-input",type:"text",value:T(w),onChange:a=>{const t=a.target.value.replace(/\D/g,"");M(t)},inputMode:"decimal",placeholder:"0,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Metas diferenciadas por produto (opcional)"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[f.map((a,t)=>e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Produto"}),e.jsxs("select",{className:"form-select",value:a.produto_id,onChange:o=>{const r=[...f];r[t]={...r[t],produto_id:o.target.value},p(r)},children:[e.jsx("option",{value:"",children:"Selecione"}),R.map(o=>e.jsx("option",{value:o.id,children:o.nome},o.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta (R$)"}),e.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",value:T(a.valor),onChange:o=>{const r=o.target.value.replace(/\D/g,""),i=[...f];i[t]={...i[t],valor:r},p(i)},placeholder:"0,00"})]}),e.jsx("div",{className:"form-group",style:{justifyContent:"flex-end"},children:e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>{p(f.filter((o,r)=>r!==t))},children:"Remover"})})]},t)),e.jsxs("div",{className:"form-row",style:{alignItems:"center"},children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>p([...f,{produto_id:"",valor:""}]),children:"+ Adicionar produto"}),e.jsxs("div",{style:{marginLeft:"auto",fontWeight:600},children:["Total diferenciada:"," ",H().toLocaleString("pt-BR",{style:"currency",currency:"BRL"})]})]}),C?.foco_valor==="liquido"&&e.jsx("small",{style:{color:"#f97316"},children:"Foco em valor l√≠quido ativo: informe metas diferenciadas por produto."})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativa?"}),e.jsxs("select",{className:"form-select",value:B?"true":"false",onChange:a=>S(a.target.value==="true"),children:[e.jsx("option",{value:"true",children:"Sim"}),e.jsx("option",{value:"false",children:"N√£o"})]})]})]}),z&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:z})}),_&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:G,children:G?"Salvando...":g?"Salvar altera√ß√µes":"Criar meta"}),g&&e.jsx("button",{type:"button",className:"btn btn-light",style:{marginLeft:8},onClick:J,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base card-blue mb-2",children:e.jsx("h3",{children:"Metas cadastradas"})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[880px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Per√≠odo"}),e.jsx("th",{children:"Meta Geral"}),e.jsx("th",{children:"Meta Diferenciada"}),e.jsx("th",{children:"Produtos"}),e.jsx("th",{children:"Ativo"}),_&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[I.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:_?6:5,children:"Nenhuma meta cadastrada."})}),I.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.periodo.slice(0,7)}),e.jsx("td",{children:a.meta_geral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:a.meta_diferenciada.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),e.jsx("td",{children:(E[a.id]||[]).length===0?"‚Äî":(E[a.id]||[]).map(t=>`${R.find(r=>r.id===t.produto_id)?.nome||"Produto"}: ${t.valor.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}`).join(" | ")}),e.jsx("td",{children:a.ativo?"Sim":"N√£o"}),_&&e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>se(a),children:"‚úèÔ∏è"}),e.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>ne(a.id),children:"üóëÔ∏è"}),e.jsx("button",{className:"btn-icon",title:a.ativo?"Inativar":"Ativar",onClick:()=>ie(a.id,a.ativo),children:a.ativo?"‚è∏Ô∏è":"‚ñ∂Ô∏è"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"Acesso ao m√≥dulo de Metas bloqueado."})}export{me as default};
