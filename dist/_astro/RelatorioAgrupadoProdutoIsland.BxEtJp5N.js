import{j as t,s as S}from"./supabase.CWKfsr2i.js";import{r as i}from"./index.DVhKKaGN.js";function M(){return new Date().toISOString().substring(0,10)}function R(n,N){const p=new Date(n);return p.setDate(p.getDate()+N),p}function g(n){return n.toISOString().substring(0,10)}function T(n){return new Date(n.getFullYear(),n.getMonth(),1)}function $(n){return new Date(n.getFullYear(),n.getMonth()+1,0)}function z(n){return n.includes(";")||n.includes('"')||n.includes(`
`)?'"'+n.replace(/"/g,'""')+'"':n}function X(){const[n,N]=i.useState([]),[p,j]=i.useState(()=>{const a=R(new Date,-30);return g(a)}),[_,b]=i.useState(M()),[D,G]=i.useState("todos"),[O,P]=i.useState([]),[w,q]=i.useState(!1),[I,x]=i.useState(null),[m,V]=i.useState(null),[Y,L]=i.useState(!0),[h,Q]=i.useState("total"),[y,A]=i.useState(!0);i.useEffect(()=>{async function e(){try{const{data:a,error:o}=await S.from("produtos").select("id, nome, tipo").order("nome",{ascending:!0});if(o)throw o;N(a||[])}catch(a){console.error(a),x("Erro ao carregar produtos.")}}e()},[]),i.useEffect(()=>{async function e(){try{L(!0),x(null);const{data:a}=await S.auth.getUser(),o=a?.user?.id;if(!o){x("Usuário não autenticado.");return}const{data:r}=await S.from("users").select("id, user_types(name)").eq("id",o).maybeSingle(),c=r?.user_types?.name||a?.user?.user_metadata?.name||"",s=String(c||"").toUpperCase();let l="VENDEDOR";s.includes("ADMIN")?l="ADMIN":s.includes("GESTOR")?l="GESTOR":s.includes("VENDEDOR")?l="VENDEDOR":l="OUTRO";let d=[o];if(l==="GESTOR"){const{data:u}=await S.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",o),C=u?.map(E=>E.vendedor_id).filter(E=>!!E)||[];d=Array.from(new Set([o,...C]))}else l==="ADMIN"&&(d=[]);V({usuarioId:o,papel:l,vendedorIds:d})}catch(a){console.error(a),x("Erro ao carregar contexto do usuário.")}finally{L(!1)}}e()},[]);const f=i.useMemo(()=>{const e=new Map(n.map(r=>[r.id,r])),a=new Map;O.forEach(r=>{const c=r.produto_id||"sem-produto",s=r.produto_id?e.get(r.produto_id):void 0,l=s?.nome||s?.tipo||"(sem produto)",d=a.get(c)||{produto_id:r.produto_id||null,produto_nome:l,quantidade:0,total:0,ticketMedio:0},u=r.valor_total??0;d.quantidade+=1,d.total+=u,a.set(c,d)});const o=Array.from(a.values()).map(r=>({...r,ticketMedio:r.quantidade>0?r.total/r.quantidade:0}));return o.sort((r,c)=>{let s=0;return h==="total"?s=r.total-c.total:h==="quantidade"?s=r.quantidade-c.quantidade:s=r.ticketMedio-c.ticketMedio,y?-s:s}),o},[O,n,h,y]),F=f.reduce((e,a)=>e+a.total,0),U=f.reduce((e,a)=>e+a.quantidade,0),H=U>0?F/U:0;function v(e){const a=new Date;if(e==="7"){const o=R(a,-7);j(g(o)),b(M());return}if(e==="30"){const o=R(a,-30);j(g(o)),b(M());return}if(e==="mes_atual"){const o=T(a),r=$(a);j(g(o)),b(g(r));return}if(e==="mes_anterior"){const o=new Date(a.getFullYear(),a.getMonth()-1,1),r=T(o),c=$(o);j(g(r)),b(g(c));return}}async function B(){if(m)try{q(!0),x(null);let e=S.from("vendas").select("id, vendedor_id, cliente_id, destino_id, produto_id, data_lancamento, data_embarque, valor_total, status").order("data_lancamento",{ascending:!1});m.papel!=="ADMIN"&&(e=e.in("vendedor_id",m.vendedorIds)),p&&(e=e.gte("data_lancamento",p)),_&&(e=e.lte("data_lancamento",_)),D!=="todos"&&(e=e.eq("status",D));const{data:a,error:o}=await e;if(o)throw o;P(a||[])}catch(e){console.error(e),x("Erro ao carregar vendas para relatório por produto.")}finally{q(!1)}}function k(e){e===h?A(a=>!a):(Q(e),A(!0))}i.useEffect(()=>{m&&B()},[m]);function W(){if(f.length===0){alert("Não há dados para exportar.");return}const e=["produto","quantidade","total","ticket_medio"],a=f.map(u=>[u.produto_nome,u.quantidade.toString(),u.total.toFixed(2).replace(".",","),u.ticketMedio.toFixed(2).replace(".",",")]),o=[e,...a].map(u=>u.map(C=>z(C)).join(";")).join(`
`),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(r),s=new Date,l=`${s.getFullYear()}${String(s.getMonth()+1).padStart(2,"0")}${String(s.getDate()).padStart(2,"0")}-${String(s.getHours()).padStart(2,"0")}${String(s.getMinutes()).padStart(2,"0")}`,d=document.createElement("a");d.href=c,d.setAttribute("download",`relatorio-vendas-por-produto-${l}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(c)}return t.jsxs("div",{className:"relatorio-vendas-produto-page",children:[t.jsxs("div",{className:"card-base card-purple mb-3",children:[t.jsxs("div",{className:"form-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data início"}),t.jsx("input",{type:"date",className:"form-input",value:p,onChange:e=>j(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Data fim"}),t.jsx("input",{type:"date",className:"form-input",value:_,onChange:e=>b(e.target.value)})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{className:"form-label",children:"Status"}),t.jsxs("select",{className:"form-select",value:D,onChange:e=>G(e.target.value),children:[t.jsx("option",{value:"todos",children:"Todos"}),t.jsx("option",{value:"aberto",children:"Aberto"}),t.jsx("option",{value:"confirmado",children:"Confirmado"}),t.jsx("option",{value:"cancelado",children:"Cancelado"})]})]})]}),t.jsxs("div",{style:{marginTop:8,display:"flex",gap:8,flexWrap:"wrap"},children:[t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("7"),children:"Últimos 7 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("30"),children:"Últimos 30 dias"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_atual"),children:"Este mês"}),t.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>v("mes_anterior"),children:"Mês anterior"}),t.jsx("button",{type:"button",className:"btn btn-primary",onClick:B,children:"Aplicar filtros"}),t.jsx("button",{type:"button",className:"btn btn-purple",onClick:W,children:"Exportar CSV"})]})]}),Y&&t.jsx("div",{className:"card-base card-config mb-3",children:"Carregando contexto do usuário..."}),m&&m.papel!=="ADMIN"&&t.jsxs("div",{className:"card-base card-config mb-3",style:{color:"#334155"},children:["Relatório limitado a ",m.papel==="GESTOR"?"sua equipe":"suas vendas","."]}),I&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:I})}),t.jsx("div",{className:"card-base mb-3",children:t.jsxs("div",{className:"form-row",children:[t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Produtos: ",t.jsx("strong",{children:f.length})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Faturamento total:"," ",t.jsx("strong",{children:F.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})}),t.jsx("div",{className:"form-group",children:t.jsxs("span",{children:["Ticket médio geral:"," ",t.jsx("strong",{children:H.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})})]})}),t.jsx("div",{className:"table-container overflow-x-auto",children:t.jsxs("table",{className:"table-default table-header-purple min-w-[620px]",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Produto"}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>k("quantidade"),children:["Qtde ",h==="quantidade"?y?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>k("total"),children:["Faturamento ",h==="total"?y?"↓":"↑":""]}),t.jsxs("th",{style:{cursor:"pointer"},onClick:()=>k("ticket"),children:["Ticket médio ",h==="ticket"?y?"↓":"↑":""]})]})}),t.jsxs("tbody",{children:[w&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Carregando..."})}),!w&&f.length===0&&t.jsx("tr",{children:t.jsx("td",{colSpan:4,children:"Nenhum produto encontrado com os filtros atuais."})}),!w&&f.map((e,a)=>t.jsxs("tr",{children:[t.jsx("td",{children:e.produto_nome}),t.jsx("td",{children:e.quantidade}),t.jsx("td",{children:e.total.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),t.jsx("td",{children:e.ticketMedio.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]},e.produto_id??`sem-${a}`))]})]})})]})}export{X as default};
