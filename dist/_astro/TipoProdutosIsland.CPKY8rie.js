import{j as e,s as d}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as ue}from"./usePermissao.72SYthuA.js";import{t as G}from"./titleCase.DQLlfrnh.js";function P(s){return(s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function ge(){const{permissao:s,ativo:ee,loading:ae}=ue("Parametros"),[w,oe]=t.useState([]),[C,z]=t.useState(!0),[L,n]=t.useState(null),[j,se]=t.useState(""),[f,U]=t.useState(null),[W,O]=t.useState(null),[$,ie]=t.useState([]),[g,te]=t.useState({}),[b,N]=t.useState(""),[y,M]=t.useState(""),[E,D]=t.useState(""),[R,T]=t.useState(""),[m,k]=t.useState(!1),[H,A]=t.useState(""),[J,I]=t.useState(""),[K,q]=t.useState(!0),[i,F]=t.useState({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0});function x(a,o){F(p=>{if(a==="nome"){const r=String(o);return{...p,nome:r,tipo:p.tipo||r}}return{...p,[a]:o}})}async function V(){try{z(!0),n(null);const[{data:a,error:o},p,r]=await Promise.all([d.from("tipo_produtos").select("*").order("nome",{ascending:!0}),d.from("commission_rule").select("id, nome, tipo").eq("ativo",!0).order("nome"),d.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]);if(o)throw o;oe(a||[]),ie(p.data||[]);const S={};r.data?.forEach(_=>{S[_.produto_id]={rule_id:_.rule_id||"",fix_meta_nao_atingida:_.fix_meta_nao_atingida,fix_meta_atingida:_.fix_meta_atingida,fix_super_meta:_.fix_super_meta}}),te(S)}catch(a){console.error(a),n("Erro ao carregar tipos de produto.")}finally{z(!1)}}t.useEffect(()=>{V()},[]);function Q(){F({nome:"",tipo:"",regra_comissionamento:"geral",soma_na_meta:!0,disponivel_todas_cidades:!1,ativo:!0}),k(!1),A(""),I(""),q(!0),N(""),M(""),D(""),T(""),U(null),n(null)}function re(a){U(a.id),F({nome:a.nome||a.tipo,tipo:a.tipo||a.nome||"",regra_comissionamento:a.regra_comissionamento,soma_na_meta:a.soma_na_meta,disponivel_todas_cidades:!!a.disponivel_todas_cidades,ativo:a.ativo}),k(!!a.usa_meta_produto),A(a.meta_produto_valor!==null&&a.meta_produto_valor!==void 0?String(a.meta_produto_valor):""),I(a.comissao_produto_meta_pct!==null&&a.comissao_produto_meta_pct!==void 0?String(a.comissao_produto_meta_pct):""),q(a.descontar_meta_geral!==null&&a.descontar_meta_geral!==void 0?!!a.descontar_meta_geral:!0);const o=g[a.id]||{};N(o.rule_id||""),M(o.fix_meta_nao_atingida!==null&&o.fix_meta_nao_atingida!==void 0?String(o.fix_meta_nao_atingida):""),D(o.fix_meta_atingida!==null&&o.fix_meta_atingida!==void 0?String(o.fix_meta_atingida):""),T(o.fix_super_meta!==null&&o.fix_super_meta!==void 0?String(o.fix_super_meta):"")}async function ne(a){if(a.preventDefault(),s==="view"){n("VocÃª nÃ£o tem permissÃ£o para salvar tipos de produto.");return}const o=G(i.nome),p=G(i.tipo||o);if(!o){n("Nome Ã© obrigatÃ³rio.");return}if(i.regra_comissionamento==="geral"&&!b){n("Selecione uma regra de comissÃ£o para produtos do tipo 'geral'.");return}const r=l=>l.trim()===""?null:Number(l),S=r(H),_=r(J);if(i.regra_comissionamento==="diferenciado"){const l=r(y),u=r(E),c=r(R);if(l===null||isNaN(l)||u===null||isNaN(u)||c===null||isNaN(c)){n("Preencha os percentuais fixos para meta nÃ£o atingida, atingida e super meta (apenas nÃºmeros).");return}}try{n(null);const l={nome:o,tipo:p,regra_comissionamento:i.regra_comissionamento,soma_na_meta:i.soma_na_meta,disponivel_todas_cidades:i.disponivel_todas_cidades,ativo:i.ativo,usa_meta_produto:m,meta_produto_valor:m?S:null,comissao_produto_meta_pct:m?_:null,descontar_meta_geral:m?K:!0};let u=f;if(f){const{error:c}=await d.from("tipo_produtos").update(l).eq("id",f);if(c)throw c}else{const{data:c,error:h}=await d.from("tipo_produtos").insert(l).select("id").single();if(h)throw h;u=c?.id||null}if(u){async function c(){const v="ComissÃ£o Fixa (auto)",{data:Y}=await d.from("commission_rule").select("id").eq("nome",v).maybeSingle();if(Y?.id)return Y.id;const{data:me,error:Z}=await d.from("commission_rule").insert({nome:v,descricao:"Gerada automaticamente para produtos diferenciados sem regra vinculada.",tipo:"GERAL",meta_nao_atingida:0,meta_atingida:0,super_meta:0,ativo:!0}).select("id").single();if(Z)throw Z;return me?.id}const h=i.regra_comissionamento==="diferenciado"?r(y):null,de=i.regra_comissionamento==="diferenciado"?r(E):null,ce=i.regra_comissionamento==="diferenciado"?r(R):null;let B=b||g[u]?.rule_id||null;if(i.regra_comissionamento==="diferenciado"&&!B&&(B=await c()),b||i.regra_comissionamento==="diferenciado"){const{error:v}=await d.from("product_commission_rule").upsert({produto_id:u,rule_id:B,ativo:!0,fix_meta_nao_atingida:h,fix_meta_atingida:de,fix_super_meta:ce},{onConflict:"produto_id"});if(v)throw v}else await d.from("product_commission_rule").delete().eq("produto_id",u)}Q(),await V()}catch(l){console.error(l),n("Erro ao salvar tipo de produto.")}}async function le(a){if(s!=="admin"){alert("Somente administradores podem excluir tipos de produto.");return}if(confirm("Tem certeza que deseja excluir este tipo de produto?"))try{O(a);const{error:o}=await d.from("tipo_produtos").delete().eq("id",a);if(o)throw o;await V()}catch(o){console.error(o),n("Erro ao excluir tipo de produto. Talvez esteja vinculado a vendas/recibos.")}finally{O(null)}}const X=t.useMemo(()=>{if(!j.trim())return w;const a=P(j);return w.filter(o=>P(o.nome||o.tipo||"").includes(a))},[j,w]);return ae?e.jsx("div",{children:"Carregando permissÃµes..."}):ee?e.jsxs("div",{className:"produtos-page",children:[e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:ne,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:i.nome,onChange:a=>x("nome",a.target.value),onBlur:a=>x("nome",G(a.target.value)),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Modelo de comissÃ£o"}),e.jsxs("select",{className:"form-input",value:i.regra_comissionamento,onChange:a=>{const o=a.target.value;x("regra_comissionamento",o),o==="diferenciado"&&N("")},disabled:s==="view",children:[e.jsx("option",{value:"geral",children:"Geral (usa regra cadastrada)"}),e.jsx("option",{value:"diferenciado",children:"Diferenciado (percentual fixo)"})]})]})]}),e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Soma na meta?"}),e.jsxs("select",{className:"form-input",value:i.soma_na_meta?"1":"0",onChange:a=>x("soma_na_meta",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DisponÃ­vel para todas as cidades?"}),e.jsxs("select",{className:"form-input",value:i.disponivel_todas_cidades?"1":"0",onChange:a=>x("disponivel_todas_cidades",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"0",children:"NÃ£o"}),e.jsx("option",{value:"1",children:"Sim"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Ativo?"}),e.jsxs("select",{className:"form-input",value:i.ativo?"1":"0",onChange:a=>x("ativo",a.target.value==="1"),disabled:s==="view",children:[e.jsx("option",{value:"1",children:"Sim"}),e.jsx("option",{value:"0",children:"NÃ£o"})]})]})]}),e.jsxs("div",{className:"card-base card-blue",style:{marginTop:12},children:[e.jsx("h4",{style:{marginBottom:8},children:"Meta especÃ­fica do produto (opcional)"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Usar meta especÃ­fica?"}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:m,onChange:a=>k(a.target.checked),disabled:s==="view"}),e.jsx("span",{children:"Sim"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta do produto (R$)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",min:"0",value:H,onChange:a=>A(a.target.value),disabled:!m||s==="view",placeholder:"Ex: 1000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"% ao bater a meta do produto"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",min:"0",value:J,onChange:a=>I(a.target.value),disabled:!m||s==="view",placeholder:"Ex: 10 (para 10%)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Descontar comissÃ£o da meta geral?"}),e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:K,onChange:a=>q(a.target.checked),disabled:!m||s==="view"}),e.jsx("span",{children:"Sim"})]})]})]}),e.jsx("small",{style:{color:"#475569"},children:'Se ativado, o produto paga a comissÃ£o da meta prÃ³pria (ex.: 10%); se "Descontar meta geral" estiver ligado, subtrai o que jÃ¡ foi pago pela meta geral para evitar duplicidade.'})]}),i.regra_comissionamento==="geral"&&e.jsxs("div",{className:"form-group",style:{marginTop:8},children:[e.jsx("label",{className:"form-label",children:"Regra de ComissÃ£o *"}),e.jsxs("select",{className:"form-input",value:b,onChange:a=>N(a.target.value),disabled:s==="view",required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),$.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," (",a.tipo,")"]},a.id))]})]}),i.regra_comissionamento==="diferenciado"&&e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta nÃ£o atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:y,onChange:a=>M(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (meta atingida) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:E,onChange:a=>D(a.target.value),disabled:s==="view"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"ComissÃ£o fixa (super meta) %"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:R,onChange:a=>T(a.target.value),disabled:s==="view"})]})]}),s!=="view"&&e.jsxs("div",{style:{display:"flex",gap:10,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",type:"submit",children:f?"Salvar alteraÃ§Ãµes":"Adicionar tipo"}),f&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:Q,children:"Cancelar ediÃ§Ã£o"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar tipo de produto"}),e.jsx("input",{className:"form-input",value:j,onChange:a=>se(a.target.value),placeholder:"Digite parte do nome..."})]})}),L&&e.jsx("div",{className:"card-base card-config mb-3",children:L}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Regra"}),e.jsx("th",{children:"Regra vinculada"}),e.jsx("th",{children:"Soma meta"}),e.jsx("th",{children:"Todas cidades"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Criado em"}),e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[C&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando tipos de produto..."})}),!C&&X.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhum tipo encontrado."})}),!C&&X.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome||a.tipo}),e.jsx("td",{children:a.regra_comissionamento}),e.jsx("td",{children:g[a.id]?.rule_id?$.find(o=>o.id===g[a.id]?.rule_id)?.nome||"-":g[a.id]?.fix_meta_atingida?"ComissÃ£o fixa":"-"}),e.jsx("td",{children:a.soma_na_meta?"Sim":"NÃ£o"}),e.jsx("td",{children:a.disponivel_todas_cidades?"Sim":"NÃ£o"}),e.jsx("td",{style:{color:a.ativo?"#22c55e":"#ef4444"},children:a.ativo?"Ativo":"Inativo"}),e.jsx("td",{children:a.created_at?new Date(a.created_at).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{className:"th-actions",children:[s!=="view"&&e.jsx("button",{className:"btn-icon",onClick:()=>re(a),children:"âœï¸"}),s==="admin"&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>le(a.id),disabled:W===a.id,children:W===a.id?"...":"ğŸ—‘ï¸"})]})]},a.id))]})]})})]}):e.jsx("div",{children:"VocÃª nÃ£o possui acesso ao mÃ³dulo de ParÃ¢metros."})}export{ge as default};
