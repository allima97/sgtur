import{j as a,s as h}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as se}from"./usePermissao.72SYthuA.js";function m(d){return(d||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const U={nome:"",cidade_id:"",tipo_produto:"",atracao_principal:"",melhor_epoca:"",duracao_sugerida:"",nivel_preco:"",imagem_url:"",informacoes_importantes:"",ativo:!0};function ne(){const{permissao:d,ativo:G,loading:H}=se("Cadastros"),[D,O]=t.useState([]),[v,Y]=t.useState([]),[u,J]=t.useState([]),[C,K]=t.useState([]),[P,Q]=t.useState([]),[r,g]=t.useState(U),[_,W]=t.useState(""),[S,j]=t.useState(""),[X,f]=t.useState(!1),[E,B]=t.useState(!0),[T,q]=t.useState(!1),[b,z]=t.useState(null),[I,A]=t.useState(null),[F,n]=t.useState(null);async function y(){async function e(){const o=[];let l=0;for(;;){const{data:i,error:p}=await h.from("cidades").select("id, nome, estado_id").order("nome").range(l,l+1e3-1);if(p)throw p;if(o.push(...i||[]),!i||i.length<1e3)break;l+=1e3}return o}try{B(!0),n(null);const[{data:o,error:s},{data:l,error:i},p,{data:x,error:N},{data:w,error:$}]=await Promise.all([h.from("paises").select("id, nome").order("nome"),h.from("estados").select("id, nome, pais_id").order("nome"),e(),h.from("tipo_produtos").select("id, nome, tipo").order("nome"),h.from("produtos").select("id, nome, cidade_id, tipo_produto, informacoes_importantes, atracao_principal, melhor_epoca, duracao_sugerida, nivel_preco, imagem_url, ativo, created_at").order("nome")]);if(s)throw s;if(i)throw i;if(N)throw N;if($)throw $;O(o||[]),Y(l||[]),J(p||[]),K(x||[]),Q(w||[])}catch(o){console.error(o),n("Erro ao carregar produtos. Verifique se as tabelas est√£o corretas.")}finally{B(!1)}}t.useEffect(()=>{y()},[]);const L=t.useMemo(()=>{const e=m(S.trim());return e?u.filter(o=>m(o.nome).includes(e)):u},[u,S]),k=t.useMemo(()=>new Map(v.map(e=>[e.id,e.nome])),[v]);function Z(e){const o=u.find(l=>l.id===e);if(!o)return"";const s=k.get(o.estado_id);return s?`${o.nome} (${s})`:o.nome}const M=t.useMemo(()=>{const e=new Map(u.map(i=>[i.id,i])),o=new Map(v.map(i=>[i.id,i])),s=new Map(D.map(i=>[i.id,i])),l=new Map(C.map(i=>[i.id,i]));return P.map(i=>{const p=e.get(i.cidade_id||""),x=p?o.get(p.estado_id):void 0,N=x?s.get(x.pais_id):void 0,w=i.tipo_produto?l.get(i.tipo_produto):void 0;return{...i,cidade_nome:p?.nome||"",estado_nome:x?.nome||"",pais_nome:N?.nome||"",tipo_nome:w?.nome||w?.tipo||""}})},[P,u,v,D,C]),V=t.useMemo(()=>{if(!_.trim())return M;const e=m(_);return M.filter(o=>m(o.nome).includes(e)||m(o.cidade_nome).includes(e)||m(o.estado_nome).includes(e)||m(o.pais_nome).includes(e)||m(o.tipo_nome).includes(e))},[_,M]);function c(e,o){g(s=>({...s,[e]:o}))}function ee(e){j(e);const o=u.find(s=>s.id===r.cidade_id);(!o||!m(o.nome).includes(m(e)))&&g(s=>({...s,cidade_id:""})),f(!0)}function R(){g(U),z(null),n(null),j(""),f(!1)}function ae(e){const o=u.find(s=>s.id===e.cidade_id);z(e.id),g({nome:e.nome,cidade_id:e.cidade_id,tipo_produto:e.tipo_produto||"",atracao_principal:e.atracao_principal||"",melhor_epoca:e.melhor_epoca||"",duracao_sugerida:e.duracao_sugerida||"",nivel_preco:e.nivel_preco||"",imagem_url:e.imagem_url||"",informacoes_importantes:e.informacoes_importantes||"",ativo:e.ativo??!0}),j(Z(e.cidade_id)||o?.nome||""),f(!1)}async function oe(e){if(e.preventDefault(),d==="view"){n("Voc√™ n√£o tem permiss√£o para salvar produtos.");return}if(!r.nome.trim()){n("Nome √© obrigat√≥rio.");return}if(!r.cidade_id){n("Cidade √© obrigat√≥ria.");return}if(!r.tipo_produto){n("Tipo de produto √© obrigat√≥rio.");return}try{q(!0),n(null);const o={nome:r.nome.trim(),cidade_id:r.cidade_id,tipo_produto:r.tipo_produto,atracao_principal:r.atracao_principal.trim()||null,melhor_epoca:r.melhor_epoca.trim()||null,duracao_sugerida:r.duracao_sugerida.trim()||null,nivel_preco:r.nivel_preco.trim()||null,imagem_url:r.imagem_url.trim()||null,informacoes_importantes:r.informacoes_importantes.trim()||null,ativo:r.ativo};if(b){const{error:s}=await h.from("produtos").update(o).eq("id",b);if(s)throw s}else{const{error:s}=await h.from("produtos").insert(o);if(s)throw s}R(),await y()}catch(o){console.error(o),n("Erro ao salvar produto. Verifique os dados e tente novamente.")}finally{q(!1)}}async function re(e){if(d!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{A(e),n(null);const{error:o}=await h.from("produtos").delete().eq("id",e);if(o)throw o;await y()}catch(o){console.error(o),n("N√£o foi poss√≠vel excluir o produto. Verifique v√≠nculos com vendas/or√ßamentos.")}finally{A(null)}}return H?a.jsx("div",{children:"Carregando permiss√µes..."}):G?a.jsxs("div",{className:"destinos-page",children:[a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:oe,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome do produto *"}),a.jsx("input",{className:"form-input",value:r.nome,onChange:e=>c("nome",e.target.value),placeholder:"Ex: Passeio em Gramado, Pacote Paris...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo *"}),a.jsxs("select",{className:"form-select",value:r.tipo_produto,onChange:e=>c("tipo_produto",e.target.value),disabled:d==="view",children:[a.jsx("option",{value:"",children:"Selecione o tipo"}),C.map(e=>a.jsx("option",{value:e.id,children:e.nome||e.tipo},e.id))]})]})]}),a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Cidade *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:S,onChange:e=>ee(e.target.value),onFocus:()=>f(!0),onBlur:()=>setTimeout(()=>f(!1),150),disabled:d==="view",style:{marginBottom:6}}),X&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb"},children:[L.length===0&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),L.map(e=>{const o=k.get(e.estado_id),s=o?`${e.nome} (${o})`:e.nome;return a.jsx("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:r.cidade_id===e.id?"#e0f2fe":"#fff",borderColor:r.cidade_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:l=>{l.preventDefault(),c("cidade_id",e.id),j(s),f(!1)},children:s},e.id)})]})]})}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Atra√ß√£o principal"}),a.jsx("input",{className:"form-input",value:r.atracao_principal,onChange:e=>c("atracao_principal",e.target.value),placeholder:"Ex: Disney, Torre Eiffel...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Melhor √©poca"}),a.jsx("input",{className:"form-input",value:r.melhor_epoca,onChange:e=>c("melhor_epoca",e.target.value),placeholder:"Ex: Dezembro a Mar√ßo",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Dura√ß√£o sugerida"}),a.jsx("input",{className:"form-input",value:r.duracao_sugerida,onChange:e=>c("duracao_sugerida",e.target.value),placeholder:"Ex: 7 dias",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"N√≠vel de pre√ßo"}),a.jsx("input",{className:"form-input",value:r.nivel_preco,onChange:e=>c("nivel_preco",e.target.value),placeholder:"Ex: Econ√¥mico, Intermedi√°rio, Premium",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Imagem (URL)"}),a.jsx("input",{className:"form-input",value:r.imagem_url,onChange:e=>c("imagem_url",e.target.value),placeholder:"URL de uma imagem do destino",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Informa√ß√µes importantes"}),a.jsx("textarea",{className:"form-input",rows:3,value:r.informacoes_importantes,onChange:e=>c("informacoes_importantes",e.target.value),placeholder:"Observa√ß√µes gerais, dicas, documenta√ß√£o necess√°ria, etc.",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Ativo"}),a.jsxs("select",{className:"form-select",value:r.ativo?"true":"false",onChange:e=>c("ativo",e.target.value==="true"),disabled:d==="view",children:[a.jsx("option",{value:"true",children:"Sim"}),a.jsx("option",{value:"false",children:"N√£o"})]})]}),a.jsxs("div",{className:"mt-2",children:[d!=="view"&&a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:T,children:T?"Salvando...":b?"Salvar altera√ß√µes":"Adicionar produto"}),b&&d!=="view"&&a.jsx("button",{type:"button",className:"btn btn-light",style:{marginLeft:8},onClick:R,children:"Cancelar edi√ß√£o"})]})]})}),a.jsx("div",{className:"card-base mb-3",children:a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Buscar produto"}),a.jsx("input",{className:"form-input",value:_,onChange:e=>W(e.target.value),placeholder:"Busque por nome, tipo, cidade, estado ou pa√≠s..."})]})})}),F&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:F})}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1080px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Tipo"}),a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Estado"}),a.jsx("th",{children:"Pa√≠s"}),a.jsx("th",{children:"N√≠vel de pre√ßo"}),a.jsx("th",{children:"Ativo"}),a.jsx("th",{children:"Criado em"}),a.jsx("th",{className:"th-actions",children:"A√ß√µes"})]})}),a.jsxs("tbody",{children:[E&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando produtos..."})}),!E&&V.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum produto encontrado."})}),!E&&V.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.tipo_nome||"-"}),a.jsx("td",{children:e.cidade_nome||"-"}),a.jsx("td",{children:e.estado_nome||"-"}),a.jsx("td",{children:e.pais_nome||"-"}),a.jsx("td",{children:e.nivel_preco||"-"}),a.jsx("td",{children:e.ativo?"Sim":"N√£o"}),a.jsx("td",{children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-"}),a.jsxs("td",{className:"th-actions",children:[d!=="view"&&a.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>ae(e),children:"‚úèÔ∏è"}),d==="admin"&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>re(e.id),disabled:I===e.id,children:I===e.id?"...":"üóëÔ∏è"})]})]},e.id))]})]})})]}):a.jsx("div",{children:"Voc√™ n√£o possui acesso ao m√≥dulo de Cadastros."})}export{ne as default};
