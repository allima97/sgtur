import{s as b,j as a}from"./supabase.DNkd6bxA.js";import{r as c}from"./index.C0Fn7Wtz.js";import{u as _a}from"./usePermissao.72SYthuA.js";const ua=[{id:"mes_atual",label:"Mês atual"},{id:"mes_anterior",label:"Mês anterior"},{id:"trim",label:"Últimos 3 meses"},{id:"sem",label:"Últimos 6 meses"},{id:"ano",label:"Últimos 12 meses"}];function V(v,n){const s=new Date(v);return s.setMonth(s.getMonth()+n),s}function Q(v){return v.toISOString().slice(0,10)}function F(v){const n=new Date;let s;switch(v){case"mes_anterior":{s=new Date(n.getFullYear(),n.getMonth()-1,1);break}case"trim":s=V(n,-3);break;case"sem":s=V(n,-6);break;case"ano":s=V(n,-12);break;case"mes_atual":default:s=new Date(n.getFullYear(),n.getMonth(),1);break}return{inicio:Q(s),fim:Q(n)}}function va(){const{ativo:v,loading:n}=_a("Vendas"),s=import.meta?.env?.PUBLIC_META_PRODUTO_ENABLED!=="false",[X,Z]=c.useState(null),[C,aa]=c.useState(null),[D,ea]=c.useState(null),[U,ta]=c.useState([]),[$,oa]=c.useState({}),[T,sa]=c.useState({}),[j,ra]=c.useState({}),[z,ia]=c.useState([]),[pa,la]=c.useState(!0),[K,W]=c.useState(!0),[Y,q]=c.useState(null),[B,ca]=c.useState("mes_atual"),[H,na]=c.useState(()=>F("mes_atual"));c.useEffect(()=>{n||!v||da()},[n,v,B]),c.useEffect(()=>{na(F(B))},[B]);async function da(){try{W(!0),q(null);const{data:t}=await b.auth.getUser(),u=t?.user?.id||null;if(!u){q("Usuário não autenticado.");return}Z({id:u,nome:t?.user?.email||""});const f=F(B),{data:P}=await b.from("parametros_comissao").select("usar_taxas_na_meta, foco_valor").maybeSingle(),{data:k}=await b.from("metas_vendedor").select("id, meta_geral").eq("vendedor_id",u).eq("periodo",f.inicio.slice(0,7)+"-01").maybeSingle(),y="id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral",M=async e=>{const w=e?`${y}, exibe_kpi_comissao`:y;return b.from("tipo_produtos").select(w)};let g=await M(!0),x=!0;g.error&&g.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(x=!1,g=await M(!1));const R=x?"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral, exibe_kpi_comissao":"id, nome, regra_comissionamento, soma_na_meta, usa_meta_produto, meta_produto_valor, comissao_produto_meta_pct, descontar_meta_geral";let N=await b.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${R}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",f.inicio).lte("data_lancamento",f.fim);N.error&&N.error.message?.toLowerCase().includes("exibe_kpi_comissao")&&(N=await b.from("vendas").select(`
          id,
          data_lancamento,
          cancelada,
          vendas_recibos (
            valor_total,
            valor_taxas,
            produto_id,
            tipo_produtos (
              ${y}
            )
          )
        `).eq("cancelada",!1).gte("data_lancamento",f.inicio).lte("data_lancamento",f.fim),x=!1);const[L,S,G]=await Promise.all([b.from("metas_vendedor_produto").select("produto_id, valor").eq("meta_vendedor_id",k?.id||""),b.from("commission_rule").select("id, tipo, meta_nao_atingida, meta_atingida, super_meta"),b.from("product_commission_rule").select("produto_id, rule_id, fix_meta_nao_atingida, fix_meta_atingida, fix_super_meta")]),E=L.data,o=S.data,i=G.data,m=g.data,l=N.data;la(x);const r={};(o||[]).forEach(e=>{r[e.id]={id:e.id,tipo:e.tipo||"GERAL",meta_nao_atingida:e.meta_nao_atingida,meta_atingida:e.meta_atingida,super_meta:e.super_meta}});const _={};(i||[]).forEach(e=>{_[e.produto_id]={produto_id:e.produto_id,rule_id:e.rule_id,fix_meta_nao_atingida:e.fix_meta_nao_atingida,fix_meta_atingida:e.fix_meta_atingida,fix_super_meta:e.fix_super_meta}});const p={};(m||[]).forEach(e=>{p[e.id]={id:e.id,nome:e.nome,regra_comissionamento:e.regra_comissionamento,soma_na_meta:e.soma_na_meta,usa_meta_produto:e.usa_meta_produto,meta_produto_valor:e.meta_produto_valor,comissao_produto_meta_pct:e.comissao_produto_meta_pct,descontar_meta_geral:e.descontar_meta_geral,exibe_kpi_comissao:x?e.exibe_kpi_comissao:void 0}}),aa(P?{usar_taxas_na_meta:!!P.usar_taxas_na_meta,foco_valor:P.foco_valor||"bruto"}:{usar_taxas_na_meta:!0,foco_valor:"bruto"}),ea(k),ta(E||[]),oa(r),sa(_),ra(p),ia(l||[])}catch(t){console.error(t),q("Erro ao carregar dados de comissionamento.")}finally{W(!1)}}const d=c.useMemo(()=>{if(!C)return null;const t={};U.forEach(o=>{t[o.produto_id]=o.valor});const u={},f={},P={};let k=0,y=0,M=0,g=0,x=0;const R={},N=[];let L=0;const S={};Object.values(j).forEach(o=>{o.regra_comissionamento==="diferenciado"&&(N.push(o.id),R[o.id]=0),o.usa_meta_produto&&(S[o.id]=0)}),z.forEach(o=>{(o.vendas_recibos||[]).forEach(i=>{const m=i.tipo_produtos?.id||i.produto_id||"",l=j[m];if(!l)return;const r=Number(i.valor_total||0),_=Number(i.valor_taxas||0),p=r-_,e=C.usar_taxas_na_meta?r:p;f[m]=(f[m]||0)+r,P[m]=(P[m]||0)+p,u[m]=(u[m]||0)+e,l.soma_na_meta&&(k+=e),y+=r,M+=_})});const G=y-M,E=D?.meta_geral&&D.meta_geral>0?k/D.meta_geral*100:0;return Object.keys(f).forEach(o=>{const i=j[o];if(!i)return;const m=C.foco_valor==="liquido"?P[o]||0:f[o]||0;if(i.regra_comissionamento==="diferenciado"){const l=T[o];if(!l)return;const r=t[o]||0,_=u[o]||0,p=r>0,e=p?_/r*100:0,w=p?_<r?0:e>=120?l.fix_super_meta??l.fix_meta_atingida??l.fix_meta_nao_atingida??0:l.fix_meta_atingida??l.fix_meta_nao_atingida??0:l.fix_meta_nao_atingida??l.fix_meta_atingida??l.fix_super_meta??0,O=m*(w/100);i.soma_na_meta&&!i.usa_meta_produto?g+=O:x+=O,R[o]=O}else{const l=T[o]?.rule_id,r=l?$[l]:void 0;let _=0;r&&(E<100?_=r.meta_nao_atingida||0:E>=120?_=r.super_meta??r.meta_atingida??r.meta_nao_atingida??0:_=r.meta_atingida??r.meta_nao_atingida??0);const p=m*(_/100);if(g+=p,s&&i.usa_meta_produto&&i.meta_produto_valor&&i.comissao_produto_meta_pct&&(u[o]||0)/i.meta_produto_valor*100>=100){const A=m*((i.comissao_produto_meta_pct||0)/100),J=i.descontar_meta_geral===!1?A:Math.max(A-p,0);L+=J,S[o]=(S[o]||0)+J}}}),{baseMeta:k,totalBruto:y,totalTaxas:M,valorLiquido:G,pctMetaGeral:E,comissaoGeral:g,comissaoDif:x,comissaoMetaProd:s?L:0,totalComissao:s?g+x+L:g+x,comissaoDifDetalhe:R,comissaoMetaProdDetalhe:s?S:{},produtosDiferenciados:N}},[z,C,j,T,U,D,$,s]);if(n)return a.jsx("div",{children:"Carregando permissões..."});if(!v)return a.jsx("div",{children:"Você não possui acesso ao módulo de Vendas."});const h={flexDirection:"column",alignItems:"center",textAlign:"center"},I=s&&d?Object.entries(d.comissaoMetaProdDetalhe||{}).filter(([t])=>j[t]?.exibe_kpi_comissao!==!1):[],ma=d&&d.produtosDiferenciados?d.produtosDiferenciados.filter(t=>j[t]?.exibe_kpi_comissao!==!1):[];return a.jsxs("div",{className:"card-base",style:{background:"transparent",boxShadow:"none",padding:0},children:[a.jsx("div",{className:"card-base",style:{marginBottom:12},children:a.jsxs("div",{className:"form-row",style:{marginBottom:0},children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Período"}),a.jsx("select",{className:"form-select",value:B,onChange:t=>ca(t.target.value),children:ua.map(t=>a.jsx("option",{value:t.id,children:t.label},t.id))})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Início"}),a.jsx("input",{className:"form-input",value:H.inicio,readOnly:!0})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Fim"}),a.jsx("input",{className:"form-input",value:H.fim,readOnly:!0})]})]})}),Y&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:Y})}),K&&a.jsx("div",{children:"Carregando dados..."}),!K&&d&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"card-base",style:{marginBottom:12},children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,marginBottom:16},children:"Como está seu Progresso"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(170px, 1fr))",gap:12,marginBottom:4},children:[a.jsxs("div",{className:"kpi-card",style:{...h,color:"#16a34a"},children:[a.jsx("div",{className:"kpi-label",children:"Meta do mês"}),a.jsx("div",{className:"kpi-value",children:(D?.meta_geral||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...h,color:"#ca8a04"},children:[a.jsx("div",{className:"kpi-label",children:"Total Bruto"}),a.jsx("div",{className:"kpi-value",children:d.totalBruto.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...h,color:"#c2410c"},children:[a.jsx("div",{className:"kpi-label",children:"Total Taxas"}),a.jsx("div",{className:"kpi-value",children:d.totalTaxas.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...h,color:"#0ea5e9"},children:[a.jsx("div",{className:"kpi-label",children:"Valor Liquido"}),a.jsx("div",{className:"kpi-value",children:d.valorLiquido.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),a.jsxs("div",{className:"kpi-card",style:{...h,color:"#2563eb"},children:[a.jsx("div",{className:"kpi-label",children:"Meta atingida"}),a.jsxs("div",{className:"kpi-value",children:[d.pctMetaGeral.toFixed(1),"%"]})]})]})]}),a.jsxs("div",{className:"card-base",children:[a.jsx("div",{style:{textAlign:"center",fontWeight:700,fontSize:18,margin:"0 0 16px"},children:"Seus Valores a Receber"}),s&&I.length>0&&a.jsx("div",{style:{textAlign:"center",color:"#0f172a",marginBottom:8,fontSize:"0.9rem"},children:"Produtos com meta específica"}),a.jsxs("div",{className:"kpi-grid",style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:12},children:[a.jsxs("div",{className:"kpi-card",style:h,children:[a.jsx("div",{className:"kpi-label",children:"Comissão (geral)"}),a.jsx("div",{className:"kpi-value",children:d.comissaoGeral.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]}),s&&I.map(([t,u])=>a.jsxs("div",{className:"kpi-card",style:h,children:[a.jsx("div",{className:"kpi-label",children:j[t]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:u.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),u===0&&a.jsx("small",{style:{color:"#dc2626"},children:"Meta não atingida"})]},`meta-${t}`)),ma.map(t=>a.jsxs("div",{className:"kpi-card",style:h,children:[a.jsx("div",{className:"kpi-label",children:j[t]?.nome||"(produto)"}),a.jsx("div",{className:"kpi-value",children:(d.comissaoDifDetalhe?.[t]||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),(d.comissaoDifDetalhe?.[t]||0)===0&&a.jsx("small",{style:{color:"#dc2626"},children:"Sem comissão"})]},t)),a.jsxs("div",{className:"kpi-card kpi-highlight",style:h,children:[a.jsx("div",{className:"kpi-label",children:"Comissão total"}),a.jsx("div",{className:"kpi-value",children:d.totalComissao.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})})]})]})]})]})]})}export{va as default};
