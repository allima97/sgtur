import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as m}from"./index.C0Fn7Wtz.js";import{s as d}from"./supabase.Ng8nq9tn.js";import{u as $}from"./usePermissao.DiLe8-Rs.js";import{r as F}from"./logs.DwCrXgEk.js";import{L as z}from"./LoadingUsuarioContext.BaDUNi7o.js";const j={id:"",nome:"",descricao:"",tipo:"GERAL",meta_nao_atingida:0,meta_atingida:0,super_meta:0,ativo:!0,tiers:[]};function X(){const{permissao:E,ativo:I,loading:O}=$("Parametros"),r=E==="admin"||E==="edit",[C,k]=m.useState([]),[g,S]=m.useState(!0),[w,o]=m.useState(null),[i,u]=m.useState(j),[N,A]=m.useState(!1),[h,x]=m.useState(null),[L,p]=m.useState(null),[v,y]=m.useState(!1);m.useEffect(()=>{b()},[]);async function b(){try{S(!0),o(null);const{data:a,error:t}=await d.from("commission_rule").select("*, commission_tier(*)").order("created_at",{ascending:!1});if(t)throw t;k(a||[])}catch(a){console.error(a),o("Erro ao carregar regras de comissÃ£o.")}finally{S(!1)}}function f(a,t){u(s=>({...s,[a]:t}))}function P(a){u(t=>({...t,tiers:[...t.tiers||[],{faixa:a,de_pct:0,ate_pct:0,inc_pct_meta:0,inc_pct_comissao:0}]}))}function _(a,t,s){u(l=>{const n=[...l.tiers||[]];return n[a][t]=s,{...l,tiers:n}})}function V(a){u(t=>({...t,tiers:(t.tiers||[]).filter((s,l)=>l!==a)}))}async function q(a){if(a.preventDefault(),!!r){if(p(null),!i.nome.trim()){o("Informe o nome da regra.");return}if(i.tipo==="ESCALONAVEL"){if(!i.tiers||i.tiers.length===0){p("Adicione pelo menos uma faixa PRE ou POS.");return}for(const s of i.tiers)if(s.de_pct>s.ate_pct){p("Em uma faixa, o valor inicial nÃ£o pode ser maior que o final.");return}const t=["PRE","POS"];for(const s of t){const l=(i.tiers||[]).filter(n=>n.faixa===s).sort((n,c)=>n.de_pct-c.de_pct);for(let n=1;n<l.length;n++){const c=l[n-1],R=l[n];if(c.ate_pct>R.de_pct){p(`Faixas ${s} sobrepostas: finalize a faixa anterior em ${c.ate_pct}% antes de iniciar ${R.de_pct}%.`);return}}}}try{A(!0),o(null);const t={nome:i.nome.trim(),descricao:i.descricao||null,tipo:i.tipo,meta_nao_atingida:i.meta_nao_atingida??0,meta_atingida:i.meta_atingida??0,super_meta:i.super_meta??0,ativo:i.ativo};let s=h;if(h){const{error:l}=await d.from("commission_rule").update(t).eq("id",h);if(l)throw l;s=h}else{const{data:l,error:n}=await d.from("commission_rule").insert(t).select("id").single();if(n)throw n;s=l?.id}if(s&&(await d.from("commission_tier").delete().eq("rule_id",s),i.tiers&&i.tiers.length>0)){const l=i.tiers.map(c=>({rule_id:s,faixa:c.faixa,de_pct:Number(c.de_pct)||0,ate_pct:Number(c.ate_pct)||0,inc_pct_meta:Number(c.inc_pct_meta)||0,inc_pct_comissao:Number(c.inc_pct_comissao)||0,ativo:!0})),{error:n}=await d.from("commission_tier").insert(l);if(n)throw n}await F({user_id:(await d.auth.getUser()).data.user?.id||null,acao:h?"commission_rule_editada":"commission_rule_criada",modulo:"Parametros",detalhes:t}),u(j),x(null),await b()}catch(t){console.error(t),o("Erro ao salvar regra.")}finally{A(!1)}}}function T(){u(j),x(null),o(null),p(null),y(!0)}function G(){u(j),x(null),o(null),p(null),y(!1)}async function M(a){if(!r||!confirm("Inativar esta regra?"))return;const{error:t}=await d.from("commission_rule").update({ativo:!1}).eq("id",a);t||b()}async function D(a){if(!r||!confirm("Excluir permanentemente esta regra?"))return;const{error:t}=await d.from("commission_tier").delete().eq("rule_id",a);if(t){o("Erro ao excluir faixas da regra.");return}const{error:s}=await d.from("commission_rule").delete().eq("id",a);if(s){o("Erro ao excluir regra.");return}await F({user_id:(await d.auth.getUser()).data.user?.id||null,acao:"commission_rule_excluida",modulo:"Parametros",detalhes:{id:a}}),b()}function U(a){x(a.id),u({id:a.id,nome:a.nome,descricao:a.descricao||"",tipo:a.tipo,meta_nao_atingida:a.meta_nao_atingida??0,meta_atingida:a.meta_atingida??0,super_meta:a.super_meta??0,ativo:a.ativo,tiers:a.tipo==="ESCALONAVEL"?a.commission_tier?.map(t=>({faixa:t.faixa,de_pct:t.de_pct,ate_pct:t.ate_pct,inc_pct_meta:t.inc_pct_meta,inc_pct_comissao:t.inc_pct_comissao}))||[]:[]}),y(!0),o(null),p(null)}return O?e.jsx(z,{}):I?e.jsxs("div",{className:"card-base card-blue",children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx("h3",{className:"card-title",style:{marginBottom:6},children:"Regras cadastradas"})}),r&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:T,disabled:v,children:"Adicionar regra"})]}),w&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:w})}),v&&L&&e.jsx("div",{className:"card-base card-config mb-2",children:e.jsx("strong",{children:L})}),v&&e.jsxs("form",{onSubmit:q,children:[e.jsxs("div",{className:"form-row",style:{marginTop:12},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:i.nome,onChange:a=>f("nome",a.target.value),required:!0,disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Tipo"}),e.jsxs("select",{className:"form-select",value:i.tipo,onChange:a=>f("tipo",a.target.value==="ESCALONAVEL"?"ESCALONAVEL":"GERAL"),disabled:!r,children:[e.jsx("option",{value:"GERAL",children:"Geral (percentuais fixos)"}),e.jsx("option",{value:"ESCALONAVEL",children:"EscalonÃ¡vel (faixas)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta nÃ£o atingida (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.meta_nao_atingida,onChange:a=>f("meta_nao_atingida",Number(a.target.value)),disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Meta atingida (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.meta_atingida,onChange:a=>f("meta_atingida",Number(a.target.value)),disabled:!r})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Super meta (%)"}),e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:i.super_meta,onChange:a=>f("super_meta",Number(a.target.value)),disabled:!r})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DescriÃ§Ã£o"}),e.jsx("textarea",{className:"form-input",rows:2,value:i.descricao||"",onChange:a=>f("descricao",a.target.value),disabled:!r})]}),i.tipo==="ESCALONAVEL"&&e.jsxs("div",{className:"card-base card-purple mb-2",style:{marginTop:12},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("h4",{style:{margin:0},children:"Faixas (PRE/POS)"}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>P("PRE"),disabled:!r,children:"+ Faixa PRE"}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>P("POS"),disabled:!r,children:"+ Faixa POS"})]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[800px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Faixa"}),e.jsx("th",{children:"De (%)"}),e.jsx("th",{children:"AtÃ© (%)"}),e.jsx("th",{children:"Inc. Meta (%)"}),e.jsx("th",{children:"Inc. ComissÃ£o (%)"}),e.jsx("th",{children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[(!i.tiers||i.tiers.length===0)&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,children:"Nenhuma faixa adicionada."})}),i.tiers?.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.faixa}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.de_pct,onChange:s=>_(t,"de_pct",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.ate_pct,onChange:s=>_(t,"ate_pct",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.inc_pct_meta,onChange:s=>_(t,"inc_pct_meta",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("input",{className:"form-input",type:"number",step:"0.01",value:a.inc_pct_comissao,onChange:s=>_(t,"inc_pct_comissao",Number(s.target.value)),disabled:!r})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn-icon btn-danger",onClick:()=>V(t),disabled:!r,children:"ğŸ—‘ï¸"})})]},t))]})]})})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap mt-2",children:[e.jsx("button",{className:"btn btn-primary",type:"submit",disabled:!r||N,children:N?"Salvando...":h?"Salvar alteraÃ§Ãµes":"Salvar regra"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:G,disabled:N,children:"Cancelar"})]})]}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[900px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{children:"Faixas"}),e.jsx("th",{children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[g&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!g&&C.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma regra cadastrada."})}),!g&&C.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.tipo}),e.jsx("td",{children:a.ativo?"Sim":"NÃ£o"}),e.jsx("td",{children:a.commission_tier?.length||0}),e.jsxs("td",{className:"th-actions",children:[e.jsx("button",{className:"btn-icon",onClick:()=>U(a),title:"Editar",children:"âœï¸"}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>M(a.id),disabled:!r,title:"Inativar",children:"â¸ï¸"}),e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>D(a.id),disabled:!r,title:"Excluir",children:"ğŸ—‘ï¸"})]})]},a.id))]})]})})]}):e.jsx("div",{className:"card-base card-config",children:"Acesso negado ao mÃ³dulo de ParÃ¢metros."})}export{X as default};
