import{j as e,s as c}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as Q}from"./usePermissao.72SYthuA.js";import{r as T}from"./logs.WCvMC_es.js";function N(g){return(g||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const X={nome:"",subdivisao_id:"",descricao:""};function ce(){const g=Q("Cidades"),y=Q("Cadastros"),x=g.isAdmin||y.isAdmin,m=g.loading||y.loading,l=x?"admin":g.permissao!=="none"?g.permissao:y.permissao,f=x||l!=="none",k=x||l==="create"||l==="edit"||l==="delete"||l==="admin",j=x||l==="edit"||l==="delete"||l==="admin",C=x||l==="delete"||l==="admin",[z,Y]=t.useState([]),[q,Z]=t.useState([]),[$,D]=t.useState([]),[h,ee]=t.useState(""),[v,F]=t.useState(X),[_,R]=t.useState(null),[A,u]=t.useState(null),[V,O]=t.useState(!1),[U,W]=t.useState(null),[M,P]=t.useState(!0),[I,B]=t.useState(!1),[re,G]=t.useState(!1);async function S(a=!1){if(!f)return;async function i(){const s="id, nome, subdivisao_id, descricao, created_at",d="id, nome, subdivisao_id, descricao";if(a){const r=[];let o=0;for(;;)try{const{data:p,error:b}=await c.from("cidades").select(s).order("nome").range(o,o+1e3-1);if(b)throw b;if(r.push(...p||[]),!p||p.length<1e3)break;o+=1e3}catch(p){console.warn("[Cidades] Falha na query principal, aplicando fallback.",p);try{const{data:b,error:w}=await c.from("cidades").select(d).order("nome").range(o,o+1e3-1);if(w)throw w;if(r.push(...b||[]),!b||b.length<1e3)break;o+=1e3}catch(b){console.warn("[Cidades] Fallback sem campo descricao.",b);const{data:w,error:K}=await c.from("cidades").select("id, nome, subdivisao_id").order("nome").range(o,o+1e3-1);if(K)throw K;if(r.push(...w||[]),!w||w.length<1e3)break;o+=1e3}}return r}else try{const{data:r,error:n}=await c.from("cidades").select(s).order("created_at",{ascending:!1}).limit(10);if(n)throw n;return r||[]}catch(r){console.warn("[Cidades] created_at indisponivel, ordenando por nome.",r);try{const{data:n,error:o}=await c.from("cidades").select(d).order("nome").limit(10);if(o)throw o;return n||[]}catch(n){console.warn("[Cidades] Fallback sem descricao/nome.",n);const{data:o,error:p}=await c.from("cidades").select("id, nome, subdivisao_id").order("nome").limit(10);if(p)throw p;return o||[]}}}try{P(!0);const[{data:s,error:d},{data:r,error:n},o]=await Promise.all([c.from("paises").select("id, nome").order("nome"),c.from("subdivisoes").select("id, nome, pais_id, codigo_admin1, tipo").order("nome"),i()]);d?u("Erro ao carregar paises."):Y(s||[]),n?u("Erro ao carregar subdivisoes."):Z(r||[]),D(o||[]),B(a)}catch(s){console.error(s),u("Erro ao carregar cidades.")}finally{P(!1)}}t.useEffect(()=>{if(!m){if(!f){P(!1);return}S(!1)}},[m,f]),t.useEffect(()=>{!h.trim()&&!m&&f&&S(!1)},[h,m,f]),t.useEffect(()=>{const a=h.trim();if(!a||m||!f)return;const i=new AbortController;async function s(){G(!0),u(null);try{const{data:d,error:r}=await c.rpc("buscar_cidades",{q:a,limite:200},{signal:i.signal});if(i.signal.aborted)return;if(r)throw r;D((d||[]).map(o=>({id:o.id,nome:o.nome,subdivisao_id:o.subdivisao_id||"",descricao:o.descricao||null,created_at:o.created_at||null,subdivisao_nome:o.subdivisao_nome||"",pais_nome:o.pais_nome||""}))),B(!0)}catch(d){if(i.signal.aborted)return;console.warn("[Cidades] RPC falhou, tentando fallback direto.",d);try{const{data:r,error:n}=await c.from("cidades").select("id, nome, subdivisao_id, descricao, created_at").ilike("nome",`%${a}%`).order("nome");if(n)throw n;D(r||[]),B(!0)}catch(r){console.error(r);const n=r instanceof Error?r.message:"";u(`Erro ao buscar cidades.${n?` Detalhe: ${n}`:""}`)}}finally{i.signal.aborted||G(!1)}}return s(),()=>i.abort()},[h,m,f]);const E=t.useMemo(()=>{const a=new Map(q.map(s=>[s.id,s])),i=new Map(z.map(s=>[s.id,s]));return $.map(s=>{const d=s.subdivisao_id?a.get(s.subdivisao_id):void 0,r=d?i.get(d.pais_id):void 0;return{...s,subdivisao_nome:d?.nome||s.subdivisao_nome||"",pais_nome:r?.nome||s.pais_nome||""}})},[$,q,z]),H=t.useMemo(()=>{if(!h.trim())return E;const a=N(h),i=E.filter(d=>N(d.nome).includes(a)),s=E.filter(d=>!N(d.nome).includes(a)&&(N(d.subdivisao_nome||"").includes(a)||N(d.pais_nome||"").includes(a)));return[...i,...s]},[h,E]);function L(a,i){F(s=>({...s,[a]:i}))}function ae(a){if(!j)return;async function i(){try{let s=a;if(!a.subdivisao_id){const{data:d,error:r}=await c.from("cidades").select("id, nome, subdivisao_id, descricao").eq("id",a.id).maybeSingle();if(r)throw r;d&&(s={...a,subdivisao_id:d.subdivisao_id||"",descricao:d.descricao||""})}R(s.id),F({nome:s.nome,subdivisao_id:s.subdivisao_id||"",descricao:s.descricao||""})}catch(s){console.error(s),u("Nao foi possivel carregar dados da cidade para edicao.")}}i()}function J(){k&&(R(null),F(X))}async function se(a){if(a.preventDefault(),!(!k&&!j)){if(!v.subdivisao_id){u("Subdivisao e obrigatoria.");return}try{O(!0),u(null);const i={nome:v.nome,subdivisao_id:v.subdivisao_id,descricao:v.descricao||null};if(_){const{error:s}=await c.from("cidades").update(i).eq("id",_);if(s)throw s;await T({user_id:null,acao:"cidade_editada",modulo:"Cadastros",detalhes:{id:_,payload:i}})}else{const{error:s}=await c.from("cidades").insert(i);if(s)throw s;await T({user_id:null,acao:"cidade_criada",modulo:"Cadastros",detalhes:i})}J(),S(I)}catch(i){console.error(i),u("Erro ao salvar cidade.")}finally{O(!1)}}}async function ie(a){if(C&&confirm("Excluir cidade?"))try{W(a);const{error:i}=await c.from("cidades").delete().eq("id",a);if(i)throw i;await T({user_id:null,acao:"cidade_excluida",modulo:"Cadastros",detalhes:{id:a}}),S(I)}catch(i){console.error(i),u("Erro ao excluir cidade (provavelmente usada em produtos/destinos).")}finally{W(null)}}return!f&&!x?m?e.jsx("div",{className:"auth-info",children:"Carregando permissoes..."}):e.jsx("div",{className:"auth-error",children:"Voce nao possui permissao para visualizar Cidades."}):e.jsxs("div",{className:"cidades-page",children:[(k||j)&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:se,children:[e.jsx("h3",{children:_?"Editar cidade":"Nova cidade"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:v.nome,onChange:a=>L("nome",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Subdivisao *"}),e.jsxs("select",{className:"form-select",value:v.subdivisao_id,onChange:a=>L("subdivisao_id",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione a subdivisao"}),q.map(a=>e.jsxs("option",{value:a.id,children:[a.nome," - ",z.find(i=>i.id===a.pais_id)?.nome||"Sem pais"]},a.id))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Descricao"}),e.jsx("textarea",{className:"form-input",rows:3,value:v.descricao,onChange:a=>L("descricao",a.target.value)})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",disabled:V,children:V?"Salvando...":_?"Salvar alteracoes":"Adicionar cidade"}),_&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:J,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cidade"}),e.jsx("input",{className:"form-input",placeholder:"Nome, subdivisao ou pais...",value:h,onChange:a=>ee(a.target.value)})]})})}),m&&e.jsx("div",{className:"auth-info mb-3",children:"Carregando permissoes..."}),!m&&A&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:A})}),!I&&!A&&e.jsx("div",{className:"card-base card-config mb-3",children:"Ultimas Cidades Cadastradas (10). Digite na busca para consultar todas."}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cidade"}),e.jsx("th",{children:"Subdivisao"}),e.jsx("th",{children:"Pais"}),e.jsx("th",{children:"Criada em"}),(j||C)&&e.jsx("th",{className:"th-actions",children:"Acoes"})]})}),e.jsxs("tbody",{children:[M&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!M&&H.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma cidade encontrada."})}),!M&&H.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.subdivisao_nome||"-"}),e.jsx("td",{children:a.pais_nome||"-"}),e.jsx("td",{children:a.created_at?a.created_at.slice(0,10):"-"}),(j||C)&&e.jsxs("td",{className:"th-actions",children:[j&&e.jsx("button",{className:"btn-icon",onClick:()=>ae(a),title:"Editar",children:"Editar"}),C&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>ie(a.id),disabled:U===a.id,title:"Excluir",children:U===a.id?"...":"Excluir"})]})]},a.id))]})]})})]})}export{ce as default};
