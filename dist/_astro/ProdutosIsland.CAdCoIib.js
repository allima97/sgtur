import{s as l,j as a}from"./supabase.DNkd6bxA.js";import{r as t}from"./index.C0Fn7Wtz.js";import{u as me}from"./usePermissao.72SYthuA.js";function p(d){return(d||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const Z={nome:"",cidade_id:"",tipo_produto:"",atracao_principal:"",melhor_epoca:"",duracao_sugerida:"",nivel_preco:"",imagem_url:"",informacoes_importantes:"",ativo:!0};function ve(){const{permissao:d,ativo:ee,loading:ae}=me("Cadastros"),[q,oe]=t.useState([]),[D,se]=t.useState([]),[x,A]=t.useState([]),[$,L]=t.useState([]),[R,ie]=t.useState([]),[i,N]=t.useState(Z),[w,re]=t.useState(""),[_,C]=t.useState(""),[te,h]=t.useState(!1),[F,S]=t.useState([]),[B,I]=t.useState(!1),[M,z]=t.useState(!0),[V,U]=t.useState(!1),[E,G]=t.useState(null),[H,O]=t.useState(null),[Y,n]=t.useState(null),[J,y]=t.useState(null);async function k(){const e=[],o=[];z(!0),n(null);try{const[{data:s,error:r},{data:f,error:u},v,b]=await Promise.all([l.from("paises").select("id, nome").order("nome"),l.from("subdivisoes").select("id, nome, pais_id").order("nome"),l.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome").then(async m=>m.error?(o.push(`tipo_produtos: ${m.error.message}`),console.warn("Fallback tipo_produtos por 'tipo':",m.error),await l.from("tipo_produtos").select("id, nome, tipo").order("tipo")):m),l.from("produtos").select("id, nome, cidade_id, tipo_produto, informacoes_importantes, atracao_principal, melhor_epoca, duracao_sugerida, nivel_preco, imagem_url, ativo, created_at").order("nome")]);if(r?(e.push("paises"),r.message&&o.push(`paises: ${r.message}`)):oe(s||[]),u?(e.push("subdivisoes"),u.message&&o.push(`subdivisoes: ${u.message}`)):se(f||[]),b.error)e.push("tipo_produtos"),b.error.message&&o.push(`tipo_produtos: ${b.error.message}`);else{const m=b.data||[];if(m.length===0){const{data:j,error:g}=await l.from("tipo_produtos").select("id, nome, tipo").order("nome");g?(e.push("tipo_produtos"),o.push(`tipo_produtos (fallback): ${g.message}`)):L(j||[])}else L(m)}if(v.error)e.push("produtos"),v.error.message&&o.push(`produtos: ${v.error.message}`);else{const m=v.data||[];ie(m);const j=Array.from(new Set(m.map(g=>g.cidade_id).filter(Boolean)));if(j.length){const{data:g,error:T}=await l.from("cidades").select("id, nome, subdivisao_id").in("id",j);T?(e.push("cidades"),T.message&&o.push(`cidades: ${T.message}`)):A(g||[])}else A([])}}catch(s){console.error(s),e.push("geral"),s?.message&&o.push(`geral: ${s.message}`)}finally{if(e.length){const s=o.length?` Detalhes: ${o.join(" | ")}`:"";n(`Erro ao carregar: ${e.join(", ")}. Verifique permissoes/RLS.${s}`)}z(!1)}}t.useEffect(()=>{k()},[]);const K=t.useMemo(()=>new Map(D.map(e=>[e.id,e])),[D]);function de(e){const o=x.find(r=>r.id===e);if(!o)return"";const s=K.get(o.subdivisao_id);return s?`${o.nome} (${s.nome})`:o.nome}function Q(e){return e&&((e.nome||"").trim()||e.tipo)||""}const P=t.useMemo(()=>{const e=new Map(x.map(r=>[r.id,r])),o=new Map(q.map(r=>[r.id,r])),s=new Map($.map(r=>[r.id,r]));return R.map(r=>{const f=e.get(r.cidade_id||""),u=f?K.get(f.subdivisao_id):void 0,v=u?o.get(u.pais_id):void 0,b=r.tipo_produto?s.get(r.tipo_produto):void 0;return{...r,cidade_nome:f?.nome||"",subdivisao_nome:u?.nome||"",pais_nome:v?.nome||"",tipo_nome:Q(b)}})},[R,x,D,q,$]),W=t.useMemo(()=>{if(!w.trim())return P;const e=p(w);return P.filter(o=>p(o.nome).includes(e)||p(o.cidade_nome).includes(e)||p(o.subdivisao_nome).includes(e)||p(o.pais_nome).includes(e)||p(o.tipo_nome).includes(e))},[w,P]);function c(e,o){N(s=>({...s,[e]:o}))}function le(e){C(e);const o=x.find(s=>s.id===i.cidade_id);(!o||!p(o.nome).includes(p(e)))&&N(s=>({...s,cidade_id:""})),h(!0)}function X(){N(Z),G(null),n(null),C(""),h(!1)}function ne(e){const o=x.find(s=>s.id===e.cidade_id);G(e.id),N({nome:e.nome,cidade_id:e.cidade_id,tipo_produto:e.tipo_produto||"",atracao_principal:e.atracao_principal||"",melhor_epoca:e.melhor_epoca||"",duracao_sugerida:e.duracao_sugerida||"",nivel_preco:e.nivel_preco||"",imagem_url:e.imagem_url||"",informacoes_importantes:e.informacoes_importantes||"",ativo:e.ativo??!0}),C(de(e.cidade_id)||o?.nome||""),h(!1)}t.useEffect(()=>{if(_.trim().length<2){S([]);return}const e=new AbortController,o=setTimeout(async()=>{I(!0),y(null);try{const{data:s,error:r}=await l.rpc("buscar_cidades",{q:_.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(r){console.error("Erro ao buscar cidades:",r),y("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:f,error:u}=await l.from("cidades").select("id, nome, subdivisao_id").ilike("nome",`%${_.trim()}%`).order("nome");u?(console.error("Erro no fallback de cidades:",u),y("Erro ao buscar cidades.")):(S(f||[]),y(null))}else S(s||[])}finally{e.signal.aborted||I(!1)}},300);return()=>{e.abort(),clearTimeout(o)}},[_]);async function ce(e){if(e.preventDefault(),d==="view"){n("Voce nao tem permissao para salvar produtos.");return}if(!i.nome.trim()){n("Nome e obrigatorio.");return}if(!i.cidade_id){n("Cidade e obrigatoria.");return}if(!i.tipo_produto){n("Tipo de produto e obrigatorio.");return}try{U(!0),n(null);const o={nome:i.nome.trim(),cidade_id:i.cidade_id,tipo_produto:i.tipo_produto,atracao_principal:i.atracao_principal.trim()||null,melhor_epoca:i.melhor_epoca.trim()||null,duracao_sugerida:i.duracao_sugerida.trim()||null,nivel_preco:i.nivel_preco.trim()||null,imagem_url:i.imagem_url.trim()||null,informacoes_importantes:i.informacoes_importantes.trim()||null,ativo:i.ativo};if(E){const{error:s}=await l.from("produtos").update(o).eq("id",E);if(s)throw s}else{const{error:s}=await l.from("produtos").insert(o);if(s)throw s}X(),await k()}catch(o){console.error(o),n("Erro ao salvar produto. Verifique os dados e tente novamente.")}finally{U(!1)}}async function ue(e){if(d!=="admin"){alert("Somente administradores podem excluir produtos.");return}if(confirm("Tem certeza que deseja excluir este produto?"))try{O(e),n(null);const{error:o}=await l.from("produtos").delete().eq("id",e);if(o)throw o;await k()}catch(o){console.error(o),n("Nao foi possivel excluir o produto. Verifique vinculos com vendas/orcamentos.")}finally{O(null)}}return ae?a.jsx("div",{children:"Carregando permissoes..."}):ee?a.jsxs("div",{className:"destinos-page",children:[a.jsx("div",{className:"card-base card-blue mb-3",children:a.jsxs("form",{onSubmit:ce,children:[a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nome do produto *"}),a.jsx("input",{className:"form-input",value:i.nome,onChange:e=>c("nome",e.target.value),placeholder:"Ex: Passeio em Gramado, Pacote Paris...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Tipo *"}),a.jsxs("select",{className:"form-select",value:i.tipo_produto,onChange:e=>c("tipo_produto",e.target.value),disabled:d==="view",children:[a.jsx("option",{value:"",children:"Selecione o tipo"}),$.map(e=>a.jsx("option",{value:e.id,children:Q(e)||"(sem nome)"},e.id))]})]})]}),a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",style:{flex:1},children:[a.jsx("label",{className:"form-label",children:"Cidade *"}),a.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:_,onChange:e=>le(e.target.value),onFocus:()=>h(!0),onBlur:()=>setTimeout(()=>h(!1),150),disabled:d==="view",style:{marginBottom:6}}),B&&a.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),J&&!B&&a.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:J}),te&&a.jsxs("div",{className:"card-base",style:{marginTop:4,maxHeight:180,overflowY:"auto",padding:6,border:"1px solid #e5e7eb"},children:[F.length===0&&!B&&a.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),F.map(e=>{const o=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return a.jsxs("button",{type:"button",className:"btn btn-light",style:{width:"100%",justifyContent:"flex-start",marginBottom:4,background:i.cidade_id===e.id?"#e0f2fe":"#fff",borderColor:i.cidade_id===e.id?"#38bdf8":"#e5e7eb"},onMouseDown:s=>{s.preventDefault(),c("cidade_id",e.id),C(o),h(!1),S([])},children:[o,e.pais_nome?a.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["â€¢ ",e.pais_nome]}):null]},e.id)})]})]})}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Atracao principal"}),a.jsx("input",{className:"form-input",value:i.atracao_principal,onChange:e=>c("atracao_principal",e.target.value),placeholder:"Ex: Disney, Torre Eiffel...",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Melhor epoca"}),a.jsx("input",{className:"form-input",value:i.melhor_epoca,onChange:e=>c("melhor_epoca",e.target.value),placeholder:"Ex: Dezembro a Marco",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-row",children:[a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Duracao sugerida"}),a.jsx("input",{className:"form-input",value:i.duracao_sugerida,onChange:e=>c("duracao_sugerida",e.target.value),placeholder:"Ex: 7 dias",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Nivel de preco"}),a.jsx("input",{className:"form-input",value:i.nivel_preco,onChange:e=>c("nivel_preco",e.target.value),placeholder:"Ex: Economico, Intermediario, Premium",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Imagem (URL)"}),a.jsx("input",{className:"form-input",value:i.imagem_url,onChange:e=>c("imagem_url",e.target.value),placeholder:"URL de uma imagem do destino",disabled:d==="view"})]})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Informacoes importantes"}),a.jsx("textarea",{className:"form-input",rows:3,value:i.informacoes_importantes,onChange:e=>c("informacoes_importantes",e.target.value),placeholder:"Observacoes gerais, dicas, documentacao necessaria, etc.",disabled:d==="view"})]}),a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Ativo"}),a.jsxs("select",{className:"form-select",value:i.ativo?"true":"false",onChange:e=>c("ativo",e.target.value==="true"),disabled:d==="view",children:[a.jsx("option",{value:"true",children:"Sim"}),a.jsx("option",{value:"false",children:"Nao"})]})]}),a.jsxs("div",{className:"mt-2",children:[d!=="view"&&a.jsx("button",{type:"submit",className:"btn btn-primary",disabled:V,children:V?"Salvando...":E?"Salvar alteracoes":"Adicionar produto"}),E&&d!=="view"&&a.jsx("button",{type:"button",className:"btn btn-light",style:{marginLeft:8},onClick:X,children:"Cancelar edicao"})]})]})}),a.jsx("div",{className:"card-base mb-3",children:a.jsx("div",{className:"form-row",children:a.jsxs("div",{className:"form-group",children:[a.jsx("label",{className:"form-label",children:"Buscar produto"}),a.jsx("input",{className:"form-input",value:w,onChange:e=>re(e.target.value),placeholder:"Busque por nome, tipo, cidade, subdivisao ou pais..."})]})})}),Y&&a.jsx("div",{className:"card-base card-config mb-3",children:a.jsx("strong",{children:Y})}),a.jsx("div",{className:"table-container overflow-x-auto",children:a.jsxs("table",{className:"table-default table-header-blue min-w-[1080px]",children:[a.jsx("thead",{children:a.jsxs("tr",{children:[a.jsx("th",{children:"Produto"}),a.jsx("th",{children:"Tipo"}),a.jsx("th",{children:"Cidade"}),a.jsx("th",{children:"Subdivisao"}),a.jsx("th",{children:"Pais"}),a.jsx("th",{children:"Nivel de preco"}),a.jsx("th",{children:"Ativo"}),a.jsx("th",{children:"Criado em"}),a.jsx("th",{className:"th-actions",children:"Acoes"})]})}),a.jsxs("tbody",{children:[M&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Carregando produtos..."})}),!M&&W.length===0&&a.jsx("tr",{children:a.jsx("td",{colSpan:9,children:"Nenhum produto encontrado."})}),!M&&W.map(e=>a.jsxs("tr",{children:[a.jsx("td",{children:e.nome}),a.jsx("td",{children:e.tipo_nome||"-"}),a.jsx("td",{children:e.cidade_nome||"-"}),a.jsx("td",{children:e.subdivisao_nome||"-"}),a.jsx("td",{children:e.pais_nome||"-"}),a.jsx("td",{children:e.nivel_preco||"-"}),a.jsx("td",{children:e.ativo?"Sim":"Nao"}),a.jsx("td",{children:e.created_at?new Date(e.created_at).toLocaleDateString("pt-BR"):"-"}),a.jsxs("td",{className:"th-actions",children:[d!=="view"&&a.jsx("button",{className:"btn-icon",title:"Editar",onClick:()=>ne(e),children:"Editar"}),(d==="admin"||d==="delete")&&a.jsx("button",{className:"btn-icon btn-danger",title:"Excluir",onClick:()=>ue(e.id),disabled:H===e.id,children:H===e.id?"...":"Excluir"})]})]},e.id))]})]})})]}):a.jsx("div",{children:"Voce nao possui acesso ao modulo de Cadastros."})}export{ve as default};
