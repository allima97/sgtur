import{j as t}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{s as m}from"./supabase.Ng8nq9tn.js";import{u as Ae}from"./usePermissao.DiLe8-Rs.js";import{r as Ce}from"./logs.DwCrXgEk.js";function I(g){return(g||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}const re={cliente_id:"",destino_id:"",data_lancamento:new Date().toISOString().substring(0,10),data_embarque:""},Ue={produto_id:"",numero_recibo:"",valor_total:"",valor_taxas:"0"};function We(g){const w=g.replace(/\D/g,"");return w?(Number(w)/100).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}):""}function ye(g){const w=Number(g);return Number.isNaN(w)?"":w.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}function Y(g){if(!g)return NaN;const w=g.replace(/\./g,"").replace(",",".");return Number(w)}function oo(){const{permissao:g,ativo:w,loading:U,isAdmin:de}=Ae("Vendas"),se=g==="create"||g==="edit"||g==="delete"||g==="admin",[W,Ee]=r.useState([]),[F,De]=r.useState([]),[b,O]=r.useState([]),[qe,Ve]=r.useState([]),[l,P]=r.useState(re),[v,L]=r.useState([]),[C,Z]=r.useState(null),[ne,ee]=r.useState({id:"",nome:""}),[le,x]=r.useState(null),[ce,B]=r.useState(!1),[Oe,ue]=r.useState(!0),[He,me]=r.useState(!1),[pe,fe]=r.useState([]),[Je,Ie]=r.useState(0),[M,oe]=r.useState(""),[y,z]=r.useState(""),[G,H]=r.useState(""),[Pe,J]=r.useState(!1),[_e,$]=r.useState([]),[K,be]=r.useState(!1),[ve,Q]=r.useState(null),[Ke,ae]=r.useState("");async function Le(e,a){try{ue(!0);const[o,i,n,j]=await Promise.all([m.from("clientes").select("id, nome, cpf").order("nome"),m.from("cidades").select("id, nome").order("nome"),m.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").order("nome"),m.from("tipo_produtos").select("id, nome")]);Ee(o.data||[]);const c=i.data||[];De(c);const S=j.data||[],q=(n.data||[]).map(p=>({...p,todas_as_cidades:p.todas_as_cidades??!1}));O(q),Ve(S),e&&await Te(e,c,q,a)}catch(o){console.error(o),x("Erro ao carregar dados."),N("Erro ao carregar dados.","error")}finally{ue(!1)}}async function Te(e,a,o,i){try{me(!0);const{data:n,error:j}=await m.from("vendas").select("id, cliente_id, destino_id, destino_cidade_id, data_lancamento, data_embarque").eq("id",e).maybeSingle();if(j)throw j;if(!n){x("Venda n√£o encontrada para edi√ß√£o.");return}let c=n.destino_cidade_id||"",S="";if(c){const s=(a||F).find(f=>f.id===c);s&&(S=s.nome)}else if(n.destino_id){const{data:d}=await m.from("produtos").select("id, cidade_id").eq("id",n.destino_id).maybeSingle();c=d?.cidade_id||"";const f=(a||F).find(D=>D.id===c);f&&(S=f.nome)}!c&&i?.id&&(c=i.id),!S&&i?.nome&&(S=i.nome),P({cliente_id:n.cliente_id,destino_id:c,data_lancamento:n.data_lancamento,data_embarque:n.data_embarque||""}),z(S||c||""),ae(S||c||"");const{data:q,error:p}=await m.from("vendas_recibos").select("*").eq("venda_id",e);if(p)throw p;const u=o||b;L((q||[]).map(d=>({id:d.id,produto_id:u.find(s=>{const f=!!s.todas_as_cidades;return s.tipo_produto===d.produto_id&&(f||!c||s.cidade_id===c)})?.id||"",numero_recibo:d.numero_recibo||"",valor_total:d.valor_total!=null?ye(d.valor_total):"",valor_taxas:d.valor_taxas!=null?ye(d.valor_taxas):"0,00"})))}catch(n){console.error(n),x("Erro ao carregar venda para edi√ß√£o."),N("Erro ao carregar venda para edi√ß√£o.","error")}finally{me(!1)}}r.useEffect(()=>{const e=new URLSearchParams(window.location.search),a=e.get("id");a&&Z(a);const o=e.get("cidadeId")||"",i=e.get("cidadeNome")||"";(o||i)&&ee({id:o,nome:i})},[]),r.useEffect(()=>{!U&&w&&Le(C||void 0,ne)},[U,w,C,ne]),r.useEffect(()=>{if(y.trim().length<2){$([]);return}const e=new AbortController,a=setTimeout(async()=>{be(!0),Q(null);try{const{data:o,error:i}=await m.rpc("buscar_cidades",{q:y.trim(),limite:10},{signal:e.signal});if(!e.signal.aborted)if(i){console.error("Erro ao buscar cidades:",i),Q("Erro ao buscar cidades (RPC). Tentando fallback...");const{data:n,error:j}=await m.from("cidades").select("id, nome").ilike("nome",`%${y.trim()}%`).order("nome");j?(console.error("Erro no fallback de cidades:",j),Q("Erro ao buscar cidades.")):($(n||[]),Q(null))}else $(o||[])}finally{e.signal.aborted||be(!1)}},300);return()=>{e.abort(),clearTimeout(a)}},[y]);const X=e=>e.replace(/\D/g,""),he=r.useMemo(()=>{if(!M.trim())return W;const e=I(M);return W.filter(a=>{const o=X(a.cpf||"");return I(a.nome).includes(e)||o.includes(X(e))})},[W,M]);r.useMemo(()=>{if(!y.trim())return F;const e=I(y);return F.filter(a=>I(a.nome).includes(e))},[F,y]);const ge=r.useMemo(()=>{const e=l.destino_id?b.filter(o=>o.todas_as_cidades||o.cidade_id===l.destino_id):b.filter(o=>o.todas_as_cidades);if(!G.trim())return e;const a=I(G);return e.filter(o=>I(o.nome).includes(a))},[b,G,l.destino_id]),xe=r.useMemo(()=>b.some(e=>!!e.todas_as_cidades),[b]),Re=r.useMemo(()=>v.length>0,[v.length]);function Fe(e){z(e);const a=F.find(o=>o.id===l.destino_id);(!a||!I(a.nome).includes(I(e)))&&P(o=>({...o,destino_id:""})),J(!0)}function N(e,a="success"){Ie(o=>{const i=o+1;return fe(n=>[...n,{id:i,message:e,type:a}]),setTimeout(()=>{fe(n=>n.filter(j=>j.id!==i))},3500),i})}function Be(){L(e=>[...e,{...Ue}])}function te(e,a,o){L(i=>{const n=[...i];return n[e][a]=o,n})}function we(e,a,o){const i=We(o);te(e,a,i)}r.useEffect(()=>{H(""),L(e=>e.map(a=>{const o=b.find(n=>n.id===a.produto_id),i=!!o?.todas_as_cidades;return o&&(i||o.cidade_id===l.destino_id)?a:{...a,produto_id:""}}))},[l.destino_id,b]);function Me(e){L(a=>a.filter((o,i)=>i!==e))}function Ne(){P({...re,data_lancamento:new Date().toISOString().substring(0,10)}),L([]),Z(null),ee({id:"",nome:""}),oe(""),z(""),H(""),ae(""),$([]),x(null),window.location.href="/vendas/consulta"}function $e(){P(re),L([]),Z(null),ee({id:"",nome:""}),oe(""),z(""),H(""),ae(""),$([]),x(null),window.location.href="/vendas/consulta"}async function ke(e){if(e.preventDefault(),!se&&!de){x("Voc√™ n√£o possui permiss√£o para cadastrar vendas."),N("Voc√™ n√£o possui permiss√£o para cadastrar vendas.","error");return}if(v.length===0){x("Uma venda precisa ter ao menos 1 recibo."),N("Inclua ao menos um recibo na venda.","error");return}try{B(!0),x(null);const{data:a}=await m.auth.getUser(),o=a?.user?.id;if(!o){x("Usu√°rio n√£o autenticado."),N("Usu√°rio n√£o autenticado.","error"),B(!1);return}if(!v.length){x("Uma venda precisa ter ao menos 1 recibo."),N("Inclua ao menos um recibo na venda.","error"),B(!1);return}if(!v[0]?.produto_id){x("Selecione um produto para o recibo. O primeiro recibo define o destino da venda."),N("Selecione um produto para o recibo principal.","error"),B(!1);return}if(v.some(p=>{const u=b.find(s=>s.id===p.produto_id),d=!!u?.todas_as_cidades||(p.produto_id||"").startsWith("virtual-");return u?.cidade_id&&!d})&&!l.destino_id){x("Selecione a cidade de destino para vendas com produtos vinculados a cidade."),N("Selecione a cidade de destino.","error"),B(!1);return}async function j(p){const u=p.produto_id,d=b.find(_=>_.id===u);if(d&&!d.isVirtual)return d.id;const s=d?.tipo_produto||(u?.startsWith("virtual-")?u.replace("virtual-",""):d?.tipo_produto);if(!s)throw new Error("Produto inv√°lido. Selecione novamente.");const f=l.destino_id;if(!f)throw new Error("Selecione a cidade de destino para usar produtos globais.");const D=qe.find(_=>_.id===s),T=!!d?.todas_as_cidades,V=b.find(_=>_.tipo_produto===s&&_.cidade_id===f&&!_.todas_as_cidades);if(V)return V.id;if(T){const _=b.find(k=>k.tipo_produto===s&&!!k.todas_as_cidades);if(_)return _.id;const{data:E,error:Se}=await m.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").eq("tipo_produto",s).eq("todas_as_cidades",!0).limit(1).maybeSingle();if(Se)throw Se;if(E?.id)return O(k=>k.some(Ge=>Ge.id===E.id)?k:[...k,{id:E.id,nome:E.nome,cidade_id:E.cidade_id,tipo_produto:E.tipo_produto,todas_as_cidades:!!E.todas_as_cidades}]),E.id;throw new Error("Produto global selecionado n√£o possui cadastro na tabela de Produtos; cadastre o servi√ßo como global antes de continuar.")}const{data:h,error:R}=await m.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").eq("tipo_produto",s).eq("cidade_id",f).limit(1).maybeSingle();if(R)throw R;if(h?.id)return O(_=>_.some(E=>E.id===h.id)?_:[..._,{id:h.id,nome:h.nome,cidade_id:h.cidade_id,tipo_produto:h.tipo_produto,todas_as_cidades:!!h.todas_as_cidades}]),h.id;const A=D?.nome||"Produto",{data:ze,error:je}=await m.from("produtos").insert({nome:A,destino:A,cidade_id:f,tipo_produto:s,ativo:!0,todas_as_cidades:!1}).select("id").single();if(je)throw je;const ie=ze?.id;if(ie)return O(_=>[..._,{id:ie,nome:A,cidade_id:f,tipo_produto:s,todas_as_cidades:!1}]),ie;throw new Error("N√£o foi poss√≠vel criar produto local.")}const c=[];for(const p of v){const u=await j(p);c.push(u)}const S=c[0];let q=C;if(C){const{error:p}=await m.from("vendas").update({cliente_id:l.cliente_id,destino_id:S,destino_cidade_id:l.destino_id||null,data_lancamento:l.data_lancamento,data_embarque:l.data_embarque||null}).eq("id",C);if(p)throw p;await m.from("vendas_recibos").delete().eq("venda_id",C);for(let u=0;u<v.length;u++){const d=v[u],s=c[u],f=b.find(R=>R.id===s),D=f?.tipo_produto||(d.produto_id?.startsWith("virtual-")?d.produto_id.replace("virtual-",""):f?.tipo_produto);if(!D)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const T=Y(d.valor_total),V=Y(d.valor_taxas);if(Number.isNaN(T))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(V))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:h}=await m.from("vendas_recibos").insert({venda_id:C,produto_id:D,numero_recibo:d.numero_recibo.trim(),valor_total:T,valor_taxas:V});if(h)throw h}await Ce({acao:"venda_atualizada",modulo:"Vendas",detalhes:{id:C,venda:l,recibos:v}}),N("Venda atualizada com sucesso!","success"),setTimeout(()=>Ne(),200)}else{const{data:p,error:u}=await m.from("vendas").insert({vendedor_id:o,cliente_id:l.cliente_id,destino_id:S,destino_cidade_id:l.destino_id||null,data_lancamento:l.data_lancamento,data_embarque:l.data_embarque||null}).select().single();if(u)throw u;q=p.id;for(let d=0;d<v.length;d++){const s=v[d],f=c[d],D=b.find(A=>A.id===f),T=D?.tipo_produto||(s.produto_id?.startsWith("virtual-")?s.produto_id.replace("virtual-",""):D?.tipo_produto);if(!T)throw new Error("Produto do recibo n√£o possui tipo vinculado.");const V=Y(s.valor_total),h=Y(s.valor_taxas);if(Number.isNaN(V))throw new Error("Valor total inv√°lido. Digite um valor monet√°rio.");if(Number.isNaN(h))throw new Error("Valor de taxas inv√°lido. Digite um valor monet√°rio.");const{error:R}=await m.from("vendas_recibos").insert({venda_id:q,produto_id:T,numero_recibo:s.numero_recibo.trim(),valor_total:V,valor_taxas:h});if(R)throw R}await Ce({acao:"venda_criada",modulo:"Vendas",detalhes:{venda:l,recibos:v,id:q}}),N("Venda cadastrada com sucesso!","success"),setTimeout(()=>Ne(),200)}}catch(a){console.error(a);const o=a?.message||a?.error?.message||"",i=a?.code||a?.error?.code||"";x(`Erro ao salvar venda.${i?` C√≥digo: ${i}.`:""}${o?` Detalhes: ${o}`:""}`),N("Erro ao salvar venda.","error")}finally{B(!1)}}return w?!se&&!de?t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para cadastrar vendas."})}):t.jsxs("div",{className:"min-h-screen bg-slate-50 p-2 md:p-6",children:[t.jsxs("div",{className:"card-base card-green mb-3",children:[t.jsx("h3",{children:C?"Editar venda":"Cadastro de Venda"}),C&&t.jsx("small",{style:{color:"#0f172a"},children:"Modo edi√ß√£o ‚Äî altere cliente, cidade de destino, embarque e recibos."}),le&&t.jsx("div",{className:"card-base card-config mb-3",children:t.jsx("strong",{children:le})}),t.jsxs("form",{onSubmit:ke,children:[t.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[t.jsxs("div",{className:"form-group flex-1 min-w-[220px]",children:[t.jsx("label",{className:"form-label",children:"Cliente *"}),t.jsx("input",{className:"form-input",list:"listaClientes",placeholder:"Buscar cliente...",value:W.find(e=>e.id===l.cliente_id)?.nome||M,onChange:e=>oe(e.target.value),onBlur:()=>{const e=M.toLowerCase(),a=X(M),o=he.find(i=>{const n=X(i.cpf||"");return i.nome.toLowerCase()===e||a&&n===a});o&&P({...l,cliente_id:o.id})},required:!0}),t.jsx("datalist",{id:"listaClientes",children:he.map(e=>t.jsx("option",{value:e.nome,label:e.cpf?`CPF: ${e.cpf}`:void 0},e.id))})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[220px] relative",children:[t.jsx("label",{className:"form-label",children:"Cidade de Destino *"}),t.jsx("input",{className:"form-input",placeholder:"Digite o nome da cidade",value:y,onChange:e=>Fe(e.target.value),onFocus:()=>J(!0),onBlur:()=>setTimeout(()=>J(!1),150),required:Re,style:{marginBottom:6}}),K&&t.jsx("div",{style:{fontSize:12,color:"#6b7280"},children:"Buscando..."}),ve&&!K&&t.jsx("div",{style:{fontSize:12,color:"#dc2626"},children:ve}),Pe&&(K||y.trim().length>=2)&&t.jsxs("div",{className:"card-base absolute left-0 right-0 mt-1 max-h-44 overflow-y-auto p-1 border border-slate-200 bg-white z-10",children:[_e.length===0&&!K&&y.trim().length>=2&&t.jsx("div",{style:{padding:"4px 6px",color:"#6b7280"},children:"Nenhuma cidade encontrada."}),_e.map(e=>{const a=e.subdivisao_nome?`${e.nome} (${e.subdivisao_nome})`:e.nome;return t.jsxs("button",{type:"button",className:`btn btn-light w-full justify-start mb-1 ${l.destino_id===e.id?"bg-sky-100 border-sky-400":"bg-white border-slate-200"}`,onMouseDown:o=>{o.preventDefault(),P(i=>({...i,destino_id:e.id})),z(a),J(!1),$([])},children:[a,e.pais_nome?t.jsxs("span",{style:{color:"#6b7280",marginLeft:6},children:["‚Ä¢ ",e.pais_nome]}):null]},e.id)})]})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[t.jsx("label",{className:"form-label",children:"Data de embarque"}),t.jsx("input",{className:"form-input",type:"date",value:l.data_embarque,onChange:e=>P({...l,data_embarque:e.target.value})})]})]}),t.jsx("h4",{className:"mt-3 font-semibold text-lg",children:"Recibos da Venda"}),v.map((e,a)=>t.jsx("div",{className:"card-base mb-2",children:t.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[t.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[t.jsx("label",{className:"form-label",children:"Produto *"}),t.jsx("input",{className:"form-input",list:`listaProdutos-${a}`,placeholder:xe?"Escolha uma cidade ou selecione um produto global...":"Selecione uma cidade primeiro e busque o produto...",value:b.find(o=>o.id===e.produto_id)?.nome||G,onChange:o=>H(o.target.value),onBlur:()=>{const o=ge.find(i=>i.nome.toLowerCase()===G.toLowerCase());o&&te(a,"produto_id",o.id)},required:!0,disabled:!l.destino_id&&!xe}),t.jsx("datalist",{id:`listaProdutos-${a}`,children:ge.map(o=>t.jsx("option",{value:o.nome},o.id))})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"N√∫mero recibo *"}),t.jsx("input",{className:"form-input",value:e.numero_recibo,onChange:o=>te(a,"numero_recibo",o.target.value),required:!0})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"Valor total *"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_total,onChange:o=>we(a,"valor_total",o.target.value),required:!0})]}),t.jsxs("div",{className:"form-group flex-1 min-w-[120px]",children:[t.jsx("label",{className:"form-label",children:"Taxas"}),t.jsx("input",{className:"form-input",type:"text",inputMode:"decimal",pattern:"[0-9,.]*",placeholder:"0,00",value:e.valor_taxas,onChange:o=>we(a,"valor_taxas",o.target.value)})]}),t.jsx("div",{className:"form-group flex-none w-20 flex items-end",children:t.jsx("button",{type:"button",className:"btn-icon btn-danger mt-2",onClick:()=>Me(a),children:"üóëÔ∏è"})})]})},a)),t.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[t.jsx("button",{type:"button",className:"btn btn-primary",onClick:Be,children:"‚ûï Adicionar recibo"}),t.jsx("button",{type:"submit",className:"btn btn-success",disabled:ce,children:ce?"Salvando...":"Salvar venda"}),t.jsx("button",{type:"button",className:"btn btn-outline bg-slate-100 text-slate-800",onClick:$e,children:"Cancelar"})]})]})]}),pe.length>0&&t.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:pe.map(e=>t.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:e.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${e.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:e.message},e.id))})]}):t.jsx("div",{className:"card-base card-config",children:t.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{oo as default};
