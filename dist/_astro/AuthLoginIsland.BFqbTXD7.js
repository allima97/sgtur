import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as i}from"./index.C0Fn7Wtz.js";import{s as r}from"./supabase.Ng8nq9tn.js";import{r as u}from"./logs.DwCrXgEk.js";import{S as F}from"./systemName.C2UUyvSH.js";function G(){const[c,_]=i.useState(""),[j,E]=i.useState(""),[v,C]=i.useState(""),[f,h]=i.useState(null),[w,o]=i.useState(!1),[k,N]=i.useState(!1);async function A(){try{return(await(await fetch("https://api.ipify.org?format=json")).json()).ip||""}catch{return""}}function n(a,s="danger"){h({texto:a,tipo:s}),setTimeout(()=>h(null),5e3)}i.useEffect(()=>{if(typeof window>"u")return;const a=new URLSearchParams(window.location.search);if(a.get("type")==="signup"){n("E-mail confirmado! Faça login para continuar.","success"),["type","access_token","token"].forEach(l=>a.delete(l));const s=a.toString(),d=window.location.pathname+(s?`?${s}`:"");window.history.replaceState({},"",d)}},[]);function q(){N(!0)}function b(){N(!1)}async function L(a){a.preventDefault(),C(""),h(null),o(!0);const s=c.trim().toLowerCase(),d=j;if(!s||!d){n("Informe e-mail e senha"),o(!1);return}const l=await A(),p=typeof navigator<"u"?navigator.userAgent:"";try{await u({user_id:null,acao:"tentativa_login",modulo:"login",detalhes:{email:s}});const{data:g,error:y}=await r.auth.signInWithPassword({email:s,password:d});if(y){await u({user_id:null,acao:"login_falhou",modulo:"login",detalhes:{email:c,motivo:y.message,ip:l,userAgent:p}}),n("E-mail ou senha incorretos. Verifique seus dados e tente novamente."),o(!1);return}const m=g.user?.id||null;await u({user_id:m,acao:"login_sucesso",modulo:"login",detalhes:{email:s,userId:m,ip:l,userAgent:p}});const{data:S}=await r.auth.getUser();if(!!!(S?.user?.email_confirmed_at||S?.user?.confirmed_at)){await r.auth.signOut(),n("Confirme seu e-mail antes de acessar o sistema.","warning"),o(!1);return}const{data:M,error:x}=await r.from("users").select("nome_completo, active, company_id, cpf, telefone, cidade, estado, uso_individual").eq("id",m).maybeSingle();let t=M;if(x&&(x.code==="42703"||x.message?.toLowerCase().includes("active"))){const{data:I}=await r.from("users").select("nome_completo, company_id, cpf, telefone, cidade, estado, uso_individual").eq("id",m).maybeSingle();t=I}if(!t){n("Não foi possível carregar seu perfil. Tente novamente."),o(!1);return}if(t&&t.active===!1){q(),await r.auth.signOut(),o(!1);return}if(!t.nome_completo||!t.telefone||!t.cidade||!t.estado||t.uso_individual===null||t.uso_individual===void 0){window.location.replace("/perfil?onboarding=1");return}window.location.replace("/dashboard")}catch(g){await u({user_id:null,acao:"login_erro_interno",modulo:"login",detalhes:{email:c,erro:g.message,ip:l,userAgent:p}}),n("Erro inesperado ao fazer login.")}finally{o(!1)}}return e.jsx("div",{className:"auth-container",children:e.jsxs("div",{className:"auth-card auth-card-lg",children:[e.jsxs("div",{className:"auth-header",children:[e.jsx("div",{className:"auth-icon",children:e.jsx("i",{className:"fa-solid fa-plane-departure","aria-hidden":!0})}),e.jsx("h1",{children:`Bem-vindo ao ${F}`}),e.jsx("h2",{children:"Sistema de Gerenciamento de Vendas para Turismo"}),e.jsx("p",{className:"auth-subtitle",children:"Use seu e-mail e senha para acessar ou faça seu cadastro"})]}),f&&e.jsx("div",{className:`alert alert-${f.tipo}`,style:{marginBottom:12},children:f.texto}),v&&e.jsx("div",{className:"alert alert-danger",style:{marginBottom:16},children:v}),k&&e.jsxs("div",{className:"modal",children:[e.jsx("div",{className:"modal-overlay",onClick:b}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("i",{className:"fa-solid fa-triangle-exclamation text-yellow-600"}),e.jsx("h2",{children:"Acesso Suspenso"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{className:"text-lg font-semibold mb-4",children:"Atenção!"}),e.jsx("p",{className:"text-gray-700 mb-6",children:"Seu acesso está suspenso, por favor entrar em contato com o Gestor ou Administrador do sistema."}),e.jsxs("div",{className:"contact-info",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Se você acredita que isto é um erro, entre em contato:"}),e.jsxs("ul",{className:"mt-3 space-y-2 text-sm",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Email:"})," suporte@sgtur.com"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Telefone:"})," (11) 1234-5678"]})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{onClick:b,className:"btn btn-secondary",children:"Fechar"})})]})]}),e.jsxs("form",{onSubmit:L,className:"auth-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"email",children:[e.jsx("i",{className:"fa-solid fa-envelope"})," E-mail"]}),e.jsx("input",{type:"email",id:"email",className:"form-input",placeholder:"seu@email.com",required:!0,autoComplete:"email",value:c,onChange:a=>_(a.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"senha",children:[e.jsx("i",{className:"fa-solid fa-lock"})," Senha"]}),e.jsx("input",{type:"password",id:"senha",className:"form-input",placeholder:"Digite sua senha",required:!0,autoComplete:"current-password",value:j,onChange:a=>E(a.target.value)})]}),e.jsx("div",{className:"auth-links auth-links-forgot",children:e.jsxs("a",{href:"/auth/recover",children:[e.jsx("i",{className:"fa-solid fa-unlock-keyhole"}),"Esqueceu a senha? Redefinir"]})}),e.jsxs("div",{className:"auth-actions",children:[e.jsxs("button",{type:"submit",className:"btn btn-primary btn-block",disabled:w,children:[e.jsx("i",{className:"fa-solid fa-right-to-bracket"}),w?" Entrando...":" Entrar"]}),e.jsxs("a",{href:"/auth/register",className:"btn btn-secondary btn-block",children:[e.jsx("i",{className:"fa-solid fa-user-plus"}),"Criar Nova Conta"]})]})]})]})})}export{G as default};
