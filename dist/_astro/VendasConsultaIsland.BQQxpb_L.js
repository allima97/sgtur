import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as d}from"./index.C0Fn7Wtz.js";import{s as x}from"./supabase.Ng8nq9tn.js";import{r as T}from"./logs.DwCrXgEk.js";import{u as he}from"./usePermissao.DiLe8-Rs.js";import{L as fe}from"./LoadingUsuarioContext.BaDUNi7o.js";function V(u){return(u||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase()}function ye(){const{permissao:u,ativo:Z,loading:A,isAdmin:ee}=he("Vendas"),N=u!=="none",ae=u==="create"||u==="edit"||u==="delete"||u==="admin",q=u==="edit"||u==="delete"||u==="admin",b=u==="delete"||u==="admin",[h,te]=d.useState(null),[se,B]=d.useState(!0),[I,ne]=d.useState([]),[de,M]=d.useState([]),[E,ie]=d.useState(""),[$,_]=d.useState(null),[L,F]=d.useState(!0),[O,U]=d.useState(null),[i,S]=d.useState(null),[k,W]=d.useState(!1),[P,z]=d.useState(!1),[G,H]=d.useState(null),[Y,J]=d.useState([]),[oe,re]=d.useState(0);d.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("id");t&&U(t)},[]),d.useEffect(()=>{async function a(){try{_(null),B(!0);const{data:t}=await x.auth.getUser(),n=t?.user?.id;if(!n){_("Usu√°rio n√£o autenticado.");return}const{data:o}=await x.from("users").select("id, user_types(name)").eq("id",n).maybeSingle(),r=o?.user_types?.name||t?.user?.user_metadata?.name||"",c=String(r||"").toUpperCase();let f="VENDEDOR";c.includes("ADMIN")?f="ADMIN":c.includes("GESTOR")?f="GESTOR":c.includes("VENDEDOR")?f="VENDEDOR":f="OUTRO";let s=[n];if(f==="GESTOR"){const{data:l}=await x.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",n),j=l?.map(v=>v.vendedor_id).filter(v=>!!v)||[];s=Array.from(new Set([n,...j]))}else f==="ADMIN"&&(s=[]);te({usuarioId:n,papel:f,vendedorIds:s})}catch(t){console.error(t),_("Erro ao carregar contexto do usu√°rio.")}finally{B(!1)}}a()},[]);async function w(){if(!(!N||!h))try{F(!0);let a=x.from("vendas").select(`
          id,
          vendedor_id,
          cliente_id,
          destino_id,
          destino_cidade_id,
          data_lancamento,
          data_embarque,
          clientes(nome),
          destinos:produtos!destino_id (
            nome,
            cidade_id
          )
        `).order("data_lancamento",{ascending:!1});h.papel!=="ADMIN"&&(a=a.in("vendedor_id",h.vendedorIds));const{data:t,error:n}=await a;if(n)throw n;const o=Array.from(new Set((t||[]).map(s=>s.destino_cidade_id||s.destinos?.cidade_id).filter(s=>!!s)));let r={};if(o.length>0){const{data:s,error:l}=await x.from("cidades").select("id, nome").in("id",o);l?console.error(l):r=Object.fromEntries((s||[]).map(j=>[j.id,j.nome]))}const c=(t||[]).map(s=>{const l=s.destino_cidade_id||s.destinos?.cidade_id||"";return{id:s.id,vendedor_id:s.vendedor_id,cliente_id:s.cliente_id,destino_id:s.destino_id,destino_cidade_id:l,data_lancamento:s.data_lancamento,data_embarque:s.data_embarque,cliente_nome:s.clientes?.nome||"",destino_nome:s.destinos?.nome||"",destino_cidade_nome:l&&r[l]||""}});ne(c);const f=c.map(s=>s.id);if(f.length===0)M([]);else{const{data:s}=await x.from("vendas_recibos").select("*").in("venda_id",f),l=Array.from(new Set((s||[]).map(m=>m.produto_id).filter(m=>!!m))),j=c.reduce((m,p)=>(p.destino_cidade_id&&(m[p.id]=p.destino_cidade_id),m),{});let v=[],X={};if(l.length>0){const{data:m,error:p}=await x.from("produtos").select("id, nome, cidade_id, tipo_produto, todas_as_cidades").in("tipo_produto",l);!p&&m?v=m:p&&console.error(p);const{data:R,error:D}=await x.from("tipo_produtos").select("id, nome").in("id",l);!D&&R?X=Object.fromEntries(R.map(y=>[y.id,y.nome||"Produto"])):D&&console.error(D)}const ue=(s||[]).map(m=>{const p=j[m.venda_id]||"",R=v.find(y=>{const xe=!!y?.todas_as_cidades;return y.tipo_produto===m.produto_id&&(xe||!p||y.cidade_id===p)}),D=X[m.produto_id];return{...m,produto_nome:R?.nome||D||""}})||[];M(ue)}if(O){const s=c.find(l=>l.id===O);s&&S(s),U(null)}}catch(a){console.error(a),_("Erro ao carregar vendas."),g("Erro ao carregar vendas.","error")}finally{F(!1)}}d.useEffect(()=>{!A&&N&&h&&w()},[A,N,h]);const K=d.useMemo(()=>h?h.papel==="ADMIN"?"Todas as vendas":h.papel==="GESTOR"?"Vendas da sua equipe":"Suas vendas":"",[h]),Q=d.useMemo(()=>{if(!E.trim())return I;const a=V(E);return I.filter(t=>V(t.cliente_nome||"").includes(a)||V(t.destino_nome||"").includes(a)||V(t.id).includes(a))},[I,E]);function C(a){return de.filter(t=>t.venda_id===a)}function g(a,t="success"){re(o=>o+1);const n=oe+1;J(o=>[...o,{id:n,message:a,type:t}]),setTimeout(()=>{J(o=>o.filter(r=>r.id!==n))},3500)}async function ce(a){if(!(!b&&!ee)&&confirm("Tem certeza que deseja CANCELAR esta venda?"))try{z(!0),await x.from("vendas_recibos").delete().eq("venda_id",a.id),await x.from("vendas").delete().eq("id",a.id),await T({acao:"venda_cancelada",modulo:"Vendas",detalhes:{id:a.id}}),await w(),S(null),g("Venda cancelada.","success")}catch(t){console.error(t),_("Erro ao cancelar venda."),g("Erro ao cancelar venda.","error")}finally{z(!1)}}async function le(a,t){if(b&&confirm("Excluir este recibo?"))try{H(a),await x.from("vendas_recibos").delete().eq("id",a),await T({acao:"recibo_excluido",modulo:"Vendas",detalhes:{recibo_id:a,venda_id:t}}),await w(),g("Recibo exclu√≠do.","success")}catch(n){console.error(n),_("Erro ao excluir recibo."),g("Erro ao excluir recibo.","error")}finally{H(null)}}async function me(a,t){if(q)try{W(!0),await x.from("vendas").update({data_embarque:t}).eq("id",a.id),await T({acao:"venda_remarcada",modulo:"Vendas",detalhes:{venda_id:a.id,nova_data:t}}),await w(),g("Data de embarque atualizada.","success")}catch(n){console.error(n),_("Erro ao remarcar venda."),g("Erro ao remarcar.","error")}finally{W(!1)}}return se||A?e.jsx(fe,{}):Z?N?e.jsxs("div",{className:"vendas-consulta-page",children:[e.jsx("div",{className:"card-base mb-3",children:e.jsxs("div",{className:"form-row",style:{marginTop:8,display:"flex",alignItems:"end",gap:16,flexWrap:"wrap"},children:[e.jsxs("div",{className:"form-group",style:{flex:1,minWidth:0},children:[e.jsx("label",{className:"form-label",children:"Buscar venda"}),e.jsx("input",{className:"form-input",placeholder:"Nome, destino ou ID...",value:E,onChange:a=>ie(a.target.value)}),K&&e.jsxs("small",{style:{color:"#64748b"},children:[K," ",h?.papel!=="ADMIN"?"(restri√ß√£o por vendedor)":""]})]}),ae&&e.jsx("div",{className:"form-group",style:{display:"flex",flexDirection:"row",gap:8,marginBottom:0,marginLeft:"auto",flexWrap:"nowrap",justifyContent:"flex-end",alignItems:"center",alignSelf:"center",marginTop:-4},children:e.jsx("a",{className:"btn btn-primary",href:"/vendas/cadastro",style:{textDecoration:"none"},children:"Nova venda"})})]})}),$&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:$})}),e.jsx("div",{className:"table-container overflow-x-auto",style:{maxHeight:"65vh",overflowY:"auto"},children:e.jsxs("table",{className:"table-default table-header-green min-w-[820px]",children:[e.jsx("thead",{style:{position:"sticky",top:0,zIndex:1},children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cliente"}),e.jsx("th",{children:"Destino"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{style:{textAlign:"center"},children:"Embarque"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),N&&e.jsx("th",{className:"th-actions",style:{textAlign:"center"},children:"A√ß√µes"})]})}),e.jsxs("tbody",{children:[L&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Carregando..."})}),!L&&Q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,children:"Nenhuma venda encontrada."})}),!L&&Q.map(a=>{const t=C(a.id).reduce((r,c)=>r+(c.valor_total||0),0),n=C(a.id).reduce((r,c)=>r+(c.valor_taxas||0),0),o=C(a.id).map(r=>r.produto_nome||"").filter(Boolean);return e.jsxs("tr",{children:[e.jsx("td",{children:a.cliente_nome}),e.jsx("td",{children:a.destino_cidade_nome||"-"}),e.jsx("td",{children:o.length===0?"-":e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:2},children:o.map((r,c)=>e.jsx("span",{children:r},`${a.id}-prod-${c}`))})}),e.jsx("td",{style:{textAlign:"center"},children:a.data_embarque?new Date(a.data_embarque).toLocaleDateString("pt-BR"):"-"}),e.jsxs("td",{children:["R$"," ",t.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{children:n===0?"-":`R$ ${n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`}),e.jsx("td",{className:"th-actions",style:{textAlign:"center"},children:e.jsx("button",{className:"btn-icon",title:"Ver detalhes",onClick:()=>S(a),children:"üëÅÔ∏è"})})]},a.id)})]})]})}),i&&e.jsx("div",{className:"modal-backdrop",children:e.jsxs("div",{className:"modal-panel",style:{maxWidth:"820px"},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("div",{children:e.jsx("div",{className:"modal-title",style:{color:"#16a34a",fontSize:"1.15rem",fontWeight:800},children:"Detalhes da venda"})}),e.jsx("button",{className:"btn-ghost",onClick:()=>S(null),children:"‚úï"})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"mb-3",style:{display:"grid",gap:6,lineHeight:1.4},children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Cliente:"})," ",i.cliente_nome||"-"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Cidade:"})," ",i.destino_cidade_nome||"N√£o informada"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Lan√ßada em:"})," ",new Date(i.data_lancamento).toLocaleDateString("pt-BR")]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Embarque:"})," ",i.data_embarque?new Date(i.data_embarque).toLocaleDateString("pt-BR"):"-"]})]}),e.jsx("h4",{style:{marginBottom:8,textAlign:"center"},children:"Recibos"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-green",style:{minWidth:520},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"N√∫mero"}),e.jsx("th",{children:"Produto"}),e.jsx("th",{children:"Valor"}),e.jsx("th",{children:"Taxas"}),b&&e.jsx("th",{children:"A√ß√µes"})]})}),e.jsx("tbody",{children:C(i.id).map(a=>{const t=(a.valor_total||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}),n=a.valor_taxas||0,o=n===0?"-":`R$ ${n.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs("tr",{children:[e.jsx("td",{children:a.numero_recibo||"-"}),e.jsx("td",{children:a.produto_nome||"-"}),e.jsxs("td",{children:["R$ ",t]}),e.jsx("td",{children:o}),b&&e.jsx("td",{children:e.jsx("button",{className:"btn-icon btn-danger",disabled:G===a.id,onClick:()=>le(a.id,i.id),children:G===a.id?"‚Ä¶":"üóëÔ∏è"})})]},a.id)})})]})})]}),(q||b)&&e.jsxs("div",{className:"modal-footer",children:[q&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-outline",style:{minWidth:130,backgroundColor:"#f3f4f6",color:"#1f2937"},onClick:()=>{const a=`/vendas/cadastro?id=${i.id}${i.destino_cidade_id?`&cidadeId=${i.destino_cidade_id}`:""}${i.destino_cidade_nome?`&cidadeNome=${encodeURIComponent(i.destino_cidade_nome)}`:""}`;window.location.href=a},children:"Editar"}),e.jsx("button",{className:"btn btn-primary",style:{minWidth:130},onClick:()=>{const a=prompt("Nova data de embarque (AAAA-MM-DD):",i.data_embarque||"");a&&me(i,a)},disabled:k,children:k?"Salvando...":"Remarcar"})]}),b&&e.jsx("button",{className:"btn btn-danger",style:{minWidth:130},onClick:()=>ce(i),disabled:P,children:P?"Cancelando...":"Cancelar Venda"})]})]})}),Y.length>0&&e.jsx("div",{style:{position:"fixed",bottom:16,right:16,display:"grid",gap:8,zIndex:9999,maxWidth:"320px"},children:Y.map(a=>e.jsx("div",{className:"card-base",style:{padding:"10px 12px",background:a.type==="success"?"#ecfdf3":"#fee2e2",border:`1px solid ${a.type==="success"?"#16a34a":"#ef4444"}`,color:"#0f172a",boxShadow:"0 10px 30px rgba(0,0,0,0.12)"},children:a.message},a.id))})]}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Voc√™ n√£o possui permiss√£o para visualizar Vendas."})}):e.jsx("div",{className:"card-base card-config",children:e.jsx("strong",{children:"Acesso negado ao m√≥dulo de Vendas."})})}export{ye as default};
