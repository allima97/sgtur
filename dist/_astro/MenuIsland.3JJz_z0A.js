import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r}from"./index.C0Fn7Wtz.js";import{r as pe}from"./index.2_Y_w1Vs.js";import{s as f}from"./supabase.Ng8nq9tn.js";import{r as xe}from"./logs.DwCrXgEk.js";import{S as fe}from"./systemName.Cf447brS.js";async function je(){try{const{data:a}=await f.auth.getUser(),h=a?.user?.id||null;let j="";try{j=(await(await fetch("https://api.ipify.org?format=json")).json()).ip||""}catch{}const M=typeof navigator<"u"?navigator.userAgent:"";await xe({user_id:h,acao:"logout",modulo:"login",detalhes:{ip:j,userAgent:M}}),await f.auth.signOut(),window.location.href="/auth/login"}catch(a){console.error("Erro ao sair:",a),window.location.href="/auth/login"}}const U={Dashboard:"dashboard",Vendas:"vendas_consulta",Orcamentos:"orcamentos",Clientes:"clientes",Cadastros:"cadastros",Paises:"cadastros_paises",Subdivisoes:"cadastros_estados",Cidades:"cadastros_cidades",Destinos:"cadastros_destinos",Produtos:"cadastros_produtos",Fornecedores:"cadastros_fornecedores",Relatorios:"relatorios",RelatorioVendas:"relatorios_vendas",RelatorioDestinos:"relatorios_destinos",RelatorioProdutos:"relatorios_produtos",RelatorioClientes:"relatorios_clientes",Parametros:"parametros",TipoProdutos:"parametros_tipo_produtos",Metas:"parametros_metas",RegrasComissao:"parametros_regras_comissao",Admin:"admin",AdminDashboard:"admin_dashboard",AdminUsers:"admin_users",AdminLogs:"admin_logs",Operacao:"operacao",Viagens:"operacao_viagens",Comissionamento:"comissionamento"},be=Object.keys(U).reduce((a,h)=>(a[h.toLowerCase()]=U[h],a),{}),E=a=>{switch(a){case"admin":return 5;case"delete":return 4;case"edit":return 3;case"create":return 2;case"view":return 1;default:return 0}},ve=()=>e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 32 32",fill:"none",stroke:"currentColor",strokeWidth:"1.6",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",focusable:"false",children:[e.jsx("circle",{cx:"14",cy:"8",r:"4.2"}),e.jsx("path",{d:"M9 18c0-1.5 1.7-3 5-3s5 1.5 5 3"}),e.jsx("path",{d:"M8 25c1.5-3 6-4 8-4s6 1 7 4"}),e.jsx("rect",{x:"11.5",y:"19",width:"6",height:"4",rx:"1"}),e.jsx("path",{d:"M21.5 8v16"}),e.jsx("path",{d:"M21.5 8l6 3-6 3"})]});function _e({activePage:a}){const j=(Number.isFinite(0),15),[M,O]=r.useState(null),[$,I]=r.useState({}),[Y,b]=r.useState(!1),[V,A]=r.useState(!1),[we,F]=r.useState(""),[p,H]=r.useState(!1),[m,v]=r.useState(!1),[Q,w]=r.useState(!1),g=r.useRef(null),C=r.useRef(null),k=j*60*1e3,W=60*1e3,Z=15*60*1e3,[ee,z]=r.useState(k),q=r.useRef(Date.now()+k),T=Object.values($).some(s=>s==="admin");r.useEffect(()=>H(!0),[]),r.useEffect(()=>{if(!p)return;const s=window.matchMedia("(max-width: 1024px)"),n=o=>{o.matches||v(!1)};return s.addEventListener?s.addEventListener("change",n):s.addListener(n),()=>{s.removeEventListener?s.removeEventListener("change",n):s.removeListener(n)}},[p]),r.useEffect(()=>{if(!m)return;const s=n=>{n.key==="Escape"&&v(!1)};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[m]);const se=()=>v(s=>!s),N=r.useCallback(()=>v(!1),[]),S=r.useCallback(async(s=!0)=>{s&&A(!0),w(!1),N();try{await je()}finally{s&&A(!1)}},[N,A]),i=()=>{typeof window<"u"&&window.innerWidth<=1024&&N()},y=r.useCallback(()=>{g.current&&(window.clearTimeout(g.current),g.current=null),C.current&&(window.clearTimeout(C.current),C.current=null)},[]),x=r.useCallback((s=k)=>{w(!1),y(),q.current=Date.now()+s,z(s),g.current=window.setTimeout(()=>S(!1),s);const n=Math.max(s-W,0);C.current=window.setTimeout(()=>w(!0),n)},[k,W,y,S]),ae=()=>{x(Z)},D=r.useCallback(()=>{typeof document<"u"&&document.visibilityState==="hidden"||x()},[x]);r.useEffect(()=>{if(!p)return;x();const s=["mousedown","keydown","scroll","touchstart"];return s.forEach(n=>window.addEventListener(n,D)),()=>{s.forEach(n=>window.removeEventListener(n,D)),y(),w(!1)}},[D,x,p,y]),r.useEffect(()=>{const s=window.setInterval(()=>{const n=Math.max(0,(q.current||Date.now())-Date.now());z(n)},1e3);return()=>window.clearInterval(s)},[]);const B=Math.ceil(Math.max(0,ee)/1e3),J=Math.floor(B/60),G=B%60,ne=J>0?`${J}m ${G.toString().padStart(2,"0")}s`:`${G}s`;function K(s,n,o){const c=n.toLowerCase(),d=s[c]??"none";s[c]=E(o)>E(d)?o:d}function re(s,n,o){const c=n.toLowerCase();K(s,c,o);const d=be[c];d&&K(s,d,o)}async function ie(){const{data:s}=await f.auth.getSession(),n=s?.session?.user,{data:o}=n?{data:{user:n}}:await f.auth.getUser(),c=o?.user||n||null,d=c?.id||null,R=c?.email||"";if(O(t=>t!==d?d:t),F(t=>t!==R.toLowerCase()?R.toLowerCase():t),!d){Y||I({}),b(!0);return}const{data:ce,error:ue}=await f.from("modulo_acesso").select("modulo, permissao, ativo").eq("usuario_id",d);if(ue){b(!0);return}const _={};(ce||[]).forEach(t=>{const L=String(t.modulo||"").toLowerCase(),u=String(t.permissao||"none").toLowerCase(),me=u==="admin"||u==="delete"||u==="edit"||u==="create"||u==="view"?u:"none",he=t.ativo?me:"none";L&&re(_,L,he)}),I(t=>{const L=JSON.stringify(t),u=JSON.stringify(_);return L!==u?_:t});try{window.localStorage.setItem("sgtur_menu_cache",JSON.stringify({userId:d,acessos:_,userEmail:R.toLowerCase()}))}catch{}b(!0)}r.useEffect(()=>{try{const s=window.localStorage.getItem("sgtur_menu_cache");if(s){const n=JSON.parse(s);O(n.userId||null),I(n.acessos||{}),F(n.userEmail||"")}}catch{}b(!0),ie()},[]);async function oe(){await S(!0)}const te=(s,n="view")=>{const o=$[String(s||"").toLowerCase()]??"none";return E(o)>=E(n)},l=(s,n="view")=>{if(T)return!0;const o=U[s];return o?te(o,n):!1},P=[{name:"Paises",href:"/cadastros/paises",active:"paises",icon:"ðŸŒ",label:"PaÃ­ses"},{name:"Subdivisoes",href:"/cadastros/estados",active:"subdivisoes",icon:"ðŸ—ºï¸",label:"Estado/ProvÃ­ncia"},{name:"Cidades",href:"/cadastros/cidades",active:"cidades",icon:"ðŸ™ï¸",label:"Cidades"},{name:"Produtos",href:"/cadastros/produtos",active:"produtos",icon:"ðŸŽ«",label:"Produtos"},{name:"Fornecedores",href:"/cadastros/fornecedores",active:"fornecedores",icon:e.jsx(ve,{}),label:"Fornecedores"}],le=P.some(s=>l(s.name)),X="app-sidebar",de=p?pe.createPortal(e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",className:"sidebar-mobile-trigger","aria-expanded":m,"aria-controls":X,onClick:se,children:[e.jsx("span",{className:"sidebar-mobile-icon",children:m?"âœ•":"â˜°"}),e.jsx("span",{children:m?"Fechar":"Menu"})]}),e.jsx("div",{className:`sidebar-overlay ${m?"visible":""}`,onClick:N})]}),document.body):null;return e.jsxs(e.Fragment,{children:[de,e.jsxs("aside",{id:X,className:`app-sidebar ${m?"open":""}`,children:[e.jsx("div",{className:"sidebar-logo",children:fe}),e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"OperaÃ§Ã£o"}),e.jsxs("ul",{className:"sidebar-nav",children:[l("Dashboard")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="dashboard"?"active":""}`,href:"/",onClick:i,children:[e.jsx("span",{children:"ðŸ“Š"}),"Dashboard"]})}),l("Vendas")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="vendas"?"active":""}`,href:"/vendas/consulta",onClick:i,children:[e.jsx("span",{children:"ðŸ§¾"}),"Vendas"]})}),l("Orcamentos")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="orcamentos"?"active":""}`,href:"/orcamentos",onClick:i,children:[e.jsx("span",{children:"ðŸ’¼"}),"OrÃ§amentos"]})}),l("Comissionamento")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="comissionamento"?"active":""}`,href:"/operacao/comissionamento",onClick:i,children:[e.jsx("span",{children:"ðŸ’°"}),"Comissionamento"]})}),l("Operacao")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="operacao_viagens"?"active":""}`,href:"/operacao/viagens",onClick:i,children:[e.jsx("span",{children:"âœˆï¸"}),"Viagens"]})}),T&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="importar-vendas"?"active":""}`,href:"/gestor/importar-vendas",onClick:i,children:[e.jsx("span",{children:"â¬†ï¸"}),"Importar Vendas"]})}),l("Clientes")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="clientes"?"active":""}`,href:"/clientes/carteira",onClick:i,children:[e.jsx("span",{children:"ðŸ‘¥"}),"Clientes"]})})]})]}),le&&e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"Cadastros"}),e.jsx("ul",{className:"sidebar-nav",children:P.filter(s=>l(s.name)).map(s=>e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a===s.active?"active":""}`,href:s.href,onClick:i,children:[e.jsx("span",{children:s.icon}),s.label]})},s.name))})]}),l("Relatorios")&&e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"RelatÃ³rios"}),e.jsxs("ul",{className:"sidebar-nav",children:[e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="relatorios-vendas"?"active":""}`,href:"/relatorios/vendas",onClick:i,children:[e.jsx("span",{children:"ðŸ“ˆ"}),"Vendas (detalhado)"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="relatorios-vendas-destino"?"active":""}`,href:"/relatorios/vendas-por-destino",onClick:i,children:[e.jsx("span",{children:"ðŸ“Œ"}),"Vendas por destino"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="relatorios-vendas-produto"?"active":""}`,href:"/relatorios/vendas-por-produto",onClick:i,children:[e.jsx("span",{children:"ðŸŽ«"}),"Vendas por produto"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="relatorios-vendas-cliente"?"active":""}`,href:"/relatorios/vendas-por-cliente",onClick:i,children:[e.jsx("span",{children:"ðŸ‘¤"}),"Vendas por cliente"]})})]})]}),l("Parametros")&&e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"ParÃ¢metros"}),e.jsxs("ul",{className:"sidebar-nav",children:[e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="parametros-tipo-produtos"?"active":""}`,href:"/parametros/tipo-produtos",onClick:i,children:[e.jsx("span",{children:"ðŸ·ï¸"}),"Tipo de Produtos"]})}),l("Metas")&&e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="parametros-metas"?"active":""}`,href:"/parametros/metas",onClick:i,children:[e.jsx("span",{children:"ðŸŽ¯"}),"Metas"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="parametros"?"active":""}`,href:"/parametros",onClick:i,children:[e.jsx("span",{children:"âš™ï¸"}),"ParÃ¢metros do Sistema"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="parametros-cambios"?"active":""}`,href:"/parametros/cambios",onClick:i,children:[e.jsx("span",{children:"ðŸ’±"}),"CÃ¢mbios"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="regras-comissao"?"active":""}`,href:"/parametros/regras-comissao",onClick:i,children:[e.jsx("span",{children:"ðŸ’°"}),"Regras de ComissÃ£o"]})})]})]}),M&&e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"Conta"}),e.jsx("ul",{className:"sidebar-nav",children:e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="perfil"?"active":""}`,href:"/perfil",onClick:i,children:[e.jsx("span",{children:"ðŸ‘¤"}),"Perfil"]})})})]}),T&&e.jsxs("div",{children:[e.jsx("div",{className:"sidebar-section-title",children:"AdministraÃ§Ã£o"}),e.jsxs("ul",{className:"sidebar-nav",children:[e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="admin-permissoes"?"active":""}`,href:"/admin/permissoes",onClick:i,children:[e.jsx("span",{children:"âš™ï¸"}),"PermissÃµes"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="admin-logs"?"active":""}`,href:"/dashboard/logs",onClick:i,children:[e.jsx("span",{children:"ðŸ“œ"}),"Logs"]})}),e.jsx("li",{children:e.jsxs("a",{className:`sidebar-link ${a==="admin-users"?"active":""}`,href:"/dashboard/admin",onClick:i,children:[e.jsx("span",{children:"ðŸ§‘"}),"UsuÃ¡rios"]})})]})]}),e.jsx("div",{style:{marginTop:20},children:e.jsx("ul",{className:"sidebar-nav",children:e.jsx("li",{children:e.jsxs("button",{type:"button",className:"sidebar-link",style:{background:"transparent",border:"none",width:"100%",textAlign:"left"},onClick:oe,disabled:V,children:[e.jsx("span",{children:"ðŸšª"}),V?"Saindo...":"Sair"]})})})})]}),e.jsxs("div",{"aria-live":"polite",style:{position:"fixed",top:12,right:16,zIndex:950,backgroundColor:"rgba(248, 250, 252, 0.85)",borderRadius:999,padding:"4px 12px",border:"1px solid rgba(148, 163, 184, 0.6)",fontSize:"0.75rem",color:"#0f172a",backdropFilter:"blur(6px)",boxShadow:"0 10px 30px rgba(15,23,42,0.25)"},children:["SessÃ£o ativa â€¢ ",ne]}),Q&&e.jsx("div",{role:"alertdialog","aria-modal":"true",style:{position:"fixed",inset:0,backgroundColor:"rgba(15, 23, 42, 0.55)",zIndex:9999,display:"flex",justifyContent:"center",alignItems:"center",padding:16},children:e.jsxs("div",{style:{background:"white",borderRadius:12,padding:"24px 32px",boxShadow:"0 30px 60px rgba(15,23,42,0.35)",maxWidth:420,width:"100%"},children:[e.jsx("h3",{style:{marginTop:0,marginBottom:12},children:"SessÃ£o quase expirando"}),e.jsx("p",{style:{marginTop:0,marginBottom:20},children:"Sua sessÃ£o serÃ¡ encerrada automaticamente em 1 minuto por inatividade. Clique em â€œContinuar Logadoâ€ para ganhar mais 15 minutos sem perder o progresso."}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"btn btn-primary",onClick:ae,children:"Continuar Logado"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>S(!0),children:"Sair agora"})]})]})})]})}export{_e as default};
