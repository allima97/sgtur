import{j as e,s as m}from"./supabase.CWKfsr2i.js";import{r}from"./index.DVhKKaGN.js";import{u as B}from"./usePermissao.LURrmXgT.js";import{r as S}from"./logs.z45cSWoX.js";const F={nome:"",pais_id:"",estado_provincia:"",descricao:""};function O(){const u=B("Cidades"),b=B("Cadastros"),n=u.isAdmin||b.isAdmin,c=u.loading||b.loading,i=n?"admin":u.permissao!=="none"?u.permissao:b.permissao,h=n||i!=="none",N=n||i==="create"||i==="edit"||i==="delete"||i==="admin",t=n||i==="edit"||i==="delete"||i==="admin",p=n||i==="delete"||i==="admin",[f,V]=r.useState([]),[g,z]=r.useState([]),[x,M]=r.useState(""),[o,C]=r.useState(F),[l,y]=r.useState(null),[P,j]=r.useState(null),[A,D]=r.useState(!1),[I,L]=r.useState(null),[_,w]=r.useState(!0);async function E(){if(h)try{w(!0);const[{data:a},{data:s}]=await Promise.all([m.from("paises").select("id, nome").order("nome"),m.from("cidades").select("*").order("nome")]);V(a||[]),z(s||[])}catch(a){console.error(a),j("Erro ao carregar cidades.")}finally{w(!1)}}r.useEffect(()=>{if(!c){if(!h){w(!1);return}E()}},[c,h]);const q=r.useMemo(()=>{if(!x.trim())return g;const a=x.toLowerCase();return g.filter(s=>s.nome.toLowerCase().includes(a)||(f.find(d=>d.id===s.pais_id)?.nome.toLowerCase()||"").includes(a))},[x,g,f]);function v(a,s){C(d=>({...d,[a]:s}))}function R(a){t&&(y(a.id),C({nome:a.nome,pais_id:a.pais_id,estado_provincia:a.estado_provincia||"",descricao:a.descricao||""}))}function k(){N&&(y(null),C(F))}async function T(a){if(a.preventDefault(),!(!N&&!t))try{D(!0),j(null);const s={nome:o.nome,pais_id:o.pais_id,estado_provincia:o.estado_provincia||null,descricao:o.descricao||null};if(l){const{error:d}=await m.from("cidades").update(s).eq("id",l);if(d)throw d;await S({user_id:null,acao:"cidade_editada",modulo:"Cadastros",detalhes:{id:l,payload:s}})}else{const{error:d}=await m.from("cidades").insert(s);if(d)throw d;await S({user_id:null,acao:"cidade_criada",modulo:"Cadastros",detalhes:s})}k(),E()}catch(s){console.error(s),j("Erro ao salvar cidade.")}finally{D(!1)}}async function W(a){if(p&&confirm("Excluir cidade?"))try{L(a);const{error:s}=await m.from("cidades").delete().eq("id",a);if(s)throw s;await S({user_id:null,acao:"cidade_excluida",modulo:"Cadastros",detalhes:{id:a}}),E()}catch(s){console.error(s),j("Erro ao excluir cidade (provavelmente usada em Destinos).")}finally{L(null)}}return!h&&!n?c?e.jsx("div",{className:"auth-info",children:"Carregando permissÃµes..."}):e.jsx("div",{className:"auth-error",children:"VocÃª nÃ£o possui permissÃ£o para visualizar Cidades."}):e.jsxs("div",{className:"cidades-page",children:[(N||t)&&e.jsx("div",{className:"card-base card-blue mb-3",children:e.jsxs("form",{onSubmit:T,children:[e.jsx("h3",{children:l?"Editar cidade":"Nova cidade"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Nome *"}),e.jsx("input",{className:"form-input",value:o.nome,onChange:a=>v("nome",a.target.value),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"PaÃ­s *"}),e.jsxs("select",{className:"form-select",value:o.pais_id,onChange:a=>v("pais_id",a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),f.map(a=>e.jsx("option",{value:a.id,children:a.nome},a.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Estado/ProvÃ­ncia"}),e.jsx("input",{className:"form-input",value:o.estado_provincia,onChange:a=>v("estado_provincia",a.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"DescriÃ§Ã£o"}),e.jsx("textarea",{className:"form-input",rows:3,value:o.descricao,onChange:a=>v("descricao",a.target.value)})]}),e.jsxs("div",{style:{display:"flex",gap:8,flexWrap:"wrap",marginTop:8},children:[e.jsx("button",{className:"btn btn-primary",disabled:A,children:A?"Salvando...":l?"Salvar alteraÃ§Ãµes":"Adicionar cidade"}),l&&e.jsx("button",{type:"button",className:"btn btn-light",onClick:k,children:"Cancelar"})]})]})}),e.jsx("div",{className:"card-base mb-3",children:e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Buscar cidade"}),e.jsx("input",{className:"form-input",placeholder:"Nome ou paÃ­s...",value:x,onChange:a=>M(a.target.value)})]})})}),c&&e.jsx("div",{className:"auth-info mb-3",children:"Carregando permissÃµes..."}),!c&&P&&e.jsx("div",{className:"card-base card-config mb-3",children:e.jsx("strong",{children:P})}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default table-header-blue min-w-[720px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Cidade"}),e.jsx("th",{children:"Estado/Prov."}),e.jsx("th",{children:"PaÃ­s"}),e.jsx("th",{children:"Criada em"}),(t||p)&&e.jsx("th",{className:"th-actions",children:"AÃ§Ãµes"})]})}),e.jsxs("tbody",{children:[_&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Carregando..."})}),!_&&q.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,children:"Nenhuma cidade encontrada."})}),!_&&q.map(a=>e.jsxs("tr",{children:[e.jsx("td",{children:a.nome}),e.jsx("td",{children:a.estado_provincia||"â€”"}),e.jsx("td",{children:f.find(s=>s.id===a.pais_id)?.nome||"â€”"}),e.jsx("td",{children:a.created_at?a.created_at.slice(0,10):"â€”"}),(t||p)&&e.jsxs("td",{className:"th-actions",children:[t&&e.jsx("button",{className:"btn-icon",onClick:()=>R(a),title:"Editar",children:"âœï¸"}),p&&e.jsx("button",{className:"btn-icon btn-danger",onClick:()=>W(a.id),disabled:I===a.id,title:"Excluir",children:I===a.id?"...":"ğŸ—‘ï¸"})]})]},a.id))]})]})})]})}export{O as default};
