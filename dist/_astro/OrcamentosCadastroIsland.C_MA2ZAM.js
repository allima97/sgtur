import{j as e}from"./jsx-runtime.mfZSNocD.js";import{r as a}from"./index.C0Fn7Wtz.js";import{s as r}from"./supabase.Ng8nq9tn.js";import{u as L}from"./usePermissao.Bkt8qSjs.js";function $(){const{ativo:E}=L("Vendas"),[I,q]=a.useState([]),[D,V]=a.useState([]),[O,P]=a.useState([]),[n,i]=a.useState(""),[c,d]=a.useState(""),[b,m]=a.useState(""),[u,x]=a.useState("novo"),[p,f]=a.useState(""),[g,v]=a.useState(""),[N,h]=a.useState(""),[S,w]=a.useState(!1),[C,t]=a.useState(null),[y,j]=a.useState(null);a.useEffect(()=>{_()},[]);async function _(){try{const[s,o,l]=await Promise.all([r.from("clientes").select("id, nome").eq("ativo",!0).order("nome"),r.from("produtos").select("id, nome").eq("ativo",!0).order("nome"),r.from("tipo_produtos").select("id, nome, tipo").eq("ativo",!0).order("nome")]);s.data&&q(s.data),o.data&&V(o.data),l.data&&P(l.data)}catch(s){console.error(s),t("Erro ao carregar listas.")}}async function F(s){if(s.preventDefault(),t(null),j(null),!n||!c||!u){t("Cliente, destino e status são obrigatórios.");return}try{w(!0);const o={cliente_id:n,destino_id:c||null,produto_id:b||null,status:u,valor:p?parseFloat(p):null,data_viagem:g||null,notas:N||null},{error:l}=await r.from("orcamentos").insert(o);if(l)throw l;j("Orçamento criado."),window.dispatchEvent(new CustomEvent("orcamento-criado")),i(""),d(""),m(""),x("novo"),f(""),v(""),h("")}catch(o){console.error(o),t("Erro ao salvar orçamento.")}finally{w(!1)}}return E?e.jsxs("div",{className:"card-base card-blue mb-3",children:[e.jsx("h2",{className:"card-title font-semibold text-lg",children:"Novo Orçamento"}),C&&e.jsx("div",{className:"auth-error text-red-600 font-medium mb-2",children:C}),y&&e.jsx("div",{className:"auth-success text-slate-900 font-bold mb-2",children:y}),e.jsxs("form",{onSubmit:F,className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Cliente *"}),e.jsxs("select",{className:"form-select",value:n,onChange:s=>i(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),I.map(s=>e.jsx("option",{value:s.id,children:s.nome},s.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Destino *"}),e.jsxs("select",{className:"form-select",value:c,onChange:s=>d(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecione"}),D.map(s=>e.jsx("option",{value:s.id,children:s.nome},s.id))]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[180px]",children:[e.jsx("label",{className:"form-label",children:"Tipo de produto"}),e.jsxs("select",{className:"form-select",value:b,onChange:s=>m(s.target.value),children:[e.jsx("option",{value:"",children:"(Opcional)"}),O.map(s=>e.jsx("option",{value:s.id,children:s.nome||s.tipo},s.id))]})]})]}),e.jsxs("div",{className:"form-row flex flex-col md:flex-row gap-3",children:[e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Status"}),e.jsxs("select",{className:"form-select",value:u,onChange:s=>x(s.target.value),children:[e.jsx("option",{value:"novo",children:"Novo"}),e.jsx("option",{value:"enviado",children:"Enviado"}),e.jsx("option",{value:"negociando",children:"Negociando"}),e.jsx("option",{value:"fechado",children:"Fechado"}),e.jsx("option",{value:"perdido",children:"Perdido"})]})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Valor estimado (R$)"}),e.jsx("input",{className:"form-input",type:"number",value:p,onChange:s=>f(s.target.value),min:0,step:"0.01"})]}),e.jsxs("div",{className:"form-group flex-1 min-w-[140px]",children:[e.jsx("label",{className:"form-label",children:"Data da viagem"}),e.jsx("input",{className:"form-input",type:"date",value:g,onChange:s=>v(s.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"Notas"}),e.jsx("textarea",{className:"form-input",rows:3,value:N,onChange:s=>h(s.target.value),placeholder:"Observações, próximos passos..."})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:S,children:S?"Salvando...":"Criar orçamento"}),e.jsx("button",{type:"button",className:"btn btn-light",onClick:()=>{i(""),d(""),m(""),x("novo"),f(""),v(""),h(""),t(null),j(null)},children:"Limpar"})]})]})]}):e.jsx("div",{children:"Acesso ao módulo de Vendas bloqueado."})}export{$ as default};
