import{j as e,s as h}from"./supabase.CWKfsr2i.js";import{r}from"./index.DVhKKaGN.js";import{u as P}from"./usePermissao.LURrmXgT.js";import{R as K,L as X,X as Q,Y as W,T as z,a as H}from"./LineChart.JgIqLDAy.js";import"./index.CD0tCUXs.js";function g(m){return m.toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}function J(){const m=new Date,S=new Date(m.getFullYear(),m.getMonth(),1),o=new Date(m.getFullYear(),m.getMonth()+1,0),j=k=>k.toISOString().substring(0,10);return{inicio:j(S),fim:j(o)}}function te(){const{ativo:m,loading:S}=P("Dashboard"),[o,j]=r.useState("OUTRO"),[k,w]=r.useState(""),[x,O]=r.useState([]),[D,M]=r.useState({}),[v,I]=r.useState(""),[f,G]=r.useState(""),[q,V]=r.useState([]),[y,A]=r.useState([]),[B,R]=r.useState(!0),[T,E]=r.useState(null);r.useEffect(()=>{const{inicio:s,fim:a}=J();I(s),G(a)},[]),r.useEffect(()=>{async function s(){try{const{data:a}=await h.auth.getUser();if(!a?.user){E("Usuário não autenticado.");return}w(a.user.id);const{data:i,error:n}=await h.from("users").select("id, nome_completo, user_types(name)").eq("id",a.user.id).maybeSingle();if(n)throw n;const d=i?.user_types?.name?.toUpperCase()||"";let l="OUTRO";if(d.includes("ADMIN")?l="ADMIN":d.includes("GESTOR")?l="GESTOR":d.includes("VENDEDOR")&&(l="VENDEDOR"),j(l),l==="GESTOR"){const{data:u,error:t}=await h.from("gestor_vendedor").select("vendedor_id").eq("gestor_id",a.user.id);if(t)throw t;const c=u?.map(p=>p.vendedor_id).filter(Boolean);O(c);const{data:b}=await h.from("users").select("id, nome_completo").in("id",c),N={};b?.forEach(p=>{N[p.id]=p.nome_completo}),M(N)}}catch(a){console.error(a),E("Erro ao carregar contexto do gestor.")}}s()},[o]),r.useEffect(()=>{if(!v||!f||o!=="GESTOR"&&o!=="ADMIN")return;async function s(){try{R(!0),E(null);let a=h.from("vendas").select(`
          id,
          data_lancamento,
          vendedor_id,
          clientes:clientes (nome),
          destinos:destinos (nome),
          vendas_recibos (
            id,
            valor_total,
            produtos:produtos (nome)
          )
        `).gte("data_lancamento",v).lte("data_lancamento",f).eq("cancelada",!1);o==="GESTOR"&&x.length>0&&(a=a.in("vendedor_id",x));const{data:i,error:n}=await a;if(n)throw n;V(i||[]);let d=h.from("metas_vendedor").select("vendedor_id, meta_geral, scope").gte("periodo",v).lte("periodo",f).eq("ativo",!0);o==="GESTOR"&&x.length>0&&(d=d.in("vendedor_id",x));const{data:l,error:u}=await d;if(u)throw u;A(l||[])}catch(a){console.error(a),E("Erro ao carregar dados do dashboard do gestor.")}finally{R(!1)}}s()},[v,f,x,o]);const{totalTeamSales:L,totalTeamDeals:U,ticketMedioEquipe:C,metaEquipe:F,atingimentoEquipe:Y,rankingEquipe:_}=r.useMemo(()=>{let s=0;const a={};let i=0;q.forEach(t=>{const c=(t.vendas_recibos||[]).reduce((N,p)=>N+Number(p.valor_total||0),0);s+=c;const b=t.vendedor_id||"0";a[b]=(a[b]||0)+c}),y.forEach(t=>{t.scope,i+=Number(t.meta_geral||0)});const n=q.length,d=n>0?s/n:0,l=i>0?s/i*100:0,u=Object.entries(a).map(([t,c])=>({vendedor_id:t,nome:D[t]||"Vendedor",total:c})).sort((t,c)=>t.total<c.total?1:-1);return{totalTeamSales:s,totalTeamDeals:n,ticketMedioEquipe:d,metaEquipe:i,atingimentoEquipe:l,rankingEquipe:u}},[q,y,D]);return S?e.jsx("div",{children:"Carregando permissões..."}):m?o!=="GESTOR"&&o!=="ADMIN"?e.jsx("div",{style:"padding:20px;",children:e.jsx("h3",{children:"Somente Gestores podem acessar este dashboard."})}):e.jsxs("div",{className:"dashboard-geral-page",children:[e.jsxs("div",{style:{marginBottom:15,padding:"12px 16px",borderRadius:8,background:"#312e81",border:"1px solid #4338ca",color:"#e0e7ff"},children:[e.jsx("strong",{children:"Dashboard do Gestor"})," — período:",e.jsxs("span",{style:{marginLeft:6},children:[new Date(v).toLocaleDateString("pt-BR")," até"," ",new Date(f).toLocaleDateString("pt-BR")]})]}),e.jsx("div",{className:"card-base card-purple mb-3",children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px,1fr))",gap:10},children:[e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Vendas da equipe"}),e.jsx("div",{className:"kpi-value",children:g(L)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Qtd. Vendas"}),e.jsx("div",{className:"kpi-value",children:U})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Ticket médio"}),e.jsx("div",{className:"kpi-value",children:g(C)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Meta da equipe"}),e.jsx("div",{className:"kpi-value",children:g(F)})]}),e.jsxs("div",{className:"kpi-card",children:[e.jsx("div",{className:"kpi-label",children:"Atingimento"}),e.jsxs("div",{className:"kpi-value",children:[Y.toFixed(1),"%"]})]})]})}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsx("h3",{style:{marginBottom:8},children:"Ranking da equipe"}),e.jsx("div",{className:"table-container overflow-x-auto",children:e.jsxs("table",{className:"table-default min-w-[480px]",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Vendedor"}),e.jsx("th",{children:"Total vendido"})]})}),e.jsxs("tbody",{children:[_.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:2,children:"Sem vendas no período."})}),_.map((s,a)=>e.jsxs("tr",{children:[e.jsxs("td",{children:["#",a+1," — ",s.nome]}),e.jsx("td",{children:g(s.total)})]},s.vendedor_id))]})]})})]}),e.jsxs("div",{className:"card-base card-purple mb-3",children:[e.jsx("h3",{style:{marginBottom:8},children:"Evolução de vendas da equipe"}),e.jsx("div",{style:{width:"100%",height:260},children:e.jsx(K,{children:e.jsxs(X,{data:_.map((s,a)=>({name:s.nome,total:s.total})),children:[e.jsx(Q,{dataKey:"name"}),e.jsx(W,{}),e.jsx(z,{formatter:s=>g(Number(s||0))}),e.jsx(H,{type:"monotone",dataKey:"total",stroke:"#a855f7",strokeWidth:2})]})})})]}),B&&e.jsx("div",{children:"Carregando..."}),T&&e.jsx("div",{className:"card-base card-config",children:T})]}):e.jsx("div",{children:"Você não possui acesso ao Dashboard."})}export{te as default};
