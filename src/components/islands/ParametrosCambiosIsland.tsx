import React, { useCallback, useEffect, useMemo, useState } from "react";
import { supabase } from "../../lib/supabase";
import { usePermissoesStore } from "../../lib/permissoesStore";
import { useCrudResource } from "../../lib/useCrudResource";
import LoadingUsuarioContext from "../ui/LoadingUsuarioContext";
import ConfirmDialog from "../ui/ConfirmDialog";
import { registrarLog } from "../../lib/logs";

const MOEDA_SUGESTOES = ["R$", "USD", "EUR"];

type CambioRecord = {
  id: string;
  moeda: string;
  data: string;
  valor: number | null;
  created_at: string | null;
  owner_user_id: string | null;
  owner_user?: {
    nome_completo: string | null;
  };
};

type FormState = {
  moeda: string;
  data: string;
  valor: string;
};

const agoraData = () => new Date().toISOString().slice(0, 10);
const buildInitialForm = (): FormState => ({ moeda: "USD", data: agoraData(), valor: "" });

function parseDecimal(value: string) {
  if (!value || typeof value !== "string") return null;
  const cleaned = value.replace(/\./g, "").replace(",", ".").trim();
  if (!cleaned) return null;
  const num = Number(cleaned);
  return Number.isFinite(num) ? num : null;
}

function formatValorNumber(value?: number | null) {
  if (value == null || Number.isNaN(value)) return "-";
  return value.toLocaleString("pt-BR", { minimumFractionDigits: 2, maximumFractionDigits: 6 });
}

export default function ParametrosCambiosIsland() {
  const { can, loading: loadingPerms, ready } = usePermissoesStore();
  const loadingPerm = loadingPerms || !ready;
  const podeVer = can("Parametros");
  const podeEscrever = can("Parametros", "create");
  const podeExcluir = can("Parametros", "edit");
  const {
    items: cambios,
    setItems: setCambios,
    loading: loadingCambios,
    saving: salvando,
    error: erro,
    setError: setErro,
    load: loadCambios,
    create,
    update,
    remove,
  } = useCrudResource<CambioRecord>({
    table: "parametros_cambios",
    select:
      "id, moeda, data, valor, created_at, owner_user_id, owner_user:owner_user_id (nome_completo)",
  });
  const [form, setForm] = useState<FormState>(buildInitialForm());
  const [editingId, setEditingId] = useState<string | null>(null);
  const [mostrarFormulario, setMostrarFormulario] = useState(false);
  const [sucesso, setSucesso] = useState<string | null>(null);
  const [companyId, setCompanyId] = useState<string | null>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [cambioParaExcluir, setCambioParaExcluir] = useState<CambioRecord | null>(null);

  const loading = loadingCambios || loadingAuth;

  const resetForm = useCallback(() => {
    setForm(buildInitialForm());
    setEditingId(null);
  }, []);

  const abrirFormulario = useCallback(() => {
    resetForm();
    setErro(null);
    setSucesso(null);
    setMostrarFormulario(true);
  }, [resetForm]);

  const fecharFormulario = useCallback(() => {
    resetForm();
    setErro(null);
    setSucesso(null);
    setMostrarFormulario(false);
  }, [resetForm]);

  const carregar = useCallback(async () => {
    setErro(null);
    setSucesso(null);
    setLoadingAuth(true);
    try {
      const { data: session } = await supabase.auth.getUser();
      const currentUserId = session?.user?.id || null;
      setUserId(currentUserId);

      if (!currentUserId) {
        setErro("Usu√°rio n√£o autenticado.");
        setCompanyId(null);
        setCambios([]);
        return;
      }

      const { data: usuario, error: usuarioErr } = await supabase
        .from("users")
        .select("company_id")
        .eq("id", currentUserId)
        .maybeSingle();

      if (usuarioErr) throw usuarioErr;

      const companyValue = usuario?.company_id || null;
      setCompanyId(companyValue);

      if (!companyValue) {
        setErro("Usu√°rio n√£o est√° vinculado a uma empresa.");
        setCambios([]);
        return;
      }

      const { error } = await loadCambios({
        filter: (query) =>
          query
            .eq("company_id", companyValue)
            .order("data", { ascending: false })
            .order("created_at", { ascending: false }),
        errorMessage: "N√£o foi poss√≠vel carregar os c√¢mbios.",
      });
      if (error) return;
    } catch (err) {
      console.error(err);
      setErro("N√£o foi poss√≠vel carregar os c√¢mbios.");
    } finally {
      setLoadingAuth(false);
    }
  }, [loadCambios, setCambios, setErro]);

  useEffect(() => {
    carregar();
  }, [carregar]);

  const handleFormChange = (field: keyof FormState, value: string) => {
    setForm((prev) => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    if (!podeEscrever || !companyId) return;
    setErro(null);
    setSucesso(null);

    const valorNumero = parseDecimal(form.valor);
    const moeda = form.moeda.trim();

    if (!moeda) {
      setErro("Informe a moeda.");
      return;
    }

    if (!form.data) {
      setErro("Informe a data.");
      return;
    }

    if (valorNumero == null) {
      setErro("Informe um valor v√°lido para o c√¢mbio.");
      return;
    }

    try {
      const payload = {
        company_id: companyId,
        owner_user_id: userId,
        moeda,
        data: form.data,
        valor: valorNumero,
      };
      const { error } = editingId
        ? await update(editingId, payload, {
            errorMessage: "N√£o foi poss√≠vel salvar o c√¢mbio.",
          })
        : await create(payload, {
            errorMessage: "N√£o foi poss√≠vel salvar o c√¢mbio.",
          });
      if (error) return;

      setSucesso(editingId ? "C√¢mbio atualizado com sucesso." : "C√¢mbio salvo com sucesso.");
      resetForm();
      setMostrarFormulario(false);
      await carregar();
      await registrarLog({
        user_id: userId,
        acao: editingId ? "parametros_cambios_atualizacao" : "parametros_cambios_cadastro",
        modulo: "Parametros",
        detalhes: {
          id: editingId || null,
          moeda,
          data: form.data,
          valor: valorNumero
        }
      });
    } catch (err) {
      console.error(err);
      setErro("N√£o foi poss√≠vel salvar o c√¢mbio.");
    }
  };

  const handleDelete = async (id: string) => {
    if (!podeExcluir) return;
    setErro(null);
    setSucesso(null);
    try {
      const { error } = await remove(id, {
        errorMessage: "N√£o foi poss√≠vel excluir o c√¢mbio.",
      });
      if (error) return;
      setSucesso("C√¢mbio exclu√≠do.");
      await carregar();
      await registrarLog({
        user_id: userId,
        acao: "parametros_cambios_exclusao",
        modulo: "Parametros",
        detalhes: { id }
      });
    } catch (err) {
      console.error(err);
      setErro("N√£o foi poss√≠vel excluir o c√¢mbio.");
    }
  };

  const solicitarExclusao = (cambio: CambioRecord) => {
    if (!podeExcluir) return;
    setCambioParaExcluir(cambio);
  };

  const confirmarExclusao = async () => {
    if (!cambioParaExcluir) return;
    await handleDelete(cambioParaExcluir.id);
    setCambioParaExcluir(null);
  };

  const handleEdit = (cambio: CambioRecord) => {
    setEditingId(cambio.id);
    setForm({
      moeda: cambio.moeda,
      data: cambio.data,
      valor: cambio.valor != null ? cambio.valor.toFixed(2) : "",
    });
    setSucesso(null);
    setErro(null);
    setMostrarFormulario(true);
  };

  const tituloTabela = useMemo(() => {
    if (!cambios.length) return "Nenhum c√¢mbio cadastrado.";
    return `${cambios.length} c√¢mbio(s) registrado(s).`;
  }, [cambios]);

  if (loading || loadingPerm) {
    return <LoadingUsuarioContext />;
  }

  if (!podeVer) {
    return <div>Acesso ao m√≥dulo de Par√¢metros bloqueado.</div>;
  }

  const cambiosExibidos = cambios.slice(0, 5);

  return (
    <div className="card-base cambios-page">
      <h2 className="card-title">C√¢mbios</h2>
      <p className="card-subtitle">Cadastre o valor de c√¢mbio aplicado em cada dia.</p>

      {!mostrarFormulario && (
        <>
          {erro && <div className="auth-error">{erro}</div>}
          {sucesso && <div className="auth-success">{sucesso}</div>}

          {podeEscrever && (
            <div className="mb-3">
              <button
                type="button"
                className="btn btn-primary w-full sm:w-auto"
                onClick={abrirFormulario}
                disabled={!companyId}
              >
                Adicionar c√¢mbio
              </button>
            </div>
          )}

          {!companyId && (
            <div className="auth-error">
              Voc√™ precisa estar vinculado a uma empresa para cadastrar c√¢mbios.
            </div>
          )}
          {!podeEscrever && (
            <div style={{ marginTop: 8, color: "#f97316", fontSize: "0.9rem" }}>
              Voc√™ n√£o tem permiss√£o para cadastrar ou remover c√¢mbios. Solicite acesso ao
              administrador.
            </div>
          )}

          <div
            className="table-container overflow-x-auto mt-6"
            style={{ maxHeight: "65vh", overflowY: "auto" }}
          >
            <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-2">
              <strong>{tituloTabela}</strong>
              <button
                type="button"
                className="btn btn-light w-full sm:w-auto"
                onClick={carregar}
                disabled={loading}
              >
                Recarregar
              </button>
            </div>
            <table className="table-default table-header-blue table-mobile-cards min-w-[600px]">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Moeda</th>
                  <th>Valor (R$)</th>
                  <th>Cadastrado por</th>
                  <th>Criado em</th>
                  {podeExcluir && <th className="th-actions">A√ß√µes</th>}
                </tr>
              </thead>
              <tbody>
                {cambiosExibidos.length === 0 && (
                  <tr>
                    <td colSpan={podeExcluir ? 6 : 5}>Nenhum c√¢mbio cadastrado ainda.</td>
                  </tr>
                )}
                {cambiosExibidos.map((cambio) => (
                  <tr key={cambio.id}>
                    <td data-label="Data">{cambio.data}</td>
                    <td data-label="Moeda">{cambio.moeda}</td>
                    <td data-label="Valor (R$)">{formatValorNumber(cambio.valor)}</td>
                    <td data-label="Cadastrado por">
                      {cambio.owner_user?.nome_completo || cambio.owner_user_id || "‚Äî"}
                    </td>
                    <td data-label="Criado em">
                      {cambio.created_at
                        ? new Date(cambio.created_at).toLocaleString("pt-BR")
                        : "‚Äî"}
                    </td>
                    <td className="th-actions" data-label="A√ß√µes">
                      <div className="action-buttons">
                        {podeEscrever && (
                          <button
                            type="button"
                            className="btn-icon"
                            title="Editar c√¢mbio"
                            onClick={() => handleEdit(cambio)}
                          >
                            ‚úèÔ∏è
                          </button>
                        )}
                        {podeExcluir && (
                          <button
                            type="button"
                            className="btn-icon btn-danger"
                            title="Excluir c√¢mbio"
                            onClick={() => solicitarExclusao(cambio)}
                          >
                            üóëÔ∏è
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </>
      )}

      {mostrarFormulario && (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="form-row">
            <div className="form-group">
              <label className="form-label">Moeda</label>
              <input
                type="text"
                className="form-input"
                list="moeda-sugestoes"
                value={form.moeda}
                onChange={(event) => handleFormChange("moeda", event.target.value)}
                disabled={!podeEscrever}
              />
              <datalist id="moeda-sugestoes">
                {MOEDA_SUGESTOES.map((moeda) => (
                  <option key={moeda} value={moeda} />
                ))}
              </datalist>
            </div>

            <div className="form-group">
              <label className="form-label">Data</label>
              <input
                type="date"
                className="form-input w-full"
                value={form.data}
                onChange={(event) => handleFormChange("data", event.target.value)}
                disabled={!podeEscrever}
              />
            </div>

            <div className="form-group">
              <label className="form-label">Valor (R$)</label>
              <input
                type="text"
                className="form-input"
                inputMode="decimal"
                placeholder="Ex: 6,50"
                value={form.valor}
                onChange={(event) => handleFormChange("valor", event.target.value)}
                disabled={!podeEscrever}
              />
            </div>
          </div>

          <div className="mobile-stack-buttons" style={{ marginTop: 8 }}>
            <button
              type="submit"
              className="btn btn-primary"
              disabled={!podeEscrever || salvando || !companyId}
            >
              {salvando ? "Salvando..." : "Salvar c√¢mbio"}
            </button>
            <button
              type="button"
              className="btn btn-light"
              onClick={fecharFormulario}
              disabled={salvando}
            >
              Cancelar
            </button>
          </div>

          {erro && <div className="auth-error">{erro}</div>}
          {sucesso && <div className="auth-success">{sucesso}</div>}

          {!companyId && (
            <div className="auth-error">
              Voc√™ precisa estar vinculado a uma empresa para cadastrar c√¢mbios.
            </div>
          )}
          {!podeEscrever && (
            <div style={{ marginTop: 8, color: "#f97316", fontSize: "0.9rem" }}>
              Voc√™ n√£o tem permiss√£o para cadastrar ou remover c√¢mbios. Solicite acesso ao
              administrador.
            </div>
          )}
        </form>
      )}
      <ConfirmDialog
        open={Boolean(cambioParaExcluir)}
        title="Excluir c√¢mbio"
        message="Deseja excluir este c√¢mbio?"
        confirmLabel="Excluir"
        confirmVariant="danger"
        onCancel={() => setCambioParaExcluir(null)}
        onConfirm={confirmarExclusao}
      />
    </div>
  );
}
