---
import { supabaseServer as supabase } from "../../../../lib/supabaseServer";

const saleId = Astro.params.id;

/* 1️⃣ VENDA (SEM JOIN) */
const { data: sale, error: saleError } = await supabase
  .from("sale")
  .select(`
    id,
    client_id,
    seller_id,
    total,
    paid_total,
    balance_due,
    currency,
    financial_status
  `)
  .eq("id", saleId)
  .single();

if (!sale) {
  console.error(saleError);
  throw new Error("Venda não encontrada");
}

/* 2️⃣ CLIENTE */
const { data: client } = await supabase
  .from("clientes")
  .select("nome")
  .eq("id", sale.client_id)
  .single();

/* 3️⃣ VENDEDOR */
const { data: seller } = await supabase
  .from("users")
  .select("nome_completo")
  .eq("id", sale.seller_id)
  .single();

/* 4️⃣ PAGAMENTOS */
const { data: payments } = await supabase
  .from("payment")
  .select(`
    id,
    method,
    amount,
    status,
    created_at
  `)
  .eq("sale_id", saleId)
  .order("created_at", { ascending: false });

/* 5️⃣ ACTIONS */
async function pagarSimples(formData: FormData) {
  "use server";

  const amount = Number(formData.get("amount"));
  const method = String(formData.get("method"));

  const { error } = await supabase.rpc(
    "registrar_pagamento_simples",
    {
      p_sale_id: saleId,
      p_method: method,
      p_amount: amount
    }
  );

  if (error) throw error;
}

async function pagarParcelado(formData: FormData) {
  "use server";

  const total = Number(formData.get("total"));
  const installments = Number(formData.get("installments"));

  const { error } = await supabase.rpc(
    "registrar_pagamento_parcelado",
    {
      p_sale_id: saleId,
      p_method: "CREDIT_CARD",
      p_total_amount: total,
      p_installments: installments,
      p_first_due_date: new Date().toISOString().slice(0,10)
    }
  );

  if (error) throw error;
}
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
  </head>
  <body>
    <h1>Pagamentos da Venda</h1>

    <p>
      Cliente: <strong>{client?.nome ?? "-"}</strong><br />
      Vendedor: <strong>{seller?.nome_completo ?? "-"}</strong>
    </p>

    <hr />

    <p>
      <strong>Total:</strong> {sale.currency} {sale.total}<br />
      <strong>Pago:</strong> {sale.currency} {sale.paid_total}<br />
      <strong>Saldo:</strong> {sale.currency} {sale.balance_due}<br />
      <strong>Status:</strong> {sale.financial_status}
    </p>

    <hr />

    <h2>Registrar pagamento (PIX / Transferência)</h2>
    <form method="post" action={pagarSimples}>
      <input type="number" step="0.01" name="amount" placeholder="Valor" required />
      <select name="method">
        <option value="PIX">PIX</option>
        <option value="BANK_TRANSFER">Transferência</option>
        <option value="CASH">Dinheiro</option>
      </select>
      <button type="submit">Registrar pagamento</button>
    </form>

    <hr />

    <h2>Pagamento com cartão (parcelado)</h2>
    <form method="post" action={pagarParcelado}>
      <input type="number" step="0.01" name="total" placeholder="Valor total" required />
      <input type="number" name="installments" placeholder="Parcelas" min="1" max="12" required />
      <button type="submit">Criar parcelamento</button>
    </form>

    <hr />

    <h2>Pagamentos registrados</h2>
    <ul>
      {payments?.map((p) => (
        <li>
          {p.method} — {sale.currency} {p.amount} — {p.status}
        </li>
      ))}
    </ul>

    <p>
      <a href={`/admin/sales/${saleId}`}>⬅ Voltar para a venda</a>
    </p>
  </body>
</html>
