---
import { createClient } from "@supabase/supabase-js";
import type { APIRoute } from "astro";


const supabase = createClient(
  import.meta.env.SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);

const quoteId = Astro.params.id;

// ðŸ”¹ Carrega quote
const { data: quote, error: quoteError } = await supabase
  .from("quote")
  .select(`
    id,
    status,
    currency,
    valid_until,
    total,
    client_id,
    seller_id
  `)
  .eq("id", quoteId)
  .single();

if (quoteError || !quote) {
  throw new Error("Quote nÃ£o encontrado");
}

// ðŸ”¹ Carrega itens
const { data: items } = await supabase
  .from("quote_item")
  .select(`
    id,
    item_type,
    description_snapshot,
    quantity,
    unit_price_snapshot,
    total_item
  `)
  .eq("quote_id", quoteId)
  .order("created_at", { ascending: true });

// ðŸ”¹ Actions
async function removerItem(formData: FormData) {
  "use server";
  const itemId = String(formData.get("item_id"));

  const { error } = await supabase.rpc("remover_quote_item", {
    p_quote_item_id: itemId
  });

  if (error) throw error;
}

async function gerarOrcamento() {
  "use server";

  const { error } = await supabase.rpc("enviar_quote", {
    p_quote_id: quoteId
  });

  if (error) throw error;
}
---
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
  </head>
  <body>
    <h1>Carrinho / OrÃ§amento</h1>

    <p>
      <strong>Status:</strong> {quote.status}<br />
      <strong>Validade:</strong> {quote.valid_until}<br />
      <strong>Total:</strong> {quote.currency} {quote.total.toFixed(2)}
    </p>

    <hr />

    <h2>Itens</h2>

    {items?.length === 0 && (
      <p>Nenhum item adicionado.</p>
    )}

    <ul>
      {items?.map((item) => (
        <li>
          <strong>{item.item_type}</strong><br />
          {item.description_snapshot}<br />
          Qtd: {item.quantity} â€”
          Unit: {quote.currency} {item.unit_price_snapshot.toFixed(2)} â€”
          Total: {quote.currency} {item.total_item.toFixed(2)}

          {quote.status === "DRAFT" && (
            <form method="post" action={removerItem}>
              <input type="hidden" name="item_id" value={item.id} />
              <button type="submit">Remover</button>
            </form>
          )}
        </li>
      ))}
    </ul>

    <hr />

    {quote.status === "DRAFT" && (
      <>
        <p>
          <a href={`/admin/inquiries/${quote.inquiry_id}`}>
            âž• Adicionar itens
          </a>
        </p>

        <form method="post" action={gerarOrcamento}>
          <button type="submit">
            ðŸ“„ Gerar orÃ§amento para o cliente
          </button>
        </form>
      </>
    )}

    {quote.status !== "DRAFT" && (
      <p>
        ðŸ”’ Este orÃ§amento jÃ¡ foi enviado ao cliente e nÃ£o pode ser alterado.
      </p>
    )}
  </body>
</html>
