---
import { supabaseServer as supabase } from "../../../../lib/supabaseServer";
const quoteId = Astro.params.id;

/* Buscar serviços por fornecedor e seus preços */
const { data: services } = await supabase
  .from("servicos_fornecedor")
  .select(`
    id,
    nome,
    tipo,
    fornecedor:fornecedor_id ( nome_fantasia ),
    prices:servico_fornecedor_price (
      id, moeda, valor_base, tipo_valor
    )
  `)
  .eq("ativo", true);

/* Action para adicionar serviço */
async function adicionarServico(formData) {
  "use server";
  const priceId = String(formData.get("price_id"));
  const quantity = Number(formData.get("quantity") || 1);

  const { error } = await supabase.rpc(
    "adicionar_servico_fornecedor_ao_quote",
    {
      p_quote_id: quoteId,
      p_price_id: priceId,
      p_quantidade: quantity
    }
  );

  if (error) throw error;
}
---

<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
  </head>
  <body>
    <h1>Adicionar Serviço</h1>

    <ul>
      {services?.map((s) => (
        <li style="margin-bottom: 20px; border-bottom: 1px solid #ccc;">
          <strong>{s.nome}</strong> — {s.tipo}  
          <em>Fornecedor: {s.fornecedor?.nome_fantasia}</em>

          <ul>
            {s.prices?.map((p) => (
              <li>
                <form method="post" action={adicionarServico} style="display:inline-block; margin-right: 20px;">
                  <input type="hidden" name="price_id" value={p.id} />
                  <label>
                    Qtd: <input type="number" name="quantity" min="1" value="1" />
                  </label>
                  <button type="submit">
                    ➕ {p.moeda} {p.valor_base} ({p.tipo_valor})
                  </button>
                </form>
              </li>
            ))}
          </ul>
        </li>
      ))}
    </ul>

    <p>
      <a href={`/admin/quotes/${quoteId}`}>
        ⬅ Voltar ao Orçamento
      </a>
    </p>
  </body>
</html>
