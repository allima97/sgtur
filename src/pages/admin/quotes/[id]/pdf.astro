---
import { supabaseServer as supabase } from "../../../../lib/supabaseServer";

const quoteId = Astro.params.id;

/* QUOTE */
const { data: quote } = await supabase
  .from("quote")
  .select(`
    id,
    currency,
    total,
    valid_until,
    client_id,
    items:quote_item (
      item_type,
      description_snapshot,
      quantity,
      unit_price_snapshot,
      total_item
    )
  `)
  .eq("id", quoteId)
  .single();

if (!quote) {
  throw new Error("Orçamento não encontrado");
}

const { data: client } = await supabase
  .from("clientes")
  .select("nome, email")
  .eq("id", quote.client_id)
  .single();
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
  </head>
    <meta charset="utf-8" />
    <title>Orçamento #{quote.id}</title>
    <style>
      body { font-family: Arial, sans-serif; font-size: 12px; }
      h1 { font-size: 20px; }
      table { width: 100%; border-collapse: collapse; margin-top: 16px; }
      th, td { border: 1px solid #ccc; padding: 6px; }
      th { background: #f5f5f5; }
      .total { text-align: right; font-weight: bold; }
    </style>
  </head>

  <body>
    <h1>Orçamento</h1>

    <p>
      <strong>Cliente:</strong> {client?.nome ?? "-"}<br />
      <strong>Validade:</strong> {quote.valid_until}
    </p>

    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Qtd</th>
          <th>Unitário</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        {quote.items.map(item => (
          <tr>
            <td>{item.description_snapshot}</td>
            <td>{item.quantity}</td>
            <td>{quote.currency} {item.unit_price_snapshot}</td>
            <td>{quote.currency} {item.total_item}</td>
          </tr>
        ))}
      </tbody>
    </table>

    <p class="total">
      Total: {quote.currency} {quote.total}
    </p>

    <hr />

    <p>
      Este orçamento está sujeito à disponibilidade e reajustes
      até a confirmação.
    </p>
  </body>
</html>
