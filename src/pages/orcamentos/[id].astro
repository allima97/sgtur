---
import "../../styles/global.css";
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import QuoteDetailIsland from "../../components/islands/QuoteDetailIsland";
import { createServerClient } from "@supabase/ssr";

const { id } = Astro.params;
const { cookies } = Astro;

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

const supabase = createServerClient(supabaseUrl, supabaseAnonKey, {
  cookies: {
    get: (name) => cookies.get(name)?.value ?? "",
    set: (name, value, options) =>
      cookies.set(name, value, {
        ...options,
        httpOnly: true,
        secure: import.meta.env.PROD,
        sameSite: "Lax",
        path: "/",
      }),
    remove: (name, options) =>
      cookies.delete(name, {
        ...options,
        path: "/",
      }),
  },
});

const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect("/auth/login");
}

const { data: quote, error: quoteErr } = await supabase
  .from("quote")
  .select(
    "id, status, status_negociacao, currency, total, average_confidence, source_file_path, source_file_url, client_id, created_at, cliente:client_id (id, nome, cpf)"
  )
  .eq("id", id)
  .single();

if (quoteErr || !quote) {
  return new Response("Quote nao encontrado", { status: 404 });
}

const { data: items } = await supabase
  .from("quote_item")
  .select(
    "id, item_type, title, product_name, city_name, quantity, unit_price, total_amount, taxes_amount, start_date, end_date, currency, confidence, order_index, raw, quote_item_segment (id, segment_type, data, order_index)"
  )
  .eq("quote_id", quote.id)
  .order("order_index", { ascending: true })
  .order("created_at", { ascending: true });

const itemsWithSegments = (items ?? []).map((item: any) => ({
  ...item,
  segments: item.quote_item_segment || [],
}));

const activePage = "orcamentos";
---

<DashboardLayout title="Orcamentos" {activePage}>
  <QuoteDetailIsland client:load quote={quote} items={itemsWithSegments} />
</DashboardLayout>
