---
import QuoteCartIsland from "../../components/islands/QuoteCartIsland";
import { supabase } from "../../lib/supabase";

const { id } = Astro.params;

// ğŸ” sessÃ£o
const {
  data: { session },
} = await supabase.auth.getSession();

if (!session) {
  return Astro.redirect("/auth/login");
}

const userId = session.user.id;

// ğŸ“„ quote
const { data: quote, error: quoteErr } = await supabase
  .from("quote")
  .select(
    "id, client_id, seller_id, status, currency, valid_until, total, created_at, updated_at"
  )
  .eq("id", id)
  .single();

if (quoteErr || !quote) {
  return new Response("Quote nÃ£o encontrado", { status: 404 });
}

// ğŸ›’ itens
const { data: items } = await supabase
  .from("quote_item")
  .select("*")
  .eq("quote_id", quote.id)
  .order("created_at", { ascending: true });

// ğŸ’¸ descontos
const { data: discounts } = await supabase
  .from("quote_discount")
  .select("*")
  .eq("quote_id", quote.id)
  .order("created_at", { ascending: true });
---

<div class="page-content-wrap">
  <div class="card-base">
    <h1 class="page-title">Carrinho do OrÃ§amento</h1>
    <p class="text-muted">Quote ID: {quote.id}</p>
  </div>

  <QuoteCartIsland
    client:load
    initialQuote={quote}
    initialItems={items ?? []}
    initialDiscounts={discounts ?? []}
    userId={userId}
  />
</div>
